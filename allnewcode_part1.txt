--- PART 1 START ---
================================================================================
FILE: src/ai/dev.ts
================================================================================

================================================================================
FILE: src/ai/flows/ai-content-moderation.ts
================================================================================
'use server';

import { ai } from '@/ai/genkit';
import { z } from 'genkit';
import { verifyIdToken } from '@/lib/firebase/auth-admin';

const ModerateContentInputSchema = z.object({
    productName: z.string().describe('The name of the product.'),
    productDescription: z.string().describe('The description of the product.'),
    productImageUri: z
        .string()
        .optional()
        .describe(
            'A photo of the product, as a data URI that must include a MIME type and use Base64 encoding. Expected format: \'data:<mimetype>;base64,<encoded_data>\'.'
        ),
    idToken: z.string().describe('The Firebase ID token of the user.'),
});
export type ModerateContentInput = z.infer<typeof ModerateContentInputSchema>;

const ModerateContentOutputSchema = z.object({
    isCompliant: z
        .boolean()
        .describe(
            'Whether the product content complies with the platform policies.'
        ),
    policyViolations: z
        .array(z.string())
        .describe('A list of policy violations identified in the product content.'),
    isFakeOrMalicious: z
        .boolean()
        .describe('Whether the product is suspected to be fake or malicious.'),
    confidenceScore: z
        .number()
        .describe(
            'A score indicating the confidence level of the moderation decision (0-1).'
        ),
    explanation: z
        .string()
        .describe(
            'A detailed explanation of the moderation decision, including reasons for policy violations or suspicion of fake/malicious activity.'
        ),
});
export type ModerateContentOutput = z.infer<typeof ModerateContentOutputSchema>;

export async function moderateContent(
    input: ModerateContentInput
): Promise<ModerateContentOutput> {
    await verifyIdToken(input.idToken);
    return moderateContentFlow(input);
}

const moderateContentPrompt = ai.definePrompt({
    name: 'moderateContentPrompt',
    input: { schema: ModerateContentInputSchema },
    output: { schema: ModerateContentOutputSchema },
    prompt: `You are an AI-powered content moderation tool for an e-commerce platform.
Your task is to review product content and identify any policy violations, fake products, or malicious content.

Here are the platform policies:
- No hate speech or discrimination.
- No illegal or harmful products.
- No misleading or deceptive content.
- No copyright infringement.
- All products must be accurately described.
- Product images must be relevant and appropriate.

Analyze the following product content:

Product Name: {{{productName}}}
Product Description: {{{productDescription}}}
{{#if productImageUri}}
Product Image: {{media url=productImageUri}}
{{else}}
(No image provided)
{{/if}}

Based on the content and platform policies, determine if the product is compliant, identify any policy violations, and assess whether the product is fake or malicious.

Provide a confidence score (0-1) for your decision and a detailed explanation.

Output in JSON format.`,
});

const moderateContentFlow = ai.defineFlow(
    {
        name: 'moderateContentFlow',
        inputSchema: ModerateContentInputSchema,
        outputSchema: ModerateContentOutputSchema,
    },
    async input => {
        const { output } = await moderateContentPrompt(input);
        return output!;
    }
);

================================================================================
FILE: src/ai/flows/auto-repricing.ts
================================================================================
'use server';

import { ai } from '@/ai/genkit';
import { z } from 'zod';
import { db } from '@/lib/firebase/config';
import { collection, query, where, getDocs, writeBatch, Timestamp } from 'firebase/firestore';
import { getAutoRepricingSettings } from '@/app/admin/auto-repricing/actions';
import { Product } from '@/lib/types';
import { sendNotification, getSuperAdminId } from '@/services/notifications';

// This flow would be triggered by a scheduled job (e.g., a cron job calling an HTTP endpoint)
export const autoRepriceProductsFlow = ai.defineFlow(
    {
        name: 'autoRepriceProductsFlow',
        inputSchema: z.null(),
        outputSchema: z.object({
            success: z.boolean(),
            message: z.string(),
            repricedProducts: z.array(z.string()),
        }),
    },
    async () => {
        const settings = await getAutoRepricingSettings();
        if (!settings) {
            return { success: false, message: 'Auto-repricing settings not configured.', repricedProducts: [] };
        }

        const { viewThreshold, priceDropPercentage, waitingPeriodHours } = settings;
        const now = Timestamp.now();
        const waitingPeriodMillis = waitingPeriodHours * 60 * 60 * 1000;

        const productsRef = collection(db, 'products');
        const q = query(
            productsRef,
            where('autoRepricingEnabled', '==', true),
            where('uniqueViews', '>=', viewThreshold)
        );

        const querySnapshot = await getDocs(q);
        if (querySnapshot.empty) {
            return { success: true, message: 'No products met the view threshold.', repricedProducts: [] };
        }
        
        const batch = writeBatch(db);
        const repricedProducts: string[] = [];
        const notificationsToSend: Promise<any>[] = [];

        const adminId = await getSuperAdminId();
        if (!adminId) {
            console.warn('Super admin ID not found. Auto-repricing notifications will not be sent.');
        }

        for (const doc of querySnapshot.docs) {
            const product = { id: doc.id, ...doc.data() } as Product;
            
            if (product.lastViewedTimestamp) {
                const lastViewedMillis = product.lastViewedTimestamp.toMillis();
                const timeSinceLastView = now.toMillis() - lastViewedMillis;

                if (timeSinceLastView >= waitingPeriodMillis) {
                    const newPrice = product.price * (1 - priceDropPercentage / 100);
                    
                    // Add update to batch
                    batch.update(doc.ref, { price: newPrice });
                    repricedProducts.push(product.id);

                    // Prepare notification for the admin
                    if (adminId) {
                        const notificationPromise = sendNotification(
                            adminId,
                            'system',
                            'Auto-Repricing Alert',
                            `The price for "${product.title}" has been automatically reduced to $${newPrice.toFixed(2)}.`,
                            `/product/${product.id}`
                        );
                        notificationsToSend.push(notificationPromise);
                    }
                }
            }
        }

        if (repricedProducts.length > 0) {
            await batch.commit();
            await Promise.all(notificationsToSend);
            return {
                success: true,
                message: `Successfully repriced ${repricedProducts.length} products.`,
                repricedProducts,
            };
        }

        return { success: true, message: 'No products were eligible for a price drop at this time.', repricedProducts: [] };
    }
);

================================================================================
FILE: src/ai/flows/check-card-condition.ts
================================================================================

'use server';

/**
 * @fileOverview An AI-powered flow for assessing the condition of collector cards.
 * This flow takes front and back images of a card and returns a detailed condition report.
 */

import { ai } from '@/ai/genkit';
import { cardConditionInputSchema, cardConditionOutputSchema } from './schemas';
import { verifyIdToken } from '@/lib/firebase/auth-admin';

/**
 * Assesses the condition of a collector card based on its images.
 * @param input An object containing data URIs for the front and back images of the card.
 * @returns {Promise<CardConditionOutput>} A promise that resolves to a detailed condition report.
 */
export async function checkCardCondition(input: import('./schemas').CardConditionInput): Promise<import('./schemas').CardConditionOutput> {
    await verifyIdToken(input.idToken);
    return await cardConditionFlow(input);
}

const cardConditionPrompt = ai.definePrompt({
    name: 'cardConditionPrompt',
    model: 'googleai/gemini-flash-latest',
    input: { schema: cardConditionInputSchema },
    output: { schema: cardConditionOutputSchema },
    prompt: `You are a professional trading card grader with expertise from a leading company like PSA or BGS.
    Analyze the front and back images of this trading card. Your analysis must be critical and adhere to professional grading standards.

    Images:
    - Front: {{media url=frontImageUri}}
    - Back: {{media url=backImageUri}}

    Your task is to provide a detailed condition report based ONLY on the provided images.
    1.  **Overall Grade:** Provide a single, definitive grade on a 1-10 scale, including the descriptive title (e.g., "Mint 9", "Near Mint 7", "Poor 1"). Be strict. If there's any doubt, grade down.
    2.  **Corners:** Assess all four corners on both front and back. Note any whitening, fraying, or rounding. Be specific (e.g., "Sharp corners with minor whitening visible on the back-left corner.").
    3.  **Edges:** Examine all edges for chips, whitening, or roughness. Be specific (e.g., "Mostly clean edges with one minor chip on the top edge.").
    4.  **Surface:** Look for scratches, print lines, dimples, or stains. Mention their location and severity.
    5.  **Centering:** Estimate the centering for both the front and back as a ratio (e.g., "60/40 Left-to-Right on the front").
    6.  **Image Quality:** Determine if the provided images are clear and high-resolution enough for a confident assessment. If they are blurry, poorly lit, or have glare, set 'isImageQualitySufficient' to false and provide specific feedback on how to improve the photos. Do not try to guess if the images are bad. If quality is good, this feedback should be empty.

    Do not invent details not visible in the images. Your assessment must be objective and based purely on visual evidence.
    `,
});

const cardConditionFlow = ai.defineFlow(
    {
        name: 'cardConditionFlow',
        inputSchema: cardConditionInputSchema,
        outputSchema: cardConditionOutputSchema,
    },
    async (input) => {
        const { output } = await cardConditionPrompt(input);
        if (!output) {
            throw new Error('Failed to get a response from the AI model.');
        }
        return output;
    }
);

================================================================================
FILE: src/ai/flows/detect-fraud.ts
================================================================================
'use server';

import { ai } from '@/ai/genkit';
import { z } from 'genkit';
import { verifyIdToken } from '@/lib/firebase/auth-admin';

const DetectFraudInputSchema = z.object({
    details: z.string().describe('The transaction details or user messages to analyze.'),
    idToken: z.string().describe('The Firebase ID token of the user.'),
});
export type DetectFraudInput = z.infer<typeof DetectFraudInputSchema>;

const DetectFraudOutputSchema = z.object({
    isFraudulent: z
        .boolean()
        .describe('Whether the provided text is likely to be fraudulent.'),
    riskScore: z
        .number()
        .describe('A score from 0 to 1 indicating the level of fraud risk.'),
    reason: z
        .string()
        .describe('An explanation for why the transaction is or is not considered fraudulent.'),
    recommendedAction: z.string().optional().describe('A recommended action for the moderator (e.g., "Ban User", "Monitor User").')
});
export type DetectFraudOutput = z.infer<typeof DetectFraudOutputSchema>;

export async function detectFraud(
    input: DetectFraudInput
): Promise<DetectFraudOutput> {
    const decodedToken = await verifyIdToken(input.idToken);
    const userRole = decodedToken.role;

    if (userRole !== 'admin' && userRole !== 'superadmin') {
        throw new Error('You do not have permission to perform this action.');
    }

    return detectFraudFlow(input);
}

const prompt = ai.definePrompt({
    name: 'detectFraudPrompt',
    input: { schema: DetectFraudInputSchema },
    output: { schema: DetectFraudOutputSchema },
    prompt: `You are a fraud detection expert for an online marketplace. Analyze the following text and determine if it represents a fraudulent or suspicious transaction.

Details:
{{{details}}}

Based on the details, determine if it's fraudulent, provide a risk score (0-1), a reason for your assessment, and a recommended action.
Common fraud patterns include:
- Offering to pay outside the platform.
- Asking for personal information (email, phone number).
- Using strange grammar or urgent language.
- Offering a deal that is too good to be true.`,
});

const detectFraudFlow = ai.defineFlow(
    {
        name: 'detectFraudFlow',
        inputSchema: DetectFraudInputSchema,
        outputSchema: DetectFraudOutputSchema,
    },
    async input => {
        const { output } = await prompt(input);
        return output!;
    }
);

================================================================================
FILE: src/ai/flows/extract-card-name.ts
================================================================================
'use server';

/**
 * @fileOverview A flow to extract detailed card information including player name, brand, type, sport, and year.
 */

import { ai } from '@/ai/genkit';
import { z } from 'genkit';

const ExtractCardNameInputSchema = z.object({
    cardImageDataUri: z
        .string()
        .describe(
            "A photo of a trading card, as a data URI. Expected format: 'data:<mimetype>;base64,<encoded_data>'."
        ),
});
type ExtractCardNameInput = z.infer<typeof ExtractCardNameInputSchema>;

const ExtractCardNameOutputSchema = z.object({
    playerName: z.string().describe('The name of the player on the card.'),
    cardBrand: z.string().optional().describe('The brand/manufacturer of the card (e.g., Panini, Topps, Upper Deck).'),
    cardColor: z.string().optional().describe('The type/color of the card (e.g., Base, Prizm, Refractor, Silver).'),
    sport: z.string().optional().describe('The sport (e.g., Basketball, Baseball, Football, Soccer).'),
    cardYear: z.number().optional().describe('The year the card was produced.'),
    salesData: z.object({
        averagePrice: z.number().optional().nullable(),
        salesCount: z.number().optional().nullable(),
        source: z.string().optional().nullable(),
    }).optional(),
});
export type ExtractCardNameOutput = z.infer<typeof ExtractCardNameOutputSchema>;

export async function extractCardName(
    input: ExtractCardNameInput
): Promise<ExtractCardNameOutput> {
    const result = await extractCardNameFlow(input);
    return result;
}

const prompt = ai.definePrompt({
    name: 'extractCardNamePrompt',
    model: 'googleai/gemini-flash-latest',
    input: { schema: ExtractCardNameInputSchema },
    output: { schema: ExtractCardNameOutputSchema },
    prompt: `You are an expert at analyzing trading cards. Extract all available information from this card image:

- Player's full name (required)
- Card brand/manufacturer (Panini, Topps, Upper Deck, etc.)
- Card type/color (Base, Prizm, Refractor, Silver, Gold, etc.)
- Sport (Basketball, Baseball, Football, Soccer, etc.)
- Year of production

Be precise and only return what you can clearly see on the card.

Card Image: {{media url=cardImageDataUri}}`,
});

const extractCardNameFlow = ai.defineFlow(
    {
        name: 'extractCardNameFlow',
        inputSchema: ExtractCardNameInputSchema,
        outputSchema: ExtractCardNameOutputSchema,
    },
    async (input) => {
        if (!input.cardImageDataUri.startsWith('data:image/')) {
            throw new Error('Invalid image format. Use JPEG or PNG.');
        }
        const { output } = await prompt(input);
        if (!output?.playerName) {
            throw new Error("Gemini could not detect a player name on the card.");
        }
        return output;
    }
);

================================================================================
FILE: src/ai/flows/grade-card-details.ts
================================================================================
'use server';

import { ai } from '@/ai/genkit';
import { z } from 'zod';
import { gradeCardDetailsSchema, type GradeCardDetailsOutput } from '@/ai/schemas/grading-schemas';
import { verifyIdToken } from '@/lib/firebase/auth-admin';

export type { GradeCardDetailsOutput };

/**
 * Advanced Card Grading AI Flow
 * Analyzes front and back of a card for:
 * - Corners (wear, damage, sharpness)
 * - Centering (left/right, top/bottom balance)
 * - Edges (whitening, chipping, wear)
 * - Surface (scratches, print lines, creases)
 */

const gradeCardDetailsPrompt = ai.definePrompt({
    name: 'gradeCardDetailsPrompt',
    model: 'googleai/gemini-flash-latest',
    input: {
        schema: z.object({
            frontImage: z.string(),
            backImage: z.string().optional(),
            cardName: z.string().optional()
        })
    },
    output: { schema: gradeCardDetailsSchema },
    prompt: `You are an expert trading card grader with deep knowledge of PSA, BGS, and CGC grading standards.

Analyze the provided card image(s) and provide a detailed grading assessment.

{{#if cardName}}
Card Name: {{cardName}}
{{/if}}

Front Image: {{media url=frontImage}}

{{#if backImage}}
Back Image: {{media url=backImage}}
{{/if}}

**GRADING CRITERIA:**

**Corners (1-10):**
- 10: Perfect sharp corners, no wear
- 8-9: Very slight wear visible under magnification
- 6-7: Minor corner wear visible
- 4-5: Moderate corner rounding or wear
- 1-3: Heavy corner wear, rounding, or damage

**Centering (1-10):**
- 10: Perfect 50/50 centering on all sides
- 9: 55/45 or better
- 8: 60/40 or better
- 7: 65/35 or better
- 6: 70/30 or better
- 5 or less: Worse than 70/30

**Edges (1-10):**
- 10: Perfect clean edges, no whitening
- 8-9: Very slight edge wear
- 6-7: Minor edge whitening or wear
- 4-5: Moderate edge issues
- 1-3: Significant edge damage, chipping, or whitening

**Surface (1-10):**
- 10: Perfect surface, no flaws
- 8-9: One or two very minor surface issues
- 6-7: Minor scratches or print lines
- 4-5: Multiple surface issues
- 1-3: Significant surface damage, creases

**OVERALL GRADE SCALE:**
- 10 (Gem Mint): Perfect card
- 9 (Mint): Near perfect, one tiny flaw
- 8 (Near Mint/Mint): Excellent condition, very minor flaws
- 7 (Near Mint): Minor flaws
- 6 (Excellent/Mint): Some wear, still presentable
- 5 (Excellent): Noticeable wear but no major damage
- 4 (Very Good): Moderate wear, starting to show age
- 3 (Good): Significant wear
- 2 (Fair): Heavy wear, major flaws
- 1 (Poor): Extensive damage

Analyze the card thoroughly and provide specific details about each grading aspect.
If only front image is provided, note that back analysis is estimate only.

Return your analysis in the structured format requested.
`,
});

export async function gradeCardDetails(input: {
    frontImageDataUri: string;
    backImageDataUri?: string;
    cardName?: string;
    idToken?: string;
}): Promise<GradeCardDetailsOutput> {
    if (!input.idToken) {
        throw new Error('Authentication required: No ID token provided.');
    }
    await verifyIdToken(input.idToken);

    const { output } = await gradeCardDetailsPrompt({
        frontImage: input.frontImageDataUri,
        backImage: input.backImageDataUri,
        cardName: input.cardName,
    });

    if (!output) {
        throw new Error("Failed to generate grading details");
    }

    return output;
}

================================================================================
FILE: src/ai/flows/notify-seller-of-removal.ts
================================================================================
'use server';

import { ai } from '@/ai/genkit';
import { z } from 'genkit';
import { verifyIdToken } from '@/lib/firebase/auth-admin';

const NotifySellerInputSchema = z.object({
    sellerEmail: z.string().email().describe('The email address of the seller to notify.'),
    sellerName: z.string().describe('The name of the seller.'),
    productName: z.string().describe('The name of the product that was removed.'),
    idToken: z.string().describe('The Firebase ID token of the user.'),
});
export type NotifySellerInput = z.infer<typeof NotifySellerInputSchema>;

const NotifySellerOutputSchema = z.object({
    success: z.boolean().describe('Whether the notification was sent successfully.'),
    message: z.string().describe('A summary of the action taken.'),
});
export type NotifySellerOutput = z.infer<typeof NotifySellerOutputSchema>;

export async function notifySellerOfRemoval(input: NotifySellerInput): Promise<NotifySellerOutput> {
    const decodedToken = await verifyIdToken(input.idToken);
    const userRole = decodedToken.role;

    if (userRole !== 'admin' && userRole !== 'superadmin') {
        throw new Error('You do not have permission to perform this action.');
    }
    return notifySellerOfRemovalFlow(input);
}

const prompt = ai.definePrompt({
    name: 'notifySellerPrompt',
    input: { schema: NotifySellerInputSchema },
    prompt: `Generate a professional and courteous email to a seller informing them that their product has been removed for violating the platform's terms and conditions.

Seller Name: {{{sellerName}}}
Product Name: {{{productName}}}
Seller Email: {{{sellerEmail}}}

The email should:
1. State clearly that the product "{{{productName}}}" has been removed.
2. Mention that the removal is due to a violation of the platform's Terms and Conditions.
3. Direct the seller to review the T&Cs for more information.
4. Be polite and professional in tone.`,
});

const notifySellerOfRemovalFlow = ai.defineFlow(
    {
        name: 'notifySellerOfRemovalFlow',
        inputSchema: NotifySellerInputSchema,
        outputSchema: NotifySellerOutputSchema,
    },
    async (input) => {
        const { text } = await prompt(input);

        console.log('--- SIMULATING EMAIL ---');
        console.log(`To: ${input.sellerEmail}`);
        console.log(`Subject: Important Notification Regarding Your Product: "${input.productName}"`);
        console.log('--- Email Body ---');
        console.log(text);
        console.log('------------------------');

        return {
            success: true,
            message: `Simulated an email notification to ${input.sellerEmail} regarding the removal of "${input.productName}".`,
        };
    }
);

================================================================================
FILE: src/ai/flows/process-donation.ts
================================================================================

'use server';

/**
 * @fileOverview A flow to process donations, send a confirmation, and generate a shipping label.
 */

import { ai } from '@/ai/genkit';
import { z } from 'genkit';
import { processDonationInputSchema, processDonationOutputSchema } from './schemas';
import { verifyIdToken } from '@/lib/firebase/auth-admin';

export async function processDonation(input: z.infer<typeof processDonationInputSchema>) {
    const validatedInput = processDonationInputSchema.parse(input);
    await verifyIdToken(validatedInput.idToken);
    return await processDonationFlow(validatedInput);
}

// Dummy tool for "sending an email"
const sendConfirmationEmailTool = ai.defineTool(
    {
        name: 'sendConfirmationEmail',
        description: 'Sends a confirmation email to the donor with a shipping label.',
        inputSchema: z.object({
            email: z.string(),
            fullName: z.string(),
            shippingLabelUrl: z.string().url(),
        }),
        outputSchema: z.object({ success: z.boolean() }),
    },
    async (input) => {
        console.log(`INFO: [Simulated Email] Sent to ${input.email} for ${input.fullName} with label ${input.shippingLabelUrl}`);
        // In a real app, this would integrate with an email service like SendGrid or Resend.
        return { success: true };
    }
);

const processDonationFlow = ai.defineFlow(
    {
        name: 'processDonationFlow',
        inputSchema: processDonationInputSchema,
        outputSchema: processDonationOutputSchema,
    },
    async (input) => {
        const fakeShippingLabel = 'https://example.com/shipping-label/fake-label-12345.pdf';

        const result = await ai.generate({
            prompt: `The user ${input.fullName} (${input.email}) is donating ${input.quantity} of ${input.donationType}. Their description is: "${input.description}". Please generate a brief, friendly thank you message and then call the email tool to send them the shipping label.`,
            model: 'googleai/gemini-flash-latest',
            tools: [sendConfirmationEmailTool],
            output: {
                schema: z.object({
                    thankYouMessage: z.string().describe('A short, friendly thank you message for the user.'),
                }),
            },
        });

        const toolCalls = result.toolRequests;
        if (toolCalls.length === 0) {
            throw new Error("The model did not request to send the confirmation email.");
        }

        // You can optionally inspect tool calls before executing
        // For now, we just execute what the model requested.
        const toolOutputs = await Promise.all(toolCalls.map(async tc => ({ tool: tc, output: await tc.run() })));

        // You could pass the tool outputs back to the model for a final response,
        // but for this flow, we'll just confirm it was called.
        const emailSent = toolOutputs.some(output => (output.output as any)?.success === true);

        if (emailSent) {
            return {
                status: "Success",
                message: result.output?.thankYouMessage || `Thank you, ${input.fullName}! Your shipping label has been sent to ${input.email}.`,
            };
        } else {
            throw new Error("Failed to execute the send email tool.");
        }
    }
);

================================================================================
FILE: src/ai/flows/quick-scan.ts
================================================================================
'use server';

/**
 * @fileOverview A fast flow to extract only the player's name from a card image.
 *
 * - quickScan - A function that handles the player name extraction.
 */

import { ai } from '@/ai/genkit';
import { z } from 'genkit';
import { checkAIRateLimit } from '@/lib/rate-limiter';

const QuickScanInputSchema = z.object({
    cardImageDataUri: z
        .string()
        .describe(
            "A photo of a card, as a data URI that must include a MIME type and use Base64 encoding. Expected format: 'data:<mimetype>;base64,<encoded_data>'."
        ),
    userId: z.string().optional().describe('User ID for rate limiting'),
});
type QuickScanInput = z.infer<typeof QuickScanInputSchema>;

const QuickScanOutputSchema = z.object({
    playerName: z
        .string()
        .describe('The name of the player extracted from the card image.'),
});
export type QuickScanOutput = z.infer<typeof QuickScanOutputSchema>;

export async function quickScan(
    input: QuickScanInput
): Promise<QuickScanOutput> {
    // Rate limiting check
    if (input.userId) {
        checkAIRateLimit(input.userId);
    }

    const result = await quickScanFlow(input);
    return result;
}

const prompt = ai.definePrompt({
    name: 'quickScanPrompt',
    model: 'googleai/gemini-flash-latest',
    input: { schema: QuickScanInputSchema },
    output: { schema: QuickScanOutputSchema },
    prompt: `You are an expert at Optical Character Recognition on trading cards. Your ONLY job is to extract the player's full name from the provided card image. Return ONLY the name.

Card Image: {{media url=cardImageDataUri}}`,
});

const quickScanFlow = ai.defineFlow(
    {
        name: 'quickScanFlow',
        inputSchema: QuickScanInputSchema,
        outputSchema: QuickScanOutputSchema,
    },
    async (input) => {
        if (!input.cardImageDataUri.startsWith('data:image/')) {
            throw new Error('Invalid image format. Use JPEG or PNG.');
        }
        const { output } = await prompt(input);
        if (!output?.playerName) {
            throw new Error("Gemini could not detect a player name.");
        }
        return output;
    }
);

================================================================================
FILE: src/ai/flows/schemas.ts
================================================================================

/**
 * @fileoverview This file centralizes all Zod schemas for AI flows.
 * This prevents schema duplication and ensures consistency across the application.
 */

import { z } from 'zod';

// Schema for src/ai/flows/check-card-condition.ts
export const cardConditionInputSchema = z.object({
  frontImageUri: z.string().describe("Image URL or Data URI of the front of the card."),
  backImageUri: z.string().describe("Image URL or Data URI of the back of the card."),
  idToken: z.string().describe('The Firebase ID token of the user.'),
});
export type CardConditionInput = z.infer<typeof cardConditionInputSchema>;

export const cardConditionOutputSchema = z.object({
  overallGrade: z.string().describe("The overall assessment of the card's grade as a string, including a number from 1-10 and a descriptive title (e.g., 'Mint 9', 'Near Mint 7', 'Poor 1')."),
  corners: z.string().describe("A brief, one-sentence description of the corners' condition (e.g., 'Sharp with minor whitening on the back-left corner.')."),
  edges: z.string().describe("A brief, one-sentence description of the edges' condition (e.g., 'Clean with one minor chip on the top edge.')."),
  surface: z.string().describe("A brief, one-sentence description of the card's surface, noting any scratches, print lines, or dimples."),
  centering: z.string().describe("An estimation of the centering as a ratio (e.g., '60/40 Front, 55/45 Back')."),
  isImageQualitySufficient: z.boolean().describe("A boolean indicating if the images were clear enough for a confident assessment."),
  qualityFeedback: z.string().optional().describe("If image quality is insufficient, provide a brief suggestion for improvement (e.g., 'Images are too blurry. Please provide higher resolution photos.'). Leave empty if quality is sufficient."),
});
export type CardConditionOutput = z.infer<typeof cardConditionOutputSchema>;


// Schema for src/ai/flows/suggest-listing-details.ts
export const suggestListingDetailsInputSchema = z.object({
  photoDataUris: z
    .array(z.string().describe("Image URL or Data URI"))
    .max(5, 'A maximum of 5 images are allowed.')
    .default([]),
  title: z.string().optional().describe("User-provided title to help generate details if images are missing."),
  idToken: z.string().describe('The Firebase ID token of the user.'),
});
export type SuggestListingDetailsInput = z.infer<typeof suggestListingDetailsInputSchema>;

export const suggestListingDetailsOutputSchema = z.object({
  title: z
    .string()
    .describe('A concise, descriptive, and SEO-friendly title for the listing.'),
  description: z
    .string()
    .describe(
      'A concise, one-to-two-line description of the item, highlighting its key features and condition.'
    ),
  price: z
    .number()
    .describe(
      'An estimated market price for the item in AUD, based on the provided images and analysis of similar items.'
    ),
  category: z.string().describe("The single best category from this list: 'Collector Cards', 'Coins', 'Collectibles'."),
  subCategory: z.string().describe("The single best sub-category based on the main category. For 'Collector Cards', choose from: 'Sports Cards', 'Trading Cards', 'Pokemon'. For 'Coins', use: 'Coins', 'World Coins', 'Ancient Coins', 'Bullion'. For 'Collectibles', use: 'Stamps', 'Comics', 'Figurines', 'Toys', 'Shoes', 'Memorabilia'."),
  condition: z.string().describe("The single best condition from this list: 'Mint', 'Near Mint', 'Excellent', 'Good', 'Fair', 'Poor'."),
  manufacturer: z.string().describe("The manufacturer or brand of the item (e.g., 'Topps', 'Nintendo', 'US Mint')."),
  year: z.number().describe("The year the item was manufactured or released."),
  cardNumber: z.string().optional().describe("The card number, typically found at the bottom of a collector card (e.g., '4/102', 'RC12')."),
});
export type SuggestListingDetailsOutput = z.infer<typeof suggestListingDetailsOutputSchema>;


// Schema for src/ai/flows/process-donation.ts
export const processDonationInputSchema = z.object({
  donationId: z.string().describe('The ID of the donation document in Firestore.'),
  fullName: z.string(),
  email: z.string(),
  donationType: z.string(),
  description: z.string(),
  quantity: z.string(),
  idToken: z.string().describe('The Firebase ID token of the user.'),
});
export type ProcessDonationInput = z.infer<typeof processDonationInputSchema>;

export const processDonationOutputSchema = z.object({
  status: z.string(),
  message: z.string(),
});
export type ProcessDonationOutput = z.infer<typeof processDonationOutputSchema>;

================================================================================
FILE: src/ai/flows/suggest-listing-details.ts
================================================================================

'use server';

/**
 * @fileOverview A flow to suggest listing details based on uploaded images.
 * This uses a generative AI model to analyze images and suggest a title, description, price, etc.
 */
import { ai } from '@/ai/genkit';
import { suggestListingDetailsInputSchema, suggestListingDetailsOutputSchema } from './schemas';
import { verifyIdToken } from '@/lib/firebase/auth-admin';

export async function suggestListingDetails(input: import('./schemas').SuggestListingDetailsInput): Promise<import('./schemas').SuggestListingDetailsOutput> {
    try {
        console.log('ðŸš€ [Server] suggestListingDetails called');
        console.log('ðŸ“Š [Server] Input images count:', input.photoDataUris?.length);

        await verifyIdToken(input.idToken);

        // Pre-process images: Convert URLs to Data URIs (Base64)
        // This ensures Gemini receives the image data directly, avoiding access/CORS issues with Firebase Storage URLs.
        if (input.photoDataUris && input.photoDataUris.length > 0) {
            console.log('ðŸ”„ [Server] converting URLs to Base64...');
            const processedImages = await Promise.all(input.photoDataUris.map(async (uri) => {
                if (uri.startsWith('http')) {
                    try {
                        const response = await fetch(uri);
                        if (!response.ok) throw new Error(`Failed to fetch image: ${response.statusText}`);
                        const arrayBuffer = await response.arrayBuffer();
                        const base64String = Buffer.from(arrayBuffer).toString('base64');
                        const mimeType = response.headers.get('content-type') || 'image/jpeg';
                        // Return standard data URI format
                        return `data:${mimeType};base64,${base64String}`;
                    } catch (fetchErr) {
                        console.error('âŒ [Server] Failed to fetch image for AI analysis:', fetchErr);
                        throw new Error('Failed to download one or more images for analysis.');
                    }
                }
                return uri; // Already a data URI or invalid
            }));

            input.photoDataUris = processedImages;
            console.log('âœ… [Server] Conversion complete. Payload ready.');
        }

        return await suggestListingDetailsFlow(input);

    } catch (error: any) {
        console.error('âŒ [Server] suggestListingDetails failed:', error);
        throw new Error(error.message || 'AI analysis service failed.');
    }
}
export type SuggestListingDetailsOutput = import('./schemas').SuggestListingDetailsOutput;

const suggestListingDetailsPrompt = ai.definePrompt({
    name: 'suggestListingDetailsPrompt',
    model: 'googleai/gemini-flash-latest',
    input: { schema: suggestListingDetailsInputSchema },
    output: { schema: suggestListingDetailsOutputSchema },
    prompt: `You are an expert in valuing and listing collectibles. Analyze the provided information (images and/or title) to generate listing details.

{{#if title}}
Provided Title: {{title}}
{{/if}}

{{#if photoDataUris.length}}
Images:
{{#each photoDataUris}}
- {{media url=this}}
{{/each}}
{{else}}
(No images provided. Base your analysis solely on the title.)
{{/if}}

Based on the images and/or title, provide the following details:
1.  **Title:** A concise, descriptive, and SEO-friendly title. Include key identifiers like name, year, and brand. (Refine the provided title if necessary).
2.  **Description:** A one-to-two-line description highlighting key features and condition.
3.  **Price:** An estimated market price in AUD (Australian Dollars). Be realistic based on the visual information or title.
4.  **Category:** Choose the single best category from this list: 'Collector Cards', 'Coins', 'Collectibles'.
5.  **Sub-Category:** Choose the most specific sub-category based on the main category. For 'Collector Cards', choose from: 'Sports Cards', 'Trading Cards'. For 'Coins', use: 'Coins', 'World Coins', 'Ancient Coins', 'Bullion'. For 'Collectibles', use: 'Stamps', 'Comics', 'Figurines', 'Toys', 'Shoes', 'Memorabilia'.
6.  **Condition:** Assess the item's condition from this list: 'Mint', 'Near Mint', 'Excellent', 'Good', 'Fair', 'Poor'. If no images are provided, default to 'Good' or make a safe assumption based on context.
7.  **Manufacturer:** Identify the manufacturer or brand.
8.  **Year:** Estimate the year of manufacture or release.
9.  **Card Number:** If it's a collector card, identify the card number (e.g., '4/102', 'RC25'). If not applicable, leave blank.
`,
});

const suggestListingDetailsFlow = ai.defineFlow(
    {
        name: 'suggestListingDetailsFlow',
        inputSchema: suggestListingDetailsInputSchema,
        outputSchema: suggestListingDetailsOutputSchema,
    },
    async (input) => {
        const { output } = await suggestListingDetailsPrompt(input);
        if (!output) {
            throw new Error('Failed to get a response from the AI model for listing details.');
        }
        return output;
    }
);

================================================================================
FILE: src/ai/flows/test-api-key.ts
================================================================================

'use server';

/**
 * @fileOverview A simple flow to test if the GenAI API key is working.
 */
import { ai } from '@/ai/genkit';
import { z } from 'zod';
import { verifyIdToken } from '@/lib/firebase/auth-admin';

const testApiKeyOutputSchema = z.object({
  status: z.string(),
  message: z.string(),
  modelInfo: z.any().optional(),
});

export async function testApiKey(idToken: string): Promise<z.infer<typeof testApiKeyOutputSchema>> {
  const decodedToken = await verifyIdToken(idToken);
  const userRole = decodedToken.role;

  if (userRole !== 'admin' && userRole !== 'superadmin') {
    throw new Error('You do not have permission to perform this action.');
  }
  return await testApiKeyFlow();
}

const testApiKeyFlow = ai.defineFlow(
  {
    name: 'testApiKeyFlow',
    outputSchema: testApiKeyOutputSchema,
  },
  async () => {
    try {
      const result = await ai.generate({
        prompt: 'Give me a one-sentence fun fact about collectible trading cards.',
        model: 'googleai/gemini-flash-latest',
        output: {
          schema: z.object({
            fact: z.string(),
          }),
        },
      });

      const modelInfo = result.usage;

      return {
        status: 'Success',
        message: result.output?.fact || 'Successfully connected to the AI service.',
        modelInfo: modelInfo,
      };
    } catch (error: any) {
      console.error('API Key Test Error:', error);
      let errorMessage = 'An unknown error occurred.';
      if (error.message.includes('API key not valid')) {
        errorMessage = 'The provided API key is not valid. Please check your .env.local file.';
      } else if (error.message.includes('fetch')) {
        errorMessage = 'A network error occurred. Could not connect to the AI service.';
      } else {
        errorMessage = error.message;
      }

      return {
        status: 'Error',
        message: errorMessage,
      };
    }
  }
);

================================================================================
FILE: src/ai/genkit.ts
================================================================================

/**
 * @fileoverview This file initializes the Genkit AI instance with the Google AI plugin.
 * It configures the connection to the Google Generative AI API using the provided API key.
 * The exported 'ai' object is used throughout the application to define and run AI flows.
 */
import { genkit } from 'genkit';
import { googleAI } from '@genkit-ai/google-genai';

const plugins = [];
const apiKey = process.env.GOOGLE_GENAI_API_KEY || process.env.GEMINI_API_KEY || process.env.GOOGLE_API_KEY;

if (apiKey) {
  plugins.push(googleAI({ apiKey: apiKey }));
} else {
  console.warn(
    'GEMINI_API_KEY or GOOGLE_API_KEY environment variable is not set. AI features will be disabled.'
  );
}

export const ai = genkit({
  plugins,
});

================================================================================
FILE: src/ai/schemas/grading-schemas.ts
================================================================================
import { z } from 'zod';

export const gradeCardDetailsSchema = z.object({
    overallGrade: z.number().min(1).max(10).describe('Overall grade from 1-10 (10 being gem mint)'),
    condition: z.string().describe('Condition string: Gem Mint, Mint, Near Mint, Excellent, Good, Fair, or Poor'),

    // Front Analysis
    frontAnalysis: z.object({
        corners: z.object({
            score: z.number().min(1).max(10).describe('Corner quality score 1-10'),
            topLeft: z.string().describe('Top left corner condition'),
            topRight: z.string().describe('Top right corner condition'),
            bottomLeft: z.string().describe('Bottom left corner condition'),
            bottomRight: z.string().describe('Bottom right corner condition'),
            notes: z.string().describe('Overall corner notes'),
        }),
        centering: z.object({
            score: z.number().min(1).max(10).describe('Centering quality score 1-10'),
            leftRight: z.string().describe('Left-right centering ratio (e.g., 55/45, 50/50)'),
            topBottom: z.string().describe('Top-bottom centering ratio'),
            notes: z.string().describe('Centering analysis notes'),
        }),
        edges: z.object({
            score: z.number().min(1).max(10).describe('Edge quality score 1-10'),
            top: z.string().describe('Top edge condition'),
            right: z.string().describe('Right edge condition'),
            bottom: z.string().describe('Bottom edge condition'),
            left: z.string().describe('Left edge condition'),
            notes: z.string().describe('Edge wear/whitening notes'),
        }),
        surface: z.object({
            score: z.number().min(1).max(10).describe('Surface quality score 1-10'),
            scratches: z.boolean().describe('Presence of scratches'),
            printLines: z.boolean().describe('Presence of print lines'),
            notes: z.string().describe('Surface condition notes'),
        }),
    }),

    // Back Analysis
    backAnalysis: z.object({
        corners: z.object({
            score: z.number().min(1).max(10).describe('Corner quality score 1-10'),
            notes: z.string().describe('Back corner condition notes'),
        }),
        centering: z.object({
            score: z.number().min(1).max(10).describe('Centering quality score 1-10'),
            notes: z.string().describe('Back centering notes'),
        }),
        edges: z.object({
            score: z.number().min(1).max(10).describe('Edge quality score 1-10'),
            notes: z.string().describe('Back edge condition notes'),
        }),
        surface: z.object({
            score: z.number().min(1).max(10).describe('Surface quality score 1-10'),
            notes: z.string().describe('Back surface condition notes'),
        }),
    }),

    // Overall Assessment
    strengths: z.array(z.string()).describe('List of card strengths'),
    weaknesses: z.array(z.string()).describe('List of card weaknesses/flaws'),
    recommendations: z.string().describe('Grading recommendations and selling advice'),
    estimatedValue: z.object({
        min: z.number().describe('Minimum estimated value in AUD'),
        max: z.number().describe('Maximum estimated value in AUD'),
        notes: z.string().describe('Value estimation notes'),
    }),
});

export type GradeCardDetailsOutput = z.infer<typeof gradeCardDetailsSchema>;

================================================================================
FILE: src/app/(auth)/layout.tsx
================================================================================

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="flex min-h-screen flex-col justify-center bg-gray-50 py-12 sm:px-6 lg:px-8">
      {children}
    </div>
  );
}

================================================================================
FILE: src/app/(auth)/sign-in/page.tsx
================================================================================
import { redirect } from 'next/navigation';

export default function SignInPage() {
  redirect('/');
}

================================================================================
FILE: src/app/(auth)/sign-up/page.tsx
================================================================================

'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { ShieldAlert } from 'lucide-react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';

export default function SignUpPage() {
  const router = useRouter();

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
       <Card className="w-full max-w-md p-6 shadow-xl border-t-4 border-primary h-fit text-center">
        <CardHeader>
            <div className="mx-auto bg-primary/10 p-4 rounded-full w-fit mb-4">
                <ShieldAlert className="h-10 w-10 text-primary" />
            </div>
          <CardTitle className="text-2xl font-bold font-headline">Registration Is Closed</CardTitle>
          <CardDescription>
            To ensure a trusted marketplace, new accounts are created by administrators only. If you would like to become a seller, please contact support.
          </CardDescription>
        </CardHeader>
        <CardContent>
            <Button asChild className="w-full">
                <Link href="/sign-in">Return to Sign In</Link>
            </Button>
        </CardContent>
      </Card>
    </div>
  );
}

================================================================================
FILE: src/app/[section]/[slug]/page.tsx
================================================================================

'use client';
import { useState, useEffect, Suspense, useMemo } from 'react';
import { PageHeader } from "@/components/layout/PageHeader";
import { useCollection, useFirebase, useMemoFirebase } from '@/firebase';
import { collection, query, where, orderBy, limit } from 'firebase/firestore';
import type { Product } from '@/lib/types';
import { useParams } from 'next/navigation';
import MontageGrid from '@/components/products/MontageGrid';
import ProductGridSkeleton from '@/components/products/ProductGridSkeleton';

function toTitleCase(str: string) {
    if (!str) return '';
    return str.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function CategoryPageContent() {
    const params = useParams();
    const section = params.section as string;
    const slug = params.slug as string;

    const { firestore } = useFirebase() || {};
    
    const categoryName = toTitleCase(slug);

    // Query by both category and subCategory for efficiency
    const productsQuery = useMemoFirebase(() => {
        if (!firestore) return null;
        return query(
            collection(firestore, "products"),
            where('category', '==', toTitleCase(section)),
            where('subCategory', '==', categoryName),
            where('isDraft', '==', false),
            orderBy("createdAt", "desc"),
            limit(100)
        );
    }, [firestore, section, categoryName]);

    const { data: products, isLoading } = useCollection<Product>(productsQuery);

    const pageTitle = `${toTitleCase(slug)}`;
    const pageDescription = `Browse collectibles in the ${pageTitle} category.`;

    return (
        <div className="min-h-screen">
            <div className="container mx-auto px-4 py-8">
                <PageHeader
                    title={pageTitle}
                    description={pageDescription}
                />
            </div>
            
            {isLoading ? (
                <div className="container mx-auto px-4">
                    <ProductGridSkeleton count={20} />
                </div>
            ) : (
                <MontageGrid products={products || []} />
            )}
        </div>
    );
}


export default function CategoryPage() {
    return (
        <Suspense fallback={<ProductGridSkeleton count={20} />}>
            <CategoryPageContent />
        </Suspense>
    )
}

================================================================================
FILE: src/app/about/page.tsx
================================================================================

import { PageHeader } from "@/components/layout/PageHeader";
import type { Metadata } from 'next';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { ShieldCheck, MapPin, Sparkles, Handshake } from "lucide-react";
import Image from "next/image";

export const metadata: Metadata = {
  title: 'About Picksy | Australia\'s Local Collectibles Marketplace',
  description: 'Picksy is Australiaâ€™s local marketplace for cards, coins & bullion. We are Perth-based with nationwide shipping, focused on trust and authenticity for Australian collectors.',
};

const principles = [
  {
    icon: <ShieldCheck className="h-8 w-8 text-primary" />,
    title: "Trust & Authenticity",
    description: "Every transaction is backed by our commitment to authenticity. With features like AI-powered grading and optional vault verification, we build a marketplace you can rely on."
  },
  {
    icon: <MapPin className="h-8 w-8 text-primary" />,
    title: "Local Focus, National Reach",
    description: "Proudly based in Perth, we provide a focused local hub for WA collectors while offering competitive nationwide shipping to connect communities across Australia."
  },
  {
    icon: <Sparkles className="h-8 w-8 text-primary" />,
    title: "AI-Powered Innovation",
    description: "We leverage cutting-edge AI to make listing easier, provide accurate pricing insights, and help you discover your next great find faster than ever before."
  },
    {
    icon: <Handshake className="h-8 w-8 text-primary" />,
    title: "By Collectors, For Collectors",
    description: "Picksy was founded by passionate collectors who understand the nuances of the hobby. Our platform is built with the features that matter most to you."
  }
]

export default function AboutPage() {
  return (
    <div className="bg-gray-50/50">
      <div className="container py-12 md:py-16">
        <PageHeader
          title="Our Story"
          description="Australiaâ€™s local marketplace for cards, coins & bullion â€” Perth-based, with nationwide shipping."
        />
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-center mt-8">
            <div className="prose lg:prose-lg max-w-none">
                <p>
                Picksy was born from a simple frustration shared by collectors across Australia: the existing options just weren&apos;t good enough. We were tired of navigating global platforms with exorbitant fees, unreliable international shipping, and a constant worry about authenticity. We believed Australian collectors deserved a dedicated, trustworthy, and modern marketplace.
                </p>
                <p>
                Our mission is to create that platform. From our home base in Perth, Western Australia, we&apos;re building a community-focused marketplace that leverages technology to solve the biggest problems in the hobby. We&apos;re connecting passionate sellers with discerning buyers, all within a framework of trust and security.
                </p>
                <p>
                Whether you&apos;re hunting for a rare pre-decimal coin, a graded PokÃ©mon card, or the latest gold bullion, Picksy is your home for collecting in Australia.
                </p>
            </div>
            <div className="relative aspect-video rounded-xl overflow-hidden shadow-lg">
                <Image 
                    src="https://images.unsplash.com/photo-1583912268183-a34d4a132dc0?q=80&w=1740&auto=format&fit=crop"
                    alt="A collection of vintage items on a table"
                    fill
                    className="object-cover"
                    data-ai-hint="collecting vintage"
                />
            </div>
        </div>

        <div className="mt-16 md:mt-24">
            <h2 className="text-3xl font-bold text-center mb-12 font-headline">Our Core Principles</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                {principles.map((p) => (
                    <Card key={p.title} className="text-center">
                        <CardHeader>
                            <div className="mx-auto bg-primary/10 p-4 rounded-full w-fit mb-2">
                                {p.icon}
                            </div>
                            <CardTitle>{p.title}</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <p className="text-sm text-muted-foreground">{p.description}</p>
                        </CardContent>
                    </Card>
                ))}
            </div>
        </div>

      </div>
    </div>
  );
}

================================================================================
FILE: src/app/actions/admin-stats.ts
================================================================================
'use server';

import { firestoreDb } from '@/lib/firebase/admin';

export interface AdminStats {
    totalListings: number;
    activeSellers: number;
    totalRevenue: number;
    pendingOrders: number;
}

export async function getAdminStats(): Promise<AdminStats> {
    try {
        // 1. Total Listings
        const productsSnapshot = await firestoreDb.collection('products').count().get();
        const totalListings = productsSnapshot.data().count;

        // 2. Active Sellers (Users with role 'seller' or just total users if roles undefined)
        // For now, let's count all users
        const sellersSnapshot = await firestoreDb.collection('users').count().get();
        const activeSellers = sellersSnapshot.data().count;

        // 3. Total Revenue & Pending Orders
        // We'll approximate this for now if orders collection exists
        let totalRevenue = 0;
        let pendingOrders = 0;

        try {
            const ordersRef = firestoreDb.collection('orders');
            const ordersSnapshot = await ordersRef.get(); // Warning: getting all orders might be heavy later

            // If we have many orders, this should be an aggregation query instead

            // Using logic: if we can, use aggregation for count at least
            const pendingSnapshot = await ordersRef.where('status', '==', 'pending').count().get();
            pendingOrders = pendingSnapshot.data().count;

            // For revenue, we need to sum. Firestore doesn't support sum aggregation natively in all SDK versions yet,
            // but recent Admin SDKs do. Let's try to be safe and just fetch fields if possible, or skip revenue for now
            // to avoid reading all docs.
            // Let's set revenue to 0 for MVP to avoid "Read all docs" cost spike
            totalRevenue = 0;

        } catch (e) {
            console.warn("Could not fetch orders stats:", e);
        }

        return {
            totalListings,
            activeSellers,
            totalRevenue,
            pendingOrders
        };
    } catch (error) {
        console.error('Error fetching admin stats:', error);
        return {
            totalListings: 0,
            activeSellers: 0,
            totalRevenue: 0,
            pendingOrders: 0
        };
    }
}

================================================================================
FILE: src/app/actions/admin-users.ts
================================================================================

'use server';

import { auth, firestoreDb, admin } from '@/lib/firebase/admin';
import { verifyIdToken } from '@/lib/firebase/auth-admin';
import type { UserProfile, UserRole } from '@/lib/types';
import { revalidatePath } from 'next/cache';

export type ActionResponse = {
    success: boolean;
    message: string;
};

export interface AdminUser extends UserProfile {
    uid: string;
    disabled: boolean;
    lastSignInTime?: string;
}

const mapUserRecordToAdminUser = (user: any, profile?: UserProfile): AdminUser => ({
    uid: user.uid,
    id: user.uid,
    displayName: user.displayName || profile?.displayName || 'N/A',
    email: user.email || 'N/A',
    photoURL: user.photoURL || profile?.photoURL,
    role: profile?.role || 'viewer',
    canSell: profile?.canSell || false,
    disabled: user.disabled,
    lastSignInTime: user.metadata.lastSignInTime,
    // Convert Firestore Timestamp to string or Date to a serializable format
    createdAt: profile?.createdAt && (profile.createdAt as any).toDate ? (profile.createdAt as any).toDate().toISOString() : profile?.createdAt,
});

/**
 * Super-admin action to create a new user.
 */
export async function createNewUser(
    idToken: string,
    userData: { email: string; password; displayName: string; role: UserRole; }
): Promise<ActionResponse> {
    try {
        const decodedToken = await verifyIdToken(idToken);
        if (decodedToken.role !== 'superadmin') { // Super admin check
            return { success: false, message: 'Permission denied.' };
        }

        const { email, password, displayName, role } = userData;

        // Create user in Firebase Auth
        const userRecord = await admin.auth().createUser({
            email,
            password,
            displayName,
            emailVerified: true,
        });

        // Create user profile in Firestore
        const profileData: Partial<UserProfile> = {
            displayName,
            email,
            role,
            canSell: ['seller', 'admin', 'superadmin'].includes(role),
            createdAt: new Date() as any, // Firestore admin SDK handles this
        };
        await firestoreDb.collection('users').doc(userRecord.uid).set(profileData);

        // Set custom claims for role-based security in server actions
        await admin.auth().setCustomUserClaims(userRecord.uid, { role, admin: ['admin', 'superadmin'].includes(role) });

        revalidatePath('/admin/users');
        return { success: true, message: `User ${displayName} created successfully.` };

    } catch (error: any) {
        console.error('Error creating user:', error);
        return { success: false, message: error.message || 'Failed to create user.' };
    }
}

/**
 * Get all users for the admin panel.
 */
export async function getAllUsers(idToken: string): Promise<{ users?: AdminUser[], error?: string }> {
    try {
        const decodedToken = await verifyIdToken(idToken);
        // Check for admin or superadmin role
        const role = decodedToken.role || (decodedToken.admin ? 'admin' : null);
        if (role !== 'superadmin' && role !== 'admin') {
            console.error('Permission denied. User role:', role);
            return { error: 'Permission denied. Admins only.' };
        }

        const userRecords = await admin.auth().listUsers();
        const uids = userRecords.users.map(u => u.uid);

        if (uids.length === 0) {
            return { users: [] };
        }

        // Fetch all profiles in chunks (Firestore 'in' limit is 10)
        const chunk = (arr: string[], size: number) => {
            const out = [];
            for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
            return out;
        };

        const profilesMap = new Map<string, UserProfile>();
        const uidChunks = chunk(uids, 10);

        for (const chunkUids of uidChunks) {
            const snap = await firestoreDb.collection('users').where(admin.firestore.FieldPath.documentId(), 'in', chunkUids).get();
            snap.forEach(doc => {
                profilesMap.set(doc.id, { id: doc.id, ...doc.data() } as UserProfile);
            });
        }

        const adminUsers: AdminUser[] = userRecords.users.map(user => {
            const profile = profilesMap.get(user.uid);
            return mapUserRecordToAdminUser(user, profile);
        });

        return { users: adminUsers };

    } catch (error: any) {
        console.error('Error fetching users:', error);
        return { error: error.message || 'Failed to fetch users.' };
    }
}


/**
 * Update a user's role.
 */
export async function updateUserRole(idToken: string, userId: string, newRole: UserRole): Promise<ActionResponse> {
    try {
        const decodedToken = await verifyIdToken(idToken);
        if (decodedToken.role !== 'superadmin') { // Super admin check
            return { success: false, message: 'Permission denied.' };
        }

        const canSell = ['seller', 'admin', 'superadmin'].includes(newRole);

        await firestoreDb.collection('users').doc(userId).update({
            role: newRole,
            canSell: canSell,
        });

        // Sync to custom claims
        await admin.auth().setCustomUserClaims(userId, {
            role: newRole,
            admin: ['admin', 'superadmin'].includes(newRole)
        });

        revalidatePath('/admin/users');
        return { success: true, message: "User role updated." };
    } catch (error: any) {
        console.error('Error updating role:', error);
        return { success: false, message: 'Failed to update role.' };
    }
}

/**
 * Toggle a user's ban status.
 */
export async function toggleUserBan(idToken: string, userId: string, currentStatus: 'active' | 'banned'): Promise<ActionResponse> {
    try {
        const decodedToken = await verifyIdToken(idToken);
        if (decodedToken.role !== 'superadmin') {
            return { success: false, message: 'Permission denied.' };
        }

        const isDisabled = currentStatus === 'active';
        await admin.auth().updateUser(userId, { disabled: isDisabled });

        revalidatePath('/admin/users');
        return { success: true, message: `User has been ${isDisabled ? 'banned' : 'unbanned'}.` };

    } catch (error: any) {
        console.error('Error toggling ban:', error);
        return { success: false, message: 'Failed to update user status.' };
    }
}

================================================================================
FILE: src/app/actions/admin.ts
================================================================================
'use server';

import { firestoreDb } from '@/lib/firebase/admin';
import { verifyIdToken } from '@/lib/firebase/auth-admin';
import { Product } from '@/lib/types';
import { notifySellerOfRemoval } from '@/ai/flows/notify-seller-of-removal';

/**
 * Result type for admin actions, ensuring a consistent response shape.
 */
export type AdminActionResult =
    | { success: true; message: string }
    | { success: false; error: string };

/**
 * An admin-only action to delete a product and notify the seller.
 * @param productId The ID of the product to delete.
 * @param idToken The Firebase ID token of the admin user.
 * @returns A promise that resolves to an AdminActionResult.
 */
export async function deleteProductByAdmin(
    productId: string,
    idToken: string
): Promise<AdminActionResult> {
    if (!productId || !idToken) {
        return {
            success: false,
            error: 'Product ID and authentication token are required.',
        };
    }

    try {
        // 1. Verify the user has the 'superadmin' role from the token's custom claims.
        const decodedToken = await verifyIdToken(idToken);
        const userRole = decodedToken.role;

        if (userRole !== 'superadmin') {
            return {
                success: false,
                error: 'You do not have permission to perform this action.',
            };
        }

        const productRef = firestoreDb.collection('products').doc(productId);
        const productSnap = await productRef.get();

        if (!productSnap.exists) {
            return { success: false, error: 'Product not found.' };
        }

        const product = productSnap.data() as Product;

        // 2. Delete the Product
        await productRef.delete();

        // 3. Notify the Seller via AI Flow (non-blocking)
        let notificationStatus = '';
        if (product.sellerEmail && product.sellerEmail.trim() !== '') {
            try {
                await notifySellerOfRemoval({
                    sellerEmail: product.sellerEmail,
                    sellerName: product.sellerName || 'Seller', // Fallback for sellerName
                    productName: product.title,
                });
                notificationStatus = ' and the seller has been notified';
            } catch (notifyError: any) {
                console.error('Failed to notify seller, but product was deleted:', notifyError);
                // Don't fail the entire operation if notification fails.
                notificationStatus = ' but failed to notify the seller';
            }
        }

        return {
            success: true,
            message: `Product "${product.title}" has been deleted${notificationStatus}.`,
        };

    } catch (error: any) {
        console.error('Admin Delete Product Error:', error);
        return {
            success: false,
            error: error.message || 'An unexpected error occurred during deletion.',
        };
    }
}

================================================================================
FILE: src/app/actions/ai-grading.ts
================================================================================
'use server';

import { gradeCardDetails as gradeCardDetailsFlow } from '@/ai/flows/grade-card-details';
import { suggestListingDetails as suggestListingDetailsFlow, SuggestListingDetailsOutput } from '@/ai/flows/suggest-listing-details';
import { GradeCardDetailsOutput } from '@/ai/schemas/grading-schemas';

export async function gradeCardDetailsAction(input: {
    frontImageDataUri: string;
    backImageDataUri?: string;
    cardName?: string;
    idToken?: string;
}): Promise<GradeCardDetailsOutput> {
    return await gradeCardDetailsFlow(input);
}

export async function suggestListingDetailsAction(input: {
    photoDataUris: string[];
    title?: string;
    idToken?: string;
}): Promise<SuggestListingDetailsOutput> {
    try {
        return await suggestListingDetailsFlow(input);
    } catch (error: any) {
        console.error('suggestListingDetailsAction error:', error);
        throw error;
    }
}

================================================================================
FILE: src/app/actions/bulk-products.ts
================================================================================

'use server';

import * as admin from 'firebase-admin';
import { firestoreDb } from '@/lib/firebase/admin';
import { verifyIdToken } from '@/lib/firebase/auth-admin';
import type { Product, UserProfile } from '@/lib/types';
import { revalidatePath } from 'next/cache';

type BulkCreateProductData = {
    title: string;
    description: string;
    price: number;
    category: string;
    subCategory?: string;
    condition: string;
    quantity: number;
    imageUrls: string[];
};

export type BulkCreateProductResult = 
    | { success: true; count: number; }
    | { success: false; error: string; };

export async function bulkCreateProductsFromCSV(
    idToken: string,
    productsData: BulkCreateProductData[]
): Promise<BulkCreateProductResult> {
    try {
        const decodedToken = await verifyIdToken(idToken);
        const userRef = firestoreDb.collection('users').doc(decodedToken.uid);
        const userSnap = await userRef.get();

        if (!userSnap.exists) {
            return { success: false, error: 'User profile not found.' };
        }

        const userProfile = userSnap.data() as UserProfile;

        if (userProfile.role !== 'superadmin' && userProfile.canSell !== true) {
            return { success: false, error: 'You do not have permission to list products.' };
        }

        const batch = firestoreDb.batch();
        const productsCollection = firestoreDb.collection("products");

        productsData.forEach(productData => {
            const docRef = productsCollection.doc(); // Auto-generate ID
            
            const finalData: Product = {
                ...(productData as Omit<Product, 'id' | 'sellerId' | 'sellerEmail' | 'sellerName' | 'sellerAvatar' | 'status' | 'isDraft' | 'createdAt' | 'updatedAt'>),
                id: docRef.id,
                sellerId: decodedToken.uid,
                sellerEmail: decodedToken.email || '',
                sellerName: userProfile.displayName,
                sellerAvatar: userProfile.photoURL,
                status: 'available',
                isDraft: false,
                createdAt: admin.firestore.FieldValue.serverTimestamp() as admin.firestore.Timestamp,
                updatedAt: admin.firestore.FieldValue.serverTimestamp() as admin.firestore.Timestamp,
            };
            
            batch.set(docRef, finalData);
        });

        await batch.commit();

        // TODO: The revalidatePath calls below can be a performance bottleneck in a multi-user environment.
        // Consider switching to Incremental Static Regeneration (ISR) with a revalidation time on the affected pages 
        // to avoid revalidating on every single product creation.
        revalidatePath('/browse');
        revalidatePath('/sell/dashboard');
        revalidatePath(`/profile/listings`);

        return { success: true, count: productsData.length };

    } catch (error: any) {
        console.error("Error bulk creating products:", error);
        return { success: false, error: error.message || 'An unexpected error occurred during bulk creation.' };
    }
}

================================================================================
FILE: src/app/actions/newsletter.ts
================================================================================
'use server';

import { z } from "zod";
import { db } from "@/lib/firebase/config";
import { collection, addDoc, Timestamp } from "firebase/firestore";

const NewsletterSchema = z.object({
    email: z.string().email("Please enter a valid email address."),
});

export type NewsletterState = {
    success?: boolean;
    error?: string;
    message?: string;
};

export async function subscribeToNewsletter(
    prevState: NewsletterState,
    formData: FormData
): Promise<NewsletterState> {
    const email = formData.get("email");

    const validatedFields = NewsletterSchema.safeParse({ email });

    if (!validatedFields.success) {
        return {
            success: false,
            error: validatedFields.error.flatten().fieldErrors.email?.[0] || "Invalid email.",
        };
    }

    try {
        await addDoc(collection(db, "newsletter_subscribers"), {
            email: validatedFields.data.email,
            subscribedAt: Timestamp.now(),
            source: "footer_v1",
        });

        return {
            success: true,
            message: "Thanks for subscribing!",
        };
    } catch (e) {
        console.error("Newsletter subscription error:", e);
        return {
            success: false,
            error: "Something went wrong. Please try again.",
        };
    }
}

================================================================================
FILE: src/app/actions/order.ts
================================================================================

'use server'

import { firestoreDb } from '@/lib/firebase/admin';
import { verifyIdToken } from '@/lib/firebase/auth-admin';
import { FieldValue } from 'firebase-admin/firestore';
import type { Product } from '@/lib/types';
import { serializeFirestoreDoc } from '@/lib/firebase/serializers';

interface CartItem {
    id: string;
    quantity: number;
}

export async function createOrderAction(items: CartItem[], idToken: string) {
    if (!items || items.length === 0) {
        return { error: 'Your cart is empty.' };
    }

    try {
        // 1. Verify User
        const decodedToken = await verifyIdToken(idToken);
        const { uid: buyerId, email: buyerEmail } = decodedToken;

        const orderDetails = await firestoreDb.runTransaction(async (t) => {
            let subtotal = 0;
            const productRefs = items.map(item => firestoreDb.collection('products').doc(item.id));
            const productDocs = await t.getAll(...productRefs);

            // 2. Validate Price & Stock
            for (let i = 0; i < items.length; i++) {
                const doc = productDocs[i];
                const item = items[i];
                
                if (!doc.exists) {
                    throw new Error(`Product with ID ${item.id} not found.`);
                }
                
                const product = doc.data() as Product;

                if ((product.quantity || 0) < item.quantity) {
                    throw new Error(`Not enough stock for ${product.title}. Only ${product.quantity} left.`);
                }

                // Use the database price, not the client price
                subtotal += product.price * item.quantity;

                // Prepare inventory deduction
                t.update(doc.ref, { 
                    quantity: FieldValue.increment(-item.quantity),
                    status: (product.quantity || 0) - item.quantity === 0 ? 'sold' : product.status,
                });
            }

            // 3. Calculate Total (server-side)
            const shippingCost = subtotal > 50 ? 0 : 7.99;
            const taxRate = 0.08;
            const taxAmount = subtotal * taxRate;
            const totalAmount = subtotal + shippingCost + taxAmount;

            // 4. Create Order Document
            const orderRef = firestoreDb.collection('orders').doc();
            const newOrder = {
                items: items, // Contains IDs and quantities
                totalAmount,
                buyerId,
                buyerEmail,
                status: 'processing',
                paymentMethod: 'Cash on Delivery',
                createdAt: FieldValue.serverTimestamp(),
            };

            t.set(orderRef, newOrder);

            // Fetch full item details for the confirmation page
            const itemsWithDetails = productDocs.map((doc, i) => {
                return serializeFirestoreDoc({
                    ...(doc.data() as Product),
                    id: doc.id,
                    quantity: items[i].quantity,
                });
            });
            
            // We need to resolve the serverTimestamp sentinel to a client-friendly value (e.g. now)
            // because we can't read back the written time within the same transaction easily/efficiently
            // without a fresh read which might be overkill.
            const serializedOrder = {
                 ...newOrder,
                 createdAt: new Date().toISOString(), // Approximation for client display
                 orderId: orderRef.id,
                 items: itemsWithDetails,
                 totalAmount
            };

            return serializedOrder;
        });

        return { order: orderDetails };

    } catch (error: any) {
        console.error('Order creation failed:', error);
        return { error: error.message || 'An unexpected error occurred.' };
    }
}

================================================================================
FILE: src/app/actions/products.ts
================================================================================
'use server';

import * as admin from 'firebase-admin';
import { firestoreDb } from '@/lib/firebase/admin';
import { verifyIdToken } from '@/lib/firebase/auth-admin';
import type { Product, UserProfile } from '@/lib/types';
import { revalidatePath } from 'next/cache';
import { productFormSchema } from '@/schemas/product';

export type CreateProductResult =
    | { success: true; productId: string; }
    | { success: false; error: string; };

export async function createProductAction(
    idToken: string,
    productData: Partial<Product>
): Promise<CreateProductResult> {
    console.log('=== CREATE PRODUCT ACTION START ===');
    console.log('productData received keys:', Object.keys(productData));
    // console.log('productData:', JSON.stringify(productData, null, 2)); // Careful with PII

    try {
        const decodedToken = await verifyIdToken(idToken);
        console.log('Token verified for UID:', decodedToken.uid);

        const userRef = firestoreDb.collection('users').doc(decodedToken.uid);
        const userSnap = await userRef.get();

        if (!userSnap.exists) {
            console.error('User profile not found');
            return { success: false, error: 'User profile not found.' };
        }

        const userProfile = userSnap.data() as UserProfile;
        console.log('User Profile:', {
            uid: decodedToken.uid,
            email: decodedToken.email,
            role: userProfile.role,
            canSell: userProfile.canSell,
            profileExists: userSnap.exists,
        });

        // Check for permission to sell
        if (userProfile.role !== 'superadmin' && userProfile.canSell !== true) {
            console.error('PERMISSION DENIED: User cannot sell');
            return { success: false, error: 'You do not have permission to list products.' };
        }

        const productsCollection = firestoreDb.collection("products");
        const docRef = productsCollection.doc(); // Auto-generate ID

        // Validate incoming data against schema
        console.log('Validating data...');
        console.log('Raw productData before validation:', JSON.stringify(productData, null, 2));
        const validationResult = productFormSchema.safeParse(productData);

        if (!validationResult.success) {
            console.error('VALIDATION FAILED!');
            console.error('Validation Errors:', JSON.stringify(validationResult.error.errors, null, 2));
            const errorMessages = validationResult.error.errors.map(e => `${e.path.join('.')}: ${e.message}`).join(', ');
            return { success: false, error: `Validation Failed: ${errorMessages}` };
        }

        console.log('Validation successful.');
        const validData = validationResult.data;

        // Note: validData from Zod might strip unknown keys if not configured to passthrough.
        // We ensure we cast it to Product structure for Firestore.

        const finalData: Product = {
            ...validData, // Safe spread of validated properties
            id: docRef.id,
            sellerId: decodedToken.uid,
            sellerEmail: decodedToken.email || '',
            sellerName: userProfile.displayName,
            sellerAvatar: userProfile.photoURL,
            // Cast timestamps because Admin SDK uses a different class than client/type definition might expect
            createdAt: admin.firestore.FieldValue.serverTimestamp() as any,
            updatedAt: admin.firestore.FieldValue.serverTimestamp() as any,
        };

        console.log('Saving to Firestore...');
        await docRef.set(finalData);
        console.log('Product saved:', docRef.id);

        revalidatePath('/browse');
        revalidatePath(`/product/${docRef.id}`);

        return { success: true, productId: docRef.id };

    } catch (error: any) {
        console.error("Error in createProductAction:", error);
        return { success: false, error: error.message || 'An unexpected error occurred.' };
    }
}

export async function recordProductView(productId: string, userId?: string) {
    const productRef = firestoreDb.collection('products').doc(productId);

    return firestoreDb.runTransaction(async (transaction) => {
        const productDoc = await transaction.get(productRef);

        if (!productDoc.exists) {
            // Silently fail if product doesn't exist to avoid client errors
            return;
        }

        const updates: any = {
            views: admin.firestore.FieldValue.increment(1),
            lastViewedTimestamp: admin.firestore.FieldValue.serverTimestamp(),
        };

        if (userId) {
            const data = productDoc.data();
            const viewedByUsers = data?.viewedByUsers || [];
            if (!viewedByUsers.includes(userId)) {
                updates.uniqueViews = admin.firestore.FieldValue.increment(1);
                updates.viewedByUsers = admin.firestore.FieldValue.arrayUnion(userId);
            }
        }

        transaction.update(productRef, updates);
    });
}
================================================================================
FILE: src/app/actions/research.ts
================================================================================
'use server';

import { firestoreDb as db } from '@/lib/firebase/admin';
import { defaultPlayers } from '@/lib/research-types';
import type { Player, ScanHistoryItem } from '@/lib/research-types';

// Helper to get user ref
const getUserRef = (uid: string) => db.collection('users').doc(uid);

/**
 * Get the list of players to keep for a specific user.
 * Stored in users/{uid}/research/preferences
 */
export async function getResearchPreferences(uid: string): Promise<Player[]> {
    try {
        const docRef = getUserRef(uid).collection('research').doc('preferences');
        const docSnap = await docRef.get();

        if (!docSnap.exists) {
            // Initialize with defaults if not exists
            await docRef.set({ namesToKeep: defaultPlayers });
            return defaultPlayers;
        }

        const data = docSnap.data();
        return (data?.namesToKeep as Player[]) || defaultPlayers;
    } catch (error) {
        console.error('Error fetching research preferences:', error);
        return defaultPlayers;
    }
}

/**
 * Add a player to the keep list.
 */
export async function addPlayerToKeepList(uid: string, player: Player): Promise<Player[]> {
    try {
        const docRef = getUserRef(uid).collection('research').doc('preferences');
        const docSnap = await docRef.get();

        let currentList: Player[] = defaultPlayers;
        if (docSnap.exists) {
            const data = docSnap.data();
            currentList = (data?.namesToKeep as Player[]) || defaultPlayers;
        }

        // Check strict duplication
        if (currentList.some(p => p.name.toLowerCase() === player.name.toLowerCase())) {
            return currentList;
        }

        const newList = [...currentList, player].sort((a, b) => a.name.localeCompare(b.name));

        await docRef.set({ namesToKeep: newList }, { merge: true });
        return newList;
    } catch (error) {
        console.error('Error adding player to keep list:', error);
        throw new Error('Failed to update keep list');
    }
}

/**
 * Remove a player from the keep list.
 */
export async function removePlayerFromKeepList(uid: string, playerName: string): Promise<Player[]> {
    try {
        const docRef = getUserRef(uid).collection('research').doc('preferences');
        const docSnap = await docRef.get();

        if (!docSnap.exists) return defaultPlayers;

        const data = docSnap.data();
        const currentList = (data?.namesToKeep as Player[]) || defaultPlayers;

        const newList = currentList.filter(p => p.name !== playerName);

        await docRef.set({ namesToKeep: newList }, { merge: true });
        return newList;
    } catch (error) {
        console.error('Error removing player from keep list:', error);
        throw new Error('Failed to update keep list');
    }
}


/**
 * Fetch scan history for a user.
 * Stored in users/{uid}/scan_history subcollection
 */
export async function getScanHistory(uid: string): Promise<ScanHistoryItem[]> {
    try {
        const historyRef = getUserRef(uid).collection('scan_history').orderBy('timestamp', 'desc').limit(100);
        const snapshot = await historyRef.get();

        const history: ScanHistoryItem[] = snapshot.docs.map((doc: any) => {
            const data = doc.data();
            return {
                id: doc.id,
                ...data,
                timestamp: data.timestamp.toDate(), // Convert Firestore Timestamp to JS Date
            } as ScanHistoryItem;
        });

        return history;
    } catch (error) {
        console.error('Error fetching scan history:', error);
        return [];
    }
}

/**
 * Add a new scan result to history.
 */
export async function addScanResult(uid: string, result: ScanHistoryItem): Promise<void> {
    try {
        const historyRef = getUserRef(uid).collection('scan_history').doc(result.id);

        // Ensure timestamp is a Date object or Firestore Timestamp compatible format
        const dataToSave = {
            ...result,
            timestamp: new Date(), // Always use server time or fresh date
        };

        await historyRef.set(dataToSave);
    } catch (error) {
        console.error('Error saving scan result:', error);
        throw new Error('Failed to save scan result');
    }
}

/**
 * Delete a scan history item.
 */
export async function deleteScanResult(uid: string, scanId: string): Promise<void> {
    try {
        await getUserRef(uid).collection('scan_history').doc(scanId).delete();
    } catch (error) {
        console.error('Error deleting scan result:', error);
        throw new Error('Failed to delete history item');
    }
}

================================================================================
FILE: src/app/actions/sell.ts
================================================================================
'use server';

import { firestoreDb as db } from '@/lib/firebase/admin';
import { FieldValue } from 'firebase-admin/firestore';
import { serializeFirestoreDoc } from '@/lib/firebase/serializers';

export interface DraftListingData {
    userId: string;
    title: string;
    description: string;
    price: number;
    category: string;
    subCategory?: string;
    condition: string;
    manufacturer?: string;
    year?: number;
    cardNumber?: string;
    quantity: number;
    isReverseBidding: boolean;
    autoRepricingEnabled: boolean;
    isVault: boolean;
    imageUrls: string[];
    status: 'draft' | 'available';
    createdAt: FieldValue;
    updatedAt: FieldValue;
}

/**
 * Creates or updates a draft listing in Firestore.
 * Returns the draft ID.
 */
export async function saveDraftListing(userId: string, data: Omit<DraftListingData, 'userId' | 'status' | 'createdAt' | 'updatedAt'>, draftId?: string): Promise<string> {
    if (!userId) {
        throw new Error("Unauthorized: User ID is required.");
    }

    const listingData = {
        ...data,
        userId,
        status: 'draft',
        updatedAt: FieldValue.serverTimestamp(),
    };

    try {
        if (draftId) {
            // Update existing draft
            await db.collection('products').doc(draftId).set(listingData, { merge: true });
            return draftId;
        } else {
            // Create new draft
            const docRef = await db.collection('products').add({
                ...listingData,
                createdAt: FieldValue.serverTimestamp(),
            });
            return docRef.id;
        }
    } catch (error) {
        console.error("Error saving draft listing:", error);
        throw new Error("Failed to save draft listing.");
    }
}

/**
 * Retrieves a draft listing by ID.
 * Ensures the listing belongs to the user.
 */
export async function getDraftListing(draftId: string, userId: string): Promise<any> {
    if (!draftId || !userId) return null;

    try {
        const docSnap = await db.collection('products').doc(draftId).get();

        if (!docSnap.exists) {
            throw new Error("Listing not found.");
        }

        const data = docSnap.data();
        if (data?.userId !== userId) {
            throw new Error("Unauthorized access to this listing.");
        }

        return { id: docSnap.id, ...serializeFirestoreDoc(data) };
    } catch (error) {
        console.error("Error fetching draft:", error);
        throw error;
    }
}

/**
 * Publishes a draft listing.
 */
export async function publishListing(draftId: string, userId: string): Promise<void> {
    if (!draftId || !userId) throw new Error("Invalid request.");

    const docRef = db.collection('products').doc(draftId);
    const docSnap = await docRef.get();

    if (!docSnap.exists || docSnap.data()?.userId !== userId) {
        throw new Error("Unauthorized or invalid listing.");
    }

    await docRef.update({
        status: 'available',
        updatedAt: FieldValue.serverTimestamp(),
        isDraft: false
    });
}

================================================================================
FILE: src/app/actions/stats.ts
================================================================================
'use server';

import { firestoreDb } from '@/lib/firebase/admin';
import { verifyIdToken } from '@/lib/firebase/auth-admin';

export async function getPlatformStats(idToken: string): Promise<{ totalItems?: number; totalRevenue?: number; error?: string }> {
  try {
    // Verify the user is an admin
    const decodedToken = await verifyIdToken(idToken);

    // Fetch the user's role directly from Firestore to ensure accuracy
    // This avoids reliance on custom claims which might not be set immediately
    const userDoc = await firestoreDb.collection('users').doc(decodedToken.uid).get();

    if (!userDoc.exists) {
      return { error: 'User profile not found.' };
    }

    const userData = userDoc.data();
    const isAdmin = userData?.isAdmin === true || userData?.role === 'admin' || userData?.role === 'superadmin';

    if (!isAdmin) {
      return { error: 'You do not have permission to view platform statistics.' };
    }

    const docRef = firestoreDb.collection('platform_stats').doc('global');
    const docSnap = await docRef.get();

    if (!docSnap.exists) {
      // Return zeros if the doc hasn't been created yet
      return { totalItems: 0, totalRevenue: 0 };
    }

    const data = docSnap.data();
    return {
      totalItems: data?.totalItems || 0,
      totalRevenue: data?.totalRevenue || 0
    };
  } catch (error: any) {
    console.error("[Stats Action] Failed to fetch platform stats:", {
      message: error.message,
      code: error.code,
      stack: error.stack
    });
    // Return an error payload
    return {
      error: `Server Error: ${error.message}`
    };
  }
}

export async function fetchProductCount(): Promise<number> {
  try {
    const snapshot = await firestoreDb
      .collection('products')
      .where('status', '==', 'available')
      .count()
      .get();
    return snapshot.data().count;
  } catch (error) {
    console.error('Error fetching product count:', error);
    // Return 0 instead of throwing, to prevent 500 error on frontend
    return 0;
  }
}

================================================================================
FILE: src/app/admin/analytics/page.tsx
================================================================================

'use client';

import { PageHeader } from "@/components/layout/PageHeader";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import EmptyState from "@/components/ui/EmptyState";
import { BarChart as BarChartIcon, PieChart as PieChartIcon } from "lucide-react";
import { BarChart, LineChart, PieChart, ResponsiveContainer, XAxis, YAxis, Tooltip, Legend, Bar, Line, Pie } from 'recharts';

// Removed mock data
const salesData: any[] = [];
const categoryData: any[] = [];

export default function AnalyticsPage() {
    return (
        <div>
            <PageHeader
                title="Intelligence Matrix"
                description="Predictive analytics and platform performance metrics."
            />
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                <Card>
                    <CardHeader>
                        <CardTitle>Sales Over Time</CardTitle>
                    </CardHeader>
                    <CardContent>
                        {salesData.length > 0 ? (
                            <ResponsiveContainer width="100%" height={300}>
                                <LineChart data={salesData}>
                                    <XAxis dataKey="name" />
                                    <YAxis />
                                    <Tooltip />
                                    <Legend />
                                    <Line type="monotone" dataKey="revenue" stroke="hsl(var(--primary))" />
                                    <Line type="monotone" dataKey="sales" stroke="hsl(var(--accent))" />
                                </LineChart>
                            </ResponsiveContainer>
                        ) : (
                             <EmptyState
                                icon={<BarChartIcon className="h-12 w-12" />}
                                title="No Sales Data"
                                description="Sales data will appear here once you start making sales."
                                className="h-[300px]"
                            />
                        )}
                    </CardContent>
                </Card>
                 <Card>
                    <CardHeader>
                        <CardTitle>Category Distribution</CardTitle>
                    </CardHeader>
                    <CardContent>
                       {categoryData.length > 0 ? (
                            <ResponsiveContainer width="100%" height={300}>
                                <PieChart>
                                    <Pie dataKey="value" data={categoryData} fill="hsl(var(--primary))" label />
                                    <Tooltip />
                                </PieChart>
                            </ResponsiveContainer>
                       ) : (
                             <EmptyState
                                icon={<PieChartIcon className="h-12 w-12" />}
                                title="No Category Data"
                                description="Category distribution will be shown here as items are listed."
                                className="h-[300px]"
                            />
                       )}
                    </CardContent>
                </Card>
            </div>
        </div>
    );
}

================================================================================
FILE: src/app/admin/auto-repricing/actions.ts
================================================================================
'use server';

import { db } from '@/lib/firebase/config';
import { doc, setDoc, getDoc } from 'firebase/firestore';

const SETTINGS_DOC_ID = 'auto_repricing_settings';

interface AutoRepricingSettings {
    viewThreshold: number;
    priceDropPercentage: number;
    waitingPeriodHours: number;
}

export async function saveAutoRepricingSettings(settings: AutoRepricingSettings) {
    try {
        const settingsRef = doc(db, 'settings', SETTINGS_DOC_ID);
        await setDoc(settingsRef, settings, { merge: true });
        return { success: true, message: 'Auto-repricing settings saved successfully.' };
    } catch (error) {
        console.error('Error saving auto-repricing settings:', error);
        return { success: false, message: 'Failed to save auto-repricing settings.' };
    }
}

export async function getAutoRepricingSettings(): Promise<AutoRepricingSettings | null> {
    try {
        const settingsRef = doc(db, 'settings', SETTINGS_DOC_ID);
        const docSnap = await getDoc(settingsRef);
        if (docSnap.exists()) {
            return docSnap.data() as AutoRepricingSettings;
        }
        return null;
    } catch (error) {
        console.error('Error fetching auto-repricing settings:', error);
        return null;
    }
}

================================================================================
FILE: src/app/admin/auto-repricing/page.tsx
================================================================================
'use client';

import { PageHeader } from '@/components/layout/PageHeader';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { useState, useEffect } from 'react';
import { useToast } from '@/hooks/use-toast';
import { getAutoRepricingSettings, saveAutoRepricingSettings } from './actions';
import { Loader2 } from 'lucide-react';

export default function AutoRepricingPage() {
    const { toast } = useToast();
    const [viewThreshold, setViewThreshold] = useState<number>(100);
    const [priceDropPercentage, setPriceDropPercentage] = useState<number>(3);
    const [waitingPeriodHours, setWaitingPeriodHours] = useState<number>(48);
    const [isLoading, setIsLoading] = useState(true);
    const [isSaving, setIsSaving] = useState(false);

    useEffect(() => {
        async function loadSettings() {
            setIsLoading(true);
            const settings = await getAutoRepricingSettings();
            if (settings) {
                setViewThreshold(settings.viewThreshold);
                setPriceDropPercentage(settings.priceDropPercentage);
                setWaitingPeriodHours(settings.waitingPeriodHours);
            }
            setIsLoading(false);
        }
        loadSettings();
    }, []);

    const handleSaveSettings = async () => {
        setIsSaving(true);
        const result = await saveAutoRepricingSettings({
            viewThreshold,
            priceDropPercentage,
            waitingPeriodHours
        });
        
        if (result.success) {
            toast({
                title: "Settings Saved",
                description: result.message,
            });
        } else {
            toast({
                variant: "destructive",
                title: "Error",
                description: result.message,
            });
        }
        setIsSaving(false);
    };

    if (isLoading) {
        return (
            <div className="container mx-auto py-8 text-center">
                <Loader2 className="h-12 w-12 animate-spin text-primary mx-auto" />
                <p className="mt-4 text-muted-foreground">Loading settings...</p>
            </div>
        );
    }

    return (
        <div className="container mx-auto py-8">
            <PageHeader
                title="Auto-Repricing Settings"
                description="Configure the logic for automated product price adjustments."
            />

            <Card className="mt-8">
                <CardHeader>
                    <CardTitle>Global Auto-Repricing Rules</CardTitle>
                    <CardDescription>
                        These settings will apply to all products with auto-repricing enabled.
                    </CardDescription>
                </CardHeader>
                <CardContent className="space-y-6">
                    <div>
                        <Label htmlFor="viewThreshold">Unique View Threshold</Label>
                        <Input
                            id="viewThreshold"
                            type="number"
                            min="1"
                            value={viewThreshold}
                            onChange={(e) => setViewThreshold(parseInt(e.target.value))}
                            className="mt-1"
                        />
                        <p className="text-sm text-muted-foreground mt-1">
                            Price adjustment will be triggered once this number of unique views is reached.
                        </p>
                    </div>
                    <div>
                        <Label htmlFor="priceDropPercentage">Price Drop Percentage (%)</Label>
                        <Input
                            id="priceDropPercentage"
                            type="number"
                            min="1"
                            max="100"
                            value={priceDropPercentage}
                            onChange={(e) => setPriceDropPercentage(parseInt(e.target.value))}
                            className="mt-1"
                        />
                        <p className="text-sm text-muted-foreground mt-1">
                            The percentage by which the price will be reduced.
                        </p>
                    </div>
                    <div>
                        <Label htmlFor="waitingPeriodHours">Waiting Period (hours)</Label>
                        <Input
                            id="waitingPeriodHours"
                            type="number"
                            min="0"
                            value={waitingPeriodHours}
                            onChange={(e) => setWaitingPeriodHours(parseInt(e.target.value))}
                            className="mt-1"
                        />
                        <p className="text-sm text-muted-foreground mt-1">
                            Time to wait after the view threshold is met before reducing the price.
                        </p>
                    </div>
                    <div className="text-right">
                        <Button onClick={handleSaveSettings} disabled={isSaving}>
                            {isSaving ? (
                                <>
                                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                    Saving...
                                </>
                            ) : (
                                "Save Settings"
                            )}
                        </Button>
                    </div>
                </CardContent>
            </Card>
        </div>
    );
}

================================================================================
FILE: src/app/admin/bulk-editor/actions.ts
================================================================================
'use server';

import { getAllProducts } from '@/services/product-service';
import { db } from '@/lib/firebase/config';
import { writeBatch, doc } from 'firebase/firestore';

export async function getProductsForBulkEdit() {
    try {
        const products = await getAllProducts();
        return products;
    } catch (error) {
        console.error('Error fetching products for bulk edit:', error);
        return [];
    }
}

export async function bulkUpdateProducts(productIds: string[], updates: { price?: number; condition?: string; status?: string; }) {
    try {
        if (productIds.length === 0) {
            return { success: false, message: "No products selected." };
        }

        const batch = writeBatch(db);
        const updateData: any = {};

        if (updates.price) updateData.price = updates.price;
        if (updates.condition) updateData.condition = updates.condition;
        if (updates.status) updateData.status = updates.status;

        if (Object.keys(updateData).length === 0) {
            return { success: false, message: "No update fields provided." };
        }

        productIds.forEach(id => {
            const productRef = doc(db, 'products', id);
            batch.update(productRef, updateData);
        });

        await batch.commit();

        return { success: true, message: `${productIds.length} products updated successfully.` };

    } catch (error) {
        console.error("Error in bulkUpdateProducts:", error);
        return { success: false, message: "An unexpected error occurred during the bulk update." };
    }
}

================================================================================
FILE: src/app/admin/bulk-editor/page.tsx
================================================================================
'use client';

import { useEffect, useState } from 'react';
import { PageHeader } from '@/components/layout/PageHeader';
import { getProductsForBulkEdit } from './actions';
import type { Product } from '@/lib/types';
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from '@/components/ui/table';
import { Checkbox } from '@/components/ui/checkbox';
import Image from 'next/image';
import { Badge } from '@/components/ui/badge';
import { format } from 'date-fns';
import { Button } from '@/components/ui/button';
import { Loader2 } from 'lucide-react';
import { Input } from '@/components/ui/input';
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from '@/components/ui/select';
import { useToast } from '@/hooks/use-toast';


const CONDITION_OPTIONS = ['Mint', 'Near Mint', 'Excellent', 'Good', 'Fair', 'Poor'];
const STATUS_OPTIONS = ['available', 'sold', 'draft'];

export default function BulkEditorPage() {
    const { toast } = useToast();
    const [products, setProducts] = useState<Product[]>([]);
    const [loading, setLoading] = useState(true);
    const [selectedProductIds, setSelectedProductIds] = useState<Set<string>>(new Set());

    const [newPrice, setNewPrice] = useState<string>('');
    const [newCondition, setNewCondition] = useState<string>('');
    const [newStatus, setNewStatus] = useState<string>('');

    useEffect(() => {
        async function fetchProducts() {
            setLoading(true);
            const fetchedProducts = await getProductsForBulkEdit();
            setProducts(fetchedProducts);
            setLoading(false);
        }
        fetchProducts();
    }, []);

    const handleSelectProduct = (productId: string, isSelected: boolean) => {
        setSelectedProductIds(prev => {
            const newSelection = new Set(prev);
            if (isSelected) {
                newSelection.add(productId);
            } else {
                newSelection.delete(productId);
            }
            return newSelection;
        });
    };

    const handleSelectAll = (isSelected: boolean) => {
        if (isSelected) {
            const allProductIds = new Set(products.map(p => p.id));
            setSelectedProductIds(allProductIds);
        } else {
            setSelectedProductIds(new Set());
        }
    };


    const [isUpdating, setIsUpdating] = useState(false);

    const handleApplyChanges = async () => {
        setIsUpdating(true);
        const updates: any = {};
        if (newPrice) updates.price = parseFloat(newPrice);
        if (newCondition) updates.condition = newCondition;
        if (newStatus) updates.status = newStatus;

        const result = await bulkUpdateProducts(Array.from(selectedProductIds), updates);

        if (result.success) {
            toast({
                title: "Success",
                description: result.message,
            });
            // Refetch products
            const fetchedProducts = await getProductsForBulkEdit();
            setProducts(fetchedProducts);
            setSelectedProductIds(new Set());
            setNewPrice('');
            setNewCondition('');
            setNewStatus('');
        } else {
            toast({
                variant: "destructive",
                title: "Error",
                description: result.message,
            });
        }
        setIsUpdating(false);
    };


    const isAllSelected = products.length > 0 && selectedProductIds.size === products.length;
    const isSomeSelected = selectedProductIds.size > 0 && selectedProductIds.size < products.length;

    if (loading) {
        return (
            <div className="container mx-auto py-8 text-center">
                <Loader2 className="h-12 w-12 animate-spin text-primary mx-auto" />
                <p className="mt-4 text-muted-foreground">Loading products...</p>
            </div>
        );
    }

    return (
        <div className="container mx-auto py-8">
            <PageHeader
                title="Bulk Editor"
                description="Select products to edit their prices, conditions, and statuses in bulk."
            />

            <div className="mt-8">
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead className="w-[50px]">
                                <Checkbox
                                    checked={isAllSelected || isSomeSelected ? (isAllSelected ? true : "indeterminate") : false}
                                    onCheckedChange={(checked) => handleSelectAll(Boolean(checked))}
                                    aria-label="Select all"
                                />
                            </TableHead>
                            <TableHead className="w-[80px]">Image</TableHead>
                            <TableHead>Product</TableHead>
                            <TableHead>Price</TableHead>
                            <TableHead>Condition</TableHead>
                            <TableHead>Status</TableHead>
                            <TableHead>Created At</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {products.map((product) => (
                            <TableRow key={product.id} data-state={selectedProductIds.has(product.id) && "selected"}>
                                <TableCell>
                                    <Checkbox
                                        checked={selectedProductIds.has(product.id)}
                                        onCheckedChange={(checked) => handleSelectProduct(product.id, Boolean(checked))}
                                    />
                                </TableCell>
                                <TableCell>
                                    <div className="relative h-16 w-16 overflow-hidden rounded-md">
                                        <Image
                                            src={product.imageUrls[0] || '/placeholder.png'}
                                            alt={product.title}
                                            fill
                                            style={{ objectFit: 'cover' }}
                                        />
                                    </div>
                                </TableCell>
                                <TableCell className="font-medium">{product.title}</TableCell>
                                <TableCell>${product.price.toFixed(2)}</TableCell>
                                <TableCell>{product.condition}</TableCell>
                                <TableCell>
                                    <Badge variant={product.status === 'available' ? 'default' : 'outline'}>
                                        {product.status}
                                    </Badge>
                                </TableCell>
                                <TableCell>
                                    {product.createdAt ? format(new Date(product.createdAt.seconds * 1000), 'PPP') : 'N/A'}
                                </TableCell>
                            </TableRow>
                        ))}
                    </TableBody>
                </Table>
                {products.length === 0 && !loading && (
                    <div className="text-center py-12 text-muted-foreground">No products found.</div>
                )}
            </div>

            {selectedProductIds.size > 0 && (
                <div className="mt-8 p-6 border rounded-lg shadow-sm bg-card">
                    <h3 className="text-lg font-semibold mb-4">Actions for {selectedProductIds.size} selected products</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label className="text-sm font-medium">Price</label>
                            <Input
                                type="number"
                                placeholder="Enter new price"
                                value={newPrice}
                                onChange={(e) => setNewPrice(e.target.value)}
                                className="mt-1"
                            />
                        </div>
                        <div>
                            <label className="text-sm font-medium">Condition</label>
                            <Select value={newCondition} onValueChange={setNewCondition}>
                                <SelectTrigger className="mt-1">
                                    <SelectValue placeholder="Select condition" />
                                </SelectTrigger>
                                <SelectContent>
                                    {CONDITION_OPTIONS.map(c => <SelectItem key={c} value={c}>{c}</SelectItem>)}
                                </SelectContent>
                            </Select>
                        </div>
                        <div>
                            <label className="text-sm font-medium">Status</label>
                            <Select value={newStatus} onValueChange={setNewStatus}>
                                <SelectTrigger className="mt-1">
                                    <SelectValue placeholder="Select status" />
                                </SelectTrigger>
                                <SelectContent>
                                    {STATUS_OPTIONS.map(s => <SelectItem key={s} value={s}>{s}</SelectItem>)}
                                </SelectContent>
                            </Select>
                        </div>
                    </div>
                    <div className="mt-6 text-right">
                        <Button onClick={handleApplyChanges}>
                            Apply Changes
                        </Button>
                    </div>
                </div>
            )}
        </div>
    );
}

================================================================================
FILE: src/app/admin/categories/page.tsx
================================================================================

'use client';

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import {
  collection,
  onSnapshot,
  query,
  orderBy,
  addDoc,
  deleteDoc,
  doc,
  updateDoc,
  serverTimestamp
} from 'firebase/firestore';
import { useFirebase } from '@/firebase'; // Import useFirebase
import type { Category } from '@/lib/types';
import { PageHeader } from '@/components/layout/PageHeader';
import { Card, CardContent, CardHeader, CardTitle, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Loader2, PlusCircle, Trash2, Edit } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog"

const categorySchema = z.object({
  name: z.string().min(2, 'Category name is required.'),
  section: z.string().min(2, 'Section slug is required (e.g., collector-cards).'),
  href: z.string().min(1, 'Href is required (e.g., /collector-cards/sports).')
});

type CategoryFormValues = z.infer<typeof categorySchema>;

export default function CategoriesPage() {
  const [categories, setCategories] = useState<Category[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [editingCategory, setEditingCategory] = useState<Category | null>(null);
  const { toast } = useToast();
  const { firestore } = useFirebase(); // Get firestore instance from hook

  const form = useForm<CategoryFormValues>({
    resolver: zodResolver(categorySchema),
    defaultValues: { name: '', section: '', href: '' },
  });
  
  useEffect(() => {
    if (!firestore) return; // Wait for firestore to be available
    const q = query(collection(firestore, 'categories'), orderBy('name', 'asc'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const cats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Category));
      setCategories(cats);
      setIsLoading(false);
    }, (error) => {
        console.error("Error fetching categories: ", error);
        toast({ title: 'Failed to load categories.', description: error.message, variant: 'destructive' });
        setIsLoading(false);
    });
    return () => unsubscribe();
  }, [firestore, toast]); // Add firestore and toast to dependency array
  
  useEffect(() => {
    if (editingCategory) {
      form.reset(editingCategory);
    } else {
      form.reset({ name: '', section: '', href: '' });
    }
  }, [editingCategory, form]);

  const onSubmit = async (values: CategoryFormValues) => {
    if (!firestore) return;
    setIsSubmitting(true);
    try {
      if (editingCategory) {
        await updateDoc(doc(firestore, 'categories', editingCategory.id), values);
        toast({ title: 'Category updated successfully!' });
        setEditingCategory(null);
      } else {
        await addDoc(collection(firestore, 'categories'), { ...values, createdAt: serverTimestamp() });
        toast({ title: 'Category added successfully!' });
      }
      form.reset();
    } catch (error: any) {
      toast({ title: 'An error occurred.', description: error.message, variant: 'destructive' });
    } finally {
      setIsSubmitting(false);
    }
  };
  
  const deleteCategory = async (id: string) => {
    if (!firestore) return;
    try {
        await deleteDoc(doc(firestore, 'categories', id));
        toast({ title: 'Category deleted successfully.' });
    } catch (error: any) {
        toast({ title: 'Failed to delete category.', description: error.message, variant: 'destructive' });
    }
  }

  return (
    <div>
      <PageHeader title="Category Management" description="Add, edit, or remove marketplace categories." />

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
        <div className="lg:col-span-1">
          <Card>
            <CardHeader>
              <CardTitle>{editingCategory ? 'Edit Category' : 'Add New Category'}</CardTitle>
            </CardHeader>
            <CardContent>
              <Form {...form}>
                <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
                  <FormField control={form.control} name="name" render={({ field }) => (
                    <FormItem><FormLabel>Name</FormLabel><FormControl><Input placeholder="e.g., Sports Cards" {...field} /></FormControl><FormMessage /></FormItem>
                  )} />
                  <FormField control={form.control} name="section" render={({ field }) => (
                    <FormItem><FormLabel>Section Slug</FormLabel><FormControl><Input placeholder="e.g., collector-cards" {...field} /></FormControl><FormMessage /></FormItem>
                  )} />
                   <FormField control={form.control} name="href" render={({ field }) => (
                    <FormItem><FormLabel>Link Href</FormLabel><FormControl><Input placeholder="e.g., /collector-cards/sports" {...field} /></FormControl><FormMessage /></FormItem>
                  )} />
                  <Button type="submit" disabled={isSubmitting} className="w-full">
                    {isSubmitting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <PlusCircle className="mr-2 h-4 w-4" />}
                    {editingCategory ? 'Update Category' : 'Add Category'}
                  </Button>
                  {editingCategory && (
                      <Button variant="outline" className="w-full" onClick={() => setEditingCategory(null)}>Cancel Edit</Button>
                  )}
                </form>
              </Form>
            </CardContent>
          </Card>
        </div>
        <div className="lg:col-span-2">
          <Card>
            <CardHeader><CardTitle>Existing Categories</CardTitle></CardHeader>
            <CardContent>
              {isLoading ? (
                <div className="flex justify-center p-8"><Loader2 className="h-8 w-8 animate-spin" /></div>
              ) : (
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Name</TableHead>
                      <TableHead>Section</TableHead>
                      <TableHead>Href</TableHead>
                      <TableHead className="text-right">Actions</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {categories.map((cat) => (
                      <TableRow key={cat.id}>
                        <TableCell className="font-medium">{cat.name}</TableCell>
                        <TableCell>{cat.section}</TableCell>
                        <TableCell>{cat.href}</TableCell>
                        <TableCell className="text-right space-x-1">
                          <Button variant="ghost" size="icon" onClick={() => setEditingCategory(cat)}><Edit className="h-4 w-4" /></Button>
                          <AlertDialog>
                            <AlertDialogTrigger asChild>
                                <Button variant="ghost" size="icon" className="text-destructive hover:text-destructive"><Trash2 className="h-4 w-4" /></Button>
                            </AlertDialogTrigger>
                            <AlertDialogContent>
                                <AlertDialogHeader>
                                <AlertDialogTitle>Are you sure?</AlertDialogTitle>
                                <AlertDialogDescription>
                                    This action cannot be undone. This will permanently delete the category.
                                </AlertDialogDescription>
                                </AlertDialogHeader>
                                <AlertDialogFooter>
                                <AlertDialogCancel>Cancel</AlertDialogCancel>
                                <AlertDialogAction onClick={() => deleteCategory(cat.id)} className="bg-destructive hover:bg-destructive/90">Delete</AlertDialogAction>
                                </AlertDialogFooter>
                            </AlertDialogContent>
                          </AlertDialog>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              )}
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/admin/disputes/page.tsx
================================================================================

'use client';

import { PageHeader } from "@/components/layout/PageHeader";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import EmptyState from "@/components/ui/EmptyState";
import { MessageSquareWarning } from "lucide-react";

export default function DisputesPage() {
    const disputes: any[] = []; // Removed mock data

    return (
        <div>
            <PageHeader
                title="Conflict Resolution Protocol"
                description="Arbitrate and manage user-reported disputes."
            />
            <div className="mt-8">
                <Card>
                    <CardHeader>
                        <CardTitle>Open Disputes</CardTitle>
                    </CardHeader>
                    <CardContent>
                        {disputes.length > 0 ? (
                            <Table>
                                <TableHeader>
                                    <TableRow>
                                        <TableHead>Dispute ID</TableHead>
                                        <TableHead>Item</TableHead>
                                        <TableHead>Status</TableHead>
                                        <TableHead>Date</TableHead>
                                        <TableHead className="text-right">Actions</TableHead>
                                    </TableRow>
                                </TableHeader>
                                <TableBody>
                                    {disputes.map((dispute) => (
                                        <TableRow key={dispute.id}>
                                            <TableCell>{dispute.id}</TableCell>
                                            <TableCell>{dispute.item}</TableCell>
                                            <TableCell><Badge variant={dispute.status === 'pending' ? 'destructive' : 'secondary'}>{dispute.status}</Badge></TableCell>
                                            <TableCell>{dispute.date}</TableCell>
                                            <TableCell className="text-right">
                                                <Button variant="outline" size="sm">View Details</Button>
                                            </TableCell>
                                        </TableRow>
                                    ))}
                                </TableBody>
                            </Table>
                        ) : (
                            <EmptyState
                                title="No Open Disputes"
                                description="All user disputes have been resolved."
                                icon={<MessageSquareWarning className="h-12 w-12 text-muted-foreground" />}
                            />
                        )}
                    </CardContent>
                </Card>
            </div>
        </div>
    );
}

================================================================================
FILE: src/app/admin/fraud-detection/page.tsx
================================================================================
'use client';

import { useFormStatus } from 'react-dom';
import { useActionState } from 'react';
import { detectFraudAction, type FraudState } from '@/lib/actions';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Progress } from '@/components/ui/progress';
import { Loader2, ShieldAlert, Sparkles } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

function SubmitButton() {
  const { pending } = useFormStatus();
  return (
    <Button type="submit" disabled={pending} className="w-full font-bold h-12 rounded-xl">
      {pending ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Sparkles className="mr-2 h-4 w-4" />}
      Analyze for Fraud
    </Button>
  );
}

export default function FraudDetectionPage() {
  const initialState: FraudState = {};
  const [state, formAction] = useActionState(detectFraudAction, initialState);

  return (
    <div>
      <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }}>
        <h1 className="text-4xl lg:text-5xl font-black tracking-tighter mb-2">
          Fraud Detection Lab
        </h1>
        <p className="text-muted-foreground font-medium tracking-wide uppercase text-xs">
          Analyze messages or transaction details for suspicious activity.
        </p>
      </motion.div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
        <Card className="p-6 rounded-xl">
          <CardHeader className="px-0 pt-0">
            <CardTitle className="text-xl font-bold">Suspicious Details</CardTitle>
            <CardDescription className="text-muted-foreground">Paste any text, like user messages or transaction notes, to analyze.</CardDescription>
          </CardHeader>
          <CardContent className="px-0">
            <form action={formAction} className="space-y-4">
              <Textarea
                name="details"
                id="details"
                placeholder="e.g., 'Can I pay you outside of Picksy with a gift card? My email is...'"
                rows={10}
                className="resize-none rounded-xl"
                required
              />
              <SubmitButton />
              {state.error && <p className="text-sm text-red-500 mt-2">{state.error}</p>}
            </form>
          </CardContent>
        </Card>

        <Card className="p-6 rounded-xl flex flex-col">
          <CardHeader className="px-0 pt-0">
            <CardTitle className="text-xl font-bold">Risk Assessment</CardTitle>
          </CardHeader>
          <CardContent className="px-0 flex-1 flex items-center justify-center">
            <AnimatePresence mode="wait">
              {state.result ? (
                <motion.div key="result" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="w-full space-y-6">
                  <div>
                    <div className="flex justify-between items-center mb-2">
                        <span className="text-sm font-bold text-foreground">Risk Score</span>
                        <span className={`text-xl font-black ${state.result.riskScore > 0.7 ? 'text-red-500' : state.result.riskScore > 0.4 ? 'text-yellow-500' : 'text-green-500'}`}>
                            {(state.result.riskScore * 100).toFixed(0)}%
                        </span>
                    </div>
                    <Progress value={state.result.riskScore * 100} />
                  </div>

                   <div className="border p-4 rounded-xl">
                      <p className="font-medium mb-2">AI Assessment</p>
                      <p className="text-muted-foreground text-sm">{state.result.reason}</p>
                  </div>
                  
                  {state.result.recommendedAction && (
                    <div className="border p-4 rounded-xl">
                        <p className="font-medium mb-2">Recommended Action</p>
                        <p className="text-base font-bold text-yellow-500">{state.result.recommendedAction}</p>
                    </div>
                  )}

                  <div className="flex gap-4 pt-4 border-t">
                    <Button variant="outline" className="flex-1 rounded-xl">Dismiss Signal</Button>
                    <Button variant="destructive" className="flex-1 rounded-xl">Restrict Account</Button>
                  </div>
                </motion.div>
              ) : (
                <motion.div key="initial" initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="text-center text-muted-foreground">
                  <ShieldAlert className="h-16 w-16 mx-auto mb-4" />
                  <p>Analysis results will appear here.</p>
                </motion.div>
              )}
            </AnimatePresence>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/admin/inventory-alerts/actions.ts
================================================================================
'use server';

import { db } from '@/lib/firebase/config';
import { doc, updateDoc } from 'firebase/firestore';

export async function updateMinStockQuantity(productId: string, minStockQuantity: number) {
    try {
        const productRef = doc(db, 'products', productId);
        await updateDoc(productRef, { minStockQuantity });
        return { success: true, message: 'Minimum stock quantity updated successfully.' };
    } catch (error) {
        console.error('Error updating minimum stock quantity:', error);
        return { success: false, message: 'Failed to update minimum stock quantity.' };
    }
}

================================================================================
FILE: src/app/admin/inventory-alerts/page.tsx
================================================================================
'use client';

import { useEffect, useState } from 'react';
import { PageHeader } from '@/components/layout/PageHeader';
import { getProductsForBulkEdit } from '../bulk-editor/actions'; // Reusing this for now
import type { Product } from '@/lib/types';
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from '@/components/ui/table';
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Loader2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { updateMinStockQuantity } from './actions';

export default function InventoryAlertsPage() {
    const { toast } = useToast();
    const [products, setProducts] = useState<Product[]>([]);
    const [loading, setLoading] = useState(true);
    const [thresholds, setThresholds] = useState<{ [key: string]: number | '' }>({});
    const [saving, setSaving] = useState<Set<string>>(new Set());

    useEffect(() => {
        async function fetchProducts() {
            setLoading(true);
            const fetchedProducts = await getProductsForBulkEdit(); // Reusing the bulk editor action
            setProducts(fetchedProducts);
            // Initialize thresholds from existing product data or default to 5
            const initialThresholds = fetchedProducts.reduce((acc, product) => {
                acc[product.id] = product.minStockQuantity || 5;
                return acc;
            }, {} as { [key: string]: number | '' });
            setThresholds(initialThresholds);
            setLoading(false);
        }
        fetchProducts();
    }, []);

    const handleThresholdChange = (productId: string, value: string) => {
        setThresholds(prev => ({
            ...prev,
            [productId]: value === '' ? '' : parseInt(value),
        }));
    };

    const handleSaveThreshold = async (productId: string) => {
        setSaving(prev => new Set(prev).add(productId));
        const threshold = thresholds[productId];

        if (typeof threshold !== 'number' || isNaN(threshold) || threshold < 0) {
            toast({
                title: "Error",
                description: "Please enter a valid non-negative number for the threshold.",
                variant: "destructive",
            });
            setSaving(prev => {
                const newSaving = new Set(prev);
                newSaving.delete(productId);
                return newSaving;
            });
            return;
        }

        const result = await updateMinStockQuantity(productId, threshold);

        if (result.success) {
            toast({
                title: "Threshold Saved",
                description: result.message,
            });
        } else {
            toast({
                title: "Error",
                description: result.message,
                variant: "destructive",
            });
        }
        setSaving(prev => {
            const newSaving = new Set(prev);
            newSaving.delete(productId);
            return newSaving;
        });
    };

    if (loading) {
        return (
            <div className="container mx-auto py-8 text-center">
                <Loader2 className="h-12 w-12 animate-spin text-primary mx-auto" />
                <p className="mt-4 text-muted-foreground">Loading products...</p>
            </div>
        );
    }

    return (
        <div className="container mx-auto py-8">
            <PageHeader
                title="Inventory Alerts"
                description="Manage low stock thresholds and receive notifications for your products."
            />

            <div className="mt-8">
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead className="w-[80px]">Image</TableHead>
                            <TableHead>Product</TableHead>
                            <TableHead>Current Stock</TableHead>
                            <TableHead className="w-[200px]">Low Stock Threshold</TableHead>
                            <TableHead className="w-[120px]">Actions</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {products.map((product) => (
                            <TableRow key={product.id}>
                                <TableCell>
                                    <div className="relative h-16 w-16 overflow-hidden rounded-md">
                                        <Image
                                            src={product.imageUrls[0] || '/placeholder.png'}
                                            alt={product.title}
                                            fill
                                            style={{ objectFit: 'cover' }}
                                        />
                                    </div>
                                </TableCell>
                                <TableCell className="font-medium">{product.title}</TableCell>
                                <TableCell>{product.quantity || 0}</TableCell>
                                <TableCell>
                                    <Input
                                        type="number"
                                        min="0"
                                        value={thresholds[product.id]}
                                        onChange={(e) => handleThresholdChange(product.id, e.target.value)}
                                    />
                                </TableCell>
                                <TableCell>
                                    <Button
                                        onClick={() => handleSaveThreshold(product.id)}
                                        disabled={saving.has(product.id)}
                                    >
                                        {saving.has(product.id) ? (
                                            <Loader2 className="h-4 w-4 animate-spin" />
                                        ) : (
                                            'Save'
                                        )}
                                    </Button>
                                </TableCell>
                            </TableRow>
                        ))}
                    </TableBody>
                </Table>
                {products.length === 0 && !loading && (
                    <div className="text-center py-12 text-muted-foreground">No products found.</div>
                )}
            </div>
        </div>
    );
}

================================================================================
FILE: src/app/admin/layout.tsx
================================================================================
'use client';

import { useUser, useDoc, useMemoFirebase } from '@/firebase';
import { useRouter, usePathname } from 'next/navigation';
import { useEffect } from 'react';
import { Loader2 } from 'lucide-react';
import { doc } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import type { UserProfile } from '@/lib/types';
import AdminSidebar from '@/components/layout/AdminSidebar';
import { NotificationBell } from '@/components/notifications/NotificationBell';
import { SUPER_ADMIN_EMAILS, SUPER_ADMIN_UIDS } from '@/lib/constants';

export default function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const { user, isUserLoading } = useUser();
  const router = useRouter();
  const pathname = usePathname(); // Get the current path

  const isSuperAdmin = (user?.uid && SUPER_ADMIN_UIDS.includes(user.uid)) || (user?.email && SUPER_ADMIN_EMAILS.includes(user.email));

  useEffect(() => {
    const checkAdmin = async () => {
      if (!isUserLoading) {
        if (!isSuperAdmin) {
          router.replace('/');
        }
      }
    };
    checkAdmin();
  }, [user, isUserLoading, router, isSuperAdmin]);

  if (isUserLoading || !isSuperAdmin) {
    return (
      <div className="flex h-screen flex-col items-center justify-center bg-background">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
        <p className="mt-4 text-muted-foreground">Verifying administrative access...</p>
      </div>
    );
  }

  return (
    <div className="flex min-h-screen">
      <AdminSidebar />
      <div className="flex flex-col flex-1">
        <header className="flex h-16 items-center justify-end border-b bg-background px-4">
          <NotificationBell />
        </header>
        <main key={pathname} className="flex-1 p-4 sm:p-6 lg:p-8 bg-muted/20">
          {children}
        </main>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/admin/management/page.tsx
================================================================================

'use client';

import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import CategoriesManager from '@/components/admin/management/CategoriesManager';
import AttributesManager from '@/components/admin/management/AttributesManager';
import MaintenanceManager from '@/components/admin/management/MaintenanceManager';
import { PageHeader } from "@/components/layout/PageHeader";

export default function AdminManagementPage() {
  return (
    <div>
      <PageHeader
        title="Marketplace Management"
        description="Manage all dropdown options, categories, and marketplace settings in one place."
      />
      <Tabs defaultValue="categories" className="mt-8">
        <TabsList>
          <TabsTrigger value="categories">Categories</TabsTrigger>
          <TabsTrigger value="attributes">Attributes</TabsTrigger>
          <TabsTrigger value="maintenance">Maintenance</TabsTrigger>
        </TabsList>
        <TabsContent value="categories" className="mt-4">
            <CategoriesManager />
        </TabsContent>
        <TabsContent value="attributes" className="mt-4">
            <AttributesManager />
        </TabsContent>
        <TabsContent value="maintenance" className="mt-4">
            <MaintenanceManager />
        </TabsContent>
      </Tabs>
    </div>
  );
}

================================================================================
FILE: src/app/admin/moderation/page.tsx
================================================================================
'use client';

import { useState } from 'react';
import { PageHeader } from '@/components/layout/PageHeader';
import { Card, CardContent, CardHeader, CardTitle, CardFooter, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { useToast } from '@/hooks/use-toast';
import { Loader2, ShieldCheck, ShieldAlert, Sparkles } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { motion, AnimatePresence } from 'framer-motion';
import { moderateContent, type ModerateContentOutput } from '@/ai/flows/ai-content-moderation';
import Image from 'next/image';
import { Input } from '@/components/ui/input';

export default function ModerationPage() {
  const [productName, setProductName] = useState('');
  const [productDescription, setProductDescription] = useState('');
  const [result, setResult] = useState<ModerateContentOutput | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const { toast } = useToast();

  const handleAnalyze = async () => {
    if (!productName.trim() || !productDescription.trim()) {
      toast({ title: 'Please enter a product name and description.', variant: 'destructive' });
      return;
    }
    setIsLoading(true);
    setResult(null);
    try {
      const analysisResult = await moderateContent({ productName, productDescription });
      setResult(analysisResult);
    } catch (error: any) {
      console.error('Moderation Error:', error);
      toast({
        title: 'Analysis Failed',
        description: error.message || 'The AI service could not be reached.',
        variant: 'destructive',
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div>
        <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }}>
            <h1 className="text-4xl lg:text-5xl font-black tracking-tighter mb-2">
                Content Moderation Lab
            </h1>
            <p className="text-muted-foreground font-medium tracking-wide uppercase text-xs">
                Use AI to analyze listings for policy violations, spam, or inappropriate content.
            </p>
        </motion.div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
        <Card className="p-6 rounded-xl">
          <CardHeader className="px-0 pt-0">
            <CardTitle className="text-xl font-bold">Content to Analyze</CardTitle>
          </CardHeader>
          <CardContent className="px-0 space-y-4">
             <Input 
                value={productName}
                onChange={(e) => setProductName(e.target.value)}
                placeholder="Product Name..."
                className="placeholder:text-muted-foreground rounded-xl"
            />
            <Textarea
              value={productDescription}
              onChange={(e) => setProductDescription(e.target.value)}
              placeholder="Paste a product title or description here..."
              rows={12}
              className="resize-none placeholder:text-muted-foreground rounded-xl"
            />
          </CardContent>
          <CardFooter className="px-0 pb-0">
            <Button onClick={handleAnalyze} disabled={isLoading} className="w-full font-bold h-12 rounded-xl">
              {isLoading ? (
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              ) : (
                <Sparkles className="mr-2 h-4 w-4" />
              )}
              Analyze Content
            </Button>
          </CardFooter>
        </Card>

        <Card className="p-6 rounded-xl flex flex-col">
          <CardHeader className="px-0 pt-0">
            <CardTitle className="text-xl font-bold">Analysis Result</CardTitle>
          </CardHeader>
          <CardContent className="px-0 flex-1 flex items-center justify-center">
            <AnimatePresence mode="wait">
              {isLoading && (
                <motion.div key="loader" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="text-center">
                  <Loader2 className="h-12 w-12 animate-spin text-primary" />
                </motion.div>
              )}
              {!isLoading && !result && (
                <motion.div key="initial" initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="text-center text-muted-foreground">
                  <ShieldCheck className="h-16 w-16 mx-auto mb-4" />
                  <p>Your analysis results will appear here.</p>
                </motion.div>
              )}
              {result && (
                <motion.div key="result" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="w-full space-y-4 text-sm">
                  <div className={`flex items-center justify-between rounded-xl p-4 ${result.isCompliant ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                    <div>
                      <p className="font-bold">{result.isCompliant ? 'Content Compliant' : 'Policy Violation Detected'}</p>
                      <p className="text-xs opacity-80">{result.isCompliant ? 'No major issues found.' : 'Action may be required.'}</p>
                    </div>
                    {result.isCompliant ? (
                      <ShieldCheck className="h-8 w-8" />
                    ) : (
                      <ShieldAlert className="h-8 w-8" />
                    )}
                  </div>

                  <div className="border p-4 rounded-xl">
                      <p className="font-medium mb-2">Violations</p>
                      {result.policyViolations.length > 0 ? (
                          <div className="flex flex-wrap gap-2">
                          {result.policyViolations.map((cat) => (
                              <Badge key={cat} variant="destructive">{cat}</Badge>
                          ))}
                          </div>
                      ) : (
                          <p className="text-muted-foreground text-xs">None</p>
                      )}
                  </div>
                  
                  <div className="border p-4 rounded-xl">
                      <p className="font-medium mb-2">AI Explanation</p>
                      <p className="text-muted-foreground text-xs italic">{result.explanation}</p>
                  </div>
                </motion.div>
              )}
            </AnimatePresence>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/admin/page.tsx
================================================================================

'use client';

import { PageHeader } from "@/components/layout/PageHeader";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { BarChart, Package, Users, Settings, ShieldAlert, FileText } from "lucide-react";
import Link from 'next/link';
import { AdminStatsGrid } from "@/components/admin/StatsGrid";
import { Skeleton } from "@/components/ui/skeleton";
import { motion } from "framer-motion";
import { getPlatformStats } from "@/app/actions/stats";
import { useEffect, useState } from "react";
import { useUser } from "@/firebase";

interface PlatformStats {
    totalRevenue: number;
    activeSellers: number;
    disputeCount: number;
    totalItems: number;
}

const adminSections = [
    {
        title: "Analytics",
        icon: <BarChart className="h-8 w-8 text-primary" />,
        href: "/admin/analytics",
        description: "Review platform performance metrics."
    },
    {
        title: "Manage Listings",
        icon: <Package className="h-8 w-8 text-primary" />,
        href: "/admin/products",
        description: "Oversee, edit, or remove any product listing."
    },
    {
        title: "Integrity Center",
        icon: <ShieldAlert className="h-8 w-8 text-primary" />,
        href: "/admin/moderation",
        description: "Analyze listings and manage platform risk."
    },
    {
        title: "Content Management",
        icon: <FileText className="h-8 w-8 text-primary" />,
        href: "/admin/categories",
        description: "Manage dynamic categories and site content."
    },
];

export default function AdminDashboardPage() {
    const { user } = useUser();
    const [stats, setStats] = useState<PlatformStats | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    useEffect(() => {
        const fetchStats = async () => {
            if (!user) return;
            setIsLoading(true);
            try {
                // Force refresh the ID token to ensure it hasn't expired
                const idToken = await user.getIdToken(true);

                // Using the server action to fetch stats
                const fetchedStats = await getPlatformStats(idToken);
                if (fetchedStats.error) {
                    throw new Error(fetchedStats.error);
                }
                setStats({
                    totalRevenue: fetchedStats.totalRevenue || 0,
                    totalItems: fetchedStats.totalItems || 0,
                    activeSellers: 1, // Mock value
                    disputeCount: 0 // Mock value
                });
            } catch (error: any) {
                console.error("Failed to fetch platform stats", error);
                setError(error.message);
            } finally {
                setIsLoading(false);
            }
        };
        fetchStats();
    }, [user]);

    const displayStats = {
        revenue: stats?.totalRevenue || 0,
        alerts: stats?.disputeCount || 0,
        sellers: stats?.activeSellers || 0,
        items: stats?.totalItems || 0,
    };

    return (
        <div>
            <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }}>
                <h1 className="text-4xl lg:text-5xl font-black tracking-tighter mb-2">
                    Admin Dashboard
                </h1>
                <p className="text-muted-foreground font-medium tracking-wide uppercase text-xs">
                    Manage all aspects of the Picksy marketplace.
                </p>
            </motion.div>

            <div className="mt-8">
                {isLoading ? (
                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                        <Skeleton className="h-28 rounded-2xl" />
                        <Skeleton className="h-28 rounded-2xl" />
                        <Skeleton className="h-28 rounded-2xl" />
                        <Skeleton className="h-28 rounded-2xl" />
                    </div>
                ) : error ? (
                    <div className="bg-destructive/10 text-destructive border border-destructive/20 p-4 rounded-lg">
                        <p className="font-bold">Error Loading Stats</p>
                        <p className="text-sm">{error}</p>
                    </div>
                ) : (
                    <AdminStatsGrid stats={displayStats} />
                )}
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mt-8">
                {adminSections.map((section, i) => (
                    <motion.div
                        key={section.title}
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: 0.1 + i * 0.1 }}
                    >
                        <Link href={section.href}>
                            <Card className="hover:-translate-y-2 transition-transform duration-300 h-full rounded-xl p-4">
                                <CardHeader className="flex flex-row items-center justify-between pb-2">
                                    <CardTitle className="text-lg font-bold tracking-tight">{section.title}</CardTitle>
                                    <div className="p-3 bg-primary/10 rounded-xl">
                                        {section.icon}
                                    </div>
                                </CardHeader>
                                <CardContent>
                                    <p className="text-sm text-muted-foreground">{section.description}</p>
                                </CardContent>
                            </Card>
                        </Link>
                    </motion.div>
                ))}
            </div>
        </div>
    );
}

================================================================================
FILE: src/app/admin/power-tools/page.tsx
================================================================================
'use client';

import { useUser } from '@/firebase';
import { useRouter } from 'next/navigation';
import { useEffect, useState } from 'react';
import Link from 'next/link';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import {
    Upload,
    FileSpreadsheet,
    Edit3,
    TrendingUp,
    Bell,
    BarChart3,
    QrCode,
    Package,
    Settings,
    Zap
} from 'lucide-react';
import { PageHeader } from '@/components/layout/PageHeader';
import { SUPER_ADMIN_EMAILS } from '@/lib/constants';
import { getAdminStats, type AdminStats } from '@/app/actions/admin-stats';

const powerTools = [
    {
        title: 'Bulk Image Lister',
        description: 'Upload multiple images and let AI create listings',
        icon: Upload,
        href: '/sell/bulk-lister',
        color: 'bg-blue-500',
    },
    {
        title: 'Bulk CSV Lister',
        description: 'Import products from CSV file with images',
        icon: FileSpreadsheet,
        href: '/sell/bulk-csv-lister',
        color: 'bg-green-500',
    },
    {
        title: 'Bulk Editor',
        description: 'Edit prices, conditions, and status for multiple items',
        icon: Edit3,
        href: '/admin/bulk-editor',
        color: 'bg-purple-500',
    },
    {
        title: 'Auto Repricing',
        description: 'Automatically match lowest prices in categories',
        icon: TrendingUp,
        href: '/admin/auto-repricing',
        color: 'bg-orange-500',
    },
    {
        title: 'Inventory Alerts',
        description: 'Get notified about low stock and trends',
        icon: Bell,
        href: '/admin/inventory-alerts',
        color: 'bg-red-500',
    },
    {
        title: 'Sales Analytics',
        description: 'View performance metrics and best selling times',
        icon: BarChart3,
        href: '/admin/analytics',
        color: 'bg-indigo-500',
    },
    {
        title: 'QR Codes',
        description: 'Generate and manage product QR codes',
        icon: QrCode,
        href: '/admin/qr-codes',
        color: 'bg-pink-500',
        comingSoon: true,
    },
    {
        title: 'Shipping Labels',
        description: 'Generate shipping labels via Shippo integration',
        icon: Package,
        href: '/admin/shipping',
        color: 'bg-cyan-500',
        comingSoon: true,
    },
];

export default function PowerToolsPage() {
    const { user, isUserLoading } = useUser();
    const router = useRouter();
    const [stats, setStats] = useState<AdminStats | null>(null);

    const isSuperAdmin = user?.email && SUPER_ADMIN_EMAILS.includes(user.email);

    useEffect(() => {
        if (!isUserLoading && !isSuperAdmin) {
            router.push('/');
        }
    }, [isSuperAdmin, isUserLoading, router]);

    useEffect(() => {
        const fetchStats = async () => {
            if (isSuperAdmin) {
                const data = await getAdminStats();
                setStats(data);
            }
        };
        fetchStats();
    }, [isSuperAdmin]);

    if (isUserLoading) {
        return (
            <div className="flex h-screen items-center justify-center">
                <div className="text-center">
                    <Settings className="h-12 w-12 animate-spin mx-auto text-muted-foreground" />
                    <p className="mt-4 text-muted-foreground">Loading...</p>
                </div>
            </div>
        );
    }

    if (!isSuperAdmin) {
        return null;
    }

    return (
        <div className="container mx-auto py-8">
            <PageHeader
                title="âš¡ Power Tools"
                description="Super Admin tools for bulk operations and advanced seller features"
            />

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                {powerTools.map((tool) => {
                    const Icon = tool.icon;
                    return (
                        <Card
                            key={tool.href}
                            className={`relative overflow-hidden transition-all hover:shadow-lg ${tool.comingSoon ? 'opacity-75' : ''}`}
                        >
                            <div className={`absolute top-0 right-0 w-32 h-32 ${tool.color} opacity-10 rounded-bl-full`} />

                            <CardHeader>
                                <div className="flex items-start justify-between">
                                    <div className={`p-3 rounded-lg ${tool.color} text-white`}>
                                        <Icon className="h-6 w-6" />
                                    </div>
                                    {tool.comingSoon && (
                                        <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-semibold">
                                            Coming Soon
                                        </span>
                                    )}
                                </div>
                                <CardTitle className="mt-4">{tool.title}</CardTitle>
                                <CardDescription>{tool.description}</CardDescription>
                            </CardHeader>

                            <CardContent>
                                <Button
                                    asChild={!tool.comingSoon}
                                    disabled={tool.comingSoon}
                                    className="w-full"
                                    variant={tool.comingSoon ? "outline" : "default"}
                                >
                                    {tool.comingSoon ? (
                                        <span>Coming Soon</span>
                                    ) : (
                                        <Link href={tool.href}>
                                            <Zap className="mr-2 h-4 w-4" />
                                            Open Tool
                                        </Link>
                                    )}
                                </Button>
                            </CardContent>
                        </Card>
                    );
                })}
            </div>

            {/* Quick Stats Section */}
            <div className="mt-12 grid grid-cols-1 md:grid-cols-4 gap-4">
                <Card>
                    <CardHeader className="pb-3">
                        <CardDescription>Total Listings</CardDescription>
                        <CardTitle className="text-3xl">
                            {stats ? stats.totalListings.toLocaleString() : '-'}
                        </CardTitle>
                    </CardHeader>
                </Card>
                <Card>
                    <CardHeader className="pb-3">
                        <CardDescription>Active Sellers</CardDescription>
                        <CardTitle className="text-3xl">
                            {stats ? stats.activeSellers.toLocaleString() : '-'}
                        </CardTitle>
                    </CardHeader>
                </Card>
                <Card>
                    <CardHeader className="pb-3">
                        <CardDescription>Total Revenue</CardDescription>
                        <CardTitle className="text-3xl">
                            {stats ? `$${stats.totalRevenue.toLocaleString()}` : '-'}
                        </CardTitle>
                    </CardHeader>
                </Card>
                <Card>
                    <CardHeader className="pb-3">
                        <CardDescription>Pending Orders</CardDescription>
                        <CardTitle className="text-3xl">
                            {stats ? stats.pendingOrders.toLocaleString() : '-'}
                        </CardTitle>
                    </CardHeader>
                </Card>
            </div>
        </div>
    );
}

================================================================================
FILE: src/app/admin/products/page.tsx
================================================================================

'use client';
import InfiniteProductGrid from '@/components/products/InfiniteProductGrid';
import { motion } from 'framer-motion';

export default function AdminProductsPage() {
    return (
        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
            <InfiniteProductGrid
                pageTitle="Product Registry"
                pageDescription="Review, manage, and edit all product listings on the platform."
            />
        </motion.div>
    );
}

================================================================================
FILE: src/app/admin/seo/page.tsx
================================================================================

'use client';

import { useState } from 'react';
import { PageHeader } from '@/components/layout/PageHeader';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Switch } from "@/components/ui/switch";
import { Separator } from "@/components/ui/separator";
import { Globe, Search, Save, FileCode } from 'lucide-react';
import { useToast } from "@/hooks/use-toast";

export default function SEOPage() {
    const { toast } = useToast();
    const [isGenerating, setIsGenerating] = useState(false);

    const handleGenerateSitemap = async () => {
        setIsGenerating(true);
        // Simulate sitemap generation
        setTimeout(() => {
            setIsGenerating(false);
            toast({
                title: "Sitemap Generated",
                description: "sitemap.xml has been updated successfully.",
            });
        }, 2000);
    };

    return (
        <div className="container mx-auto py-8 space-y-8">
            <div>
                <h1 className="text-3xl font-bold tracking-tight">SEO Management</h1>
                <p className="text-muted-foreground">Configure global meta tags and search engine visibility.</p>
            </div>

            <div className="grid gap-6 md:grid-cols-3">
                <Card className="md:col-span-2">
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                            <Globe className="h-5 w-5 text-primary" />
                            Global Metadata
                        </CardTitle>
                        <CardDescription>Default settings for pages without specific SEO overrides.</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="space-y-2">
                            <Label>Site Title Template</Label>
                            <Input placeholder="%s | Picksy - The Collector&apos;s Marketplace" />
                            <p className="text-xs text-muted-foreground">Use %s as a placeholder for the page title.</p>
                        </div>
                        <div className="space-y-2">
                            <Label>Default Description</Label>
                            <Textarea placeholder="The premier marketplace for grading, buying, and selling collector cards, coins, and memorabilia." />
                        </div>
                        <div className="space-y-2">
                            <Label>Keywords (Comma separated)</Label>
                            <Input placeholder="trading cards, sports cards, coins, grading, psa, bgs" />
                        </div>
                        <Separator className="my-4" />
                        <div className="flex items-center justify-between">
                            <div className="space-y-0.5">
                                <Label>Allow Indexing</Label>
                                <p className="text-xs text-muted-foreground">If disabled, adds 'noindex' to all pages.</p>
                            </div>
                            <Switch defaultChecked />
                        </div>
                        <div className="pt-4 flex justify-end">
                            <Button>
                                <Save className="mr-2 h-4 w-4" /> Save Changes
                            </Button>
                        </div>
                    </CardContent>
                </Card>

                <div className="space-y-6">
                    <Card>
                        <CardHeader>
                            <CardTitle className="flex items-center gap-2">
                                <FileCode className="h-5 w-5 text-orange-500" />
                                Sitemap
                            </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <p className="text-sm text-muted-foreground">
                                Last generated: <span className="text-foreground">2 hours ago</span>
                            </p>
                            <Button
                                variant="outline"
                                className="w-full"
                                onClick={handleGenerateSitemap}
                                disabled={isGenerating}
                            >
                                {isGenerating ? "Generating..." : "Regenerate Sitemap"}
                            </Button>
                            <Button variant="link" className="w-full" asChild>
                                <a href="/sitemap.xml" target="_blank">View sitemap.xml</a>
                            </Button>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader>
                            <CardTitle className="flex items-center gap-2">
                                <Search className="h-5 w-5 text-green-500" />
                                Robots.txt
                            </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <div className="bg-muted p-3 rounded-md border">
                                <pre className="text-xs text-muted-foreground font-mono">
                                    User-agent: *<br/>
                                    Allow: /<br/>
                                    Disallow: /admin/<br/>
                                    Disallow: /profile/<br/>
                                    Sitemap: https://picksy.com/sitemap.xml
                                </pre>
                            </div>
                            <Button variant="ghost" size="sm" className="w-full">Edit File</Button>
                        </CardContent>
                    </Card>
                </div>
            </div>
        </div>
    );
}

================================================================================
FILE: src/app/admin/settings/page.tsx
================================================================================
'use client';

import { useState, useTransition } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle, CardFooter } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Upload, Palette, CheckCircle, AlertTriangle, Loader2, Save } from "lucide-react";
import Image from "next/image";
import { Logo } from '@/components/logo';
import { motion } from "framer-motion";
import { testApiKey } from '@/ai/flows/test-api-key';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';
import { useToast } from '@/hooks/use-toast';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';

export default function AdminSettingsPage() {
    const { toast } = useToast();
    const [isTesting, startTestTransition] = useTransition();
    const [testResult, setTestResult] = useState<{ status: string; message: string } | null>(null);

    const handleTestApiKey = () => {
        startTestTransition(async () => {
            setTestResult(null);
            try {
                const idToken = await getCurrentUserIdToken();
                if (!idToken) throw new Error("Not authenticated");
                const result = await testApiKey(idToken);
                setTestResult(result);
                toast({
                    title: result.status === 'Success' ? 'API Connection Verified' : 'API Connection Failed',
                    description: result.message,
                    variant: result.status === 'Success' ? 'default' : 'destructive',
                });
            } catch (error: any) {
                setTestResult({ status: 'Error', message: error.message });
                toast({
                    title: 'Verification Failed',
                    description: error.message,
                    variant: 'destructive',
                });
            }
        });
    };

    return (
        <div className="space-y-12 pb-20">
            <header>
                <motion.div
                    initial={{ opacity: 0, y: -20 }}
                    animate={{ opacity: 1, y: 0 }}
                >
                    <h1 className="text-4xl lg:text-5xl font-black tracking-tighter mb-2">
                        System Settings
                    </h1>
                    <p className="text-muted-foreground font-medium tracking-wide uppercase text-xs">
                        Configure core platform parameters and integrations.
                    </p>
                </motion.div>
            </header>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {/* AI Service Status */}
                <Card className="p-10 rounded-2xl">
                    <CardHeader className="px-0 pt-0 mb-8">
                        <CardTitle className="text-2xl font-black tracking-tight">AI Service Status</CardTitle>
                        <CardDescription>Verify the connection to the Gemini API.</CardDescription>
                    </CardHeader>
                    <CardContent className="px-0">
                        <Button onClick={handleTestApiKey} disabled={isTesting} className="w-full h-12 font-bold rounded-xl">
                            {isTesting ? (
                                <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Verifying...</>
                            ) : (
                                "Test Gemini API Key"
                            )}
                        </Button>
                        {testResult && (
                            <Alert className={`mt-4 rounded-xl ${testResult.status === 'Success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                                {testResult.status === 'Success' ? <CheckCircle className="h-4 w-4" /> : <AlertTriangle className="h-4 w-4" />}
                                <AlertTitle className="font-bold">{testResult.status}</AlertTitle>
                                <AlertDescription className="text-xs">{testResult.message}</AlertDescription>
                            </Alert>
                        )}
                    </CardContent>
                </Card>

                {/* Color Palette */}
                <Card className="p-10 rounded-2xl">
                    <CardHeader className="px-0 pt-0 mb-8">
                        <CardTitle className="text-2xl font-black tracking-tight flex items-center gap-3">
                            <Palette className="w-6 h-6 text-primary" /> Branding &amp; Appearance
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="px-0 space-y-8">
                        <div className="space-y-4">
                            <Label className="text-xs font-bold uppercase tracking-wider text-muted-foreground">System Logo</Label>
                            <div className="p-8 rounded-xl bg-muted/50 border border-dashed flex flex-col items-center justify-center">
                                <Logo className="w-auto h-10" />
                                <Button variant="ghost" className="mt-4 text-xs font-bold uppercase tracking-wider text-muted-foreground rounded-lg">
                                    <Upload className="mr-2 h-3 w-3" /> Change Logo
                                </Button>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <Label className="text-xs font-bold uppercase tracking-wider text-muted-foreground">Accent Color</Label>
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 rounded-lg border p-1 bg-muted/50">
                                    <input
                                        type="color"
                                        defaultValue="#6366f1"
                                        className="w-full h-full rounded-md bg-transparent border-none cursor-pointer"
                                    />
                                </div>
                                <div className="text-sm font-mono font-bold uppercase tracking-tighter">#6366F1</div>
                            </div>
                        </div>
                    </CardContent>
                    <CardFooter className="px-0 pt-8 mt-4 border-t">
                        <Button className="w-full h-12 font-black uppercase tracking-widest rounded-xl shadow-lg shadow-primary/20">
                            <Save className="w-4 h-4 mr-2" /> Save Aesthetic Changes
                        </Button>
                    </CardFooter>
                </Card>
            </div>
        </div>
    );
}

================================================================================
FILE: src/app/admin/system/page.tsx
================================================================================

import { Metadata } from 'next';
import { PageHeader } from '@/components/layout/PageHeader';
import { ConnectionStatus } from '@/components/admin/system/ConnectionStatus';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { AlertCircle, CheckCircle2, Server, Key, Activity } from 'lucide-react';
import { AuditLogViewer } from '@/components/admin/system/AuditLogViewer';
import { SeedDatabaseButton } from '@/components/admin/system/SeedDatabaseButton';

export const metadata: Metadata = {
  title: 'System Health | Admin',
  description: 'Monitor API connections and system status.',
};

export default function SystemPage() {
  return (
    <div className="container mx-auto py-8 space-y-8">
      <div>
        <h1 className="text-3xl font-bold tracking-tight">System Diagnostics</h1>
        <p className="text-muted-foreground">Monitor external API connections and backend services.</p>
      </div>

      <Tabs defaultValue="connections" className="space-y-4">
        <TabsList>
          <TabsTrigger value="connections" className="gap-2"><Key className="h-4 w-4" /> API Connections</TabsTrigger>
          <TabsTrigger value="logs" className="gap-2"><Activity className="h-4 w-4" /> Audit Logs</TabsTrigger>
          <TabsTrigger value="maintenance" className="gap-2"><Server className="h-4 w-4" /> Maintenance</TabsTrigger>
        </TabsList>

        <TabsContent value="connections" className="space-y-6">
          <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            <ConnectionStatus
              serviceName="Google Gemini AI"
              endpoint="/api/health/ai"
              docsUrl="https://ai.google.dev/"
            />
            <ConnectionStatus
              serviceName="Firebase Auth"
              endpoint="/api/health/auth"
              docsUrl="https://firebase.google.com/docs/auth"
            />
            <ConnectionStatus
              serviceName="Firestore DB"
              endpoint="/api/health/db"
              docsUrl="https://firebase.google.com/docs/firestore"
            />
            <ConnectionStatus
              serviceName="Stripe Payments"
              endpoint="/api/health/stripe"
              docsUrl="https://stripe.com/docs/api"
            />
            <ConnectionStatus
              serviceName="SendGrid Email"
              endpoint="/api/health/email"
              docsUrl="https://sendgrid.com/docs"
            />
          </div>
        </TabsContent>

        <TabsContent value="logs">
          <Card>
            <CardHeader>
              <CardTitle>System Audit Log</CardTitle>
              <CardDescription>Recent administrative actions and system errors.</CardDescription>
            </CardHeader>
            <CardContent>
              <AuditLogViewer />
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="maintenance">
          <Card>
            <CardHeader>
              <CardTitle>System Maintenance</CardTitle>
              <CardDescription>Perform administrative tasks and database management.</CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between p-4 border rounded-lg">
                <div className="space-y-1">
                  <h3 className="font-medium">Database Seeding</h3>
                  <p className="text-sm text-muted-foreground">Populate the database with initial categories and sample products.</p>
                </div>
                <SeedDatabaseButton />
              </div>
            </CardContent>
          </Card>
        </TabsContent>

      </Tabs>
    </div >
  );
}

================================================================================
FILE: src/app/admin/users/page.tsx
================================================================================

import { Metadata } from 'next';
import UserManagementClient from '@/components/admin/users/UserManagementClient';
import { PageHeader } from '@/components/layout/PageHeader';

export const metadata: Metadata = {
  title: 'User Management | Admin',
  description: 'Manage users, roles, and permissions.',
};

export default function UsersPage() {
  return (
    <div className="container mx-auto py-8 space-y-8">
        <div>
            <h1 className="text-3xl font-bold tracking-tight">User Management</h1>
            <p className="text-muted-foreground">Manage accounts, assign roles (Seller, Store Owner, Admin), and monitor user status.</p>
        </div>
        <UserManagementClient />
    </div>
  );
}

================================================================================
FILE: src/app/api/admin/seed/route.ts
================================================================================

import { NextRequest, NextResponse } from 'next/server';
import { firestoreDb, auth } from '@/lib/firebase/admin';
import { PlaceHolderImages } from '@/lib/placeholder-images';
import { Product, Category } from '@/lib/types';
import { Timestamp } from 'firebase-admin/firestore';

export async function POST(request: NextRequest) {
    try {
        const authHeader = request.headers.get('Authorization');
        if (!authHeader?.startsWith('Bearer ')) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        const token = authHeader.split('Bearer ')[1];

        // Validate token
        try {
            await auth.verifyIdToken(token);
            // Could check for admin role here
        } catch (e) {
            return NextResponse.json({ error: 'Invalid token' }, { status: 403 });
        }

        // Seed Categories
        const categories: Category[] = [
            { id: 'cat_cards', name: 'Trading Cards', description: 'Collectible trading cards', imageUrl: PlaceHolderImages.find(i => i.id === 'category-cards')?.imageUrl, slug: 'trading-cards' },
            { id: 'cat_coins', name: 'Coins & Paper Money', description: 'Rare coins and currency', imageUrl: PlaceHolderImages.find(i => i.id === 'category-coins')?.imageUrl, slug: 'coins-paper-money' },
            { id: 'cat_comics', name: 'Comics', description: 'Vintage and modern comics', imageUrl: PlaceHolderImages.find(i => i.id === 'product-comic-1')?.imageUrl, slug: 'comics' },
            { id: 'cat_memorabilia', name: 'Sports Memorabilia', description: 'Signed gear and apparel', imageUrl: PlaceHolderImages.find(i => i.id === 'hero')?.imageUrl, slug: 'sports-memorabilia' },
        ];

        const categoryBatch = firestoreDb.batch();
        for (const cat of categories) {
            categoryBatch.set(firestoreDb.collection('categories').doc(cat.id), cat, { merge: true });
        }
        await categoryBatch.commit();

        // Seed Products
        // Using a dummy user ID for the "Picksy Official" seller
        const sellerId = 'picksy-official';

        // Create the seller profile if it doesn't exist
        await firestoreDb.collection('users').doc(sellerId).set({
            uid: sellerId,
            displayName: 'Picksy Official',
            email: 'official@picksy.au',
            photoURL: PlaceHolderImages.find(i => i.id === 'hero')?.imageUrl,
            role: 'admin',
            createdAt: Timestamp.now(),
            isVerified: true,
            rating: 5.0,
            totalSales: 100
        }, { merge: true });

        const products: Partial<Product>[] = [
            {
                id: 'prod_card_1',
                title: 'Rare Dragon Trading Card (Holo)',
                description: 'A pristine condition holographic dragon card. Extremely rare find.',
                price: 1250,
                category: 'Trading Cards',
                sellerId: sellerId,
                sellerName: 'Picksy Official',
                sellerEmail: 'official@picksy.au',
                sellerAvatar: PlaceHolderImages.find(i => i.id === 'hero')?.imageUrl || '',
                imageUrls: [PlaceHolderImages.find(i => i.id === 'product-card-1')?.imageUrl || ''],
                status: 'available',
                condition: 'Mint',
                year: 2023,
                manufacturer: 'Fantasy TCG',
                createdAt: Timestamp.now() as any,
                updatedAt: Timestamp.now() as any,
                isAuction: false
            },
            {
                id: 'prod_coin_1',
                title: 'Ancient Roman Silver Denarius',
                description: 'Authentic silver Denarius from the Roman Empire. Certified.',
                price: 450,
                category: 'Coins & Paper Money',
                sellerId: sellerId,
                sellerName: 'Picksy Official',
                sellerEmail: 'official@picksy.au',
                sellerAvatar: PlaceHolderImages.find(i => i.id === 'hero')?.imageUrl || '',
                imageUrls: [PlaceHolderImages.find(i => i.id === 'product-coin-1')?.imageUrl || ''],
                status: 'available',
                condition: 'Good',
                year: 200, // Approximate
                createdAt: Timestamp.now() as any,
                updatedAt: Timestamp.now() as any,
                isAuction: true,
                startingBid: 300,
                currentBid: 300,
                auctionEndTime: Timestamp.fromMillis(Date.now() + 7 * 24 * 60 * 60 * 1000) as any // 7 days
            }
        ];

        const productBatch = firestoreDb.batch();
        for (const prod of products) {
            if (prod.id) {
                productBatch.set(firestoreDb.collection('products').doc(prod.id), prod, { merge: true });
            }
        }
        await productBatch.commit();

        return NextResponse.json({
            success: true,
            message: `Seeded ${categories.length} categories and ${products.length} products.`,
            details: { categories: categories.length, products: products.length }
        });

    } catch (error: any) {
        console.error('Seeding failed:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}

================================================================================
FILE: src/app/api/debug-admin/route.ts
================================================================================
import { NextResponse } from 'next/server';
import * as admin from 'firebase-admin';

export async function GET() {
  const status = {
    envVarPresent: !!process.env.SERVICE_ACCOUNT_JSON,
    envVarLength: process.env.SERVICE_ACCOUNT_JSON?.length || 0,
    projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
    adminApps: admin.apps.length,
    initializationError: null as string | null,
  };

  try {
    if (!admin.apps.length) {
      // Try to initialize manually to catch the error
      const serviceAccountJson = process.env.SERVICE_ACCOUNT_JSON;
      if (serviceAccountJson) {
         const serviceAccount = JSON.parse(serviceAccountJson);
         admin.initializeApp({
            credential: admin.credential.cert(serviceAccount),
         });
      } else if (process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID) {
         admin.initializeApp({ projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID });
      } else {
         throw new Error("No credentials found");
      }
    }
    // Try a simple read
    await admin.firestore().collection('products').limit(1).get();
    return NextResponse.json({ status: 'OK', details: status });
  } catch (error: any) {
    console.error("Debug Route Error:", error);
    return NextResponse.json({ 
      status: 'ERROR', 
      details: status,
      message: error.message,
      stack: error.stack 
    }, { status: 500 });
  }
}

================================================================================
FILE: src/app/api/debug/route.ts
================================================================================
import { NextResponse } from 'next/server';
import * as admin from 'firebase-admin';

export async function GET() {
  return NextResponse.json({
    message: 'Debug endpoint working',
    timestamp: new Date().toISOString(),
    env: {
      nodeEnv: process.env.NODE_ENV,
      projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
      storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
      hasServiceAccount: !!process.env.SERVICE_ACCOUNT_JSON || !!process.env.FIREBASE_SERVICE_ACCOUNT_JSON,
      serviceAccountLength: (process.env.SERVICE_ACCOUNT_JSON || process.env.FIREBASE_SERVICE_ACCOUNT_JSON || '').length,
    },
    firebase: {
      adminAppsInitialized: admin.apps.length,
      appName: admin.apps[0]?.name || 'none',
      projectId: admin.apps[0]?.options?.projectId || 'not set',
    },
  });
}

================================================================================
FILE: src/app/api/health/[service]/route.ts
================================================================================

import { NextRequest, NextResponse } from 'next/server';
import { firestoreDb, auth } from '@/lib/firebase/admin';

export async function GET(
    request: NextRequest,
    { params }: { params: { service: string } }
) {
    const { service } = await params;
    const start = Date.now();

    try {
        let status = 'unknown';
        let details: any = {};

        switch (service) {
            case 'ai':
                // Check if API key is configured
                const apiKey = process.env.GOOGLE_GENAI_API_KEY || process.env.GEMINI_API_KEY || process.env.GOOGLE_API_KEY;
                if (apiKey) {
                    status = 'healthy';
                } else {
                    status = 'degraded';
                    details.error = 'Missing AI API Key (GOOGLE_GENAI_API_KEY or GEMINI_API_KEY)';
                    throw new Error('Missing AI API Key');
                }
                break;

            case 'auth':
                // Check if Firebase Auth is responsive
                try {
                    // Just listing 1 user to check connection
                    await auth.listUsers(1);
                    status = 'healthy';
                } catch (e: any) {
                    status = 'unhealthy';
                    details.error = e.message;
                    throw e;
                }
                break;

            case 'db':
                // Check if Firestore is responsive
                try {
                    await firestoreDb.listCollections();
                    status = 'healthy';
                } catch (e: any) {
                    status = 'unhealthy';
                    details.error = e.message;
                    throw e;
                }
                break;

            case 'stripe':
                if (process.env.STRIPE_SECRET_KEY) {
                    status = 'healthy';
                } else {
                    status = 'degraded';
                    details.message = 'Stripe key not configured';
                    // Not critical for app start, but reported
                }
                break;

            case 'email':
                if (process.env.SENDGRID_API_KEY) {
                    status = 'healthy';
                } else {
                    status = 'degraded';
                    details.message = 'SendGrid key not configured';
                }
                break;

            default:
                return NextResponse.json({ error: 'Unknown service' }, { status: 400 });
        }

        const latency = Date.now() - start;

        return NextResponse.json({
            status,
            latency,
            details,
            timestamp: new Date().toISOString()
        });

    } catch (error: any) {
        const latency = Date.now() - start;
        return NextResponse.json({
            status: 'unhealthy',
            latency,
            error: error.message,
            timestamp: new Date().toISOString()
        }, { status: 500 });
    }
}

================================================================================
FILE: src/app/api/log-error/route.ts
================================================================================
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
    try {
        const errorData = await request.json();

        // Log to console in development
        if (process.env.NODE_ENV === 'development') {
            console.error('Client Error:', errorData);
        }

        // In production, you would send to error tracking service (Sentry, LogRocket, etc.)
        // Example: await Sentry.captureException(errorData);

        // For now, just log to server console
        console.error('[Client Error]', {
            timestamp: errorData.timestamp,
            url: errorData.url,
            error: errorData.error,
            userAgent: errorData.userAgent,
        });

        return NextResponse.json({ success: true });
    } catch (error) {
        console.error('Failed to log error:', error);
        return NextResponse.json({ success: false }, { status: 500 });
    }
}

================================================================================
FILE: src/app/api/setup-cors/route.ts
================================================================================
import { NextResponse } from 'next/server';
import { storage } from '@/lib/firebase/admin'; // Use our robust admin export

export async function GET() {
  try {
    const bucket = storage.bucket(); // Uses default bucket
    // Or specify explicit bucket if needed: storage.bucket('studio-8322868971-8ca89.appspot.com');

    await bucket.setCorsConfiguration([
      {
        origin: ["*"],
        method: ["GET", "POST", "PUT", "DELETE", "HEAD", "OPTIONS"],
        responseHeader: ["Content-Type", "Authorization", "Content-Length", "User-Agent", "x-goog-resumable"],
        maxAgeSeconds: 3600
      }
    ]);

    return NextResponse.json({ 
      status: 'SUCCESS', 
      message: `CORS configured for bucket: ${bucket.name}`,
      bucketName: bucket.name 
    });
  } catch (error: any) {
    console.error("CORS Setup Error:", error);
    return NextResponse.json({ 
      status: 'ERROR', 
      message: error.message,
      stack: error.stack 
    }, { status: 500 });
  }
}

================================================================================
FILE: src/app/browse/page.tsx
================================================================================
'use client';

import { Suspense } from 'react';
import InfiniteProductGrid from '@/components/products/InfiniteProductGrid';
import { useSearchParams } from 'next/navigation';

function BrowsePageContent() {
  const searchParams = useSearchParams();
  const searchTerm = searchParams.get('q') || '';

  return (
     <InfiniteProductGrid
        pageTitle={searchTerm ? `Results for "${searchTerm}"` : 'All Collectibles'}
        pageDescription="Browse items from thousands of sellers."
        initialFilterState={{
          q: searchTerm
        }}
     />
  );
}

export default function BrowsePage() {
  return (
    <Suspense>
      <BrowsePageContent />
    </Suspense>
  )
}

================================================================================
FILE: src/app/checkout/confirmation/page.tsx
================================================================================

'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardFooter } from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import Image from 'next/image';
import Link from 'next/link';
import { CheckCircle2, ShoppingBag } from 'lucide-react';
import type { CartItem } from '@/context/CartContext';

interface OrderDetails {
    orderId: string;
    items: CartItem[];
    totalAmount: number;
}

export default function ConfirmationPage() {
    const [order, setOrder] = useState<OrderDetails | null>(null);
    const router = useRouter();

    useEffect(() => {
        const savedOrder = sessionStorage.getItem('lastOrder');
        if (savedOrder) {
            try {
                setTimeout(() => {
                    setOrder(JSON.parse(savedOrder));
                    // Clear the session storage after retrieving it
                    sessionStorage.removeItem('lastOrder');
                }, 0);
            } catch {
                router.push('/');
            }
        } else {
            // If there's no order in session, redirect to home
            router.push('/');
        }
    }, [router]);

    if (!order) {
        return (
            <div className="container mx-auto px-4 py-16 text-center">
                <ShoppingBag className="h-16 w-16 mx-auto text-gray-300 mb-4" />
                <h1 className="text-2xl font-bold text-gray-800 mb-2">Looking for an order?</h1>
                <p className="text-gray-600 mb-6">We can't find any recent order details.</p>
                <Button asChild>
                    <Link href="/">Continue Shopping</Link>
                </Button>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="container mx-auto px-4 py-12">
                <Card className="max-w-2xl mx-auto">
                    <CardHeader className="text-center">
                        <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <CheckCircle2 className="w-10 h-10 text-green-600" />
                        </div>
                        <CardTitle className="text-2xl font-bold">Thank you for your order!</CardTitle>
                        <p className="text-muted-foreground">Your order has been placed successfully.</p>
                        <p className="text-sm text-muted-foreground pt-2">Order ID: <span className="font-mono bg-gray-100 p-1 rounded">{order.orderId}</span></p>
                    </CardHeader>
                    <CardContent>
                        <Separator />
                        <div className="py-6 space-y-4">
                            <h3 className="font-semibold">Order Summary</h3>
                            {order.items.map(item => (
                                <div key={item.id} className="flex items-center gap-4">
                                    <div className="relative w-16 h-16 rounded-md overflow-hidden bg-muted shrink-0">
                                        <Image src={item.imageUrls[0]} alt={item.title} fill className="object-cover" />
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-medium line-clamp-1">{item.title}</p>
                                        <p className="text-sm text-muted-foreground">Qty: {item.quantity}</p>
                                    </div>
                                    <p className="font-medium">${(item.price * item.quantity).toFixed(2)}</p>
                                </div>
                            ))}
                        </div>
                        <Separator />
                        <div className="py-6 flex justify-between font-bold text-lg">
                            <span>Total Paid</span>
                            <span>${order.totalAmount.toFixed(2)}</span>
                        </div>
                    </CardContent>
                    <CardFooter>
                        <Button size="lg" className="w-full" asChild>
                            <Link href="/">Continue Shopping</Link>
                        </Button>
                    </CardFooter>
                </Card>
            </div>
        </div>
    );
}

================================================================================
FILE: src/app/checkout/page.tsx
================================================================================

'use client';

import { useCart } from '@/context/CartContext';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardFooter } from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import { useToast } from '@/hooks/use-toast';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import Link from 'next/link';
import { ShoppingBag, ArrowLeft, Loader2 } from 'lucide-react';
import { useId, useState, useTransition } from 'react';
import { useUser } from '@/firebase';
import type { CartItem } from '@/context/CartContext';
import { createOrderAction } from '@/app/actions/order';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';


export default function CheckoutPage() {
  const { items, cartTotal, clearCart, itemCount, setIsCartOpen } = useCart();
  const { toast } = useToast();
  const router = useRouter();
  const { user } = useUser();
  const [isPending, startTransition] = useTransition();

  const shippingCost = cartTotal > 50 ? 0 : 7.99;
  const taxRate = 0.08; // 8% tax
  const taxAmount = cartTotal * taxRate;
  const totalAmount = cartTotal + shippingCost + taxAmount;

  const handlePlaceOrder = (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) {
        toast({ title: "Please sign in to place an order.", variant: 'destructive'});
        router.push('/sign-in?redirect=/checkout');
        return;
    }

    startTransition(async () => {
        const idToken = await getCurrentUserIdToken();
        if (!idToken) {
            toast({ title: "Authentication session expired. Please sign in again.", variant: 'destructive' });
            router.push('/sign-in?redirect=/checkout');
            return;
        }

        const cartItemsForAction = items.map(item => ({ id: item.id, quantity: item.quantity }));
        
        try {
            const result = await createOrderAction(cartItemsForAction, idToken);

            if (result.error) {
                throw new Error(result.error);
            }
            
            // Store order details in session storage for confirmation page
            if (result.order) {
                sessionStorage.setItem('lastOrder', JSON.stringify(result.order));
            }
            
            clearCart();
            router.push('/checkout/confirmation');
            toast({
                title: 'Order Placed!',
                description: 'Thank you for your purchase. We will notify the seller.',
            });

        } catch (error: any) {
            console.error("Checkout failed: ", error);
            toast({
                title: "Order Failed",
                description: error.message || "Could not place your order at this time.",
                variant: "destructive"
            });
        }
    });
  };

  if (itemCount === 0) {
    return (
        <div className="container mx-auto px-4 py-16 text-center">
            <ShoppingBag className="h-16 w-16 mx-auto text-gray-300 mb-4" />
            <h1 className="text-2xl font-bold text-gray-800 mb-2">Your Cart is Empty</h1>
            <p className="text-gray-600 mb-6">You can't proceed to checkout with an empty cart.</p>
            <Button asChild>
                <Link href="/">Browse Collectibles</Link>
            </Button>
        </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="container mx-auto px-4 py-12">
        <Button variant="ghost" className="mb-6" onClick={() => setIsCartOpen(true)}>
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back to Cart
        </Button>
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
          {/* Shipping and Payment Info */}
          <div>
            <form onSubmit={handlePlaceOrder} className="space-y-8">
              <Card>
                <CardHeader>
                  <CardTitle>Cash on Delivery (COD)</CardTitle>
                </CardHeader>
                <CardContent>
                  <p className="text-muted-foreground">You will pay the seller directly upon receiving the item. Please arrange a safe meeting location.</p>
                </CardContent>
                <CardFooter>
                    <Button type="submit" size="lg" className="w-full" disabled={isPending}>
                        {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                        Place Order (COD)
                    </Button>
                </CardFooter>
              </Card>
            </form>
          </div>

          {/* Order Summary */}
          <div className="lg:sticky lg:top-24 h-fit">
            <Card>
              <CardHeader>
                <CardTitle>Order Summary</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-4 max-h-64 overflow-y-auto pr-2">
                    {items.map(item => (
                        <div key={item.id} className="flex items-center gap-4">
                            <div className="relative w-16 h-16 rounded-md overflow-hidden bg-muted">
                                <Image src={item.imageUrls[0]} alt={item.title} fill className="object-cover" />
                                <span className="absolute -top-2 -right-2 bg-primary text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">
                                    {item.quantity}
                                </span>
                            </div>
                            <div className="flex-1">
                                <p className="font-medium line-clamp-1">{item.title}</p>
                                <p className="text-sm text-muted-foreground">Qty: {item.quantity}</p>
                            </div>
                            <p className="font-medium">${(item.price * item.quantity).toFixed(2)}</p>
                        </div>
                    ))}
                </div>
                <Separator />
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Subtotal</span>
                    <span>${cartTotal.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Shipping</span>
                    <span>{shippingCost === 0 ? 'Free' : `$${shippingCost.toFixed(2)}`}</span>
                  </div>
                   <div className="flex justify-between">
                    <span className="text-muted-foreground">Taxes (Est.)</span>
                    <span>${taxAmount.toFixed(2)}</span>
                  </div>
                </div>
                <Separator />
                <div className="flex justify-between font-bold text-lg">
                  <span>Total</span>
                  <span>${totalAmount.toFixed(2)}</span>
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/coins/bullion/page.tsx
================================================================================

'use client';
import { Suspense } from 'react';
import { PageHeader } from "@/components/layout/PageHeader";
import MontageGrid from "@/components/products/MontageGrid";
import ProductGridSkeleton from '@/components/products/ProductGridSkeleton';
import { useCollection, useFirebase, useMemoFirebase } from '@/firebase';
import { collection, query, where, orderBy, limit } from 'firebase/firestore';
import type { Product } from '@/lib/types';

export default function BullionPage() {
    const { firestore } = useFirebase();
    const productsQuery = useMemoFirebase(() => {
        if (!firestore) return null;
        return query(collection(firestore, 'products'), where('category', '==', 'Bullion'), orderBy('createdAt', 'desc'), limit(100));
    }, [firestore]);

    const { data: products, isLoading } = useCollection<Product>(productsQuery);
    
    return (
        <div className="min-h-screen">
            <div className="container mx-auto px-4 py-8">
                <PageHeader
                    title="Bullion"
                    description="Invest in gold, silver, and platinum bullion."
                />
            </div>
            <Suspense fallback={<div className="container mx-auto px-4"><ProductGridSkeleton count={20} /></div>}>
                {isLoading ? <div className="container mx-auto px-4"><ProductGridSkeleton count={20} /></div> : <MontageGrid products={products || []} />}
            </Suspense>
        </div>
    );
}

================================================================================
FILE: src/app/coins/layout.tsx
================================================================================

'use client';
import type { ReactNode } from 'react';
import { usePathname } from 'next/navigation';
import { CollapsibleSidebarLayout } from '@/components/layout/collapsible-sidebar-layout';
import { CoinsSidebar } from '@/components/layout/CoinsSidebar';
import { useCollection, useMemoFirebase } from '@/firebase';
import { collection, query, where, orderBy }from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import type { Category } from '@/lib/types';


export default function CoinsLayout({ children }: { children: ReactNode }) {
  const pathname = usePathname();
  const categoriesQuery = useMemoFirebase(() => query(collection(db, 'categories'), where('section', '==', 'coins'), orderBy('name', 'asc')), []);
  const { data: categories, isLoading } = useCollection<Category>(categoriesQuery);

  // Simple pages that should use the sidebar
  const sidebarPages = [
    '/coins/world',
    '/coins/ancient',
    '/coins/by-metal',
    '/coins/by-year',
    '/coins/modern',
    '/coins/coins'
  ];

  // Also include dynamic category pages
  const dynamicSidebarPages = (categories || []).map(cat => cat.href);
  const allSidebarPages = [...sidebarPages, ...dynamicSidebarPages, ...categories?.map(c => c.href) || []];
  
  const isSidebarPage = allSidebarPages.some(p => pathname === p || pathname.startsWith(p + '/'));

  // Define full-width pages explicitly
  const fullWidthPages = ['/coins', '/coins/bullion'];
  if (fullWidthPages.includes(pathname)) {
      return <>{children}</>;
  }

  if (isSidebarPage) {
    return (
      <CollapsibleSidebarLayout sidebar={<CoinsSidebar pathname={pathname} categories={categories || []} />}>
        <div className="p-4 sm:p-6 lg:p-8">
            {children}
        </div>
      </CollapsibleSidebarLayout>
    );
  }

  // Fallback for pages like /coins, /coins/bullion, etc., that have their own full-width layout
  return (
    <>
      {children}
    </>
  );
}

================================================================================
FILE: src/app/coins/notes/page.tsx
================================================================================

'use client';
import { Suspense, useMemo } from 'react';
import { PageHeader } from "@/components/layout/PageHeader";
import MontageGrid from "@/components/products/MontageGrid";
import ProductGridSkeleton from '@/components/products/ProductGridSkeleton';
import type { Product } from '@/lib/types';
import { useCollection, useFirebase, useMemoFirebase } from '@/firebase';
import { collection, query, where, orderBy, limit } from 'firebase/firestore';


export default function NotesPage() {
    const { firestore } = useFirebase();
    const productsQuery = useMemoFirebase(() => {
        if (!firestore) return null;
        return query(collection(firestore, 'products'), where('category', '==', 'Coins'), orderBy('createdAt', 'desc'), limit(100));
    }, [firestore]);

    const { data: products, isLoading } = useCollection<Product>(productsQuery);
    
    const filteredProducts = useMemo(() => {
        if (!products) return [];
        return products.filter(p => 
            (typeof p.title === 'string' && p.title.toLowerCase().includes('note')) || 
            (typeof p.description === 'string' && p.description.toLowerCase().includes('note'))
        ) || [];
    }, [products]);

    return (
        <div className="min-h-screen">
            <div className="container mx-auto px-4 py-8">
                <PageHeader
                    title="Collectible Banknotes"
                    description="Explore rare and historical banknotes from around the world."
                />
            </div>
            <Suspense fallback={<div className="container mx-auto px-4"><ProductGridSkeleton count={20} /></div>}>
                {isLoading ? <div className="container mx-auto px-4"><ProductGridSkeleton count={20} /></div> : <MontageGrid products={filteredProducts} />}
            </Suspense>
        </div>
    );
}

================================================================================
FILE: src/app/coins/page.tsx
================================================================================

'use client';
import { Suspense } from "react";
import ProductGridSkeleton from "@/components/products/ProductGridSkeleton";
import { PageHeader } from "@/components/layout/PageHeader";
import MontageGrid from "@/components/products/MontageGrid";
import { useCollection, useFirebase, useMemoFirebase } from "@/firebase";
import { collection, query, where, limit, orderBy } from 'firebase/firestore';
import type { Product } from "@/lib/types";

export default function CollectorCoinsPage() {
  const { firestore } = useFirebase();

  const productsQuery = useMemoFirebase(() => {
    if (!firestore) return null;
    return query(collection(firestore, 'products'), where('category', '==', 'Coins'), orderBy('createdAt', 'desc'), limit(100));
  }, [firestore]);

  const { data: products, isLoading } = useCollection<Product>(productsQuery);

  return (
    <div className="min-h-screen">
      <div className="container mx-auto px-4 py-8">
        <PageHeader 
            title="Collector Coins"
        />
      </div>
      <Suspense fallback={<div className="container mx-auto px-4"><ProductGridSkeleton count={20} /></div>}>
        {isLoading ? <div className="container mx-auto px-4"><ProductGridSkeleton count={20} /></div> : <MontageGrid products={products || []} />}
      </Suspense>
    </div>
  );
}

================================================================================
FILE: src/app/collectibles/comics/page.tsx
================================================================================

'use client';
import { Suspense, useMemo } from 'react';
import { PageHeader } from "@/components/layout/PageHeader";
import MontageGrid from "@/components/products/MontageGrid";
import ProductGridSkeleton from '@/components/products/ProductGridSkeleton';
import type { Product } from '@/lib/types';
import { useCollection, useFirebase, useMemoFirebase } from '@/firebase';
import { collection, query, where, orderBy, limit } from 'firebase/firestore';


export default function ComicsPage() {
    const { firestore } = useFirebase();
    const productsQuery = useMemoFirebase(() => {
        if (!firestore) return null;
        return query(
            collection(firestore, 'products'), 
            where('subCategory', '==', 'Comics'),
            orderBy('createdAt', 'desc'), 
            limit(100));
    }, [firestore]);

    const { data: products, isLoading } = useCollection<Product>(productsQuery);
    
    return (
        <div className="min-h-screen">
            <div className="container mx-auto px-4 py-8">
                <PageHeader
                    title="Comics"
                    description="Explore a universe of comic books, from vintage classics to modern graphic novels."
                />
            </div>
            <Suspense fallback={<div className="container mx-auto px-4"><ProductGridSkeleton count={20} /></div>}>
                {isLoading ? <div className="container mx-auto px-4"><ProductGridSkeleton count={20} /></div> : <MontageGrid products={products || []} />}
            </Suspense>
        </div>
    );
}

================================================================================
FILE: src/app/collectibles/layout.tsx
================================================================================
import type { ReactNode } from 'react';

export default function CollectiblesLayout({
  children,
}: {
  children: ReactNode;
}) {

  return (
    <>
      {children}
    </>
  );
}

================================================================================
FILE: src/app/collectibles/page.tsx
================================================================================

'use client';
import { Suspense, useMemo } from 'react';
import { PageHeader } from "@/components/layout/PageHeader";
import MontageGrid from "@/components/products/MontageGrid";
import ProductGridSkeleton from '@/components/products/ProductGridSkeleton';
import { Product } from '@/lib/types';
import { useCollection, useFirebase, useMemoFirebase } from '@/firebase';
import { collection, query, where, orderBy, limit } from 'firebase/firestore';

const COLLECTIBLES_CATEGORIES = ['Collectibles', 'Stamps', 'Comics', 'Figurines', 'Toys', 'Shoes', 'Memorabilia'];

export default function CollectiblesPage() {
    const { firestore } = useFirebase();

    const productsQuery = useMemoFirebase(() => {
        if (!firestore) return null;
        return query(collection(firestore, 'products'), where('category', 'in', COLLECTIBLES_CATEGORIES), orderBy('createdAt', 'desc'), limit(100));
    }, [firestore]);

    const { data: products, isLoading } = useCollection<Product>(productsQuery);

    return (
        <div className="min-h-screen">
            <div className="container mx-auto px-4 py-8">
                <PageHeader
                    title="General Collectibles"
                    description="A wide array of treasures from various categories."
                />
            </div>
            <Suspense fallback={<div className="container mx-auto px-4"><ProductGridSkeleton count={20} /></div>}>
                 {isLoading ? <div className="container mx-auto px-4"><ProductGridSkeleton count={20} /></div> : <MontageGrid products={products || []} />}
            </Suspense>
        </div>
    );
}


================================================================================
FILE: src/app/collector-cards/CollectorCardsClient.tsx
================================================================================
'use client';

import InfiniteProductGrid from '@/components/products/InfiniteProductGrid';

export default function CollectorCardsClient({ pageTitle, pageDescription, subCategory, category }: { pageTitle: string, pageDescription?: string, subCategory?: string, category?: string }) {
    return (
        <InfiniteProductGrid 
            pageTitle={pageTitle}
            pageDescription={pageDescription}
            initialFilterState={{
                category: category,
                subCategory: subCategory,
            }}
        />
    )
}

================================================================================
FILE: src/app/collector-cards/layout.tsx
================================================================================
import type { ReactNode } from 'react';

export default function CollectorCardsLayout({ children }: { children: ReactNode }) {
  return (
    <>
      {children}
    </>
  );
}

================================================================================
FILE: src/app/collector-cards/page.tsx
================================================================================
'use client';
import { Suspense } from "react";
import ProductGridSkeleton from "@/components/products/ProductGridSkeleton";
import CollectorCardsClient from "./CollectorCardsClient";

export default function CollectorCardsPage() {
  return (
    <Suspense fallback={<div className="container mx-auto px-4 py-8"><ProductGridSkeleton count={20} /></div>}>
      <CollectorCardsClient
        pageTitle="Collector Cards"
        pageDescription="Browse all sports, trading, and graded cards."
        category="Collector Cards"
      />
    </Suspense>
  );
}

================================================================================
FILE: src/app/collector-cards/sports/page.tsx
================================================================================
'use client';
import { Suspense } from "react";
import ProductGridSkeleton from "@/components/products/ProductGridSkeleton";
import CollectorCardsClient from "../CollectorCardsClient";

export default function SportsCardsPage() {
    return (
        <Suspense fallback={<div className="container mx-auto px-4 py-8"><ProductGridSkeleton count={20} /></div>}>
            <CollectorCardsClient 
                pageTitle="Sports Cards"
                pageDescription="Browse our collection of basketball, baseball, football cards and more."
                subCategory="Sports Cards"
                category="Collector Cards"
            />
        </Suspense>
    );
}

================================================================================
FILE: src/app/collector-cards/trading/page.tsx
================================================================================
'use client';
import { Suspense } from "react";
import ProductGridSkeleton from "@/components/products/ProductGridSkeleton";
import CollectorCardsClient from "../CollectorCardsClient";

export default function TradingCardsPage() {
    return (
        <Suspense fallback={<div className="container mx-auto px-4 py-8"><ProductGridSkeleton count={20} /></div>}>
            <CollectorCardsClient 
                pageTitle="Trading Cards"
                pageDescription="Explore a universe of trading cards from games like PokÃ©mon, Magic: The Gathering, and more."
                subCategory="Trading Cards"
                category="Collector Cards"
            />
        </Suspense>
    );
}

================================================================================
FILE: src/app/consign/actions.ts
================================================================================
'use server';

import { z } from "zod";
import { db } from "@/lib/firebase/config";
import { collection, addDoc, Timestamp } from "firebase/firestore";
import { sendNotification, getSuperAdminId } from "@/services/notifications";

const ConsignmentSchema = z.object({
    name: z.string().min(1, "Name is required"),
    email: z.string().email("Invalid email address"),
    phone: z.string().optional(),
    itemType: z.string().min(1, "Please select an item type"),
    estimatedValue: z.string().min(1, "Please provide an estimated value"),
    description: z.string().min(10, "Please provide more details about your collection"),
});

export type ConsignmentState = {
    success?: boolean;
    error?: string;
    fields?: {
        name?: string;
        email?: string;
        phone?: string;
        itemType?: string;
        estimatedValue?: string;
        description?: string;
    };
    message?: string;
};

export async function submitConsignmentInquiry(
    prevState: ConsignmentState,
    formData: FormData
): Promise<ConsignmentState> {
    const rawData = {
        name: formData.get("name"),
        email: formData.get("email"),
        phone: formData.get("phone"),
        itemType: formData.get("itemType"),
        estimatedValue: formData.get("estimatedValue"),
        description: formData.get("description"),
    };

    const validatedFields = ConsignmentSchema.safeParse(rawData);

    if (!validatedFields.success) {
        return {
            success: false,
            error: "Please correct the errors below.",
            fields: validatedFields.error.flatten().fieldErrors as any,
        };
    }

    try {
        const { name, email, phone, itemType, estimatedValue, description } = validatedFields.data;

        // 1. Save to Firestore
        await addDoc(collection(db, "consignment_inquiries"), {
            name,
            email,
            phone: phone || null,
            itemType,
            estimatedValue,
            description,
            status: "new",
            createdAt: Timestamp.now(),
        });

        // 2. Notify Admin
        const adminId = await getSuperAdminId();
        if (adminId) {
            await sendNotification(
                adminId,
                "system",
                "New Consignment Inquiry",
                `From: ${name}\nType: ${itemType}\nValue: ${estimatedValue}\nDesc: ${description.substring(0, 50)}...`,
                "/admin/consignments"
            );
        }

        // 3. Send Confirmation Email (Simulated)
        await sendConfirmationEmail(email, name);

        return {
            success: true,
            message: "Thank you! Your inquiry has been sent. We've sent a confirmation email to your inbox.",
        };
    } catch (e) {
        console.error("Consignment submission error:", e);
        return {
            success: false,
            error: "Something went wrong. Please try again later.",
        };
    }
}

/**
 * Sends a confirmation email to the user.
 * 
 * TODO: Integrate with a real email service provider (e.g., Resend, SendGrid, AWS SES).
 * Currently, this function simulates sending an email by logging to the console.
 */
async function sendConfirmationEmail(email: string, name: string): Promise<void> {
    // In a production environment, you would use an email SDK here.
    // Example with Resend:
    // await resend.emails.send({
    //   from: 'Consignments <consign@picksy.au>',
    //   to: email,
    //   subject: 'We received your consignment inquiry',
    //   react: EmailTemplate({ name }),
    // });

    console.log(`[SIMULATED EMAIL] To: ${email}`);
    console.log(`[SIMULATED EMAIL] Subject: We received your consignment inquiry`);
    console.log(`[SIMULATED EMAIL] Body: Hi ${name}, thanks for reaching out! We'll be in touch shortly.`);
    
    return Promise.resolve();
}

================================================================================
FILE: src/app/consign/contact-form.tsx
================================================================================
'use client';

import { useFormStatus } from 'react-dom';
import { useActionState, useEffect, useRef } from 'react';
import { submitConsignmentInquiry, type ConsignmentState } from './actions';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Card, CardContent } from "@/components/ui/card";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { CheckCircle2, AlertCircle, Loader2 } from "lucide-react";

const initialState: ConsignmentState = {
    message: '',
    error: '',
    fields: {},
};

function SubmitButton() {
    const { pending } = useFormStatus();
    return (
        <Button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-lg py-6" disabled={pending}>
            {pending ? (
                <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Sending...
                </>
            ) : (
                'Send Inquiry'
            )}
        </Button>
    );
}

export function ConsignmentForm() {
    const [state, formAction] = useActionState(submitConsignmentInquiry, initialState);
    const formRef = useRef<HTMLFormElement>(null);

    useEffect(() => {
        if (state.success && formRef.current) {
            formRef.current.reset();
        }
    }, [state.success]);

    return (
        <Card className="w-full max-w-xl mx-auto shadow-lg border-2 border-blue-100">
            <CardContent className="p-8">
                <h3 className="text-2xl font-bold mb-6 text-center">Get Your Free Valuation</h3>
                
                {state.success && (
                    <Alert className="mb-6 bg-green-50 border-green-200 text-green-800">
                        <CheckCircle2 className="h-4 w-4" />
                        <AlertTitle>Success!</AlertTitle>
                        <AlertDescription>{state.message}</AlertDescription>
                    </Alert>
                )}

                {state.error && (
                    <Alert className="mb-6 bg-red-50 border-red-200 text-red-800">
                        <AlertCircle className="h-4 w-4" />
                        <AlertTitle>Error</AlertTitle>
                        <AlertDescription>{state.error}</AlertDescription>
                    </Alert>
                )}

                <form ref={formRef} action={formAction} className="space-y-6">
                    <div className="space-y-2">
                        <Label htmlFor="name">Full Name</Label>
                        <Input 
                            id="name" 
                            name="name" 
                            placeholder="Your Name" 
                            required 
                            defaultValue={state.fields?.name}
                        />
                        {state.fields?.name && <p className="text-sm text-red-500">{state.fields.name}</p>}
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="email">Email Address</Label>
                        <Input 
                            id="email" 
                            name="email" 
                            type="email" 
                            placeholder="you@example.com" 
                            required 
                            defaultValue={state.fields?.email}
                        />
                         {state.fields?.email && <p className="text-sm text-red-500">{state.fields.email}</p>}
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="phone">Phone Number (Optional)</Label>
                        <Input 
                            id="phone" 
                            name="phone" 
                            type="tel" 
                            placeholder="0400 000 000" 
                            defaultValue={state.fields?.phone}
                        />
                         {state.fields?.phone && <p className="text-sm text-red-500">{state.fields.phone}</p>}
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div className="space-y-2">
                            <Label htmlFor="itemType">Type of Items</Label>
                            <Select name="itemType" defaultValue={state.fields?.itemType}>
                                <SelectTrigger>
                                    <SelectValue placeholder="Select type" />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem value="Sports Cards">Sports Cards</SelectItem>
                                    <SelectItem value="TCG">TCG (PokÃ©mon, Magic, etc.)</SelectItem>
                                    <SelectItem value="Coins & Banknotes">Coins & Banknotes</SelectItem>
                                    <SelectItem value="Comics">Comics</SelectItem>
                                    <SelectItem value="Sealed Product">Sealed Product</SelectItem>
                                    <SelectItem value="Memorabilia">Memorabilia</SelectItem>
                                    <SelectItem value="Other">Other</SelectItem>
                                </SelectContent>
                            </Select>
                            {state.fields?.itemType && <p className="text-sm text-red-500">{state.fields.itemType}</p>}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="estimatedValue">Estimated Value</Label>
                            <Input 
                                id="estimatedValue" 
                                name="estimatedValue" 
                                placeholder="e.g., $5,000" 
                                required 
                                defaultValue={state.fields?.estimatedValue}
                            />
                            {state.fields?.estimatedValue && <p className="text-sm text-red-500">{state.fields.estimatedValue}</p>}
                        </div>
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="description">Tell us about your collection</Label>
                        <Textarea 
                            id="description" 
                            name="description" 
                            placeholder="I have a collection of..." 
                            className="min-h-[120px]" 
                            required 
                            defaultValue={state.fields?.description}
                        />
                        <p className="text-xs text-gray-500">Please provide a brief overview of what you have (e.g., '1990s NBA Cards', 'Gold Sovereigns').</p>
                        {state.fields?.description && <p className="text-sm text-red-500">{state.fields.description}</p>}
                    </div>

                    <SubmitButton />
                </form>
            </CardContent>
        </Card>
    );
}

================================================================================
FILE: src/app/consign/layout.tsx
================================================================================
import type { Metadata } from 'next';

export const metadata: Metadata = {
    title: 'Consignment Services | Sell Your Collectibles Hassle-Free',
    description: 'Expert consignment services for trading cards, coins, and collectibles in Australia. Stay anonymous, maximize returns, and let us handle everything. Contact Ben Mackie: 0422 225 265',
    keywords: 'consignment, collectibles consignment Australia, sell trading cards, sell coins, collectibles broker, anonymous selling',
    openGraph: {
        title: 'Professional Consignment Services | Picksy Australia',
        description: 'Sell your collectibles without the hassle. Expert consignment services with flexible rates and complete anonymity.',
        type: 'website',
    },
};

export { default } from './page';

================================================================================
FILE: src/app/consign/page.tsx
================================================================================
'use client';
import { PageHeader } from "@/components/layout/PageHeader";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
import { CheckCircle2, Shield, TrendingUp, Clock, Eye, Handshake, Mail, Phone, Star, Boxes, Gem, Bitcoin, BookOpen } from "lucide-react";
import Image from 'next/image';
import { ConsignmentForm } from "./contact-form";


export default function ConsignPage() {
    return (
        <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white">
            {/* Hero Section */}
            <div className="bg-gradient-to-r from-blue-600 to-indigo-800 text-white">
                <div className="container mx-auto px-4 py-20 md:py-28">
                    <div className="max-w-4xl mx-auto text-center">
                        <h1 className="text-5xl md:text-6xl font-extrabold mb-6 tracking-tight">
                            Turn Your Collectibles into Cash, Effortlessly
                        </h1>
                        <p className="text-xl md:text-2xl mb-8 text-blue-100 font-light">
                            Maximize Your Returns, Minimize Your Effort.
                        </p>
                        <p className="text-lg text-blue-100 mb-10">
                            Our premier consignment service handles everything, so you can sell your collection discreetly and profitably.
                        </p>
                        <div className="flex flex-col sm:flex-row gap-4 justify-center">
                            <Button
                                size="lg"
                                className="bg-white text-indigo-700 hover:bg-indigo-50 font-bold text-lg py-7 px-8"
                                onClick={() => document.getElementById('contact-section')?.scrollIntoView({ behavior: 'smooth' })}
                            >
                                Get a Free Valuation
                            </Button>
                            <Button
                                size="lg"
                                variant="outline"
                                className="bg-transparent border-white text-white hover:bg-white/10 hover:text-white font-bold text-lg py-7 px-8"
                                onClick={() => document.getElementById('process-section')?.scrollIntoView({ behavior: 'smooth' })}
                            >
                                How It Works
                            </Button>
                        </div>
                    </div>
                </div>
            </div>

            <div className="container mx-auto px-4 py-16">

                {/* What We Accept Section */}
                <div className="max-w-5xl mx-auto mb-20 text-center">
                    <h2 className="text-4xl font-bold mb-4">What We Accept</h2>
                    <p className="text-lg text-gray-600 mb-12">We specialize in a wide range of high-value collectibles. If you have quality items, we can sell them.</p>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                        <div className="flex flex-col items-center p-4 bg-gray-100 rounded-xl">
                            <Gem className="h-10 w-10 text-blue-600 mb-3" />
                            <span className="font-semibold text-center">Sports & Trading Cards</span>
                        </div>
                        <div className="flex flex-col items-center p-4 bg-gray-100 rounded-xl">
                            <Bitcoin className="h-10 w-10 text-orange-500 mb-3" />
                            <span className="font-semibold text-center">Coins & Banknotes</span>
                        </div>
                        <div className="flex flex-col items-center p-4 bg-gray-100 rounded-xl">
                            <BookOpen className="h-10 w-10 text-green-600 mb-3" />
                            <span className="font-semibold text-center">Comic Books</span>
                        </div>
                        <div className="flex flex-col items-center p-4 bg-gray-100 rounded-xl">
                            <Boxes className="h-10 w-10 text-purple-600 mb-3" />
                            <span className="font-semibold text-center">Sealed Products</span>
                        </div>
                        <div className="flex flex-col items-center p-4 bg-gray-100 rounded-xl">
                            <Star className="h-10 w-10 text-yellow-500 mb-3" />
                            <span className="font-semibold text-center">Other Graded Items</span>
                        </div>
                    </div>
                </div>

                {/* Why Consign Section */}
                <div className="max-w-5xl mx-auto mb-20">
                    <h2 className="text-4xl font-bold text-center mb-12">
                        The Picksy Advantage
                    </h2>

                    <div className="grid md:grid-cols-2 gap-8">
                        <Card className="border-2 hover:border-blue-500 transition-all shadow-sm hover:shadow-lg">
                            <CardContent className="p-8">
                                <div className="flex items-start gap-5">
                                    <div className="p-3 bg-blue-100 rounded-full">
                                        <Eye className="h-7 w-7 text-blue-600" />
                                    </div>
                                    <div>
                                        <h3 className="text-2xl font-semibold mb-2">Sell Discreetly & Confidentially</h3>
                                        <p className="text-gray-600 text-lg">
                                            Your identity remains 100% private. We manage all listings and buyer communications, ensuring you stay anonymous.
                                        </p>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>

                        <Card className="border-2 hover:border-green-500 transition-all shadow-sm hover:shadow-lg">
                            <CardContent className="p-8">
                                <div className="flex items-start gap-5">
                                    <div className="p-3 bg-green-100 rounded-full">
                                        <TrendingUp className="h-7 w-7 text-green-600" />
                                    </div>
                                    <div>
                                        <h3 className="text-2xl font-semibold mb-2">Expert Pricing & Maximum Returns</h3>
                                        <p className="text-gray-600 text-lg">
                                            Leverage our market expertise. We use cutting-edge pricing strategies to ensure your items fetch the highest possible market price.
                                        </p>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>

                        <Card className="border-2 hover:border-purple-500 transition-all shadow-sm hover:shadow-lg">
                            <CardContent className="p-8">
                                <div className="flex items-start gap-5">
                                    <div className="p-3 bg-purple-100 rounded-full">
                                        <Clock className="h-7 w-7 text-purple-600" />
                                    </div>
                                    <div>
                                        <h3 className="text-2xl font-semibold mb-2">We Do All The Work</h3>
                                        <p className="text-gray-600 text-lg">
                                            From professional, high-resolution photography to listings, customer service, and shipping â€“ we handle it all. You just relax and get paid.
                                        </p>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>

                        <Card className="border-2 hover:border-orange-500 transition-all shadow-sm hover:shadow-lg">
                            <CardContent className="p-8">
                                <div className="flex items-start gap-5">
                                    <div className="p-3 bg-orange-100 rounded-full">
                                        <Shield className="h-7 w-7 text-orange-600" />
                                    </div>
                                    <div>
                                        <h3 className="text-2xl font-semibold mb-2">Peace of Mind with Full Insurance</h3>
                                        <p className="text-gray-600 text-lg">
                                            Your valuable items are fully insured and protected from the moment they are in our care until they are safely in the buyer's hands.
                                        </p>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    </div>
                </div>

                {/* How It Works */}
                <div id="process-section" className="max-w-4xl mx-auto mb-20">
                    <h2 className="text-4xl font-bold text-center mb-12">
                        Your Simple Path to Getting Paid
                    </h2>

                    <div className="relative">
                        <div className="absolute left-1/2 -translate-x-1/2 top-0 bottom-0 w-0.5 bg-gray-200" aria-hidden="true"></div>
                        <div className="space-y-12">
                            <div className="flex items-start gap-8">
                                <div className="flex-shrink-0 w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-2xl z-10">1</div>
                                <div className="flex-1 pt-2">
                                    <h3 className="text-2xl font-semibold mb-2">Initial Consultation</h3>
                                    <p className="text-gray-600 text-lg">Contact Ben to discuss your collection. We'll provide a free, no-obligation assessment and valuation estimate.</p>
                                </div>
                            </div>
                            <div className="flex items-start gap-8">
                                <div className="flex-shrink-0 w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-2xl z-10">2</div>
                                <div className="flex-1 pt-2">
                                    <h3 className="text-2xl font-semibold mb-2">Agree on Your Rate</h3>
                                    <p className="text-gray-600 text-lg">We offer fair, transparent, and flexible commission rates tailored to the value of your items and our partnership.</p>
                                </div>
                            </div>
                            <div className="flex items-start gap-8">
                                <div className="flex-shrink-0 w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-2xl z-10">3</div>
                                <div className="flex-1 pt-2">
                                    <h3 className="text-2xl font-semibold mb-2">We Take Over</h3>
                                    <p className="text-gray-600 text-lg">Sit back as we manage every detail: professional photography, compelling listings, buyer inquiries, and secure shipping.</p>
                                </div>
                            </div>
                            <div className="flex items-start gap-8">
                                <div className="flex-shrink-0 w-16 h-16 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-2xl z-10">4</div>
                                <div className="flex-1 pt-2">
                                    <h3 className="text-2xl font-semibold mb-2">Receive Your Payout</h3>
                                    <p className="text-gray-600 text-lg">Once your item sells, you receive your payout quickly and securely. Simple, transparent, and profitable.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {/* Testimonials Section */}
                <div className="bg-gray-100/70 py-16 mb-20 rounded-xl">
                    <div className="max-w-4xl mx-auto text-center">
                        <h2 className="text-4xl font-bold mb-12">Trusted by Collectors Like You</h2>
                        <div className="grid md:grid-cols-2 gap-8 px-6">
                            <Card className="bg-white">
                                <CardContent className="p-6">
                                    <div className="flex mb-2">
                                        <Star className="text-yellow-400" />
                                        <Star className="text-yellow-400" />
                                        <Star className="text-yellow-400" />
                                        <Star className="text-yellow-400" />
                                        <Star className="text-yellow-400" />
                                    </div>
                                    <p className="text-gray-700 italic mb-4">"The entire process was seamless. I sent my cards in, and Picksy handled the rest. The final sale price exceeded my expectations. Highly recommend for anyone who values their time and privacy."</p>
                                    <p className="font-semibold">- David R., Private Collector</p>
                                </CardContent>
                            </Card>
                             <Card className="bg-white">
                                <CardContent className="p-6">
                                    <div className="flex mb-2">
                                        <Star className="text-yellow-400" />
                                        <Star className="text-yellow-400" />
                                        <Star className="text-yellow-400" />
                                        <Star className="text-yellow-400" />
                                        <Star className="text-yellow-400" />
                                    </div>
                                    <p className="text-gray-700 italic mb-4">"I was nervous about selling my late father's coin collection, but Ben handled it with the utmost professionalism and respect. The communication was excellent, and the results were fantastic."</p>
                                    <p className="font-semibold">- Sarah L., Estate Seller</p>
                                </CardContent>
                            </Card>
                        </div>
                    </div>
                </div>

                {/* FAQ Section */}
                <div className="max-w-3xl mx-auto mb-20">
                    <h2 className="text-4xl font-bold text-center mb-8">Frequently Asked Questions</h2>
                    <Accordion type="single" collapsible className="w-full">
                        <AccordionItem value="item-1">
                            <AccordionTrigger className="text-lg font-medium text-left">How does the valuation process work?</AccordionTrigger>
                            <AccordionContent className="text-base text-gray-600">
                                We start with a free preliminary assessment based on photos and details you provide. If you decide to proceed, you send the items to us for a physical inspection and a final valuation before we list them.
                            </AccordionContent>
                        </AccordionItem>
                        <AccordionItem value="item-2">
                            <AccordionTrigger className="text-lg font-medium text-left">What are your fees?</AccordionTrigger>
                            <AccordionContent className="text-base text-gray-600">
                                Our commission rates are competitive and tiered based on the value of your items. We agree on a transparent rate upfront during the consultation, so there are no surprises or hidden costs.
                            </AccordionContent>
                        </AccordionItem>
                        <AccordionItem value="item-3">
                            <AccordionTrigger className="text-lg font-medium text-left">Is my collection insured?</AccordionTrigger>
                            <AccordionContent className="text-base text-gray-600">
                                Yes, absolutely. From the moment your items arrive at our secure facility until they reach the buyer, they are fully insured against theft, damage, and loss.
                            </AccordionContent>
                        </AccordionItem>
                        <AccordionItem value="item-4">
                            <AccordionTrigger className="text-lg font-medium text-left">How long does it take to get paid?</AccordionTrigger>
                            <AccordionContent className="text-base text-gray-600">
                                Payouts are processed promptly after the sale is finalized and the buyer has received the item, typically within 5-7 business days.
                            </AccordionContent>
                        </AccordionItem>
                        <AccordionItem value="item-5">
                            <AccordionTrigger className="text-lg font-medium text-left">Do you sell internationally?</AccordionTrigger>
                            <AccordionContent className="text-base text-gray-600">
                                Yes! We list your items on global marketplaces to ensure they reach the widest audience of serious collectors, maximizing your final sale price.
                            </AccordionContent>
                        </AccordionItem>
                    </Accordion>
                </div>

                {/* CTA Section */}
                <div id="contact-section" className="relative max-w-6xl mx-auto bg-gradient-to-r from-blue-700 to-indigo-800 text-white rounded-2xl p-8 md:p-12 overflow-hidden">
                    <div className="absolute -top-10 -left-10 w-24 h-24 bg-white/10 rounded-full"></div>
                    <div className="absolute -bottom-12 -right-8 w-32 h-32 bg-white/10 rounded-full"></div>
                    
                    <div className="grid lg:grid-cols-2 gap-12 items-center relative z-10">
                        <div className="text-left">
                            <h2 className="text-4xl md:text-5xl font-bold mb-4">
                                Ready to Unlock the Value of Your Collection?
                            </h2>
                            <p className="text-xl mb-8 text-blue-100">
                                Fill out the form or contact Ben directly for a free, no-obligation consultation.
                            </p>

                            <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6 mb-8 max-w-md">
                                <h3 className="text-2xl font-semibold mb-4">Contact Ben Mackie</h3>
                                <div className="space-y-4">
                                    <a
                                        href="tel:0422225265"
                                        className="flex items-center gap-3 text-lg hover:text-blue-200 transition-colors"
                                    >
                                        <div className="bg-white/20 p-2 rounded-full">
                                            <Phone className="h-5 w-5" />
                                        </div>
                                        <span className="font-mono tracking-wider">0422 225 265</span>
                                    </a>
                                    <a
                                        href="mailto:consign@picksy.au"
                                        className="flex items-center gap-3 text-lg hover:text-blue-200 transition-colors"
                                    >
                                        <div className="bg-white/20 p-2 rounded-full">
                                            <Mail className="h-5 w-5" />
                                        </div>
                                        <span>consign@picksy.au</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div>
                            <ConsignmentForm />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}

================================================================================
FILE: src/app/deals/page.tsx
================================================================================
'use client';

import { useState, useMemo } from 'react';
import { PageHeader } from "@/components/layout/PageHeader";
import ProductGrid from "@/components/products/ProductGrid";
import ProductList from '@/components/products/ProductList';
import ProductViewSwitcher from '@/components/products/ProductViewSwitcher';
import { useCollection, useFirebase, useMemoFirebase } from '@/firebase';
import { collection, query, orderBy, limit } from 'firebase/firestore';
import type { Product } from '@/lib/types';
import ProductGridSkeleton from '@/components/products/ProductGridSkeleton';
import MontageGrid from '@/components/products/MontageGrid';

export default function DealsPage() {
    const [view, setView] = useState<'grid' | 'list' | 'montage'>('grid');
    const { firestore } = useFirebase() || {};

    const productsQuery = useMemoFirebase(() => {
        if (!firestore) return null;
        return query(collection(firestore, "products"), orderBy("createdAt", "desc"), limit(50));
    }, [firestore]);

    const { data: products, isLoading } = useCollection<Product>(productsQuery);

    return (
        <div className="container py-8">
            <div className="flex justify-between items-center mb-8">
                <PageHeader
                    title="Hot Deals"
                    description="Check out the latest sales and special offers from our sellers."
                />
                <ProductViewSwitcher view={view} setView={setView} />
            </div>

            {isLoading ? (
                <ProductGridSkeleton count={8} />
            ) : view === 'grid' ? (
                <ProductGrid products={products || []} />
            ) : view === 'list' ? (
                <ProductList products={products || []} />
            ) : (
                <MontageGrid products={products || []} />
            )}
        </div>
    );
}

================================================================================
FILE: src/app/dmca/page.tsx
================================================================================

import { PageHeader } from "@/components/layout/PageHeader";

export default function DMCAPage() {
  return (
    <div className="container py-12 md:py-16">
      <PageHeader
        title="DMCA Takedown Policy"
        description="Our policy for handling copyright infringement claims."
      />
      <div className="prose lg:prose-lg max-w-4xl mx-auto mt-8">
        <h2>1. Introduction</h2>
        <p>
          Picksy Marketplace respects the intellectual property rights of others
          and expects its users to do the same. In accordance with the Digital
          Millennium Copyright Act (DMCA), we will respond expeditiously to
          claims of copyright infringement committed using the Picksy service
          that are reported to our Designated Copyright Agent.
        </p>
        
        <h2>2. Reporting Claims of Copyright Infringement</h2>
        <p>
          If you are a copyright owner, or are authorized to act on behalf of
          one, please report alleged copyright infringements taking place on or
          through the Site by completing the following DMCA Notice of Alleged
          Infringement and delivering it to our Designated Copyright Agent.
        </p>
        <p>
          Your notice must include:
        </p>
        <ul>
            <li>A physical or electronic signature of a person authorized to act on behalf of the owner of an exclusive right that is allegedly infringed.</li>
            <li>Identification of the copyrighted work claimed to have been infringed.</li>
            <li>Identification of the material that is claimed to be infringing or to be the subject of infringing activity and that is to be removed or access to which is to be disabled.</li>
            <li>Information reasonably sufficient to permit us to contact you, such as an address, telephone number, and, if available, an email address.</li>
            <li>A statement that you have a good faith belief that use of the material in the manner complained of is not authorized by the copyright owner, its agent, or the law.</li>
            <li>A statement that the information in the notification is accurate, and under penalty of perjury, that you are authorized to act on behalf of the owner of an exclusive right that is allegedly infringed.</li>
        </ul>
        <p>
            Deliver this notice, with all items completed, to Picksy's Designated Copyright Agent at legal@picksy.com.
        </p>

        <h2>3. Counter-Notification Procedures</h2>
        <p>
          If you believe that your material has been removed or disabled by mistake or misidentification, you may file a counter-notification with us by submitting a written notification to our copyright agent.
        </p>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/donate/page.tsx
================================================================================


"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { useState } from "react";
import { useRouter } from "next/navigation";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { useToast } from "@/hooks/use-toast";
import { createDonation } from "@/lib/firebase/client-ops";
import { Gift, Package, Send } from "lucide-react";
import { Loader2 } from "lucide-react";

const donationFormSchema = z.object({
  fullName: z.string().min(2, { message: "Full name is required." }),
  email: z.string().email({ message: "A valid email is required." }),
  donationType: z.enum(["Cards", "Coins", "Mixed Collectibles"]),
  description: z
    .string()
    .min(10, { message: "Please provide a brief description." }),
  quantity: z
    .string()
    .min(1, { message: "Please estimate the quantity." }),
});

type DonationFormValues = z.infer<typeof donationFormSchema>;

export default function DonatePage() {
  const { toast } = useToast();
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<DonationFormValues>({
    resolver: zodResolver(donationFormSchema),
    defaultValues: {
      fullName: "",
      email: "",
      donationType: "Cards",
      description: "",
      quantity: "",
    },
  });

  async function onSubmit(values: DonationFormValues) {
    setIsLoading(true);
    try {
      await createDonation(values);
      toast({
        title: "Donation Submitted!",
        description:
          "Thank you for your generosity! Please check your email for the shipping label.",
      });
      form.reset();
      router.push("/");
    } catch (error: any) {
      toast({
        title: "Submission Failed",
        description: error.message || "Could not submit your donation.",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <div className="container py-12 md:py-16">
      <section className="text-center mb-12">
        <h1 className="text-4xl font-bold tracking-tight text-primary font-headline sm:text-5xl md:text-6xl">
          Picksy Presents
        </h1>
        <p className="mt-6 text-lg max-w-3xl mx-auto text-muted-foreground">
          Give the gift of collecting. Donate your spare cards and coins to the
          'Picksy Presents' program. We partner with children's hospitals across
          Australia to bring joy to kids who need it most.
        </p>
      </section>

      <section className="mb-12">
        <h2 className="text-3xl font-bold text-center mb-8 font-headline">
          How It Works
        </h2>
        <div className="grid md:grid-cols-3 gap-8 text-center">
          <div className="flex flex-col items-center">
            <div className="bg-primary/10 p-6 rounded-full mb-4">
              <Gift className="h-10 w-10 text-primary" />
            </div>
            <h3 className="text-xl font-semibold mb-2">
              1. Tell Us What You're Sending
            </h3>
            <p className="text-muted-foreground">
              Fill out the simple donation form below.
            </p>
          </div>
          <div className="flex flex-col items-center">
            <div className="bg-primary/10 p-6 rounded-full mb-4">
              <Package className="h-10 w-10 text-primary" />
            </div>
            <h3 className="text-xl font-semibold mb-2">
              2. We Handle the Shipping
            </h3>
            <p className="text-muted-foreground">
              We'll instantly email you a prepaid Australia Post shipping
              label.
            </p>
          </div>
          <div className="flex flex-col items-center">
            <div className="bg-primary/10 p-6 rounded-full mb-4">
              <Send className="h-10 w-10 text-primary" />
            </div>
            <h3 className="text-xl font-semibold mb-2">
              3. You Make a Difference
            </h3>
            <p className="text-muted-foreground">
              Your donation is received, sorted, and delivered to our hospital partners.
            </p>
          </div>
        </div>
      </section>

      <section className="max-w-2xl mx-auto">
        <h2 className="text-3xl font-bold text-center mb-8 font-headline">
          Donation Form
        </h2>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            <div className="grid sm:grid-cols-2 gap-6">
              <FormField
                control={form.control}
                name="fullName"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Full Name</FormLabel>
                    <FormControl>
                      <Input placeholder="John Smith" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="email"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Email</FormLabel>
                    <FormControl>
                      <Input
                        type="email"
                        placeholder="you@example.com"
                        {...field}
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
            <div className="grid sm:grid-cols-2 gap-6">
              <FormField
                control={form.control}
                name="donationType"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Donation Type</FormLabel>
                    <Select
                      onValueChange={field.onChange}
                      defaultValue={field.value}
                    >
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Select what you're donating" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="Cards">Cards</SelectItem>
                        <SelectItem value="Coins">Coins</SelectItem>
                        <SelectItem value="Mixed Collectibles">
                          Mixed Collectibles
                        </SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="quantity"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Estimated Quantity</FormLabel>
                    <FormControl>
                      <Input placeholder="e.g., Approx. 100 cards" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
            <FormField
              control={form.control}
              name="description"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Brief Description of Items</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="e.g., A mix of basketball cards from the 90s."
                      rows={4}
                      {...field}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <Button
              type="submit"
              size="lg"
              className="w-full"
              disabled={isLoading}
            >
              {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Submit Donation
            </Button>
          </form>
        </Form>
      </section>
    </div>
  );
}

================================================================================
FILE: src/app/error.tsx
================================================================================
'use client';

import { useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { AlertTriangle, RefreshCcw, Home } from 'lucide-react';
import Link from 'next/link';

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    // Log the error to an error reporting service
    console.error('Global Application Error:', error);
  }, [error]);

  return (
    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
      <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 text-center space-y-6">
        <div className="bg-rose-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto">
          <AlertTriangle className="h-8 w-8 text-rose-600" />
        </div>
        
        <div className="space-y-2">
          <h2 className="text-2xl font-black text-slate-900">Something went wrong!</h2>
          <p className="text-slate-500">
            We encountered an unexpected error. Our team has been notified.
          </p>
          {error.digest && (
            <div className="bg-slate-100 p-2 rounded text-xs font-mono text-slate-500 mt-2 break-all">
              Error ID: {error.digest}
            </div>
          )}
        </div>

        <div className="flex flex-col sm:flex-row gap-3 justify-center pt-2">
          <Button 
            onClick={() => reset()} 
            variant="default"
            className="flex items-center gap-2"
          >
            <RefreshCcw className="h-4 w-4" />
            Try Again
          </Button>
          <Button 
            asChild 
            variant="outline"
            className="flex items-center gap-2"
          >
            <Link href="/">
              <Home className="h-4 w-4" />
              Go Home
            </Link>
          </Button>
        </div>
      </div>
    </div>
  );
}
================================================================================
FILE: src/app/general/page.tsx
================================================================================

'use client';
import { Suspense } from 'react';
import { PageHeader } from "@/components/layout/PageHeader";
import MontageGrid from "@/components/products/MontageGrid";
import ProductGridSkeleton from '@/components/products/ProductGridSkeleton';
import { Product } from '@/lib/types';
import { useCollection, useFirebase, useMemoFirebase } from '@/firebase';
import { collection, query, where, orderBy, limit } from 'firebase/firestore';

export default function GeneralPage() {
    const { firestore } = useFirebase();

    const productsQuery = useMemoFirebase(() => {
        if (!firestore) return null;
        return query(
            collection(firestore, 'products'),
            where('category', '==', 'General'),
            orderBy('createdAt', 'desc'),
            limit(100)
        );
    }, [firestore]);

    const { data: products, isLoading } = useCollection<Product>(productsQuery);

    return (
        <div className="min-h-screen">
            <div className="container mx-auto px-4 py-8">
                <PageHeader
                    title="General Listings"
                    description="Everything else. Second-hand treasures and general items."
                />
            </div>
            <Suspense fallback={<div className="container mx-auto px-4"><ProductGridSkeleton count={20} /></div>}>
                {isLoading ? <div className="container mx-auto px-4"><ProductGridSkeleton count={20} /></div> : <MontageGrid products={products || []} />}
            </Suspense>
        </div>
    );
}

================================================================================
FILE: src/app/global-error.tsx
================================================================================
'use client';

import { useEffect } from 'react';
import { Button } from '@/components/ui/button';

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    // In a real application, you would log the error to a service like Sentry,
    // LogRocket, or another error tracking service.
    console.error('Global Error Boundary Caught:', error);
  }, [error]);

  return (
    <html>
      <body>
        <div className="flex min-h-screen flex-col items-center justify-center bg-background text-center p-4">
          <h1 className="text-4xl font-bold mb-4">Something went wrong</h1>
          <p className="text-muted-foreground mb-8 max-w-lg">
            We apologize for the inconvenience. The application encountered an unexpected error. Our team has been notified.
          </p>
          <Button onClick={() => reset()} variant="default">
            Try again
          </Button>
        </div>
      </body>
    </html>
  );
}

================================================================================
FILE: src/app/globals.css
================================================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 240 6% 97%;
    --foreground: 222.2 84% 4.9%;
    --card: 0 0% 100%;
    --card-foreground: 222.2 84% 4.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 222.2 84% 4.9%;
    --primary: 222.8 85.5% 53.1%;
    --primary-foreground: 210 40% 98%;
    --secondary: 210 40% 96.1%;
    --secondary-foreground: 222.2 47.4% 11.2%;
    --muted: 210 40% 96.1%;
    --muted-foreground: 215.4 16.3% 46.9%;
    --accent: 346.8 77.2% 49.8%;
    --accent-foreground: 210 40% 98%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 210 40% 98%;
    --border: 214.3 31.8% 91.4%;
    --input: 214.3 31.8% 91.4%;
    --ring: 222.8 85.5% 53.1%;
    --radius: 0.75rem;
  }

  .dark {
    --background: 224 24% 11%;
    --foreground: 210 40% 98%;
    --card: 224 23% 15%;
    --card-foreground: 210 40% 98%;
    --popover: 222.2 84% 4.9%;
    --popover-foreground: 210 40% 98%;
    --primary: 222.8 85.5% 53.1%;
    --primary-foreground: 210 40% 98%;
    --secondary: 217.2 32.6% 17.5%;
    --secondary-foreground: 210 40% 98%;
    --muted: 217.2 32.6% 17.5%;
    --muted-foreground: 215 20.2% 65.1%;
    --accent: 346.8 77.2% 49.8%;
    --accent-foreground: 210 40% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 210 40% 98%;
    --border: 217.2 32.6% 17.5%;
    --input: 217.2 32.6% 17.5%;
    --ring: 221.2 83.2% 58%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
    font-feature-settings: "rlig" 1, "calt" 1;
  }
  ::selection {
    @apply bg-primary/20 text-primary;
  }
}

@layer utilities {
  .glass-card {
    @apply bg-card/60 backdrop-blur-lg border border-border/20;
  }
  .glass-nav {
    @apply bg-background/80 backdrop-blur-lg border-b border-border/20;
  }
  .gradient-text {
    @apply bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent;
  }
   .shimmer {
    @apply bg-gradient-to-r from-transparent via-primary/10 to-transparent;
    animation: shimmer 2s infinite;
    background-size: 200% 100%;
  }

  @keyframes shimmer {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }
}

================================================================================
FILE: src/app/how-it-works/page.tsx
================================================================================

import { PageHeader } from "@/components/layout/PageHeader";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Search, ShoppingCart, Shield, Upload, DollarSign, Package } from "lucide-react";

const forBuyers = [
  {
    icon: <Search className="h-8 w-8 text-primary" />,
    title: "Discover & Find",
    description: "Use our powerful search and filtering tools to browse thousands of collectibles from sellers across Australia."
  },
  {
    icon: <ShoppingCart className="h-8 w-8 text-primary" />,
    title: "Purchase Securely",
    description: "Add items to your cart and check out with confidence. Your payment is held securely until you confirm receipt of your item."
  },
  {
    icon: <Shield className="h-8 w-8 text-primary" />,
    title: "Receive & Verify",
    description: "For high-value items, use our optional Picksy Vault service for third-party verification and secure storage."
  }
];

const forSellers = [
  {
    icon: <Upload className="h-8 w-8 text-primary" />,
    title: "List Your Items",
    description: "Easily create listings with our AI-powered tools that help you write descriptions, suggest prices, and grade your cards."
  },
  {
    icon: <Package className="h-8 w-8 text-primary" />,
    title: "Ship to Buyer",
    description: "Once an item is sold, ship it directly to the buyer or to the Picksy Vault for verification, depending on the transaction type."
  },
  {
    icon: <DollarSign className="h-8 w-8 text-primary" />,
    title: "Get Paid Fast",
    description: "Payment is released to you as soon as the buyer confirms receipt or the item is verified by our Vault service."
  }
];

export default function HowItWorksPage() {
  return (
    <div className="bg-gray-50/50">
      <div className="container py-12 md:py-16">
        <PageHeader
          title="How Picksy Works"
          description="A simple, secure, and modern marketplace for Australian collectors."
        />

        <div className="mt-16">
          <h2 className="text-3xl font-bold text-center mb-12 font-headline">For Buyers</h2>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            {forBuyers.map((item) => (
              <Card key={item.title} className="text-center">
                <CardHeader>
                  <div className="mx-auto bg-primary/10 p-4 rounded-full w-fit mb-2">
                    {item.icon}
                  </div>
                  <CardTitle>{item.title}</CardTitle>
                </CardHeader>
                <CardContent>
                  <p className="text-sm text-muted-foreground">{item.description}</p>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>

        <div className="mt-24">
          <h2 className="text-3xl font-bold text-center mb-12 font-headline">For Sellers</h2>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            {forSellers.map((item) => (
              <Card key={item.title} className="text-center">
                <CardHeader>
                  <div className="mx-auto bg-primary/10 p-4 rounded-full w-fit mb-2">
                    {item.icon}
                  </div>
                  <CardTitle>{item.title}</CardTitle>
                </CardHeader>
                <CardContent>
                  <p className="text-sm text-muted-foreground">{item.description}</p>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>

      </div>
    </div>
  );
}

================================================================================
FILE: src/app/layout.tsx
================================================================================

import type { Metadata } from 'next';
import { Toaster } from "@/components/ui/toaster";
import "./globals.css";
import { CartProvider } from "@/context/CartContext";
import { CartDrawer } from "@/components/cart/CartDrawer";
import { ViewedProductsProvider } from "@/context/ViewedProductsContext";
import Header from '@/components/layout/Header';
import Footer from '@/components/layout/Footer';
import { FirebaseProvider } from '@/firebase/provider';
import { GoogleAnalytics } from '@/components/analytics/GoogleAnalytics';
import { SidebarProvider } from '@/components/layout/sidebar-provider';
import { Inter } from 'next/font/google';

const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-inter',
});

// SITE_URL must be set in production environment variables.
const SITE_URL = process.env.NEXT_PUBLIC_SITE_URL || 'https://studio-8322868971-8ca89.web.app';

export const metadata: Metadata = {
  metadataBase: new URL(SITE_URL),
  title: {
    default: 'Picksy | The AI-Powered Collectibles Marketplace',
    template: '%s | Picksy',
  },
  description: 'Buy, sell, and trade cards, coins, and comics with AI-assisted pricing and verification. Australia\'s premier collectibles marketplace.',
  other: {
    'geo.region': 'AU',
    'geo.placename': 'Australia',
  },
  openGraph: {
    type: 'website',
    locale: 'en_AU',
    url: '/',
    siteName: 'Picksy',
    images: [{ url: '/og-image.jpg', width: 1200, height: 630 }],
  },
  twitter: {
    card: "summary_large_image",
    title: "Picksy - Australia's Premier Collectibles Marketplace",
    description: "Discover unique collectibles, vintage items, trading cards, and coins. Australian marketplace with local shipping only.",
    images: [`${SITE_URL}/og-image.jpg`],
  },
  robots: {
    index: true,
    follow: true,
    googleBot: {
      index: true,
      follow: true,
      'max-video-preview': -1,
      'max-image-preview': 'large',
      'max-snippet': -1,
    },
  },
};

import { ErrorBoundary } from '@/components/ErrorBoundary';

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en-AU" suppressHydrationWarning data-scroll-behavior="smooth" className={`${inter.variable}`}>
      <body className="font-body antialiased overflow-x-hidden" suppressHydrationWarning>
        <script
          type="application/ld+json"
          dangerouslySetInnerHTML={{
            __html: JSON.stringify({
              '@context': 'https://schema.org',
              '@type': 'Organization',
              name: 'Picksy',
              description: 'Australia\'s premier collectibles marketplace',
              url: SITE_URL,
              logo: `${SITE_URL}/logo.png`,
              areaServed: {
                '@type': 'Country',
                name: 'Australia',
              },
              shippingDestination: {
                '@type': 'DefinedRegion',
                addressCountry: 'AU',
              },
            }),
          }}
        />
        <ErrorBoundary>
          <FirebaseProvider>
            <SidebarProvider>
              <CartProvider>
                <ViewedProductsProvider>
                  <GoogleAnalytics />
                  <Header />
                  <main className="min-h-screen">
                    {children}
                  </main>
                  <Footer />
                  <CartDrawer />
                </ViewedProductsProvider>
              </CartProvider>
            </SidebarProvider>
          </FirebaseProvider>
          <Toaster />
        </ErrorBoundary>
      </body>
    </html>
  );
}

================================================================================
FILE: src/app/log/page.tsx
================================================================================

import { Suspense } from 'react';
import SignInForm from '@/components/auth/SignInForm';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';

export default function LogPage() {
    return (
        <div className="min-h-screen flex justify-center bg-gray-50 p-4 pt-12">
            <Card className="w-full max-w-md p-6 shadow-xl border-t-4 border-primary h-fit">
                <CardHeader className="text-center">
                    <CardTitle className="text-3xl font-bold font-headline">Welcome Back</CardTitle>
                    <CardDescription>Sign in to access your Picksy account</CardDescription>
                </CardHeader>
                <CardContent>
                    <Suspense fallback={<div>Loading...</div>}>
                        <SignInForm />
                    </Suspense>
                </CardContent>
            </Card>
        </div>
    );
}

================================================================================
FILE: src/app/messages/[[...id]]/page.tsx
================================================================================

'use client';

import { useEffect, useState, useRef } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { useUser } from '@/firebase';
import { db } from '@/lib/firebase/config';
import {
  collection,
  query,
  where,
  onSnapshot,
  orderBy,
  addDoc,
  serverTimestamp,
  doc,
  getDoc,
  updateDoc,
  getDocs,
} from 'firebase/firestore';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  Send,
  MessageSquare,
  ArrowLeft,
  Loader2,
  Package,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import Link from 'next/link';
import Image from 'next/image';
import { formatDistanceToNow } from 'date-fns';

type Participant = {
  displayName: string;
  photoURL: string;
};

type Conversation = {
  id: string;
  participantIds: string[];
  participants: Record<string, Participant>;
  lastMessage: {
    text: string;
    timestamp: any;
    senderId: string;
  };
  productContext?: {
    id: string;
    title: string;
    imageUrl: string;
  };
};

type Message = {
  id: string;
  senderId: string;
  text: string;
  timestamp: any;
};

function ConversationList({
  conversations,
  currentConversationId,
}: {
  conversations: Conversation[];
  currentConversationId: string | null;
}) {
  const { user } = useUser();
  
  return (
    <div
      className={cn(
        'w-full md:w-1/3 lg:w-1/4 border-r bg-gray-50 flex-col',
        currentConversationId ? 'hidden md:flex' : 'flex'
      )}
    >
      <div className="p-4 border-b">
        <h2 className="text-2xl font-bold">Messages</h2>
      </div>
      <ScrollArea className="flex-1">
        {conversations.length === 0 ? (
            <div className="text-center p-8 text-gray-500">
                <MessageSquare className="h-12 w-12 mx-auto mb-4 text-gray-300" />
                No conversations yet.
            </div>
        ) : (
            conversations.map((convo) => {
                const otherParticipantId = convo.participantIds.find(id => id !== user?.uid)!;
                const otherParticipant = convo.participants[otherParticipantId];
                return (
                    <Link href={`/messages/${convo.id}`} key={convo.id}>
                        <div
                        className={cn(
                            'p-4 flex items-start gap-4 cursor-pointer border-b hover:bg-gray-100',
                            convo.id === currentConversationId && 'bg-primary/5'
                        )}
                        >
                            <Avatar>
                                <AvatarImage src={otherParticipant?.photoURL} />
                                <AvatarFallback>{otherParticipant?.displayName?.[0]}</AvatarFallback>
                            </Avatar>
                            <div className="flex-1 overflow-hidden">
                                <div className="flex items-center justify-between">
                                    <h3 className="font-semibold truncate">{otherParticipant?.displayName}</h3>
                                    <span className="text-xs text-gray-400 flex-shrink-0">
                                        {convo.lastMessage.timestamp && formatDistanceToNow(convo.lastMessage.timestamp.toDate(), { addSuffix: true })}
                                    </span>
                                </div>
                                <p className="text-sm text-gray-500 truncate mt-1">
                                    {convo.lastMessage.senderId === user?.uid && 'You: '}
                                    {convo.lastMessage.text}
                                </p>
                                {convo.productContext && (
                                    <div className="text-xs text-muted-foreground truncate mt-1 italic">
                                        re: {convo.productContext.title}
                                    </div>
                                )}
                            </div>
                        </div>
                    </Link>
                );
            })
        )}
      </ScrollArea>
    </div>
  );
}

function ConversationView({ conversationId }: { conversationId: string }) {
  const { user } = useUser();
  const [messages, setMessages] = useState<Message[]>([]);
  const [newMessage, setNewMessage] = useState('');
  const [conversation, setConversation] = useState<Conversation | null>(null);
  const router = useRouter();
  const messagesEndRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  useEffect(() => {
    if (!conversationId) return;

    // Fetch conversation details
    const convoUnsub = onSnapshot(doc(db, 'conversations', conversationId), (doc) => {
        if(doc.exists()) {
            setConversation({ id: doc.id, ...doc.data() } as Conversation);
        }
    });

    // Fetch messages
    const q = query(
      collection(db, 'conversations', conversationId, 'messages'),
      orderBy('timestamp', 'asc')
    );
    const messagesUnsub = onSnapshot(q, (snapshot) => {
      const msgs = snapshot.docs.map(
        (doc) => ({ id: doc.id, ...doc.data() } as Message)
      );
      setMessages(msgs);
    });

    return () => {
      convoUnsub();
      messagesUnsub();
    };
  }, [conversationId]);

  const handleSendMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newMessage.trim() || !user || !conversationId) return;

    const messageText = newMessage;
    setNewMessage('');

    const messageData = {
      senderId: user.uid,
      text: messageText,
      timestamp: serverTimestamp(),
    };
    
    await addDoc(collection(db, 'conversations', conversationId, 'messages'), messageData);
    
    // Update last message in conversation
    const convoRef = doc(db, 'conversations', conversationId);
    await updateDoc(convoRef, {
        lastMessage: {
            text: messageText,
            senderId: user.uid,
            timestamp: serverTimestamp(),
        }
    });

  };

  if (!conversation) {
    return (
        <div className="flex-1 flex items-center justify-center text-center p-8">
            <Loader2 className="h-8 w-8 animate-spin" />
        </div>
    )
  }
  
  const otherParticipantId = conversation.participantIds.find(id => id !== user?.uid)!;
  const otherParticipant = conversation.participants[otherParticipantId];

  return (
    <div className="flex-1 flex flex-col h-full">
      {/* Header */}
      <div className="p-4 border-b flex items-center gap-4">
        <Button variant="ghost" size="icon" className="md:hidden" onClick={() => router.push('/messages')}>
            <ArrowLeft />
        </Button>
        <Avatar>
          <AvatarImage src={otherParticipant.photoURL} />
          <AvatarFallback>{otherParticipant.displayName[0]}</AvatarFallback>
        </Avatar>
        <div>
          <h3 className="font-semibold">{otherParticipant.displayName}</h3>
        </div>
      </div>

      {conversation.productContext && (
        <div className="p-3 border-b bg-gray-50">
            <Link href={`/product/${conversation.productContext.id}`} className="flex items-center gap-3 hover:bg-gray-100 p-2 rounded-lg">
                <div className="relative w-12 h-12 rounded-md overflow-hidden bg-muted flex-shrink-0">
                    <Image src={conversation.productContext.imageUrl} alt={conversation.productContext.title} fill className="object-cover" />
                </div>
                <div className="flex-1">
                    <p className="text-sm font-semibold line-clamp-1">{conversation.productContext.title}</p>
                    <p className="text-xs text-primary">View Item</p>
                </div>
            </Link>
        </div>
      )}

      {/* Messages */}
      <ScrollArea className="flex-1 p-4">
        <div className="space-y-4">
          {messages.map((message) => (
            <div
              key={message.id}
              className={cn(
                'flex gap-2',
                message.senderId === user?.uid ? 'justify-end' : 'justify-start'
              )}
            >
              <div
                className={cn(
                  'p-3 rounded-lg max-w-xs md:max-w-md',
                  message.senderId === user?.uid
                    ? 'bg-primary text-primary-foreground'
                    : 'bg-muted'
                )}
              >
                {message.text}
              </div>
            </div>
          ))}
          <div ref={messagesEndRef} />
        </div>
      </ScrollArea>

      {/* Input */}
      <div className="p-4 border-t bg-background">
        <form onSubmit={handleSendMessage} className="flex gap-4">
          <Input
            value={newMessage}
            onChange={(e) => setNewMessage(e.target.value)}
            placeholder="Type a message..."
            autoComplete="off"
          />
          <Button type="submit" size="icon" disabled={!newMessage.trim()}>
            <Send />
          </Button>
        </form>
      </div>
    </div>
  );
}


export default function MessagesPage() {
  const { user } = useUser();
  const pathname = usePathname();
  const conversationId = pathname.split('/')[2] || null;

  const [conversations, setConversations] = useState<Conversation[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user?.uid) return;

    setTimeout(() => {
      setLoading(true);
    }, 0);
    const q = query(
      collection(db, 'conversations'),
      where('participantIds', 'array-contains', user.uid),
      orderBy('lastMessage.timestamp', 'desc')
    );

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const convos = snapshot.docs.map(
        (doc) => ({ id: doc.id, ...doc.data() } as Conversation)
      );
      setConversations(convos);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user?.uid]);

  if(loading) {
      return (
        <div className="w-full flex items-center justify-center">
            <Loader2 className="h-12 w-12 animate-spin" />
        </div>
      )
  }

  return (
    <>
      <ConversationList conversations={conversations} currentConversationId={conversationId} />
      <div className={cn(
        'flex-1 flex-col',
        conversationId ? 'flex' : 'hidden md:flex'
      )}>
        {conversationId ? (
            <ConversationView conversationId={conversationId} />
        ) : (
            <div className="flex-1 flex items-center justify-center text-center p-8">
                <div className="text-gray-500">
                    <MessageSquare className="h-16 w-16 mx-auto mb-4 text-gray-300" />
                    <h2 className="text-xl font-semibold">Select a conversation</h2>
                    <p>Or start a new one from a product page.</p>
                </div>
            </div>
        )}
      </div>
    </>
  );
}

================================================================================
FILE: src/app/messages/layout.tsx
================================================================================

'use client';

import { useUser } from '@/firebase';
import { useRouter } from 'next/navigation';
import { Loader2 } from 'lucide-react';
import { ReactNode } from 'react';

export default function MessagesLayout({ children }: { children: ReactNode }) {
  const { user, isUserLoading } = useUser();
  const router = useRouter();

  if (isUserLoading) {
    return (
      <div className="flex h-screen items-center justify-center">
        <Loader2 className="h-12 w-12 animate-spin" />
      </div>
    );
  }

  if (!user) {
    router.push('/sign-in?redirect=/messages');
    return (
      <div className="flex h-screen items-center justify-center">
        <p>Redirecting to sign-in...</p>
      </div>
    );
  }

  return (
    <div className="h-[calc(100vh-65px)] w-full flex bg-background border-t">
      {children}
    </div>
  );
}

================================================================================
FILE: src/app/not-found.tsx
================================================================================

'use client';

import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardDescription, CardFooter } from '@/components/ui/card';
import { AlertTriangle } from 'lucide-react';

export const dynamic = 'force-dynamic';

function NotFoundContent() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
      <Card className="w-full max-w-md text-center shadow-xl border-t-4 border-destructive">
        <CardHeader className="p-8">
          <div className="mx-auto bg-destructive/10 p-4 rounded-full w-fit">
            <AlertTriangle className="h-10 w-10 text-destructive" />
          </div>
          <CardTitle className="mt-4 text-3xl font-bold font-headline">404 - Page Not Found</CardTitle>
          <CardDescription className="mt-2">
            The page you are looking for might have been removed, had its name changed, or is temporarily unavailable.
          </CardDescription>
        </CardHeader>
        <CardFooter className="p-8 pt-0">
          <Button asChild className="w-full" size="lg">
            <Link href="/">Return to Homepage</Link>
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

export default function NotFound() {
  return <NotFoundContent />;
}

================================================================================
FILE: src/app/page.tsx
================================================================================
'use client';
import Hero from "@/components/home/Hero";
import { Suspense, useState, useEffect } from "react";
import { fetchProductCount } from "@/app/actions/stats";
import { SearchBar } from "@/components/layout/search-bar";
import FeaturedCategories from "@/components/home/FeaturedCategories";

export default function HomePage() {
  const [productCount, setProductCount] = useState<number | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function fetchStats() {
      try {
        const count = await fetchProductCount();
        setProductCount(count);
      } catch (e: any) {
        console.error("Homepage stats error:", e);
        setError("Could not load marketplace stats.");
      }
    }
    fetchStats();
  }, []);

  return (
    <main>
      <Hero productCount={productCount} error={error} />
      <Suspense>
        <FeaturedCategories />
      </Suspense>
      <div className="max-w-[1440px] mx-auto px-4 md:px-10">
        <div className="py-16 border-t border-[#e7ebf3] dark:border-white/10">
          <div className="max-w-2xl mx-auto text-center space-y-6">
            <h2 className="text-3xl font-black">Can't find your grail?</h2>
            <p className="text-gray-500 dark:text-gray-400">Describe what you're looking for, and our AI will scour global private collections and upcoming auctions.</p>
            <SearchBar className="relative flex items-center h-16" inputClassName="h-16 text-base pl-6 pr-32 rounded-2xl shadow-lg" buttonClassName="absolute right-3 h-10 px-6 rounded-xl" />
          </div>
        </div>
      </div>
    </main>
  );
}

================================================================================
FILE: src/app/privacy/page.tsx
================================================================================

import { PageHeader } from "@/components/layout/PageHeader";

export default function PrivacyPage() {
  return (
    <div className="container py-12 md:py-16">
      <PageHeader
        title="Privacy Policy"
        description="Last Updated: October 26, 2023"
      />
      <div className="prose lg:prose-lg max-w-4xl mx-auto mt-8">
        <p>
          This Privacy Policy describes Our policies and procedures on the collection,
          use and disclosure of Your information when You use the Service and tells
          You about Your privacy rights and how the law protects You.
        </p>
        <p>
          We use Your Personal data to provide and improve the Service. By using the
          Service, You agree to the collection and use of information in accordance
          with this Privacy Policy.
        </p>

        <h2>Interpretation and Definitions</h2>
        <h3>Interpretation</h3>
        <p>
          The words of which the initial letter is capitalized have meanings
          defined under the following conditions. The following definitions shall
          have the same meaning regardless of whether they appear in singular or in
          plural.
        </p>

        <h2>Collecting and Using Your Personal Data</h2>
        <h3>Types of Data Collected</h3>
        <h4>Personal Data</h4>
        <p>
          While using Our Service, We may ask You to provide Us with certain
          personally identifiable information that can be used to contact or
          identify You. Personally identifiable information may include, but is not
          limited to: Email address, First name and last name, Phone number,
          Address, State, Province, ZIP/Postal code, City, Usage Data.
        </p>
        <h4>Usage Data</h4>
        <p>
          Usage Data is collected automatically when using the Service. Usage Data
          may include information such as Your Device's Internet Protocol address
          (e.g. IP address), browser type, browser version, the pages of our
          Service that You visit, the time and date of Your visit, the time spent
          on those pages, unique device identifiers and other diagnostic data.
        </p>

        <h2>Use of Your Personal Data</h2>
        <p>The Company may use Personal Data for the following purposes:</p>
        <ul>
          <li>To provide and maintain our Service, including to monitor the usage of our Service.</li>
          <li>To manage Your Account: to manage Your registration as a user of the Service.</li>
          <li>For the performance of a contract: the development, compliance and undertaking of the purchase contract for the products, items or services You have purchased or of any other contract with Us through the Service.</li>
          <li>To contact You: To contact You by email, telephone calls, SMS, or other equivalent forms of electronic communication.</li>
        </ul>

        <h2>Contact Us</h2>
        <p>
          If you have any questions about this Privacy Policy, You can contact us:
          By email: legal@picksy.com
        </p>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/product/[id]/ProductDetailsClient.tsx
================================================================================

'use client';

import { useState, useEffect, useCallback, useMemo, Suspense, useRef } from 'react';
import { notFound, useRouter } from 'next/navigation';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Skeleton } from '@/components/ui/skeleton';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { useToast } from '@/hooks/use-toast';
import {
    Share2,
    Heart,
    Star,
    ShieldCheck,
    CheckCircle,
    AlertCircle,
    ChevronLeft,
    MessageSquare,
    Eye,
    Calendar,
    ShoppingCart,
    CreditCard,
    Loader2,
    Copyright,
    ChevronRight,
    Hash
} from 'lucide-react';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { cn } from '@/lib/utils';
import { db } from '@/lib/firebase/config';
import { doc, collection, query, where, getDocs, limit, addDoc, serverTimestamp, deleteDoc, setDoc, orderBy, updateDoc, increment, arrayUnion, Timestamp } from 'firebase/firestore';
import { useCart } from '@/context/CartContext';
import type { Product, Review } from '@/lib/types';
import type { UserProfile } from '@/lib/types';
import { useViewedProducts } from '@/context/ViewedProductsContext';
import { useUser, useCollection, useMemoFirebase, useDoc } from '@/firebase';
import ReviewForm from '@/components/reviews/ReviewForm';
import ReviewList from '@/components/reviews/ReviewList';
import { placeBid, acceptBid } from '@/services/bidding';
import { deleteProductByAdmin } from '@/app/actions/admin';
import { createProductAction, recordProductView } from '@/app/actions/products';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';
import { Trash2, DollarSign } from 'lucide-react';
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import ProductGrid from '@/components/products/ProductGrid';
import ProductGridSkeleton from '@/components/products/ProductGridSkeleton';
import { BiddingInterface } from '@/components/products/BiddingInterface';
import ProductImageGallery from '@/components/products/ProductImageGallery';
import { SUPER_ADMIN_EMAILS, SUPER_ADMIN_UIDS } from '@/lib/constants';

export default function ProductDetailsClient({
    productId,
    initialProduct,
    initialSeller,
    initialReviews
}: {
    productId: string;
    initialProduct: Product;
    initialSeller: UserProfile | null;
    initialReviews: Review[];
}) {
    const router = useRouter();
    const { toast } = useToast();
    const { user, isUserLoading } = useUser();
    const { addItem } = useCart();
    const { markAsViewed } = useViewedProducts();

    const [relatedProducts, setRelatedProducts] = useState<Product[]>([]);
    const [loadingRelated, setLoadingRelated] = useState(true);
    const [isDeleting, setIsDeleting] = useState(false);
    const viewRecordedRef = useRef<string | null>(null);

    // Super admin check
    const isSuperAdmin = (user?.uid && SUPER_ADMIN_UIDS.includes(user.uid)) || (user?.email && SUPER_ADMIN_EMAILS.includes(user.email));

    const productRef = useMemoFirebase(() => doc(db, 'products', productId), [productId]);
    const { data: product, isLoading: isProductLoading, error: productError } = useDoc<Product>(productRef, {
        initialData: initialProduct,
    });

    const sellerRef = useMemoFirebase(() => product?.sellerId ? doc(db, 'users', product.sellerId) : null, [product?.sellerId]);
    const { data: seller, isLoading: isSellerLoading } = useDoc<UserProfile>(sellerRef, { initialData: initialSeller });

    const reviewsQuery = useMemoFirebase(() =>
        query(
            collection(db, 'reviews'),
            where('productId', '==', productId),
            orderBy('createdAt', 'desc')
        ),
        [productId]);
    const { data: reviews, isLoading: reviewsLoading } = useCollection<Review>(reviewsQuery, { initialData: initialReviews });

    const favoriteRef = useMemoFirebase(() =>
        user?.uid ? doc(db, `users/${user.uid}/favorites/${productId}`) : null
        , [user?.uid, productId]);
    const { data: favorite } = useDoc(favoriteRef);
    const isFavorited = favorite !== null;

    const toggleFavorite = useCallback(async () => {
        if (!user || !favoriteRef) {
            router.push(`/sign-in?redirect=/product/${productId}`);
            return;
        }
        if (isFavorited) {
            await deleteDoc(favoriteRef);
            toast({ title: "Removed from favorites." });
        } else {
            await setDoc(favoriteRef, {
                productId: productId,
                addedAt: serverTimestamp(),
            });
            toast({ title: "Added to favorites!" });
        }
    }, [user, favoriteRef, isFavorited, productId, router, toast]);

    const handleStartConversation = async () => {
        if (!user || !product || !seller) {
            if (!user) {
                router.push(`/sign-in?redirect=/product/${product?.id}`);
            }
            return;
        }

        if (user.uid === seller.id) {
            toast({ title: "You can't message yourself.", variant: 'destructive' });
            return;
        }

        const conversationQuery = query(
            collection(db, 'conversations'),
            where('participantIds', 'array-contains', user.uid)
        );

        const querySnapshot = await getDocs(conversationQuery);
        let existingConversation: any = null;

        querySnapshot.forEach(doc => {
            const data = doc.data();
            if (data.participantIds.includes(seller.id) && data.productContext?.id === product.id) {
                existingConversation = { id: doc.id, ...data };
            }
        });

        if (existingConversation) {
            router.push(`/messages/${existingConversation.id}`);
        } else {
            const newConversationRef = await addDoc(collection(db, 'conversations'), {
                participantIds: [user.uid, seller.id],
                participants: {
                    [user.uid]: {
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                    },
                    [seller.id]: {
                        displayName: seller.displayName,
                        photoURL: seller.photoURL,
                    }
                },
                lastMessage: {
                    text: `Inquiry about: ${product.title}`,
                    senderId: user.uid,
                    timestamp: serverTimestamp(),
                },
                productContext: {
                    id: product.id,
                    title: product.title,
                    imageUrl: product.imageUrls[0],
                },
                createdAt: serverTimestamp(),
            });
            router.push(`/messages/${newConversationRef.id}`);
        }
    };

    useEffect(() => {
        if (!productId || viewRecordedRef.current === productId) return;

        // We mark it as recorded immediately to prevent double-firing due to StrictMode or fast renders
        viewRecordedRef.current = productId;

        const recordView = async () => {
            try {
                await recordProductView(productId, user?.uid);
            } catch (error) {
                console.error("Failed to record product view:", error);
            }
        };

        recordView();
    }, [productId, user?.uid]);

    useEffect(() => {
        if (product) {
            markAsViewed(productId);
            // Fetch related products
            const fetchRelatedProducts = async () => {
                setLoadingRelated(true);

                const relatedQuery = query(
                    collection(db, 'products'),
                    where('category', '==', product.category),
                    where('__name__', '!=', productId),
                    where('isDraft', '==', false),
                    limit(4)
                );
                const relatedSnap = await getDocs(relatedQuery);
                const relatedData = relatedSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })) as Product[];
                setRelatedProducts(relatedData);
                setLoadingRelated(false);
            };

            fetchRelatedProducts();
        }
    }, [product, productId, markAsViewed]);

    useEffect(() => {
        if (productError) {
            toast({
                title: "Error loading product",
                description: productError.message,
                variant: 'destructive',
            })
        }
    }, [productError, toast]);

    const isLoading = isProductLoading || isSellerLoading;

    if (isLoading && !product) {
        return (
            <div className="container mx-auto px-4 py-8">
                <Skeleton className="h-10 w-24 mb-6" />
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                    <div>
                        <Skeleton className="aspect-square rounded-2xl mb-4" />
                        <div className="flex gap-2">
                            {[...Array(4)].map((_, i) => (
                                <Skeleton key={i} className="w-20 h-20 rounded-lg" />
                            ))}
                        </div>
                    </div>
                    <div className="space-y-6">
                        <div className="space-y-3">
                            <Skeleton className="h-4 w-1/4" />
                            <Skeleton className="h-9 w-3/4" />
                            <Skeleton className="h-10 w-1/3" />
                            <div className="flex gap-4">
                                <Skeleton className="h-5 w-1/4" />
                                <Skeleton className="h-5 w-1/4" />
                            </div>
                            <Skeleton className="h-20 w-full" />
                        </div>
                        <Skeleton className="h-12 w-full" />
                        <div className="flex gap-3">
                            <Skeleton className="h-12 flex-1" />
                            <Skeleton className="h-12 flex-1" />
                        </div>
                        <Skeleton className="h-20 w-full" />
                    </div>
                </div>
            </div>
        );
    }

    if (!product) {
        notFound();
    }

    const handleAddToCart = () => {
        addItem(product, 1);
        toast({
            title: "Added to Cart!",
            description: `${product.title} is now in your cart.`,
        });
    };



    const handleAcceptBid = async (bidId: string) => {
        try {
            await acceptBid(product.id, bidId);
            toast({
                title: "Bid Accepted",
                description: "You have accepted the offer!",
            });
        } catch (err: any) {
            toast({
                variant: "destructive",
                title: "Error",
                description: err.message,
            });
        }
    };

    const handleDelete = async (e: React.MouseEvent) => {
        e.preventDefault();

        if (!isSuperAdmin) return;
        setIsDeleting(true);

        try {
            const idToken = await getCurrentUserIdToken();
            if (!idToken) throw new Error("Authentication session expired.");

            const result = await deleteProductByAdmin(productId, idToken);

            if (!result.success) {
                throw new Error(result.error);
            }

            toast({
                title: "Product Deleted",
                description: result.message,
            });
            router.push('/browse');

        } catch (error: any) {
            toast({
                variant: "destructive",
                title: "Deletion Failed",
                description: error.message || "An error occurred.",
            });
        } finally {
            setIsDeleting(false);
        }
    };

    return (
        <div className="min-h-screen bg-gray-50">
            <div className="container mx-auto px-4 py-8">
                <Button
                    variant="ghost"
                    onClick={() => router.back()}
                    className="mb-6"
                >
                    <ChevronLeft className="h-4 w-4 mr-2" />
                    Back
                </Button>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                    <div className="space-y-4">
                        <ProductImageGallery
                            images={product.imageUrls}
                            title={product.title}
                            isCard={product.category === 'Collector Cards'}
                            condition={product.condition}
                        />
                    </div>

                    <div className="space-y-6">
                        <div>
                            <div className="flex items-center justify-between mb-2">
                                <Badge variant="outline" className="text-xs">
                                    {product.category} {product.subCategory && `> ${product.subCategory}`}
                                </Badge>
                                <div className="flex items-center gap-2">
                                    <Button
                                        variant="ghost"
                                        size="icon"
                                        onClick={toggleFavorite}
                                        className="h-9 w-9"
                                    >
                                        <Heart className={cn("h-5 w-5", isFavorited && "fill-red-500 text-red-500")} />
                                    </Button>
                                    <Button variant="ghost" size="icon" className="h-9 w-9">
                                        <Share2 className="h-5 w-5" />
                                    </Button>
                                    {isSuperAdmin && (
                                        <AlertDialog>
                                            <AlertDialogTrigger asChild>
                                                <Button variant="ghost" size="icon" className="h-9 w-9 text-red-500 hover:text-red-700 hover:bg-red-50">
                                                    {isDeleting ? <Loader2 className="h-5 w-5 animate-spin" /> : <Trash2 className="h-5 w-5" />}
                                                </Button>
                                            </AlertDialogTrigger>
                                            <AlertDialogContent>
                                                <AlertDialogHeader>
                                                    <AlertDialogTitle>Are you absolutely sure?</AlertDialogTitle>
                                                    <AlertDialogDescription>
                                                        This action cannot be undone. This will permanently delete the product "{product.title}".
                                                    </AlertDialogDescription>
                                                </AlertDialogHeader>
                                                <AlertDialogFooter>
                                                    <AlertDialogCancel>Cancel</AlertDialogCancel>
                                                    <AlertDialogAction onClick={handleDelete} className="bg-red-600 hover:bg-red-700">Delete</AlertDialogAction>
                                                </AlertDialogFooter>
                                            </AlertDialogContent>
                                        </AlertDialog>
                                    )}
                                </div>
                            </div>

                            <h1 className="text-3xl font-bold text-gray-900 mb-3">{product.title}</h1>

                            <div className="flex items-center gap-3 mb-4">
                                <div className="text-4xl font-bold text-gray-900">
                                    ${product.price.toFixed(2)}
                                </div>
                            </div>

                            <div className="text-sm text-muted-foreground flex flex-wrap gap-x-4 gap-y-1">
                                {product.year && (
                                    <div className="flex items-center gap-1.5">
                                        <Calendar className="w-4 h-4" />
                                        <span>Year: {product.year}</span>
                                    </div>
                                )}
                                {product.manufacturer && (
                                    <div className="flex items-center gap-1.5">
                                        <Copyright className="w-4 h-4" />
                                        <span>{product.manufacturer}</span>
                                    </div>
                                )}
                                {product.cardNumber && (
                                    <div className="flex items-center gap-1.5">
                                        <Hash className="w-4 h-4" />
                                        <span>#{product.cardNumber}</span>
                                    </div>
                                )}
                                <div className="flex items-center gap-1.5">
                                    <Eye className="w-4 h-4" />
                                    <span>{product.views || 0} views</span>
                                </div>
                            </div>

                            <p className="text-gray-600 mt-4">{product.description}</p>
                        </div>

                        {(product.quantity && product.quantity > 0) ? (
                            <Alert className="bg-green-50 border-green-200">
                                <CheckCircle className="h-4 w-4 text-green-600" />
                                <AlertDescription className="text-green-800">
                                    <span className="font-semibold">In Stock</span>
                                </AlertDescription>
                            </Alert>
                        ) : (
                            <Alert variant="destructive">
                                <AlertCircle className="h-4 w-4" />
                                <AlertDescription>
                                    <span className="font-semibold">Out of Stock</span>
                                </AlertDescription>
                            </Alert>
                        )}

                        <div className="space-y-4 pt-4 border-t">
                            {(!product.isReverseBidding || user?.uid === product.sellerId) && (
                                <div className="flex flex-col sm:flex-row gap-3">
                                    <Button
                                        size="lg"
                                        className="flex-1"
                                        onClick={handleAddToCart}
                                        disabled={!product.quantity || product.quantity === 0}
                                    >
                                        <ShoppingCart className="h-5 w-5 mr-2" />
                                        Buy It
                                    </Button>
                                    <Button
                                        size="lg"
                                        variant="outline"
                                        className="flex-1"
                                        onClick={() => toast({ title: "Make Offer", description: "This feature is coming soon!" })}
                                    >
                                        <DollarSign className="h-5 w-5 mr-2" />
                                        Make Offer
                                    </Button>

                                </div>
                            )}
                        </div>

                        {product.isReverseBidding && user && (
                            <BiddingInterface
                                product={product}
                                user={user}
                                onAcceptBid={handleAcceptBid}
                            />
                        )}

                        {seller && (
                            <Card>
                                <CardContent className="pt-6">
                                    <div className="flex items-center gap-3 mb-4">
                                        <Avatar className="h-12 w-12 border">
                                            <AvatarImage src={seller.photoURL || ''} />
                                            <AvatarFallback>{seller.displayName?.[0]}</AvatarFallback>
                                        </Avatar>
                                        <div className="flex-1">
                                            <h3 className="font-semibold text-gray-900 flex items-center gap-1">
                                                {seller.displayName}
                                                {seller.isVerified && <ShieldCheck className="h-4 w-4 text-blue-500" />}
                                            </h3>
                                            <div className="flex items-center gap-3 mt-1">
                                                <div className="flex items-center gap-1">
                                                    <Star className="h-4 w-4 fill-yellow-400 text-yellow-400" />
                                                    <span className="text-sm font-medium">{seller.rating?.toFixed(1) || 'N/A'}</span>
                                                    <span className="text-xs text-gray-500">({seller.totalSales || 0} sales)</span>
                                                </div>
                                            </div>
                                        </div>
                                        <Button variant="outline" size="sm" asChild>
                                            <Link href={`/seller/${product.sellerId}`}>
                                                View Shop <ChevronRight className="w-4 h-4 ml-1" />
                                            </Link>
                                        </Button>
                                    </div>
                                    <Button variant="outline" size="sm" className="w-full" onClick={handleStartConversation}>
                                        <MessageSquare className="h-4 w-4 mr-2" />
                                        Message Seller
                                    </Button>
                                </CardContent>
                            </Card>
                        )}
                    </div>
                </div>

                <div className="lg:col-span-2 mt-12">
                    <Tabs defaultValue="reviews" className="space-y-6">
                        <TabsList className="grid grid-cols-2 w-full max-w-sm">
                            <TabsTrigger value="reviews">Reviews ({reviews?.length || 0})</TabsTrigger>
                            <TabsTrigger value="details">Item Details</TabsTrigger>
                        </TabsList>
                        <TabsContent value="reviews">
                            <Suspense fallback={<Loader2 className="animate-spin" />}>
                                {isUserLoading ? (
                                    <div className="flex justify-center p-8"><Loader2 className="animate-spin" /></div>
                                ) : (
                                    <>
                                        <ReviewForm
                                            user={user}
                                            productId={product.id}
                                            productTitle={product.title}
                                            sellerId={product.sellerId}
                                        />
                                        <ReviewList reviews={reviews || []} isLoading={reviewsLoading} />
                                    </>
                                )}
                            </Suspense>
                        </TabsContent>

                        <TabsContent value="details">
                            <Card>
                                <CardContent className="pt-6">
                                    <div className="prose max-w-none text-gray-600">
                                        <p>{product.description}</p>
                                        {/* Additional details would be rendered here */}
                                    </div>
                                </CardContent>
                            </Card>
                        </TabsContent>
                    </Tabs>
                </div>

                {relatedProducts.length > 0 && (
                    <div className="lg:col-span-2 mt-16">
                        <h2 className="text-2xl font-bold text-gray-900 mb-6">Related Collectibles</h2>
                        {loadingRelated ? <ProductGridSkeleton count={4} /> : <ProductGrid products={relatedProducts} />}
                    </div>
                )}
            </div>
        </div>
    );
}

================================================================================
FILE: src/app/product/[id]/opengraph-image.tsx
================================================================================

import { ImageResponse } from 'next/og';
import { getProductById } from '@/lib/firebase/firestore';

export const runtime = 'nodejs';
export const alt = 'Picksy Product Listing';
export const size = {
  width: 1200,
  height: 630,
};
export const contentType = 'image/png';


export default async function Image({ params }: { params: { id: string } }) {
  const product = await getProductById(params.id);

  if (!product) {
    return new ImageResponse(
      (
        <div
          style={{
            fontSize: 48,
            background: 'linear-gradient(to bottom right, #111827, #4b5563)',
            width: '100%',
            height: '100%',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            color: 'white',
            fontWeight: 'bold',
          }}
        >
          Picksy Marketplace
        </div>
      ),
      { ...size }
    );
  }

  const price = new Intl.NumberFormat('en-AU', {
    style: 'currency',
    currency: 'AUD',
  }).format(product.price);

  return new ImageResponse(
    (
      <div
        style={{
          background: 'white',
          width: '100%',
          height: '100%',
          display: 'flex',
          flexDirection: 'row',
        }}
      >
        {/* Left Side: Product Image */}
        <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', backgroundColor: '#f3f4f6', overflow: 'hidden' }}>
            <img
                src={product.imageUrls?.[0] || ''}
                alt={product.title}
                style={{ width: '100%', height: '100%', objectFit: 'cover' }}
            />
        </div>

        {/* Right Side: Details */}
        <div style={{
            flex: 1,
            display: 'flex',
            flexDirection: 'column',
            justifyContent: 'center',
            padding: '40px',
            background: 'linear-gradient(135deg, hsl(222.2, 47.4%, 11.2%) 0%, hsl(210, 40%, 96.1%) 100%)',
            color: 'white'
        }}>
          {/* Logo / Brand */}
          <div style={{ fontSize: 32, fontWeight: 'bold', marginBottom: 20, color: 'hsl(210, 40%, 98%)' }}>
            Picksy
          </div>

          {/* Title */}
          <div style={{ fontSize: 48, fontWeight: 'bold', marginBottom: 20, lineHeight: 1.1, color: 'white' }}>
            {product.title.substring(0, 60)}{product.title.length > 60 ? '...' : ''}
          </div>

          {/* Condition Badge */}
           {product.condition && (
            <div style={{
                display: 'flex',
                backgroundColor: 'hsla(0, 0%, 100%, 0.1)',
                padding: '8px 16px',
                borderRadius: 50,
                width: 'fit-content',
                marginBottom: 40,
                fontSize: 24,
                color: 'white',
                border: '1px solid hsla(0, 0%, 100%, 0.2)'
            }}>
              {product.condition}
            </div>
           )}

          {/* Price */}
          <div style={{ fontSize: 64, fontWeight: 'bold', color: 'white' }}>
            {price}
          </div>

          {/* Footer */}
          <div style={{ marginTop: 'auto', fontSize: 20, color: 'hsla(0, 0%, 100%, 0.7)' }}>
            Verified â€¢ Secure â€¢ Local
          </div>
        </div>
      </div>
    ),
    {
      ...size,
    }
  );
}

================================================================================
FILE: src/app/product/[id]/page.tsx
================================================================================

import { Suspense } from 'react';
import { notFound } from 'next/navigation';
import { getProductById, getReviewsForProduct } from '@/lib/firebase/firestore';
import type { Metadata } from 'next';
import type { Product, UserProfile, Review } from '@/lib/types';
import { Loader2 } from 'lucide-react';
import ProductDetailsClient from './ProductDetailsClient';


interface Props {
  params: Promise<{ id: string }>;
}

// Generate dynamic metadata for SEO - This MUST be in a Server Component
export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const { id } = await params;
  const product = await getProductById(id);

  if (!product) {
    return {
      title: 'Product Not Found | Picksy',
    };
  }

  const images = product.imageUrls && product.imageUrls.length > 0
    ? product.imageUrls
    : ['/og-image.jpg'];

  const description = product.description ? product.description.substring(0, 160) : 'Check out this collectible on Picksy.';

  return {
    title: `${product.title} | Picksy`,
    description: description,
    openGraph: {
      title: product.title,
      description: product.condition ? `${product.condition} condition. ${description}` : description,
      images: images.map(url => ({ url })),
      type: 'website',
      siteName: 'Picksy Marketplace',
    },
    twitter: {
      card: 'summary_large_image',
      title: product.title,
      description: description,
      images: images,
    }
  };
}


// This is the main page component - it's a Server Component
export default async function ProductPage({ params }: Props) {
  const { id } = await params;
  const product = await getProductById(id);

  if (!product) {
    notFound();
  }

  // Fetch seller and reviews on the server
  let seller: UserProfile | null = null;
  if (product.sellerId) {
    try {
      const { firestoreDb } = await import('@/lib/firebase/admin');
      const sellerSnap = await firestoreDb.collection('users').doc(product.sellerId).get();
      if (sellerSnap.exists) {
        const sellerData = sellerSnap.data();
        // Serialize timestamps to plain objects
        const serializedSeller: any = { id: sellerSnap.id };
        for (const key in sellerData) {
          const value = sellerData[key];
          if (value && typeof value === 'object' && 'seconds' in value && 'nanoseconds' in value) {
            serializedSeller[key] = { seconds: value.seconds, nanoseconds: value.nanoseconds };
          } else {
            serializedSeller[key] = value;
          }
        }
        seller = serializedSeller as UserProfile;
      }
    } catch (e) {
      console.error("Failed to fetch seller profile:", e);
    }
  }

  const initialReviews = await getReviewsForProduct(id);


  const SITE_URL = process.env.NEXT_PUBLIC_SITE_URL || 'https://studio-8322868971-8ca89.web.app';

  const jsonLd = {
    '@context': 'https://schema.org',
    '@type': 'Product',
    name: product.title,
    image: product.imageUrls,
    description: product.description,
    brand: {
      '@type': 'Brand',
      name: product.manufacturer || 'Picksy Marketplace',
    },
    offers: {
      '@type': 'Offer',
      priceCurrency: 'AUD',
      price: product.price,
      availability: product.status === 'available' ? 'https://schema.org/InStock' : 'https://schema.org/SoldOut',
      url: `${SITE_URL}/product/${product.id}`,
      seller: {
        '@type': 'Organization',
        name: product.sellerName || 'Picksy Seller'
      },
      eligibleRegion: {
        '@type': 'Country',
        name: 'Australia',
      },
      shippingDetails: {
        '@type': 'OfferShippingDetails',
        shippingDestination: {
          '@type': 'DefinedRegion',
          addressCountry: 'AU',
        },
      },
      areaServed: {
        '@type': 'Country',
        name: 'Australia',
      },
    },
  };

  const breadcrumbJsonLd = {
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: [
      {
        '@type': 'ListItem',
        position: 1,
        name: 'Home',
        item: `${SITE_URL}/`,
      },
      {
        '@type': 'ListItem',
        position: 2,
        name: product.category,
        item: `${SITE_URL}/${product.category.toLowerCase().replace(/\s+/g, '-')}`,
      },
      {
        '@type': 'ListItem',
        position: 3,
        name: product.title,
        item: `${SITE_URL}/product/${product.id}`,
      },
    ],
  };

  // The client component handles all interactive logic
  return (
    <>
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
      />
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(breadcrumbJsonLd) }}
      />
      <Suspense fallback={<div className="flex h-screen items-center justify-center"><Loader2 className="h-12 w-12 animate-spin text-primary" /></div>}>
        <ProductDetailsClient
          productId={id}
          initialProduct={product}
          initialSeller={seller}
          initialReviews={initialReviews}
        />
      </Suspense>
    </>
  );
}

================================================================================
FILE: src/app/profile/favorites/page.tsx
================================================================================

'use client';

import { useFirebase, useCollection, useUser, useMemoFirebase } from '@/firebase';
import { collection, doc, getDocs, query, where, documentId } from 'firebase/firestore';
import { useState, useEffect } from 'react';
import type { Product, WishlistItem } from '@/lib/types';
import ProductGrid from '@/components/products/ProductGrid';
import ProductGridSkeleton from '@/components/products/ProductGridSkeleton';
import { useRouter } from 'next/navigation';
import EmptyState from '@/components/ui/EmptyState';
import { Heart } from 'lucide-react';
import { Button } from '@/components/ui/button';
import Link from 'next/link';

export default function FavoritesTab() {
  const { firestore } = useFirebase();
  const { user, isUserLoading } = useUser();
  const [favoriteProducts, setFavoriteProducts] = useState<Product[]>([]);
  const [loadingFavorites, setLoadingFavorites] = useState(true);
  const router = useRouter();

  const favoritesQuery = useMemoFirebase(() => {
    if (!firestore || !user?.uid) return null;
    return collection(firestore, 'users', user.uid, 'favorites');
  }, [firestore, user?.uid]);

  const { data: favoriteItems, isLoading: favoritesLoading } = useCollection<WishlistItem>(favoritesQuery);

  useEffect(() => {
    if (isUserLoading) return;
    if (!user) {
      router.push('/sign-in?redirect=/profile/favorites');
      return;
    }

    const fetchFavoriteProducts = async () => {
      setLoadingFavorites(true);
      if (!favoriteItems || !firestore) {
        if (!favoritesLoading) {
          setLoadingFavorites(false);
          setFavoriteProducts([]);
        }
        return;
      }

      const favoriteIds = favoriteItems.map(fav => fav.id);

      if (favoriteIds.length === 0) {
        setFavoriteProducts([]);
        setLoadingFavorites(false);
        return;
      }

      try {
        const productChunks: Product[] = [];
        // Firestore 'in' query is limited to 30 items. We chunk the requests.
        for (let i = 0; i < favoriteIds.length; i += 30) {
          const chunkIds = favoriteIds.slice(i, i + 30);
          if (chunkIds.length === 0) continue;

          // Use documentId() to query by document ID
          const productsQuery = query(collection(firestore, 'products'), where(documentId(), 'in', chunkIds));
          const productDocs = await getDocs(productsQuery);
          
          const products = productDocs.docs
            .filter(docSnap => docSnap.exists())
            .map(docSnap => ({ id: docSnap.id, ...docSnap.data() } as Product));
          productChunks.push(...products);
        }
        setFavoriteProducts(productChunks);
      } catch (error) {
        console.error("Error fetching favorite products:", error);
      } finally {
        setLoadingFavorites(false);
      }
    };

    fetchFavoriteProducts();
  }, [favoriteItems, firestore, favoritesLoading, user, isUserLoading, router]);

  const isLoading = isUserLoading || favoritesLoading || loadingFavorites;

  return (
    <div>
      <h1 className="text-3xl font-bold tracking-tight mb-6 font-headline">
        My Favorites
      </h1>
      {isLoading ? (
        <ProductGridSkeleton count={4} />
      ) : favoriteProducts.length > 0 ? (
        <ProductGrid products={favoriteProducts} />
      ) : (
        <EmptyState
          title="Your Favorites List is Empty"
          description="Browse our collections and click the heart icon to save items you love."
          icon={<Heart className="h-16 w-16 text-muted-foreground" />}
        >
          <Button asChild className="mt-6">
            <Link href="/browse">Start Browsing</Link>
          </Button>
        </EmptyState>
      )}
    </div>
  );
}

================================================================================
FILE: src/app/profile/layout.tsx
================================================================================

'use client';

import { useFirebase, useUser } from '@/firebase';
import { useRouter, usePathname } from 'next/navigation';
import Link from 'next/link';
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Skeleton } from '@/components/ui/skeleton';
import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Heart, ShoppingBag, Loader2, User as UserIcon } from 'lucide-react';
import { useEffect } from 'react';
import { cn } from '@/lib/utils';

const getInitials = (name?: string | null) => {
  if (!name) return 'U';
  const names = name.split(' ');
  if (names.length > 1) {
    return names[0][0] + names[names.length - 1][0];
  }
  return name[0];
};

function ProfileSkeleton() {
  return (
    <div className="container py-8 md:py-12">
      <div className="grid gap-10 lg:grid-cols-4">
        <div className="lg:col-span-1">
          <Card>
            <CardHeader className="flex flex-col items-center text-center p-6">
              <Skeleton className="h-24 w-24 rounded-full mb-4" />
              <Skeleton className="h-8 w-3/4 mb-2" />
              <Skeleton className="h-4 w-full" />
            </CardHeader>
          </Card>
        </div>
        <div className="lg:col-span-3">
            <div className="mb-6">
                <Skeleton className="h-10 w-64" />
            </div>
          <Skeleton className="h-64 w-full" />
        </div>
      </div>
    </div>
  );
}

export default function ProfileLayout({
    children,
}: {
    children: React.ReactNode;
}) {
  const { user, isUserLoading } = useUser();
  const router = useRouter();
  const pathname = usePathname();

  useEffect(() => {
    if (!isUserLoading && !user) {
      router.push('/sign-in?redirect=/profile');
    }
  }, [isUserLoading, user, router]);
  
  const getCurrentTab = () => {
    if (pathname.includes('/favorites')) return 'favorites';
    if (pathname.includes('/listings')) return 'listings';
    return 'profile';
  }

  if (isUserLoading) {
    return <ProfileSkeleton />;
  }

  if (!user) {
     return <ProfileSkeleton />; // Show skeleton while redirecting
  }

  return (
    <div className="container py-8 md:py-12">
      <div className="grid gap-10 lg:grid-cols-4 items-start">
        {/* Left Sidebar */}
        <aside className="lg:col-span-1 lg:sticky lg:top-24">
          <Card>
            <CardHeader className="flex flex-col items-center text-center p-6">
              <Avatar className="h-24 w-24 mb-4">
                <AvatarImage
                  src={user?.photoURL || ''}
                  alt={user?.displayName || 'User'}
                />
                <AvatarFallback className="text-3xl">
                  {getInitials(user?.displayName)}
                </AvatarFallback>
              </Avatar>
              <CardTitle className="text-2xl">{user?.displayName}</CardTitle>
              <p className="text-muted-foreground">{user?.email}</p>
            </CardHeader>
          </Card>
        </aside>

        {/* Right Content */}
        <main className="lg:col-span-3">
            <Tabs value={getCurrentTab()} className="w-full">
                <TabsList className="grid w-full grid-cols-3 max-w-md mb-6">
                    <TabsTrigger value="profile" asChild>
                        <Link href="/profile"><UserIcon className="w-4 h-4 mr-2"/>Profile</Link>
                    </TabsTrigger>
                    <TabsTrigger value="listings" asChild>
                        <Link href="/profile/listings"><ShoppingBag className="w-4 h-4 mr-2"/>My Listings</Link>
                    </TabsTrigger>
                    <TabsTrigger value="favorites" asChild>
                        <Link href="/profile/favorites"><Heart className="w-4 h-4 mr-2"/>Favorites</Link>
                    </TabsTrigger>
                </TabsList>
                {/* The active page content will be rendered here */}
                {children}
            </Tabs>
        </main>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/profile/listings/page.tsx
================================================================================

'use client';

import { useFirebase, useCollection, useUser, useMemoFirebase } from '@/firebase';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import type { Product } from '@/lib/types';
import ProductGrid from '@/components/products/ProductGrid';
import { Button } from '@/components/ui/button';
import { collection, query, where, orderBy } from 'firebase/firestore';
import { ShoppingBag, Upload } from 'lucide-react';
import { useEffect } from 'react';
import EmptyState from '@/components/ui/EmptyState';
import ProductGridSkeleton from '@/components/products/ProductGridSkeleton';

export default function MyListingsPage() {
  const { firestore } = useFirebase();
  const { user, isUserLoading } = useUser();
  const router = useRouter();

  useEffect(() => {
    if (!isUserLoading && !user) {
      router.push('/sign-in?redirect=/profile/listings');
    }
  }, [isUserLoading, user, router]);

  const userProductsQuery = useMemoFirebase(() => {
    if (!firestore || !user?.uid) return null;
    return query(
      collection(firestore, 'products'),
      where('sellerId', '==', user.uid),
      orderBy('createdAt', 'desc')
    );
  }, [firestore, user?.uid]);

  const { data: userProducts, isLoading: productsLoading } =
    useCollection<Product>(userProductsQuery);

  if (isUserLoading || productsLoading) {
    return (
        <div>
             <div className="flex items-center justify-between mb-6">
                <h1 className="text-3xl font-bold tracking-tight font-headline">
                    My Listings
                </h1>
                 <Button asChild>
                    <Link href="/sell/create">
                        <Upload className="h-4 w-4 mr-2" />
                        New Listing
                    </Link>
                </Button>
            </div>
            <ProductGridSkeleton count={3} />
        </div>
    );
  }

  if (!user) {
     return null;
  }

  return (
    <div>
        <div className="flex items-center justify-between mb-6">
            <h1 className="text-3xl font-bold tracking-tight font-headline">
                My Listings
            </h1>
            <Button asChild>
                <Link href="/sell/create">
                    <Upload className="h-4 w-4 mr-2" />
                    New Listing
                </Link>
            </Button>
        </div>
        {userProducts && userProducts.length > 0 ? (
            <ProductGrid products={userProducts} />
        ) : (
            <EmptyState
                title="You haven't listed any items"
                description="Start selling your collectibles to see them here."
                icon={<ShoppingBag className="h-16 w-16 text-muted-foreground" />}
            >
                <Button asChild>
                    <Link href="/sell/create">Create Your First Listing</Link>
                </Button>
            </EmptyState>
        )}
    </div>
  );
}

================================================================================
FILE: src/app/profile/page.tsx
================================================================================
'use client';

import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
} from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { useUser } from '@/firebase';
import { Edit, Loader2 } from 'lucide-react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { useToast } from '@/hooks/use-toast';
import { updateUserProfile } from '@/lib/firebase/client-ops';
import { useState, useEffect, useTransition } from 'react';

const profileSchema = z.object({
  displayName: z.string().min(2, 'Display name must be at least 2 characters.'),
  bio: z.string().max(160, 'Bio cannot be longer than 160 characters.').optional(),
});

type ProfileFormValues = z.infer<typeof profileSchema>;

export default function ProfileDetailsPage() {
  const { user } = useUser();
  const { toast } = useToast();
  const [isPending, startTransition] = useTransition();

  const form = useForm<ProfileFormValues>({
    resolver: zodResolver(profileSchema),
    defaultValues: {
      displayName: '',
      bio: '',
    },
    mode: 'onChange',
  });

  useEffect(() => {
    if (user) {
      form.reset({
        displayName: user.displayName || '',
        bio: (user as any).bio || '',
      });
    }
  }, [user, form]);

  const onSubmit = (data: ProfileFormValues) => {
    if (!user) {
      toast({ title: 'You must be signed in', variant: 'destructive' });
      return;
    }

    startTransition(async () => {
      try {
        await updateUserProfile(user, data);
        toast({ title: 'Profile updated successfully!' });
      } catch (error: any) {
        toast({
          title: 'Failed to update profile',
          description: error.message,
          variant: 'destructive',
        });
      }
    });
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Public Profile</CardTitle>
        <CardDescription>
          This is how others will see you on the site.
        </CardDescription>
      </CardHeader>
      <CardContent>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            <FormField
              control={form.control}
              name="displayName"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Display Name</FormLabel>
                  <FormControl>
                    <Input placeholder="Your display name" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
             <div className="space-y-2">
                <FormLabel>Email</FormLabel>
                <Input value={user?.email || ''} readOnly disabled />
            </div>
             <FormField
              control={form.control}
              name="bio"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Bio</FormLabel>
                  <FormControl>
                    <Textarea
                        placeholder="Tell us a little about your collection."
                        {...field}
                     />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <div className="flex justify-end">
              <Button type="submit" disabled={isPending || !form.formState.isValid}>
                {isPending ? (
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                ) : (
                  <Edit className="mr-2 h-4 w-4" />
                )}
                Update Profile
              </Button>
            </div>
          </form>
        </Form>
      </CardContent>
    </Card>
  );
}

================================================================================
FILE: src/app/prohibited-items/page.tsx
================================================================================

import { PageHeader } from "@/components/layout/PageHeader";
import { AlertTriangle } from "lucide-react";

const prohibitedCategories = [
    {
        category: "Illegal Items",
        items: ["Counterfeit or replica items", "Stolen goods", "Firearms, ammunition, and explosives", "Illegal drugs and drug paraphernalia"]
    },
    {
        category: "Hazardous Materials",
        items: ["Flammable materials", "Toxic substances", "Radioactive materials"]
    },
    {
        category: "Adult Content",
        items: ["Pornographic materials", "Items depicting explicit or obscene content"]
    },
    {
        category: "Other",
        items: ["Human remains or body parts", "Services or intangible items", "Items that infringe on intellectual property rights"]
    }
];

export default function ProhibitedItemsPage() {
  return (
    <div className="container py-12 md:py-16">
        <PageHeader
            title="Prohibited Items Policy"
            description="To maintain a safe and trusted marketplace, certain items are not allowed on Picksy."
        />

        <div className="prose lg:prose-lg max-w-4xl mx-auto mt-8">
            <div className="bg-destructive/10 border-l-4 border-destructive text-destructive p-4 rounded-md" role="alert">
                <div className="flex">
                    <div className="flex-shrink-0">
                    <AlertTriangle className="h-5 w-5" />
                    </div>
                    <div className="ml-3">
                    <p className="font-bold">Important Notice</p>
                    <p className="text-sm">
                        Listing prohibited items will result in the removal of the listing and may lead to suspension of your account.
                    </p>
                    </div>
                </div>
            </div>

            <p>
                The following list provides a non-exhaustive overview of items that are not permitted to be sold on the Picksy platform. All users are responsible for ensuring their listings comply with all local, state, and federal laws.
            </p>
            
            {prohibitedCategories.map(cat => (
                <div key={cat.category}>
                    <h3>{cat.category}</h3>
                    <ul>
                        {cat.items.map(item => <li key={item}>{item}</li>)}
                    </ul>
                </div>
            ))}
        </div>
    </div>
  );
}

================================================================================
FILE: src/app/research/collection/page.tsx
================================================================================
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Star, Loader, ArrowLeft, Gem, DollarSign } from 'lucide-react';
import { PageHeader } from '@/components/layout/PageHeader';
import { useUser } from '@/firebase';
import type { ScanHistoryItem } from '@/lib/research-types';
import { getScanHistory } from '@/app/actions/research';
import { useToast } from '@/hooks/use-toast';
import { formatCardDetails } from '@/lib/card-logic';
import { formatDistanceToNow } from 'date-fns';
import Image from 'next/image';

export default function CollectionPage() {
    const [keepers, setKeepers] = useState<ScanHistoryItem[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const { user, isUserLoading } = useUser();
    const router = useRouter();
    const { toast } = useToast();

    useEffect(() => {
        if (!isUserLoading && !user) {
            router.push('/sign-in?redirect=/research/collection');
        }
    }, [user, isUserLoading, router]);

    useEffect(() => {
        if (user) {
            const loadData = async () => {
                try {
                    const parsed = await getScanHistory(user.uid);
                    // Filter only keepers where image is present (optional: server could return all)
                    // The getScanHistory action returns a list.
                    // We only want keepers here.
                    setKeepers(parsed.filter((item) => item.isKeeper && item.imageDataUri));
                } catch (error) {
                    console.error('Failed to load collection:', error);
                    toast({ title: "Failed to load collection", variant: "destructive" });
                    setKeepers([]);
                } finally {
                    setIsLoading(false);
                }
            };
            loadData();
        }
    }, [user, toast]);

    if (isUserLoading || isLoading || !user) {
        return (
            <div className="flex h-screen items-center justify-center">
                <Loader className="h-8 w-8 animate-spin text-primary" />
            </div>
        );
    }

    return (
        <div className="container mx-auto py-8">
            <PageHeader
                title="My Collection"
                description="View your keeper cards from scans"
            />

            <div className="flex gap-4 mt-6 mb-8">
                <Button variant="outline" asChild>
                    <a href="/research">
                        <ArrowLeft className="mr-2 h-4 w-4" />
                        Back to Scanner
                    </a>
                </Button>
                <Button variant="outline" asChild>
                    <a href="/research/keep-list">
                        <Star className="mr-2 h-4 w-4" />
                        Keep List
                    </a>
                </Button>
            </div>

            {keepers.length === 0 ? (
                <Card>
                    <CardContent className="py-12 text-center">
                        <Star className="h-16 w-16 mx-auto text-muted-foreground mb-4" />
                        <h3 className="text-lg font-semibold mb-2">No Keepers Yet</h3>
                        <p className="text-muted-foreground mb-4">
                            Scan cards and keeper cards will appear here
                        </p>
                        <Button asChild>
                            <a href="/research">Start Scanning</a>
                        </Button>
                    </CardContent>
                </Card>
            ) : (
                <>
                    <div className="mb-6">
                        <h2 className="text-2xl font-bold">Your Keepers ({keepers.length})</h2>
                        <p className="text-muted-foreground">Cards you've scanned and kept</p>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        {keepers.map((card) => (
                            <Card key={card.id} className={`overflow-hidden ${card.isPrizmRookie ? 'border-yellow-400 border-2' : ''}`}>
                                <div className="relative aspect-[2.5/3.5] bg-gray-100">
                                    {card.imageDataUri && (
                                        <Image
                                            src={card.imageDataUri}
                                            alt={card.name}
                                            fill
                                            className="object-contain"
                                        />
                                    )}
                                    {card.isPrizmRookie && (
                                        <div className="absolute top-2 right-2 bg-gradient-to-r from-yellow-400 to-pink-500 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1">
                                            <Gem className="h-3 w-3" />
                                            PRIZM
                                        </div>
                                    )}
                                </div>
                                <CardHeader className="p-3">
                                    <CardTitle className="text-sm line-clamp-1">{card.name}</CardTitle>
                                    <CardDescription className="text-xs line-clamp-2">
                                        {formatCardDetails(card)}
                                    </CardDescription>
                                </CardHeader>
                                <CardContent className="p-3 pt-0">
                                    {card.salesData?.averagePrice && (
                                        <div className="flex items-center text-xs text-green-600 font-semibold">
                                            <DollarSign className="h-3 w-3" />
                                            ${card.salesData.averagePrice} avg
                                        </div>
                                    )}
                                    <p className="text-xs text-muted-foreground mt-1">
                                        {formatDistanceToNow(card.timestamp, { addSuffix: true })}
                                    </p>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </>
            )}
        </div>
    );
}

================================================================================
FILE: src/app/research/keep-list/page.tsx
================================================================================
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Trash2, PlusCircle, List, Loader } from 'lucide-react';
import { PageHeader } from '@/components/layout/PageHeader';
import { useUser } from '@/firebase';
import { useToast } from '@/hooks/use-toast';
import type { Player } from '@/lib/research-types';
import { getResearchPreferences, addPlayerToKeepList, removePlayerFromKeepList } from '@/app/actions/research';

export default function KeepListPage() {
    const [players, setPlayers] = useState<Player[]>([]);
    const [newPlayerName, setNewPlayerName] = useState('');
    const [newPlayerSport, setNewPlayerSport] = useState<Player['sport']>('Uncategorized');
    const [isLoading, setIsLoading] = useState(true);
    const { user, isUserLoading } = useUser();
    const router = useRouter();
    const { toast } = useToast();

    useEffect(() => {
        if (!isUserLoading && !user) {
            router.push('/sign-in?redirect=/research/keep-list');
        }
    }, [user, isUserLoading, router]);

    useEffect(() => {
        if (user) {
            const loadData = async () => {
                try {
                    const data = await getResearchPreferences(user.uid);
                    setPlayers(data);
                } catch (error) {
                    toast({ title: "Failed to load preferences", variant: "destructive" });
                } finally {
                    setIsLoading(false);
                }
            };
            loadData();
        }
    }, [user, toast]);

    const handleAddPlayer = async () => {
        if (!newPlayerName.trim()) {
            toast({ title: 'Enter a player name', variant: 'destructive' });
            return;
        }

        if (players.some(p => p.name.toLowerCase() === newPlayerName.toLowerCase())) {
            toast({ title: 'Player already in list', variant: 'destructive' });
            return;
        }

        const newPlayer: Player = { name: newPlayerName.trim(), sport: newPlayerSport };

        // Optimistic
        setPlayers(prev => [...prev, newPlayer].sort((a, b) => a.name.localeCompare(b.name)));
        setNewPlayerName('');

        try {
            if (user) {
                await addPlayerToKeepList(user.uid, newPlayer);
                toast({ title: 'Player added!', description: `${newPlayer.name} added to keep list` });
            }
        } catch (error) {
            toast({ title: "Failed to save to server", variant: "destructive" });
        }
    };

    const handleDeletePlayer = async (name: string) => {
        // Optimistic
        setPlayers(prev => prev.filter(p => p.name !== name));

        try {
            if (user) {
                await removePlayerFromKeepList(user.uid, name);
                toast({ title: 'Player removed' });
            }
        } catch (error) {
            toast({ title: "Failed to sync with server", variant: "destructive" });
        }
    };

    if (isUserLoading || isLoading || !user) {
        return (
            <div className="flex h-screen items-center justify-center">
                <Loader className="h-8 w-8 animate-spin text-primary" />
            </div>
        );
    }

    const sports = ['Baseball', 'Basketball', 'Football', 'Soccer', 'Hockey', 'Uncategorized'] as const;

    return (
        <div className="container mx-auto py-8 max-w-4xl">
            <PageHeader
                title="Keep List"
                description="Manage the players you want to keep when scanning cards"
            />

            <Card className="mt-8">
                <CardHeader>
                    <CardTitle>Add New Player</CardTitle>
                    <CardDescription>Add players to automatically detect keepers when scanning</CardDescription>
                </CardHeader>
                <CardContent>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="md:col-span-2">
                            <Label htmlFor="player-name">Player Name</Label>
                            <Input
                                id="player-name"
                                value={newPlayerName}
                                onChange={(e) => setNewPlayerName(e.target.value)}
                                placeholder="e.g., Stephen Curry"
                                onKeyDown={(e) => e.key === 'Enter' && handleAddPlayer()}
                            />
                        </div>
                        <div>
                            <Label htmlFor="sport">Sport</Label>
                            <Select value={newPlayerSport} onValueChange={(v) => setNewPlayerSport(v as Player['sport'])}>
                                <SelectTrigger id="sport">
                                    <SelectValue />
                                </SelectTrigger>
                                <SelectContent>
                                    {sports.map(sport => (
                                        <SelectItem key={sport} value={sport}>{sport}</SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>
                    </div>
                    <Button onClick={handleAddPlayer} className="mt-4">
                        <PlusCircle className="mr-2 h-4 w-4" />
                        Add Player
                    </Button>
                </CardContent>
            </Card>

            <Card className="mt-6">
                <CardHeader>
                    <div className="flex items-center justify-between">
                        <div>
                            <CardTitle>Your Keep List ({players.length})</CardTitle>
                            <CardDescription>Players you're collecting</CardDescription>
                        </div>
                        <Button variant="outline" asChild>
                            <a href="/research">
                                <List className="mr-2 h-4 w-4" />
                                Back to Scanner
                            </a>
                        </Button>
                    </div>
                </CardHeader>
                <CardContent>
                    {players.length === 0 ? (
                        <p className="text-center text-muted-foreground py-8">No players yet. Add some above!</p>
                    ) : (
                        <div className="space-y-2">
                            {players.map((player) => (
                                <div
                                    key={player.name}
                                    className="flex items-center justify-between p-3 rounded-lg border hover:bg-muted/50 transition-colors"
                                >
                                    <div>
                                        <p className="font-medium">{player.name}</p>
                                        <p className="text-sm text-muted-foreground">{player.sport}</p>
                                    </div>
                                    <Button
                                        variant="ghost"
                                        size="icon"
                                        onClick={() => handleDeletePlayer(player.name)}
                                        className="text-muted-foreground hover:text-destructive"
                                    >
                                        <Trash2 className="h-4 w-4" />
                                    </Button>
                                </div>
                            ))}
                        </div>
                    )}
                </CardContent>
            </Card>
        </div>
    );
}

================================================================================
FILE: src/app/research/page.tsx
================================================================================
'use client';

import { useState, useEffect, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import { nanoid } from 'nanoid';
import { Settings, FileClock, ScanLine, Loader, ShoppingCart, Star, List } from 'lucide-react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import type { ScanHistoryItem, Player } from '@/lib/research-types';
import { defaultPlayers } from '@/lib/research-types';
import { useToast } from '@/hooks/use-toast';
import { useUser } from '@/firebase';
import dynamic from 'next/dynamic';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { PageHeader } from '@/components/layout/PageHeader';
import { ErrorBoundary } from 'react-error-boundary';
import { getResearchPreferences, addPlayerToKeepList, getScanHistory, addScanResult, deleteScanResult } from '@/app/actions/research';

const CameraScanner = dynamic(() => import('@/components/research/camera-scanner'), {
    loading: () => (
        <div className="w-full max-w-[12rem] aspect-[9/16] flex flex-col items-center justify-center bg-muted rounded-xl">
            <Loader className="w-8 h-8 animate-spin text-primary mb-4" />
            <p className="text-sm text-muted-foreground">Loading Camera...</p>
        </div>
    ),
    ssr: false,
});

// Fallback component for CameraScanner error boundary
function CameraScannerFallback({ error, resetErrorBoundary }: any) {
    return (
        <div className="w-full max-w-[12rem] aspect-[9/16] flex flex-col items-center justify-center bg-muted rounded-xl p-4">
            <div className="text-destructive mb-2 font-bold">Scan Failed</div>
            <p className="text-xs text-muted-foreground text-center mb-4">
                {error?.message || 'Unable to load scanner'}
            </p>
            <Button variant="outline" size="sm" onClick={resetErrorBoundary}>
                Try Again
            </Button>
        </div>
    );
}

const HistoryLog = dynamic(() => import('@/components/research/history-log'), {
    ssr: false,
});

export default function ResearchPage() {
    const [namesToKeep, setNamesToKeep] = useState<Player[]>([]);
    const [history, setHistory] = useState<ScanHistoryItem[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const { toast } = useToast();
    const { user, isUserLoading } = useUser();
    const router = useRouter();

    useEffect(() => {
        if (!isUserLoading && !user) {
            router.push('/sign-in?redirect=/research');
        }
    }, [user, isUserLoading, router]);

    useEffect(() => {
        if (user) {
            const loadData = async () => {
                try {
                    const [prefs, hist] = await Promise.all([
                        getResearchPreferences(user.uid),
                        getScanHistory(user.uid)
                    ]);
                    setNamesToKeep(prefs);
                    setHistory(hist);
                } catch (error) {
                    console.error("Failed to load research data:", error);
                    toast({
                        title: "Error",
                        description: "Could not load your research data.",
                        variant: "destructive"
                    });
                } finally {
                    setIsLoading(false);
                }
            };
            loadData();
        }
    }, [user, toast]);

    const handleAddPlayer = useCallback(async (player: Player) => {
        if (!user) return;

        // Optimistic update
        setNamesToKeep((prevNames) => {
            if (prevNames.some(p => p.name.toLowerCase() === player.name.toLowerCase())) {
                toast({
                    title: 'Already in List',
                    description: `"${player.name}" is already in your keep list.`,
                });
                return prevNames;
            }
            return [...prevNames, player].sort((a, b) => a.name.localeCompare(b.name));
        });

        try {
            await addPlayerToKeepList(user.uid, player);
            toast({
                title: 'Player Added',
                description: `"${player.name}" has been added to your keep list.`,
            });
        } catch (error) {
            console.error("Failed to add player:", error);
            toast({
                title: "Error",
                description: "Failed to save player to server.",
                variant: "destructive"
            });
            // Revert logic could go here if needed
        }
    }, [user, toast]);

    const handleAddNameToKeep = useCallback((name: string, sport: string = 'Uncategorized') => {
        const newPlayer: Player = { name, sport: sport as Player['sport'] };
        handleAddPlayer(newPlayer);
    }, [handleAddPlayer]);

    const handleScanComplete = useCallback(
        async (result: {
            name: string;
            isKeeper: boolean;
            imageDataUri: string;
            brand?: string;
            cardType?: string;
            sport?: string;
            cardYear?: number | null;
            isPrizmRookie?: boolean;
            salesData?: {
                averagePrice?: number | null;
                salesCount?: number | null;
                source?: string | null;
            };
        }) => {
            if (!user) return;

            const newItem: ScanHistoryItem = {
                id: nanoid(),
                name: result.name,
                isKeeper: result.isKeeper,
                isPrizmRookie: result.isPrizmRookie,
                brand: result.brand,
                cardType: result.cardType,
                sport: result.sport,
                cardYear: result.cardYear,
                salesData: result.salesData,
                timestamp: new Date(),
                imageDataUri: result.imageDataUri, // We might want to upload this to storage in a real app
            };

            // Optimistic update
            setHistory(prev => [newItem, ...prev]);

            try {
                await addScanResult(user.uid, newItem);
            } catch (error) {
                console.error("Failed to save scan result:", error);
                toast({
                    title: "Warning",
                    description: "Scan saved locally but failed to sync to server.",
                    variant: "destructive"
                });
            }
        },
        [user, toast]
    );

    const handleDeleteItem = useCallback(async (id: string) => {
        if (!user) return;

        // Optimistic
        setHistory(prev => prev.filter(item => item.id !== id));

        try {
            await deleteScanResult(user.uid, id);
        } catch (error) {
            console.error("Failed to delete history item:", error);
            toast({
                title: "Error",
                description: "Failed to delete item from server.",
                variant: "destructive"
            });
            // Could revert here by reloading history
            const hist = await getScanHistory(user.uid);
            setHistory(hist);
        }
    }, [user, toast]);

    if (isUserLoading || isLoading || !user) {
        return (
            <div className="flex h-screen w-full items-center justify-center bg-background">
                <Loader className="h-8 w-8 animate-spin text-primary" />
            </div>
        );
    }

    return (
        <div className="container mx-auto py-8">
            <PageHeader
                title="Card Research Lab"
                description="Scan trading cards with AI to identify players, check values, and add to your marketplace listings"
            />

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                {/* Scanner Section */}
                <Card>
                    <CardHeader>
                        <div className="flex items-center gap-3">
                            <div className="bg-primary/10 text-primary p-3 rounded-full">
                                <ScanLine className="w-6 h-6" />
                            </div>
                            <div>
                                <CardTitle>AI Card Scanner</CardTitle>
                                <CardDescription>Position card in frame and tap to scan</CardDescription>
                            </div>
                        </div>
                    </CardHeader>
                    <CardContent className="flex flex-col items-center gap-4">
                        <ErrorBoundary FallbackComponent={CameraScannerFallback}>
                            <CameraScanner
                                playersToKeep={namesToKeep}
                                onScanComplete={handleScanComplete}
                                onAddNameToKeep={handleAddNameToKeep}
                            />
                        </ErrorBoundary>
                        <div className="flex gap-2 mt-4">
                            <Button variant="outline" asChild size="sm">
                                <Link href="/research/keep-list">
                                    <List className="w-4 h-4 mr-2" />
                                    Keep List ({namesToKeep.length})
                                </Link>
                            </Button>
                            <Button variant="outline" asChild size="sm">
                                <Link href="/research/collection">
                                    <Star className="w-4 h-4 mr-2" />
                                    My Collection
                                </Link>
                            </Button>
                        </div>
                    </CardContent>
                </Card>

                {/* History Section */}
                <Card className="flex flex-col">
                    <CardHeader>
                        <div className="flex items-center gap-3">
                            <div className="bg-primary/10 text-primary p-3 rounded-full">
                                <FileClock className="w-6 h-6" />
                            </div>
                            <div>
                                <CardTitle>Scan History</CardTitle>
                                <CardDescription>Review your recent scans</CardDescription>
                            </div>
                        </div>
                    </CardHeader>
                    <CardContent className="flex-1 overflow-hidden">
                        <HistoryLog
                            history={history}
                            onDeleteItem={handleDeleteItem}
                            onAddNameToKeep={handleAddNameToKeep}
                        />
                    </CardContent>
                </Card>
            </div>
        </div>
    );
}

================================================================================
FILE: src/app/robots.ts
================================================================================
import { MetadataRoute } from 'next';

export default function robots(): MetadataRoute.Robots {
  const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://picksy.com.au';
  return {
    rules: {
      userAgent: '*',
      allow: '/',
      disallow: ['/admin/', '/profile/', '/api/'],
    },
    sitemap: `${baseUrl}/sitemap.xml`,
  };
}

================================================================================
FILE: src/app/safety-tips/page.tsx
================================================================================

import { PageHeader } from "@/components/layout/PageHeader";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { ShieldCheck, Eye, Users, MessageSquare } from "lucide-react";

const safetyTips = [
  {
    icon: <ShieldCheck className="h-8 w-8 text-primary" />,
    title: "Verify Item Details",
    description: "Carefully review the item's description, photos, and condition. If a deal seems too good to be true, it probably is. Ask the seller for more information or photos if needed."
  },
  {
    icon: <Eye className="h-8 w-8 text-primary" />,
    title: "Check Seller Reviews",
    description: "Look at the seller's rating and read feedback from other buyers. A strong history of positive reviews is a good sign of a reliable seller."
  },
  {
    icon: <MessageSquare className="h-8 w-8 text-primary" />,
    title: "Communicate on Picksy",
    description: "Keep all communication with the other party on the Picksy messaging platform. Do not share personal contact information like emails or phone numbers."
  },
  {
    icon: <Users className="h-8 w-8 text-primary" />,
    title: "Meet in Public Places",
    description: "For in-person transactions, always arrange to meet in a well-lit, public place. Consider meeting at a police station or a busy coffee shop."
  }
];

export default function SafetyTipsPage() {
  return (
    <div className="bg-gray-50/50">
      <div className="container py-12 md:py-16">
        <PageHeader
          title="Safety Tips for Buyers & Sellers"
          description="Follow these guidelines to ensure a safe and secure experience on Picksy."
        />
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mt-16">
            {safetyTips.map((tip) => (
                <Card key={tip.title}>
                    <CardHeader className="flex flex-row items-center gap-4">
                        <div className="bg-primary/10 p-4 rounded-full w-fit">
                            {tip.icon}
                        </div>
                        <CardTitle>{tip.title}</CardTitle>
                    </CardHeader>
                    <CardContent>
                        <p className="text-muted-foreground">{tip.description}</p>
                    </CardContent>
                </Card>
            ))}
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/sell/bulk-csv-lister/page.tsx
================================================================================

'use client';

import { useState, useTransition, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import { useUser } from '@/firebase';
import { useToast } from '@/hooks/use-toast';
import Papa from 'papaparse';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Progress } from '@/components/ui/progress';
import { PageHeader } from '@/components/layout/PageHeader';
import { uploadImages } from '@/lib/firebase/storage';
import { bulkCreateProductsFromCSV } from '@/app/actions/bulk-products';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';
import { Upload, FileText, CheckCircle, XCircle, Loader2, ListChecks, FileUp, ImageUp } from 'lucide-react';
import { BeforeUnload } from '@/hooks/use-before-unload';

type CSVRow = {
  title: string;
  description: string;
  price: number;
  category: string;
  subCategory?: string;
  condition: string;
  quantity: number;
  imageName: string; // e.g., "charizard.jpg"
};

const REQUIRED_COLUMNS: (keyof CSVRow)[] = ['title', 'description', 'price', 'category', 'condition', 'quantity', 'imageName'];

export default function BulkCsvListerPage() {
  const router = useRouter();
  const { toast } = useToast();
  const { user } = useUser();
  const [isPending, startTransition] = useTransition();

  const [imageFiles, setImageFiles] = useState<File[]>([]);
  const [csvFile, setCsvFile] = useState<File | null>(null);
  const [parsedData, setParsedData] = useState<CSVRow[]>([]);
  const [validationErrors, setValidationErrors] = useState<string[]>([]);
  const [progress, setProgress] = useState(0);

  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    setImageFiles(Array.from(e.target.files || []));
  };

  const handleCsvUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setCsvFile(file);
      setParsedData([]);
      setValidationErrors([]);
      Papa.parse<CSVRow>(file, {
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const errors: string[] = [];
          if (results.errors.length > 0) {
            errors.push('CSV parsing failed. Check for formatting errors.');
          }
          const firstRow = results.data[0];
          if (firstRow) {
            for (const col of REQUIRED_COLUMNS) {
              if (!(col in firstRow)) {
                errors.push(`Missing required column: "${col}"`);
              }
            }
          } else {
            errors.push("CSV file is empty or invalid.");
          }
          
          if (errors.length > 0) {
            setValidationErrors(errors);
            setParsedData([]);
          } else {
            setParsedData(results.data);
          }
        },
      });
    }
  };

  const handleSubmit = useCallback(async () => {
    if (!user) {
      toast({ title: "Authentication required.", variant: "destructive" });
      return;
    }
    if (imageFiles.length === 0 || !csvFile || parsedData.length === 0 || validationErrors.length > 0) {
      toast({ title: "Please complete all steps correctly.", variant: "destructive" });
      return;
    }

    const idToken = await getCurrentUserIdToken();
    if (!idToken) {
      toast({ title: "Session expired. Please sign in again.", variant: "destructive" });
      return;
    }
    
    // Validate that every row in CSV has a matching image
    const imageNames = new Set(imageFiles.map(f => f.name));
    const missingImages: string[] = [];
    parsedData.forEach((row, index) => {
        if (!imageNames.has(row.imageName)) {
            missingImages.push(`Row ${index + 2}: Image "${row.imageName}" not found in uploaded images.`);
        }
    });

    if (missingImages.length > 0) {
        setValidationErrors(prev => [...prev, ...missingImages]);
        toast({ title: "Image Mismatch", description: "Some images in your CSV were not found.", variant: "destructive" });
        return;
    }

    startTransition(async () => {
      try {
        // 1. Upload all images to storage
        setProgress(10);
        const imageUrlsMap = new Map<string, string>();
        const uploadPath = `products/${user.uid}/bulk-${Date.now()}`;
        
        // Batch image uploads
        const uploadedUrls = await uploadImages(imageFiles, uploadPath);
        imageFiles.forEach((file, index) => {
            imageUrlsMap.set(file.name, uploadedUrls[index]);
        });
        setProgress(40);
        
        // 2. Prepare product data
        const productsToCreate = parsedData.map(row => ({
          ...row,
          imageUrls: [imageUrlsMap.get(row.imageName) || ''], // Get the URL, provide fallback
        }));
        
        // 3. Send to server action for batch Firestore write
        const result = await bulkCreateProductsFromCSV(idToken, productsToCreate);

        if (result.success) {
          setProgress(100);
          toast({
            title: "Success!",
            description: `${result.count} listings were created.`,
          });
          router.push('/sell/dashboard');
        } else {
          throw new Error(result.error);
        }
      } catch (error: any) {
        setProgress(0);
        toast({
          title: "An error occurred",
          description: error.message || "Failed to create listings.",
          variant: "destructive",
        });
      }
    });
  }, [user, imageFiles, csvFile, parsedData, validationErrors, router, toast]);

  const isFormDirty = imageFiles.length > 0 || csvFile !== null;

  return (
    <div className="container mx-auto py-8 max-w-4xl">
      <BeforeUnload when={isFormDirty && !isPending} />
      <PageHeader
        title="Bulk CSV Lister"
        description="A powerful tool for creating multiple listings from a CSV file."
      />

      <div className="space-y-8 mt-8">
        {/* Step 1: Upload Images */}
        <Card>
          <CardHeader>
            <div className="flex items-center gap-3">
              <div className="bg-primary/10 text-primary p-3 rounded-full">
                <ImageUp className="h-6 w-6" />
              </div>
              <div>
                <CardTitle>Step 1: Upload Images</CardTitle>
                <CardDescription>Select all the images referenced in your CSV file.</CardDescription>
              </div>
            </div>
          </CardHeader>
          <CardContent>
            <Input id="image-upload" type="file" multiple accept="image/*" onChange={handleImageUpload} />
            {imageFiles.length > 0 && (
              <div className="mt-4 p-4 bg-muted/50 rounded-lg text-sm">
                <p className="font-semibold text-green-600 flex items-center gap-2">
                  <CheckCircle className="h-4 w-4" />
                  {imageFiles.length} image(s) selected.
                </p>
                <ul className="text-xs text-muted-foreground list-disc pl-5 mt-2 max-h-24 overflow-y-auto">
                    {imageFiles.map(f => <li key={f.name}>{f.name}</li>)}
                </ul>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Step 2: Upload CSV */}
        <Card>
          <CardHeader>
             <div className="flex items-center gap-3">
              <div className="bg-primary/10 text-primary p-3 rounded-full">
                <FileUp className="h-6 w-6" />
              </div>
              <div>
                <CardTitle>Step 2: Upload CSV File</CardTitle>
                <CardDescription>Upload the CSV with your product data.</CardDescription>
              </div>
            </div>
          </CardHeader>
          <CardContent>
            <Input id="csv-upload" type="file" accept=".csv" onChange={handleCsvUpload} />
             <div className="text-xs mt-2 text-muted-foreground p-2 bg-muted/30 rounded">
                Required columns: {REQUIRED_COLUMNS.join(', ')}
            </div>
            {parsedData.length > 0 && (
              <p className="mt-4 font-semibold text-green-600 flex items-center gap-2 text-sm">
                <CheckCircle className="h-4 w-4" />
                {parsedData.length} rows parsed successfully.
              </p>
            )}
            {validationErrors.length > 0 && (
              <div className="mt-4 p-4 bg-destructive/10 text-destructive text-sm rounded-lg">
                <h4 className="font-bold flex items-center gap-2"><XCircle className="h-4 w-4" />Validation Errors:</h4>
                <ul className="list-disc pl-5 mt-2 text-xs">
                  {validationErrors.map((err, i) => <li key={i}>{err}</li>)}
                </ul>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Step 3: Process */}
        <Card>
          <CardHeader>
             <div className="flex items-center gap-3">
              <div className="bg-primary/10 text-primary p-3 rounded-full">
                <ListChecks className="h-6 w-6" />
              </div>
              <div>
                <CardTitle>Step 3: Create Listings</CardTitle>
                <CardDescription>Once both files are uploaded and valid, you can create the listings.</CardDescription>
              </div>
            </div>
          </CardHeader>
          <CardContent>
            <Button
              size="lg"
              className="w-full"
              onClick={handleSubmit}
              disabled={isPending || imageFiles.length === 0 || !csvFile || validationErrors.length > 0}
            >
              {isPending ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Upload className="mr-2 h-4 w-4" />}
              Create {parsedData.length > 0 ? `${parsedData.length}` : ''} Listings
            </Button>
            {isPending && (
              <div className="mt-4 space-y-2">
                <Progress value={progress} />
                <p className="text-sm text-center text-muted-foreground">
                    {progress < 40 ? "Uploading images..." : "Creating listings..."}
                </p>
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/sell/bulk-lister/page.tsx
================================================================================

'use client';

import { useState, useTransition, ChangeEvent, useId } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import { useFieldArray, useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useToast } from '@/hooks/use-toast';
import { useUser } from '@/firebase';
import {
  Upload,
  Trash2,
  DollarSign,
  Sparkles,
  Loader2,
  Layers,
} from 'lucide-react';
import { PageHeader } from '@/components/layout/PageHeader';
import { suggestListingDetails } from '@/ai/flows/suggest-listing-details';
import { uploadImages } from '@/lib/firebase/storage';
import { BeforeUnload } from '@/hooks/use-before-unload';
import type { Product } from '@/lib/types';
import { createProductAction } from '@/app/actions/products';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';


const fileToDataUri = (file: File): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target?.result as string);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
};

const cardSchema = z.object({
  file: z.instanceof(File),
  preview: z.string(),
  price: z.coerce
    .number()
    .positive({ message: 'Price must be a positive number.' }),
});

const formSchema = z.object({
  cards: z.array(cardSchema).min(1, 'Please upload at least one card.'),
});

type CardFormValues = z.infer<typeof cardSchema>;
type BulkListerFormValues = z.infer<typeof formSchema>;

function BulkListerPage() {
  const router = useRouter();
  const { toast } = useToast();
  const { user } = useUser();
  const fileInputId = useId();

  const [isSubmitting, setIsSubmitting] = useState(false);
  const [analysisProgress, setAnalysisProgress] = useState(0);

  const form = useForm<BulkListerFormValues>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      cards: [],
    },
  });

  const { fields, append, remove } = useFieldArray({
    control: form.control,
    name: 'cards',
  });

  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    const newCards = files.map(file => ({
      file,
      preview: URL.createObjectURL(file),
      price: 0,
    }));
    append(newCards);
  };

  const onSubmit = async (data: BulkListerFormValues) => {
    setIsSubmitting(true);
    setAnalysisProgress(0);

    const idToken = await getCurrentUserIdToken();
    if (!user || !idToken) {
      toast({ title: 'You must be signed in.', variant: 'destructive' });
      setIsSubmitting(false);
      return;
    }

    const totalCards = data.cards.length;
    let createdCount = 0;

    for (let i = 0; i < totalCards; i++) {
      const card = data.cards[i];
      try {
        // 1. Get AI suggestions
        const dataUri = await fileToDataUri(card.file);
        const suggestions = await suggestListingDetails({
          photoDataUris: [dataUri],
        });

        // 2. Upload image
        const imageUrls = await uploadImages(
          [card.file],
          `products/${user.uid}`
        );

        // 3. Prepare product data
        const productData: Partial<Product> = {
          title: suggestions.title,
          description: suggestions.description,
          price: card.price,
          category: 'Collector Cards',
          subCategory: suggestions.subCategory,
          condition: suggestions.condition,
          manufacturer: suggestions.manufacturer,
          year: suggestions.year,
          imageUrls,
          quantity: 1,
          isDraft: false,
          status: 'available',
        };

        // 4. Create product via Server Action
        const result = await createProductAction(idToken, productData);
        if (!result.success) {
            throw new Error(result.error);
        }
        createdCount++;
      } catch (error: any) {
        toast({
          title: `Failed to list card ${i + 1}`,
          description: error.message,
          variant: 'destructive',
        });
      } finally {
        setAnalysisProgress(((i + 1) / totalCards) * 100);
      }
    }

    setIsSubmitting(false);
    toast({
      title: 'Bulk Listing Complete!',
      description: `${createdCount} out of ${totalCards} cards listed successfully.`,
    });
    router.push('/sell/dashboard');
  };

  return (
    <div className="container mx-auto py-8">
      <PageHeader
        title="Bulk AI Lister"
        description="Upload photos of your cards, set your prices, and let our AI do the heavy lifting."
      />
       <BeforeUnload when={form.formState.isDirty && !isSubmitting} />

      <Card>
        <CardHeader>
          <CardTitle>Upload Your Cards</CardTitle>
          <CardDescription>
            Select all the card images you want to list.
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div
            className="flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg cursor-pointer hover:bg-muted/50"
            onClick={() => document.getElementById(fileInputId)?.click()}
          >
            <Upload className="h-12 w-12 text-muted-foreground" />
            <p className="mt-4 text-lg font-semibold">
              Click to upload or drag & drop
            </p>
            <p className="text-muted-foreground">PNG, JPG up to 10MB</p>
            <Input
              id={fileInputId}
              type="file"
              multiple
              accept="image/*"
              className="hidden"
              onChange={handleFileChange}
            />
          </div>
        </CardContent>
      </Card>

      {fields.length > 0 && (
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)}>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mt-8">
              {fields.map((field, index) => (
                <Card key={field.id} className="relative group">
                  <CardHeader className="p-0">
                    <div className="aspect-w-1 aspect-h-1 w-full overflow-hidden rounded-t-lg bg-muted">
                      <Image
                        src={field.preview}
                        alt={`Card Preview ${index}`}
                        width={300}
                        height={420}
                        className="object-cover w-full h-full"
                      />
                    </div>
                  </CardHeader>
                  <CardContent className="p-4">
                    <FormField
                      control={form.control}
                      name={`cards.${index}.price`}
                      render={({ field: priceField }) => (
                        <FormItem>
                          <FormLabel>Price (AUD)</FormLabel>
                          <div className="relative">
                            <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                            <FormControl>
                              <Input
                                type="number"
                                step="0.01"
                                placeholder="0.00"
                                className="pl-9"
                                {...priceField}
                              />
                            </FormControl>
                          </div>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </CardContent>
                  <Button
                    type="button"
                    variant="destructive"
                    size="icon"
                    className="absolute top-2 right-2 opacity-0 group-hover:opacity-100"
                    onClick={() => remove(index)}
                  >
                    <Trash2 className="h-4 w-4" />
                  </Button>
                </Card>
              ))}
            </div>

            <div className="mt-8 flex justify-center">
              <Button
                type="submit"
                size="lg"
                className="w-full max-w-md h-16 text-lg"
                disabled={isSubmitting}
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                    Processing... (
                    {Math.round(analysisProgress)}
                    %)
                  </>
                ) : (
                  <>
                    <Sparkles className="mr-2 h-5 w-5" />
                    Analyze All & Create Listings
                  </>
                )}
              </Button>
            </div>
          </form>
        </Form>
      )}
    </div>
  );
}

export default BulkListerPage;

================================================================================
FILE: src/app/sell/create/page.tsx
================================================================================
'use client';

import { useState, useRef, ChangeEvent, useEffect, useCallback, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';

import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';
import { Upload, Trash2, DollarSign, Sparkles, Loader2, GripVertical, ShieldCheck, Eye, ImagePlus } from 'lucide-react';
import { cn } from '@/lib/utils';
import { useToast } from "@/hooks/use-toast";
import { useFirebase, useUser, useDoc, useMemoFirebase } from '@/firebase';
import { uploadImages } from '@/lib/firebase/storage';
import { CameraCapture } from '@/components/ui/camera-capture';
import { Reorder } from 'framer-motion';
import { BeforeUnload } from '@/hooks/use-before-unload';
import EnhancedAICardGrader from '@/components/products/EnhancedAICardGrader';
import { suggestListingDetails } from '@/ai/flows/suggest-listing-details';
import { EbayPriceLookup } from '@/components/sell/EbayPriceLookup';
import { doc } from 'firebase/firestore';
import { saveDraftListing } from '@/app/actions/sell';

const VAULT_MINIMUM_PRICE = 0;

const formSchema = z.object({
  title: z.string().min(5, 'Title must be at least 5 characters.'),
  description: z.string().min(10, 'Description must be at least 10 characters.'),
  price: z.coerce.number().positive('Price must be a positive number.'),
  category: z.string().min(1, 'A category is required.'),
  subCategory: z.string().optional(),
  condition: z.string().min(1, 'Condition is required.'),
  manufacturer: z.string().optional(),
  year: z.coerce.number().int().min(1900).max(new Date().getFullYear() + 1).optional().or(z.literal(0)).or(z.nan()).or(z.null()).transform(val => val || undefined),
  cardNumber: z.string().optional(),
  quantity: z.coerce.number().int().min(1, 'Quantity must be at least 1.'),
  isReverseBidding: z.boolean().default(false),
  autoRepricingEnabled: z.boolean().default(false),
  isVault: z.boolean().default(false),
  imageFiles: z.array(z.any()).min(1, 'At least one image is required.').max(5, 'A maximum of 5 images are allowed.').default([]),
});

type ListingFormValues = z.infer<typeof formSchema>;

export default function CreateListingPage() {
  const router = useRouter();
  const { toast } = useToast();
  const { firestore } = useFirebase();
  const { user, isUserLoading: authLoading } = useUser();
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [imagePreviews, setImagePreviews] = useState<string[]>([]);
  const [showPriceLookup, setShowPriceLookup] = useState(false);
  const [isAnalyzing, setIsAnalyzing] = useState(false);

  const optionsRef = useMemoFirebase(() => firestore ? doc(firestore, 'settings', 'marketplace_options') : null, [firestore]);
  const { data: marketplaceOptions } = useDoc<any>(optionsRef);

  const form = useForm<ListingFormValues>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      title: '',
      description: '',
      price: 0,
      category: '',
      subCategory: '',
      condition: '',
      manufacturer: '',
      year: undefined,
      cardNumber: '',
      quantity: 1,
      isReverseBidding: false,
      autoRepricingEnabled: false,
      isVault: false,
      imageFiles: [],
    },
  });

  const CATEGORIES_OPTIONS = marketplaceOptions?.categories || ['Collector Cards', 'Coins', 'Collectibles', 'General'];
  const CONDITION_OPTIONS = marketplaceOptions?.conditions || ['Mint', 'Near Mint', 'Excellent', 'Good', 'Fair', 'Poor'];
  const SUB_CATEGORIES: Record<string, string[]> = {
    'Collector Cards': marketplaceOptions?.subCategories?.collector_cards || ['Sports Cards', 'Trading Cards'],
    'Coins': marketplaceOptions?.subCategories?.coins || ['Coins', 'World Coins', 'Ancient Coins', 'Bullion'],
    'Collectibles': marketplaceOptions?.subCategories?.collectibles || ['Stamps', 'Comics', 'Figurines', 'Toys', 'Shoes', 'Memorabilia'],
    'General': marketplaceOptions?.subCategories?.general || ['Household', 'Electronics', 'Clothing', 'Books', 'Other']
  };

  useEffect(() => {
    if (!authLoading && !user) {
      router.push('/sign-in?redirect=/sell/create');
    }
  }, [user, authLoading, router]);

  // Clean up object URLs to prevent memory leaks
  useEffect(() => {
    return () => {
      imagePreviews.forEach(url => {
        if (url.startsWith('blob:')) URL.revokeObjectURL(url);
      });
    };
  }, [imagePreviews]);

  const selectedCategory = form.watch('category');
  const imageFiles = form.watch('imageFiles');

  // Optimized File Handling
  const addImages = useCallback((newFiles: File[]) => {
    const currentFiles = form.getValues('imageFiles');
    if (currentFiles.length + newFiles.length > 5) {
      toast({ title: "Maximum 5 images allowed.", variant: "destructive" });
      return;
    }
    const validFiles: File[] = [];
    const newPreviews: string[] = [];
    newFiles.forEach(file => {
      if (file.size > 5 * 1024 * 1024) {
        toast({ title: `Image ${file.name} is too large (max 5MB).`, variant: 'destructive' });
        return;
      }
      validFiles.push(file);
      newPreviews.push(URL.createObjectURL(file));
    });
    const updatedFiles = [...currentFiles, ...validFiles];
    form.setValue('imageFiles', updatedFiles, { shouldValidate: true });
    setImagePreviews(prev => [...prev, ...newPreviews]);
  }, [form, toast]);

  const handleFileSelect = useCallback((e: ChangeEvent<HTMLInputElement>) => {
    addImages(Array.from(e.target.files || []));
    if (fileInputRef.current) fileInputRef.current.value = ''; // Reset input
  }, [addImages]);

  const removeImage = (index: number) => {
    const currentFiles = form.getValues('imageFiles');
    const urlToRemove = imagePreviews[index];
    form.setValue('imageFiles', currentFiles.filter((_, i) => i !== index), { shouldValidate: true });
    setImagePreviews(prev => prev.filter((_, i) => i !== index));
    if (urlToRemove && urlToRemove.startsWith('blob:')) URL.revokeObjectURL(urlToRemove);
  };

  const handleImageReorder = (newOrder: string[]) => {
    const currentFiles = form.getValues('imageFiles');
    const reorderedFiles: File[] = [];
    newOrder.forEach(previewUrl => {
      const originalIndex = imagePreviews.indexOf(previewUrl);
      if (originalIndex > -1) reorderedFiles.push(currentFiles[originalIndex]);
    });
    form.setValue('imageFiles', reorderedFiles);
    setImagePreviews(newOrder);
  };

  // Memoized Auto-Fill State
  const isAutoFillAvailable = useMemo(() => {
    return imageFiles.length > 0 && !isAnalyzing;
  }, [imageFiles.length, isAnalyzing]);

  const handleAutoFill = async () => {
    const currentFiles = form.getValues('imageFiles');
    if (!currentFiles.length || !user) return;

    setIsAnalyzing(true);
    try {
      const filesToProcess = currentFiles.slice(0, 3).filter((f: any) => f instanceof File) as File[];
      if (!filesToProcess.length) throw new Error("Please upload new photos.");

      const photoUrls = await uploadImages(filesToProcess, `temp-analysis/${user.uid}`);
      const idToken = await user.getIdToken();

      const suggestions = await suggestListingDetails({
        photoDataUris: photoUrls,
        title: form.getValues('title') || undefined,
        idToken,
      });

      if (suggestions) {
        Object.entries(suggestions).forEach(([key, value]) => {
          if (value) form.setValue(key as any, value);
        });
        if (suggestions.category && SUB_CATEGORIES[suggestions.category]?.includes(suggestions.subCategory)) {
          form.setValue('subCategory', suggestions.subCategory);
        }
        toast({ title: 'âœ¨ AI Magic Applied!', description: "We've filled in the details for you." });
      }
    } catch (error: any) {
      toast({ title: "Auto-Fill Failed", description: error.message, variant: "destructive" });
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleReview = async () => {
    setIsSubmitting(true);
    const isValid = await form.trigger();
    if (!isValid) {
      // Scroll to first error
      const firstError = Object.keys(form.formState.errors)[0];
      const element = document.querySelector(`[name="${firstError}"]`);
      if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      toast({ title: "Check your form", description: "Please fix the highlighted errors.", variant: "destructive" });
      setIsSubmitting(false);
      return;
    }

    if (!user) {
      setIsSubmitting(false);
      return;
    }

    try {
      const data = form.getValues();
      const imageFiles = data.imageFiles.filter(f => f instanceof File) as File[];
      const imageUrls = await uploadImages(imageFiles, `products/${user.uid}`);

      const draftId = await saveDraftListing(user.uid, {
        title: data.title,
        description: data.description,
        price: data.price,
        category: data.category,
        subCategory: data.subCategory,
        condition: data.condition,
        manufacturer: data.manufacturer,
        year: data.year,
        cardNumber: data.cardNumber,
        quantity: data.quantity,
        isReverseBidding: data.isReverseBidding,
        autoRepricingEnabled: data.autoRepricingEnabled,
        isVault: data.isVault,
        imageUrls: imageUrls
      });

      router.push(`/sell/review?draftId=${draftId}`);
    } catch (error: any) {
      toast({ title: "Error", description: error.message, variant: "destructive" });
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleApplyAiSuggestions = useCallback((result: any) => {
    if (!result) return;

    if (result.title) form.setValue('title', result.title, { shouldValidate: true });
    if (result.description) form.setValue('description', result.description, { shouldValidate: true });
    if (result.price) form.setValue('price', result.price, { shouldValidate: true });
    if (result.category) {
      form.setValue('category', result.category, { shouldValidate: true });
      // Only set subCategory if it's valid for the category
      if (result.subCategory && SUB_CATEGORIES[result.category]?.includes(result.subCategory)) {
        form.setValue('subCategory', result.subCategory, { shouldValidate: true });
      }
    }
    if (result.condition) form.setValue('condition', result.condition, { shouldValidate: true });
    if (result.manufacturer) form.setValue('manufacturer', result.manufacturer, { shouldValidate: true });
    if (result.year) form.setValue('year', result.year, { shouldValidate: true });
    if (result.cardNumber) form.setValue('cardNumber', result.cardNumber, { shouldValidate: true });

    toast({ title: 'âœ¨ AI Suggestions Applied!', description: "We've updated the form with AI-generated details." });
  }, [form, toast]);

  const getCaptureMode = () => form.getValues('category') === 'Collector Cards' ? 'card' : 'default';

  if (authLoading) return <div className="flex h-screen items-center justify-center"><Loader2 className="h-12 w-12 animate-spin text-primary" /></div>;
  if (!user) return <div className="flex h-screen items-center justify-center">Redirecting...</div>;

  return (
    <Form {...form}>
      <BeforeUnload when={form.formState.isDirty && !isSubmitting} />
      <div className="bg-slate-50 min-h-screen pb-20">
        <div className="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
          <div className="container mx-auto px-4 h-16 flex items-center justify-between">
            <h1 className="text-xl font-bold text-slate-900">List an Item</h1>
            <div className="flex items-center gap-2">
              <Button variant="ghost" size="sm" onClick={() => router.back()}>Cancel</Button>
              <Button onClick={handleReview} disabled={isSubmitting} className="bg-primary hover:bg-primary/90 text-white font-semibold">
                {isSubmitting ? <Loader2 className="h-4 w-4 animate-spin mr-2" /> : <Eye className="h-4 w-4 mr-2" />}
                Review
              </Button>
            </div>
          </div>
        </div>

        <main className="container mx-auto px-4 py-8 max-w-6xl">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* LEFT COLUMN: Photos & AI */}
            <div className="lg:col-span-1 space-y-6">
              <Card className="border-0 shadow-md overflow-hidden">
                <CardHeader className="bg-slate-900 text-white p-5">
                  <CardTitle className="text-lg flex items-center gap-2">
                    <ImagePlus className="h-5 w-5" /> Product Photos
                  </CardTitle>
                  <CardDescription className="text-slate-400">Upload up to 5 photos.</CardDescription>
                </CardHeader>
                <CardContent className="p-5 space-y-4">
                  <div className="grid grid-cols-2 gap-3">
                    <div onClick={() => fileInputRef.current?.click()} className="aspect-square rounded-xl border-2 border-dashed border-slate-300 hover:border-primary hover:bg-primary/5 cursor-pointer flex flex-col items-center justify-center transition-all group">
                      <div className="bg-white p-3 rounded-full shadow-sm group-hover:scale-110 transition-transform">
                        <Upload className="h-6 w-6 text-primary" />
                      </div>
                      <span className="text-xs font-semibold mt-2 text-slate-600">Upload</span>
                      <input ref={fileInputRef} type="file" multiple accept="image/*" onChange={handleFileSelect} className="hidden" />
                    </div>
                    <div className="aspect-square">
                      <CameraCapture onCapture={addImages} captureMode={getCaptureMode()} variant="hero" maxFiles={5 - imageFiles.length} />
                    </div>
                  </div>

                  {imagePreviews.length > 0 && (
                    <Reorder.Group axis="y" values={imagePreviews} onReorder={handleImageReorder} className="space-y-2 max-h-[300px] overflow-y-auto pr-1">
                      {imagePreviews.map((preview, index) => (
                        <Reorder.Item key={preview} value={preview} className="flex items-center gap-3 bg-white p-2 rounded-lg border border-slate-200 shadow-sm cursor-grab active:cursor-grabbing group">
                          <GripVertical className="h-4 w-4 text-slate-400" />
                          <div className="relative h-12 w-12 rounded overflow-hidden bg-slate-100 flex-shrink-0">
                            <Image
                              src={preview}
                              alt="Thumb"
                              fill
                              className="object-cover"
                              style={{ WebkitUserSelect: 'none', WebkitTransform: 'translateZ(0)' }} // Safari fix
                            />
                          </div>
                          <div className="flex-1 text-xs font-medium text-slate-700 truncate">Image {index + 1}</div>
                          <Button variant="ghost" size="icon" onClick={() => removeImage(index)} className="h-8 w-8 text-slate-400 hover:text-red-500">
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </Reorder.Item>
                      ))}
                    </Reorder.Group>
                  )}

                  {imageFiles.length > 0 && (
                    <Button onClick={handleAutoFill} disabled={!isAutoFillAvailable} variant="outline" className="w-full border-indigo-200 text-indigo-700 hover:bg-indigo-50 hover:text-indigo-800">
                      {isAnalyzing ? <Loader2 className="h-4 w-4 animate-spin mr-2" /> : <Sparkles className="h-4 w-4 mr-2" />}
                      {isAnalyzing ? 'Analyzing...' : 'Auto-Fill Details'}
                    </Button>
                  )}
                </CardContent>
              </Card>

              {selectedCategory === 'Collector Cards' && (
                <EnhancedAICardGrader
                  onGradeComplete={(grade) => form.setValue('condition', grade)}
                  imageFiles={imageFiles}
                  onApplySuggestions={(res) => handleApplyAiSuggestions(res)}
                />
              )}
            </div>

            {/* RIGHT COLUMN: Form Details */}
            <div className="lg:col-span-2 space-y-6">
              <Card className="border-0 shadow-md">
                <CardHeader className="border-b border-slate-100 pb-4">
                  <CardTitle>Item Details</CardTitle>
                </CardHeader>
                <CardContent className="p-6 space-y-6">
                  <FormField control={form.control} name="title" render={({ field }) => (
                    <FormItem><FormLabel>Title</FormLabel><FormControl><Input placeholder="e.g. 1999 PokÃ©mon Charizard Holo" {...field} className="h-12 text-lg" /></FormControl><FormMessage /></FormItem>
                  )} />

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <FormField control={form.control} name="category" render={({ field }) => (
                      <FormItem><FormLabel>Category</FormLabel><Select onValueChange={(val) => { field.onChange(val); form.setValue('subCategory', ''); }} value={field.value}><FormControl><SelectTrigger><SelectValue placeholder="Select Category" /></SelectTrigger></FormControl><SelectContent>{CATEGORIES_OPTIONS.map((c: string) => <SelectItem key={c} value={c}>{c}</SelectItem>)}</SelectContent></Select><FormMessage /></FormItem>
                    )} />
                    <FormField control={form.control} name="condition" render={({ field }) => (
                      <FormItem><FormLabel>Condition</FormLabel><Select onValueChange={field.onChange} value={field.value}><FormControl><SelectTrigger><SelectValue placeholder="Select Condition" /></SelectTrigger></FormControl><SelectContent>{CONDITION_OPTIONS.map((c: string) => <SelectItem key={c} value={c}>{c}</SelectItem>)}</SelectContent></Select><FormMessage /></FormItem>
                    )} />
                  </div>

                  <FormField control={form.control} name="description" render={({ field }) => (
                    <FormItem><FormLabel>Description</FormLabel><FormControl><Textarea placeholder="Tell buyers about your item..." rows={6} className="resize-none" {...field} /></FormControl><FormMessage /></FormItem>
                  )} />
                </CardContent>
              </Card>

              <Card className="border-0 shadow-md">
                <CardHeader className="border-b border-slate-100 pb-4">
                  <CardTitle>Pricing & Delivery</CardTitle>
                </CardHeader>
                <CardContent className="p-6 space-y-6">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <FormField control={form.control} name="price" render={({ field }) => (
                      <FormItem>
                        <div className="flex justify-between"><FormLabel>Price (AUD)</FormLabel><Button type="button" variant="link" size="sm" onClick={() => setShowPriceLookup(true)} className="h-auto p-0 text-primary">Price Research</Button></div>
                        <div className="relative"><DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" /><FormControl><Input type="number" step="0.01" className="pl-9" {...field} /></FormControl></div><FormMessage />
                      </FormItem>
                    )} />
                    <FormField control={form.control} name="quantity" render={({ field }) => (
                      <FormItem><FormLabel>Quantity</FormLabel><FormControl><Input type="number" min="1" {...field} /></FormControl><FormMessage /></FormItem>
                    )} />
                  </div>

                  <div className="space-y-4 pt-4">
                    <FormField control={form.control} name="isVault" render={({ field }) => (
                      <FormItem className="flex items-center justify-between rounded-xl border border-emerald-100 bg-emerald-50/50 p-4">
                        <div className="space-y-1">
                          <FormLabel className="flex items-center text-emerald-900 font-bold"><ShieldCheck className="h-4 w-4 mr-2 text-emerald-600" /> Secure Vault Protection</FormLabel>
                          <FormDescription className="text-emerald-700/80 text-xs">Picksy acts as the middle-man. We verify the item before payout. ($49.95 fee)</FormDescription>
                        </div>
                        <FormControl><Switch checked={field.value} onCheckedChange={field.onChange} className="data-[state=checked]:bg-emerald-600" /></FormControl>
                      </FormItem>
                    )} />

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <FormField control={form.control} name="isReverseBidding" render={({ field }) => (
                        <FormItem className="flex items-center justify-between rounded-xl border border-slate-200 p-4">
                          <div className="space-y-0.5"><FormLabel>Accept Offers</FormLabel><FormDescription className="text-xs">Let buyers bid.</FormDescription></div>
                          <FormControl><Switch checked={field.value} onCheckedChange={field.onChange} /></FormControl>
                        </FormItem>
                      )} />
                      <FormField control={form.control} name="autoRepricingEnabled" render={({ field }) => (
                        <FormItem className="flex items-center justify-between rounded-xl border border-slate-200 p-4">
                          <div className="space-y-0.5"><FormLabel>Smart Pricing</FormLabel><FormDescription className="text-xs">Auto-adjust price.</FormDescription></div>
                          <FormControl><Switch checked={field.value} onCheckedChange={field.onChange} /></FormControl>
                        </FormItem>
                      )} />
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>
          </div>

          <div className="mt-8 flex justify-end">
            <Button
              onClick={handleReview}
              disabled={isSubmitting}
              size="lg"
              className="bg-primary hover:bg-primary/90 text-white font-bold h-14 px-8 text-lg shadow-lg w-full md:w-auto"
            >
              {isSubmitting ? <Loader2 className="h-5 w-5 animate-spin mr-2" /> : <Eye className="h-5 w-5 mr-2" />}
              Review Listing
            </Button>
          </div>
        </main>
      </div >

      {/* Mobile Fixed Action Bar */}
      < div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 z-50 md:hidden pb-safe" >
        <Button
          onClick={handleReview}
          disabled={isSubmitting}
          className="w-full bg-primary hover:bg-primary/90 text-white font-bold h-12 shadow-lg"
        >
          {isSubmitting ? <Loader2 className="h-5 w-5 animate-spin mr-2" /> : <Eye className="h-5 w-5 mr-2" />}
          Review Listing
        </Button>
      </div >

      <EbayPriceLookup isOpen={showPriceLookup} onClose={() => setShowPriceLookup(false)} onPriceSelect={(p) => { form.setValue('price', p); setShowPriceLookup(false); }} searchParams={{ title: form.getValues('title'), year: form.getValues('year') }} />
    </Form >
  );
}

================================================================================
FILE: src/app/sell/dashboard/page.tsx
================================================================================

'use client';

import { useMemo, useEffect, useState } from 'react';
import { useFirebase, useCollection, useUser, useMemoFirebase } from '@/firebase';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { collection, query, where, orderBy, Timestamp } from 'firebase/firestore';
import type { Product, Review } from '@/lib/types';

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import {
  DollarSign,
  TrendingUp,
  Package,
  Star,
  Eye,
  Loader2,
  Upload,
  BarChart,
  ArrowUp,
  ArrowDown,
  MessageSquare,
} from 'lucide-react';
import Image from 'next/image';
import { formatDistanceToNow } from 'date-fns';

function DashboardSkeleton() {
  return (
    <div className="flex h-screen w-full items-center justify-center">
      <Loader2 className="h-12 w-12 animate-spin text-primary" />
    </div>
  )
}

export default function SellerDashboard() {
  const router = useRouter();
  const { firestore } = useFirebase();
  const { user, isUserLoading } = useUser();

  const userProductsQuery = useMemoFirebase(() => {
    if (!firestore || !user?.uid) return null;
    return query(collection(firestore, 'products'), where('sellerId', '==', user.uid), orderBy('createdAt', 'desc'));
  }, [firestore, user?.uid]);

  const { data: products, isLoading: productsLoading } = useCollection<Product>(userProductsQuery);

  const sellerReviewsQuery = useMemoFirebase(() => {
    if (!firestore || !user?.uid) return null;
    return query(collection(firestore, 'reviews'), where('sellerId', '==', user.uid), orderBy('createdAt', 'desc'));
  }, [firestore, user?.uid]);

  const { data: reviews, isLoading: reviewsLoading } = useCollection<Review>(sellerReviewsQuery);

  const [mockConversionRate, setMockConversionRate] = useState(0);

  useEffect(() => {
    setTimeout(() => {
      setMockConversionRate(2.5 + Math.random() * 2);
    }, 0);
  }, []);

  const stats = useMemo(() => {
    if (!products || !reviews) {
      return {
        totalRevenue: 0,
        activeListings: 0,
        averageRating: 0,
        totalReviews: 0,
        totalViews: 0,
        conversionRate: 0,
      };
    }
    const totalRevenue = products.reduce((acc, p) => acc + p.price, 0);
    const activeListings = products.length;
    const totalReviews = reviews.length;
    const averageRating = totalReviews > 0 ? reviews.reduce((acc, r) => acc + r.rating, 0) / totalReviews : 0;
    const totalViews = products.reduce((acc, p) => acc + ((p as any).views || 0), 0);

    // This is a mock conversion rate as we don't track sales yet
    const conversionRate = activeListings > 0 ? mockConversionRate : 0;

    return { totalRevenue, activeListings, averageRating, totalReviews, totalViews, conversionRate };
  }, [products, reviews, mockConversionRate]);

  useEffect(() => {
    if (!isUserLoading && !user) {
      router.push('/sign-in?redirect=/sell/dashboard');
    }
  }, [isUserLoading, user, router]);

  if (isUserLoading || productsLoading || reviewsLoading || !user) {
    return <DashboardSkeleton />;
  }

  const statCards = [
    { label: 'Potential Revenue', value: `$${stats.totalRevenue.toFixed(2)}`, change: '+12.5%', icon: DollarSign, color: 'text-green-600 bg-green-100' },
    { label: 'Active Listings', value: stats.activeListings, change: '', icon: Package, color: 'text-blue-600 bg-blue-100' },
    { label: 'Conversion Rate', value: `${stats.conversionRate.toFixed(1)}%`, change: '+1.4%', icon: TrendingUp, color: 'text-purple-600 bg-purple-100' },
    { label: 'Seller Rating', value: `${stats.averageRating.toFixed(1)}/5`, change: `(${stats.totalReviews} reviews)`, icon: Star, color: 'text-yellow-600 bg-yellow-100' },
  ];

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="container mx-auto px-4 py-8">
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
          <div>
            <h1 className="text-3xl font-bold text-gray-900">Seller Dashboard</h1>
            <p className="text-gray-600">Welcome back, {user.displayName}! Here's your business overview.</p>
          </div>
          <div className="flex gap-3 mt-4 md:mt-0">
            <Button asChild>
              <Link href="/sell/create">
                <Upload className="h-4 w-4 mr-2" />
                New Listing
              </Link>
            </Button>
          </div>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          {statCards.map((stat, index) => (
            <Card key={index}>
              <CardContent className="pt-6">
                <div className="flex items-center justify-between mb-4">
                  <div className={`${stat.color} p-2 rounded-lg`}>
                    <stat.icon className="h-5 w-5" />
                  </div>
                  {stat.change && <Badge variant={stat.change.startsWith('+') ? 'default' : 'secondary'} className="text-xs">{stat.change}</Badge>}
                </div>
                <div className="text-2xl font-bold mb-1">{stat.value}</div>
                <div className="text-sm text-gray-600">{stat.label}</div>
              </CardContent>
            </Card>
          ))}
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2">
            <Card>
              <CardHeader>
                <CardTitle>Your Listings</CardTitle>
                <CardDescription>Manage your active product listings.</CardDescription>
              </CardHeader>
              <CardContent>
                {products && products.length > 0 ? (
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>Product</TableHead>
                        <TableHead>Price</TableHead>
                        <TableHead>Views</TableHead>
                        <TableHead>Listed</TableHead>
                        <TableHead className="text-right">Actions</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {products.map(product => (
                        <TableRow key={product.id}>
                          <TableCell>
                            <div className="flex items-center gap-3">
                              <div className="relative w-12 h-12 rounded-md overflow-hidden bg-muted">
                                <Image src={product.imageUrls[0]} alt={product.title} fill className="object-cover" />
                              </div>
                              <span className="font-medium line-clamp-2">{product.title}</span>
                            </div>
                          </TableCell>
                          <TableCell>${product.price.toFixed(2)}</TableCell>
                          <TableCell>{(product as any).views || 0}</TableCell>
                          <TableCell>{product.createdAt ? formatDistanceToNow(product.createdAt instanceof Timestamp ? product.createdAt.toDate() : product.createdAt, { addSuffix: true }) : 'N/A'}</TableCell>
                          <TableCell className="text-right">
                            <Button variant="ghost" size="sm" asChild>
                              <Link href={`/product/${product.id}`}>View</Link>
                            </Button>
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <Package className="h-12 w-12 mx-auto mb-4 text-gray-300" />
                    <p>You have no active listings.</p>
                    <Button variant="outline" className="mt-4" asChild>
                      <Link href="/sell/create">Create Your First Listing</Link>
                    </Button>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
          <div>
            <Card>
              <CardHeader>
                <CardTitle>Recent Reviews</CardTitle>
                <CardDescription>Your latest feedback from buyers.</CardDescription>
              </CardHeader>
              <CardContent>
                {reviews && reviews.length > 0 ? (
                  <div className="space-y-4">
                    {reviews.slice(0, 5).map(review => (
                      <div key={review.id} className="flex gap-3">
                        <div className="flex items-center gap-1">
                          {[...Array(5)].map((_, i) => (
                            <Star key={i} className={`h-4 w-4 ${i < review.rating ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300'}`} />
                          ))}
                        </div>
                        <div className="flex-1">
                          <p className="text-sm line-clamp-2">{review.comment}</p>
                          <p className="text-xs text-muted-foreground mt-1">- {review.buyerName} on "{review.productTitle}"</p>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <MessageSquare className="h-12 w-12 mx-auto mb-4 text-gray-300" />
                    <p>No reviews yet.</p>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/sell/page.tsx
================================================================================
'use client';

import Link from 'next/link';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { CreditCard, Gem, Upload, Layers, CheckCircle, Sparkles, Shield, FileText, Loader2 } from 'lucide-react';
import { StaggerContainer, FadeIn } from '@/components/animations/FadeIn';
import { useUserPermissions } from '@/hooks/use-user-permissions';

export default function SellPage() {
    const { isSuperAdmin, canSell, isLoading } = useUserPermissions();

    const sellingOptions = [
        {
            icon: Upload,
            title: "Create a Listing",
            description: "Manually list any collectible. Perfect for single, unique items.",
            href: "/sell/create",
            cta: "List an Item"
        },
        {
            icon: FileText,
            title: "Bulk CSV Lister",
            description: "Upload a CSV file with image names to create multiple listings at once.",
            href: "/sell/bulk-csv-lister",
            cta: "Bulk Upload"
        },
        {
            icon: Layers,
            title: "Bulk AI Lister",
            description: "Upload photos of multiple items and let AI generate listings for you.",
            href: "/sell/bulk-lister",
            cta: "List in Bulk"
        },
        {
            icon: Gem,
            title: "Sell Coins & Bullion",
            description: "Specialized tools and categories for numismatics and precious metals.",
            href: "/sell/create?type=Coins",
            cta: "Sell Coins"
        }
    ];

    const features = [
        { icon: Sparkles, text: "AI-powered pricing and descriptions" },
        { icon: CheckCircle, text: "Access to a trusted community of collectors" },
        { icon: Layers, text: "Tools for bulk listing and management" },
    ];

    if (isLoading) {
        return (
            <div className="flex h-screen items-center justify-center">
                <Loader2 className="h-12 w-12 animate-spin text-primary" />
            </div>
        );
    }

    if (!isSuperAdmin && !canSell) {
        return (
            <div className="min-h-screen bg-gradient-to-b from-gray-50 via-white to-gray-50">
                 <main className="container mx-auto px-4 py-12 md:py-20 text-center">
                    <div className="max-w-2xl mx-auto">
                        <FadeIn>
                             <div className="mx-auto bg-primary/10 p-6 rounded-full w-fit mb-6">
                                <Shield className="h-12 w-12 text-primary" />
                            </div>
                            <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-gray-900 font-headline">
                                Viewing Mode
                            </h1>
                            <p className="mt-6 text-lg text-muted-foreground">
                                Product listing is currently restricted to administrators. You can browse and purchase items from our curated collections.
                            </p>
                            <Button asChild size="lg" className="mt-8">
                                <Link href="/browse">Browse Collectibles</Link>
                            </Button>
                        </FadeIn>
                    </div>
                </main>
            </div>
        )
    }

    return (
        <div className="min-h-screen bg-gradient-to-b from-gray-50 via-white to-gray-50">
            <main className="container mx-auto px-4 py-12 md:py-20">
                <div className="text-center max-w-3xl mx-auto">
                    <FadeIn>
                        <h1 className="text-4xl md:text-6xl font-bold tracking-tight text-gray-900 font-headline">
                            Turn Your Collection into Cash
                        </h1>
                        <p className="mt-6 text-lg md:text-xl text-muted-foreground">
                            Picksy provides powerful, AI-driven tools to make selling your collectibles faster and more profitable than ever before.
                        </p>
                         <Button asChild size="lg" className="mt-8">
                            <Link href="/sell/dashboard">View My Listings</Link>
                        </Button>
                    </FadeIn>
                </div>

                <StaggerContainer className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-16">
                    {sellingOptions.map((option, i) => (
                        <FadeIn key={option.title} delay={i * 0.1}>
                            <Card className="h-full flex flex-col text-center hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                                <CardHeader className="flex-1">
                                    <div className="mx-auto bg-primary/10 p-4 rounded-full w-fit mb-4">
                                        <option.icon className="h-8 w-8 text-primary" />
                                    </div>
                                    <CardTitle>{option.title}</CardTitle>
                                    <p className="text-sm text-muted-foreground pt-2">{option.description}</p>
                                </CardHeader>
                                <CardContent>
                                    <Button className="w-full" asChild>
                                        <Link href={option.href}>{option.cta}</Link>
                                    </Button>
                                </CardContent>
                            </Card>
                        </FadeIn>
                    ))}
                </StaggerContainer>

                <FadeIn delay={0.5} className="mt-20">
                    <div className="text-center max-w-2xl mx-auto">
                        <h2 className="text-3xl font-bold text-gray-900">Why Sell on Picksy?</h2>
                        <ul className="mt-8 space-y-4 text-left">
                            {features.map((feature, i) => (
                                <li key={i} className="flex items-center gap-3 bg-white p-4 rounded-lg border">
                                    <feature.icon className="h-6 w-6 text-green-500" />
                                    <span className="text-md text-gray-700">{feature.text}</span>
                                </li>
                            ))}
                        </ul>
                    </div>
                </FadeIn>
            </main>
        </div>
    );
}

================================================================================
FILE: src/app/sell/review/page.tsx
================================================================================
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import { useToast } from '@/hooks/use-toast';
import { useUser } from '@/firebase';
import { Loader2, Package, Send, ArrowLeft, ShieldCheck, Check, Info } from 'lucide-react';
import type { Product } from '@/lib/types';
import { getDraftListing, publishListing } from '@/app/actions/sell';
import { useSearchParams } from 'next/navigation';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';

type ListingFormData = Omit<Product, 'id' | 'sellerId' | 'sellerName' | 'sellerEmail' | 'sellerAvatar' | 'createdAt' | 'updatedAt' | 'views'> & {
  imageUrls: string[];
};

function ReviewPageSkeleton() {
  return (
    <div className="flex justify-center items-center h-screen">
      <Loader2 className="h-12 w-12 animate-spin text-primary" />
    </div>
  );
}

function ReviewPageContent() {
  const router = useRouter();
  const { toast } = useToast();
  const { user } = useUser();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitAction, setSubmitAction] = useState<'publish' | 'draft' | null>(null);
  const [listingData, setListingData] = useState<ListingFormData | null>(null);

  const searchParams = useSearchParams();
  const draftId = searchParams.get('draftId');

  useEffect(() => {
    if (!user || !draftId) return;

    const loadDraft = async () => {
      try {
        const data = await getDraftListing(draftId, user.uid);
        if (data) {
          setListingData(data);
        } else {
          router.replace('/sell/create');
        }
      } catch (error) {
        console.error("Failed to load draft:", error);
        toast({ title: "Error loading draft", variant: "destructive" });
        router.replace('/sell/create');
      }
    };
    loadDraft();
  }, [user, draftId, router]);

  const handleSubmit = async (asDraft: boolean) => {
    if (!listingData || !draftId || !user) return;

    setSubmitAction(asDraft ? 'draft' : 'publish');
    setIsSubmitting(true);

    try {
      if (asDraft) {
        // It's already saved as a draft on creation/update
        toast({ title: 'Listing saved as a draft!' });
        router.push(`/sell/dashboard`);
      } else {
        // Publish
        await publishListing(draftId, user.uid);
        toast({ title: 'Listing Published Successfully!' });
        router.push(`/product/${draftId}`);
      }
    } catch (error: any) {
      console.error("Publish error:", error);
      toast({ title: 'Failed to publish listing', description: error.message, variant: 'destructive' });
    } finally {
      setIsSubmitting(false);
      setSubmitAction(null);
    }
  };

  if (!listingData) {
    return <ReviewPageSkeleton />;
  }

  const { title, description, price, imageUrls, category, subCategory, condition, year, manufacturer, cardNumber, isVault } = listingData;

  return (
    <main className="flex-1 max-w-[960px] mx-auto w-full px-6 py-8">
      <div className="flex items-center gap-2 mb-6">
        <Button variant="ghost" size="sm" onClick={() => router.back()} className="text-muted-foreground">
          <ArrowLeft className="mr-2 h-4 w-4" /> Back to Edit
        </Button>
      </div>

      <div className="flex flex-col gap-2 mb-10">
        <h1 className="text-4xl font-black leading-tight tracking-tight text-foreground">Review Your Listing</h1>
        <p className="text-lg text-muted-foreground">This is how your listing will appear to buyers. Publish when you're ready.</p>
      </div>

      <div className="bg-white dark:bg-gray-900 rounded-xl overflow-hidden shadow-xl shadow-primary/5 border border-gray-100 dark:border-gray-800 mb-10">
        <div className="flex flex-col md:flex-row">
          <div className="md:w-1/2 relative group">
            <div className="aspect-square bg-muted relative">
              <Image 
                src={imageUrls[0]} 
                alt={title} 
                fill 
                className="object-cover" 
                sizes="(max-width: 768px) 100vw, 50vw"
              />
            </div>
            {imageUrls.length > 1 && (
              <div className="absolute bottom-4 left-4 flex gap-2">
                <span className="bg-black/70 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold tracking-wider text-white shadow-sm border border-white/20">
                  + {imageUrls.length - 1} Photos
                </span>
              </div>
            )}
          </div>

          <div className="md:w-1/2 p-8 flex flex-col justify-between">
            <div>
              <div className="flex items-center gap-2 mb-4">
                <span className="bg-primary/10 text-primary px-3 py-1 rounded-full text-xs font-bold tracking-wide flex items-center gap-1">
                  <Check className="h-3 w-3" />
                  PREVIEW
                </span>
                {isVault && (
                  <span className="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-xs font-bold tracking-wide flex items-center gap-1 border border-emerald-200">
                    <ShieldCheck className="h-3 w-3" />
                    VAULT PROTECTED
                  </span>
                )}
              </div>
              <h2 className="text-2xl font-bold mb-4 leading-tight">{title}</h2>

              <div className="grid grid-cols-2 gap-4 mb-8">
                {condition && (
                  <div className="p-3 bg-background rounded-lg border">
                    <p className="text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-1">Condition</p>
                    <p className="text-lg font-semibold">{condition}</p>
                  </div>
                )}
                {year && (
                  <div className="p-3 bg-background rounded-lg border">
                    <p className="text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-1">Year</p>
                    <p className="text-lg font-semibold">{year}</p>
                  </div>
                )}
                {(category || subCategory) && (
                  <div className="p-3 bg-background rounded-lg border col-span-2">
                    <p className="text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-1">Category</p>
                    <p className="text-base font-semibold flex items-center gap-2">
                      {category} {subCategory && `/ ${subCategory}`}
                    </p>
                  </div>
                )}
              </div>
            </div>
            <div>
              <p className="text-sm font-medium text-muted-foreground mb-1">Listing Price</p>
              <p className="text-4xl font-black text-primary">${Number(price || 0).toFixed(2)}</p>
            </div>
          </div>
        </div>
      </div>

      <div className="space-y-3">
        <h2 className="text-xl font-bold">Shipping &amp; Logistics</h2>
        <div className="bg-white dark:bg-gray-900 rounded-xl border border-gray-100 dark:border-gray-800 divide-y divide-gray-100 dark:divide-gray-800">
          <div className="p-4 flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="size-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                <Info className="h-5 w-5" />
              </div>
              <div>
                <p className="text-sm font-bold">Logistics</p>
                <p className="text-sm text-muted-foreground">Shipping and returns are managed between buyer and seller.</p>
              </div>
            </div>
          </div>
        </div>
      </div>


      <div className="flex flex-col sm:flex-row items-center gap-4 justify-center py-6 mt-10 border-t">
        <Button onClick={() => handleSubmit(false)} disabled={isSubmitting} className="w-full sm:w-auto min-w-[240px] px-8 py-4 text-lg font-bold rounded-xl shadow-lg shadow-primary/20 hover:bg-primary/90 transition-all active:scale-95 flex items-center justify-center gap-2 h-16">
          {isSubmitting && submitAction === 'publish' ? <Loader2 className="animate-spin" /> : <Send />}
          Publish Listing
        </Button>
        <Button variant="outline" onClick={() => handleSubmit(true)} disabled={isSubmitting} className="w-full sm:w-auto px-8 py-4 text-lg font-semibold rounded-xl h-16">
          {isSubmitting && submitAction === 'draft' ? <Loader2 className="animate-spin" /> : <Package />}
          Save as Draft
        </Button>
      </div>
      <p className="text-center text-xs text-gray-400 mt-6">By publishing, you agree to Picksy's Seller Terms of Service and Privacy Policy.</p>
    </main>
  );
}

export default function ReviewPage() {
  return (
    <Suspense fallback={<ReviewPageSkeleton />}>
      <ReviewPageContent />
    </Suspense>
  );
}
================================================================================
FILE: src/app/seller/[id]/page.tsx
================================================================================

'use client';

import { useState, useEffect, useMemo } from 'react';
import { usePathname } from 'next/navigation';
import { doc, getDoc, collection, query, where, getDocs, orderBy, addDoc, serverTimestamp } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import type { Product, UserProfile, Review } from '@/lib/types';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Skeleton } from '@/components/ui/skeleton';
import { Star, Mail, ShieldCheck, ShoppingBag, MessageSquare, Info } from 'lucide-react';
import ProductGrid from '@/components/products/ProductGrid';
import { useFirebase, useCollection, useMemoFirebase, useDoc } from '@/firebase';
import ReviewList from '@/components/reviews/ReviewList';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { useRouter } from 'next/navigation';
import { useUser } from '@/firebase';
import { toast } from '@/hooks/use-toast';
import Link from 'next/link';

// Define types
interface Seller extends UserProfile {
    rating?: number;
    totalSales?: number;
    isVerified?: boolean;
    responseTime?: string;
    joinDate?: string;
    description?: string;
}

function SellerProfileSkeleton() {
  return (
    <div className="container py-8 md:py-12">
      <div className="grid grid-cols-1 lg:grid-cols-4 gap-8 lg:gap-12">
        <div className="lg:col-span-1">
          <Card>
            <CardContent className="p-6 text-center flex flex-col items-center">
              <Skeleton className="h-28 w-28 rounded-full mb-4" />
              <Skeleton className="h-8 w-3/4 mb-2" />
              <Skeleton className="h-4 w-1/2" />
            </CardContent>
          </Card>
        </div>
        <div className="lg:col-span-3">
          <Skeleton className="h-10 w-full max-w-sm mb-6" />
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
              {[...Array(6)].map((_, i) => <Skeleton key={i} className="aspect-square h-48 w-full" />)}
          </div>
        </div>
      </div>
    </div>
  );
}

export default function SellerPage() {
  const pathname = usePathname();
  const router = useRouter();
  const sellerId = pathname.split('/').pop() || '';
  
  const { firestore } = useFirebase();
  const { user } = useUser();

  const sellerRef = useMemoFirebase(() => sellerId ? doc(db, 'users', sellerId) : null, [sellerId]);
  const { data: seller, isLoading: loadingSeller } = useDoc<Seller>(sellerRef);

  const reviewsQuery = useMemoFirebase(() => {
    if (!firestore || !sellerId) return null;
    return query(
      collection(firestore, 'reviews'),
      where('sellerId', '==', sellerId),
      orderBy('createdAt', 'desc')
    );
  }, [firestore, sellerId]);
  const { data: reviews, isLoading: reviewsLoading } = useCollection<Review>(reviewsQuery);
  
  const productsQuery = useMemoFirebase(() => {
    if (!firestore || !sellerId) return null;
    return query(
        collection(db, 'products'), 
        where('sellerId', '==', sellerId),
        where('isDraft', '!=', true)
    );
  }, [firestore, sellerId]);
  const { data: products, isLoading: loadingProducts } = useCollection<Product>(productsQuery);


  const averageRating = reviews && reviews.length > 0
    ? reviews.reduce((acc, review) => acc + review.rating, 0) / reviews.length
    : 0;

   const handleStartConversation = async () => {
        if (!user || !seller) {
            if (!user) router.push(`/sign-in?redirect=/seller/${sellerId}`);
            return;
        }

        if (user.uid === seller.id) {
            toast({ title: "You can't message yourself.", variant: 'destructive' });
            return;
        }

        const conversationQuery = query(
            collection(db, 'conversations'),
            where('participantIds', 'array-contains', user.uid)
        );

        const querySnapshot = await getDocs(conversationQuery);
        let existingConversation: any = null;

        querySnapshot.forEach(doc => {
            const data = doc.data();
            if (data.participantIds.includes(seller.id)) {
                existingConversation = { id: doc.id, ...data };
            }
        });

        if (existingConversation) {
            router.push(`/messages/${existingConversation.id}`);
        } else {
            const newConversationRef = await addDoc(collection(db, 'conversations'), {
                participantIds: [user.uid, seller.id],
                participants: {
                    [user.uid]: {
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                    },
                    [seller.id]: {
                        displayName: seller.displayName,
                        photoURL: seller.photoURL,
                    }
                },
                lastMessage: {
                    text: `New conversation with ${seller.displayName}`,
                    senderId: user.uid,
                    timestamp: serverTimestamp(),
                },
                createdAt: serverTimestamp(),
            });
            router.push(`/messages/${newConversationRef.id}`);
        }
    };

  if (loadingSeller || loadingProducts) return <SellerProfileSkeleton />;

  if (!seller) {
    return (
      <div className="container py-12 text-center">
        <h1 className="text-2xl font-bold">Seller not found</h1>
        <p className="text-muted-foreground mt-2">The seller you are looking for does not exist.</p>
      </div>
    );
  }

  const getInitials = (name?: string | null) => {
    if (!name) return 'S';
    const names = name.split(' ');
    if (names.length > 1) {
      return names[0][0] + names[names.length - 1][0];
    }
    return name[0];
  };

  const joinDate = seller.createdAt?.toDate().toLocaleDateString() || new Date().toLocaleDateString();

  return (
    <div className="bg-gray-50 min-h-screen">
      <div className="container py-8 md:py-12">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-8 lg:gap-12">
          {/* Left Sidebar */}
          <div className="lg:col-span-1">
            <Card className="sticky top-24">
              <CardContent className="p-6 text-center flex flex-col items-center">
                <Avatar className="h-28 w-28 mb-4 border-4 border-white shadow-md">
                  <AvatarImage src={seller.photoURL || ''} alt={seller.displayName || 'Seller'} />
                  <AvatarFallback className="text-4xl">{getInitials(seller.displayName)}</AvatarFallback>
                </Avatar>
                <h1 className="text-2xl font-bold font-headline">{seller.displayName}</h1>
                <p className="text-sm text-muted-foreground">Joined {joinDate}</p>

                <div className="flex items-center gap-2 mt-4">
                  <div className="flex items-center gap-1">
                    <Star className="h-5 w-5 fill-yellow-400 text-yellow-400" />
                    <span className="font-bold">{averageRating.toFixed(1)}</span>
                  </div>
                  <span className="text-muted-foreground text-sm">({reviews?.length || 0} reviews)</span>
                </div>
                
                {seller.isVerified && (
                    <div className="flex items-center gap-2 mt-2 text-blue-600">
                        <ShieldCheck className="h-5 w-5" />
                        <span className="text-sm font-medium">Verified Seller</span>
                    </div>
                )}
                
                <Button className="w-full mt-6" onClick={handleStartConversation}>
                    <Mail className="mr-2 h-4 w-4" /> Message Seller
                </Button>
                 {seller.bio && (
                  <div className="text-left w-full mt-6 pt-4 border-t">
                    <h4 className="font-semibold text-sm mb-2 text-muted-foreground">About Me</h4>
                    <p className="text-sm text-gray-600">{seller.bio}</p>
                  </div>
                 )}
              </CardContent>
            </Card>
          </div>

          {/* Right Content */}
          <div className="lg:col-span-3">
            <Tabs defaultValue="listings">
                <TabsList className="grid w-full grid-cols-2 max-w-sm">
                    <TabsTrigger value="listings"><ShoppingBag className="w-4 h-4 mr-2"/>Listings ({products?.length || 0})</TabsTrigger>
                    <TabsTrigger value="reviews"><MessageSquare className="w-4 h-4 mr-2"/>Reviews ({reviews?.length || 0})</TabsTrigger>
                </TabsList>
                <TabsContent value="listings" className="mt-8">
                    {products && products.length > 0 ? (
                        <ProductGrid products={products} />
                    ) : (
                        <div className="text-center py-16 border-2 border-dashed rounded-lg">
                            <p className="text-muted-foreground">This seller has no active listings.</p>
                        </div>
                    )}
                </TabsContent>
                <TabsContent value="reviews" className="mt-8">
                    <ReviewList reviews={reviews || []} isLoading={reviewsLoading} />
                </TabsContent>
            </Tabs>
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/seller/dashboard/page.tsx
================================================================================

'use client';

import { useMemo, useEffect, useState } from 'react';
import { useFirebase, useCollection, useUser, useMemoFirebase } from '@/firebase';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { collection, query, where, orderBy, Timestamp } from 'firebase/firestore';
import type { Product, Review } from '@/lib/types';

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import {
  DollarSign,
  TrendingUp,
  Package,
  Star,
  Eye,
  Loader2,
  Upload,
  BarChart,
  ArrowUp,
  ArrowDown,
  MessageSquare,
} from 'lucide-react';
import Image from 'next/image';
import { formatDistanceToNow } from 'date-fns';

function DashboardSkeleton() {
  return (
    <div className="flex h-screen w-full items-center justify-center">
      <Loader2 className="h-12 w-12 animate-spin text-primary" />
    </div>
  )
}

export default function SellerDashboard() {
  const router = useRouter();
  const { firestore } = useFirebase();
  const { user, isUserLoading } = useUser();

  const userProductsQuery = useMemoFirebase(() => {
    if (!firestore || !user?.uid) return null;
    return query(collection(firestore, 'products'), where('sellerId', '==', user.uid), orderBy('createdAt', 'desc'));
  }, [firestore, user?.uid]);

  const { data: products, isLoading: productsLoading } = useCollection<Product>(userProductsQuery);

  const sellerReviewsQuery = useMemoFirebase(() => {
    if (!firestore || !user?.uid) return null;
    return query(collection(firestore, 'reviews'), where('sellerId', '==', user.uid), orderBy('createdAt', 'desc'));
  }, [firestore, user?.uid]);

  const { data: reviews, isLoading: reviewsLoading } = useCollection<Review>(sellerReviewsQuery);

  const [mockConversionRate, setMockConversionRate] = useState(0);

  useEffect(() => {
    setTimeout(() => {
      setMockConversionRate(2.5 + Math.random() * 2);
    }, 0);
  }, []);

  const stats = useMemo(() => {
    if (!products || !reviews) {
      return {
        totalRevenue: 0,
        activeListings: 0,
        averageRating: 0,
        totalReviews: 0,
        totalViews: 0,
        conversionRate: 0,
      };
    }
    const totalRevenue = products.reduce((acc, p) => acc + p.price, 0);
    const activeListings = products.length;
    const totalReviews = reviews.length;
    const averageRating = totalReviews > 0 ? reviews.reduce((acc, r) => acc + r.rating, 0) / totalReviews : 0;
    const totalViews = products.reduce((acc, p) => acc + ((p as any).views || 0), 0);

    // This is a mock conversion rate as we don't track sales yet
    const conversionRate = activeListings > 0 ? mockConversionRate : 0;

    return { totalRevenue, activeListings, averageRating, totalReviews, totalViews, conversionRate };
  }, [products, reviews, mockConversionRate]);

  useEffect(() => {
    if (!isUserLoading && !user) {
      router.push('/sign-in?redirect=/sell/dashboard');
    }
  }, [isUserLoading, user, router]);

  if (isUserLoading || productsLoading || reviewsLoading || !user) {
    return <DashboardSkeleton />;
  }

  const statCards = [
    { label: 'Potential Revenue', value: `$${stats.totalRevenue.toFixed(2)}`, change: '+12.5%', icon: DollarSign, color: 'text-green-600 bg-green-100' },
    { label: 'Active Listings', value: stats.activeListings, change: '', icon: Package, color: 'text-blue-600 bg-blue-100' },
    { label: 'Conversion Rate', value: `${stats.conversionRate.toFixed(1)}%`, change: '+1.4%', icon: TrendingUp, color: 'text-purple-600 bg-purple-100' },
    { label: 'Seller Rating', value: `${stats.averageRating.toFixed(1)}/5`, change: `(${stats.totalReviews} reviews)`, icon: Star, color: 'text-yellow-600 bg-yellow-100' },
  ];

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="container mx-auto px-4 py-8">
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
          <div>
            <h1 className="text-3xl font-bold text-gray-900">Seller Dashboard</h1>
            <p className="text-gray-600">Welcome back, {user.displayName}! Here's your business overview.</p>
          </div>
          <div className="flex gap-3 mt-4 md:mt-0">
            <Button asChild>
              <Link href="/sell/create">
                <Upload className="h-4 w-4 mr-2" />
                New Listing
              </Link>
            </Button>
          </div>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          {statCards.map((stat, index) => (
            <Card key={index}>
              <CardContent className="pt-6">
                <div className="flex items-center justify-between mb-4">
                  <div className={`${stat.color} p-2 rounded-lg`}>
                    <stat.icon className="h-5 w-5" />
                  </div>
                  {stat.change && <Badge variant={stat.change.startsWith('+') ? 'default' : 'secondary'} className="text-xs">{stat.change}</Badge>}
                </div>
                <div className="text-2xl font-bold mb-1">{stat.value}</div>
                <div className="text-sm text-gray-600">{stat.label}</div>
              </CardContent>
            </Card>
          ))}
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2">
            <Card>
              <CardHeader>
                <CardTitle>Your Listings</CardTitle>
                <CardDescription>Manage your active product listings.</CardDescription>
              </CardHeader>
              <CardContent>
                {products && products.length > 0 ? (
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>Product</TableHead>
                        <TableHead>Price</TableHead>
                        <TableHead>Views</TableHead>
                        <TableHead>Listed</TableHead>
                        <TableHead className="text-right">Actions</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {products.map(product => (
                        <TableRow key={product.id}>
                          <TableCell>
                            <div className="flex items-center gap-3">
                              <div className="relative w-12 h-12 rounded-md overflow-hidden bg-muted">
                                <Image src={product.imageUrls[0]} alt={product.title} fill className="object-cover" />
                              </div>
                              <span className="font-medium line-clamp-2">{product.title}</span>
                            </div>
                          </TableCell>
                          <TableCell>${product.price.toFixed(2)}</TableCell>
                          <TableCell>{(product as any).views || 0}</TableCell>
                          <TableCell>{product.createdAt ? formatDistanceToNow(product.createdAt instanceof Timestamp ? product.createdAt.toDate() : product.createdAt, { addSuffix: true }) : 'N/A'}</TableCell>
                          <TableCell className="text-right">
                            <Button variant="ghost" size="sm" asChild>
                              <Link href={`/product/${product.id}`}>View</Link>
                            </Button>
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <Package className="h-12 w-12 mx-auto mb-4 text-gray-300" />
                    <p>You have no active listings.</p>
                    <Button variant="outline" className="mt-4" asChild>
                      <Link href="/sell/create">Create Your First Listing</Link>
                    </Button>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
          <div>
            <Card>
              <CardHeader>
                <CardTitle>Recent Reviews</CardTitle>
                <CardDescription>Your latest feedback from buyers.</CardDescription>
              </CardHeader>
              <CardContent>
                {reviews && reviews.length > 0 ? (
                  <div className="space-y-4">
                    {reviews.slice(0, 5).map(review => (
                      <div key={review.id} className="flex gap-3">
                        <div className="flex items-center gap-1">
                          {[...Array(5)].map((_, i) => (
                            <Star key={i} className={`h-4 w-4 ${i < review.rating ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300'}`} />
                          ))}
                        </div>
                        <div className="flex-1">
                          <p className="text-sm line-clamp-2">{review.comment}</p>
                          <p className="text-xs text-muted-foreground mt-1">- {review.buyerName} on "{review.productTitle}"</p>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <MessageSquare className="h-12 w-12 mx-auto mb-4 text-gray-300" />
                    <p>No reviews yet.</p>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/sitemap.ts
================================================================================

import { MetadataRoute } from 'next';
import { getCategories } from '@/lib/firebase/firestore';

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://picksy.com.au';

  // Key static routes that should be indexed
  const staticRoutes: MetadataRoute.Sitemap = [
    '',
    '/browse',
    '/sell',
    '/about',
    '/how-it-works',
    '/safety-tips',
    '/donate',
    '/vault',
    '/collector-cards',
    '/collector-cards/sports',
    '/collector-cards/trading',
    '/coins',
    '/coins/bullion',
    '/coins/notes',
    '/collectibles',
    '/collectibles/comics',
    '/general',
    '/consign',
    '/terms',
    '/privacy',
    '/dmca',
    '/prohibited-items'
  ].map((route) => ({
    url: `${baseUrl}${route}`,
    lastModified: new Date(),
    changeFrequency: 'daily' as const,
    priority: route === '' ? 1 : 0.8,
  }));

  const categories = await getCategories();
  const categoryRoutes: MetadataRoute.Sitemap = categories
    .filter(category => category.slug)
    .map((category) => ({
      url: `${baseUrl}/${category.slug}`,
      lastModified: new Date(),
      changeFrequency: 'weekly' as const,
      priority: 0.7,
    }));


  // In a real application, you would also programmatically fetch all product IDs
  // to add dynamic product pages to the sitemap. This would require a more
  // advanced, paginated sitemap generation strategy for performance.
  // For example:
  // const products = await getAllProductIds();
  // const productRoutes = products.map(id => ({ url: `${baseUrl}/product/${id}`, ... }));

  return [...staticRoutes, ...categoryRoutes];
}

================================================================================
FILE: src/app/terms/page.tsx
================================================================================

import { PageHeader } from "@/components/layout/PageHeader";

export default function TermsPage() {
  return (
    <div className="container py-12 md:py-16">
      <PageHeader
        title="Terms of Service"
        description="Last Updated: October 26, 2023"
      />
      <div className="prose lg:prose-lg max-w-4xl mx-auto mt-8">
        <h2>1. Agreement to Terms</h2>
        <p>
          By using our Service, you agree to be bound by these Terms. If you
          donâ€™t agree to be bound by these Terms, do not use the Service.
        </p>
        
        <h2>2. Privacy Policy</h2>
        <p>
          Please refer to our Privacy Policy for information on how we collect,
          use and disclose information from our users. You acknowledge and
          agree that your use of the Service is subject to our Privacy Policy.
        </p>

        <h2>3. Content Ownership</h2>
        <p>
            We do not claim any ownership rights in any User Content and nothing in these Terms will be deemed to restrict any rights that you may have to use and exploit your User Content.
        </p>
        
        <h2>4. Prohibitions</h2>
        <p>You agree not to do any of the following:</p>
        <ul>
          <li>Post, upload, publish, submit or transmit any Content that: (i) infringes, misappropriates or violates a third partyâ€™s patent, copyright, trademark, trade secret, moral rights or other intellectual property rights, or rights of publicity or privacy; (ii) violates, or encourages any conduct that would violate, any applicable law or regulation or would give rise to civil liability;</li>
          <li>Use, display, mirror or frame the Service or any individual element within the Service, Picksyâ€™s name, any Picksy trademark, logo or other proprietary information, or the layout and design of any page or form contained on a page, without Picksyâ€™s express written consent;</li>
        </ul>
        
        <h2>5. Termination</h2>
        <p>
            We may terminate your access to and use of the Service, at our sole discretion, at any time and without notice to you.
        </p>

        <h2>Contact Us</h2>
        <p>
          If you have any questions about these Terms, please contact us at legal@picksy.com.
        </p>
      </div>
    </div>
  );
}

================================================================================
FILE: src/app/vault/page.tsx
================================================================================
'use client';

import { PageHeader } from "@/components/layout/PageHeader";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
import { ShieldCheck, PackageCheck, Lock, CheckCircle2, DollarSign, Search, Truck, ArrowRight, UserCheck, CreditCard } from "lucide-react";
import Image from "next/image";
import Link from "next/link";
import { motion } from "framer-motion";

export default function VaultPage() {
  return (
    <div className="bg-slate-50 min-h-screen">
      {/* Hero Section */}
      <section className="relative bg-slate-900 text-white overflow-hidden">
        <div className="absolute inset-0 z-0 opacity-40">
           <Image 
              src="https://images.unsplash.com/photo-1621360841012-3f82413a967e?q=80&w=2070&auto=format&fit=crop"
              alt="Secure vault background"
              fill
              className="object-cover"
              priority
           />
           <div className="absolute inset-0 bg-gradient-to-r from-slate-900 via-slate-900/90 to-slate-900/60" />
        </div>

        <div className="container relative z-10 py-20 md:py-32 flex flex-col md:flex-row items-center gap-12">
          <div className="flex-1 space-y-8">
            <motion.div 
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5 }}
              className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 font-semibold text-sm"
            >
              <ShieldCheck className="h-4 w-4" />
              <span>Official Middle-Man Service</span>
            </motion.div>
            
            <motion.h1 
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: 0.1 }}
              className="text-4xl md:text-6xl font-black leading-tight tracking-tight"
            >
              The Safest Way to Trade <br/>
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400">
                Collectibles in Australia.
              </span>
            </motion.h1>

            <motion.p 
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: 0.2 }}
              className="text-lg md:text-xl text-slate-300 max-w-2xl leading-relaxed"
            >
              We act as the unbiased middle-man. We hold the money, verify the product, and ensure both buyer and seller are 100% protected. No scams. No chargebacks. Just peace of mind.
            </motion.p>

            <motion.div 
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: 0.3 }}
              className="flex flex-col sm:flex-row gap-4"
            >
              <Button size="lg" className="h-14 px-8 text-lg font-bold bg-emerald-500 hover:bg-emerald-600 text-white rounded-full shadow-lg shadow-emerald-500/20">
                Start a Vault Transaction
              </Button>
              <Button size="lg" variant="outline" className="h-14 px-8 text-lg font-bold text-white border-slate-600 hover:bg-white/10 rounded-full">
                How It Works
              </Button>
            </motion.div>
          </div>

          <motion.div 
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ duration: 0.5, delay: 0.2 }}
            className="flex-1 w-full max-w-md"
          >
            <div className="bg-white/5 backdrop-blur-xl border border-white/10 p-8 rounded-3xl shadow-2xl">
              <div className="flex justify-between items-center mb-6">
                <div className="text-slate-300 font-medium">Service Fee</div>
                <div className="text-3xl font-bold text-white">$49.95 <span className="text-sm font-normal text-slate-400">/ transaction</span></div>
              </div>
              <div className="space-y-4">
                <FeatureRow text="Physical Item Authentication" />
                <FeatureRow text="Secure Payment Escrow" />
                <FeatureRow text="Insured Shipping" />
                <FeatureRow text="Dispute Resolution" />
              </div>
              <div className="mt-8 pt-6 border-t border-white/10 text-center">
                 <p className="text-sm text-slate-400">Available for items valued $250 - $50,000</p>
              </div>
            </div>
          </motion.div>
        </div>
      </section>

      {/* Trust Stats */}
      <div className="bg-white border-b border-slate-200">
        <div className="container py-8 grid grid-cols-2 md:grid-cols-4 gap-8">
            <StatItem label="Australian Owned" value="100%" />
            <StatItem label="Secure Transactions" value="10k+" />
            <StatItem label="Verified Sellers" value="500+" />
            <StatItem label="Money Back" value="Guarantee" />
        </div>
      </div>

      {/* How It Works - The Core Value */}
      <section className="py-20 container">
        <div className="text-center max-w-3xl mx-auto mb-16">
          <h2 className="text-3xl md:text-4xl font-black text-slate-900 mb-4">The "No-Stress" Transaction</h2>
          <p className="text-lg text-slate-600">
            We've removed the trust barrier. You don't need to trust the stranger on the internetâ€”you just need to trust Picksy.
          </p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-8 relative">
          {/* Connector Line (Desktop) */}
          <div className="hidden md:block absolute top-12 left-[12%] right-[12%] h-0.5 bg-slate-200 -z-10" />

          <ProcessStep 
            number="1" 
            title="Agreement" 
            desc="Buyer and Seller agree on a price. Buyer pays Picksy (not the seller)."
            icon={<CreditCard className="h-6 w-6 text-emerald-600" />}
          />
          <ProcessStep 
            number="2" 
            title="Ship to Vault" 
            desc="Seller ships the item to our secure Australian facility for verification."
            icon={<Truck className="h-6 w-6 text-emerald-600" />}
          />
          <ProcessStep 
            number="3" 
            title="Verification" 
            desc="Our experts inspect the item to ensure it matches the listing perfectly."
            icon={<Search className="h-6 w-6 text-emerald-600" />}
          />
          <ProcessStep 
            number="4" 
            title="Payout" 
            desc="We ship the item to the buyer and release funds to the seller instantly."
            icon={<DollarSign className="h-6 w-6 text-emerald-600" />}
          />
        </div>
      </section>

      {/* Buyer vs Seller Benefits */}
      <section className="py-20 bg-slate-100">
        <div className="container max-w-5xl">
          <Tabs defaultValue="sellers" className="w-full">
            <div className="text-center mb-12">
               <h2 className="text-3xl font-bold mb-8">Why use the Vault?</h2>
               <TabsList className="bg-white p-1 rounded-full border shadow-sm">
                  <TabsTrigger value="sellers" className="rounded-full px-8 py-3 text-base data-[state=active]:bg-emerald-500 data-[state=active]:text-white transition-all">For Sellers</TabsTrigger>
                  <TabsTrigger value="buyers" className="rounded-full px-8 py-3 text-base data-[state=active]:bg-blue-600 data-[state=active]:text-white transition-all">For Buyers</TabsTrigger>
               </TabsList>
            </div>

            <TabsContent value="sellers" className="mt-0">
               <div className="grid md:grid-cols-2 gap-12 items-center">
                  <div className="order-2 md:order-1 space-y-6">
                    <BenefitItem title="Zero Chargeback Risk" desc="Since we verify the item before shipping to the buyer, they cannot claim 'item not as described' later." />
                    <BenefitItem title="Guaranteed Payment" desc="We secure the funds BEFORE you ship. You never ship an item without knowing the money is there." />
                    <BenefitItem title="Premium Badge" desc="Listings with Vault enabled sell 3x faster because buyers feel safe." />
                    <div className="pt-4">
                      <Button className="bg-emerald-600 hover:bg-emerald-700 text-white rounded-full px-8">Start Selling Securely</Button>
                    </div>
                  </div>
                  <div className="order-1 md:order-2 relative h-[400px] rounded-2xl overflow-hidden shadow-2xl">
                     <Image src="https://images.unsplash.com/photo-1556742049-0cfed4f7a07d?q=80&w=2070&auto=format&fit=crop" alt="Seller happy" fill className="object-cover" />
                     <div className="absolute inset-0 bg-emerald-900/10" />
                  </div>
               </div>
            </TabsContent>

            <TabsContent value="buyers" className="mt-0">
               <div className="grid md:grid-cols-2 gap-12 items-center">
                  <div className="order-2 md:order-1 space-y-6">
                    <BenefitItem title="100% Authenticity Guarantee" desc="If the item is fake or not as described, we return your money instantly. Full stop." />
                    <BenefitItem title="Professional Inspection" desc="We check corners, edges, and surface conditions for cards, and authenticity for coins/memorabilia." />
                    <BenefitItem title="Secure Shipping" desc="We repackage the item in professional-grade protection for the final leg of the journey." />
                    <div className="pt-4">
                      <Button className="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-8">Browse Vault Items</Button>
                    </div>
                  </div>
                  <div className="order-1 md:order-2 relative h-[400px] rounded-2xl overflow-hidden shadow-2xl">
                     <Image src="https://images.unsplash.com/photo-1561414927-6d86591d0c4f?q=80&w=1973&auto=format&fit=crop" alt="Buyer happy" fill className="object-cover" />
                     <div className="absolute inset-0 bg-blue-900/10" />
                  </div>
               </div>
            </TabsContent>
          </Tabs>
        </div>
      </section>

      {/* FAQ */}
      <section className="py-20 container max-w-3xl">
        <h2 className="text-3xl font-bold text-center mb-12">Frequently Asked Questions</h2>
        <Accordion type="single" collapsible className="w-full space-y-4">
          <FAQItem 
            question="What is the cost?" 
            answer="We charge a flat fee of $49.95 AUD per transaction, regardless of the item's value. This covers the authentication, escrow service, and secure handling." 
          />
          <FAQItem 
            question="Who pays for shipping?" 
            answer="The seller pays to ship the item to our Vault facility. Picksy covers the insured shipping from the Vault to the Buyer." 
          />
          <FAQItem 
            question="What happens if an item fails verification?" 
            answer="If an item is deemed inauthentic or significantly not as described, we cancel the transaction. The buyer gets a full refund, and the item is returned to the seller (seller pays return shipping)." 
          />
          <FAQItem 
            question="How long does the process take?" 
            answer="Once we receive the item, verification typically takes 24-48 hours. Payouts are released immediately after verification." 
          />
        </Accordion>
      </section>

      {/* Final CTA */}
      <section className="py-24 bg-slate-900 text-white text-center">
        <div className="container max-w-4xl">
           <h2 className="text-4xl md:text-5xl font-black mb-6">Ready to trade with confidence?</h2>
           <p className="text-xl text-slate-400 mb-10 max-w-2xl mx-auto">Join thousands of Australians who trust Picksy Vault for their high-value collectibles.</p>
           <Button size="lg" className="h-16 px-12 text-xl font-bold bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-400 hover:to-cyan-400 border-0 rounded-full shadow-2xl shadow-emerald-500/20">
             Get Started Now
           </Button>
        </div>
      </section>
    </div>
  );
}

// Sub-components for cleaner code
function FeatureRow({ text }: { text: string }) {
  return (
    <div className="flex items-center gap-3 text-slate-200">
      <CheckCircle2 className="h-5 w-5 text-emerald-400 flex-shrink-0" />
      <span>{text}</span>
    </div>
  );
}

function StatItem({ label, value }: { label: string, value: string }) {
    return (
        <div className="text-center">
            <div className="text-3xl md:text-4xl font-black text-slate-900 mb-1">{value}</div>
            <div className="text-sm font-medium text-slate-500 uppercase tracking-wide">{label}</div>
        </div>
    )
}

function ProcessStep({ number, title, desc, icon }: { number: string, title: string, desc: string, icon: React.ReactNode }) {
    return (
        <div className="relative bg-white p-6 rounded-2xl shadow-lg border border-slate-100 flex flex-col items-center text-center z-10 hover:-translate-y-1 transition-transform duration-300">
            <div className="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center mb-4 border border-slate-200 shadow-sm">
                {icon}
            </div>
            <div className="absolute top-4 right-4 text-4xl font-black text-slate-100 -z-10">{number}</div>
            <h3 className="text-xl font-bold text-slate-900 mb-2">{title}</h3>
            <p className="text-sm text-slate-500 leading-relaxed">{desc}</p>
        </div>
    )
}

function BenefitItem({ title, desc }: { title: string, desc: string }) {
    return (
        <div className="flex gap-4">
            <div className="mt-1 bg-emerald-100 p-1.5 rounded-full h-fit w-fit">
                <CheckCircle2 className="h-5 w-5 text-emerald-600" />
            </div>
            <div>
                <h4 className="font-bold text-lg text-slate-900">{title}</h4>
                <p className="text-slate-600 leading-relaxed">{desc}</p>
            </div>
        </div>
    )
}

function FAQItem({ question, answer }: { question: string, answer: string }) {
    return (
        <AccordionItem value={question} className="bg-white border border-slate-200 rounded-lg px-6 shadow-sm">
            <AccordionTrigger className="text-lg font-semibold text-slate-800 hover:text-emerald-600 text-left">{question}</AccordionTrigger>
            <AccordionContent className="text-slate-600 pb-6 leading-relaxed">
                {answer}
            </AccordionContent>
        </AccordionItem>
    )
}
================================================================================
FILE: src/components/ErrorBoundary.tsx
================================================================================
'use client';
import React from 'react';
import { Button } from '@/components/ui/button';
import { AlertTriangle } from 'lucide-react';

interface ErrorBoundaryState {
    hasError: boolean;
    error?: Error;
}

export class ErrorBoundary extends React.Component<
    { children: React.ReactNode },
    ErrorBoundaryState
> {
    constructor(props: any) {
        super(props);
        this.state = { hasError: false };
    }

    static getDerivedStateFromError(error: Error): ErrorBoundaryState {
        return { hasError: true, error };
    }

    componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
        console.error('Error caught by boundary:', error, errorInfo);

        // Log to error tracking service (in production)
        if (typeof window !== 'undefined') {
            try {
                // Will implement error logging service
                fetch('/api/log-error', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        error: error.message,
                        stack: error.stack,
                        componentStack: errorInfo.componentStack,
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString(),
                    }),
                }).catch(console.error);
            } catch (e) {
                console.error('Failed to log error:', e);
            }
        }
    }

    render() {
        if (this.state.hasError) {
            return (
                <div className="flex min-h-screen items-center justify-center bg-gray-50 px-4">
                    <div className="text-center max-w-md">
                        <div className="flex justify-center mb-4">
                            <AlertTriangle className="h-16 w-16 text-red-500" />
                        </div>
                        <h1 className="text-3xl font-bold text-gray-900 mb-2">
                            Oops! Something went wrong
                        </h1>
                        <p className="text-gray-600 mb-6">
                            We've encountered an unexpected error. Don't worry, our team has been notified and we're working to fix it.
                        </p>
                        <div className="flex flex-col sm:flex-row gap-3 justify-center">
                            <Button
                                onClick={() => {
                                    this.setState({ hasError: false, error: undefined });
                                    window.location.href = '/';
                                }}
                                variant="default"
                            >
                                Return Home
                            </Button>
                            <Button
                                onClick={() => window.location.reload()}
                                variant="outline"
                            >
                                Reload Page
                            </Button>
                        </div>
                        {process.env.NODE_ENV === 'development' && this.state.error && (
                            <details className="mt-6 text-left">
                                <summary className="cursor-pointer text-sm text-gray-500 hover:text-gray-700">
                                    Error Details (Dev Only)
                                </summary>
                                <pre className="mt-2 p-4 bg-gray-100 rounded text-xs overflow-auto">
                                    {this.state.error.stack}
                                </pre>
                            </details>
                        )}
                    </div>
                </div>
            );
        }

        return this.props.children;
    }
}

================================================================================
FILE: src/components/FirebaseErrorListener.tsx
================================================================================

'use client';

import { useEffect } from 'react';
import { errorEmitter } from '@/firebase/error-emitter';
import { FirestorePermissionError } from '@/firebase/errors';

/**
 * A client-side component that listens for Firestore permission errors
 * and throws them to be caught by Next.js's development error overlay.
 * This is essential for debugging Security Rules during development.
 */
export function FirebaseErrorListener() {
  useEffect(() => {
    const handleError = (error: FirestorePermissionError) => {
      // Throwing the error here will trigger the Next.js error overlay
      // in development, showing the detailed permission error message.
      throw error;
    };

    // Subscribe to the custom 'permission-error' event
    errorEmitter.on('permission-error', handleError);

    // Clean up the subscription when the component unmounts
    return () => {
      errorEmitter.off('permission-error', handleError);
    };
  }, []); // Run this effect only once when the component mounts

  // This component does not render anything to the DOM.
  return null;
}

================================================================================
FILE: src/components/admin/StatsGrid.tsx
================================================================================
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { DollarSign, ShieldAlert, Users, Package } from "lucide-react";

interface AdminStatsGridProps {
    stats: {
        revenue: number;
        alerts: number;
        sellers: number;
        items: number;
    }
}

export function AdminStatsGrid({ stats }: AdminStatsGridProps) {
  const items = [
    { title: "Revenue", value: `$${stats.revenue.toLocaleString()}`, icon: DollarSign, color: "text-green-500" },
    { title: "Risk Alerts", value: stats.alerts, icon: ShieldAlert, color: "text-red-500" },
    { title: "Active Sellers", value: stats.sellers, icon: Users, color: "text-blue-500" },
    { title: "Total Items", value: stats.items, icon: Package, color: "text-purple-500" },
  ];
  return (
    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
      {items.map((stat) => (
        <Card key={stat.title}>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">{stat.title}</CardTitle>
            <stat.icon className={`h-4 w-4 ${stat.color}`} />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stat.value}</div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}

================================================================================
FILE: src/components/admin/management/AttributesManager.tsx
================================================================================

'use client';

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { doc, onSnapshot, updateDoc, arrayUnion, arrayRemove } from 'firebase/firestore';
import { useFirebase, useMemoFirebase, useDoc } from '@/firebase';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useToast } from '@/hooks/use-toast';
import { Loader2, Plus, Trash2, Tag } from 'lucide-react';

interface Attributes {
    conditions?: string[];
    manufacturers?: string[];
    brands?: string[];
}

const attributeSchema = z.object({
    newValue: z.string().min(1, 'Value cannot be empty'),
});

type AttributeFormValues = z.infer<typeof attributeSchema>;

type AttributeType = keyof Attributes;

const AttributeEditor = ({ title, attributeKey, data, isLoading }: { title: string, attributeKey: AttributeType, data: Attributes | null, isLoading: boolean }) => {
    const { firestore } = useFirebase();
    const { toast } = useToast();
    const [isSubmitting, setIsSubmitting] = useState(false);
    const form = useForm<AttributeFormValues>({ resolver: zodResolver(attributeSchema) });

    const values = data?.[attributeKey] || [];

    const handleAdd = async (formData: AttributeFormValues) => {
        if (!firestore) return;
        setIsSubmitting(true);
        try {
            const optionsRef = doc(firestore, 'settings', 'marketplace_options');
            await updateDoc(optionsRef, {
                [attributeKey]: arrayUnion(formData.newValue)
            });
            toast({ title: `${title} value added.` });
            form.reset({ newValue: '' });
        } catch (error: any) {
            toast({ title: 'Error', description: error.message, variant: 'destructive' });
        } finally {
            setIsSubmitting(false);
        }
    };

    const handleRemove = async (value: string) => {
        if (!firestore) return;
        try {
            const optionsRef = doc(firestore, 'settings', 'marketplace_options');
            await updateDoc(optionsRef, {
                [attributeKey]: arrayRemove(value)
            });
            toast({ title: `${title} value removed.` });
        } catch (error: any) {
            toast({ title: 'Error', description: error.message, variant: 'destructive' });
        }
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2"><Tag className="w-5 h-5 text-primary" /> {title}</CardTitle>
            </CardHeader>
            <CardContent>
                <form onSubmit={form.handleSubmit(handleAdd)} className="flex gap-2 mb-4">
                    <Input {...form.register('newValue')} placeholder={`New ${title} value...`} />
                    <Button type="submit" disabled={isSubmitting}>
                        {isSubmitting ? <Loader2 className="animate-spin h-4 w-4" /> : <Plus className="h-4 w-4" />}
                    </Button>
                </form>
                {isLoading ? (
                    <div className="flex justify-center p-4"><Loader2 className="h-6 w-6 animate-spin" /></div>
                ) : (
                    <div className="space-y-2 max-h-48 overflow-y-auto">
                        {values.map(val => (
                            <div key={val} className="flex items-center justify-between p-2 rounded bg-muted/50">
                                <span className="text-sm">{val}</span>
                                <Button size="icon" variant="ghost" className="h-7 w-7" onClick={() => handleRemove(val)}>
                                    <Trash2 className="h-4 w-4 text-destructive" />
                                </Button>
                            </div>
                        ))}
                    </div>
                )}
            </CardContent>
        </Card>
    );
};

export default function AttributesManager() {
    const { firestore } = useFirebase();
    const optionsRef = useMemoFirebase(() => firestore ? doc(firestore, 'settings', 'marketplace_options') : null, [firestore]);
    const { data, isLoading } = useDoc<Attributes>(optionsRef);
    
    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <AttributeEditor title="Conditions" attributeKey="conditions" data={data} isLoading={isLoading} />
            <AttributeEditor title="Manufacturers" attributeKey="manufacturers" data={data} isLoading={isLoading} />
            <AttributeEditor title="Brands" attributeKey="brands" data={data} isLoading={isLoading} />
        </div>
    );
}


================================================================================
FILE: src/components/admin/management/CategoriesManager.tsx
================================================================================

'use client';

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import {
  collection,
  onSnapshot,
  query,
  orderBy,
  addDoc,
  deleteDoc,
  doc,
  updateDoc,
  serverTimestamp
} from 'firebase/firestore';
import { useFirebase } from '@/firebase';
import type { Category } from '@/lib/types';
import { Card, CardContent, CardHeader, CardTitle, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Loader2, PlusCircle, Trash2, Edit } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog"

const categorySchema = z.object({
  name: z.string().min(2, 'Category name is required.'),
  section: z.string().min(2, 'Section slug is required (e.g., collector-cards).'),
  href: z.string().min(1, 'Href is required (e.g., /collector-cards/sports).')
});

type CategoryFormValues = z.infer<typeof categorySchema>;

export default function CategoriesManager() {
  const [categories, setCategories] = useState<Category[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [editingCategory, setEditingCategory] = useState<Category | null>(null);
  const { toast } = useToast();
  const { firestore } = useFirebase();

  const form = useForm<CategoryFormValues>({
    resolver: zodResolver(categorySchema),
    defaultValues: { name: '', section: '', href: '' },
  });
  
  useEffect(() => {
    if (!firestore) return;
    const q = query(collection(firestore, 'categories'), orderBy('name', 'asc'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const cats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Category));
      setCategories(cats);
      setIsLoading(false);
    }, (error) => {
        console.error("Error fetching categories: ", error);
        toast({ title: 'Failed to load categories.', description: error.message, variant: 'destructive' });
        setIsLoading(false);
    });
    return () => unsubscribe();
  }, [firestore, toast]);
  
  useEffect(() => {
    if (editingCategory) {
      form.reset(editingCategory);
    } else {
      form.reset({ name: '', section: '', href: '' });
    }
  }, [editingCategory, form]);

  const onSubmit = async (values: CategoryFormValues) => {
    if (!firestore) return;
    setIsSubmitting(true);
    try {
      if (editingCategory) {
        await updateDoc(doc(firestore, 'categories', editingCategory.id), values);
        toast({ title: 'Category updated successfully!' });
        setEditingCategory(null);
      } else {
        await addDoc(collection(firestore, 'categories'), { ...values, createdAt: serverTimestamp() });
        toast({ title: 'Category added successfully!' });
      }
      form.reset();
    } catch (error: any) {
      toast({ title: 'An error occurred.', description: error.message, variant: 'destructive' });
    } finally {
      setIsSubmitting(false);
    }
  };
  
  const deleteCategory = async (id: string) => {
    if (!firestore) return;
    try {
        await deleteDoc(doc(firestore, 'categories', id));
        toast({ title: 'Category deleted successfully.' });
    } catch (error: any) {
        toast({ title: 'Failed to delete category.', description: error.message, variant: 'destructive' });
    }
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-1">
            <Card>
            <CardHeader>
                <CardTitle>{editingCategory ? 'Edit Category' : 'Add New Category'}</CardTitle>
            </CardHeader>
            <CardContent>
                <Form {...form}>
                <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
                    <FormField control={form.control} name="name" render={({ field }) => (
                    <FormItem><FormLabel>Name</FormLabel><FormControl><Input placeholder="e.g., Sports Cards" {...field} /></FormControl><FormMessage /></FormItem>
                    )} />
                    <FormField control={form.control} name="section" render={({ field }) => (
                    <FormItem><FormLabel>Section Slug</FormLabel><FormControl><Input placeholder="e.g., collector-cards" {...field} /></FormControl><FormMessage /></FormItem>
                    )} />
                    <FormField control={form.control} name="href" render={({ field }) => (
                    <FormItem><FormLabel>Link Href</FormLabel><FormControl><Input placeholder="e.g., /collector-cards/sports" {...field} /></FormControl><FormMessage /></FormItem>
                    )} />
                    <Button type="submit" disabled={isSubmitting} className="w-full">
                    {isSubmitting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <PlusCircle className="mr-2 h-4 w-4" />}
                    {editingCategory ? 'Update Category' : 'Add Category'}
                    </Button>
                    {editingCategory && (
                        <Button variant="outline" className="w-full" onClick={() => setEditingCategory(null)}>Cancel Edit</Button>
                    )}
                </form>
                </Form>
            </CardContent>
            </Card>
        </div>
        <div className="lg:col-span-2">
            <Card>
            <CardHeader><CardTitle>Existing Categories</CardTitle></CardHeader>
            <CardContent>
                {isLoading ? (
                <div className="flex justify-center p-8"><Loader2 className="h-8 w-8 animate-spin" /></div>
                ) : (
                <Table>
                    <TableHeader>
                    <TableRow>
                        <TableHead>Name</TableHead>
                        <TableHead>Section</TableHead>
                        <TableHead>Href</TableHead>
                        <TableHead className="text-right">Actions</TableHead>
                    </TableRow>
                    </TableHeader>
                    <TableBody>
                    {categories.map((cat) => (
                        <TableRow key={cat.id}>
                        <TableCell className="font-medium">{cat.name}</TableCell>
                        <TableCell>{cat.section}</TableCell>
                        <TableCell>{cat.href}</TableCell>
                        <TableCell className="text-right space-x-1">
                            <Button variant="ghost" size="icon" onClick={() => setEditingCategory(cat)}><Edit className="h-4 w-4" /></Button>
                            <AlertDialog>
                            <AlertDialogTrigger asChild>
                                <Button variant="ghost" size="icon" className="text-destructive hover:text-destructive"><Trash2 className="h-4 w-4" /></Button>
                            </AlertDialogTrigger>
                            <AlertDialogContent>
                                <AlertDialogHeader>
                                <AlertDialogTitle>Are you sure?</AlertDialogTitle>
                                <AlertDialogDescription>
                                    This action cannot be undone. This will permanently delete the category.
                                </AlertDialogDescription>
                                </AlertDialogHeader>
                                <AlertDialogFooter>
                                <AlertDialogCancel>Cancel</AlertDialogCancel>
                                <AlertDialogAction onClick={() => deleteCategory(cat.id)} className="bg-destructive hover:bg-destructive/90">Delete</AlertDialogAction>
                                </AlertDialogFooter>
                            </AlertDialogContent>
                            </AlertDialog>
                        </TableCell>
                        </TableRow>
                    ))}
                    </TableBody>
                </Table>
                )}
            </CardContent>
            </Card>
        </div>
    </div>
  );
}

================================================================================
FILE: src/components/admin/management/MaintenanceManager.tsx
================================================================================
'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { useToast } from '@/hooks/use-toast';
import { Loader2, Trash2, Search, AlertTriangle } from 'lucide-react';
import { deleteProductByAdmin } from '@/app/actions/admin';
import { getProducts } from '@/services/product-service';
import { Product } from '@/lib/types';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';

export default function MaintenanceManager() {
    const [searchTerm, setSearchTerm] = useState('');
    const [products, setProducts] = useState<Product[]>([]);
    const [isSearching, setIsSearching] = useState(false);
    const [deletingId, setDeletingId] = useState<string | null>(null);
    const { toast } = useToast();

    const handleSearch = async () => {
        if (!searchTerm.trim()) return;
        setIsSearching(true);
        try {
            // Fetch products matching the search term
            const result = await getProducts({ q: searchTerm, page: 1, limit: 50 });
            setProducts(result.products);
            
            if (result.products.length === 0) {
                toast({
                    title: "No products found",
                    description: `No active products found matching "${searchTerm}".`,
                });
            }
        } catch (error) {
            console.error("Search error:", error);
            toast({
                variant: "destructive",
                title: "Search Failed",
                description: "Could not fetch products.",
            });
        } finally {
            setIsSearching(false);
        }
    };

    const handleDelete = async (productId: string, productTitle: string) => {
        if (!confirm(`Are you sure you want to FORCE DELETE "${productTitle}"?\nThis action cannot be undone.`)) {
            return;
        }

        setDeletingId(productId);
        try {
            const idToken = await getCurrentUserIdToken();
            if (!idToken) throw new Error("Not authenticated");

            const result = await deleteProductByAdmin(productId, idToken);
            
            if (result.success) {
                toast({
                    title: "Product Deleted",
                    description: result.message,
                });
                // Remove from list
                setProducts(prev => prev.filter(p => p.id !== productId));
            } else {
                throw new Error(result.error);
            }
        } catch (error: any) {
            toast({
                variant: "destructive",
                title: "Deletion Failed",
                description: error.message,
            });
        } finally {
            setDeletingId(null);
        }
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="text-red-600 flex items-center gap-2">
                    <AlertTriangle className="h-5 w-5" />
                    Force Delete Products
                </CardTitle>
                <CardDescription>
                    Search for specific listings (e.g., "Fix Test", "Charizard") and permanently remove them from the database. 
                    This tool bypasses standard checks and is intended for cleanup.
                </CardDescription>
            </CardHeader>
            <CardContent>
                <div className="flex gap-4 mb-6">
                    <Input 
                        placeholder="Enter product title..." 
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                    />
                    <Button onClick={handleSearch} disabled={isSearching || !searchTerm.trim()}>
                        {isSearching ? <Loader2 className="h-4 w-4 animate-spin" /> : <Search className="h-4 w-4 mr-2" />}
                        Find
                    </Button>
                </div>

                <div className="space-y-2">
                    {products.length > 0 && (
                         <div className="text-sm text-muted-foreground mb-2">Found {products.length} matching products:</div>
                    )}
                    
                    {products.map(product => (
                        <div key={product.id} className="flex items-center justify-between p-3 border rounded-lg bg-muted/20">
                            <div className="flex items-center gap-3">
                                {product.imageUrls && product.imageUrls[0] && (
                                    <div className="h-10 w-10 relative rounded overflow-hidden bg-muted">
                                        <img src={product.imageUrls[0]} alt="" className="object-cover w-full h-full" />
                                    </div>
                                )}
                                <div>
                                    <div className="font-bold">{product.title}</div>
                                    <div className="text-xs text-muted-foreground">ID: {product.id} | Price: ${product.price}</div>
                                </div>
                            </div>
                            <Button 
                                variant="destructive" 
                                size="sm" 
                                onClick={() => handleDelete(product.id, product.title)}
                                disabled={deletingId === product.id}
                            >
                                {deletingId === product.id ? <Loader2 className="h-4 w-4 animate-spin" /> : <Trash2 className="h-4 w-4" />}
                                Delete
                            </Button>
                        </div>
                    ))}
                </div>
            </CardContent>
        </Card>
    );
}

================================================================================
FILE: src/components/admin/system/AuditLogViewer.tsx
================================================================================

'use client';

import { useState, useEffect } from 'react';
import { db } from '@/lib/firebase/config';
import { collection, query, orderBy, limit, getDocs, Timestamp } from 'firebase/firestore';
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow
} from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Loader2, AlertCircle } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';

interface AuditLog {
    id: string;
    action: string;
    userId: string;
    userEmail?: string;
    details: string;
    status: 'success' | 'warning' | 'error';
    timestamp: Timestamp;
}

export function AuditLogViewer() {
    const [logs, setLogs] = useState<AuditLog[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    useEffect(() => {
        async function fetchLogs() {
            try {
                // In a real scenario, ensure this logic matches your firestore structure
                const q = query(
                    collection(db, 'audit_logs'),
                    orderBy('timestamp', 'desc'),
                    limit(20)
                );

                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    setLogs([]);
                } else {
                    const fetchedLogs = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    })) as AuditLog[];
                    setLogs(fetchedLogs);
                }
            } catch (err: any) {
                console.error("Error fetching audit logs:", err);
                // Don't show critical error to UI if collection missing, just empty
                if (err.code === 'permission-denied') {
                    setError("You do not have permission to view audit logs.");
                } else if (err.code === 'failed-precondition') {
                    // Missing index?
                    setError("Index missing for audit logs.");
                } else {
                    // Start with empty logs if collection doesn't exist or other error
                    setLogs([]);
                }
            } finally {
                setLoading(false);
            }
        }

        fetchLogs();
    }, []);

    if (loading) {
        return (
            <div className="flex justify-center items-center py-12">
                <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
            </div>
        );
    }

    if (error) {
        return (
            <div className="flex items-center justify-center py-12 text-destructive gap-2">
                <AlertCircle className="h-5 w-5" />
                <span>{error}</span>
            </div>
        );
    }

    if (logs.length === 0) {
        return (
            <div className="text-center py-12 text-muted-foreground border rounded-md bg-muted/20">
                <p>No audit logs found.</p>
                <p className="text-xs mt-1">System events will appear here.</p>
            </div>
        );
    }

    return (
        <div className="border rounded-md">
            <Table>
                <TableHeader>
                    <TableRow>
                        <TableHead>Time</TableHead>
                        <TableHead>Action</TableHead>
                        <TableHead>User</TableHead>
                        <TableHead>Status</TableHead>
                        <TableHead className="text-right">Details</TableHead>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    {logs.map((log) => (
                        <TableRow key={log.id}>
                            <TableCell className="whitespace-nowrap text-xs text-muted-foreground">
                                {log.timestamp?.toMillis ?
                                    formatDistanceToNow(log.timestamp.toMillis(), { addSuffix: true }) :
                                    'Unknown'
                                }
                            </TableCell>
                            <TableCell className="font-medium">{log.action}</TableCell>
                            <TableCell className="text-sm">{log.userEmail || log.userId || 'System'}</TableCell>
                            <TableCell>
                                <Badge variant={
                                    log.status === 'success' ? 'default' :
                                        log.status === 'error' ? 'destructive' :
                                            'secondary'
                                } className={
                                    log.status === 'success' ? 'bg-green-500 hover:bg-green-600' : ''
                                }>
                                    {log.status}
                                </Badge>
                            </TableCell>
                            <TableCell className="text-right text-sm text-muted-foreground max-w-[200px] truncate">
                                {log.details}
                            </TableCell>
                        </TableRow>
                    ))}
                </TableBody>
            </Table>
        </div>
    );
}

================================================================================
FILE: src/components/admin/system/ConnectionStatus.tsx
================================================================================

'use client';

import { useState } from 'react';
import { Card, CardContent, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { RefreshCw, CheckCircle2, XCircle, ExternalLink, HelpCircle } from "lucide-react";
import { cn } from "@/lib/utils";

interface ConnectionStatusProps {
    serviceName: string;
    endpoint: string;
    docsUrl?: string;
}

type Status = 'idle' | 'loading' | 'success' | 'error';

export function ConnectionStatus({ serviceName, endpoint, docsUrl }: ConnectionStatusProps) {
    const [status, setStatus] = useState<Status>('idle');
    const [latency, setLatency] = useState<number | null>(null);
    const [message, setMessage] = useState<string>("");

    const runTest = async () => {
        if (!endpoint) return;

        setStatus('loading');
        setMessage("");
        setLatency(null);

        try {
            const res = await fetch(endpoint);
            const data = await res.json();

            if (res.ok && (data.status === 'healthy' || data.status === 'success')) {
                setStatus('success');
                setLatency(data.latency);
            } else {
                setStatus('error');
                setLatency(data.latency);
                setMessage(data.error || data.details?.message || "Service unhealthy");
            }
        } catch (error: any) {
            console.error("Connection test failed:", error);
            setStatus('error');
            setMessage(error.message || "Network error");
        }
    };

    return (
        <Card>
            <CardHeader className="pb-3">
                <div className="flex justify-between items-start">
                    <CardTitle className="text-base font-medium">{serviceName}</CardTitle>
                    {status === 'idle' && <HelpCircle className="h-5 w-5 text-gray-400" />}
                    {status === 'success' && <CheckCircle2 className="h-5 w-5 text-green-500" />}
                    {status === 'error' && <XCircle className="h-5 w-5 text-red-500" />}
                </div>
            </CardHeader>
            <CardContent className="pb-3">
                <div className="flex items-center justify-between mb-2">
                    <span className="text-sm text-muted-foreground">Status</span>
                    <Badge variant={status === 'success' ? 'default' : status === 'error' ? 'destructive' : 'secondary'}
                        className={cn(status === 'success' && "bg-green-500 hover:bg-green-600")}>
                        {status === 'idle' ? 'Unknown' : status === 'loading' ? 'Testing...' : status === 'success' ? 'Online' : 'Offline'}
                    </Badge>
                </div>
                <div className="flex items-center justify-between">
                    <span className="text-sm text-muted-foreground">Latency</span>
                    <span className={cn("text-sm font-mono", !latency && "text-muted-foreground/50")}>
                        {latency ? `${latency}ms` : '--'}
                    </span>
                </div>
                {message && (
                    <div className={cn("mt-3 text-xs p-2 rounded", "bg-yellow-500/10 text-yellow-700")}>
                        {message}
                    </div>
                )}
            </CardContent>
            <CardFooter className="pt-0 gap-2">
                <Button
                    variant="outline"
                    size="sm"
                    className="w-full"
                    onClick={runTest}
                    disabled={status === 'loading'}
                >
                    <RefreshCw className={cn("mr-2 h-3 w-3")} />
                    Test Connection
                </Button>
                {docsUrl && (
                    <Button variant="ghost" size="icon" className="shrink-0 text-muted-foreground" asChild>
                        <a href={docsUrl} target="_blank" rel="noopener noreferrer">
                            <ExternalLink className="h-4 w-4" />
                        </a>
                    </Button>
                )}
            </CardFooter>
        </Card>
    );
}

================================================================================
FILE: src/components/admin/system/SeedDatabaseButton.tsx
================================================================================

'use client';

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Database, Loader2 } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import { auth } from "@/lib/firebase/config"; // Client SDK

export function SeedDatabaseButton() {
    const [loading, setLoading] = useState(false);
    const { toast } = useToast();

    const handleSeed = async () => {
        if (!auth.currentUser) {
            toast({
                variant: "destructive",
                title: "Authentication Required",
                description: "You must be logged in to perform this action.",
            });
            return;
        }

        setLoading(true);
        try {
            const token = await auth.currentUser.getIdToken();
            const res = await fetch('/api/admin/seed', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.error || 'Failed to seed database');
            }

            toast({
                title: "Success",
                description: data.message,
            });

        } catch (error: any) {
            toast({
                variant: "destructive",
                title: "Error",
                description: error.message,
            });
        } finally {
            setLoading(false);
        }
    };

    return (
        <Button
            onClick={handleSeed}
            disabled={loading}
            variant="outline"
        >
            {loading ? (
                <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Seeding...
                </>
            ) : (
                <>
                    <Database className="mr-2 h-4 w-4" />
                    Seed Database
                </>
            )}
        </Button>
    );
}

================================================================================
FILE: src/components/admin/users/CreateUserDialog.tsx
================================================================================

'use client';

import { useState, useTransition } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import * as z from "zod";

import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { Shield, Store, User, BadgeCheck, Loader2 } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import type { UserRole } from "@/lib/types";
import { createNewUser } from "@/app/actions/admin-users";
import { getCurrentUserIdToken } from "@/lib/firebase/auth";

const formSchema = z.object({
  displayName: z.string().min(2, "Name is required"),
  email: z.string().email("Invalid email address"),
  password: z.string().min(6, "Password must be at least 6 characters"),
  role: z.enum(['viewer', 'seller', 'admin', 'superadmin']),
});

type FormValues = z.infer<typeof formSchema>;

interface CreateUserDialogProps {
    isOpen: boolean;
    onClose: () => void;
}

export function CreateUserDialog({ isOpen, onClose }: CreateUserDialogProps) {
    const [isPending, startTransition] = useTransition();
    const { toast } = useToast();

    const form = useForm<FormValues>({
        resolver: zodResolver(formSchema),
        defaultValues: {
            displayName: "",
            email: "",
            password: "",
            role: "viewer",
        },
    });

    const onSubmit = (values: FormValues) => {
        startTransition(async () => {
            const idToken = await getCurrentUserIdToken();
            if (!idToken) {
                toast({ title: "Authentication error", variant: "destructive" });
                return;
            }
            
            const result = await createNewUser(idToken, values);

            if (result.success) {
                toast({ title: "Success!", description: result.message });
                form.reset();
                onClose();
            } else {
                toast({ title: "Error", description: result.message, variant: "destructive" });
            }
        });
    };

    return (
        <Dialog open={isOpen} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[425px]">
                <DialogHeader>
                    <DialogTitle>Create New User</DialogTitle>
                    <DialogDescription>
                        Set up a new account and assign their role on the platform.
                    </DialogDescription>
                </DialogHeader>
                <Form {...form}>
                    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4 py-4">
                        <FormField control={form.control} name="displayName" render={({ field }) => (
                            <FormItem><FormLabel>Display Name</FormLabel><FormControl><Input {...field} /></FormControl><FormMessage /></FormItem>
                        )} />
                        <FormField control={form.control} name="email" render={({ field }) => (
                            <FormItem><FormLabel>Email</FormLabel><FormControl><Input type="email" {...field} /></FormControl><FormMessage /></FormItem>
                        )} />
                        <FormField control={form.control} name="password" render={({ field }) => (
                            <FormItem><FormLabel>Password</FormLabel><FormControl><Input type="password" {...field} /></FormControl><FormMessage /></FormItem>
                        )} />
                        <FormField control={form.control} name="role" render={({ field }) => (
                            <FormItem>
                                <FormLabel>Role</FormLabel>
                                <Select onValueChange={field.onChange} defaultValue={field.value}>
                                    <FormControl><SelectTrigger><SelectValue /></SelectTrigger></FormControl>
                                    <SelectContent>
                                        <SelectItem value="viewer">Viewer</SelectItem>
                                        <SelectItem value="seller">Seller</SelectItem>
                                        <SelectItem value="admin">Admin</SelectItem>
                                        <SelectItem value="superadmin">Super Admin</SelectItem>
                                    </SelectContent>
                                </Select>
                                <FormMessage />
                            </FormItem>
                        )} />
                        <DialogFooter className="pt-4">
                            <Button variant="outline" onClick={onClose} type="button">Cancel</Button>
                            <Button type="submit" disabled={isPending}>
                                {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                                Create User
                            </Button>
                        </DialogFooter>
                    </form>
                </Form>
            </DialogContent>
        </Dialog>
    );
}

================================================================================
FILE: src/components/admin/users/UserManagementClient.tsx
================================================================================

'use client';

import { useState, useEffect, useTransition, useCallback } from 'react';
import { UserTable } from './UserTable';
import { UserRoleDialog } from './UserRoleDialog';
import { CreateUserDialog } from './CreateUserDialog';
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Search, Plus, Loader2 } from "lucide-react";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { getAllUsers, updateUserRole, toggleUserBan, type AdminUser, type ActionResponse } from '@/app/actions/admin-users';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';
import { useToast } from '@/hooks/use-toast';
import type { UserRole } from '@/lib/types';


export default function UserManagementClient() {
    const [users, setUsers] = useState<AdminUser[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [roleFilter, setRoleFilter] = useState<string>('all');
    const [isPending, startTransition] = useTransition();

    const { toast } = useToast();

    // Dialog States
    const [isRoleDialogOpen, setIsRoleDialogOpen] = useState(false);
    const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);
    const [selectedUser, setSelectedUser] = useState<AdminUser | null>(null);

    const fetchUsers = useCallback(async () => {
        setIsLoading(true);
        const idToken = await getCurrentUserIdToken();
        if (!idToken) {
            toast({ title: "Authentication Error", variant: "destructive" });
            setIsLoading(false);
            return;
        }
        const result = await getAllUsers(idToken);
        if (result.users) {
            setUsers(result.users);
        } else {
            toast({ title: "Error fetching users", description: result.error, variant: "destructive" });
        }
        setIsLoading(false);
    }, [setIsLoading, toast, setUsers]);

    useEffect(() => {
        setTimeout(() => {
            fetchUsers();
        }, 0);
    }, [fetchUsers]);

    const filteredUsers = users.filter(user => {
        const matchesSearch = user.displayName.toLowerCase().includes(searchQuery.toLowerCase()) ||
                              user.email.toLowerCase().includes(searchQuery.toLowerCase());
        const matchesRole = roleFilter === 'all' || user.role === roleFilter;
        return matchesSearch && matchesRole;
    });

    const handleAction = (action: () => Promise<ActionResponse>) => {
        startTransition(async () => {
            const result = await action();
            if (result.success) {
                toast({ title: "Success", description: result.message });
                await fetchUsers(); // Re-fetch users to get updated state
            } else {
                toast({ title: "Error", description: result.message, variant: "destructive" });
            }
        });
    };

    const handleEditRole = (user: AdminUser) => {
        setSelectedUser(user);
        setIsRoleDialogOpen(true);
    };

    const handleUpdateRole = async (userId: string, newRole: UserRole) => {
        const idToken = await getCurrentUserIdToken();
        if (!idToken) return;
        handleAction(() => updateUserRole(idToken, userId, newRole));
    };

    const handleToggleBan = async (userId: string, currentStatus: 'active' | 'banned') => {
        const idToken = await getCurrentUserIdToken();
        if (!idToken) return;
        handleAction(() => toggleUserBan(idToken, userId, currentStatus));
    };

    return (
        <div className="space-y-6">
            <div className="flex flex-col sm:flex-row gap-4 justify-between items-center bg-card p-4 rounded-lg border shadow-sm">
                <div className="relative w-full sm:w-96">
                    <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Search users by name or email..."
                        className="pl-9"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
                <div className="flex gap-2 w-full sm:w-auto">
                    <Select value={roleFilter} onValueChange={setRoleFilter}>
                        <SelectTrigger className="w-[180px]">
                            <SelectValue placeholder="Filter by Role" />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="all">All Roles</SelectItem>
                            <SelectItem value="superadmin">Super Admin</SelectItem>
                            <SelectItem value="admin">Admins</SelectItem>
                            <SelectItem value="seller">Sellers</SelectItem>
                            <SelectItem value="viewer">Viewers</SelectItem>
                        </SelectContent>
                    </Select>
                    <Button onClick={() => setIsCreateDialogOpen(true)}>
                        <Plus className="mr-2 h-4 w-4" /> Create User
                    </Button>
                </div>
            </div>

            {isLoading ? (
                <div className="flex justify-center p-12"><Loader2 className="h-8 w-8 animate-spin" /></div>
            ) : (
                <UserTable
                    users={filteredUsers}
                    onEditRole={handleEditRole}
                    onToggleBan={handleToggleBan}
                    isPending={isPending}
                />
            )}

            {selectedUser && (
                <UserRoleDialog
                    isOpen={isRoleDialogOpen}
                    onClose={() => setIsRoleDialogOpen(false)}
                    currentRole={selectedUser.role || 'viewer'}
                    userId={selectedUser.id}
                    userName={selectedUser.displayName}
                    onUpdateRole={handleUpdateRole}
                />
            )}
            
            <CreateUserDialog
                isOpen={isCreateDialogOpen}
                onClose={() => {
                    setIsCreateDialogOpen(false);
                    fetchUsers(); // Refresh list after closing create dialog
                }}
            />
        </div>
    );
}

================================================================================
FILE: src/components/admin/users/UserRoleDialog.tsx
================================================================================

'use client';

import { useState, useTransition } from "react";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Shield, Store, User, BadgeCheck, Loader2, Eye } from "lucide-react";
import type { UserRole } from "@/lib/types";

interface UserRoleDialogProps {
    isOpen: boolean;
    onClose: () => void;
    currentRole: UserRole;
    userId: string;
    userName: string;
    onUpdateRole: (userId: string, newRole: UserRole) => Promise<void>;
}

export function UserRoleDialog({ isOpen, onClose, currentRole, userId, userName, onUpdateRole }: UserRoleDialogProps) {
    const [selectedRole, setSelectedRole] = useState<UserRole>(currentRole);
    const [isPending, startTransition] = useTransition();

    const handleSave = () => {
        if (selectedRole === currentRole) {
            onClose();
            return;
        }
        startTransition(async () => {
            await onUpdateRole(userId, selectedRole);
            onClose();
        });
    };

    return (
        <Dialog open={isOpen} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[425px]">
                <DialogHeader>
                    <DialogTitle>Manage User Role</DialogTitle>
                    <DialogDescription>
                        Change permissions and access levels for <span className="font-bold text-foreground">{userName}</span>.
                    </DialogDescription>
                </DialogHeader>
                <div className="grid gap-4 py-4">
                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="role" className="text-right">
                            Role
                        </Label>
                        <Select value={selectedRole} onValueChange={(val: UserRole) => setSelectedRole(val)}>
                            <SelectTrigger className="col-span-3">
                                <SelectValue placeholder="Select a role" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="viewer">
                                    <div className="flex items-center gap-2">
                                        <Eye className="h-4 w-4 text-slate-500" />
                                        <span>Viewer</span>
                                    </div>
                                </SelectItem>
                                <SelectItem value="seller">
                                    <div className="flex items-center gap-2">
                                        <Store className="h-4 w-4 text-blue-500" />
                                        <span>Seller</span>
                                    </div>
                                </SelectItem>
                                <SelectItem value="admin">
                                    <div className="flex items-center gap-2">
                                        <BadgeCheck className="h-4 w-4 text-purple-500" />
                                        <span>Admin</span>
                                    </div>
                                </SelectItem>
                                <SelectItem value="superadmin">
                                    <div className="flex items-center gap-2">
                                        <Shield className="h-4 w-4 text-red-500" />
                                        <span>Super Admin</span>
                                    </div>
                                </SelectItem>
                            </SelectContent>
                        </Select>
                    </div>
                </div>
                <DialogFooter>
                    <Button variant="outline" onClick={onClose} disabled={isPending}>Cancel</Button>
                    <Button onClick={handleSave} disabled={isPending}>
                        {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                        Save Changes
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

================================================================================
FILE: src/components/admin/users/UserTable.tsx
================================================================================

'use client';

import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel, DropdownMenuSeparator, DropdownMenuTrigger } from "@/components/ui/dropdown-menu";
import { Button } from "@/components/ui/button";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { MoreHorizontal, Shield, Store, BadgeCheck, Ban, Eye } from "lucide-react";
import { format } from "date-fns";
import type { AdminUser } from '@/app/actions/admin-users';
import type { UserRole } from "@/lib/types";

interface UserTableProps {
    users: AdminUser[];
    onEditRole: (user: AdminUser) => void;
    onToggleBan: (userId: string, currentStatus: 'active' | 'banned') => void;
    isPending: boolean;
}

const RoleBadge = ({ role }: { role: UserRole }) => {
    switch (role) {
        case 'superadmin':
            return <Badge variant="destructive" className="gap-1"><Shield className="h-3 w-3" /> Super Admin</Badge>;
        case 'admin':
            return <Badge className="bg-purple-600 hover:bg-purple-700 gap-1"><BadgeCheck className="h-3 w-3" /> Admin</Badge>;
        case 'seller':
            return <Badge variant="secondary" className="text-blue-600 bg-blue-100 hover:bg-blue-200 gap-1"><Store className="h-3 w-3" /> Seller</Badge>;
        default:
            return <Badge variant="outline" className="gap-1"><Eye className="h-3 w-3" /> Viewer</Badge>;
    }
};

export function UserTable({ users, onEditRole, onToggleBan, isPending }: UserTableProps) {
    return (
        <div className="rounded-md border bg-card">
            <Table>
                <TableHeader>
                    <TableRow>
                        <TableHead>User</TableHead>
                        <TableHead>Role</TableHead>
                        <TableHead>Status</TableHead>
                        <TableHead>Last Sign In</TableHead>
                        <TableHead className="text-right">Actions</TableHead>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    {users.map((user) => (
                        <TableRow key={user.id} className={isPending ? 'opacity-50' : ''}>
                            <TableCell className="flex items-center gap-3">
                                <Avatar className="h-9 w-9">
                                    <AvatarImage src={user.photoURL} />
                                    <AvatarFallback>{user.displayName.slice(0, 2).toUpperCase()}</AvatarFallback>
                                </Avatar>
                                <div className="flex flex-col">
                                    <span className="font-medium text-sm">{user.displayName}</span>
                                    <span className="text-xs text-muted-foreground">{user.email}</span>
                                </div>
                            </TableCell>
                            <TableCell>
                                <RoleBadge role={user.role || 'viewer'} />
                            </TableCell>
                            <TableCell>
                                <span className={`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${
                                    !user.disabled ? 'bg-green-50 text-green-700 ring-1 ring-inset ring-green-600/20' :
                                    'bg-red-50 text-red-700 ring-1 ring-inset ring-red-600/20'
                                }`}>
                                    {!user.disabled ? 'Active' : 'Banned'}
                                </span>
                            </TableCell>
                            <TableCell className="text-muted-foreground text-sm">
                                {user.lastSignInTime ? format(new Date(user.lastSignInTime), 'MMM d, yyyy') : 'Never'}
                            </TableCell>
                            <TableCell className="text-right">
                                <DropdownMenu>
                                    <DropdownMenuTrigger asChild>
                                        <Button variant="ghost" className="h-8 w-8 p-0" disabled={isPending}>
                                            <span className="sr-only">Open menu</span>
                                            <MoreHorizontal className="h-4 w-4" />
                                        </Button>
                                    </DropdownMenuTrigger>
                                    <DropdownMenuContent align="end">
                                        <DropdownMenuLabel>Actions</DropdownMenuLabel>
                                        <DropdownMenuItem onClick={() => navigator.clipboard.writeText(user.id)}>
                                            Copy User ID
                                        </DropdownMenuItem>
                                        <DropdownMenuSeparator />
                                        <DropdownMenuItem onClick={() => onEditRole(user)}>
                                            Change Role...
                                        </DropdownMenuItem>
                                        <DropdownMenuItem
                                            className={!user.disabled ? "text-red-600" : "text-green-600"}
                                            onClick={() => onToggleBan(user.id, !user.disabled ? 'active' : 'banned')}
                                        >
                                            {!user.disabled ? <><Ban className="mr-2 h-4 w-4" /> Ban User</> : "Unban User"}
                                        </DropdownMenuItem>
                                    </DropdownMenuContent>
                                </DropdownMenu>
                            </TableCell>
                        </TableRow>
                    ))}
                </TableBody>
            </Table>
        </div>
    );
}

================================================================================
FILE: src/components/analytics/GoogleAnalytics.tsx
================================================================================

'use client';

import { usePathname, useSearchParams } from 'next/navigation';
import Script from 'next/script';
import { useEffect, Suspense } from 'react';

const GA_MEASUREMENT_ID = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID;

function GoogleAnalyticsInner() {
  const pathname = usePathname();
  const searchParams = useSearchParams();

  useEffect(() => {
    if (!GA_MEASUREMENT_ID) {
      return;
    }
    const url = `${pathname}?${searchParams.toString()}`;
    
    // @ts-ignore
    window.gtag('config', GA_MEASUREMENT_ID, {
      page_path: url,
    });
  }, [pathname, searchParams]);

  if (!GA_MEASUREMENT_ID) {
    return null;
  }

  return (
    <>
      <Script
        src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`}
        strategy="afterInteractive"
      />
      <Script id="google-analytics" strategy="afterInteractive">
        {`
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', '${GA_MEASUREMENT_ID}');
        `}
      </Script>
    </>
  );
}

export function GoogleAnalytics() {
    return (
        <Suspense fallback={null}>
            <GoogleAnalyticsInner />
        </Suspense>
    )
}

================================================================================
FILE: src/components/animations/FadeIn.tsx
================================================================================

'use client';

import { motion, useInView } from 'framer-motion';
import { useRef } from 'react';
import { cn } from '@/lib/utils';

export function StaggerContainer({ children, className }: { children: React.ReactNode; className?: string }) {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.2 });

  return (
    <motion.div
      ref={ref}
      className={className}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
      variants={{
        visible: { transition: { staggerChildren: 0.1 } },
      }}
    >
      {children}
    </motion.div>
  );
}

interface FadeInProps {
    children: React.ReactNode;
    delay?: number;
    className?: string;
}

export function FadeIn({ children, delay = 0, className }: FadeInProps) {
  return (
    <motion.div
      className={className}
      variants={{
        hidden: { opacity: 0, y: 20 },
        visible: { opacity: 1, y: 0 },
      }}
      transition={{ duration: 0.5, delay }}
    >
      {children}
    </motion.div>
  );
}

================================================================================
FILE: src/components/ar-camera-overlay.tsx
================================================================================

'use client';

interface ARCameraOverlayProps {
  guideType: 'card' | 'coin';
}

export function ARCameraOverlay({ guideType }: ARCameraOverlayProps) {
  const guideStyles = {
    card: {
      aspectRatio: '1 / 1.4', // Standard trading card aspect ratio
      width: '80%',
      border: '2px dashed white',
      borderRadius: '4%',
    },
    coin: {
      aspectRatio: '1 / 1',
      width: '70%',
      border: '2px dashed white',
      borderRadius: '50%',
    },
  };

  return (
    <div
      className="absolute inset-0 flex items-center justify-center pointer-events-none"
    >
      <div
        style={guideStyles[guideType]}
        className="shadow-[0_0_0_9999px_rgba(0,0,0,0.5)]"
      />
    </div>
  );
}

================================================================================
FILE: src/components/auth/SignInForm.tsx
================================================================================

"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { useState, Suspense, useEffect } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import Link from 'next/link';

import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { useToast } from "@/hooks/use-toast";
import { signInWithEmail } from "@/lib/firebase/auth";
import { Loader2 } from "lucide-react";

const formSchema = z.object({
  email: z.string().email({ message: "Invalid email address." }),
  password: z.string().min(1, { message: "Password is required." }),
});

function SignInFormInner() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const redirectUrl = searchParams.get('redirect') || '/';
  const { toast } = useToast();
  const [isLoading, setIsLoading] = useState(false);
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    // eslint-disable-next-line react-hooks/set-state-in-effect
    setMounted(true);
  }, []);

  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      email: "",
      password: "",
    },
    mode: "onChange",
  });

  async function onSubmit(values: z.infer<typeof formSchema>) {
    // Failsafe: Ensure values are present
    if (!values.email || !values.password) {
      return;
    }

    setIsLoading(true);
    const { error } = await signInWithEmail(values.email, values.password);

    if (error) {
      let errorMessage = "An unknown error occurred. Please try again.";
      // Use the new, more descriptive error handling
      switch(error.code) {
          case 'auth/invalid-credential':
          case 'auth/user-not-found':
          case 'auth/wrong-password':
              errorMessage = "Invalid email or password. Please try again.";
              break;
          case 'auth/too-many-requests':
              errorMessage = "Too many sign-in attempts. Please try again later.";
              break;
          case 'auth/network-request-failed':
              errorMessage = "Network error. Please check your internet connection.";
              break;
          case 'auth/invalid-api-key':
              errorMessage = "The API key is invalid. Please check your .env configuration and ensure the key is enabled in your Google Cloud console.";
              break;
          default:
              // For any other errors, show the raw message from Firebase to aid debugging.
              errorMessage = error.message;
              break;
      }

      toast({
        title: "Sign-in failed",
        description: errorMessage,
        variant: "destructive",
      });
      setIsLoading(false);
    } else {
      toast({
        title: "Success!",
        description: "You have successfully signed in.",
      });
      // Use Next.js router to force a full page reload and ensure auth state is updated.
      router.push(redirectUrl);
    }
  }

  if (!mounted) {
      return null;
  }

  return (
    <>
      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
          <FormField
            control={form.control}
            name="email"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Email address</FormLabel>
                <FormControl>
                  <Input placeholder="you@example.com" {...field} type="email" autoComplete="email" />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="password"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Password</FormLabel>
                <FormControl>
                  <Input placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" {...field} type="password" autoComplete="current-password" />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          <div className="flex items-center justify-between">
            <div />
            <Button variant="link" asChild className="p-0 text-sm">
              <Link href="#">Forgot password?</Link>
            </Button>
          </div>
          <div>
            <Button type="submit" className="w-full" size="lg" disabled={isLoading}>
              {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Sign In
            </Button>
          </div>
        </form>
      </Form>
    </>
  );
}

export default function SignInForm() {
    return (
        <Suspense fallback={<div>Loading...</div>}>
            <SignInFormInner />
        </Suspense>
    )
}

================================================================================
FILE: src/components/auth/SignUpForm.tsx
================================================================================

"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { useState, Suspense } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import Link from 'next/link';

import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { useToast } from "@/hooks/use-toast";
import { signUpWithEmail } from "@/lib/firebase/auth";
import { Loader2 } from "lucide-react";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Textarea } from "@/components/ui/textarea";
import { Checkbox } from "@/components/ui/checkbox";

const formSchema = z.object({
  displayName: z.string().min(2, { message: "Full name must be at least 2 characters." }),
  email: z.string().email({ message: "Please enter a valid email address." }),
  password: z.string()
    .min(8, { message: "Password must be at least 8 characters long." })
    .regex(/[A-Z]/, { message: "Password must contain at least one uppercase letter." })
    .regex(/[a-z]/, { message: "Password must contain at least one lowercase letter." })
    .regex(/[0-9]/, { message: "Password must contain at least one number." }),
  confirmPassword: z.string(),
  accountType: z.enum(["buyer", "seller"], {
    required_error: "You must select an account type."
  }),
  storeName: z.string().optional(),
  storeDescription: z.string().optional(),
  agreedToTerms: z.boolean().refine((val) => val === true, {
    message: "You must agree to the Terms & Conditions and Privacy Policy.",
  }),
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords do not match.",
  path: ["confirmPassword"],
}).refine((data) => {
    if (data.accountType === 'seller') {
        return !!data.storeName && data.storeName.length >= 2;
    }
    return true;
}, {
    message: "Store name is required for sellers.",
    path: ["storeName"],
});

function SignUpFormInner() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const redirectUrl = searchParams.get('redirect') || '/';
  const { toast } = useToast();
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      displayName: "",
      email: "",
      password: "",
      confirmPassword: "",
      accountType: "buyer",
      storeName: "",
      storeDescription: "",
      agreedToTerms: false,
    },
  });

  const accountType = form.watch("accountType");

  async function onSubmit(values: z.infer<typeof formSchema>) {
    setIsLoading(true);
    const { error } = await signUpWithEmail({
        email: values.email, 
        password: values.password, 
        displayName: values.displayName,
        accountType: values.accountType,
        storeName: values.storeName,
        storeDescription: values.storeDescription,
    });

    if (error) {
      let errorMessage = "An unknown error occurred. Please try again.";
      switch (error.code) {
        case 'auth/email-already-in-use':
          errorMessage = 'This email address is already in use.';
          break;
        case 'auth/invalid-email':
          errorMessage = 'Please enter a valid email address.';
          break;
        case 'auth/weak-password':
          errorMessage = 'The password is too weak.';
          break;
        default:
          errorMessage = error.message;
          break;
      }

      toast({
        title: "Sign-up failed",
        description: errorMessage,
        variant: "destructive",
      });
       setIsLoading(false);
    } else {
      toast({
        title: "Success!",
        description: "Your account has been created.",
      });
      window.location.href = redirectUrl;
    }
  }

  return (
    <>
      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
          
          <FormField
            control={form.control}
            name="accountType"
            render={({ field }) => (
              <FormItem className="space-y-3">
                <FormLabel>I am a...</FormLabel>
                <FormControl>
                  <RadioGroup
                    onValueChange={field.onChange}
                    defaultValue={field.value}
                    className="flex space-x-4"
                  >
                    <FormItem className="flex items-center space-x-2 space-y-0">
                      <FormControl>
                        <RadioGroupItem value="buyer" />
                      </FormControl>
                      <FormLabel className="font-normal">Buyer</FormLabel>
                    </FormItem>
                    <FormItem className="flex items-center space-x-2 space-y-0">
                      <FormControl>
                        <RadioGroupItem value="seller" />
                      </FormControl>
                      <FormLabel className="font-normal">Seller</FormLabel>
                    </FormItem>
                  </RadioGroup>
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="displayName"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Full Name</FormLabel>
                <FormControl>
                  <Input placeholder="John Doe" {...field} autoComplete="name" />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="email"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Email address</FormLabel>
                <FormControl>
                  <Input placeholder="you@example.com" {...field} type="email" autoComplete="email" />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="password"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Password</FormLabel>
                <FormControl>
                  <Input placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" {...field} type="password" autoComplete="new-password" />
                </FormControl>
                 <FormDescription className="text-xs">
                    Must be 8+ characters with uppercase, lowercase, and a number.
                </FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="confirmPassword"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Confirm Password</FormLabel>
                <FormControl>
                  <Input placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" {...field} type="password" autoComplete="new-password" />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          
          {accountType === "seller" && (
             <div className="space-y-4 border-t pt-4">
                <h3 className="text-lg font-medium">Seller Information</h3>
                 <FormField
                    control={form.control}
                    name="storeName"
                    render={({ field }) => (
                    <FormItem>
                        <FormLabel>Store Name</FormLabel>
                        <FormControl>
                        <Input placeholder="e.g., John's Collectibles" {...field} />
                        </FormControl>
                        <FormMessage />
                    </FormItem>
                    )}
                />
                 <FormField
                    control={form.control}
                    name="storeDescription"
                    render={({ field }) => (
                    <FormItem>
                        <FormLabel>Store Description (Optional)</FormLabel>
                        <FormControl>
                        <Textarea placeholder="Specializing in rare cards and coins..." {...field} />
                        </FormControl>
                        <FormMessage />
                    </FormItem>
                    )}
                />
             </div>
          )}

           <FormField
                control={form.control}
                name="agreedToTerms"
                render={({ field }) => (
                    <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4">
                    <FormControl>
                        <Checkbox
                        checked={field.value}
                        onCheckedChange={field.onChange}
                        />
                    </FormControl>
                    <div className="space-y-1 leading-none">
                        <FormLabel>
                           I agree to the <Link href="/terms" className="text-primary hover:underline">Terms & Conditions</Link> and <Link href="/privacy" className="text-primary hover:underline">Privacy Policy</Link>.
                        </FormLabel>
                         <FormMessage />
                    </div>
                    </FormItem>
                )}
            />

          <div>
            <Button type="submit" className="w-full" size="lg" disabled={isLoading}>
              {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Create Account
            </Button>
          </div>
        </form>
      </Form>
      <div className="mt-6">
        <div className="relative">
          <div className="absolute inset-0 flex items-center">
            <div className="w-full border-t border-border" />
          </div>
          <div className="relative flex justify-center text-sm">
            <span className="bg-card px-2 text-muted-foreground">
              Or
            </span>
          </div>
        </div>

        <div className="mt-6 text-center">
          <p className="text-sm text-muted-foreground">
            Already have an account?{' '}
            <Button variant="link" asChild className="p-0">
              <Link href="/sign-in">Sign in</Link>
            </Button>
          </p>
        </div>
      </div>
    </>
  );
}

export default function SignUpForm() {
    return (
        <Suspense fallback={<div>Loading...</div>}>
            <SignUpFormInner />
        </Suspense>
    )
}

================================================================================
FILE: src/components/cart/CartDrawer.tsx
================================================================================
"use client";

import React from 'react';
import { useCart } from '@/context/CartContext';
import {
    Sheet,
    SheetContent,
    SheetHeader,
    SheetTitle,
    SheetFooter,
    SheetDescription,
} from '@/components/ui/sheet';
import { Button } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Trash2, Plus, Minus, ShoppingBag } from 'lucide-react';
import Image from 'next/image';
import Link from 'next/link';

export function CartDrawer() {
    const { items, removeItem, updateQuantity, cartTotal, itemCount, isCartOpen, setIsCartOpen } = useCart();

    const handleCheckout = () => {
        setIsCartOpen(false);
    };

    return (
        <Sheet open={isCartOpen} onOpenChange={setIsCartOpen}>
            <SheetContent className="w-full sm:max-w-lg flex flex-col">
                <SheetHeader className="px-6 pt-6">
                    <SheetTitle className="flex items-center gap-2 text-lg font-semibold">
                        <ShoppingBag className="w-5 h-5" />
                        Your Cart ({itemCount})
                    </SheetTitle>
                </SheetHeader>
                
                <Separator />

                {items.length === 0 ? (
                    <div className="flex-1 flex flex-col items-center justify-center text-center p-6">
                        <ShoppingBag className="w-16 h-16 text-muted-foreground opacity-30 mb-4" />
                        <h3 className="text-xl font-semibold">Your cart is empty</h3>
                        <p className="text-muted-foreground mt-2">Looks like you haven't added anything yet.</p>
                        <Button
                            variant="outline"
                            className="mt-6"
                            onClick={() => setIsCartOpen(false)}
                        >
                            Continue Shopping
                        </Button>
                    </div>
                ) : (
                    <>
                        <ScrollArea className="flex-1 -mx-6 px-6">
                            <div className="space-y-6">
                                {items.map((item) => (
                                    <div key={item.id} className="flex gap-4">
                                        <div className="relative w-24 h-24 rounded-md overflow-hidden bg-muted shrink-0">
                                            <Image
                                                src={item.imageUrls[0]}
                                                alt={item.title}
                                                fill
                                                className="object-cover"
                                            />
                                        </div>
                                        <div className="flex-1 flex flex-col justify-between py-1">
                                            <div>
                                                <h4 className="font-semibold line-clamp-2 leading-tight">{item.title}</h4>
                                                <p className="text-sm font-bold text-primary mt-1">
                                                    ${item.price.toFixed(2)}
                                                </p>
                                            </div>
                                            <div className="flex items-center justify-between mt-2">
                                                <div className="flex items-center gap-2">
                                                    <Button
                                                        variant="outline"
                                                        size="icon"
                                                        className="h-7 w-7"
                                                        onClick={() => updateQuantity(item.id, item.quantity - 1)}
                                                    >
                                                        <Minus className="w-3.5 h-3.5" />
                                                    </Button>
                                                    <span className="text-sm font-medium w-5 text-center">{item.quantity}</span>
                                                    <Button
                                                        variant="outline"
                                                        size="icon"
                                                        className="h-7 w-7"
                                                        onClick={() => updateQuantity(item.id, item.quantity + 1)}
                                                    >
                                                        <Plus className="w-3.5 h-3.5" />
                                                    </Button>
                                                </div>
                                                <Button
                                                    variant="ghost"
                                                    size="icon"
                                                    className="h-8 w-8 text-muted-foreground hover:text-destructive"
                                                    onClick={() => removeItem(item.id)}
                                                >
                                                    <Trash2 className="w-4 h-4" />
                                                </Button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </ScrollArea>
                        
                        <SheetFooter className="px-6 pb-6 pt-4 mt-auto border-t">
                            <div className="w-full space-y-4">
                                <div className="flex justify-between text-lg font-semibold">
                                    <span>Subtotal</span>
                                    <span>${cartTotal.toFixed(2)}</span>
                                </div>
                                <p className="text-xs text-muted-foreground text-center">
                                    Shipping and taxes will be calculated at checkout.
                                </p>
                                <Button size="lg" className="w-full" asChild>
                                    <Link href="/checkout" onClick={handleCheckout}>Proceed to Checkout</Link>
                                </Button>
                            </div>
                        </SheetFooter>
                    </>
                )}
            </SheetContent>
        </Sheet>
    );
}

================================================================================
FILE: src/components/dashboard/dashboard-sidebar.tsx
================================================================================

'use client';

import React from 'react';
import Link from 'next/link';
import {
  Home,
  Package,
  Wand2,
  DollarSign,
  Star,
  AreaChart,
  Settings,
  Camera,
  Package2,
  Sparkles,
  Layers,
} from 'lucide-react';
import { usePathname } from 'next/navigation';
import { cn } from '@/lib/utils';
import { useSidebar } from '@/components/layout/sidebar-provider';
import { SidebarToggle } from '../layout/sidebar-toggle';

const navItems = [
  { href: '/sell/dashboard', label: 'Dashboard', icon: Home },
  { href: '/sell/listings', label: 'My Listings', icon: Package },
  { href: '/sell/payouts', label: 'Payouts', icon: DollarSign },
  { href: '/sell/reviews', label: 'Reviews', icon: Star },
  { href: '/sell/analytics', label: 'Analytics', icon: AreaChart },
  { href: '/sell/settings', label: 'Settings', icon: Settings },
];

const aiTools = [
    { href: '/sell/bulk-lister', label: 'Bulk AI Lister', icon: Layers },
    { href: '/sell/cards', label: 'AI Card Grader', icon: Sparkles },
]

export default function DashboardSidebar() {
  const pathname = usePathname();
  const { isSidebarOpen } = useSidebar();

  return (
     <div className={cn("flex flex-col h-full bg-muted/40", isSidebarOpen ? 'w-64' : 'w-20' )}>
        <div className="flex items-center justify-between p-4 border-b h-16">
            <Link href="/" className="flex items-center gap-2 font-semibold">
                <Package2 className="h-6 w-6 shrink-0" />
                <span className={cn('transition-opacity', isSidebarOpen ? 'opacity-100' : 'opacity-0 w-0')}>Picksy Seller</span>
            </Link>
            <SidebarToggle />
        </div>
        <nav className="flex-grow p-2 space-y-1">
            {navItems.map(item => (
            <Link
                key={item.href}
                href={item.href}
                className={cn(
                'flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:text-primary',
                pathname === item.href && 'bg-primary/10 text-primary',
                 !isSidebarOpen && 'justify-center'
                )}
            >
                <item.icon className="h-5 w-5 shrink-0" />
                <span className={cn('whitespace-nowrap transition-opacity', isSidebarOpen ? 'opacity-100' : 'opacity-0 w-0')}>{item.label}</span>
            </Link>
            ))}
             <div className="px-3 py-2">
                <h2 className={cn('text-xs font-semibold text-muted-foreground tracking-wider transition-opacity', isSidebarOpen ? 'opacity-100' : 'opacity-0 w-0')}>AI Tools</h2>
            </div>
            {aiTools.map(item => (
            <Link
                key={item.href}
                href={item.href}
                className={cn(
                'flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:text-primary',
                pathname === item.href && 'bg-primary/10 text-primary',
                 !isSidebarOpen && 'justify-center'
                )}
            >
                <item.icon className="h-5 w-5 shrink-0" />
                <span className={cn('whitespace-nowrap transition-opacity', isSidebarOpen ? 'opacity-100' : 'opacity-0 w-0')}>{item.label}</span>
            </Link>
            ))}
        </nav>
    </div>
  );
}

================================================================================
FILE: src/components/filters/AdvancedFilterPanel.tsx
================================================================================
'use client';

import { useState, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Slider } from '@/components/ui/slider';
import { Checkbox } from '@/components/ui/checkbox';
import {
    Sheet,
    SheetContent,
    SheetDescription,
    SheetHeader,
    SheetTitle,
    SheetTrigger,
    SheetFooter,
} from '@/components/ui/sheet';
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from '@/components/ui/select';
import { Separator } from '@/components/ui/separator';
import { Badge } from '@/components/ui/badge';
import { Filter, X, SlidersHorizontal } from 'lucide-react';
import type { ProductSearchParams } from '@/lib/types';

const CATEGORIES = [
    'Collector Cards',
    'Coins',
    'Collectibles',
];

const CONDITIONS = [
    'Mint',
    'Near Mint',
    'Excellent',
    'Good',
    'Fair',
    'Poor',
];

const SORT_OPTIONS = [
    { value: 'createdAt-desc', label: 'Newest First' },
    { value: 'createdAt-asc', label: 'Oldest First' },
    { value: 'price-asc', label: 'Price: Low to High' },
    { value: 'price-desc', label: 'Price: High to Low' },
    { value: 'views-desc', label: 'Most Popular' },
    { value: 'title-asc', label: 'Title: A to Z' },
];

interface AdvancedFilterPanelProps {
    currentFilters: Partial<ProductSearchParams>;
    onFilterChange: (filters: Partial<ProductSearchParams>) => void;
    onClearFilters: () => void;
}

export default function AdvancedFilterPanel({
    currentFilters,
    onFilterChange,
    onClearFilters,
}: AdvancedFilterPanelProps) {
    const [isOpen, setIsOpen] = useState(false);

    // Local state for filters
    const [localFilters, setLocalFilters] = useState<Partial<ProductSearchParams>>(currentFilters);

    const handleLocalChange = useCallback((key: string, value: any) => {
        setLocalFilters(prev => ({
            ...prev,
            [key]: value,
        }));
    }, []);

    const handleApplyFilters = () => {
        onFilterChange(localFilters);
        setIsOpen(false);
    };

    const handleClear = () => {
        setLocalFilters({});
        onClearFilters();
    };

    const toggleCategory = (category: string) => {
        const currentCategories = (localFilters.categories as string[]) || [];
        const newCategories = currentCategories.includes(category)
            ? currentCategories.filter(c => c !== category)
            : [...currentCategories, category];
        handleLocalChange('categories', newCategories.length > 0 ? newCategories : undefined);
    };

    const toggleCondition = (condition: string) => {
        const currentConditions = (localFilters.conditions as string[]) || [];
        const newConditions = currentConditions.includes(condition)
            ? currentConditions.filter(c => c !== condition)
            : [...currentConditions, condition];
        handleLocalChange('conditions', newConditions.length > 0 ? newConditions : undefined);
    };

    const activeFilterCount = Object.keys(currentFilters).filter(
        key => !['view', 'sort', 'page'].includes(key) && currentFilters[key as keyof ProductSearchParams]
    ).length;

    const priceRange = (localFilters.priceRange as [number, number]) || [0, 10000];
    const yearRange = (localFilters.yearRange as [number, number]) || [1900, new Date().getFullYear()];

    return (
        <Sheet open={isOpen} onOpenChange={setIsOpen}>
            <SheetTrigger asChild>
                <Button variant="outline" className="relative">
                    <SlidersHorizontal className="mr-2 h-4 w-4" />
                    Filters
                    {activeFilterCount > 0 && (
                        <Badge className="ml-2 px-1.5 min-w-[20px] h-5" variant="default">
                            {activeFilterCount}
                        </Badge>
                    )}
                </Button>
            </SheetTrigger>
            <SheetContent className="w-full sm:max-w-lg overflow-y-auto">
                <SheetHeader>
                    <SheetTitle>Advanced Filters</SheetTitle>
                    <SheetDescription>
                        Refine your search with detailed filters
                    </SheetDescription>
                </SheetHeader>

                <div className="py-6 space-y-6">
                    {/* Sort */}
                    <div className="space-y-3">
                        <Label className="text-base font-semibold">Sort By</Label>
                        <Select
                            value={localFilters.sort as string || 'createdAt-desc'}
                            onValueChange={(value) => handleLocalChange('sort', value)}
                        >
                            <SelectTrigger>
                                <SelectValue placeholder="Select sort order" />
                            </SelectTrigger>
                            <SelectContent>
                                {SORT_OPTIONS.map(option => (
                                    <SelectItem key={option.value} value={option.value}>
                                        {option.label}
                                    </SelectItem>
                                ))}
                            </SelectContent>
                        </Select>
                    </div>

                    <Separator />

                    {/* Price Range */}
                    <div className="space-y-4">
                        <Label className="text-base font-semibold">
                            Price Range: ${priceRange[0]} - ${priceRange[1]}
                        </Label>
                        <Slider
                            min={0}
                            max={10000}
                            step={50}
                            value={priceRange}
                            onValueChange={(value) => handleLocalChange('priceRange', value as [number, number])}
                            className="w-full"
                        />
                        <div className="flex gap-4">
                            <div className="flex-1">
                                <Label className="text-xs text-muted-foreground">Min ($)</Label>
                                <Input
                                    type="number"
                                    value={priceRange[0]}
                                    onChange={(e) => handleLocalChange('priceRange', [Number(e.target.value), priceRange[1]])}
                                    className="mt-1"
                                />
                            </div>
                            <div className="flex-1">
                                <Label className="text-xs text-muted-foreground">Max ($)</Label>
                                <Input
                                    type="number"
                                    value={priceRange[1]}
                                    onChange={(e) => handleLocalChange('priceRange', [priceRange[0], Number(e.target.value)])}
                                    className="mt-1"
                                />
                            </div>
                        </div>
                    </div>

                    <Separator />

                    {/* Categories */}
                    <div className="space-y-3">
                        <Label className="text-base font-semibold">Categories</Label>
                        <div className="space-y-2">
                            {CATEGORIES.map(category => {
                                const isSelected = (localFilters.categories as string[] || []).includes(category);
                                return (
                                    <div key={category} className="flex items-center space-x-2">
                                        <Checkbox
                                            id={`category-${category}`}
                                            checked={isSelected}
                                            onCheckedChange={() => toggleCategory(category)}
                                        />
                                        <label
                                            htmlFor={`category-${category}`}
                                            className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer"
                                        >
                                            {category}
                                        </label>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <Separator />

                    {/* Conditions */}
                    <div className="space-y-3">
                        <Label className="text-base font-semibold">Condition</Label>
                        <div className="grid grid-cols-2 gap-2">
                            {CONDITIONS.map(condition => {
                                const isSelected = (localFilters.conditions as string[] || []).includes(condition);
                                return (
                                    <div key={condition} className="flex items-center space-x-2">
                                        <Checkbox
                                            id={`condition-${condition}`}
                                            checked={isSelected}
                                            onCheckedChange={() => toggleCondition(condition)}
                                        />
                                        <label
                                            htmlFor={`condition-${condition}`}
                                            className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer"
                                        >
                                            {condition}
                                        </label>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <Separator />

                    {/* Year Range */}
                    <div className="space-y-4">
                        <Label className="text-base font-semibold">
                            Year Range: {yearRange[0]} - {yearRange[1]}
                        </Label>
                        <Slider
                            min={1900}
                            max={new Date().getFullYear()}
                            step={1}
                            value={yearRange}
                            onValueChange={(value) => handleLocalChange('yearRange', value as [number, number])}
                            className="w-full"
                        />
                        <div className="flex gap-4">
                            <div className="flex-1">
                                <Label className="text-xs text-muted-foreground">From</Label>
                                <Input
                                    type="number"
                                    value={yearRange[0]}
                                    onChange={(e) => handleLocalChange('yearRange', [Number(e.target.value), yearRange[1]])}
                                    className="mt-1"
                                />
                            </div>
                            <div className="flex-1">
                                <Label className="text-xs text-muted-foreground">To</Label>
                                <Input
                                    type="number"
                                    value={yearRange[1]}
                                    onChange={(e) => handleLocalChange('yearRange', [yearRange[0], Number(e.target.value)])}
                                    className="mt-1"
                                />
                            </div>
                        </div>
                    </div>

                    <Separator />

                    {/* Seller Rating */}
                    <div className="space-y-3">
                        <Label className="text-base font-semibold">Minimum Seller Rating</Label>
                        <Select
                            value={String(localFilters.minRating || '')}
                            onValueChange={(value) => handleLocalChange('minRating', value ? Number(value) : undefined)}
                        >
                            <SelectTrigger>
                                <SelectValue placeholder="Any rating" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="">Any Rating</SelectItem>
                                <SelectItem value="4.5">4.5 â­ & up</SelectItem>
                                <SelectItem value="4.0">4.0 â­ & up</SelectItem>
                                <SelectItem value="3.5">3.5 â­ & up</SelectItem>
                                <SelectItem value="3.0">3.0 â­ & up</SelectItem>
                            </SelectContent>
                        </Select>
                    </div>

                    <Separator />

                    {/* Keyword Search */}
                    <div className="space-y-3">
                        <Label className="text-base font-semibold">Keyword Search</Label>
                        <Input
                            placeholder="Search in titles and descriptions..."
                            value={localFilters.q as string || ''}
                            onChange={(e) => handleLocalChange('q', e.target.value || undefined)}
                        />
                    </div>
                </div>

                <SheetFooter className="flex-col sm:flex-col gap-2 sticky bottom-0 bg-background pt-4">
                    <Button onClick={handleApplyFilters} className="w-full">
                        Apply Filters
                    </Button>
                    <Button onClick={handleClear} variant="outline" className="w-full">
                        <X className="mr-2 h-4 w-4" />
                        Clear All Filters
                    </Button>
                </SheetFooter>
            </SheetContent>
        </Sheet>
    );
}

================================================================================
FILE: src/components/filters/collector-cards-filter-trigger.tsx
================================================================================

'use client';

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import {
    Sheet,
    SheetContent,
    SheetDescription,
    SheetHeader,
    SheetTitle,
    SheetTrigger,
} from "@/components/ui/sheet";
import { Checkbox } from "@/components/ui/checkbox";
import { Filter, X } from "lucide-react";
import { ScrollArea } from "@/components/ui/scroll-area";
import type { UserProfile } from "@/lib/types";
import { Slider } from "../ui/slider";

interface CollectorCardsFilterTriggerProps {
    sortOrder: string;
    setSortOrder: (value: string) => void;
    postcode: string;
    setPostcode: (value: string) => void;
    isExclusionMode: boolean;
    setIsExclusionMode: (value: boolean) => void;
    selectedSellers: string[];
    handleSellerSelection: (sellerId: string) => void;
    availableSellers: UserProfile[];
    priceRange: [number, number];
    setPriceRange: (value: [number, number]) => void;
    conditionOptions: string[];
    selectedConditions: string[];
    handleConditionSelection: (condition: string) => void;
}

export function CollectorCardsFilterTrigger({
    sortOrder,
    setSortOrder,
    postcode,
    setPostcode,
    isExclusionMode,
    setIsExclusionMode,
    selectedSellers,
    handleSellerSelection,
    availableSellers,
    priceRange,
    setPriceRange,
    conditionOptions,
    selectedConditions,
    handleConditionSelection,
}: CollectorCardsFilterTriggerProps) {
    return (
        <Sheet>
            <SheetTrigger asChild>
                <Button variant="outline" size="sm" className="h-10 gap-2">
                    <Filter className="w-4 h-4" />
                    <span className="hidden sm:inline">Filters</span>
                </Button>
            </SheetTrigger>
            <SheetContent side="right" className="w-[300px] sm:w-[540px]">
                <SheetHeader>
                    <SheetTitle>Filter & Sort</SheetTitle>
                    <SheetDescription>
                        Narrow down your search results.
                    </SheetDescription>
                </SheetHeader>
                <ScrollArea className="h-[calc(100vh-100px)] pr-4 mt-4">
                    <div className="space-y-8">
                        {/* Sort Order */}
                        <div className="space-y-2">
                            <Label className="font-semibold">Sort By</Label>
                            <Select value={sortOrder} onValueChange={setSortOrder}>
                                <SelectTrigger>
                                    <SelectValue placeholder="Sort by" />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem value="createdAt-desc">Newest</SelectItem>
                                    <SelectItem value="price-asc">Price: Low to High</SelectItem>
                                    <SelectItem value="price-desc">Price: High to Low</SelectItem>
                                </SelectContent>
                            </Select>
                        </div>

                        {/* Price Range */}
                        <div className="space-y-4">
                            <Label className="font-semibold">Price Range</Label>
                            <Slider
                                min={0}
                                max={5000}
                                step={10}
                                value={priceRange}
                                onValueChange={(value) => setPriceRange(value as [number, number])}
                            />
                            <div className="flex justify-between text-sm text-muted-foreground">
                                <span>${priceRange[0]}</span>
                                <span>${priceRange[1]}{priceRange[1] === 5000 ? '+' : ''}</span>
                            </div>
                        </div>

                        {/* Condition */}
                        <div className="space-y-2">
                             <Label className="font-semibold">Condition</Label>
                             <div className="space-y-2 border rounded-md p-4 bg-muted/20">
                                {conditionOptions.map(condition => (
                                    <div key={condition} className="flex items-center space-x-2">
                                        <Checkbox
                                            id={`condition-${condition}`}
                                            checked={selectedConditions.includes(condition)}
                                            onCheckedChange={() => handleConditionSelection(condition)}
                                        />
                                        <Label htmlFor={`condition-${condition}`} className="text-sm font-normal">
                                            {condition}
                                        </Label>
                                    </div>
                                ))}
                             </div>
                        </div>


                        {/* Postcode */}
                        <div className="space-y-2">
                            <Label className="font-semibold">Seller Postcode</Label>
                            <Input
                                placeholder="e.g. 6000"
                                value={postcode}
                                onChange={(e) => setPostcode(e.target.value)}
                            />
                        </div>

                        {/* Seller Filters */}
                        <div className="space-y-4">
                            <div className="flex items-center justify-between">
                                <Label className="font-semibold">Sellers</Label>
                                <div className="flex items-center space-x-2">
                                    <Label htmlFor="exclusion-mode" className="text-xs text-muted-foreground">
                                        Exclusion Mode
                                    </Label>
                                    <Checkbox
                                        id="exclusion-mode"
                                        checked={isExclusionMode}
                                        onCheckedChange={(checked) => setIsExclusionMode(checked as boolean)}
                                    />
                                </div>
                            </div>
                            <div className="space-y-2 border rounded-md p-4 bg-muted/20 max-h-48 overflow-y-auto">
                                {availableSellers.length > 0 ? (
                                    availableSellers.map((seller) => (
                                        <div key={seller.id} className="flex items-center space-x-2">
                                            <Checkbox
                                                id={`seller-${seller.id}`}
                                                checked={selectedSellers.includes(seller.id)}
                                                onCheckedChange={() => handleSellerSelection(seller.id)}
                                            />
                                            <Label htmlFor={`seller-${seller.id}`} className="text-sm font-normal">
                                                {seller.displayName}
                                            </Label>
                                        </div>
                                    ))
                                ) : (
                                    <p className="text-sm text-muted-foreground">No active sellers found.</p>
                                )}
                            </div>
                        </div>
                    </div>
                </ScrollArea>
            </SheetContent>
        </Sheet>
    );
}

================================================================================
FILE: src/components/home/CTA.tsx
================================================================================
// components/home/CTA.tsx
import Link from "next/link";
import { Button } from "@/components/ui/button";

export default function CTA() {
  return (
    <section className="py-16 sm:py-20">
      <div className="container mx-auto px-4 text-center bg-gradient-to-r from-primary to-accent/80 p-12 rounded-xl">
        <h2 className="text-3xl md:text-4xl font-bold text-white mb-4">Ready to Start Your Collection?</h2>
        <p className="text-white/90 max-w-2xl mx-auto mb-8">Join thousands of collectors who trust Picksy for authentic finds and secure transactions.</p>

        <div className="flex flex-col sm:flex-row gap-4 justify-center">
          <Button size="lg" variant="secondary" asChild className="w-full sm:w-auto">
            <Link href="/browse">Start Exploring</Link>
          </Button>
          <Button size="lg" variant="outline" asChild className="w-full sm:w-auto bg-transparent border-white text-white hover:bg-white hover:text-primary">
            <Link href="/about">Learn More</Link>
          </Button>
        </div>
      </div>
    </section>
  );
}

================================================================================
FILE: src/components/home/FeaturedCategories.tsx
================================================================================
'use client';
import Link from "next/link";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Coins, CreditCard, ToyBrick, Gamepad2, Star, Footprints } from "lucide-react";

const staticCategories = [
    { name: 'Pokemon', href: '/browse?q=pokemon', icon: <Gamepad2 className="h-6 w-6" /> },
    { name: '$1 Coins', href: '/browse?q=%241+coin', icon: <Coins className="h-6 w-6" /> },
    { name: '$2 Coins', href: '/browse?q=%242+coin', icon: <Coins className="h-6 w-6" /> },
    { name: '50c Coins', href: '/browse?q=50c+coin', icon: <Coins className="h-6 w-6" /> },
    { name: 'Barbie', href: '/browse?q=barbie', icon: <ToyBrick className="h-6 w-6" /> },
    { name: 'NBA', href: '/browse?q=nba', icon: <CreditCard className="h-6 w-6" /> },
    { name: 'Rookies', href: '/browse?q=rookie', icon: <Star className="h-6 w-6" /> },
    { name: 'Shoes', href: '/browse?q=shoes', icon: <Footprints className="h-6 w-6" /> },
];

export default function FeaturedCategories() {
  return (
    <section className="py-16 container mx-auto px-4">
      <div className="text-center mb-12">
        <h2 className="text-3xl md:text-4xl font-bold mb-4">Browse by Category</h2>
        <p className="text-muted-foreground max-w-2xl mx-auto">
          Explore our carefully curated categories to find exactly what you're looking for
        </p>
      </div>
      
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {staticCategories.map((category) => (
            <Link key={category.name} href={category.href} className="h-full">
            <Card className="group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 border-2 hover:border-primary h-full">
                <CardContent className="p-6 flex flex-col items-center justify-center text-center h-full">
                <div className="p-3 rounded-full bg-primary/10 text-primary mb-4 group-hover:scale-110 transition-transform">
                    {category.icon}
                </div>
                <h3 className="font-semibold mb-1">{category.name}</h3>
                <p className="text-xs text-muted-foreground">Explore â†’</p>
                </CardContent>
            </Card>
            </Link>
        ))}
      </div>
      
      <div className="text-center mt-12">
        <Button variant="outline" asChild>
          <Link href="/browse">View All Categories</Link>
        </Button>
      </div>
    </section>
  );
}

================================================================================
FILE: src/components/home/Hero.tsx
================================================================================
import Link from "next/link";
import { Button } from "@/components/ui/button";

export default function Hero({ productCount, error }: { productCount: number | null, error: string | null }) {
  const count = productCount ?? 0;
  return (
    <section className="bg-gray-50/50 dark:bg-background">
      <div className="container mx-auto px-4 py-16 text-center lg:py-24">
        <h1 className="text-4xl font-bold tracking-tight text-foreground sm:text-5xl md:text-6xl">
          Discover Rare Finds & Unique Collectibles
        </h1>
        <p className="mt-6 max-w-2xl mx-auto text-lg text-muted-foreground">
          Picksy is the premier marketplace for collectors, with over {count.toLocaleString()} items to discover. Buy, sell, and trade verified collectibles with complete confidence.
        </p>
        <div className="mt-10 flex justify-center gap-x-6">
          <Button asChild size="lg">
            <Link href="/browse">Start Exploring</Link>
          </Button>
          <Button asChild variant="outline" size="lg">
            <Link href="/consign">Sell with Us</Link>
          </Button>
        </div>
      </div>
    </section>
  );
}

================================================================================
FILE: src/components/home/MarketTrends.tsx
================================================================================

'use client';

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { TrendingUp } from "lucide-react";

const trends = [
  { name: "Graded PokÃ©mon", change: "+12.4%", volume: "$4.2M", color: "text-green-500" },
  { name: "Pre-War Coins", change: "+8.1%", volume: "$1.8M", color: "text-green-500" },
  { name: "NBA Top Shot", change: "-3.2%", volume: "$940K", color: "text-red-500" },
  { name: "Vintage Baseball", change: "+22.7%", volume: "$12.5M", color: "text-green-500" },
];

export function MarketTrends() {
  return (
    <Card className="bg-white dark:bg-white/5 rounded-xl p-6 border border-[#e7ebf3] dark:border-white/10">
      <CardHeader className="flex flex-row items-center justify-between mb-6 p-0">
        <CardTitle className="font-black text-lg">Market Trends</CardTitle>
        <TrendingUp className="h-5 w-5 text-primary" />
      </CardHeader>
      <CardContent className="p-0">
        <div className="space-y-5">
          {trends.map(trend => (
            <div key={trend.name} className="flex items-center justify-between group cursor-pointer">
              <div>
                <p className="text-sm font-bold">{trend.name}</p>
                <p className="text-[10px] text-gray-500 uppercase font-black">24h Volume</p>
              </div>
              <div className="text-right">
                <p className={`text-sm font-bold ${trend.color}`}>{trend.change}</p>
                <p className="text-[10px] text-gray-400">{trend.volume}</p>
              </div>
            </div>
          ))}
        </div>
        <Button variant="outline" className="w-full mt-6 text-xs font-black uppercase tracking-widest text-primary border-primary/20 rounded-lg hover:bg-primary/5 transition-colors">
            View Full Report
        </Button>
      </CardContent>
    </Card>
  );
}

================================================================================
FILE: src/components/home/WhyChooseUs.tsx
================================================================================

import { Shield, Truck, DollarSign, Users, Clock, Headphones } from "lucide-react";

const features = [
  {
    icon: Truck,
    title: "Secure Shipping",
    description: "Insured and tracked shipping with specialized packaging for collectibles.",
  },
  {
    icon: Clock,
    title: "Fast Transactions",
    description: "Quick payment processing and fast shipping for a seamless experience.",
  },
  {
    icon: Headphones,
    title: "Dedicated Support",
    description: "24/7 customer support from collectible experts ready to help you.",
  },
];

export default function WhyChooseUs() {
  return (
    <section className="py-16">
      <div className="text-center mb-12">
        <h2 className="text-3xl md:text-4xl font-bold mb-4">Why Collectors Choose Picksy</h2>
        <p className="text-muted-foreground max-w-2xl mx-auto">
          We've built the ultimate platform for collectors with features designed specifically for the collecting community
        </p>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
        {features.map((feature) => (
          <div key={feature.title} className="p-6 border rounded-xl hover:border-primary transition-colors">
            <div className="inline-flex p-3 rounded-lg bg-primary/10 text-primary mb-4">
              <feature.icon className="h-6 w-6" />
            </div>
            <h3 className="text-xl font-semibold mb-2">{feature.title}</h3>
            <p className="text-muted-foreground">{feature.description}</p>
          </div>
        ))}
      </div>
    </section>
  );
}

================================================================================
FILE: src/components/layout/AdminSidebar.tsx
================================================================================

"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import {
    Sidebar,
    SidebarContent,
    SidebarHeader,
    SidebarMenu,
    SidebarMenuItem,
    SidebarMenuButton,
    SidebarTrigger,
    SidebarFooter,
} from "@/components/ui/sidebar";
import {
    LayoutDashboard,
    Box,
    Shapes,
    MessageSquareWarning,
    BarChart,
    ShieldCheck,
    ShieldAlert,
    Home,
    Settings,
    Zap,
    Users,
    Globe,
    Activity,
    ListChecks
} from "lucide-react";
import { Logo } from "@/components/logo";
import { motion } from "framer-motion";
import { useUser } from "@/firebase";
import { useSidebar } from "@/components/layout/sidebar-provider";
import { cn } from "@/lib/utils";

const navItems = [
    { href: "/admin", icon: LayoutDashboard, label: "Dashboard" },
    { href: "/admin/products", icon: Box, label: "Products" },
    { href: "/admin/management", icon: ListChecks, label: "Management" },
    { href: "/admin/users", icon: Users, label: "Users" },
    { href: "/admin/disputes", icon: MessageSquareWarning, label: "Disputes" },
    { href: "/admin/analytics", icon: BarChart, label: "Analytics" },
];

const integrityItems = [
    { href: "/admin/moderation", icon: ShieldCheck, label: "Moderation" },
    { href: "/admin/fraud-detection", icon: ShieldAlert, label: "Fraud Lab" },
];

const sysItems = [
    { href: "/admin/seo", icon: Globe, label: "SEO" },
    { href: "/admin/system", icon: Activity, label: "System Health" },
    { href: "/admin/settings", icon: Settings, label: "System Settings" },
];

export default function AdminSidebar() {
    const pathname = usePathname();
    const { user } = useUser();
    const { isSidebarOpen, isHovered } = useSidebar();
    const effectiveOpen = isSidebarOpen || isHovered;

    return (
        <Sidebar>
            <SidebarHeader className="p-6">
                <div className="flex items-center justify-between w-full">
                    {effectiveOpen ? (
                        <Link href="/admin" className="block transform transition-transform hover:scale-105">
                            <Logo className="w-auto h-8" />
                        </Link>
                    ) : (
                        <div className="mx-auto bg-primary/10 p-2 rounded-lg">
                            <Zap className="h-5 w-5 text-primary" />
                        </div>
                    )}
                    {effectiveOpen && <SidebarTrigger />}
                </div>
            </SidebarHeader>

            <SidebarContent className="px-4 py-2">
                <SidebarMenu>
                    <SidebarMenuItem>
                        <SidebarMenuButton asChild tooltip="Return to Marketplace">
                            <Link href="/">
                                <Home />
                                <span>Marketplace</span>
                            </Link>
                        </SidebarMenuButton>
                    </SidebarMenuItem>
                </SidebarMenu>

                <div className="my-4 px-4">
                    <div className="h-px bg-border" />
                </div>

                <SidebarMenu className="space-y-1">
                    {navItems.map((item) => {
                        const isActive = pathname === item.href;
                        return (
                            <SidebarMenuItem key={item.href}>
                                <Link href={item.href}>
                                    <SidebarMenuButton
                                        isActive={isActive}
                                        tooltip={item.label}
                                        className="relative group overflow-hidden"
                                    >
                                        <item.icon />
                                        <span>{item.label}</span>
                                        {isActive && effectiveOpen && (
                                            <motion.div
                                                layoutId="active-pill"
                                                className="absolute left-0 w-1 h-6 bg-primary rounded-full"
                                                transition={{ type: 'spring', stiffness: 300, damping: 30 }}
                                            />
                                        )}
                                    </SidebarMenuButton>
                                </Link>
                            </SidebarMenuItem>
                        );
                    })}
                </SidebarMenu>

                <div className="my-4 px-4">
                    {effectiveOpen && <div className="text-[10px] uppercase font-bold text-muted-foreground tracking-widest px-2 mb-2">Integrity</div>}
                    <SidebarMenu className="space-y-1">
                        {integrityItems.map((item) => {
                            const isActive = pathname === item.href;
                            return (
                                <SidebarMenuItem key={item.href}>
                                    <Link href={item.href}>
                                        <SidebarMenuButton isActive={isActive} tooltip={item.label}>
                                            <item.icon />
                                            <span>{item.label}</span>
                                        </SidebarMenuButton>
                                    </Link>
                                </SidebarMenuItem>
                            );
                        })}
                    </SidebarMenu>
                </div>


                <div className="my-4 px-4">
                    {effectiveOpen && <div className="text-[10px] uppercase font-bold text-muted-foreground tracking-widest px-2 mb-2">Configuration</div>}
                    <SidebarMenu className="space-y-1">
                        {sysItems.map((item) => {
                            const isActive = pathname === item.href;
                            return (
                                <SidebarMenuItem key={item.href}>
                                    <Link href={item.href}>
                                        <SidebarMenuButton isActive={isActive} tooltip={item.label}>
                                            <item.icon />
                                            <span>{item.label}</span>
                                        </SidebarMenuButton>
                                    </Link>
                                </SidebarMenuItem>
                            );
                        })}
                    </SidebarMenu>
                </div>
            </SidebarContent>

            <SidebarFooter className={cn("p-6 border-t transition-all", !effectiveOpen && "p-2 px-4")}>
                <SidebarMenu>
                    <SidebarMenuItem>
                        <SidebarMenuButton asChild tooltip="Admin Profile">
                            <Link href="/profile" className={cn("flex items-center gap-3 p-2 rounded-lg hover:bg-muted transition-all", !effectiveOpen && "justify-center gap-0 p-0")}>
                                <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-primary to-accent flex items-center justify-center text-[10px] font-black text-white shrink-0">
                                    {user?.displayName?.[0] || 'A'}
                                </div>
                                {effectiveOpen && (
                                    <div className="flex flex-col">
                                        <span className="text-xs font-bold text-foreground">{user?.displayName || 'Administrator'}</span>
                                        <span className="text-[10px] text-muted-foreground font-mono tracking-tighter uppercase">Root Access</span>
                                    </div>
                                )}
                            </Link>
                        </SidebarMenuButton>
                    </SidebarMenuItem>
                </SidebarMenu>
            </SidebarFooter>
        </Sidebar>
    );
}

================================================================================
FILE: src/components/layout/CoinsSidebar.tsx
================================================================================

'use client'; // This component is now interactive and used within a client component

import {
  Coins,
  Shield,
  Globe,
  Calendar,
  Scale,
  Landmark,
  Diamond,
} from 'lucide-react';
import type { Category } from '@/lib/types';
import Link from 'next/link';
import { cn } from '@/lib/utils';
import { Card, CardContent } from '@/components/ui/card';
import { SidebarToggle } from './sidebar-toggle';
import { useSidebar } from '@/components/layout/sidebar-provider';

const staticCoinNavItems = [
  { title: 'All Coins', href: '/coins', icon: Landmark, isStatic: true },
  { title: 'World Coins', href: '/coins/world', icon: Globe, isStatic: true },
  { title: 'Ancient Coins', href: '/coins/ancient', icon: Shield, isStatic: true },
  { title: 'Bullion', href: '/coins/bullion', icon: Diamond, isStatic: true },
];

export function CoinsSidebar({ pathname, categories }: { pathname: string; categories: Category[] }) {
  const { isSidebarOpen } = useSidebar();
  
  const dynamicNavItems = categories.map((cat: Category) => ({
    title: cat.name,
    href: cat.href,
    icon: Coins, // Default icon for dynamic categories
  }));

  const combinedNavItems = [...staticCoinNavItems, ...dynamicNavItems];

  return (
    <div className={cn("flex flex-col h-full bg-muted/40", isSidebarOpen ? 'w-64' : 'w-20' )}>
        <div className="flex items-center justify-between p-4 border-b h-16">
            <div className="flex items-center">
                <Coins className="h-8 w-8 text-primary flex-shrink-0" />
                <h1 className={cn('ml-3 text-xl font-bold font-headline transition-opacity duration-200', isSidebarOpen ? 'opacity-100' : 'opacity-0 w-0')}>
                    Coins
                </h1>
            </div>
            <SidebarToggle />
        </div>
        <nav className="flex-grow p-2 space-y-1">
            <ul className="space-y-2">
            {combinedNavItems.map((item) => (
                <li key={item.title}>
                <Link
                    href={item.href}
                    className={cn(
                    'flex items-center p-3 rounded-lg',
                    pathname === item.href
                        ? 'bg-primary text-primary-foreground'
                        : 'text-foreground/80 hover:bg-muted hover:text-foreground',
                    !isSidebarOpen && 'justify-center'
                    )}
                >
                    <item.icon className="h-6 w-6 flex-shrink-0" />
                    <span
                    className={cn(
                        'ml-4 font-medium transition-opacity duration-200 whitespace-nowrap',
                        isSidebarOpen ? 'opacity-100' : 'opacity-0 w-0'
                    )}
                    >
                    {item.title}
                    </span>
                </Link>
                </li>
            ))}
            </ul>
        </nav>
    </div>
  );
}

================================================================================
FILE: src/components/layout/Footer.tsx
================================================================================

import Link from 'next/link';
import { Logo } from '../logo';
import { NewsletterSignup } from './NewsletterSignup';

const footerLinks = {
  Marketplace: [
    { name: 'Featured Assets', href: '/browse' },
    { name: 'Recently Verified', href: '/browse?sort=verified-desc' },
    { name: 'Auctions', href: '/browse?type=auction' },
    { name: 'Private Sales', href: '/sell' },
  ],
  Company: [
    { name: 'Our AI Tech', href: '/about' },
    { name: 'Grading Standards', href: '/how-it-works' },
    { name: 'Authenticity Guarantee', href: '/vault' },
    { name: 'Careers', href: '/about' },
  ],
};

export default function Footer() {
  return (
    <footer className="bg-white dark:bg-background-dark border-t border-[#e7ebf3] dark:border-white/10 py-12 px-4 md:px-10">
      <div className="max-w-[1440px] mx-auto grid grid-cols-2 md:grid-cols-4 gap-8">
        <div className="col-span-2 md:col-span-1">
          <div className="flex items-center gap-2 text-primary mb-6">
            <Logo />
          </div>
          <p className="text-sm text-gray-500 max-w-xs">The world's most trusted AI-powered marketplace for ultra-high-end collectibles.</p>
        </div>
        {Object.entries(footerLinks).map(([category, links]) => (
          <div key={category}>
            <h5 className="font-black text-xs uppercase tracking-widest mb-6">{category}</h5>
            <ul className="space-y-4 text-sm text-gray-500 dark:text-gray-400">
              {links.map((link) => (
                <li key={link.name}>
                  <Link href={link.href} className="hover:text-primary transition-colors">
                    {link.name}
                  </Link>
                </li>
              ))}
            </ul>
          </div>
        ))}
        <div>
          <h5 className="font-black text-xs uppercase tracking-widest mb-6">Newsletter</h5>
          <p className="text-sm text-gray-500 mb-4">Get early access to weekly drops.</p>
          <NewsletterSignup />
        </div>
      </div>
      <div className="max-w-[1440px] mx-auto mt-12 pt-8 border-t border-[#e7ebf3] dark:border-white/10 flex flex-col md:flex-row justify-between items-center gap-4 text-xs text-gray-400">
        <Link href="/log" className="cursor-default hover:text-gray-400 transition-colors">
          Â© {new Date().getFullYear()} Picksy AI Technologies Inc. All rights reserved.
        </Link>
        <div className="flex gap-8">
          <Link href="/privacy" className="hover:text-primary transition-colors">Privacy Policy</Link>
          <Link href="/terms" className="hover:text-primary transition-colors">Terms of Service</Link>
        </div>
      </div>
    </footer>
  );
}

================================================================================
FILE: src/components/layout/Header.tsx
================================================================================

'use client';

import Link from 'next/link';
import { Logo } from '../logo';
import { MobileNav } from './mobile-nav';
import HeaderActions from './HeaderActions';
import { Suspense, useEffect, useState } from 'react';
import { MainNavLinks } from './MainNavLinks';
import { SearchBar } from './search-bar';

export default function Header() {
  const [isClient, setIsClient] = useState(false);

  useEffect(() => {
    setTimeout(() => {
        setIsClient(true);
    }, 0);
  }, []);

  return (
    <header className="sticky top-0 glass-nav z-50 px-4 md:px-10 py-3">
      <div className="max-w-[1440px] mx-auto flex items-center justify-between gap-8">
        <div className="flex items-center gap-4 md:gap-8 flex-1">
          {isClient && <MobileNav />}
          <Link href="/" className="flex items-center" aria-label="Back to homepage">
            <Logo />
          </Link>
          {isClient && <SearchBar className="hidden lg:flex flex-1 max-w-2xl h-10 group" />}
        </div>
        
        <div className="hidden md:flex items-center gap-8">
          {isClient && <MainNavLinks />}
        </div>
        
        <div className="flex items-center justify-end gap-2">
            {isClient && (
              <Suspense fallback={<div className="h-10 w-24 bg-muted/20 rounded-md" />}>
                <HeaderActions />
              </Suspense>
            )}
        </div>
      </div>
    </header>
  );
}

================================================================================
FILE: src/components/layout/HeaderActions.tsx
================================================================================
'use client';

import { useState } from 'react';
import { ShoppingCart, Search } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { useCart } from '@/context/CartContext';
import { UserNav } from './user-nav';
import { SearchCommand } from '@/components/search/SearchCommand';
import { NotificationBell } from '../notifications/NotificationBell';
import Link from 'next/link';
import { useUser } from '@/firebase/auth/use-user';

export default function HeaderActions() {
    const { itemCount, setIsCartOpen } = useCart();
    const [open, setOpen] = useState(false);
    const { user } = useUser();

    return (
        <div className="flex items-center justify-end space-x-1 md:space-x-2">
            <div className="lg:hidden">
                <Button variant="ghost" size="icon" onClick={() => setOpen(true)} aria-label="Open search">
                    <Search className="h-5 w-5" />
                </Button>
            </div>

            <NotificationBell />

            {user && (
                <div className="hidden md:flex items-center gap-2">
                    <Button asChild variant="default" size="sm" className="hidden sm:flex">
                        <Link href="/sell/create">New</Link>
                    </Button>
                </div>
            )}

            <Button
                variant="ghost"
                size="icon"
                className="relative"
                onClick={() => setIsCartOpen(true)}
                aria-label={`Open cart with ${itemCount} items`}
            >
                <ShoppingCart className="h-5 w-5" />
                {itemCount > 0 && (
                    <span className="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-primary text-xs text-white">
                        {itemCount}
                    </span>
                )}
            </Button>

            <UserNav />

            <SearchCommand open={open} setOpen={setOpen} />
        </div>
    )
}

================================================================================
FILE: src/components/layout/MainNavLinks.tsx
================================================================================

"use client"

import Link from 'next/link';
import {
  NavigationMenu,
  NavigationMenuItem,
  NavigationMenuLink,
  NavigationMenuList,
} from '@/components/ui/navigation-menu';
import { navigationMenuTriggerStyle } from '@/components/ui/navigation-menu';
import { useUser } from '@/firebase';

export function MainNavLinks() {
  const { user } = useUser();

  return (
    <NavigationMenu>
      <NavigationMenuList>
        <NavigationMenuItem>
          <NavigationMenuLink asChild className={navigationMenuTriggerStyle()}>
            <Link href="/collector-cards">
              Cards
            </Link>
          </NavigationMenuLink>
        </NavigationMenuItem>
        <NavigationMenuItem>
          <NavigationMenuLink asChild className={navigationMenuTriggerStyle()}>
            <Link href="/coins">
              Coins
            </Link>
          </NavigationMenuLink>
        </NavigationMenuItem>
        <NavigationMenuItem>
          <NavigationMenuLink asChild className={navigationMenuTriggerStyle()}>
            <Link href="/collectibles">
              Memorabilia
            </Link>
          </NavigationMenuLink>
        </NavigationMenuItem>
        <NavigationMenuItem>
          <NavigationMenuLink asChild className={navigationMenuTriggerStyle()}>
            <Link href="/general">
              General
            </Link>
          </NavigationMenuLink>
        </NavigationMenuItem>
        <NavigationMenuItem>
          <NavigationMenuLink asChild className={navigationMenuTriggerStyle()}>
            <Link href="/consign">
              Consign
            </Link>
          </NavigationMenuLink>
        </NavigationMenuItem>
        {user && (
          <NavigationMenuItem>
            <NavigationMenuLink asChild className={navigationMenuTriggerStyle()}>
              <Link href="/research">
                Research
              </Link>
            </NavigationMenuLink>
          </NavigationMenuItem>
        )}
      </NavigationMenuList>
    </NavigationMenu>
  );
}

================================================================================
FILE: src/components/layout/MobileNavContent.tsx
================================================================================


'use client';

import { useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { signOutUser } from '@/lib/firebase/auth';
import { useUser, useDoc, useMemoFirebase, useCollection } from '@/firebase';
import { collection, query, orderBy, doc } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
    LayoutGrid, Tag, User, Heart, ShoppingBag, LayoutDashboard, Shield, LogOut, LogIn,
    Coins, CreditCard, Gem, BookOpen, Stamp, Gamepad2, Search
} from 'lucide-react';
import type { Category, UserProfile } from '@/lib/types';
import { Skeleton } from '../ui/skeleton';
import { useUserPermissions } from '@/hooks/use-user-permissions';

// Helper to map DB sections to Icons
const iconMap: Record<string, any> = {
    'coins': Coins,
    'collector-cards': CreditCard,
    'collectibles': Gem,
    'comics': BookOpen,
    'stamps': Stamp,
    'video-games': Gamepad2,
};

export function MobileNavContent({ setIsOpen }: { setIsOpen: (isOpen: boolean) => void }) {
    const { user } = useUser();
    const router = useRouter();
    const { isSuperAdmin, isLoading: isPermissionsLoading } = useUserPermissions();

    // 1. Fetch Categories Dynamically
    const categoriesQuery = useMemoFirebase(() => query(collection(db, 'categories'), orderBy('name')), []);
    const { data: categories } = useCollection<Category>(categoriesQuery);

    // 2. Group Categories by Section
    const groupedCategories = useMemo(() => {
        const mainSections = {
            'collector-cards': { label: 'Collector Cards', icon: CreditCard, href: '/collector-cards', items: [] as Category[] },
            'coins': { label: 'Coins', icon: Coins, href: '/coins', items: [] as Category[] },
            'collectibles': { label: 'Collectibles', icon: Gem, href: '/collectibles', items: [] as Category[] },
        } as Record<string, { label: string, icon: any, href: string, items: Category[] }>;

        if (!categories) return mainSections;

        categories.forEach(cat => {
            if (mainSections[cat.section]) {
                mainSections[cat.section].items.push(cat);
            } else {
                if (!mainSections.collectibles) {
                    mainSections.collectibles = { label: 'Collectibles', icon: Gem, href: '/collectibles', items: [] };
                }
                mainSections.collectibles.items.push(cat);
            }
        });
        return mainSections;
    }, [categories]);

    const handleLinkClick = (href: string) => {
        router.push(href);
        setIsOpen(false);
    };

    const handleSignOut = async () => {
        await signOutUser();
        setIsOpen(false);
        router.push('/');
    };

    return (
        <ScrollArea className="flex-1 h-[calc(100vh-80px)]">
            <div className="p-4 space-y-4 pb-20">
                {/* Main Actions */}
                <nav className="flex flex-col space-y-1">
                    <Button variant="ghost" className="justify-start text-base" onClick={() => handleLinkClick('/collector-cards')}>
                        <CreditCard className="mr-3 h-5 w-5" /> Cards
                    </Button>
                    <Button variant="ghost" className="justify-start text-base" onClick={() => handleLinkClick('/coins')}>
                        <Coins className="mr-3 h-5 w-5" /> Coins
                    </Button>
                    <Button variant="ghost" className="justify-start text-base" onClick={() => handleLinkClick('/collectibles')}>
                        <Gem className="mr-3 h-5 w-5" /> Memorabilia
                    </Button>
                    <Button variant="ghost" className="justify-start text-base" onClick={() => handleLinkClick('/general')}>
                        <LayoutGrid className="mr-3 h-5 w-5" /> General
                    </Button>
                    <Button variant="ghost" className="justify-start text-base" onClick={() => handleLinkClick('/consign')}>
                        <Tag className="mr-3 h-5 w-5" /> Consign
                    </Button>
                    {user && (
                        <Button variant="ghost" className="justify-start text-base" onClick={() => handleLinkClick('/research')}>
                            <Search className="mr-3 h-5 w-5" /> Research
                        </Button>
                    )}
                </nav>

                {/* Dynamic Categories Accordion */}
                <div className="py-2">
                    <h3 className="px-4 text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2">Categories</h3>
                    <Accordion type="multiple" className="w-full">
                        {Object.entries(groupedCategories).map(([section, data]) => {
                            if (data.items.length === 0) return null;
                            const Icon = data.icon || LayoutGrid;

                            return (
                                <AccordionItem key={section} value={section} className="border-b-0">
                                    <AccordionTrigger className="text-base font-medium px-4 py-2 hover:bg-muted/50 rounded-md hover:no-underline">
                                        <div className="flex items-center">
                                            <Icon className="mr-3 h-5 w-5" />
                                            {data.label}
                                        </div>
                                    </AccordionTrigger>
                                    <AccordionContent>
                                        <div className="flex flex-col pl-8 space-y-1 mt-1">
                                            <Button
                                                variant="ghost"
                                                size="sm"
                                                className="justify-start text-muted-foreground h-9 font-semibold"
                                                onClick={() => handleLinkClick(data.href)}
                                            >
                                                View All {data.label}
                                            </Button>
                                            {data.items.map((cat) => (
                                                <Button
                                                    key={cat.id}
                                                    variant="ghost"
                                                    size="sm"
                                                    className="justify-start text-muted-foreground h-8"
                                                    onClick={() => handleLinkClick(cat.href || `/category/${cat.id}`)}
                                                >
                                                    {cat.name}
                                                </Button>
                                            ))}
                                        </div>
                                    </AccordionContent>
                                </AccordionItem>
                            );
                        })}
                    </Accordion>
                </div>

                {/* User Account Section */}
                <div className="border-t pt-4">
                    {user ? (
                        <>
                            <h3 className="px-4 text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2">My Account</h3>
                            <div className="space-y-1">
                                {isPermissionsLoading ? (
                                    <div className="flex items-center px-4 py-2">
                                        <Skeleton className="mr-3 h-5 w-5 rounded-sm" />
                                        <Skeleton className="h-5 w-32" />
                                    </div>
                                ) : isSuperAdmin ? (
                                    <Button variant="ghost" className="justify-start w-full" onClick={() => handleLinkClick('/admin')}>
                                        <Shield className="mr-3 h-5 w-5 text-primary" /> Admin Dashboard
                                    </Button>
                                ) : null}

                                <Button variant="ghost" className="justify-start w-full" onClick={() => handleLinkClick('/profile')}>
                                    <User className="mr-3 h-5 w-5" /> My Profile
                                </Button>
                                <Button variant="ghost" className="justify-start w-full" onClick={() => handleLinkClick('/profile/favorites')}>
                                    <Heart className="mr-3 h-5 w-5" /> My Favorites
                                </Button>
                                <Button variant="ghost" className="justify-start w-full" onClick={() => handleLinkClick('/profile/listings')}>
                                    <ShoppingBag className="mr-3 h-5 w-5" /> My Listings
                                </Button>
                            </div>

                            <div className="border-t mt-4 pt-4">
                                <Button variant="ghost" className="justify-start w-full text-muted-foreground hover:text-destructive" onClick={handleSignOut}>
                                    <LogOut className="mr-3 h-5 w-5" /> Sign Out
                                </Button>
                            </div>
                        </>
                    ) : (
                        <div className="space-y-1">
                            <h3 className="px-4 text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2">Account</h3>
                            <Button variant="ghost" className="justify-start w-full" onClick={() => handleLinkClick('/sign-in')}>
                                <LogIn className="mr-3 h-5 w-5" /> Sign In
                            </Button>
                            <Button variant="ghost" className="justify-start w-full" onClick={() => handleLinkClick('/sign-up')}>
                                <User className="mr-3 h-5 w-5" /> Create Account
                            </Button>
                        </div>
                    )}
                </div>
            </div>
        </ScrollArea>
    );
}

================================================================================
FILE: src/components/layout/NewsletterSignup.tsx
================================================================================
'use client';

import { useFormStatus } from 'react-dom';
import { useActionState, useEffect, useRef } from 'react';
import { subscribeToNewsletter, type NewsletterState } from '@/app/actions/newsletter';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Send, Loader2, Check } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

const initialState: NewsletterState = {
    message: '',
    error: '',
};

function SubmitButton() {
    const { pending } = useFormStatus();
    return (
        <Button size="icon" className="rounded-lg" disabled={pending} type="submit">
            {pending ? <Loader2 className="h-4 w-4 animate-spin" /> : <Send className="h-4 w-4" />}
        </Button>
    );
}

export function NewsletterSignup() {
    const [state, formAction] = useActionState(subscribeToNewsletter, initialState);
    const formRef = useRef<HTMLFormElement>(null);
    const { toast } = useToast();

    useEffect(() => {
        if (state.success) {
            formRef.current?.reset();
            toast({
                title: "Subscribed!",
                description: state.message,
            });
        } else if (state.error) {
            toast({
                title: "Error",
                description: state.error,
                variant: "destructive",
            });
        }
    }, [state, toast]);

    if (state.success) {
         return (
            <div className="flex items-center gap-2 text-green-600 font-medium h-10 p-2 bg-green-50 rounded-lg border border-green-100">
                <Check className="h-4 w-4" />
                <span className="text-sm">Subscribed!</span>
            </div>
        );
    }

    return (
        <form ref={formRef} action={formAction} className="flex gap-2">
            <Input 
                name="email" 
                className="flex-1 rounded-lg border-[#e7ebf3] dark:border-white/10 bg-transparent text-sm" 
                placeholder="Email" 
                type="email" 
                required
            />
            <SubmitButton />
        </form>
    );
}

