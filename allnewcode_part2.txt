PART 2 OF 2
CONTENTS: src/components (UI, Features, Layouts)
================================================================================


--------------------------------------------------------------------------------
FILE: src/components/ErrorBoundary.tsx
--------------------------------------------------------------------------------

'use client';
import React from 'react';
import { Button } from '@/components/ui/button';
import { AlertTriangle } from 'lucide-react';

interface ErrorBoundaryState {
    hasError: boolean;
    error?: Error;
}

export class ErrorBoundary extends React.Component<
    { children: React.ReactNode },
    ErrorBoundaryState
> {
    constructor(props: any) {
        super(props);
        this.state = { hasError: false };
    }

    static getDerivedStateFromError(error: Error): ErrorBoundaryState {
        return { hasError: true, error };
    }

    componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
        console.error('Error caught by boundary:', error, errorInfo);

        // Log to error tracking service (in production)
        if (typeof window !== 'undefined') {
            try {
                // Will implement error logging service
                fetch('/api/log-error', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        error: error.message,
                        stack: error.stack,
                        componentStack: errorInfo.componentStack,
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString(),
                    }),
                }).catch(console.error);
            } catch (e) {
                console.error('Failed to log error:', e);
            }
        }
    }

    render() {
        if (this.state.hasError) {
            return (
                <div className="flex min-h-screen items-center justify-center bg-gray-50 px-4">
                    <div className="text-center max-w-md">
                        <div className="flex justify-center mb-4">
                            <AlertTriangle className="h-16 w-16 text-red-500" />
                        </div>
                        <h1 className="text-3xl font-bold text-gray-900 mb-2">
                            Oops! Something went wrong
                        </h1>
                        <p className="text-gray-600 mb-6">
                            We've encountered an unexpected error. Don't worry, our team has been notified and we're working to fix it.
                        </p>
                        <div className="flex flex-col sm:flex-row gap-3 justify-center">
                            <Button
                                onClick={() => {
                                    this.setState({ hasError: false, error: undefined });
                                    window.location.href = '/';
                                }}
                                variant="default"
                            >
                                Return Home
                            </Button>
                            <Button
                                onClick={() => window.location.reload()}
                                variant="outline"
                            >
                                Reload Page
                            </Button>
                        </div>
                        {process.env.NODE_ENV === 'development' && this.state.error && (
                            <details className="mt-6 text-left">
                                <summary className="cursor-pointer text-sm text-gray-500 hover:text-gray-700">
                                    Error Details (Dev Only)
                                </summary>
                                <pre className="mt-2 p-4 bg-gray-100 rounded text-xs overflow-auto">
                                    {this.state.error.stack}
                                </pre>
                            </details>
                        )}
                    </div>
                </div>
            );
        }

        return this.props.children;
    }
}


--------------------------------------------------------------------------------
FILE: src/components/FirebaseErrorListener.tsx
--------------------------------------------------------------------------------


'use client';

import { useEffect } from 'react';
import { errorEmitter } from '@/firebase/error-emitter';
import { FirestorePermissionError } from '@/firebase/errors';

/**
 * A client-side component that listens for Firestore permission errors
 * and throws them to be caught by Next.js's development error overlay.
 * This is essential for debugging Security Rules during development.
 */
export function FirebaseErrorListener() {
  useEffect(() => {
    const handleError = (error: FirestorePermissionError) => {
      // Throwing the error here will trigger the Next.js error overlay
      // in development, showing the detailed permission error message.
      throw error;
    };

    // Subscribe to the custom 'permission-error' event
    errorEmitter.on('permission-error', handleError);

    // Clean up the subscription when the component unmounts
    return () => {
      errorEmitter.off('permission-error', handleError);
    };
  }, []); // Run this effect only once when the component mounts

  // This component does not render anything to the DOM.
  return null;
}


--------------------------------------------------------------------------------
FILE: src/components/ar-camera-overlay.tsx
--------------------------------------------------------------------------------


'use client';

interface ARCameraOverlayProps {
  guideType: 'card' | 'coin';
}

export function ARCameraOverlay({ guideType }: ARCameraOverlayProps) {
  const guideStyles = {
    card: {
      aspectRatio: '1 / 1.4', // Standard trading card aspect ratio
      width: '80%',
      border: '2px dashed white',
      borderRadius: '4%',
    },
    coin: {
      aspectRatio: '1 / 1',
      width: '70%',
      border: '2px dashed white',
      borderRadius: '50%',
    },
  };

  return (
    <div
      className="absolute inset-0 flex items-center justify-center pointer-events-none"
    >
      <div
        style={guideStyles[guideType]}
        className="shadow-[0_0_0_9999px_rgba(0,0,0,0.5)]"
      />
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/logo.tsx
--------------------------------------------------------------------------------

import { Sparkles } from 'lucide-react';
import { cn } from '@/lib/utils';

export function Logo({ className }: { className?: string }) {
    return (
        <div className={cn("flex items-center gap-2 text-primary", className)}>
            <div className="size-8 bg-primary rounded-lg flex items-center justify-center text-white">
                <Sparkles className="h-5 w-5" />
            </div>
            <h2 className="text-[#0d121b] dark:text-white text-xl font-black leading-tight tracking-tight">Picksy</h2>
        </div>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/admin/StatsGrid.tsx
--------------------------------------------------------------------------------

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { DollarSign, ShieldAlert, Users, Package } from "lucide-react";

interface AdminStatsGridProps {
    stats: {
        revenue: number;
        alerts: number;
        sellers: number;
        items: number;
    }
}

export function AdminStatsGrid({ stats }: AdminStatsGridProps) {
  const items = [
    { title: "Revenue", value: `$${stats.revenue.toLocaleString()}`, icon: DollarSign, color: "text-green-500" },
    { title: "Risk Alerts", value: stats.alerts, icon: ShieldAlert, color: "text-red-500" },
    { title: "Active Sellers", value: stats.sellers, icon: Users, color: "text-blue-500" },
    { title: "Total Items", value: stats.items, icon: Package, color: "text-purple-500" },
  ];
  return (
    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
      {items.map((stat) => (
        <Card key={stat.title}>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">{stat.title}</CardTitle>
            <stat.icon className={`h-4 w-4 ${stat.color}`} />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stat.value}</div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/admin/management/AttributesManager.tsx
--------------------------------------------------------------------------------


'use client';

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { doc, onSnapshot, updateDoc, arrayUnion, arrayRemove } from 'firebase/firestore';
import { useFirebase, useMemoFirebase, useDoc } from '@/firebase';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useToast } from '@/hooks/use-toast';
import { Loader2, Plus, Trash2, Tag } from 'lucide-react';

interface Attributes {
    conditions?: string[];
    manufacturers?: string[];
    brands?: string[];
}

const attributeSchema = z.object({
    newValue: z.string().min(1, 'Value cannot be empty'),
});

type AttributeFormValues = z.infer<typeof attributeSchema>;

type AttributeType = keyof Attributes;

const AttributeEditor = ({ title, attributeKey, data, isLoading }: { title: string, attributeKey: AttributeType, data: Attributes | null, isLoading: boolean }) => {
    const { firestore } = useFirebase();
    const { toast } = useToast();
    const [isSubmitting, setIsSubmitting] = useState(false);
    const form = useForm<AttributeFormValues>({ resolver: zodResolver(attributeSchema) });

    const values = data?.[attributeKey] || [];

    const handleAdd = async (formData: AttributeFormValues) => {
        if (!firestore) return;
        setIsSubmitting(true);
        try {
            const optionsRef = doc(firestore, 'settings', 'marketplace_options');
            await updateDoc(optionsRef, {
                [attributeKey]: arrayUnion(formData.newValue)
            });
            toast({ title: `${title} value added.` });
            form.reset({ newValue: '' });
        } catch (error: any) {
            toast({ title: 'Error', description: error.message, variant: 'destructive' });
        } finally {
            setIsSubmitting(false);
        }
    };

    const handleRemove = async (value: string) => {
        if (!firestore) return;
        try {
            const optionsRef = doc(firestore, 'settings', 'marketplace_options');
            await updateDoc(optionsRef, {
                [attributeKey]: arrayRemove(value)
            });
            toast({ title: `${title} value removed.` });
        } catch (error: any) {
            toast({ title: 'Error', description: error.message, variant: 'destructive' });
        }
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2"><Tag className="w-5 h-5 text-primary" /> {title}</CardTitle>
            </CardHeader>
            <CardContent>
                <form onSubmit={form.handleSubmit(handleAdd)} className="flex gap-2 mb-4">
                    <Input {...form.register('newValue')} placeholder={`New ${title} value...`} />
                    <Button type="submit" disabled={isSubmitting}>
                        {isSubmitting ? <Loader2 className="animate-spin h-4 w-4" /> : <Plus className="h-4 w-4" />}
                    </Button>
                </form>
                {isLoading ? (
                    <div className="flex justify-center p-4"><Loader2 className="h-6 w-6 animate-spin" /></div>
                ) : (
                    <div className="space-y-2 max-h-48 overflow-y-auto">
                        {values.map(val => (
                            <div key={val} className="flex items-center justify-between p-2 rounded bg-muted/50">
                                <span className="text-sm">{val}</span>
                                <Button size="icon" variant="ghost" className="h-7 w-7" onClick={() => handleRemove(val)}>
                                    <Trash2 className="h-4 w-4 text-destructive" />
                                </Button>
                            </div>
                        ))}
                    </div>
                )}
            </CardContent>
        </Card>
    );
};

export default function AttributesManager() {
    const { firestore } = useFirebase();
    const optionsRef = useMemoFirebase(() => firestore ? doc(firestore, 'settings', 'marketplace_options') : null, [firestore]);
    const { data, isLoading } = useDoc<Attributes>(optionsRef);
    
    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <AttributeEditor title="Conditions" attributeKey="conditions" data={data} isLoading={isLoading} />
            <AttributeEditor title="Manufacturers" attributeKey="manufacturers" data={data} isLoading={isLoading} />
            <AttributeEditor title="Brands" attributeKey="brands" data={data} isLoading={isLoading} />
        </div>
    );
}



--------------------------------------------------------------------------------
FILE: src/components/admin/management/CategoriesManager.tsx
--------------------------------------------------------------------------------


'use client';

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import {
  collection,
  onSnapshot,
  query,
  orderBy,
  addDoc,
  deleteDoc,
  doc,
  updateDoc,
  serverTimestamp
} from 'firebase/firestore';
import { useFirebase } from '@/firebase';
import type { Category } from '@/lib/types';
import { Card, CardContent, CardHeader, CardTitle, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Loader2, PlusCircle, Trash2, Edit } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog"

const categorySchema = z.object({
  name: z.string().min(2, 'Category name is required.'),
  section: z.string().min(2, 'Section slug is required (e.g., collector-cards).'),
  href: z.string().min(1, 'Href is required (e.g., /collector-cards/sports).')
});

type CategoryFormValues = z.infer<typeof categorySchema>;

export default function CategoriesManager() {
  const [categories, setCategories] = useState<Category[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [editingCategory, setEditingCategory] = useState<Category | null>(null);
  const { toast } = useToast();
  const { firestore } = useFirebase();

  const form = useForm<CategoryFormValues>({
    resolver: zodResolver(categorySchema),
    defaultValues: { name: '', section: '', href: '' },
  });
  
  useEffect(() => {
    if (!firestore) return;
    const q = query(collection(firestore, 'categories'), orderBy('name', 'asc'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const cats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Category));
      setCategories(cats);
      setIsLoading(false);
    }, (error) => {
        console.error("Error fetching categories: ", error);
        toast({ title: 'Failed to load categories.', description: error.message, variant: 'destructive' });
        setIsLoading(false);
    });
    return () => unsubscribe();
  }, [firestore, toast]);
  
  useEffect(() => {
    if (editingCategory) {
      form.reset(editingCategory);
    } else {
      form.reset({ name: '', section: '', href: '' });
    }
  }, [editingCategory, form]);

  const onSubmit = async (values: CategoryFormValues) => {
    if (!firestore) return;
    setIsSubmitting(true);
    try {
      if (editingCategory) {
        await updateDoc(doc(firestore, 'categories', editingCategory.id), values);
        toast({ title: 'Category updated successfully!' });
        setEditingCategory(null);
      } else {
        await addDoc(collection(firestore, 'categories'), { ...values, createdAt: serverTimestamp() });
        toast({ title: 'Category added successfully!' });
      }
      form.reset();
    } catch (error: any) {
      toast({ title: 'An error occurred.', description: error.message, variant: 'destructive' });
    } finally {
      setIsSubmitting(false);
    }
  };
  
  const deleteCategory = async (id: string) => {
    if (!firestore) return;
    try {
        await deleteDoc(doc(firestore, 'categories', id));
        toast({ title: 'Category deleted successfully.' });
    } catch (error: any) {
        toast({ title: 'Failed to delete category.', description: error.message, variant: 'destructive' });
    }
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-1">
            <Card>
            <CardHeader>
                <CardTitle>{editingCategory ? 'Edit Category' : 'Add New Category'}</CardTitle>
            </CardHeader>
            <CardContent>
                <Form {...form}>
                <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
                    <FormField control={form.control} name="name" render={({ field }) => (
                    <FormItem><FormLabel>Name</FormLabel><FormControl><Input placeholder="e.g., Sports Cards" {...field} /></FormControl><FormMessage /></FormItem>
                    )} />
                    <FormField control={form.control} name="section" render={({ field }) => (
                    <FormItem><FormLabel>Section Slug</FormLabel><FormControl><Input placeholder="e.g., collector-cards" {...field} /></FormControl><FormMessage /></FormItem>
                    )} />
                    <FormField control={form.control} name="href" render={({ field }) => (
                    <FormItem><FormLabel>Link Href</FormLabel><FormControl><Input placeholder="e.g., /collector-cards/sports" {...field} /></FormControl><FormMessage /></FormItem>
                    )} />
                    <Button type="submit" disabled={isSubmitting} className="w-full">
                    {isSubmitting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <PlusCircle className="mr-2 h-4 w-4" />}
                    {editingCategory ? 'Update Category' : 'Add Category'}
                    </Button>
                    {editingCategory && (
                        <Button variant="outline" className="w-full" onClick={() => setEditingCategory(null)}>Cancel Edit</Button>
                    )}
                </form>
                </Form>
            </CardContent>
            </Card>
        </div>
        <div className="lg:col-span-2">
            <Card>
            <CardHeader><CardTitle>Existing Categories</CardTitle></CardHeader>
            <CardContent>
                {isLoading ? (
                <div className="flex justify-center p-8"><Loader2 className="h-8 w-8 animate-spin" /></div>
                ) : (
                <Table>
                    <TableHeader>
                    <TableRow>
                        <TableHead>Name</TableHead>
                        <TableHead>Section</TableHead>
                        <TableHead>Href</TableHead>
                        <TableHead className="text-right">Actions</TableHead>
                    </TableRow>
                    </TableHeader>
                    <TableBody>
                    {categories.map((cat) => (
                        <TableRow key={cat.id}>
                        <TableCell className="font-medium">{cat.name}</TableCell>
                        <TableCell>{cat.section}</TableCell>
                        <TableCell>{cat.href}</TableCell>
                        <TableCell className="text-right space-x-1">
                            <Button variant="ghost" size="icon" onClick={() => setEditingCategory(cat)}><Edit className="h-4 w-4" /></Button>
                            <AlertDialog>
                            <AlertDialogTrigger asChild>
                                <Button variant="ghost" size="icon" className="text-destructive hover:text-destructive"><Trash2 className="h-4 w-4" /></Button>
                            </AlertDialogTrigger>
                            <AlertDialogContent>
                                <AlertDialogHeader>
                                <AlertDialogTitle>Are you sure?</AlertDialogTitle>
                                <AlertDialogDescription>
                                    This action cannot be undone. This will permanently delete the category.
                                </AlertDialogDescription>
                                </AlertDialogHeader>
                                <AlertDialogFooter>
                                <AlertDialogCancel>Cancel</AlertDialogCancel>
                                <AlertDialogAction onClick={() => deleteCategory(cat.id)} className="bg-destructive hover:bg-destructive/90">Delete</AlertDialogAction>
                                </AlertDialogFooter>
                            </AlertDialogContent>
                            </AlertDialog>
                        </TableCell>
                        </TableRow>
                    ))}
                    </TableBody>
                </Table>
                )}
            </CardContent>
            </Card>
        </div>
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/admin/management/MaintenanceManager.tsx
--------------------------------------------------------------------------------

'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { useToast } from '@/hooks/use-toast';
import { Loader2, Trash2, Search, AlertTriangle } from 'lucide-react';
import { deleteProductByAdmin } from '@/app/actions/admin';
import { getProducts } from '@/services/product-service';
import { Product } from '@/lib/types';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';

export default function MaintenanceManager() {
    const [searchTerm, setSearchTerm] = useState('');
    const [products, setProducts] = useState<Product[]>([]);
    const [isSearching, setIsSearching] = useState(false);
    const [deletingId, setDeletingId] = useState<string | null>(null);
    const { toast } = useToast();

    const handleSearch = async () => {
        if (!searchTerm.trim()) return;
        setIsSearching(true);
        try {
            // Fetch products matching the search term
            const result = await getProducts({ q: searchTerm, page: 1, limit: 50 });
            setProducts(result.products);
            
            if (result.products.length === 0) {
                toast({
                    title: "No products found",
                    description: `No active products found matching "${searchTerm}".`,
                });
            }
        } catch (error) {
            console.error("Search error:", error);
            toast({
                variant: "destructive",
                title: "Search Failed",
                description: "Could not fetch products.",
            });
        } finally {
            setIsSearching(false);
        }
    };

    const handleDelete = async (productId: string, productTitle: string) => {
        if (!confirm(`Are you sure you want to FORCE DELETE "${productTitle}"?\nThis action cannot be undone.`)) {
            return;
        }

        setDeletingId(productId);
        try {
            const idToken = await getCurrentUserIdToken();
            if (!idToken) throw new Error("Not authenticated");

            const result = await deleteProductByAdmin(productId, idToken);
            
            if (result.success) {
                toast({
                    title: "Product Deleted",
                    description: result.message,
                });
                // Remove from list
                setProducts(prev => prev.filter(p => p.id !== productId));
            } else {
                throw new Error(result.error);
            }
        } catch (error: any) {
            toast({
                variant: "destructive",
                title: "Deletion Failed",
                description: error.message,
            });
        } finally {
            setDeletingId(null);
        }
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="text-red-600 flex items-center gap-2">
                    <AlertTriangle className="h-5 w-5" />
                    Force Delete Products
                </CardTitle>
                <CardDescription>
                    Search for specific listings (e.g., "Fix Test", "Charizard") and permanently remove them from the database. 
                    This tool bypasses standard checks and is intended for cleanup.
                </CardDescription>
            </CardHeader>
            <CardContent>
                <div className="flex gap-4 mb-6">
                    <Input 
                        placeholder="Enter product title..." 
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                    />
                    <Button onClick={handleSearch} disabled={isSearching || !searchTerm.trim()}>
                        {isSearching ? <Loader2 className="h-4 w-4 animate-spin" /> : <Search className="h-4 w-4 mr-2" />}
                        Find
                    </Button>
                </div>

                <div className="space-y-2">
                    {products.length > 0 && (
                         <div className="text-sm text-muted-foreground mb-2">Found {products.length} matching products:</div>
                    )}
                    
                    {products.map(product => (
                        <div key={product.id} className="flex items-center justify-between p-3 border rounded-lg bg-muted/20">
                            <div className="flex items-center gap-3">
                                {product.imageUrls && product.imageUrls[0] && (
                                    <div className="h-10 w-10 relative rounded overflow-hidden bg-muted">
                                        <img src={product.imageUrls[0]} alt="" className="object-cover w-full h-full" />
                                    </div>
                                )}
                                <div>
                                    <div className="font-bold">{product.title}</div>
                                    <div className="text-xs text-muted-foreground">ID: {product.id} | Price: ${product.price}</div>
                                </div>
                            </div>
                            <Button 
                                variant="destructive" 
                                size="sm" 
                                onClick={() => handleDelete(product.id, product.title)}
                                disabled={deletingId === product.id}
                            >
                                {deletingId === product.id ? <Loader2 className="h-4 w-4 animate-spin" /> : <Trash2 className="h-4 w-4" />}
                                Delete
                            </Button>
                        </div>
                    ))}
                </div>
            </CardContent>
        </Card>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/admin/system/AuditLogViewer.tsx
--------------------------------------------------------------------------------


'use client';

import { useState, useEffect } from 'react';
import { db } from '@/lib/firebase/config';
import { collection, query, orderBy, limit, getDocs, Timestamp } from 'firebase/firestore';
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow
} from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Loader2, AlertCircle } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';

interface AuditLog {
    id: string;
    action: string;
    userId: string;
    userEmail?: string;
    details: string;
    status: 'success' | 'warning' | 'error';
    timestamp: Timestamp;
}

export function AuditLogViewer() {
    const [logs, setLogs] = useState<AuditLog[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    useEffect(() => {
        async function fetchLogs() {
            try {
                // In a real scenario, ensure this logic matches your firestore structure
                const q = query(
                    collection(db, 'audit_logs'),
                    orderBy('timestamp', 'desc'),
                    limit(20)
                );

                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    setLogs([]);
                } else {
                    const fetchedLogs = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    })) as AuditLog[];
                    setLogs(fetchedLogs);
                }
            } catch (err: any) {
                console.error("Error fetching audit logs:", err);
                // Don't show critical error to UI if collection missing, just empty
                if (err.code === 'permission-denied') {
                    setError("You do not have permission to view audit logs.");
                } else if (err.code === 'failed-precondition') {
                    // Missing index?
                    setError("Index missing for audit logs.");
                } else {
                    // Start with empty logs if collection doesn't exist or other error
                    setLogs([]);
                }
            } finally {
                setLoading(false);
            }
        }

        fetchLogs();
    }, []);

    if (loading) {
        return (
            <div className="flex justify-center items-center py-12">
                <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
            </div>
        );
    }

    if (error) {
        return (
            <div className="flex items-center justify-center py-12 text-destructive gap-2">
                <AlertCircle className="h-5 w-5" />
                <span>{error}</span>
            </div>
        );
    }

    if (logs.length === 0) {
        return (
            <div className="text-center py-12 text-muted-foreground border rounded-md bg-muted/20">
                <p>No audit logs found.</p>
                <p className="text-xs mt-1">System events will appear here.</p>
            </div>
        );
    }

    return (
        <div className="border rounded-md">
            <Table>
                <TableHeader>
                    <TableRow>
                        <TableHead>Time</TableHead>
                        <TableHead>Action</TableHead>
                        <TableHead>User</TableHead>
                        <TableHead>Status</TableHead>
                        <TableHead className="text-right">Details</TableHead>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    {logs.map((log) => (
                        <TableRow key={log.id}>
                            <TableCell className="whitespace-nowrap text-xs text-muted-foreground">
                                {log.timestamp?.toMillis ?
                                    formatDistanceToNow(log.timestamp.toMillis(), { addSuffix: true }) :
                                    'Unknown'
                                }
                            </TableCell>
                            <TableCell className="font-medium">{log.action}</TableCell>
                            <TableCell className="text-sm">{log.userEmail || log.userId || 'System'}</TableCell>
                            <TableCell>
                                <Badge variant={
                                    log.status === 'success' ? 'default' :
                                        log.status === 'error' ? 'destructive' :
                                            'secondary'
                                } className={
                                    log.status === 'success' ? 'bg-green-500 hover:bg-green-600' : ''
                                }>
                                    {log.status}
                                </Badge>
                            </TableCell>
                            <TableCell className="text-right text-sm text-muted-foreground max-w-[200px] truncate">
                                {log.details}
                            </TableCell>
                        </TableRow>
                    ))}
                </TableBody>
            </Table>
        </div>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/admin/system/ConnectionStatus.tsx
--------------------------------------------------------------------------------


'use client';

import { useState } from 'react';
import { Card, CardContent, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { RefreshCw, CheckCircle2, XCircle, ExternalLink, HelpCircle } from "lucide-react";
import { cn } from "@/lib/utils";

interface ConnectionStatusProps {
    serviceName: string;
    endpoint: string;
    docsUrl?: string;
}

type Status = 'idle' | 'loading' | 'success' | 'error';

export function ConnectionStatus({ serviceName, endpoint, docsUrl }: ConnectionStatusProps) {
    const [status, setStatus] = useState<Status>('idle');
    const [latency, setLatency] = useState<number | null>(null);
    const [message, setMessage] = useState<string>("");

    const runTest = async () => {
        if (!endpoint) return;

        setStatus('loading');
        setMessage("");
        setLatency(null);

        try {
            const res = await fetch(endpoint);
            const data = await res.json();

            if (res.ok && (data.status === 'healthy' || data.status === 'success')) {
                setStatus('success');
                setLatency(data.latency);
            } else {
                setStatus('error');
                setLatency(data.latency);
                setMessage(data.error || data.details?.message || "Service unhealthy");
            }
        } catch (error: any) {
            console.error("Connection test failed:", error);
            setStatus('error');
            setMessage(error.message || "Network error");
        }
    };

    return (
        <Card>
            <CardHeader className="pb-3">
                <div className="flex justify-between items-start">
                    <CardTitle className="text-base font-medium">{serviceName}</CardTitle>
                    {status === 'idle' && <HelpCircle className="h-5 w-5 text-gray-400" />}
                    {status === 'success' && <CheckCircle2 className="h-5 w-5 text-green-500" />}
                    {status === 'error' && <XCircle className="h-5 w-5 text-red-500" />}
                </div>
            </CardHeader>
            <CardContent className="pb-3">
                <div className="flex items-center justify-between mb-2">
                    <span className="text-sm text-muted-foreground">Status</span>
                    <Badge variant={status === 'success' ? 'default' : status === 'error' ? 'destructive' : 'secondary'}
                        className={cn(status === 'success' && "bg-green-500 hover:bg-green-600")}>
                        {status === 'idle' ? 'Unknown' : status === 'loading' ? 'Testing...' : status === 'success' ? 'Online' : 'Offline'}
                    </Badge>
                </div>
                <div className="flex items-center justify-between">
                    <span className="text-sm text-muted-foreground">Latency</span>
                    <span className={cn("text-sm font-mono", !latency && "text-muted-foreground/50")}>
                        {latency ? `${latency}ms` : '--'}
                    </span>
                </div>
                {message && (
                    <div className={cn("mt-3 text-xs p-2 rounded", "bg-yellow-500/10 text-yellow-700")}>
                        {message}
                    </div>
                )}
            </CardContent>
            <CardFooter className="pt-0 gap-2">
                <Button
                    variant="outline"
                    size="sm"
                    className="w-full"
                    onClick={runTest}
                    disabled={status === 'loading'}
                >
                    <RefreshCw className={cn("mr-2 h-3 w-3")} />
                    Test Connection
                </Button>
                {docsUrl && (
                    <Button variant="ghost" size="icon" className="shrink-0 text-muted-foreground" asChild>
                        <a href={docsUrl} target="_blank" rel="noopener noreferrer">
                            <ExternalLink className="h-4 w-4" />
                        </a>
                    </Button>
                )}
            </CardFooter>
        </Card>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/admin/system/SeedDatabaseButton.tsx
--------------------------------------------------------------------------------


'use client';

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Database, Loader2 } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import { auth } from "@/lib/firebase/config"; // Client SDK

export function SeedDatabaseButton() {
    const [loading, setLoading] = useState(false);
    const { toast } = useToast();

    const handleSeed = async () => {
        if (!auth.currentUser) {
            toast({
                variant: "destructive",
                title: "Authentication Required",
                description: "You must be logged in to perform this action.",
            });
            return;
        }

        setLoading(true);
        try {
            const token = await auth.currentUser.getIdToken();
            const res = await fetch('/api/admin/seed', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.error || 'Failed to seed database');
            }

            toast({
                title: "Success",
                description: data.message,
            });

        } catch (error: any) {
            toast({
                variant: "destructive",
                title: "Error",
                description: error.message,
            });
        } finally {
            setLoading(false);
        }
    };

    return (
        <Button
            onClick={handleSeed}
            disabled={loading}
            variant="outline"
        >
            {loading ? (
                <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Seeding...
                </>
            ) : (
                <>
                    <Database className="mr-2 h-4 w-4" />
                    Seed Database
                </>
            )}
        </Button>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/admin/users/CreateUserDialog.tsx
--------------------------------------------------------------------------------


'use client';

import { useState, useTransition } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import * as z from "zod";

import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { Shield, Store, User, BadgeCheck, Loader2 } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import type { UserRole } from "@/lib/types";
import { createNewUser } from "@/app/actions/admin-users";
import { getCurrentUserIdToken } from "@/lib/firebase/auth";

const formSchema = z.object({
  displayName: z.string().min(2, "Name is required"),
  email: z.string().email("Invalid email address"),
  password: z.string().min(6, "Password must be at least 6 characters"),
  role: z.enum(['viewer', 'seller', 'admin', 'superadmin']),
});

type FormValues = z.infer<typeof formSchema>;

interface CreateUserDialogProps {
    isOpen: boolean;
    onClose: () => void;
}

export function CreateUserDialog({ isOpen, onClose }: CreateUserDialogProps) {
    const [isPending, startTransition] = useTransition();
    const { toast } = useToast();

    const form = useForm<FormValues>({
        resolver: zodResolver(formSchema),
        defaultValues: {
            displayName: "",
            email: "",
            password: "",
            role: "viewer",
        },
    });

    const onSubmit = (values: FormValues) => {
        startTransition(async () => {
            const idToken = await getCurrentUserIdToken();
            if (!idToken) {
                toast({ title: "Authentication error", variant: "destructive" });
                return;
            }
            
            const result = await createNewUser(idToken, values);

            if (result.success) {
                toast({ title: "Success!", description: result.message });
                form.reset();
                onClose();
            } else {
                toast({ title: "Error", description: result.message, variant: "destructive" });
            }
        });
    };

    return (
        <Dialog open={isOpen} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[425px]">
                <DialogHeader>
                    <DialogTitle>Create New User</DialogTitle>
                    <DialogDescription>
                        Set up a new account and assign their role on the platform.
                    </DialogDescription>
                </DialogHeader>
                <Form {...form}>
                    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4 py-4">
                        <FormField control={form.control} name="displayName" render={({ field }) => (
                            <FormItem><FormLabel>Display Name</FormLabel><FormControl><Input {...field} /></FormControl><FormMessage /></FormItem>
                        )} />
                        <FormField control={form.control} name="email" render={({ field }) => (
                            <FormItem><FormLabel>Email</FormLabel><FormControl><Input type="email" {...field} /></FormControl><FormMessage /></FormItem>
                        )} />
                        <FormField control={form.control} name="password" render={({ field }) => (
                            <FormItem><FormLabel>Password</FormLabel><FormControl><Input type="password" {...field} /></FormControl><FormMessage /></FormItem>
                        )} />
                        <FormField control={form.control} name="role" render={({ field }) => (
                            <FormItem>
                                <FormLabel>Role</FormLabel>
                                <Select onValueChange={field.onChange} defaultValue={field.value}>
                                    <FormControl><SelectTrigger><SelectValue /></SelectTrigger></FormControl>
                                    <SelectContent>
                                        <SelectItem value="viewer">Viewer</SelectItem>
                                        <SelectItem value="seller">Seller</SelectItem>
                                        <SelectItem value="admin">Admin</SelectItem>
                                        <SelectItem value="superadmin">Super Admin</SelectItem>
                                    </SelectContent>
                                </Select>
                                <FormMessage />
                            </FormItem>
                        )} />
                        <DialogFooter className="pt-4">
                            <Button variant="outline" onClick={onClose} type="button">Cancel</Button>
                            <Button type="submit" disabled={isPending}>
                                {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                                Create User
                            </Button>
                        </DialogFooter>
                    </form>
                </Form>
            </DialogContent>
        </Dialog>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/admin/users/UserManagementClient.tsx
--------------------------------------------------------------------------------


'use client';

import { useState, useEffect, useTransition, useCallback } from 'react';
import { UserTable } from './UserTable';
import { UserRoleDialog } from './UserRoleDialog';
import { CreateUserDialog } from './CreateUserDialog';
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Search, Plus, Loader2 } from "lucide-react";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { getAllUsers, updateUserRole, toggleUserBan, type AdminUser, type ActionResponse } from '@/app/actions/admin-users';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';
import { useToast } from '@/hooks/use-toast';
import type { UserRole } from '@/lib/types';


export default function UserManagementClient() {
    const [users, setUsers] = useState<AdminUser[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [roleFilter, setRoleFilter] = useState<string>('all');
    const [isPending, startTransition] = useTransition();

    const { toast } = useToast();

    // Dialog States
    const [isRoleDialogOpen, setIsRoleDialogOpen] = useState(false);
    const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);
    const [selectedUser, setSelectedUser] = useState<AdminUser | null>(null);

    const fetchUsers = useCallback(async () => {
        setIsLoading(true);
        const idToken = await getCurrentUserIdToken();
        if (!idToken) {
            toast({ title: "Authentication Error", variant: "destructive" });
            setIsLoading(false);
            return;
        }
        const result = await getAllUsers(idToken);
        if (result.users) {
            setUsers(result.users);
        } else {
            toast({ title: "Error fetching users", description: result.error, variant: "destructive" });
        }
        setIsLoading(false);
    }, [setIsLoading, toast, setUsers]);

    useEffect(() => {
        setTimeout(() => {
            fetchUsers();
        }, 0);
    }, [fetchUsers]);

    const filteredUsers = users.filter(user => {
        const matchesSearch = user.displayName.toLowerCase().includes(searchQuery.toLowerCase()) ||
                              user.email.toLowerCase().includes(searchQuery.toLowerCase());
        const matchesRole = roleFilter === 'all' || user.role === roleFilter;
        return matchesSearch && matchesRole;
    });

    const handleAction = (action: () => Promise<ActionResponse>) => {
        startTransition(async () => {
            const result = await action();
            if (result.success) {
                toast({ title: "Success", description: result.message });
                await fetchUsers(); // Re-fetch users to get updated state
            } else {
                toast({ title: "Error", description: result.message, variant: "destructive" });
            }
        });
    };

    const handleEditRole = (user: AdminUser) => {
        setSelectedUser(user);
        setIsRoleDialogOpen(true);
    };

    const handleUpdateRole = async (userId: string, newRole: UserRole) => {
        const idToken = await getCurrentUserIdToken();
        if (!idToken) return;
        handleAction(() => updateUserRole(idToken, userId, newRole));
    };

    const handleToggleBan = async (userId: string, currentStatus: 'active' | 'banned') => {
        const idToken = await getCurrentUserIdToken();
        if (!idToken) return;
        handleAction(() => toggleUserBan(idToken, userId, currentStatus));
    };

    return (
        <div className="space-y-6">
            <div className="flex flex-col sm:flex-row gap-4 justify-between items-center bg-card p-4 rounded-lg border shadow-sm">
                <div className="relative w-full sm:w-96">
                    <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Search users by name or email..."
                        className="pl-9"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
                <div className="flex gap-2 w-full sm:w-auto">
                    <Select value={roleFilter} onValueChange={setRoleFilter}>
                        <SelectTrigger className="w-[180px]">
                            <SelectValue placeholder="Filter by Role" />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="all">All Roles</SelectItem>
                            <SelectItem value="superadmin">Super Admin</SelectItem>
                            <SelectItem value="admin">Admins</SelectItem>
                            <SelectItem value="seller">Sellers</SelectItem>
                            <SelectItem value="viewer">Viewers</SelectItem>
                        </SelectContent>
                    </Select>
                    <Button onClick={() => setIsCreateDialogOpen(true)}>
                        <Plus className="mr-2 h-4 w-4" /> Create User
                    </Button>
                </div>
            </div>

            {isLoading ? (
                <div className="flex justify-center p-12"><Loader2 className="h-8 w-8 animate-spin" /></div>
            ) : (
                <UserTable
                    users={filteredUsers}
                    onEditRole={handleEditRole}
                    onToggleBan={handleToggleBan}
                    isPending={isPending}
                />
            )}

            {selectedUser && (
                <UserRoleDialog
                    isOpen={isRoleDialogOpen}
                    onClose={() => setIsRoleDialogOpen(false)}
                    currentRole={selectedUser.role || 'viewer'}
                    userId={selectedUser.id}
                    userName={selectedUser.displayName}
                    onUpdateRole={handleUpdateRole}
                />
            )}
            
            <CreateUserDialog
                isOpen={isCreateDialogOpen}
                onClose={() => {
                    setIsCreateDialogOpen(false);
                    fetchUsers(); // Refresh list after closing create dialog
                }}
            />
        </div>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/admin/users/UserRoleDialog.tsx
--------------------------------------------------------------------------------


'use client';

import { useState, useTransition } from "react";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Shield, Store, User, BadgeCheck, Loader2, Eye } from "lucide-react";
import type { UserRole } from "@/lib/types";

interface UserRoleDialogProps {
    isOpen: boolean;
    onClose: () => void;
    currentRole: UserRole;
    userId: string;
    userName: string;
    onUpdateRole: (userId: string, newRole: UserRole) => Promise<void>;
}

export function UserRoleDialog({ isOpen, onClose, currentRole, userId, userName, onUpdateRole }: UserRoleDialogProps) {
    const [selectedRole, setSelectedRole] = useState<UserRole>(currentRole);
    const [isPending, startTransition] = useTransition();

    const handleSave = () => {
        if (selectedRole === currentRole) {
            onClose();
            return;
        }
        startTransition(async () => {
            await onUpdateRole(userId, selectedRole);
            onClose();
        });
    };

    return (
        <Dialog open={isOpen} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[425px]">
                <DialogHeader>
                    <DialogTitle>Manage User Role</DialogTitle>
                    <DialogDescription>
                        Change permissions and access levels for <span className="font-bold text-foreground">{userName}</span>.
                    </DialogDescription>
                </DialogHeader>
                <div className="grid gap-4 py-4">
                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="role" className="text-right">
                            Role
                        </Label>
                        <Select value={selectedRole} onValueChange={(val: UserRole) => setSelectedRole(val)}>
                            <SelectTrigger className="col-span-3">
                                <SelectValue placeholder="Select a role" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="viewer">
                                    <div className="flex items-center gap-2">
                                        <Eye className="h-4 w-4 text-slate-500" />
                                        <span>Viewer</span>
                                    </div>
                                </SelectItem>
                                <SelectItem value="seller">
                                    <div className="flex items-center gap-2">
                                        <Store className="h-4 w-4 text-blue-500" />
                                        <span>Seller</span>
                                    </div>
                                </SelectItem>
                                <SelectItem value="admin">
                                    <div className="flex items-center gap-2">
                                        <BadgeCheck className="h-4 w-4 text-purple-500" />
                                        <span>Admin</span>
                                    </div>
                                </SelectItem>
                                <SelectItem value="superadmin">
                                    <div className="flex items-center gap-2">
                                        <Shield className="h-4 w-4 text-red-500" />
                                        <span>Super Admin</span>
                                    </div>
                                </SelectItem>
                            </SelectContent>
                        </Select>
                    </div>
                </div>
                <DialogFooter>
                    <Button variant="outline" onClick={onClose} disabled={isPending}>Cancel</Button>
                    <Button onClick={handleSave} disabled={isPending}>
                        {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                        Save Changes
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/admin/users/UserTable.tsx
--------------------------------------------------------------------------------


'use client';

import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel, DropdownMenuSeparator, DropdownMenuTrigger } from "@/components/ui/dropdown-menu";
import { Button } from "@/components/ui/button";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { MoreHorizontal, Shield, Store, BadgeCheck, Ban, Eye } from "lucide-react";
import { format } from "date-fns";
import type { AdminUser } from '@/app/actions/admin-users';
import type { UserRole } from "@/lib/types";

interface UserTableProps {
    users: AdminUser[];
    onEditRole: (user: AdminUser) => void;
    onToggleBan: (userId: string, currentStatus: 'active' | 'banned') => void;
    isPending: boolean;
}

const RoleBadge = ({ role }: { role: UserRole }) => {
    switch (role) {
        case 'superadmin':
            return <Badge variant="destructive" className="gap-1"><Shield className="h-3 w-3" /> Super Admin</Badge>;
        case 'admin':
            return <Badge className="bg-purple-600 hover:bg-purple-700 gap-1"><BadgeCheck className="h-3 w-3" /> Admin</Badge>;
        case 'seller':
            return <Badge variant="secondary" className="text-blue-600 bg-blue-100 hover:bg-blue-200 gap-1"><Store className="h-3 w-3" /> Seller</Badge>;
        default:
            return <Badge variant="outline" className="gap-1"><Eye className="h-3 w-3" /> Viewer</Badge>;
    }
};

export function UserTable({ users, onEditRole, onToggleBan, isPending }: UserTableProps) {
    return (
        <div className="rounded-md border bg-card">
            <Table>
                <TableHeader>
                    <TableRow>
                        <TableHead>User</TableHead>
                        <TableHead>Role</TableHead>
                        <TableHead>Status</TableHead>
                        <TableHead>Last Sign In</TableHead>
                        <TableHead className="text-right">Actions</TableHead>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    {users.map((user) => (
                        <TableRow key={user.id} className={isPending ? 'opacity-50' : ''}>
                            <TableCell className="flex items-center gap-3">
                                <Avatar className="h-9 w-9">
                                    <AvatarImage src={user.photoURL} />
                                    <AvatarFallback>{user.displayName.slice(0, 2).toUpperCase()}</AvatarFallback>
                                </Avatar>
                                <div className="flex flex-col">
                                    <span className="font-medium text-sm">{user.displayName}</span>
                                    <span className="text-xs text-muted-foreground">{user.email}</span>
                                </div>
                            </TableCell>
                            <TableCell>
                                <RoleBadge role={user.role || 'viewer'} />
                            </TableCell>
                            <TableCell>
                                <span className={`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${
                                    !user.disabled ? 'bg-green-50 text-green-700 ring-1 ring-inset ring-green-600/20' :
                                    'bg-red-50 text-red-700 ring-1 ring-inset ring-red-600/20'
                                }`}>
                                    {!user.disabled ? 'Active' : 'Banned'}
                                </span>
                            </TableCell>
                            <TableCell className="text-muted-foreground text-sm">
                                {user.lastSignInTime ? format(new Date(user.lastSignInTime), 'MMM d, yyyy') : 'Never'}
                            </TableCell>
                            <TableCell className="text-right">
                                <DropdownMenu>
                                    <DropdownMenuTrigger asChild>
                                        <Button variant="ghost" className="h-8 w-8 p-0" disabled={isPending}>
                                            <span className="sr-only">Open menu</span>
                                            <MoreHorizontal className="h-4 w-4" />
                                        </Button>
                                    </DropdownMenuTrigger>
                                    <DropdownMenuContent align="end">
                                        <DropdownMenuLabel>Actions</DropdownMenuLabel>
                                        <DropdownMenuItem onClick={() => navigator.clipboard.writeText(user.id)}>
                                            Copy User ID
                                        </DropdownMenuItem>
                                        <DropdownMenuSeparator />
                                        <DropdownMenuItem onClick={() => onEditRole(user)}>
                                            Change Role...
                                        </DropdownMenuItem>
                                        <DropdownMenuItem
                                            className={!user.disabled ? "text-red-600" : "text-green-600"}
                                            onClick={() => onToggleBan(user.id, !user.disabled ? 'active' : 'banned')}
                                        >
                                            {!user.disabled ? <><Ban className="mr-2 h-4 w-4" /> Ban User</> : "Unban User"}
                                        </DropdownMenuItem>
                                    </DropdownMenuContent>
                                </DropdownMenu>
                            </TableCell>
                        </TableRow>
                    ))}
                </TableBody>
            </Table>
        </div>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/analytics/GoogleAnalytics.tsx
--------------------------------------------------------------------------------


'use client';

import { usePathname, useSearchParams } from 'next/navigation';
import Script from 'next/script';
import { useEffect, Suspense } from 'react';

const GA_MEASUREMENT_ID = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID;

function GoogleAnalyticsInner() {
  const pathname = usePathname();
  const searchParams = useSearchParams();

  useEffect(() => {
    if (!GA_MEASUREMENT_ID) {
      return;
    }
    const url = `${pathname}?${searchParams.toString()}`;
    
    // @ts-ignore
    window.gtag('config', GA_MEASUREMENT_ID, {
      page_path: url,
    });
  }, [pathname, searchParams]);

  if (!GA_MEASUREMENT_ID) {
    return null;
  }

  return (
    <>
      <Script
        src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`}
        strategy="afterInteractive"
      />
      <Script id="google-analytics" strategy="afterInteractive">
        {`
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', '${GA_MEASUREMENT_ID}');
        `}
      </Script>
    </>
  );
}

export function GoogleAnalytics() {
    return (
        <Suspense fallback={null}>
            <GoogleAnalyticsInner />
        </Suspense>
    )
}


--------------------------------------------------------------------------------
FILE: src/components/animations/FadeIn.tsx
--------------------------------------------------------------------------------


'use client';

import { motion, useInView } from 'framer-motion';
import { useRef } from 'react';
import { cn } from '@/lib/utils';

export function StaggerContainer({ children, className }: { children: React.ReactNode; className?: string }) {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.2 });

  return (
    <motion.div
      ref={ref}
      className={className}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
      variants={{
        visible: { transition: { staggerChildren: 0.1 } },
      }}
    >
      {children}
    </motion.div>
  );
}

interface FadeInProps {
    children: React.ReactNode;
    delay?: number;
    className?: string;
}

export function FadeIn({ children, delay = 0, className }: FadeInProps) {
  return (
    <motion.div
      className={className}
      variants={{
        hidden: { opacity: 0, y: 20 },
        visible: { opacity: 1, y: 0 },
      }}
      transition={{ duration: 0.5, delay }}
    >
      {children}
    </motion.div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/auth/SignInForm.tsx
--------------------------------------------------------------------------------


"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { useState, Suspense, useEffect } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import Link from 'next/link';

import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { useToast } from "@/hooks/use-toast";
import { signInWithEmail } from "@/lib/firebase/auth";
import { Loader2 } from "lucide-react";

const formSchema = z.object({
  email: z.string().email({ message: "Invalid email address." }),
  password: z.string().min(1, { message: "Password is required." }),
});

function SignInFormInner() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const redirectUrl = searchParams.get('redirect') || '/';
  const { toast } = useToast();
  const [isLoading, setIsLoading] = useState(false);
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    // eslint-disable-next-line react-hooks/set-state-in-effect
    setMounted(true);
  }, []);

  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      email: "",
      password: "",
    },
    mode: "onChange",
  });

  async function onSubmit(values: z.infer<typeof formSchema>) {
    // Failsafe: Ensure values are present
    if (!values.email || !values.password) {
      return;
    }

    setIsLoading(true);
    const { error } = await signInWithEmail(values.email, values.password);

    if (error) {
      let errorMessage = "An unknown error occurred. Please try again.";
      // Use the new, more descriptive error handling
      switch(error.code) {
          case 'auth/invalid-credential':
          case 'auth/user-not-found':
          case 'auth/wrong-password':
              errorMessage = "Invalid email or password. Please try again.";
              break;
          case 'auth/too-many-requests':
              errorMessage = "Too many sign-in attempts. Please try again later.";
              break;
          case 'auth/network-request-failed':
              errorMessage = "Network error. Please check your internet connection.";
              break;
          case 'auth/invalid-api-key':
              errorMessage = "The API key is invalid. Please check your .env configuration and ensure the key is enabled in your Google Cloud console.";
              break;
          default:
              // For any other errors, show the raw message from Firebase to aid debugging.
              errorMessage = error.message;
              break;
      }

      toast({
        title: "Sign-in failed",
        description: errorMessage,
        variant: "destructive",
      });
      setIsLoading(false);
    } else {
      toast({
        title: "Success!",
        description: "You have successfully signed in.",
      });
      // Use Next.js router to force a full page reload and ensure auth state is updated.
      router.push(redirectUrl);
    }
  }

  if (!mounted) {
      return null;
  }

  return (
    <>
      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
          <FormField
            control={form.control}
            name="email"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Email address</FormLabel>
                <FormControl>
                  <Input placeholder="you@example.com" {...field} type="email" autoComplete="email" />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="password"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Password</FormLabel>
                <FormControl>
                  <Input placeholder="" {...field} type="password" autoComplete="current-password" />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          <div className="flex items-center justify-between">
            <div />
            <Button variant="link" asChild className="p-0 text-sm">
              <Link href="#">Forgot password?</Link>
            </Button>
          </div>
          <div>
            <Button type="submit" className="w-full" size="lg" disabled={isLoading}>
              {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Sign In
            </Button>
          </div>
        </form>
      </Form>
    </>
  );
}

export default function SignInForm() {
    return (
        <Suspense fallback={<div>Loading...</div>}>
            <SignInFormInner />
        </Suspense>
    )
}


--------------------------------------------------------------------------------
FILE: src/components/auth/SignUpForm.tsx
--------------------------------------------------------------------------------


"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { useState, Suspense } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import Link from 'next/link';

import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { useToast } from "@/hooks/use-toast";
import { signUpWithEmail } from "@/lib/firebase/auth";
import { Loader2 } from "lucide-react";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Textarea } from "@/components/ui/textarea";
import { Checkbox } from "@/components/ui/checkbox";

const formSchema = z.object({
  displayName: z.string().min(2, { message: "Full name must be at least 2 characters." }),
  email: z.string().email({ message: "Please enter a valid email address." }),
  password: z.string()
    .min(8, { message: "Password must be at least 8 characters long." })
    .regex(/[A-Z]/, { message: "Password must contain at least one uppercase letter." })
    .regex(/[a-z]/, { message: "Password must contain at least one lowercase letter." })
    .regex(/[0-9]/, { message: "Password must contain at least one number." }),
  confirmPassword: z.string(),
  accountType: z.enum(["buyer", "seller"], {
    required_error: "You must select an account type."
  }),
  storeName: z.string().optional(),
  storeDescription: z.string().optional(),
  agreedToTerms: z.boolean().refine((val) => val === true, {
    message: "You must agree to the Terms & Conditions and Privacy Policy.",
  }),
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords do not match.",
  path: ["confirmPassword"],
}).refine((data) => {
    if (data.accountType === 'seller') {
        return !!data.storeName && data.storeName.length >= 2;
    }
    return true;
}, {
    message: "Store name is required for sellers.",
    path: ["storeName"],
});

function SignUpFormInner() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const redirectUrl = searchParams.get('redirect') || '/';
  const { toast } = useToast();
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      displayName: "",
      email: "",
      password: "",
      confirmPassword: "",
      accountType: "buyer",
      storeName: "",
      storeDescription: "",
      agreedToTerms: false,
    },
  });

  const accountType = form.watch("accountType");

  async function onSubmit(values: z.infer<typeof formSchema>) {
    setIsLoading(true);
    const { error } = await signUpWithEmail({
        email: values.email, 
        password: values.password, 
        displayName: values.displayName,
        accountType: values.accountType,
        storeName: values.storeName,
        storeDescription: values.storeDescription,
    });

    if (error) {
      let errorMessage = "An unknown error occurred. Please try again.";
      switch (error.code) {
        case 'auth/email-already-in-use':
          errorMessage = 'This email address is already in use.';
          break;
        case 'auth/invalid-email':
          errorMessage = 'Please enter a valid email address.';
          break;
        case 'auth/weak-password':
          errorMessage = 'The password is too weak.';
          break;
        default:
          errorMessage = error.message;
          break;
      }

      toast({
        title: "Sign-up failed",
        description: errorMessage,
        variant: "destructive",
      });
       setIsLoading(false);
    } else {
      toast({
        title: "Success!",
        description: "Your account has been created.",
      });
      window.location.href = redirectUrl;
    }
  }

  return (
    <>
      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
          
          <FormField
            control={form.control}
            name="accountType"
            render={({ field }) => (
              <FormItem className="space-y-3">
                <FormLabel>I am a...</FormLabel>
                <FormControl>
                  <RadioGroup
                    onValueChange={field.onChange}
                    defaultValue={field.value}
                    className="flex space-x-4"
                  >
                    <FormItem className="flex items-center space-x-2 space-y-0">
                      <FormControl>
                        <RadioGroupItem value="buyer" />
                      </FormControl>
                      <FormLabel className="font-normal">Buyer</FormLabel>
                    </FormItem>
                    <FormItem className="flex items-center space-x-2 space-y-0">
                      <FormControl>
                        <RadioGroupItem value="seller" />
                      </FormControl>
                      <FormLabel className="font-normal">Seller</FormLabel>
                    </FormItem>
                  </RadioGroup>
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="displayName"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Full Name</FormLabel>
                <FormControl>
                  <Input placeholder="John Doe" {...field} autoComplete="name" />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="email"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Email address</FormLabel>
                <FormControl>
                  <Input placeholder="you@example.com" {...field} type="email" autoComplete="email" />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="password"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Password</FormLabel>
                <FormControl>
                  <Input placeholder="" {...field} type="password" autoComplete="new-password" />
                </FormControl>
                 <FormDescription className="text-xs">
                    Must be 8+ characters with uppercase, lowercase, and a number.
                </FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="confirmPassword"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Confirm Password</FormLabel>
                <FormControl>
                  <Input placeholder="" {...field} type="password" autoComplete="new-password" />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          
          {accountType === "seller" && (
             <div className="space-y-4 border-t pt-4">
                <h3 className="text-lg font-medium">Seller Information</h3>
                 <FormField
                    control={form.control}
                    name="storeName"
                    render={({ field }) => (
                    <FormItem>
                        <FormLabel>Store Name</FormLabel>
                        <FormControl>
                        <Input placeholder="e.g., John's Collectibles" {...field} />
                        </FormControl>
                        <FormMessage />
                    </FormItem>
                    )}
                />
                 <FormField
                    control={form.control}
                    name="storeDescription"
                    render={({ field }) => (
                    <FormItem>
                        <FormLabel>Store Description (Optional)</FormLabel>
                        <FormControl>
                        <Textarea placeholder="Specializing in rare cards and coins..." {...field} />
                        </FormControl>
                        <FormMessage />
                    </FormItem>
                    )}
                />
             </div>
          )}

           <FormField
                control={form.control}
                name="agreedToTerms"
                render={({ field }) => (
                    <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4">
                    <FormControl>
                        <Checkbox
                        checked={field.value}
                        onCheckedChange={field.onChange}
                        />
                    </FormControl>
                    <div className="space-y-1 leading-none">
                        <FormLabel>
                           I agree to the <Link href="/terms" className="text-primary hover:underline">Terms & Conditions</Link> and <Link href="/privacy" className="text-primary hover:underline">Privacy Policy</Link>.
                        </FormLabel>
                         <FormMessage />
                    </div>
                    </FormItem>
                )}
            />

          <div>
            <Button type="submit" className="w-full" size="lg" disabled={isLoading}>
              {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Create Account
            </Button>
          </div>
        </form>
      </Form>
      <div className="mt-6">
        <div className="relative">
          <div className="absolute inset-0 flex items-center">
            <div className="w-full border-t border-border" />
          </div>
          <div className="relative flex justify-center text-sm">
            <span className="bg-card px-2 text-muted-foreground">
              Or
            </span>
          </div>
        </div>

        <div className="mt-6 text-center">
          <p className="text-sm text-muted-foreground">
            Already have an account?{' '}
            <Button variant="link" asChild className="p-0">
              <Link href="/sign-in">Sign in</Link>
            </Button>
          </p>
        </div>
      </div>
    </>
  );
}

export default function SignUpForm() {
    return (
        <Suspense fallback={<div>Loading...</div>}>
            <SignUpFormInner />
        </Suspense>
    )
}


--------------------------------------------------------------------------------
FILE: src/components/cart/CartDrawer.tsx
--------------------------------------------------------------------------------

"use client";

import React from 'react';
import { useCart } from '@/context/CartContext';
import {
    Sheet,
    SheetContent,
    SheetHeader,
    SheetTitle,
    SheetFooter,
    SheetDescription,
} from '@/components/ui/sheet';
import { Button } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Trash2, Plus, Minus, ShoppingBag } from 'lucide-react';
import Image from 'next/image';
import Link from 'next/link';

export function CartDrawer() {
    const { items, removeItem, updateQuantity, cartTotal, itemCount, isCartOpen, setIsCartOpen } = useCart();

    const handleCheckout = () => {
        setIsCartOpen(false);
    };

    return (
        <Sheet open={isCartOpen} onOpenChange={setIsCartOpen}>
            <SheetContent className="w-full sm:max-w-lg flex flex-col">
                <SheetHeader className="px-6 pt-6">
                    <SheetTitle className="flex items-center gap-2 text-lg font-semibold">
                        <ShoppingBag className="w-5 h-5" />
                        Your Cart ({itemCount})
                    </SheetTitle>
                </SheetHeader>
                
                <Separator />

                {items.length === 0 ? (
                    <div className="flex-1 flex flex-col items-center justify-center text-center p-6">
                        <ShoppingBag className="w-16 h-16 text-muted-foreground opacity-30 mb-4" />
                        <h3 className="text-xl font-semibold">Your cart is empty</h3>
                        <p className="text-muted-foreground mt-2">Looks like you haven't added anything yet.</p>
                        <Button
                            variant="outline"
                            className="mt-6"
                            onClick={() => setIsCartOpen(false)}
                        >
                            Continue Shopping
                        </Button>
                    </div>
                ) : (
                    <>
                        <ScrollArea className="flex-1 -mx-6 px-6">
                            <div className="space-y-6">
                                {items.map((item) => (
                                    <div key={item.id} className="flex gap-4">
                                        <div className="relative w-24 h-24 rounded-md overflow-hidden bg-muted shrink-0">
                                            <Image
                                                src={item.imageUrls[0]}
                                                alt={item.title}
                                                fill
                                                className="object-cover"
                                            />
                                        </div>
                                        <div className="flex-1 flex flex-col justify-between py-1">
                                            <div>
                                                <h4 className="font-semibold line-clamp-2 leading-tight">{item.title}</h4>
                                                <p className="text-sm font-bold text-primary mt-1">
                                                    ${item.price.toFixed(2)}
                                                </p>
                                            </div>
                                            <div className="flex items-center justify-between mt-2">
                                                <div className="flex items-center gap-2">
                                                    <Button
                                                        variant="outline"
                                                        size="icon"
                                                        className="h-7 w-7"
                                                        onClick={() => updateQuantity(item.id, item.quantity - 1)}
                                                    >
                                                        <Minus className="w-3.5 h-3.5" />
                                                    </Button>
                                                    <span className="text-sm font-medium w-5 text-center">{item.quantity}</span>
                                                    <Button
                                                        variant="outline"
                                                        size="icon"
                                                        className="h-7 w-7"
                                                        onClick={() => updateQuantity(item.id, item.quantity + 1)}
                                                    >
                                                        <Plus className="w-3.5 h-3.5" />
                                                    </Button>
                                                </div>
                                                <Button
                                                    variant="ghost"
                                                    size="icon"
                                                    className="h-8 w-8 text-muted-foreground hover:text-destructive"
                                                    onClick={() => removeItem(item.id)}
                                                >
                                                    <Trash2 className="w-4 h-4" />
                                                </Button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </ScrollArea>
                        
                        <SheetFooter className="px-6 pb-6 pt-4 mt-auto border-t">
                            <div className="w-full space-y-4">
                                <div className="flex justify-between text-lg font-semibold">
                                    <span>Subtotal</span>
                                    <span>${cartTotal.toFixed(2)}</span>
                                </div>
                                <p className="text-xs text-muted-foreground text-center">
                                    Shipping and taxes will be calculated at checkout.
                                </p>
                                <Button size="lg" className="w-full" asChild>
                                    <Link href="/checkout" onClick={handleCheckout}>Proceed to Checkout</Link>
                                </Button>
                            </div>
                        </SheetFooter>
                    </>
                )}
            </SheetContent>
        </Sheet>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/dashboard/dashboard-sidebar.tsx
--------------------------------------------------------------------------------


'use client';

import React from 'react';
import Link from 'next/link';
import {
  Home,
  Package,
  Wand2,
  DollarSign,
  Star,
  AreaChart,
  Settings,
  Camera,
  Package2,
  Sparkles,
  Layers,
} from 'lucide-react';
import { usePathname } from 'next/navigation';
import { cn } from '@/lib/utils';
import { useSidebar } from '@/components/layout/sidebar-provider';
import { SidebarToggle } from '../layout/sidebar-toggle';

const navItems = [
  { href: '/sell/dashboard', label: 'Dashboard', icon: Home },
  { href: '/sell/listings', label: 'My Listings', icon: Package },
  { href: '/sell/payouts', label: 'Payouts', icon: DollarSign },
  { href: '/sell/reviews', label: 'Reviews', icon: Star },
  { href: '/sell/analytics', label: 'Analytics', icon: AreaChart },
  { href: '/sell/settings', label: 'Settings', icon: Settings },
];

const aiTools = [
    { href: '/sell/bulk-lister', label: 'Bulk AI Lister', icon: Layers },
    { href: '/sell/cards', label: 'AI Card Grader', icon: Sparkles },
]

export default function DashboardSidebar() {
  const pathname = usePathname();
  const { isSidebarOpen } = useSidebar();

  return (
     <div className={cn("flex flex-col h-full bg-muted/40", isSidebarOpen ? 'w-64' : 'w-20' )}>
        <div className="flex items-center justify-between p-4 border-b h-16">
            <Link href="/" className="flex items-center gap-2 font-semibold">
                <Package2 className="h-6 w-6 shrink-0" />
                <span className={cn('transition-opacity', isSidebarOpen ? 'opacity-100' : 'opacity-0 w-0')}>Picksy Seller</span>
            </Link>
            <SidebarToggle />
        </div>
        <nav className="flex-grow p-2 space-y-1">
            {navItems.map(item => (
            <Link
                key={item.href}
                href={item.href}
                className={cn(
                'flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:text-primary',
                pathname === item.href && 'bg-primary/10 text-primary',
                 !isSidebarOpen && 'justify-center'
                )}
            >
                <item.icon className="h-5 w-5 shrink-0" />
                <span className={cn('whitespace-nowrap transition-opacity', isSidebarOpen ? 'opacity-100' : 'opacity-0 w-0')}>{item.label}</span>
            </Link>
            ))}
             <div className="px-3 py-2">
                <h2 className={cn('text-xs font-semibold text-muted-foreground tracking-wider transition-opacity', isSidebarOpen ? 'opacity-100' : 'opacity-0 w-0')}>AI Tools</h2>
            </div>
            {aiTools.map(item => (
            <Link
                key={item.href}
                href={item.href}
                className={cn(
                'flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:text-primary',
                pathname === item.href && 'bg-primary/10 text-primary',
                 !isSidebarOpen && 'justify-center'
                )}
            >
                <item.icon className="h-5 w-5 shrink-0" />
                <span className={cn('whitespace-nowrap transition-opacity', isSidebarOpen ? 'opacity-100' : 'opacity-0 w-0')}>{item.label}</span>
            </Link>
            ))}
        </nav>
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/filters/AdvancedFilterPanel.tsx
--------------------------------------------------------------------------------

'use client';

import { useState, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Slider } from '@/components/ui/slider';
import { Checkbox } from '@/components/ui/checkbox';
import {
    Sheet,
    SheetContent,
    SheetDescription,
    SheetHeader,
    SheetTitle,
    SheetTrigger,
    SheetFooter,
} from '@/components/ui/sheet';
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from '@/components/ui/select';
import { Separator } from '@/components/ui/separator';
import { Badge } from '@/components/ui/badge';
import { Filter, X, SlidersHorizontal } from 'lucide-react';
import type { ProductSearchParams } from '@/lib/types';

const CATEGORIES = [
    'Collector Cards',
    'Coins',
    'Collectibles',
];

const CONDITIONS = [
    'Mint',
    'Near Mint',
    'Excellent',
    'Good',
    'Fair',
    'Poor',
];

const SORT_OPTIONS = [
    { value: 'createdAt-desc', label: 'Newest First' },
    { value: 'createdAt-asc', label: 'Oldest First' },
    { value: 'price-asc', label: 'Price: Low to High' },
    { value: 'price-desc', label: 'Price: High to Low' },
    { value: 'views-desc', label: 'Most Popular' },
    { value: 'title-asc', label: 'Title: A to Z' },
];

interface AdvancedFilterPanelProps {
    currentFilters: Partial<ProductSearchParams>;
    onFilterChange: (filters: Partial<ProductSearchParams>) => void;
    onClearFilters: () => void;
}

export default function AdvancedFilterPanel({
    currentFilters,
    onFilterChange,
    onClearFilters,
}: AdvancedFilterPanelProps) {
    const [isOpen, setIsOpen] = useState(false);

    // Local state for filters
    const [localFilters, setLocalFilters] = useState<Partial<ProductSearchParams>>(currentFilters);

    const handleLocalChange = useCallback((key: string, value: any) => {
        setLocalFilters(prev => ({
            ...prev,
            [key]: value,
        }));
    }, []);

    const handleApplyFilters = () => {
        onFilterChange(localFilters);
        setIsOpen(false);
    };

    const handleClear = () => {
        setLocalFilters({});
        onClearFilters();
    };

    const toggleCategory = (category: string) => {
        const currentCategories = (localFilters.categories as string[]) || [];
        const newCategories = currentCategories.includes(category)
            ? currentCategories.filter(c => c !== category)
            : [...currentCategories, category];
        handleLocalChange('categories', newCategories.length > 0 ? newCategories : undefined);
    };

    const toggleCondition = (condition: string) => {
        const currentConditions = (localFilters.conditions as string[]) || [];
        const newConditions = currentConditions.includes(condition)
            ? currentConditions.filter(c => c !== condition)
            : [...currentConditions, condition];
        handleLocalChange('conditions', newConditions.length > 0 ? newConditions : undefined);
    };

    const activeFilterCount = Object.keys(currentFilters).filter(
        key => !['view', 'sort', 'page'].includes(key) && currentFilters[key as keyof ProductSearchParams]
    ).length;

    const priceRange = (localFilters.priceRange as [number, number]) || [0, 10000];
    const yearRange = (localFilters.yearRange as [number, number]) || [1900, new Date().getFullYear()];

    return (
        <Sheet open={isOpen} onOpenChange={setIsOpen}>
            <SheetTrigger asChild>
                <Button variant="outline" className="relative">
                    <SlidersHorizontal className="mr-2 h-4 w-4" />
                    Filters
                    {activeFilterCount > 0 && (
                        <Badge className="ml-2 px-1.5 min-w-[20px] h-5" variant="default">
                            {activeFilterCount}
                        </Badge>
                    )}
                </Button>
            </SheetTrigger>
            <SheetContent className="w-full sm:max-w-lg overflow-y-auto">
                <SheetHeader>
                    <SheetTitle>Advanced Filters</SheetTitle>
                    <SheetDescription>
                        Refine your search with detailed filters
                    </SheetDescription>
                </SheetHeader>

                <div className="py-6 space-y-6">
                    {/* Sort */}
                    <div className="space-y-3">
                        <Label className="text-base font-semibold">Sort By</Label>
                        <Select
                            value={localFilters.sort as string || 'createdAt-desc'}
                            onValueChange={(value) => handleLocalChange('sort', value)}
                        >
                            <SelectTrigger>
                                <SelectValue placeholder="Select sort order" />
                            </SelectTrigger>
                            <SelectContent>
                                {SORT_OPTIONS.map(option => (
                                    <SelectItem key={option.value} value={option.value}>
                                        {option.label}
                                    </SelectItem>
                                ))}
                            </SelectContent>
                        </Select>
                    </div>

                    <Separator />

                    {/* Price Range */}
                    <div className="space-y-4">
                        <Label className="text-base font-semibold">
                            Price Range: ${priceRange[0]} - ${priceRange[1]}
                        </Label>
                        <Slider
                            min={0}
                            max={10000}
                            step={50}
                            value={priceRange}
                            onValueChange={(value) => handleLocalChange('priceRange', value as [number, number])}
                            className="w-full"
                        />
                        <div className="flex gap-4">
                            <div className="flex-1">
                                <Label className="text-xs text-muted-foreground">Min ($)</Label>
                                <Input
                                    type="number"
                                    value={priceRange[0]}
                                    onChange={(e) => handleLocalChange('priceRange', [Number(e.target.value), priceRange[1]])}
                                    className="mt-1"
                                />
                            </div>
                            <div className="flex-1">
                                <Label className="text-xs text-muted-foreground">Max ($)</Label>
                                <Input
                                    type="number"
                                    value={priceRange[1]}
                                    onChange={(e) => handleLocalChange('priceRange', [priceRange[0], Number(e.target.value)])}
                                    className="mt-1"
                                />
                            </div>
                        </div>
                    </div>

                    <Separator />

                    {/* Categories */}
                    <div className="space-y-3">
                        <Label className="text-base font-semibold">Categories</Label>
                        <div className="space-y-2">
                            {CATEGORIES.map(category => {
                                const isSelected = (localFilters.categories as string[] || []).includes(category);
                                return (
                                    <div key={category} className="flex items-center space-x-2">
                                        <Checkbox
                                            id={`category-${category}`}
                                            checked={isSelected}
                                            onCheckedChange={() => toggleCategory(category)}
                                        />
                                        <label
                                            htmlFor={`category-${category}`}
                                            className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer"
                                        >
                                            {category}
                                        </label>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <Separator />

                    {/* Conditions */}
                    <div className="space-y-3">
                        <Label className="text-base font-semibold">Condition</Label>
                        <div className="grid grid-cols-2 gap-2">
                            {CONDITIONS.map(condition => {
                                const isSelected = (localFilters.conditions as string[] || []).includes(condition);
                                return (
                                    <div key={condition} className="flex items-center space-x-2">
                                        <Checkbox
                                            id={`condition-${condition}`}
                                            checked={isSelected}
                                            onCheckedChange={() => toggleCondition(condition)}
                                        />
                                        <label
                                            htmlFor={`condition-${condition}`}
                                            className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer"
                                        >
                                            {condition}
                                        </label>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <Separator />

                    {/* Year Range */}
                    <div className="space-y-4">
                        <Label className="text-base font-semibold">
                            Year Range: {yearRange[0]} - {yearRange[1]}
                        </Label>
                        <Slider
                            min={1900}
                            max={new Date().getFullYear()}
                            step={1}
                            value={yearRange}
                            onValueChange={(value) => handleLocalChange('yearRange', value as [number, number])}
                            className="w-full"
                        />
                        <div className="flex gap-4">
                            <div className="flex-1">
                                <Label className="text-xs text-muted-foreground">From</Label>
                                <Input
                                    type="number"
                                    value={yearRange[0]}
                                    onChange={(e) => handleLocalChange('yearRange', [Number(e.target.value), yearRange[1]])}
                                    className="mt-1"
                                />
                            </div>
                            <div className="flex-1">
                                <Label className="text-xs text-muted-foreground">To</Label>
                                <Input
                                    type="number"
                                    value={yearRange[1]}
                                    onChange={(e) => handleLocalChange('yearRange', [yearRange[0], Number(e.target.value)])}
                                    className="mt-1"
                                />
                            </div>
                        </div>
                    </div>

                    <Separator />

                    {/* Seller Rating */}
                    <div className="space-y-3">
                        <Label className="text-base font-semibold">Minimum Seller Rating</Label>
                        <Select
                            value={String(localFilters.minRating || '')}
                            onValueChange={(value) => handleLocalChange('minRating', value ? Number(value) : undefined)}
                        >
                            <SelectTrigger>
                                <SelectValue placeholder="Any rating" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="">Any Rating</SelectItem>
                                <SelectItem value="4.5">4.5  & up</SelectItem>
                                <SelectItem value="4.0">4.0  & up</SelectItem>
                                <SelectItem value="3.5">3.5  & up</SelectItem>
                                <SelectItem value="3.0">3.0  & up</SelectItem>
                            </SelectContent>
                        </Select>
                    </div>

                    <Separator />

                    {/* Keyword Search */}
                    <div className="space-y-3">
                        <Label className="text-base font-semibold">Keyword Search</Label>
                        <Input
                            placeholder="Search in titles and descriptions..."
                            value={localFilters.q as string || ''}
                            onChange={(e) => handleLocalChange('q', e.target.value || undefined)}
                        />
                    </div>
                </div>

                <SheetFooter className="flex-col sm:flex-col gap-2 sticky bottom-0 bg-background pt-4">
                    <Button onClick={handleApplyFilters} className="w-full">
                        Apply Filters
                    </Button>
                    <Button onClick={handleClear} variant="outline" className="w-full">
                        <X className="mr-2 h-4 w-4" />
                        Clear All Filters
                    </Button>
                </SheetFooter>
            </SheetContent>
        </Sheet>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/filters/collector-cards-filter-trigger.tsx
--------------------------------------------------------------------------------


'use client';

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import {
    Sheet,
    SheetContent,
    SheetDescription,
    SheetHeader,
    SheetTitle,
    SheetTrigger,
} from "@/components/ui/sheet";
import { Checkbox } from "@/components/ui/checkbox";
import { Filter, X } from "lucide-react";
import { ScrollArea } from "@/components/ui/scroll-area";
import type { UserProfile } from "@/lib/types";
import { Slider } from "../ui/slider";

interface CollectorCardsFilterTriggerProps {
    sortOrder: string;
    setSortOrder: (value: string) => void;
    postcode: string;
    setPostcode: (value: string) => void;
    isExclusionMode: boolean;
    setIsExclusionMode: (value: boolean) => void;
    selectedSellers: string[];
    handleSellerSelection: (sellerId: string) => void;
    availableSellers: UserProfile[];
    priceRange: [number, number];
    setPriceRange: (value: [number, number]) => void;
    conditionOptions: string[];
    selectedConditions: string[];
    handleConditionSelection: (condition: string) => void;
}

export function CollectorCardsFilterTrigger({
    sortOrder,
    setSortOrder,
    postcode,
    setPostcode,
    isExclusionMode,
    setIsExclusionMode,
    selectedSellers,
    handleSellerSelection,
    availableSellers,
    priceRange,
    setPriceRange,
    conditionOptions,
    selectedConditions,
    handleConditionSelection,
}: CollectorCardsFilterTriggerProps) {
    return (
        <Sheet>
            <SheetTrigger asChild>
                <Button variant="outline" size="sm" className="h-10 gap-2">
                    <Filter className="w-4 h-4" />
                    <span className="hidden sm:inline">Filters</span>
                </Button>
            </SheetTrigger>
            <SheetContent side="right" className="w-[300px] sm:w-[540px]">
                <SheetHeader>
                    <SheetTitle>Filter & Sort</SheetTitle>
                    <SheetDescription>
                        Narrow down your search results.
                    </SheetDescription>
                </SheetHeader>
                <ScrollArea className="h-[calc(100vh-100px)] pr-4 mt-4">
                    <div className="space-y-8">
                        {/* Sort Order */}
                        <div className="space-y-2">
                            <Label className="font-semibold">Sort By</Label>
                            <Select value={sortOrder} onValueChange={setSortOrder}>
                                <SelectTrigger>
                                    <SelectValue placeholder="Sort by" />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem value="createdAt-desc">Newest</SelectItem>
                                    <SelectItem value="price-asc">Price: Low to High</SelectItem>
                                    <SelectItem value="price-desc">Price: High to Low</SelectItem>
                                </SelectContent>
                            </Select>
                        </div>

                        {/* Price Range */}
                        <div className="space-y-4">
                            <Label className="font-semibold">Price Range</Label>
                            <Slider
                                min={0}
                                max={5000}
                                step={10}
                                value={priceRange}
                                onValueChange={(value) => setPriceRange(value as [number, number])}
                            />
                            <div className="flex justify-between text-sm text-muted-foreground">
                                <span>${priceRange[0]}</span>
                                <span>${priceRange[1]}{priceRange[1] === 5000 ? '+' : ''}</span>
                            </div>
                        </div>

                        {/* Condition */}
                        <div className="space-y-2">
                             <Label className="font-semibold">Condition</Label>
                             <div className="space-y-2 border rounded-md p-4 bg-muted/20">
                                {conditionOptions.map(condition => (
                                    <div key={condition} className="flex items-center space-x-2">
                                        <Checkbox
                                            id={`condition-${condition}`}
                                            checked={selectedConditions.includes(condition)}
                                            onCheckedChange={() => handleConditionSelection(condition)}
                                        />
                                        <Label htmlFor={`condition-${condition}`} className="text-sm font-normal">
                                            {condition}
                                        </Label>
                                    </div>
                                ))}
                             </div>
                        </div>


                        {/* Postcode */}
                        <div className="space-y-2">
                            <Label className="font-semibold">Seller Postcode</Label>
                            <Input
                                placeholder="e.g. 6000"
                                value={postcode}
                                onChange={(e) => setPostcode(e.target.value)}
                            />
                        </div>

                        {/* Seller Filters */}
                        <div className="space-y-4">
                            <div className="flex items-center justify-between">
                                <Label className="font-semibold">Sellers</Label>
                                <div className="flex items-center space-x-2">
                                    <Label htmlFor="exclusion-mode" className="text-xs text-muted-foreground">
                                        Exclusion Mode
                                    </Label>
                                    <Checkbox
                                        id="exclusion-mode"
                                        checked={isExclusionMode}
                                        onCheckedChange={(checked) => setIsExclusionMode(checked as boolean)}
                                    />
                                </div>
                            </div>
                            <div className="space-y-2 border rounded-md p-4 bg-muted/20 max-h-48 overflow-y-auto">
                                {availableSellers.length > 0 ? (
                                    availableSellers.map((seller) => (
                                        <div key={seller.id} className="flex items-center space-x-2">
                                            <Checkbox
                                                id={`seller-${seller.id}`}
                                                checked={selectedSellers.includes(seller.id)}
                                                onCheckedChange={() => handleSellerSelection(seller.id)}
                                            />
                                            <Label htmlFor={`seller-${seller.id}`} className="text-sm font-normal">
                                                {seller.displayName}
                                            </Label>
                                        </div>
                                    ))
                                ) : (
                                    <p className="text-sm text-muted-foreground">No active sellers found.</p>
                                )}
                            </div>
                        </div>
                    </div>
                </ScrollArea>
            </SheetContent>
        </Sheet>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/home/CTA.tsx
--------------------------------------------------------------------------------

// components/home/CTA.tsx
import Link from "next/link";
import { Button } from "@/components/ui/button";

export default function CTA() {
  return (
    <section className="py-16 sm:py-20">
      <div className="container mx-auto px-4 text-center bg-gradient-to-r from-primary to-accent/80 p-12 rounded-xl">
        <h2 className="text-3xl md:text-4xl font-bold text-white mb-4">Ready to Start Your Collection?</h2>
        <p className="text-white/90 max-w-2xl mx-auto mb-8">Join thousands of collectors who trust Picksy for authentic finds and secure transactions.</p>

        <div className="flex flex-col sm:flex-row gap-4 justify-center">
          <Button size="lg" variant="secondary" asChild className="w-full sm:w-auto">
            <Link href="/browse">Start Exploring</Link>
          </Button>
          <Button size="lg" variant="outline" asChild className="w-full sm:w-auto bg-transparent border-white text-white hover:bg-white hover:text-primary">
            <Link href="/about">Learn More</Link>
          </Button>
        </div>
      </div>
    </section>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/home/FeaturedCategories.tsx
--------------------------------------------------------------------------------

'use client';
import Link from "next/link";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Coins, CreditCard, ToyBrick, Gamepad2, Star, Footprints } from "lucide-react";

const staticCategories = [
    { name: 'Pokemon', href: '/browse?q=pokemon', icon: <Gamepad2 className="h-6 w-6" /> },
    { name: '$1 Coins', href: '/browse?q=%241+coin', icon: <Coins className="h-6 w-6" /> },
    { name: '$2 Coins', href: '/browse?q=%242+coin', icon: <Coins className="h-6 w-6" /> },
    { name: '50c Coins', href: '/browse?q=50c+coin', icon: <Coins className="h-6 w-6" /> },
    { name: 'Barbie', href: '/browse?q=barbie', icon: <ToyBrick className="h-6 w-6" /> },
    { name: 'NBA', href: '/browse?q=nba', icon: <CreditCard className="h-6 w-6" /> },
    { name: 'Rookies', href: '/browse?q=rookie', icon: <Star className="h-6 w-6" /> },
    { name: 'Shoes', href: '/browse?q=shoes', icon: <Footprints className="h-6 w-6" /> },
];

export default function FeaturedCategories() {
  return (
    <section className="py-16 container mx-auto px-4">
      <div className="text-center mb-12">
        <h2 className="text-3xl md:text-4xl font-bold mb-4">Browse by Category</h2>
        <p className="text-muted-foreground max-w-2xl mx-auto">
          Explore our carefully curated categories to find exactly what you're looking for
        </p>
      </div>
      
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {staticCategories.map((category) => (
            <Link key={category.name} href={category.href} className="h-full">
            <Card className="group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 border-2 hover:border-primary h-full">
                <CardContent className="p-6 flex flex-col items-center justify-center text-center h-full">
                <div className="p-3 rounded-full bg-primary/10 text-primary mb-4 group-hover:scale-110 transition-transform">
                    {category.icon}
                </div>
                <h3 className="font-semibold mb-1">{category.name}</h3>
                <p className="text-xs text-muted-foreground">Explore </p>
                </CardContent>
            </Card>
            </Link>
        ))}
      </div>
      
      <div className="text-center mt-12">
        <Button variant="outline" asChild>
          <Link href="/browse">View All Categories</Link>
        </Button>
      </div>
    </section>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/home/Hero.tsx
--------------------------------------------------------------------------------

import Link from "next/link";
import { Button } from "@/components/ui/button";

export default function Hero({ productCount, error }: { productCount: number | null, error: string | null }) {
  const count = productCount ?? 0;
  return (
    <section className="bg-gray-50/50 dark:bg-background">
      <div className="container mx-auto px-4 py-16 text-center lg:py-24">
        <h1 className="text-4xl font-bold tracking-tight text-foreground sm:text-5xl md:text-6xl">
          Discover Rare Finds & Unique Collectibles
        </h1>
        <p className="mt-6 max-w-2xl mx-auto text-lg text-muted-foreground">
          Picksy is the premier marketplace for collectors, with over {count.toLocaleString()} items to discover. Buy, sell, and trade verified collectibles with complete confidence.
        </p>
        <div className="mt-10 flex justify-center gap-x-6">
          <Button asChild size="lg">
            <Link href="/browse">Start Exploring</Link>
          </Button>
          <Button asChild variant="outline" size="lg">
            <Link href="/consign">Sell with Us</Link>
          </Button>
        </div>
      </div>
    </section>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/home/MarketTrends.tsx
--------------------------------------------------------------------------------


'use client';

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { TrendingUp } from "lucide-react";

const trends = [
  { name: "Graded Pokmon", change: "+12.4%", volume: "$4.2M", color: "text-green-500" },
  { name: "Pre-War Coins", change: "+8.1%", volume: "$1.8M", color: "text-green-500" },
  { name: "NBA Top Shot", change: "-3.2%", volume: "$940K", color: "text-red-500" },
  { name: "Vintage Baseball", change: "+22.7%", volume: "$12.5M", color: "text-green-500" },
];

export function MarketTrends() {
  return (
    <Card className="bg-white dark:bg-white/5 rounded-xl p-6 border border-[#e7ebf3] dark:border-white/10">
      <CardHeader className="flex flex-row items-center justify-between mb-6 p-0">
        <CardTitle className="font-black text-lg">Market Trends</CardTitle>
        <TrendingUp className="h-5 w-5 text-primary" />
      </CardHeader>
      <CardContent className="p-0">
        <div className="space-y-5">
          {trends.map(trend => (
            <div key={trend.name} className="flex items-center justify-between group cursor-pointer">
              <div>
                <p className="text-sm font-bold">{trend.name}</p>
                <p className="text-[10px] text-gray-500 uppercase font-black">24h Volume</p>
              </div>
              <div className="text-right">
                <p className={`text-sm font-bold ${trend.color}`}>{trend.change}</p>
                <p className="text-[10px] text-gray-400">{trend.volume}</p>
              </div>
            </div>
          ))}
        </div>
        <Button variant="outline" className="w-full mt-6 text-xs font-black uppercase tracking-widest text-primary border-primary/20 rounded-lg hover:bg-primary/5 transition-colors">
            View Full Report
        </Button>
      </CardContent>
    </Card>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/home/WhyChooseUs.tsx
--------------------------------------------------------------------------------


import { Shield, Truck, DollarSign, Users, Clock, Headphones } from "lucide-react";

const features = [
  {
    icon: Truck,
    title: "Secure Shipping",
    description: "Insured and tracked shipping with specialized packaging for collectibles.",
  },
  {
    icon: Clock,
    title: "Fast Transactions",
    description: "Quick payment processing and fast shipping for a seamless experience.",
  },
  {
    icon: Headphones,
    title: "Dedicated Support",
    description: "24/7 customer support from collectible experts ready to help you.",
  },
];

export default function WhyChooseUs() {
  return (
    <section className="py-16">
      <div className="text-center mb-12">
        <h2 className="text-3xl md:text-4xl font-bold mb-4">Why Collectors Choose Picksy</h2>
        <p className="text-muted-foreground max-w-2xl mx-auto">
          We've built the ultimate platform for collectors with features designed specifically for the collecting community
        </p>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
        {features.map((feature) => (
          <div key={feature.title} className="p-6 border rounded-xl hover:border-primary transition-colors">
            <div className="inline-flex p-3 rounded-lg bg-primary/10 text-primary mb-4">
              <feature.icon className="h-6 w-6" />
            </div>
            <h3 className="text-xl font-semibold mb-2">{feature.title}</h3>
            <p className="text-muted-foreground">{feature.description}</p>
          </div>
        ))}
      </div>
    </section>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/AdminSidebar.tsx
--------------------------------------------------------------------------------


"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import {
    Sidebar,
    SidebarContent,
    SidebarHeader,
    SidebarMenu,
    SidebarMenuItem,
    SidebarMenuButton,
    SidebarTrigger,
    SidebarFooter,
} from "@/components/ui/sidebar";
import {
    LayoutDashboard,
    Box,
    Shapes,
    MessageSquareWarning,
    BarChart,
    ShieldCheck,
    ShieldAlert,
    Home,
    Settings,
    Zap,
    Users,
    Globe,
    Activity,
    ListChecks
} from "lucide-react";
import { Logo } from "@/components/logo";
import { motion } from "framer-motion";
import { useUser } from "@/firebase";
import { useSidebar } from "@/components/layout/sidebar-provider";
import { cn } from "@/lib/utils";

const navItems = [
    { href: "/admin", icon: LayoutDashboard, label: "Dashboard" },
    { href: "/admin/products", icon: Box, label: "Products" },
    { href: "/admin/management", icon: ListChecks, label: "Management" },
    { href: "/admin/users", icon: Users, label: "Users" },
    { href: "/admin/disputes", icon: MessageSquareWarning, label: "Disputes" },
    { href: "/admin/analytics", icon: BarChart, label: "Analytics" },
];

const integrityItems = [
    { href: "/admin/moderation", icon: ShieldCheck, label: "Moderation" },
    { href: "/admin/fraud-detection", icon: ShieldAlert, label: "Fraud Lab" },
];

const sysItems = [
    { href: "/admin/seo", icon: Globe, label: "SEO" },
    { href: "/admin/system", icon: Activity, label: "System Health" },
    { href: "/admin/settings", icon: Settings, label: "System Settings" },
];

export default function AdminSidebar() {
    const pathname = usePathname();
    const { user } = useUser();
    const { isSidebarOpen, isHovered } = useSidebar();
    const effectiveOpen = isSidebarOpen || isHovered;

    return (
        <Sidebar>
            <SidebarHeader className="p-6">
                <div className="flex items-center justify-between w-full">
                    {effectiveOpen ? (
                        <Link href="/admin" className="block transform transition-transform hover:scale-105">
                            <Logo className="w-auto h-8" />
                        </Link>
                    ) : (
                        <div className="mx-auto bg-primary/10 p-2 rounded-lg">
                            <Zap className="h-5 w-5 text-primary" />
                        </div>
                    )}
                    {effectiveOpen && <SidebarTrigger />}
                </div>
            </SidebarHeader>

            <SidebarContent className="px-4 py-2">
                <SidebarMenu>
                    <SidebarMenuItem>
                        <SidebarMenuButton asChild tooltip="Return to Marketplace">
                            <Link href="/">
                                <Home />
                                <span>Marketplace</span>
                            </Link>
                        </SidebarMenuButton>
                    </SidebarMenuItem>
                </SidebarMenu>

                <div className="my-4 px-4">
                    <div className="h-px bg-border" />
                </div>

                <SidebarMenu className="space-y-1">
                    {navItems.map((item) => {
                        const isActive = pathname === item.href;
                        return (
                            <SidebarMenuItem key={item.href}>
                                <Link href={item.href}>
                                    <SidebarMenuButton
                                        isActive={isActive}
                                        tooltip={item.label}
                                        className="relative group overflow-hidden"
                                    >
                                        <item.icon />
                                        <span>{item.label}</span>
                                        {isActive && effectiveOpen && (
                                            <motion.div
                                                layoutId="active-pill"
                                                className="absolute left-0 w-1 h-6 bg-primary rounded-full"
                                                transition={{ type: 'spring', stiffness: 300, damping: 30 }}
                                            />
                                        )}
                                    </SidebarMenuButton>
                                </Link>
                            </SidebarMenuItem>
                        );
                    })}
                </SidebarMenu>

                <div className="my-4 px-4">
                    {effectiveOpen && <div className="text-[10px] uppercase font-bold text-muted-foreground tracking-widest px-2 mb-2">Integrity</div>}
                    <SidebarMenu className="space-y-1">
                        {integrityItems.map((item) => {
                            const isActive = pathname === item.href;
                            return (
                                <SidebarMenuItem key={item.href}>
                                    <Link href={item.href}>
                                        <SidebarMenuButton isActive={isActive} tooltip={item.label}>
                                            <item.icon />
                                            <span>{item.label}</span>
                                        </SidebarMenuButton>
                                    </Link>
                                </SidebarMenuItem>
                            );
                        })}
                    </SidebarMenu>
                </div>


                <div className="my-4 px-4">
                    {effectiveOpen && <div className="text-[10px] uppercase font-bold text-muted-foreground tracking-widest px-2 mb-2">Configuration</div>}
                    <SidebarMenu className="space-y-1">
                        {sysItems.map((item) => {
                            const isActive = pathname === item.href;
                            return (
                                <SidebarMenuItem key={item.href}>
                                    <Link href={item.href}>
                                        <SidebarMenuButton isActive={isActive} tooltip={item.label}>
                                            <item.icon />
                                            <span>{item.label}</span>
                                        </SidebarMenuButton>
                                    </Link>
                                </SidebarMenuItem>
                            );
                        })}
                    </SidebarMenu>
                </div>
            </SidebarContent>

            <SidebarFooter className={cn("p-6 border-t transition-all", !effectiveOpen && "p-2 px-4")}>
                <SidebarMenu>
                    <SidebarMenuItem>
                        <SidebarMenuButton asChild tooltip="Admin Profile">
                            <Link href="/profile" className={cn("flex items-center gap-3 p-2 rounded-lg hover:bg-muted transition-all", !effectiveOpen && "justify-center gap-0 p-0")}>
                                <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-primary to-accent flex items-center justify-center text-[10px] font-black text-white shrink-0">
                                    {user?.displayName?.[0] || 'A'}
                                </div>
                                {effectiveOpen && (
                                    <div className="flex flex-col">
                                        <span className="text-xs font-bold text-foreground">{user?.displayName || 'Administrator'}</span>
                                        <span className="text-[10px] text-muted-foreground font-mono tracking-tighter uppercase">Root Access</span>
                                    </div>
                                )}
                            </Link>
                        </SidebarMenuButton>
                    </SidebarMenuItem>
                </SidebarMenu>
            </SidebarFooter>
        </Sidebar>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/CoinsSidebar.tsx
--------------------------------------------------------------------------------


'use client'; // This component is now interactive and used within a client component

import {
  Coins,
  Shield,
  Globe,
  Calendar,
  Scale,
  Landmark,
  Diamond,
} from 'lucide-react';
import type { Category } from '@/lib/types';
import Link from 'next/link';
import { cn } from '@/lib/utils';
import { Card, CardContent } from '@/components/ui/card';
import { SidebarToggle } from './sidebar-toggle';
import { useSidebar } from '@/components/layout/sidebar-provider';

const staticCoinNavItems = [
  { title: 'All Coins', href: '/coins', icon: Landmark, isStatic: true },
  { title: 'World Coins', href: '/coins/world', icon: Globe, isStatic: true },
  { title: 'Ancient Coins', href: '/coins/ancient', icon: Shield, isStatic: true },
  { title: 'Bullion', href: '/coins/bullion', icon: Diamond, isStatic: true },
];

export function CoinsSidebar({ pathname, categories }: { pathname: string; categories: Category[] }) {
  const { isSidebarOpen } = useSidebar();
  
  const dynamicNavItems = categories.map((cat: Category) => ({
    title: cat.name,
    href: cat.href,
    icon: Coins, // Default icon for dynamic categories
  }));

  const combinedNavItems = [...staticCoinNavItems, ...dynamicNavItems];

  return (
    <div className={cn("flex flex-col h-full bg-muted/40", isSidebarOpen ? 'w-64' : 'w-20' )}>
        <div className="flex items-center justify-between p-4 border-b h-16">
            <div className="flex items-center">
                <Coins className="h-8 w-8 text-primary flex-shrink-0" />
                <h1 className={cn('ml-3 text-xl font-bold font-headline transition-opacity duration-200', isSidebarOpen ? 'opacity-100' : 'opacity-0 w-0')}>
                    Coins
                </h1>
            </div>
            <SidebarToggle />
        </div>
        <nav className="flex-grow p-2 space-y-1">
            <ul className="space-y-2">
            {combinedNavItems.map((item) => (
                <li key={item.title}>
                <Link
                    href={item.href}
                    className={cn(
                    'flex items-center p-3 rounded-lg',
                    pathname === item.href
                        ? 'bg-primary text-primary-foreground'
                        : 'text-foreground/80 hover:bg-muted hover:text-foreground',
                    !isSidebarOpen && 'justify-center'
                    )}
                >
                    <item.icon className="h-6 w-6 flex-shrink-0" />
                    <span
                    className={cn(
                        'ml-4 font-medium transition-opacity duration-200 whitespace-nowrap',
                        isSidebarOpen ? 'opacity-100' : 'opacity-0 w-0'
                    )}
                    >
                    {item.title}
                    </span>
                </Link>
                </li>
            ))}
            </ul>
        </nav>
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/Footer.tsx
--------------------------------------------------------------------------------


import Link from 'next/link';
import { Logo } from '../logo';
import { NewsletterSignup } from './NewsletterSignup';

const footerLinks = {
  Marketplace: [
    { name: 'Featured Assets', href: '/browse' },
    { name: 'Recently Verified', href: '/browse?sort=verified-desc' },
    { name: 'Auctions', href: '/browse?type=auction' },
    { name: 'Private Sales', href: '/sell' },
  ],
  Company: [
    { name: 'Our AI Tech', href: '/about' },
    { name: 'Grading Standards', href: '/how-it-works' },
    { name: 'Authenticity Guarantee', href: '/vault' },
    { name: 'Careers', href: '/about' },
  ],
};

export default function Footer() {
  return (
    <footer className="bg-white dark:bg-background-dark border-t border-[#e7ebf3] dark:border-white/10 py-12 px-4 md:px-10">
      <div className="max-w-[1440px] mx-auto grid grid-cols-2 md:grid-cols-4 gap-8">
        <div className="col-span-2 md:col-span-1">
          <div className="flex items-center gap-2 text-primary mb-6">
            <Logo />
          </div>
          <p className="text-sm text-gray-500 max-w-xs">The world's most trusted AI-powered marketplace for ultra-high-end collectibles.</p>
        </div>
        {Object.entries(footerLinks).map(([category, links]) => (
          <div key={category}>
            <h5 className="font-black text-xs uppercase tracking-widest mb-6">{category}</h5>
            <ul className="space-y-4 text-sm text-gray-500 dark:text-gray-400">
              {links.map((link) => (
                <li key={link.name}>
                  <Link href={link.href} className="hover:text-primary transition-colors">
                    {link.name}
                  </Link>
                </li>
              ))}
            </ul>
          </div>
        ))}
        <div>
          <h5 className="font-black text-xs uppercase tracking-widest mb-6">Newsletter</h5>
          <p className="text-sm text-gray-500 mb-4">Get early access to weekly drops.</p>
          <NewsletterSignup />
        </div>
      </div>
      <div className="max-w-[1440px] mx-auto mt-12 pt-8 border-t border-[#e7ebf3] dark:border-white/10 flex flex-col md:flex-row justify-between items-center gap-4 text-xs text-gray-400">
        <Link href="/log" className="cursor-default hover:text-gray-400 transition-colors">
           {new Date().getFullYear()} Picksy AI Technologies Inc. All rights reserved.
        </Link>
        <div className="flex gap-8">
          <Link href="/privacy" className="hover:text-primary transition-colors">Privacy Policy</Link>
          <Link href="/terms" className="hover:text-primary transition-colors">Terms of Service</Link>
        </div>
      </div>
    </footer>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/Header.tsx
--------------------------------------------------------------------------------


'use client';

import Link from 'next/link';
import { Logo } from '../logo';
import { MobileNav } from './mobile-nav';
import HeaderActions from './HeaderActions';
import { Suspense, useEffect, useState } from 'react';
import { MainNavLinks } from './MainNavLinks';
import { SearchBar } from './search-bar';

export default function Header() {
  const [isClient, setIsClient] = useState(false);

  useEffect(() => {
    setTimeout(() => {
        setIsClient(true);
    }, 0);
  }, []);

  return (
    <header className="sticky top-0 glass-nav z-50 px-4 md:px-10 py-3">
      <div className="max-w-[1440px] mx-auto flex items-center justify-between gap-8">
        <div className="flex items-center gap-4 md:gap-8 flex-1">
          {isClient && <MobileNav />}
          <Link href="/" className="flex items-center" aria-label="Back to homepage">
            <Logo />
          </Link>
          {isClient && <SearchBar className="hidden lg:flex flex-1 max-w-2xl h-10 group" />}
        </div>
        
        <div className="hidden md:flex items-center gap-8">
          {isClient && <MainNavLinks />}
        </div>
        
        <div className="flex items-center justify-end gap-2">
            {isClient && (
              <Suspense fallback={<div className="h-10 w-24 bg-muted/20 rounded-md" />}>
                <HeaderActions />
              </Suspense>
            )}
        </div>
      </div>
    </header>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/HeaderActions.tsx
--------------------------------------------------------------------------------

'use client';

import { useState } from 'react';
import { ShoppingCart, Search } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { useCart } from '@/context/CartContext';
import { UserNav } from './user-nav';
import { SearchCommand } from '@/components/search/SearchCommand';
import { NotificationBell } from '../notifications/NotificationBell';
import Link from 'next/link';
import { useUser } from '@/firebase/auth/use-user';

export default function HeaderActions() {
    const { itemCount, setIsCartOpen } = useCart();
    const [open, setOpen] = useState(false);
    const { user } = useUser();

    return (
        <div className="flex items-center justify-end space-x-1 md:space-x-2">
            <div className="lg:hidden">
                <Button variant="ghost" size="icon" onClick={() => setOpen(true)} aria-label="Open search">
                    <Search className="h-5 w-5" />
                </Button>
            </div>

            <NotificationBell />

            {user && (
                <div className="hidden md:flex items-center gap-2">
                    <Button asChild variant="default" size="sm" className="hidden sm:flex">
                        <Link href="/sell/create">New</Link>
                    </Button>
                </div>
            )}

            <Button
                variant="ghost"
                size="icon"
                className="relative"
                onClick={() => setIsCartOpen(true)}
                aria-label={`Open cart with ${itemCount} items`}
            >
                <ShoppingCart className="h-5 w-5" />
                {itemCount > 0 && (
                    <span className="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-primary text-xs text-white">
                        {itemCount}
                    </span>
                )}
            </Button>

            <UserNav />

            <SearchCommand open={open} setOpen={setOpen} />
        </div>
    )
}


--------------------------------------------------------------------------------
FILE: src/components/layout/MainNavLinks.tsx
--------------------------------------------------------------------------------


"use client"

import Link from 'next/link';
import {
  NavigationMenu,
  NavigationMenuItem,
  NavigationMenuLink,
  NavigationMenuList,
} from '@/components/ui/navigation-menu';
import { navigationMenuTriggerStyle } from '@/components/ui/navigation-menu';
import { useUser } from '@/firebase';

export function MainNavLinks() {
  const { user } = useUser();

  return (
    <NavigationMenu>
      <NavigationMenuList>
        <NavigationMenuItem>
          <NavigationMenuLink asChild className={navigationMenuTriggerStyle()}>
            <Link href="/collector-cards">
              Cards
            </Link>
          </NavigationMenuLink>
        </NavigationMenuItem>
        <NavigationMenuItem>
          <NavigationMenuLink asChild className={navigationMenuTriggerStyle()}>
            <Link href="/coins">
              Coins
            </Link>
          </NavigationMenuLink>
        </NavigationMenuItem>
        <NavigationMenuItem>
          <NavigationMenuLink asChild className={navigationMenuTriggerStyle()}>
            <Link href="/collectibles">
              Memorabilia
            </Link>
          </NavigationMenuLink>
        </NavigationMenuItem>
        <NavigationMenuItem>
          <NavigationMenuLink asChild className={navigationMenuTriggerStyle()}>
            <Link href="/general">
              General
            </Link>
          </NavigationMenuLink>
        </NavigationMenuItem>
        <NavigationMenuItem>
          <NavigationMenuLink asChild className={navigationMenuTriggerStyle()}>
            <Link href="/consign">
              Consign
            </Link>
          </NavigationMenuLink>
        </NavigationMenuItem>
        {user && (
          <NavigationMenuItem>
            <NavigationMenuLink asChild className={navigationMenuTriggerStyle()}>
              <Link href="/research">
                Research
              </Link>
            </NavigationMenuLink>
          </NavigationMenuItem>
        )}
      </NavigationMenuList>
    </NavigationMenu>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/MobileNavContent.tsx
--------------------------------------------------------------------------------



'use client';

import { useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { signOutUser } from '@/lib/firebase/auth';
import { useUser, useDoc, useMemoFirebase, useCollection } from '@/firebase';
import { collection, query, orderBy, doc } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
    LayoutGrid, Tag, User, Heart, ShoppingBag, LayoutDashboard, Shield, LogOut, LogIn,
    Coins, CreditCard, Gem, BookOpen, Stamp, Gamepad2, Search
} from 'lucide-react';
import type { Category, UserProfile } from '@/lib/types';
import { Skeleton } from '../ui/skeleton';
import { useUserPermissions } from '@/hooks/use-user-permissions';

// Helper to map DB sections to Icons
const iconMap: Record<string, any> = {
    'coins': Coins,
    'collector-cards': CreditCard,
    'collectibles': Gem,
    'comics': BookOpen,
    'stamps': Stamp,
    'video-games': Gamepad2,
};

export function MobileNavContent({ setIsOpen }: { setIsOpen: (isOpen: boolean) => void }) {
    const { user } = useUser();
    const router = useRouter();
    const { isSuperAdmin, isLoading: isPermissionsLoading } = useUserPermissions();

    // 1. Fetch Categories Dynamically
    const categoriesQuery = useMemoFirebase(() => query(collection(db, 'categories'), orderBy('name')), []);
    const { data: categories } = useCollection<Category>(categoriesQuery);

    // 2. Group Categories by Section
    const groupedCategories = useMemo(() => {
        const mainSections = {
            'collector-cards': { label: 'Collector Cards', icon: CreditCard, href: '/collector-cards', items: [] as Category[] },
            'coins': { label: 'Coins', icon: Coins, href: '/coins', items: [] as Category[] },
            'collectibles': { label: 'Collectibles', icon: Gem, href: '/collectibles', items: [] as Category[] },
        } as Record<string, { label: string, icon: any, href: string, items: Category[] }>;

        if (!categories) return mainSections;

        categories.forEach(cat => {
            if (mainSections[cat.section]) {
                mainSections[cat.section].items.push(cat);
            } else {
                if (!mainSections.collectibles) {
                    mainSections.collectibles = { label: 'Collectibles', icon: Gem, href: '/collectibles', items: [] };
                }
                mainSections.collectibles.items.push(cat);
            }
        });
        return mainSections;
    }, [categories]);

    const handleLinkClick = (href: string) => {
        router.push(href);
        setIsOpen(false);
    };

    const handleSignOut = async () => {
        await signOutUser();
        setIsOpen(false);
        router.push('/');
    };

    return (
        <ScrollArea className="flex-1 h-[calc(100vh-80px)]">
            <div className="p-4 space-y-4 pb-20">
                {/* Main Actions */}
                <nav className="flex flex-col space-y-1">
                    <Button variant="ghost" className="justify-start text-base" onClick={() => handleLinkClick('/collector-cards')}>
                        <CreditCard className="mr-3 h-5 w-5" /> Cards
                    </Button>
                    <Button variant="ghost" className="justify-start text-base" onClick={() => handleLinkClick('/coins')}>
                        <Coins className="mr-3 h-5 w-5" /> Coins
                    </Button>
                    <Button variant="ghost" className="justify-start text-base" onClick={() => handleLinkClick('/collectibles')}>
                        <Gem className="mr-3 h-5 w-5" /> Memorabilia
                    </Button>
                    <Button variant="ghost" className="justify-start text-base" onClick={() => handleLinkClick('/general')}>
                        <LayoutGrid className="mr-3 h-5 w-5" /> General
                    </Button>
                    <Button variant="ghost" className="justify-start text-base" onClick={() => handleLinkClick('/consign')}>
                        <Tag className="mr-3 h-5 w-5" /> Consign
                    </Button>
                    {user && (
                        <Button variant="ghost" className="justify-start text-base" onClick={() => handleLinkClick('/research')}>
                            <Search className="mr-3 h-5 w-5" /> Research
                        </Button>
                    )}
                </nav>

                {/* Dynamic Categories Accordion */}
                <div className="py-2">
                    <h3 className="px-4 text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2">Categories</h3>
                    <Accordion type="multiple" className="w-full">
                        {Object.entries(groupedCategories).map(([section, data]) => {
                            if (data.items.length === 0) return null;
                            const Icon = data.icon || LayoutGrid;

                            return (
                                <AccordionItem key={section} value={section} className="border-b-0">
                                    <AccordionTrigger className="text-base font-medium px-4 py-2 hover:bg-muted/50 rounded-md hover:no-underline">
                                        <div className="flex items-center">
                                            <Icon className="mr-3 h-5 w-5" />
                                            {data.label}
                                        </div>
                                    </AccordionTrigger>
                                    <AccordionContent>
                                        <div className="flex flex-col pl-8 space-y-1 mt-1">
                                            <Button
                                                variant="ghost"
                                                size="sm"
                                                className="justify-start text-muted-foreground h-9 font-semibold"
                                                onClick={() => handleLinkClick(data.href)}
                                            >
                                                View All {data.label}
                                            </Button>
                                            {data.items.map((cat) => (
                                                <Button
                                                    key={cat.id}
                                                    variant="ghost"
                                                    size="sm"
                                                    className="justify-start text-muted-foreground h-8"
                                                    onClick={() => handleLinkClick(cat.href || `/category/${cat.id}`)}
                                                >
                                                    {cat.name}
                                                </Button>
                                            ))}
                                        </div>
                                    </AccordionContent>
                                </AccordionItem>
                            );
                        })}
                    </Accordion>
                </div>

                {/* User Account Section */}
                <div className="border-t pt-4">
                    {user ? (
                        <>
                            <h3 className="px-4 text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2">My Account</h3>
                            <div className="space-y-1">
                                {isPermissionsLoading ? (
                                    <div className="flex items-center px-4 py-2">
                                        <Skeleton className="mr-3 h-5 w-5 rounded-sm" />
                                        <Skeleton className="h-5 w-32" />
                                    </div>
                                ) : isSuperAdmin ? (
                                    <Button variant="ghost" className="justify-start w-full" onClick={() => handleLinkClick('/admin')}>
                                        <Shield className="mr-3 h-5 w-5 text-primary" /> Admin Dashboard
                                    </Button>
                                ) : null}

                                <Button variant="ghost" className="justify-start w-full" onClick={() => handleLinkClick('/profile')}>
                                    <User className="mr-3 h-5 w-5" /> My Profile
                                </Button>
                                <Button variant="ghost" className="justify-start w-full" onClick={() => handleLinkClick('/profile/favorites')}>
                                    <Heart className="mr-3 h-5 w-5" /> My Favorites
                                </Button>
                                <Button variant="ghost" className="justify-start w-full" onClick={() => handleLinkClick('/profile/listings')}>
                                    <ShoppingBag className="mr-3 h-5 w-5" /> My Listings
                                </Button>
                            </div>

                            <div className="border-t mt-4 pt-4">
                                <Button variant="ghost" className="justify-start w-full text-muted-foreground hover:text-destructive" onClick={handleSignOut}>
                                    <LogOut className="mr-3 h-5 w-5" /> Sign Out
                                </Button>
                            </div>
                        </>
                    ) : null}
                </div>
            </div>
        </ScrollArea>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/NewsletterSignup.tsx
--------------------------------------------------------------------------------

'use client';

import { useFormStatus } from 'react-dom';
import { useActionState, useEffect, useRef } from 'react';
import { subscribeToNewsletter, type NewsletterState } from '@/app/actions/newsletter';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Send, Loader2, Check } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

const initialState: NewsletterState = {
    message: '',
    error: '',
};

function SubmitButton() {
    const { pending } = useFormStatus();
    return (
        <Button size="icon" className="rounded-lg" disabled={pending} type="submit">
            {pending ? <Loader2 className="h-4 w-4 animate-spin" /> : <Send className="h-4 w-4" />}
        </Button>
    );
}

export function NewsletterSignup() {
    const [state, formAction] = useActionState(subscribeToNewsletter, initialState);
    const formRef = useRef<HTMLFormElement>(null);
    const { toast } = useToast();

    useEffect(() => {
        if (state.success) {
            formRef.current?.reset();
            toast({
                title: "Subscribed!",
                description: state.message,
            });
        } else if (state.error) {
            toast({
                title: "Error",
                description: state.error,
                variant: "destructive",
            });
        }
    }, [state, toast]);

    if (state.success) {
         return (
            <div className="flex items-center gap-2 text-green-600 font-medium h-10 p-2 bg-green-50 rounded-lg border border-green-100">
                <Check className="h-4 w-4" />
                <span className="text-sm">Subscribed!</span>
            </div>
        );
    }

    return (
        <form ref={formRef} action={formAction} className="flex gap-2">
            <Input 
                name="email" 
                className="flex-1 rounded-lg border-[#e7ebf3] dark:border-white/10 bg-transparent text-sm" 
                placeholder="Email" 
                type="email" 
                required
            />
            <SubmitButton />
        </form>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/PageHeader.tsx
--------------------------------------------------------------------------------


interface PageHeaderProps {
    title: string;
    description?: string;
}

export function PageHeader({ title, description }: PageHeaderProps) {
    return (
        <div className="mb-6 sm:mb-8">
            <h1 className="text-3xl sm:text-4xl md:text-5xl font-bold tracking-tight text-primary font-headline">
                {title}
            </h1>
            {description && (
                <p className="mt-3 sm:mt-4 text-base sm:text-lg text-muted-foreground max-w-3xl">
                    {description}
                </p>
            )}
        </div>
    )
}


--------------------------------------------------------------------------------
FILE: src/components/layout/collapsible-sidebar-layout.tsx
--------------------------------------------------------------------------------


'use client';

import React, { useState, type ReactNode } from 'react';
import { cn } from '@/lib/utils';
import { useSidebar } from './sidebar-provider';
import { Button } from '@/components/ui/button';
import { PanelLeftClose, PanelRightClose } from 'lucide-react';

function CollapsibleSidebarLayoutInner({ children, sidebar }: { children: ReactNode, sidebar: ReactNode }) {
  const { isSidebarOpen } = useSidebar();

  return (
    <div className="flex min-h-screen w-full">
      <aside
        className={cn(
          'relative bg-card border-r z-40 transition-all duration-300 ease-in-out hidden lg:block',
          isSidebarOpen ? 'w-64' : 'w-20'
        )}
      >
        <div className="flex flex-col h-full overflow-hidden">
          {sidebar}
        </div>
      </aside>

      <div className="flex flex-col flex-1 overflow-auto">
        {children}
      </div>
    </div>
  );
}


export function CollapsibleSidebarLayout({ children, sidebar }: { children: ReactNode, sidebar: ReactNode }) {
    return (
        <CollapsibleSidebarLayoutInner sidebar={sidebar}>
            {children}
        </CollapsibleSidebarLayoutInner>
    )
}


--------------------------------------------------------------------------------
FILE: src/components/layout/main-nav.tsx
--------------------------------------------------------------------------------


"use client"

import { MainNavLinks } from './MainNavLinks';

export function MainNav() {
  return (
    <nav className="hidden md:flex items-center space-x-6 text-sm font-medium">
      <MainNavLinks />
    </nav>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/mobile-nav.tsx
--------------------------------------------------------------------------------


'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Sheet, SheetContent, SheetTrigger } from '@/components/ui/sheet';
import { Menu } from 'lucide-react';
import { Logo } from '@/components/logo';
import { MobileNavContent } from './MobileNavContent';
import Link from 'next/link';

export function MobileNav() {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <Sheet open={isOpen} onOpenChange={setIsOpen}>
      <SheetTrigger asChild>
        <Button variant="ghost" size="icon" className="md:hidden">
          <Menu className="h-6 w-6" />
          <span className="sr-only">Toggle navigation menu</span>
        </Button>
      </SheetTrigger>
      <SheetContent side="left" className="p-0">
        <div className="flex h-full flex-col">
          <div className="border-b p-4">
             <Link href="/" onClick={() => setIsOpen(false)} aria-label="Back to homepage">
              <Logo />
            </Link>
          </div>
          <MobileNavContent setIsOpen={setIsOpen} />
        </div>
      </SheetContent>
    </Sheet>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/page-transition.tsx
--------------------------------------------------------------------------------

'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { usePathname } from 'next/navigation';

export function PageTransition({ children }: { children: React.ReactNode }) {
    const pathname = usePathname();

    return (
        <AnimatePresence mode="wait">
            <motion.div
                key={pathname}
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                transition={{ duration: 0.3, ease: 'easeOut' }}
            >
                {children}
            </motion.div>
        </AnimatePresence>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/search-bar.tsx
--------------------------------------------------------------------------------


'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Input } from '@/components/ui/input';
import { Search } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from '../ui/button';

export function SearchBar({ className, inputClassName, buttonClassName }: { className?: string; inputClassName?: string; buttonClassName?: string; }) {
  const [searchTerm, setSearchTerm] = useState('');
  const router = useRouter();

  const handleSearch = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    if (searchTerm.trim()) {
      router.push(`/browse?q=${encodeURIComponent(searchTerm.trim())}`);
    }
  };

  return (
    <form onSubmit={handleSearch} className={cn("relative w-full", className)}>
      <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-primary" />
      <Input
        type="search"
        placeholder="Find your next holy grail with AI..."
        className={cn("w-full pl-10 bg-[#e7ebf3] dark:bg-white/5 border-transparent focus:bg-white dark:focus:bg-background-dark focus-within:border-primary/50", inputClassName)}
        value={searchTerm}
        onChange={(e) => setSearchTerm(e.target.value)}
      />
       <div className="absolute right-3 top-1/2 -translate-y-1/2 flex items-center">
            <kbd className="hidden sm:inline-flex items-center gap-1 rounded border bg-white dark:bg-white/10 px-1.5 font-mono text-[10px] font-medium text-muted-foreground">
                <span className="text-xs"></span>K
            </kbd>
            {buttonClassName && <Button type="submit" className={buttonClassName}>AI Search</Button>}
        </div>
    </form>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/sidebar-provider.tsx
--------------------------------------------------------------------------------


'use client';

import React, { createContext, useContext, useState, useEffect } from 'react';
import { usePathname } from 'next/navigation';

interface SidebarContextType {
    isSidebarOpen: boolean;
    setIsSidebarOpen: React.Dispatch<React.SetStateAction<boolean>>;
    isHovered: boolean;
    setIsHovered: React.Dispatch<React.SetStateAction<boolean>>;
    isSellingSection: boolean;
    setIsSellingSection: React.Dispatch<React.SetStateAction<boolean>>;
}

const SidebarContext = createContext<SidebarContextType | undefined>(undefined);

export function useSidebar() {
    const context = useContext(SidebarContext);
    if (!context) {
        throw new Error('useSidebar must be used within a SidebarProvider');
    }
    return context;
}

export function SidebarProvider({ children }: { children: React.ReactNode }) {
    const [isSidebarOpen, setIsSidebarOpen] = useState(false);
    const [isHovered, setIsHovered] = useState(false);
    const [isSellingSection, setIsSellingSection] = useState(false);
    
    // This provider will wrap layouts that need a sidebar.
    return (
        <SidebarContext.Provider value={{ 
            isSidebarOpen, 
            setIsSidebarOpen, 
            isHovered, 
            setIsHovered,
            isSellingSection, 
            setIsSellingSection 
        }}>
            {children}
        </SidebarContext.Provider>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/layout/sidebar-toggle.tsx
--------------------------------------------------------------------------------


'use client';

import { Button } from '@/components/ui/button';
import { PanelLeftClose, PanelRightClose } from 'lucide-react';
import { useSidebar } from './sidebar-provider';

export function SidebarToggle() {
    const { isSidebarOpen, setIsSidebarOpen } = useSidebar();
    
    return (
        <Button 
            variant="ghost" 
            size="icon" 
            onClick={() => setIsSidebarOpen(!isSidebarOpen)}
            className="hidden lg:flex"
        >
            {isSidebarOpen ? <PanelLeftClose /> : <PanelRightClose />}
            <span className="sr-only">Toggle sidebar</span>
        </Button>
    )
}


--------------------------------------------------------------------------------
FILE: src/components/layout/user-nav.tsx
--------------------------------------------------------------------------------



"use client";

import Link from 'next/link';
import { useUser, useDoc, useMemoFirebase } from '@/firebase';
import { signOutUser } from '@/lib/firebase/auth';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Skeleton } from '@/components/ui/skeleton';
import { useRouter } from 'next/navigation';
import { Shield, Zap } from 'lucide-react';
import { doc } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import { UserProfile } from '@/lib/types';
import { useUserPermissions } from '@/hooks/use-user-permissions';
import { SUPER_ADMIN_EMAILS, SUPER_ADMIN_UIDS } from '@/lib/constants';


export function UserNav() {
  const { user, isUserLoading } = useUser();
  const { canSell, isSuperAdmin: isClaimSuperAdmin, isLoading: permissionsLoading } = useUserPermissions();
  const isSuperAdmin = isClaimSuperAdmin || (user?.uid && SUPER_ADMIN_UIDS.includes(user.uid)) || (user?.email && SUPER_ADMIN_EMAILS.includes(user.email));
  const router = useRouter();

  const handleSignOut = async () => {
    await signOutUser();
    router.push('/');
    router.refresh();
  };

  if (isUserLoading) {
    return <Skeleton className="h-10 w-10 rounded-full" />;
  }

  if (!user) {
    return null;
  }

  const getInitials = (name?: string | null) => {
    if (!name) return 'U';
    const names = name.split(' ');
    if (names.length > 1) {
      return `${names[0][0]}${names[names.length - 1][0]}`;
    }
    return name[0];
  };

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" className="relative h-10 w-10 rounded-full">
          <Avatar className="h-10 w-10">
            <AvatarImage src={user.photoURL || ''} alt={user.displayName || 'User'} />
            <AvatarFallback>{getInitials(user.displayName)}</AvatarFallback>
          </Avatar>
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent className="w-56" align="end" forceMount>
        <DropdownMenuLabel className="font-normal">
          <div className="flex flex-col space-y-1">
            <p className="text-sm font-medium leading-none">{user.displayName || 'User'}</p>
            <p className="text-xs leading-none text-muted-foreground">{user.email}</p>
          </div>
        </DropdownMenuLabel>
        <DropdownMenuSeparator />
        {isSuperAdmin && (
          <>
            <DropdownMenuItem asChild>
              <Link href="/admin">
                <Shield className="mr-2 h-4 w-4" />
                <span>Admin Dashboard</span>
              </Link>
            </DropdownMenuItem>
            <DropdownMenuItem asChild>
              <Link href="/admin/power-tools">
                <Zap className="mr-2 h-4 w-4" />
                <span>Power Tools</span>
              </Link>
            </DropdownMenuItem>
          </>
        )}
        <DropdownMenuGroup>
          <DropdownMenuItem asChild>
            <Link href="/profile">Profile</Link>
          </DropdownMenuItem>
          {canSell && (
            <DropdownMenuItem asChild>
              <Link href="/sell/dashboard">Seller Dashboard</Link>
            </DropdownMenuItem>
          )}
          <DropdownMenuItem asChild>
            <Link href="/profile/favorites">My Favorites</Link>
          </DropdownMenuItem>
          {canSell && (
            <DropdownMenuItem asChild>
              <Link href="/profile/listings">My Listings</Link>
            </DropdownMenuItem>
          )}
        </DropdownMenuGroup>
        <DropdownMenuSeparator />
        {canSell && (
          <DropdownMenuItem asChild>
            <Link href="/sell/create">Sell Item</Link>
          </DropdownMenuItem>
        )}
        <DropdownMenuSeparator />
        <DropdownMenuItem onClick={handleSignOut}>
          Sign out
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/notifications/NotificationBell.tsx
--------------------------------------------------------------------------------



'use client';

import { useState, useEffect, useTransition, useMemo } from 'react';
import { useUser, useCollection, useMemoFirebase } from '@/firebase';
import { getUserNotifications, markAllAsRead, markAsRead } from '@/services/notifications';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Badge } from '@/components/ui/badge';
import { Bell, Loader2, Check } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { cn } from '@/lib/utils';
import Link from 'next/link';
import { Notification } from '@/lib/types';
import { query, collection, where, orderBy, limit } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';

export function NotificationBell() {
  const { user } = useUser();
  const [isOpen, setIsOpen] = useState(false);
  const [isPending, startTransition] = useTransition();

  const notificationsQuery = useMemoFirebase(() => {
    if (!user?.uid) return null;
    return query(
        collection(db, 'notifications'),
        where('recipientId', '==', user.uid),
        orderBy('createdAt', 'desc'), 
        limit(20)
    );
  }, [user?.uid]);

  const { data: notifications, isLoading } = useCollection<Notification>(notificationsQuery);
  
  const unreadCount = notifications?.filter(n => !n.read).length || 0;

  const handleMarkAllRead = () => {
    if (!user?.uid || unreadCount === 0) return;
    startTransition(async () => {
      await markAllAsRead(user.uid);
    });
  };

  const handleNotificationClick = async (notification: Notification) => {
    if (!notification.read) {
        await markAsRead(notification.id);
    }
    // Note: navigation is handled by the Link component
  };

  return (
    <DropdownMenu open={isOpen} onOpenChange={setIsOpen}>
      <DropdownMenuTrigger asChild>
        <Button
          variant="ghost"
          size="icon"
          className="relative"
          aria-label={`View notifications (${unreadCount} unread)`}
        >
          <Bell className="h-5 w-5" />
          {unreadCount > 0 && (
            <span className="absolute top-1 right-1 flex h-4 w-4 items-center justify-center rounded-full bg-destructive text-xs font-bold text-white">
              {unreadCount}
            </span>
          )}
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent className="w-80 md:w-96" align="end">
        <div className="flex items-center justify-between p-2">
            <DropdownMenuLabel>Notifications</DropdownMenuLabel>
            {unreadCount > 0 && (
                <Button variant="ghost" size="sm" onClick={handleMarkAllRead} disabled={isPending}>
                    {isPending ? <Loader2 className="w-4 h-4 animate-spin"/> : <Check className="w-4 h-4 mr-1" />}
                    Mark all as read
                </Button>
            )}
        </div>
        <DropdownMenuSeparator />
        <ScrollArea className="h-[300px] md:h-[400px]">
          {isLoading && <div className="flex items-center justify-center p-8"><Loader2 className="w-6 h-6 animate-spin text-muted-foreground" /></div>}
          {!isLoading && (!notifications || notifications.length === 0) && (
             <div className="text-center p-8 text-sm text-muted-foreground">
                You have no notifications.
             </div>
          )}
          {notifications && notifications.map((notif) => (
            <DropdownMenuItem key={notif.id} asChild className={cn("flex items-start gap-3 p-3", !notif.read && "bg-primary/5")}>
              <Link href={notif.link || '#'} onClick={() => handleNotificationClick(notif)}>
                 {!notif.read && <div className="w-2 h-2 rounded-full bg-primary mt-1.5 shrink-0"></div>}
                 <div className={cn("flex-1", notif.read && "ml-5")}>
                    <p className="font-semibold text-sm">{notif.title}</p>
                    <p className="text-xs text-muted-foreground">{notif.message}</p>
                    <p className="text-xs text-muted-foreground/80 mt-1">
                        {formatDistanceToNow(notif.createdAt.toDate(), { addSuffix: true })}
                    </p>
                 </div>
              </Link>
            </DropdownMenuItem>
          ))}
        </ScrollArea>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/product/ProductDetails.tsx
--------------------------------------------------------------------------------


'use client';

import { useState, useEffect, useCallback, useMemo, Suspense } from 'react';
import { notFound, useRouter } from 'next/navigation';
import Image from 'next/image';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Skeleton } from '@/components/ui/skeleton';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { useToast } from '@/hooks/use-toast';
import {
    Share2,
    Heart,
    Star,
    ShieldCheck,
    CheckCircle,
    AlertCircle,
    ChevronLeft,
    MessageSquare,
    Eye,
    Calendar,
    ShoppingCart,
    CreditCard,
    Loader2,
    Info as InfoIcon,
    Copyright,
    ChevronRight
} from 'lucide-react';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { cn } from '@/lib/utils';
import { db } from '@/lib/firebase/config';
import { doc, getDoc, collection, query, where, getDocs, limit, addDoc, serverTimestamp, deleteDoc, setDoc, orderBy, updateDoc, increment } from 'firebase/firestore';
import { useCart } from '@/context/CartContext';
import type { Product, Review } from '@/lib/types';
import type { UserProfile } from '@/lib/types';
import { useViewedProducts } from '@/context/ViewedProductsContext';
import { useUser, useCollection, useMemoFirebase, useDoc, useFirebase } from '@/firebase';
import ReviewForm from '@/components/reviews/ReviewForm';
import ReviewList from '@/components/reviews/ReviewList';
import { placeBid, acceptBid } from '@/services/bidding';
import { Input } from '@/components/ui/input';
import { Bid } from '@/lib/types';
import ProductGrid from '@/components/products/ProductGrid';
import ProductGridSkeleton from '@/components/products/ProductGridSkeleton';

// Define types
interface Seller extends UserProfile {
    rating?: number;
    totalSales?: number;
    isVerified?: boolean;
    responseTime?: string;
    joinDate?: string;
    description?: string;
}


// Main product component
export default function ProductDetails({ productId, initialProduct }: { productId: string; initialProduct: Product }) {
    const router = useRouter();
    const { toast } = useToast();
    const { user, isUserLoading } = useUser();
    const { addItem, updateQuantity: updateCartQuantity } = useCart();
    const { markAsViewed } = useViewedProducts();
    
    const [selectedImage, setSelectedImage] = useState(0);
    const [quantity, setQuantity] = useState(1);
    const [seller, setSeller] = useState<Seller | null>(null);
    const [relatedProducts, setRelatedProducts] = useState<Product[]>([]);
    const [loadingRelated, setLoadingRelated] = useState(true);
    
    // Bidding State
    const [bidAmount, setBidAmount] = useState('');
    const [biddingLoading, setBiddingLoading] = useState(false);

    const { firestore } = useFirebase();
    
    const productRef = useMemoFirebase(() => firestore ? doc(db, 'products', productId) : null, [firestore, productId]);
    const { data: product, isLoading: isProductLoading, error: productError } = useDoc<Product>(productRef, {
        initialData: initialProduct,
    });

    const reviewsQuery = useMemoFirebase(() => {
        if (!firestore || !productId) return null;
        return query(
            collection(firestore, 'reviews'),
            where('productId', '==', productId),
            orderBy('createdAt', 'desc')
        );
    }, [firestore, productId]);

    const { data: reviews, isLoading: reviewsLoading } = useCollection<Review>(reviewsQuery);

    const favoriteRef = useMemoFirebase(() => {
        if (!firestore || !user?.uid || !productId) return null;
        return doc(firestore, 'users', user.uid, 'favorites', productId);
    }, [firestore, user?.uid, productId]);

    const { data: favorite } = useDoc(favoriteRef);
    const isFavorited = favorite !== null;

    const toggleFavorite = useCallback(async () => {
        if (!user || !favoriteRef) {
            router.push(`/sign-in?redirect=/product/${productId}`);
            return;
        }
        if (isFavorited) {
            await deleteDoc(favoriteRef);
            toast({ title: "Removed from favorites." });
        } else {
            await setDoc(favoriteRef, {
                productId: productId,
                addedAt: serverTimestamp(),
            });
            toast({ title: "Added to favorites!" });
        }
    }, [user, favoriteRef, isFavorited, productId, router, toast]);


    const handleStartConversation = async () => {
        if (!user || !product || !seller) {
            if (!user) {
                router.push(`/sign-in?redirect=/product/${product?.id}`);
            }
            return;
        }

        if (user.uid === seller.id) {
            toast({ title: "You can't message yourself.", variant: 'destructive' });
            return;
        }

        const conversationQuery = query(
            collection(db, 'conversations'),
            where('participantIds', 'array-contains', user.uid)
        );

        const querySnapshot = await getDocs(conversationQuery);
        let existingConversation: any = null;

        querySnapshot.forEach(doc => {
            const data = doc.data();
            if (data.participantIds.includes(seller.id) && data.productContext?.id === product.id) {
                existingConversation = { id: doc.id, ...data };
            }
        });

        if (existingConversation) {
            router.push(`/messages/${existingConversation.id}`);
        } else {
            const newConversationRef = await addDoc(collection(db, 'conversations'), {
                participantIds: [user.uid, seller.id],
                participants: {
                    [user.uid]: {
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                    },
                    [seller.id]: {
                        displayName: seller.displayName,
                        photoURL: seller.photoURL,
                    }
                },
                lastMessage: {
                    text: `Inquiry about: ${product.title}`,
                    senderId: user.uid,
                    timestamp: serverTimestamp(),
                },
                productContext: {
                    id: product.id,
                    title: product.title,
                    imageUrl: product.imageUrls[0],
                },
                createdAt: serverTimestamp(),
            });
            router.push(`/messages/${newConversationRef.id}`);
        }
    };
    
    // Increment view count
     useEffect(() => {
        if (productId && productRef) {
            const incrementView = async () => {
                await updateDoc(productRef, {
                    views: increment(1)
                });
            };
            incrementView().catch(console.error); // Fire-and-forget
        }
    }, [productId, productRef]);

    useEffect(() => {
        if (product) {
            markAsViewed(productId);
            // Fetch seller and related products
             const fetchExtraData = async () => {
                setLoadingRelated(true);
                if (product.sellerId) {
                    const sellerRef = doc(db, 'users', product.sellerId);
                    const sellerSnap = await getDoc(sellerRef);
                    if (sellerSnap.exists()) {
                        const sellerData = sellerSnap.data() as UserProfile;
                        setSeller({
                            ...sellerData,
                            id: sellerSnap.id,
                            rating: 4.8,
                            totalSales: 150,
                            isVerified: true,
                            joinDate: sellerData.createdAt?.toDate().toLocaleDateString() || new Date().toLocaleDateString(),
                        } as Seller);
                    }
                }

                const relatedQuery = query(
                    collection(db, 'products'),
                    where('category', '==', product.category),
                    where('__name__', '!=', productId),
                    limit(4)
                );
                const relatedSnap = await getDocs(relatedQuery);
                const relatedData = relatedSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })) as Product[];
                setRelatedProducts(relatedData);
                setLoadingRelated(false);
            };

            fetchExtraData();
        }
    }, [product, productId, markAsViewed]);

    useEffect(() => {
        if (productError) {
            toast({
                title: "Error loading product",
                description: productError.message,
                variant: 'destructive',
            })
        }
    }, [productError, toast]);
    
    if (!product && !isProductLoading) {
        notFound();
    }
    
    if (!product) {
        return (
            <div className="container mx-auto px-4 py-8">
                <Skeleton className="h-10 w-24 mb-6" />
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                    <div>
                        <Skeleton className="aspect-square rounded-2xl mb-4" />
                        <div className="flex gap-2">
                            {[...Array(4)].map((_, i) => (
                                <Skeleton key={i} className="w-20 h-20 rounded-lg" />
                            ))}
                        </div>
                    </div>
                    <div className="space-y-6">
                        <div className="space-y-3">
                            <Skeleton className="h-4 w-1/4" />
                            <Skeleton className="h-9 w-3/4" />
                            <Skeleton className="h-10 w-1/3" />
                             <div className="flex gap-4">
                                <Skeleton className="h-5 w-1/4" />
                                <Skeleton className="h-5 w-1/4" />
                            </div>
                            <Skeleton className="h-20 w-full" />
                        </div>
                        <Skeleton className="h-12 w-full" />
                        <div className="flex gap-3">
                             <Skeleton className="h-12 flex-1" />
                             <Skeleton className="h-12 flex-1" />
                        </div>
                        <Skeleton className="h-20 w-full" />
                    </div>
                </div>
            </div>
        );
    }

    const conditionColors: Record<string, string> = {
        'Mint': 'bg-green-100 text-green-800 border-green-200',
        'Near Mint': 'bg-emerald-100 text-emerald-800 border-emerald-200',
        'Excellent': 'bg-blue-100 text-blue-800 border-blue-200',
        'Good': 'bg-yellow-100 text-yellow-800 border-yellow-200',
        'Fair': 'bg-orange-100 text-orange-800 border-orange-200',
        'Poor': 'bg-red-100 text-red-800 border-red-200',
    };

    const handleAddToCart = () => {
        addItem(product);
        updateCartQuantity(product.id, quantity)
    };

    const handleBuyNow = () => {
        handleAddToCart();
        router.push('/checkout');
    };

    const handlePlaceBid = async () => {
        if (!user) {
            router.push(`/sign-in?redirect=/product/${product?.id}`);
            return;
        }
        if (!product || !bidAmount) return;

        try {
            setBiddingLoading(true);
            await placeBid(product.id, user.uid, user.displayName || 'Anonymous', parseFloat(bidAmount));
            toast({
                title: "Bid Placed",
                description: "Your bid has been submitted successfully!",
            });
            setBidAmount('');
        } catch (err: any) {
            toast({
                variant: "destructive",
                title: "Bid Failed",
                description: err.message,
            });
        } finally {
            setBiddingLoading(false);
        }
    };

    const handleAcceptBid = async (bidId: string) => {
        if (!product) return;
        try {
            await acceptBid(product.id, bidId);
            toast({
                title: "Bid Accepted",
                description: "You have accepted the offer!",
            });
        } catch (err: any) {
            toast({
                variant: "destructive",
                title: "Error",
                description: err.message,
            });
        }
    };

    const isCard = product.category === 'Collector Cards';
    const isCoin = product.category === 'Coins';

    return (
        <div className="min-h-screen bg-gray-50">
            <div className="container mx-auto px-4 py-8">
                <Button
                    variant="ghost"
                    onClick={() => router.back()}
                    className="mb-6"
                >
                    <ChevronLeft className="h-4 w-4 mr-2" />
                    Back
                </Button>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                    <div className="space-y-4">
                        <div
                            className={cn(
                                'relative bg-gray-100 border overflow-hidden',
                                isCoin ? 'aspect-square rounded-full' : 'aspect-square rounded-2xl'
                            )}
                        >
                            <Image
                                src={product.imageUrls[selectedImage]}
                                alt={product.title}
                                fill
                                className={cn(
                                    'object-cover',
                                    isCoin ? 'rounded-full' : ''
                                )}
                                sizes="(max-width: 768px) 100vw, 50vw"
                                priority
                            />
                            <div className="absolute top-4 left-4 flex flex-col gap-2">
                                <Badge className={cn("border-none", conditionColors[product.condition as string] || 'bg-gray-100')}>
                                    {product.condition}
                                </Badge>
                                {(product as any).authentication?.isAuthenticated && (
                                    <Badge className="bg-blue-100 text-blue-800 border-blue-200 border-none">
                                        <ShieldCheck className="h-3 w-3 mr-1" />
                                        Authenticated
                                    </Badge>
                                )}
                            </div>
                        </div>

                        {product.imageUrls.length > 1 && (
                            <div className="flex gap-2 overflow-x-auto pb-2">
                                {product.imageUrls.map((url, index) => (
                                    <button
                                        key={index}
                                        onClick={() => setSelectedImage(index)}
                                        className={cn(
                                            "relative w-20 h-20 overflow-hidden flex-shrink-0 border-2 transition-all",
                                            isCoin ? "rounded-full" : "rounded-lg",
                                            selectedImage === index
                                                ? "border-primary ring-2 ring-primary/20"
                                                : "border-transparent hover:border-gray-300"
                                        )}
                                        aria-label={`View image ${index + 1} of ${product.title}`}
                                    >
                                        <Image
                                            src={url}
                                            alt={`${product.title} view ${index + 1}`}
                                            fill
                                            className={cn(
                                                'object-cover',
                                                isCoin ? "rounded-full" : ""
                                            )}
                                        />
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="space-y-6">
                        <div>
                            <div className="flex items-center justify-between mb-2">
                                <Badge variant="outline" className="text-xs">
                                    {product.category} {product.subCategory && `> ${product.subCategory}`}
                                </Badge>
                                <div className="flex items-center gap-2">
                                    <Button
                                        variant="ghost"
                                        size="icon"
                                        onClick={toggleFavorite}
                                        className="h-9 w-9"
                                    >
                                        <Heart className={cn("h-5 w-5", isFavorited && "fill-red-500 text-red-500")} />
                                    </Button>
                                    <Button variant="ghost" size="icon" className="h-9 w-9">
                                        <Share2 className="h-5 w-5" />
                                    </Button>
                                </div>
                            </div>

                            <h1 className="text-3xl font-bold text-gray-900 mb-3">{product.title}</h1>

                            <div className="flex items-center gap-3 mb-4">
                                <div className="text-4xl font-bold text-gray-900">
                                    ${product.price.toFixed(2)}
                                </div>
                            </div>
                            
                             <div className="text-sm text-muted-foreground flex flex-wrap gap-x-4 gap-y-1">
                                {product.year && (
                                    <div className="flex items-center gap-1.5">
                                        <Calendar className="w-4 h-4" />
                                        <span>Year: {product.year}</span>
                                    </div>
                                )}
                                {product.manufacturer && (
                                    <div className="flex items-center gap-1.5">
                                        <Copyright className="w-4 h-4" />
                                        <span>{product.manufacturer}</span>
                                    </div>
                                )}
                                 <div className="flex items-center gap-1.5">
                                    <Eye className="w-4 h-4" />
                                    <span>{(product as any).views || 0} views</span>
                                </div>
                            </div>


                            <p className="text-gray-600 mt-4">{product.description}</p>
                        </div>

                        {(product.quantity && product.quantity > 0) ? (
                            <Alert className="bg-green-50 border-green-200">
                                <CheckCircle className="h-4 w-4 text-green-600" />
                                <AlertDescription className="text-green-800">
                                    <span className="font-semibold">In Stock</span>
                                </AlertDescription>
                            </Alert>
                        ) : (
                            <Alert variant="destructive">
                                <AlertCircle className="h-4 w-4" />
                                <AlertDescription>
                                    <span className="font-semibold">Out of Stock</span>
                                </AlertDescription>
                            </Alert>
                        )}
                        
                        <div className="space-y-4 pt-4 border-t">
                             {(!product.isReverseBidding || user?.uid === product.sellerId) && (
                                <div className="flex flex-col sm:flex-row gap-3">
                                    <Button
                                        size="lg"
                                        className="flex-1"
                                        onClick={handleAddToCart}
                                        disabled={!product.quantity || product.quantity === 0}
                                    >
                                        <ShoppingCart className="h-5 w-5 mr-2" />
                                        Add to Cart
                                    </Button>
                                    <Button
                                        size="lg"
                                        className="flex-1 bg-gradient-to-r from-primary to-primary/80"
                                        onClick={handleBuyNow}
                                        disabled={!product.quantity || product.quantity === 0}
                                    >
                                        <CreditCard className="h-5 w-5 mr-2" />
                                        Buy Now
                                    </Button>
                                </div>
                             )}
                        </div>

                        {product.isReverseBidding && (
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                        <h3 className="font-semibold text-lg">Bids</h3>
                                        <Badge variant="secondary">{product.bids?.length || 0} Bids</Badge>
                                    </div>
                                    {product.bids && product.bids.length > 0 ? (
                                        <div className="space-y-2 border p-3 rounded-lg max-h-60 overflow-y-auto bg-gray-50/50">
                                            {[...product.bids].sort((a, b) => b.amount - a.amount).map((bid) => (
                                                <div key={bid.id} className="flex justify-between items-center p-3 bg-white border rounded shadow-sm">
                                                    <div>
                                                        <div className="font-medium flex items-center gap-2">
                                                            {bid.bidderName}
                                                            {bid.bidderId === user?.uid && <Badge variant="outline" className="text-[10px] h-5">You</Badge>}
                                                        </div>
                                                        <div className="text-gray-500 text-xs mt-0.5">
                                                            {bid.timestamp?.seconds ? new Date(bid.timestamp.seconds * 1000).toLocaleDateString() : 'Just now'}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <span className="font-bold text-lg">${bid.amount.toFixed(2)}</span>
                                                        {user?.uid === product.sellerId && bid.status === 'pending' && (
                                                            <Button size="sm" onClick={() => handleAcceptBid(bid.id)}>Accept</Button>
                                                        )}
                                                        {bid.status === 'accepted' && <Badge className="bg-green-500 hover:bg-green-600">Accepted</Badge>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-center p-6 border-2 border-dashed rounded-lg text-gray-400 bg-gray-50">
                                            <p>No bids yet. Be the first to make an offer!</p>
                                        </div>
                                    )}

                                    {(!user || user.uid !== product.sellerId) ? (
                                        <div className="flex gap-3 pt-2">
                                            <div className="relative flex-1">
                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-semibold">$</span>
                                                <Input
                                                    type="number"
                                                    placeholder="Enter bid"
                                                    className="pl-8 h-12 text-lg"
                                                    value={bidAmount}
                                                    onChange={(e) => setBidAmount(e.target.value)}
                                                />
                                            </div>
                                            <Button
                                                onClick={handlePlaceBid}
                                                disabled={biddingLoading || !bidAmount}
                                                size="lg"
                                                className="px-8"
                                            >
                                                {biddingLoading ? <Loader2 className="animate-spin w-5 h-5" /> : "Place Bid"}
                                            </Button>
                                        </div>
                                    ) : (
                                        <div className="p-4 bg-blue-50 text-blue-800 rounded-lg text-sm border border-blue-100 flex items-center gap-2">
                                            <InfoIcon className="w-4 h-4" />
                                            <span>You are the seller. You can accept offers from the list above.</span>
                                        </div>
                                    )}
                                </div>
                            )}

                        {seller && (
                             <Card>
                                <CardContent className="pt-6">
                                    <div className="flex items-center gap-3 mb-4">
                                        <Avatar className="h-12 w-12 border">
                                            <AvatarImage src={seller.photoURL || ''} />
                                            <AvatarFallback>{seller.displayName?.[0]}</AvatarFallback>
                                        </Avatar>
                                        <div className="flex-1">
                                            <h3 className="font-semibold text-gray-900">{seller.displayName}</h3>
                                            <div className="flex items-center gap-3 mt-1">
                                                <div className="flex items-center gap-1">
                                                    <Star className="h-4 w-4 fill-yellow-400 text-yellow-400" />
                                                    <span className="text-sm font-medium">{seller.rating}</span>
                                                    <span className="text-xs text-gray-500">({seller.totalSales} sales)</span>
                                                </div>
                                            </div>
                                        </div>
                                        <Button variant="outline" size="sm" asChild>
                                            <Link href={`/seller/${product.sellerId}`}>
                                                View Shop <ChevronRight className="w-4 h-4 ml-1" />
                                            </Link>
                                        </Button>
                                    </div>
                                    <Button variant="outline" size="sm" className="w-full" onClick={handleStartConversation}>
                                        <MessageSquare className="h-4 w-4 mr-2" />
                                        Message Seller
                                    </Button>
                                </CardContent>
                            </Card>
                        )}
                    </div>
                </div>

                <div className="lg:col-span-2 mt-12">
                    <Tabs defaultValue="reviews" className="space-y-6">
                        <TabsList className="grid grid-cols-2 w-full max-w-sm">
                            <TabsTrigger value="reviews">Reviews ({reviews?.length || 0})</TabsTrigger>
                            <TabsTrigger value="details">Item Details</TabsTrigger>
                        </TabsList>
                        <TabsContent value="reviews">
                            <Suspense fallback={<Loader2 className="animate-spin" />}>
                                {isUserLoading ? (
                                    <div className="flex justify-center p-8"><Loader2 className="animate-spin" /></div>
                                ) : (
                                    <>
                                        <ReviewForm
                                            user={user as any}
                                            productId={product.id}
                                            productTitle={product.title}
                                            sellerId={product.sellerId}
                                        />
                                        <ReviewList reviews={reviews || []} isLoading={reviewsLoading} />
                                    </>
                                )}
                            </Suspense>
                        </TabsContent>

                        <TabsContent value="details">
                            <Card>
                                <CardContent className="pt-6">
                                    <div className="prose max-w-none text-gray-600">
                                       <p>{product.description}</p>
                                       {/* Additional details would be rendered here */}
                                    </div>
                                </CardContent>
                            </Card>
                        </TabsContent>
                    </Tabs>
                </div>

                {relatedProducts.length > 0 && (
                    <div className="lg:col-span-2 mt-16">
                        <h2 className="text-2xl font-bold text-gray-900 mb-6">Related Collectibles</h2>
                        {loadingRelated ? <ProductGridSkeleton count={4}/> : <ProductGrid products={relatedProducts} />}
                    </div>
                )}
            </div>
        </div>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/products/AICardGrader.tsx
--------------------------------------------------------------------------------


'use client';

import { useState, useTransition } from 'react';
import Image from 'next/image';
import { checkCardCondition } from '@/ai/flows/check-card-condition';
import type { CardConditionOutput } from '@/ai/flows/schemas';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Loader2, Sparkles, CheckCircle2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { suggestListingDetails } from '@/ai/flows/suggest-listing-details';
import type { SuggestListingDetailsOutput } from '@/ai/flows/schemas';

const fileToDataUri = (file: File): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target?.result as string);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
};

interface AICardGraderProps {
  onGradeComplete?: (grade: string) => void;
  onApplySuggestions: (suggestions: SuggestListingDetailsOutput) => void;
  imageFiles: File[];
}

export default function AICardGrader({ onGradeComplete, onApplySuggestions, imageFiles }: AICardGraderProps) {
  const [isPending, startTransition] = useTransition();
  const [result, setResult] = useState<SuggestListingDetailsOutput | null>(null);
  const { toast } = useToast();

  const handleGrade = () => {
    if (imageFiles.length === 0) {
      toast({ title: "Missing Photos", description: "Please upload at least one photo of your card.", variant: "destructive" });
      return;
    }

    startTransition(async () => {
      try {
        const dataUris = await Promise.all(
          imageFiles.map(file => fileToDataUri(file))
        );

        const gradingReport = await suggestListingDetails({
          photoDataUris: dataUris,
        });

        setResult(gradingReport);

        if (gradingReport.condition && onGradeComplete) {
          onGradeComplete(gradingReport.condition);
        }

        toast({ title: "AI Analysis Complete!", description: "Review the suggestions below and apply them to your listing." });

      } catch (error) {
        console.error(error);
        toast({ title: "Grading Failed", description: "Could not analyze images. Please try again.", variant: "destructive" });
      }
    });
  };

  const applySuggestions = () => {
    if (result) {
      onApplySuggestions(result);
    }
  }

  return (
    <div className="w-full mx-auto border border-indigo-100 shadow-xl overflow-hidden rounded-2xl bg-gradient-to-r from-indigo-50 to-white mb-6">
      <div className="p-6">
        <div className="flex items-center gap-2 mb-4">
          <div className="bg-indigo-600 p-2 rounded-lg">
            <Sparkles className="h-5 w-5 text-white" />
          </div>
          <div>
            <h3 className="text-lg font-black text-indigo-950">AI Grade & Suggest</h3>
            <p className="text-sm text-muted-foreground">Get AI-powered condition & listing suggestions.</p>
          </div>
        </div>

        <Button
          size="lg"
          className="w-full h-12 text-md font-bold bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all"
          onClick={handleGrade}
          disabled={isPending || imageFiles.length === 0}
        >
          {isPending ? (
            <><Loader2 className="mr-2 h-5 w-5 animate-spin" />Analyzing...</>
          ) : (
            <><Sparkles className="mr-2 h-5 w-5" />Analyze & Suggest Details</>
          )}
        </Button>

        {result && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 mt-6">
            <div className="space-y-4 bg-slate-50 rounded-2xl p-4 border border-slate-100">
              <div className="flex items-center justify-between border-b border-slate-200 pb-3">
                <span className="text-slate-500 font-bold uppercase text-xs tracking-widest">AI Suggestions</span>
                <Button size="sm" onClick={applySuggestions} className="h-7 rounded-md">Apply All</Button>
              </div>

              <div className="grid gap-2 text-sm">
                <AISuggestion label="Title" value={result.title} />
                <AISuggestion label="Price" value={`$${result.price.toFixed(2)}`} />
                <AISuggestion label="Condition" value={result.condition} />
                <AISuggestion label="Year" value={String(result.year)} />
              </div>

              <div className="flex gap-2 text-xs text-slate-400 pt-2 items-center justify-center">
                <CheckCircle2 className="h-3 w-3" />
                <span>AI Estimation  Review before publishing</span>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function AISuggestion({ label, value }: { label: string, value: string | undefined }) {
  if (!value) return null;
  return (
    <div className="flex justify-between items-center bg-white p-2 rounded-lg border border-slate-100 shadow-sm">
      <h5 className="text-xs font-black text-slate-400 uppercase">{label}</h5>
      <p className="text-xs font-medium text-slate-800 leading-snug text-right">{value}</p>
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/products/BiddingInterface.tsx
--------------------------------------------------------------------------------

'use client';

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Loader2, Info as InfoIcon, Clock, TrendingUp } from 'lucide-react';
import { Bid, Product, SafeUser } from '@/lib/types';
import { useToast } from '@/hooks/use-toast';
import { placeBid, acceptBid } from '@/services/bidding';

interface BiddingInterfaceProps {
    product: Product;
    user: SafeUser;
    onAcceptBid?: (bidId: string) => Promise<void>;
}

export function BiddingInterface({ product, user, onAcceptBid }: BiddingInterfaceProps) {
    const { toast } = useToast();
    const [bidAmount, setBidAmount] = useState('');
    const [loading, setLoading] = useState(false);

    const handlePlaceBid = async () => {
        if (!user) return;
        if (!bidAmount) return;

        try {
            setLoading(true);
            await placeBid(product.id, user.uid, user.displayName || 'Anonymous', parseFloat(bidAmount));
            toast({
                title: "Bid Placed",
                description: "Your offer has been sent to the seller!",
            });
            setBidAmount('');
        } catch (err: any) {
            toast({
                variant: "destructive",
                title: "Offer Failed",
                description: err.message,
            });
        } finally {
            setLoading(false);
        }
    };

    const isSeller = user?.uid === product.sellerId;
    const sortedBids = [...(product.bids || [])].sort((a, b) => b.amount - a.amount);

    return (
        <div className="space-y-6">
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                    <h3 className="font-black text-xl tracking-tight">Active Offers</h3>
                    <Badge variant="secondary" className="rounded-full px-3">{product.bids?.length || 0}</Badge>
                </div>
                {product.bids && product.bids.length > 0 && (
                    <div className="flex items-center gap-1 text-[10px] font-bold text-orange-500 animate-pulse">
                        <Clock className="h-3 w-3" />
                        <span>LIVE UPDATES</span>
                    </div>
                )}
            </div>

            <div className="space-y-3">
                <AnimatePresence initial={false}>
                    {sortedBids.length > 0 ? (
                        sortedBids.map((bid, index) => (
                            <motion.div
                                key={bid.id}
                                initial={{ opacity: 0, x: -20 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, scale: 0.95 }}
                                transition={{ delay: index * 0.05 }}
                                className={`flex justify-between items-center p-4 rounded-2xl border transition-all ${bid.status === 'accepted'
                                        ? 'bg-green-50 border-green-200'
                                        : 'bg-white/50 border-white/60 hover:border-indigo-200 shadow-sm'
                                    }`}
                            >
                                <div className="flex flex-col">
                                    <div className="font-bold flex items-center gap-2 text-sm">
                                        {bid.bidderName}
                                        {bid.bidderId === user?.uid && (
                                            <Badge variant="outline" className="text-[9px] h-4 px-1.5 uppercase font-black bg-indigo-50 text-indigo-600 border-indigo-100">You</Badge>
                                        )}
                                    </div>
                                    <div className="text-[10px] text-muted-foreground font-medium mt-0.5">
                                        {bid.timestamp?.seconds ? new Date(bid.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Recently'}
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="flex flex-col items-end">
                                        <span className="font-black text-lg text-indigo-600">${bid.amount.toLocaleString()}</span>
                                        {index === 0 && bid.status === 'pending' && (
                                            <span className="text-[9px] font-bold text-orange-500 uppercase">Highest Offer</span>
                                        )}
                                    </div>
                                    {isSeller && bid.status === 'pending' && (
                                        <Button
                                            size="sm"
                                            onClick={() => onAcceptBid?.(bid.id)}
                                            className="rounded-full bg-indigo-600 hover:bg-indigo-700 h-8 px-4 text-xs font-bold"
                                        >
                                            Accept
                                        </Button>
                                    )}
                                    {bid.status === 'accepted' && (
                                        <Badge className="bg-green-500 text-white border-none text-[10px] font-black h-6 px-3">ACCEPTED</Badge>
                                    )}
                                </div>
                            </motion.div>
                        ))
                    ) : (
                        <motion.div
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            className="text-center p-10 border-2 border-dashed rounded-3xl text-muted-foreground bg-white/20 border-white/40"
                        >
                            <TrendingUp className="h-8 w-8 mx-auto mb-3 opacity-20" />
                            <p className="font-bold text-sm">No offers yet.</p>
                            <p className="text-xs">Be the first to secure this item!</p>
                        </motion.div>
                    )}
                </AnimatePresence>
            </div>

            {!isSeller && product.status !== 'sold' && (
                <div className="p-6 rounded-3xl bg-indigo-600 shadow-xl shadow-indigo-500/20 text-white">
                    <div className="flex items-center gap-2 mb-4">
                        <TrendingUp className="h-4 w-4" />
                        <span className="text-xs font-black uppercase tracking-widest">Place Your Offer</span>
                    </div>
                    <div className="flex gap-3">
                        <div className="relative flex-1">
                            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-white/60 font-black">$</span>
                            <Input
                                type="number"
                                placeholder="0.00"
                                className="pl-10 h-14 bg-white/10 border-white/20 text-white placeholder:text-white/40 text-xl font-black rounded-2xl focus-visible:ring-white/30"
                                value={bidAmount}
                                onChange={(e) => setBidAmount(e.target.value)}
                            />
                        </div>
                        <Button
                            onClick={handlePlaceBid}
                            disabled={loading || !bidAmount}
                            className="h-14 px-8 bg-white text-indigo-600 hover:bg-white/90 rounded-2xl font-black text-sm transition-transform active:scale-95"
                        >
                            {loading ? <Loader2 className="animate-spin w-5 h-5" /> : "SEND OFFER"}
                        </Button>
                    </div>
                    <p className="text-[10px] font-bold text-white/50 mt-4 flex items-center gap-1.5 uppercase tracking-tighter">
                        <InfoIcon className="h-3 w-3" />
                        Offers are binding. Seller will be notified immediately.
                    </p>
                </div>
            )}

            {isSeller && (
                <div className="p-4 rounded-2xl bg-indigo-50 border border-indigo-100 flex items-center gap-3">
                    <div className="bg-indigo-600 p-2 rounded-xl text-white">
                        <InfoIcon className="h-4 w-4" />
                    </div>
                    <div className="text-xs font-bold text-indigo-900 leading-tight">
                        You are the seller. You can accept any offer above to finalize the sale instantly.
                    </div>
                </div>
            )}
        </div>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/products/EnhancedAICardGrader.tsx
--------------------------------------------------------------------------------

'use client';

import { useState } from 'react';
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Loader2, Sparkles, CheckCircle2, ShieldCheck, TrendingUp, AlertCircle, Image as ImageIcon } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { gradeCardDetailsAction } from '@/app/actions/ai-grading';
import { suggestListingDetailsAction } from '@/app/actions/ai-grading';
import type { GradeCardDetailsOutput } from '@/ai/schemas/grading-schemas';
import type { SuggestListingDetailsOutput } from '@/ai/flows/suggest-listing-details';
import { useUser } from '@/firebase';
import { uploadImages } from '@/lib/firebase/storage';

const fileToDataUri = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target?.result as string);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
};

interface EnhancedAICardGraderProps {
    onGradeComplete?: (grade: string) => void;
    onApplySuggestions: (suggestions: SuggestListingDetailsOutput) => void;
    imageFiles: File[];
}

export default function EnhancedAICardGrader({ onGradeComplete, onApplySuggestions, imageFiles }: EnhancedAICardGraderProps) {
    const [isGrading, setIsGrading] = useState(false);
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [gradingResult, setGradingResult] = useState<GradeCardDetailsOutput | null>(null);
    const [listingResult, setListingResult] = useState<SuggestListingDetailsOutput | null>(null);
    const { toast } = useToast();
    const { user } = useUser();

    const getGradeColor = (grade: number) => {
        if (grade >= 9) return 'text-emerald-600 bg-emerald-50 border-emerald-200';
        if (grade >= 7) return 'text-blue-600 bg-blue-50 border-blue-200';
        if (grade >= 5) return 'text-amber-600 bg-amber-50 border-amber-200';
        return 'text-rose-600 bg-rose-50 border-rose-200';
    };

    const getScoreColor = (score: number) => {
        if (score >= 9) return 'text-emerald-600';
        if (score >= 7) return 'text-blue-600';
        if (score >= 5) return 'text-amber-600';
        return 'text-rose-600';
    };

    const handleDetailedGrading = async () => {
        if (imageFiles.length === 0) {
            toast({
                title: "No Images",
                description: "Please upload at least the front of your card for grading.",
                variant: "destructive"
            });
            return;
        }

        setIsGrading(true);
        try {
            if (!user) {
                throw new Error("You must be logged in to grade cards.");
            }

            // 1. Get ID Token
            const token = await user.getIdToken();

            // 2. Upload Images to Storage (Solves Payload Limit)
            const uploadPath = `grading-temp/${user.uid}`;
            const uploadedUrls = await uploadImages(imageFiles.slice(0, 2), uploadPath);

            const frontImage = uploadedUrls[0];
            const backImage = uploadedUrls[1]; // undefined if only 1 uploaded

            // 3. Call AI Action with URLs and Token
            const result = await gradeCardDetailsAction({
                frontImageDataUri: frontImage,
                backImageDataUri: backImage,
                idToken: token
            });

            setGradingResult(result);

            if (result.condition && onGradeComplete) {
                onGradeComplete(result.condition);
            }

            toast({
                title: "Grading Complete!",
                description: `Overall Grade: ${result.overallGrade}/10 (${result.condition})`
            });

        } catch (error: any) {
            console.error('Grading error:', error);
            toast({
                title: "Grading Failed",
                description: error.message || "Could not analyze card. Please try again.",
                variant: "destructive"
            });
        } finally {
            setIsGrading(false);
        }
    };

    const handleQuickAnalysis = async () => {
        if (imageFiles.length === 0) {
            toast({
                title: "No Images",
                description: "Please upload at least one photo of your card.",
                variant: "destructive"
            });
            return;
        }

        setIsAnalyzing(true);
        try {
            if (!user) {
                throw new Error("You must be logged in to analyze cards.");
            }

            // 1. Get ID Token
            const token = await user.getIdToken();

            // 2. Upload Images
            const uploadPath = `grading-temp/${user.uid}`;
            const uploadedUrls = await uploadImages(imageFiles.slice(0, 3), uploadPath);

            // 3. Call AI Action
            const result = await suggestListingDetailsAction({
                photoDataUris: uploadedUrls,
                idToken: token
            });

            setListingResult(result);

            toast({
                title: "Analysis Complete!",
                description: "AI suggestions are ready to apply."
            });

        } catch (error: any) {
            console.error('Analysis error:', error);
            toast({
                title: "Analysis Failed",
                description: error.message || "Could not analyze images. Please try again.",
                variant: "destructive"
            });
        } finally {
            setIsAnalyzing(false);
        }
    };

    const applySuggestions = () => {
        if (listingResult) {
            onApplySuggestions(listingResult);
            toast({ title: "Suggestions Applied!" });
        }
    };

    return (
        <Card className="overflow-hidden border-2 border-indigo-100 shadow-xl bg-gradient-to-br from-indigo-50 via-white to-purple-50">
            <CardHeader className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                <div className="flex items-center gap-3">
                    <div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                        <ShieldCheck className="h-6 w-6" />
                    </div>
                    <div>
                        <CardTitle className="text-xl font-black">AI Card Analysis Lab</CardTitle>
                        <CardDescription className="text-indigo-100">
                            Professional-grade analysis with detailed grading
                        </CardDescription>
                    </div>
                </div>
            </CardHeader>

            <CardContent className="p-6 space-y-6">
                {/* Action Buttons */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <Button
                        size="lg"
                        className="h-14 text-md font-bold bg-indigo-600 hover:bg-indigo-700 shadow-lg transition-all"
                        onClick={handleDetailedGrading}
                        disabled={isGrading || imageFiles.length === 0}
                    >
                        {isGrading ? (
                            <><Loader2 className="mr-2 h-5 w-5 animate-spin" />Grading Card...</>
                        ) : (
                            <><ShieldCheck className="mr-2 h-5 w-5" />Detailed Grading</>
                        )}
                    </Button>

                    <Button
                        size="lg"
                        variant="outline"
                        className="h-14 text-md font-bold border-2 border-purple-200 hover:bg-purple-50 transition-all"
                        onClick={handleQuickAnalysis}
                        disabled={isAnalyzing || imageFiles.length === 0}
                    >
                        {isAnalyzing ? (
                            <><Loader2 className="mr-2 h-5 w-5 animate-spin" />Analyzing...</>
                        ) : (
                            <><Sparkles className="mr-2 h-5 w-5 text-purple-600" />Quick Analysis</>
                        )}
                    </Button>
                </div>

                {/* Image Upload Guidance */}
                {imageFiles.length === 0 && (
                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 flex items-start gap-3">
                        <AlertCircle className="h-5 w-5 text-amber-600 mt-0.5 flex-shrink-0" />
                        <div className="text-sm">
                            <p className="font-semibold text-amber-900">Upload card images first</p>
                            <p className="text-amber-700 mt-1">For best results, upload front and back images of your card.</p>
                        </div>
                    </div>
                )}

                {imageFiles.length === 1 && (
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start gap-3">
                        <ImageIcon className="h-5 w-5 text-blue-600 mt-0.5 flex-shrink-0" />
                        <div className="text-sm">
                            <p className="font-semibold text-blue-900">Add back image for complete analysis</p>
                            <p className="text-blue-700 mt-1">Upload a second image of the card back for full grading accuracy.</p>
                        </div>
                    </div>
                )}

                {/* Grading Results */}
                {gradingResult && (
                    <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-4">
                        {/* Overall Grade */}
                        <div className={cn(
                            "rounded-xl p-6 border-2 text-center",
                            getGradeColor(gradingResult.overallGrade)
                        )}>
                            <div className="text-6xl font-black mb-2">{gradingResult.overallGrade}<span className="text-3xl">/10</span></div>
                            <div className="text-xl font-bold mb-2">{gradingResult.condition}</div>
                            <Badge variant="outline" className="text-sm">Overall Grade</Badge>
                        </div>

                        {/* Tabbed Analysis */}
                        <Tabs defaultValue="front" className="w-full">
                            <TabsList className="grid w-full grid-cols-3">
                                <TabsTrigger value="front">Front</TabsTrigger>
                                <TabsTrigger value="back">Back</TabsTrigger>
                                <TabsTrigger value="summary">Summary</TabsTrigger>
                            </TabsList>

                            <TabsContent value="front" className="space-y-4 mt-4">
                                <GradingSection title="Corners" score={gradingResult.frontAnalysis.corners.score}>
                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                        <div><span className="font-semibold">Top Left:</span> {gradingResult.frontAnalysis.corners.topLeft}</div>
                                        <div><span className="font-semibold">Top Right:</span> {gradingResult.frontAnalysis.corners.topRight}</div>
                                        <div><span className="font-semibold">Bottom Left:</span> {gradingResult.frontAnalysis.corners.bottomLeft}</div>
                                        <div><span className="font-semibold">Bottom Right:</span> {gradingResult.frontAnalysis.corners.bottomRight}</div>
                                    </div>
                                    <p className="text-sm text-muted-foreground mt-2">{gradingResult.frontAnalysis.corners.notes}</p>
                                </GradingSection>

                                <GradingSection title="Centering" score={gradingResult.frontAnalysis.centering.score}>
                                    <div className="text-sm space-y-1">
                                        <div><span className="font-semibold">Left/Right:</span> {gradingResult.frontAnalysis.centering.leftRight}</div>
                                        <div><span className="font-semibold">Top/Bottom:</span> {gradingResult.frontAnalysis.centering.topBottom}</div>
                                        <p className="text-muted-foreground mt-2">{gradingResult.frontAnalysis.centering.notes}</p>
                                    </div>
                                </GradingSection>

                                <GradingSection title="Edges" score={gradingResult.frontAnalysis.edges.score}>
                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                        <div><span className="font-semibold">Top:</span> {gradingResult.frontAnalysis.edges.top}</div>
                                        <div><span className="font-semibold">Right:</span> {gradingResult.frontAnalysis.edges.right}</div>
                                        <div><span className="font-semibold">Bottom:</span> {gradingResult.frontAnalysis.edges.bottom}</div>
                                        <div><span className="font-semibold">Left:</span> {gradingResult.frontAnalysis.edges.left}</div>
                                    </div>
                                    <p className="text-sm text-muted-foreground mt-2">{gradingResult.frontAnalysis.edges.notes}</p>
                                </GradingSection>

                                <GradingSection title="Surface" score={gradingResult.frontAnalysis.surface.score}>
                                    <div className="text-sm space-y-1">
                                        <div><span className="font-semibold">Scratches:</span> {gradingResult.frontAnalysis.surface.scratches ? 'Present' : 'None detected'}</div>
                                        <div><span className="font-semibold">Print Lines:</span> {gradingResult.frontAnalysis.surface.printLines ? 'Visible' : 'None detected'}</div>
                                        <p className="text-muted-foreground mt-2">{gradingResult.frontAnalysis.surface.notes}</p>
                                    </div>
                                </GradingSection>
                            </TabsContent>

                            <TabsContent value="back" className="space-y-4 mt-4">
                                <GradingSection title="Corners" score={gradingResult.backAnalysis.corners.score}>
                                    <p className="text-sm text-muted-foreground">{gradingResult.backAnalysis.corners.notes}</p>
                                </GradingSection>

                                <GradingSection title="Centering" score={gradingResult.backAnalysis.centering.score}>
                                    <p className="text-sm text-muted-foreground">{gradingResult.backAnalysis.centering.notes}</p>
                                </GradingSection>

                                <GradingSection title="Edges" score={gradingResult.backAnalysis.edges.score}>
                                    <p className="text-sm text-muted-foreground">{gradingResult.backAnalysis.edges.notes}</p>
                                </GradingSection>

                                <GradingSection title="Surface" score={gradingResult.backAnalysis.surface.score}>
                                    <p className="text-sm text-muted-foreground">{gradingResult.backAnalysis.surface.notes}</p>
                                </GradingSection>
                            </TabsContent>

                            <TabsContent value="summary" className="space-y-4 mt-4">
                                {/* Strengths */}
                                <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                                    <h4 className="font-bold text-emerald-900 mb-2 flex items-center gap-2">
                                        <CheckCircle2 className="h-4 w-4" />
                                        Strengths
                                    </h4>
                                    <ul className="space-y-1">
                                        {gradingResult.strengths.map((strength, idx) => (
                                            <li key={idx} className="text-sm text-emerald-800"> {strength}</li>
                                        ))}
                                    </ul>
                                </div>

                                {/* Weaknesses */}
                                <div className="bg-rose-50 border border-rose-200 rounded-lg p-4">
                                    <h4 className="font-bold text-rose-900 mb-2 flex items-center gap-2">
                                        <AlertCircle className="h-4 w-4" />
                                        Weaknesses
                                    </h4>
                                    <ul className="space-y-1">
                                        {gradingResult.weaknesses.map((weakness, idx) => (
                                            <li key={idx} className="text-sm text-rose-800"> {weakness}</li>
                                        ))}
                                    </ul>
                                </div>

                                {/* Recommendations */}
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 className="font-bold text-blue-900 mb-2">Recommendations</h4>
                                    <p className="text-sm text-blue-800">{gradingResult.recommendations}</p>
                                </div>

                                {/* Estimated Value */}
                                <div className="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-lg p-4">
                                    <h4 className="font-bold text-amber-900 mb-2 flex items-center gap-2">
                                        <TrendingUp className="h-4 w-4" />
                                        Estimated Value
                                    </h4>
                                    <div className="text-2xl font-black text-amber-900 mb-1">
                                        ${gradingResult.estimatedValue.min.toFixed(2)} - ${gradingResult.estimatedValue.max.toFixed(2)} AUD
                                    </div>
                                    <p className="text-sm text-amber-800">{gradingResult.estimatedValue.notes}</p>
                                </div>
                            </TabsContent>
                        </Tabs>
                    </div>
                )}

                {/* Listing Analysis Results */}
                {listingResult && (
                    <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div className="bg-slate-50 rounded-xl p-4 border border-slate-200 space-y-3">
                            <div className="flex items-center justify-between border-b border-slate-300 pb-3">
                                <span className="text-slate-600 font-bold uppercase text-xs tracking-widest">Quick Analysis</span>
                                <Button size="sm" onClick={applySuggestions} className="h-8">
                                    Apply All
                                </Button>
                            </div>

                            <div className="grid gap-2">
                                <SuggestionRow label="Title" value={listingResult.title} />
                                <SuggestionRow label="Price" value={`$${listingResult.price.toFixed(2)} AUD`} />
                                <SuggestionRow label="Condition" value={listingResult.condition} />
                                <SuggestionRow label="Category" value={listingResult.category} />
                                {listingResult.year && <SuggestionRow label="Year" value={String(listingResult.year)} />}
                                {listingResult.manufacturer && <SuggestionRow label="Manufacturer" value={listingResult.manufacturer} />}
                            </div>

                            <div className="flex gap-2 text-xs text-slate-500 pt-2 items-center justify-center">
                                <CheckCircle2 className="h-3 w-3" />
                                <span>AI Estimation  Review before publishing</span>
                            </div>
                        </div>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}

function GradingSection({ title, score, children }: { title: string; score: number; children: React.ReactNode }) {
    const getScoreColor = (score: number) => {
        if (score >= 9) return 'text-emerald-600 bg-emerald-50';
        if (score >= 7) return 'text-blue-600 bg-blue-50';
        if (score >= 5) return 'text-amber-600 bg-amber-50';
        return 'text-rose-600 bg-rose-50';
    };

    return (
        <div className="bg-white rounded-lg border border-slate-200 p-4">
            <div className="flex items-center justify-between mb-3">
                <h4 className="font-bold text-slate-900">{title}</h4>
                <Badge className={cn("font-bold", getScoreColor(score))}>
                    {score}/10
                </Badge>
            </div>
            {children}
        </div>
    );
}

function SuggestionRow({ label, value }: { label: string; value: string | undefined }) {
    if (!value) return null;
    return (
        <div className="flex justify-between items-center bg-white p-3 rounded-lg border border-slate-100 shadow-sm">
            <h5 className="text-xs font-bold text-slate-500 uppercase">{label}</h5>
            <p className="text-sm font-semibold text-slate-900">{value}</p>
        </div>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/products/InfiniteProductGrid.tsx
--------------------------------------------------------------------------------

'use client';

import React, { useState, useMemo, useCallback, useRef, useEffect, Suspense } from 'react';
import { useSearchParams, useRouter, usePathname } from 'next/navigation';
import { getProducts } from '@/services/product-service';
import type { Product, ProductSearchParams, UserProfile } from '@/lib/types';
import ProductCard from '@/components/products/ProductCard';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { LayoutGrid, List, Loader2, Filter, Grid } from 'lucide-react';
import { PageHeader } from '../layout/PageHeader';
import { CollectorCardsFilterTrigger } from '../filters/collector-cards-filter-trigger';
import AdvancedFilterPanel from '../filters/AdvancedFilterPanel';
import { useUser, useCollection, useMemoFirebase } from '@/firebase';
import { collection, query, where } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import { motion } from 'framer-motion';
import MontageGrid from './MontageGrid';
import Image from 'next/image';
import Link from 'next/link';

type ViewMode = 'grid' | 'list' | 'montage';
const PAGE_SIZE = 24;

const CONDITION_OPTIONS = ['Mint', 'Near Mint', 'Excellent', 'Good', 'Fair', 'Poor'];


function InfiniteProductGridInner({ pageTitle, pageDescription, initialFilterState = {} }: { pageTitle: string, pageDescription?: string, initialFilterState?: Partial<ProductSearchParams> }) {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  const [products, setProducts] = useState<Product[]>([]);

  const loadingRef = useRef(false);
  const hasMoreRef = useRef(true);
  const pageRef = useRef(0);

  const [loading, setLoading] = useState(true);
  const [hasMore, setHasMore] = useState(true);

  const observer = useRef<IntersectionObserver>();

  const currentSearchParams = useMemo(() => {
    const params: ProductSearchParams = { ...initialFilterState };
    searchParams.forEach((value, key) => {
      if (key === 'priceRange' || key === 'yearRange') {
        params[key] = value.split(',').map(Number) as [number, number];
      } else if (key === 'conditions' || key === 'sellers' || key === 'categories') {
        params[key] = value.split(',');
      } else {
        params[key] = value;
      }
    });
    return params;
  }, [searchParams, initialFilterState]);

  // Filter specific states, derived from URL
  const viewMode = (currentSearchParams.view as ViewMode) || 'grid';
  const sortOrder = currentSearchParams.sort || 'createdAt-desc';
  const priceRange = currentSearchParams.priceRange || [0, 5000];
  const selectedConditions = useMemo(() => currentSearchParams.conditions || [], [currentSearchParams.conditions]);
  const selectedSellers = useMemo(() => currentSearchParams.sellers || [], [currentSearchParams.sellers]);

  const [postcode, setPostcode] = useState<string>("");
  const [isExclusionMode, setIsExclusionMode] = useState<boolean>(false);

  const { user } = useUser();

  const usersQuery = useMemoFirebase(() => {
    // Only query users if authenticated to avoid permission errors
    if (!user) return null;
    return query(collection(db, 'users'), where('accountType', '==', 'seller'));
  }, [user]);
  const { data: fetchedUsers } = useCollection<UserProfile>(usersQuery);

  const availableSellers = useMemo(() => {
    if (!fetchedUsers) return [];
    return fetchedUsers as unknown as UserProfile[];
  }, [fetchedUsers]);


  const createQueryString = useCallback(
    (newParams: Record<string, string | string[] | [number, number] | null>) => {
      const params = new URLSearchParams(searchParams.toString());
      for (const [key, value] of Object.entries(newParams)) {
        if (value && Array.isArray(value) && value.length > 0) {
          params.set(key, value.join(','));
        } else if (value && !Array.isArray(value)) {
          params.set(key, String(value));
        } else {
          params.delete(key);
        }
      }
      return params.toString();
    },
    [searchParams]
  );

  const handleFilterChange = useCallback((key: string, value: string | string[] | [number, number] | null) => {
    const newQuery = createQueryString({ [key]: value, page: null });
    router.push(`${pathname}?${newQuery}`, { scroll: false });
  }, [createQueryString, pathname, router]);

  const handleViewChange = (mode: ViewMode) => {
    handleFilterChange('view', mode);
  };

  const loadMoreProducts = useCallback(async () => {
    if (loadingRef.current || !hasMoreRef.current) return;

    loadingRef.current = true;
    setLoading(true);

    pageRef.current += 1;

    try {
      const { products: newProducts, hasMore: newHasMore } = await getProducts({
        ...currentSearchParams,
        page: pageRef.current,
        limit: PAGE_SIZE,
      });

      setProducts(prev => {
        if (pageRef.current === 1) return newProducts;
        const uniqueIds = new Set(prev.map(p => p.id));
        const filteredNewProducts = newProducts.filter(p => !uniqueIds.has(p.id));
        return [...prev, ...filteredNewProducts];
      });

      hasMoreRef.current = newHasMore;
      setHasMore(newHasMore);

    } catch (error) {
      console.error("Failed to load products:", error);
    } finally {
      loadingRef.current = false;
      setLoading(false);
    }
  }, [currentSearchParams]);

  useEffect(() => {
    pageRef.current = 0;
    setProducts([]);
    hasMoreRef.current = true;
    setHasMore(true);
    loadingRef.current = false;
    setLoading(true);
    loadMoreProducts();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchParams]);


  const lastProductElementRef = useCallback((node: HTMLDivElement) => {
    if (loadingRef.current) return;
    if (observer.current) observer.current.disconnect();

    observer.current = new IntersectionObserver(entries => {
      if (entries[0].isIntersecting && hasMoreRef.current) {
        loadMoreProducts();
      }
    });

    if (node) observer.current.observe(node);
  }, [loadMoreProducts]);

  const renderProducts = () => {
    if (products.length === 0 && loading) {
      return (
        <div className="grid grid-cols-[repeat(auto-fill,minmax(220px,1fr))] gap-x-6 gap-y-8">
          {[...Array(18)].map((_, i) => (
            <div key={i} className="space-y-2">
              <div className="bg-muted aspect-[5/7] rounded-lg shimmer" />
              <div className="space-y-2">
                <div className="h-4 bg-muted rounded w-3/4 shimmer" />
                <div className="h-5 bg-muted rounded w-1/2 shimmer" />
              </div>
            </div>
          ))}
        </div>
      )
    }

    if (products.length === 0 && !loading) {
      return (
        <p className="col-span-full text-center text-muted-foreground py-12">
          No products found matching your criteria.
        </p>
      );
    }

    if (viewMode === 'list') {
      return (
        <div className="space-y-4">
          {products.map((product, index) => {
            const isLastElement = index === products.length - 1;
            return <motion.div
              layout
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.3 }}
              ref={isLastElement ? lastProductElementRef : null}
              key={`${product.id}-${index}`}>
              <ProductCard product={product} viewMode={viewMode} />
            </motion.div>
          })}
        </div>
      );
    }

    if (viewMode === 'montage') {
      return <MontageGrid products={products} lastProductRef={lastProductElementRef} />;
    }


    return (
      <motion.div layout className="grid grid-cols-[repeat(auto-fill,minmax(220px,1fr))] gap-x-6 gap-y-8">
        {products.map((product, index) => {
          const isLastElement = index === products.length - 1;
          return <motion.div
            layout
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
            transition={{ duration: 0.3, delay: (index % PAGE_SIZE) * 0.05 }}
            ref={isLastElement ? lastProductElementRef : null}
            key={`${product.id}-${index}`}>
            <ProductCard product={product} viewMode={viewMode} />
          </motion.div>
        })}
      </motion.div>
    );
  };

  const handleConditionSelection = useCallback((c: string) => {
    const newConditions = selectedConditions.includes(c)
      ? selectedConditions.filter(sc => sc !== c)
      : [...selectedConditions, c];
    handleFilterChange('conditions', newConditions.length > 0 ? newConditions : null);
  }, [selectedConditions, handleFilterChange]);

  const handleSellerSelection = useCallback((sellerId: string) => {
    const newSellers = selectedSellers.includes(sellerId)
      ? selectedSellers.filter(id => id !== sellerId)
      : [...selectedSellers, sellerId];
    handleFilterChange('sellers', newSellers.length > 0 ? newSellers : null);
  }, [selectedSellers, handleFilterChange]);

  return (
    <div className="container mx-auto max-w-screen-2xl px-4 py-8 min-h-screen">
      <header className="flex flex-col sm:flex-row justify-between items-start gap-4 mb-8">
        <div>
          <PageHeader title={pageTitle} description={pageDescription} />
        </div>
        <div className="flex items-center gap-2 self-end sm:self-auto flex-shrink-0">
          <Select value={sortOrder} onValueChange={(v) => handleFilterChange('sort', v)}>
            <SelectTrigger className="w-[180px] h-10 hidden sm:flex">
              <SelectValue placeholder="Sort by" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="createdAt-desc">Newest</SelectItem>
              <SelectItem value="price-asc">Price: Low to High</SelectItem>
              <SelectItem value="price-desc">Price: High to Low</SelectItem>
            </SelectContent>
          </Select>

          <div className="hidden sm:flex items-center rounded-md border bg-card p-1 h-10">
            <Button variant={viewMode === 'grid' ? 'secondary' : 'ghost'} size="icon" className="h-8 w-8" onClick={() => handleViewChange('grid')}><LayoutGrid /></Button>
            <Button variant={viewMode === 'list' ? 'secondary' : 'ghost'} size="icon" className="h-8 w-8" onClick={() => handleViewChange('list')}><List /></Button>
            <Button variant={viewMode === 'montage' ? 'secondary' : 'ghost'} size="icon" className="h-8 w-8" onClick={() => handleViewChange('montage')}><Grid /></Button>
          </div>
          <AdvancedFilterPanel
            currentFilters={currentSearchParams}
            onFilterChange={(newFilters) => {
              const newQuery = createQueryString(newFilters);
              router.push(`${pathname}?${newQuery}`, { scroll: false });
            }}
            onClearFilters={() => router.push(pathname, { scroll: false })}
          />
        </div>
      </header>

      {renderProducts()}

      {loading && products.length > 0 && (
        <div className="flex justify-center mt-8">
          <Loader2 className="animate-spin" />
        </div>
      )}

      {!hasMore && products.length > 0 && (
        <div className="py-12 text-center text-muted-foreground">
          <p>You&apos;ve reached the end of the list.</p>
        </div>
      )}
    </div>
  );
}

export default function InfiniteProductGrid(props: { pageTitle: string, pageDescription?: string, initialFilterState?: Partial<ProductSearchParams> }) {
  return (
    <Suspense fallback={<div className="flex h-screen w-full items-center justify-center"><Loader2 className="h-12 w-12 animate-spin" /></div>}>
      <InfiniteProductGridInner {...props} />
    </Suspense>
  )
}


--------------------------------------------------------------------------------
FILE: src/components/products/MontageGrid.tsx
--------------------------------------------------------------------------------

'use client';

import type { Product } from '@/lib/types';
import Image from 'next/image';
import Link from 'next/link';
import EmptyState from '../ui/EmptyState';
import { Package } from 'lucide-react';
import { motion } from 'framer-motion';

export interface MontageGridProps {
  products: Product[];
  lastProductRef?: (node: HTMLDivElement) => void;
}

import { useViewedProducts } from '@/context/ViewedProductsContext';
import { Eye, Trash2, Loader2 } from 'lucide-react';
import { useUser } from '@/firebase';
import { useState } from 'react';
import { deleteProductByAdmin } from '@/app/actions/admin';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';
import { useToast } from '@/hooks/use-toast';
import { SUPER_ADMIN_EMAILS, SUPER_ADMIN_UIDS } from '@/lib/constants';

export default function MontageGrid({ products, lastProductRef }: MontageGridProps) {
  const { viewedProductIds } = useViewedProducts();
  const { user } = useUser();
  const { toast } = useToast();
  const [deletingId, setDeletingId] = useState<string | null>(null);

  const isSuperAdmin = (user?.uid && SUPER_ADMIN_UIDS.includes(user.uid)) || (user?.email && SUPER_ADMIN_EMAILS.includes(user.email));

  const handleDelete = async (e: React.MouseEvent, productId: string) => {
    e.preventDefault();
    e.stopPropagation();

    if (!confirm("Are you sure you want to delete this product?")) return;

    setDeletingId(productId);
    try {
      const idToken = await getCurrentUserIdToken();
      if (!idToken) throw new Error("Auth error");

      const result = await deleteProductByAdmin(productId, idToken);

      if (result.success) {
        toast({ title: "Deleted", description: "Product removed." });
        // Note: The list won't auto-refresh unless we invalidate router or use realtime. 
        // Without router.refresh(), it stays until reload. 
        // For now, I'll rely on user reloading or navigation.
        // Actually, I can reload page: window.location.reload(); 
        // Or just letting it be is fine for now.
        window.location.reload();
      } else {
        toast({ title: "Error", description: result.error, variant: "destructive" });
      }
    } catch (err) {
      console.error(err);
      toast({ title: "Failed", variant: "destructive" });
    } finally {
      setDeletingId(null);
    }
  };

  if (!products || products.length === 0) {
    return <EmptyState
      icon={<Package className="h-12 w-12 text-muted-foreground" />}
      title="No Products Found"
      description="Try adjusting your search or filters to find what you're looking for."
    />;
  }

  return (
    <motion.div
      layout
      className="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-2"
    >
      {products.map((product, index) => {
        const isLastElement = index === products.length - 1;
        const hasViewed = viewedProductIds.includes(product.id);

        return (
          <motion.div
            ref={isLastElement ? lastProductRef : null}
            key={product.id}
            layout
            initial={{ opacity: 0, scale: 0.8 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.8 }}
            transition={{ duration: 0.3, delay: index * 0.02 }}
          >
            <Link href={`/product/${product.id}`} className="group block relative aspect-square w-full h-full overflow-hidden rounded-md">
              <Image
                src={product.imageUrls[0]}
                alt={product.title}
                fill
                sizes="(max-width: 640px) 25vw, (max-width: 768px) 16vw, (max-width: 1024px) 12.5vw, 10vw"
                className="object-cover transition-transform duration-300 ease-in-out group-hover:scale-110"
              />
              <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />

              {hasViewed && (
                <div className="absolute top-1 left-1 z-10">
                  <div className="bg-black/50 text-white p-1 rounded-full backdrop-blur-sm">
                    <Eye className="h-3 w-3" />
                  </div>
                </div>
              )}

              {isSuperAdmin && (
                <button
                  onClick={(e) => handleDelete(e, product.id)}
                  className="absolute top-1 right-1 z-20 bg-red-600/80 hover:bg-red-700 text-white p-1 rounded-md opacity-0 group-hover:opacity-100 transition-opacity"
                  disabled={deletingId === product.id}
                >
                  {deletingId === product.id ? <Loader2 className="h-3 w-3 animate-spin" /> : <Trash2 className="h-3 w-3" />}
                </button>
              )}

              <div className="absolute bottom-1 right-1">
                <span className="bg-black/50 text-white text-xs font-bold px-2 py-1 rounded-md backdrop-blur-sm">
                  ${product.price.toFixed(0)}
                </span>
              </div>
            </Link>
          </motion.div>
        )
      })}
    </motion.div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/products/ProductCard.tsx
--------------------------------------------------------------------------------


'use client';

import React, { useState } from 'react';
import Image from 'next/image';
import Link from 'next/link';
import type { Product } from '@/lib/types';
import { cn } from '@/lib/utils';
import { Badge } from '../ui/badge';
import { Button } from '../ui/button';
import { ShoppingCart, Eye, Trash2, Loader2, Clock, Users, Edit, MoreHorizontal, ShieldCheck } from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { useCart } from '@/context/CartContext';
import { useToast } from '@/hooks/use-toast';
import { Avatar, AvatarFallback, AvatarImage } from '../ui/avatar';
import { formatDistanceToNow } from 'date-fns';
import { QuickView } from './QuickView';
import { Timestamp } from 'firebase/firestore';
import { useUser } from '@/firebase';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';
import { deleteProductByAdmin } from '@/app/actions/admin';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { useViewedProducts } from '@/context/ViewedProductsContext';
import { SUPER_ADMIN_EMAILS, SUPER_ADMIN_UIDS } from '@/lib/constants';


interface ProductCardProps {
  product: Product;
  viewMode?: 'grid' | 'list';
}

export default function ProductCard({ product, viewMode = 'grid' }: ProductCardProps) {
  const { addItem } = useCart();
  const { toast } = useToast();
  const { user } = useUser();
  const [isDeleting, setIsDeleting] = useState(false);
  const [isDeleted, setIsDeleted] = useState(false);
  const { viewedProductIds } = useViewedProducts();

  const hasViewed = viewedProductIds.includes(product.id);

  // Super admin check
  const isSuperAdmin = (user?.uid && SUPER_ADMIN_UIDS.includes(user.uid)) || (user?.email && SUPER_ADMIN_EMAILS.includes(user.email));

  const handleAddToCart = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.preventDefault();
    e.stopPropagation();
    addItem(product);
    toast({
      title: 'Added to Cart!',
      description: `${product.title} is now in your cart.`,
    });
  };

  const handleDelete = async (e: React.MouseEvent<HTMLButtonElement>) => {
    e.preventDefault();
    e.stopPropagation();

    if (!isSuperAdmin) return;
    setIsDeleting(true);

    try {
      const idToken = await getCurrentUserIdToken();
      if (!idToken) throw new Error("Authentication session expired.");

      const result = await deleteProductByAdmin(product.id, idToken);

      if (!result.success) {
        throw new Error(result.error);
      }

      toast({
        title: "Product Deleted",
        description: result.message,
      });
      setIsDeleted(true); // Visually remove the card

    } catch (error: any) {
      toast({
        variant: "destructive",
        title: "Deletion Failed",
        description: error.message || "An error occurred.",
      });
    } finally {
      setIsDeleting(false);
    }
  };


  const getFormattedDate = (dateValue: any) => {
    if (!dateValue) return '';

    // Handle both Firestore Timestamps and JS Date objects
    if (dateValue instanceof Timestamp) {
      return formatDistanceToNow(dateValue.toDate(), { addSuffix: true });
    }
    // Check for serialized Timestamp from server-side rendering
    if (typeof dateValue === 'object' && dateValue.seconds) {
      return formatDistanceToNow(new Date(dateValue.seconds * 1000), { addSuffix: true });
    }
    // Handle standard JS Date object
    if (dateValue instanceof Date) {
      return formatDistanceToNow(dateValue, { addSuffix: true });
    }
    return '';
  }

  if (isDeleted) {
    return null; // Don't render the card if it has been deleted
  }

  if (viewMode === 'list') {
    return (
      <Link href={`/product/${product.id}`} className="group block">
        <div className="flex flex-col sm:flex-row gap-4 rounded-lg border bg-card text-card-foreground shadow-sm overflow-hidden transition-all hover:shadow-md">
          <div className="relative w-full sm:w-48 flex-shrink-0 aspect-square bg-muted">
            {product.imageUrls?.[0] ? (
              <Image
                src={product.imageUrls[0]}
                alt={product.title}
                fill
                className="object-cover"
                sizes="(max-width: 640px) 100vw, 192px"
              />
            ) : null}
            <div className="absolute top-2 left-2 z-10 flex flex-col gap-1">
              {product.isVault && (
                <Badge 
                  variant="default" 
                  className="inline-flex items-center gap-1 bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-tighter shadow-md cursor-pointer z-20"
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    window.open('/vault', '_blank');
                  }}
                >
                  <ShieldCheck className="h-3 w-3" />
                  Vault
                </Badge>
              )}
              {hasViewed && (
                <Badge variant="secondary" className="inline-flex items-center gap-1 bg-black/50 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-tighter backdrop-blur-sm">
                  <Eye className="h-3 w-3" />
                  Viewed
                </Badge>
              )}
              {product.status === 'sold' && (
                <Badge variant="destructive">
                  Sold
                </Badge>
              )}
            </div>
            <div className="absolute top-2 right-2 z-10">
              {isSuperAdmin && (
                <div onClick={(e) => e.stopPropagation()}>
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button variant="secondary" size="icon" className="h-8 w-8 rounded-full bg-black/50 text-white backdrop-blur-sm hover:bg-black/70 border-none">
                        <MoreHorizontal className="h-4 w-4" />
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="end">
                      <DropdownMenuItem asChild>
                        <Link href={`/sell/create?edit=${product.id}`}>
                          <Edit className="mr-2 h-4 w-4" /> Edit Listing
                        </Link>
                      </DropdownMenuItem>
                      <DropdownMenuItem onClick={(e) => { e.preventDefault(); e.stopPropagation(); setIsDeleting(true); }} className="text-red-600">
                        <Trash2 className="mr-2 h-4 w-4" /> Delete Listing
                      </DropdownMenuItem>
                    </DropdownMenuContent>
                  </DropdownMenu>
                  <AlertDialog open={isDeleting} onOpenChange={setIsDeleting}>
                    <AlertDialogContent onClick={(e) => e.stopPropagation()}>
                      <AlertDialogHeader>
                        <AlertDialogTitle>Delete Product?</AlertDialogTitle>
                        <AlertDialogDescription>
                          Are you sure you want to delete "{product.title}"? This action cannot be undone.
                        </AlertDialogDescription>
                      </AlertDialogHeader>
                      <AlertDialogFooter>
                        <AlertDialogCancel onClick={(e) => { e.stopPropagation(); setIsDeleting(false); }}>Cancel</AlertDialogCancel>
                        <AlertDialogAction onClick={handleDelete} className="bg-red-600">Delete</AlertDialogAction>
                      </AlertDialogFooter>
                    </AlertDialogContent>
                  </AlertDialog>
                </div>
              )}
            </div>
          </div>
          <div className="p-4 flex flex-col justify-between flex-grow">
            <div>
              <div className="flex items-center justify-between">
                <Badge variant="outline" className="text-xs mb-1">{product.category}</Badge>
                <p className="text-lg font-bold">${product.price?.toLocaleString() || '0.00'}</p>
              </div>
              <h3 className="text-lg font-semibold text-foreground group-hover:text-primary leading-tight">
                {product.title}
              </h3>
              <p className="text-sm text-muted-foreground mt-2 line-clamp-2">
                {product.description}
              </p>
            </div>
            <div className="flex items-center justify-between mt-4 text-xs text-muted-foreground">
              <div className="flex items-center gap-2">
                <Avatar className="h-6 w-6">
                  <AvatarImage src={product.sellerAvatar} />
                  <AvatarFallback>{product.sellerName?.[0]}</AvatarFallback>
                </Avatar>
                <span>{product.sellerName}</span>
              </div>
              <span>{getFormattedDate(product.createdAt)}</span>
            </div>
          </div>
        </div>
      </Link>
    );
  }

  // Grid View (default) - new style
  return (
    <div className="group relative flex flex-col bg-white dark:bg-white/5 rounded-xl overflow-hidden border border-transparent hover:border-primary/20 hover:shadow-2xl transition-all duration-300 h-full">
      <Link href={`/product/${product.id}`} className="contents">
        <div className="aspect-[4/5] bg-gray-100 dark:bg-white/10 relative overflow-hidden">
          <div className="absolute top-3 left-3 z-10 flex gap-2">
            {product.isVault && (
              <Badge 
                variant="default" 
                className="inline-flex items-center gap-1 bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-tighter shadow-lg cursor-pointer z-20"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  window.open('/vault', '_blank');
                }}
              >
                <ShieldCheck className="h-3 w-3" />
                Vault
              </Badge>
            )}
            {hasViewed && (
              <Badge variant="secondary" className="inline-flex items-center gap-1 bg-black/50 text-white text-[10px] font-bold px-2.5 py-1 rounded-full uppercase tracking-tighter backdrop-blur-sm">
                <Eye className="h-3 w-3" />
                Viewed
              </Badge>
            )}
          </div>
          <div className="absolute top-3 right-3 z-10">
            {isSuperAdmin && (
              <div onClick={(e) => e.preventDefault()}>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="secondary" size="icon" className="h-8 w-8 rounded-full bg-black/50 text-white backdrop-blur-sm hover:bg-black/70 border-none">
                      <MoreHorizontal className="h-4 w-4" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem asChild>
                      <Link href={`/sell/create?edit=${product.id}`}>
                        <Edit className="mr-2 h-4 w-4" /> Edit Listing
                      </Link>
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={(e) => { e.preventDefault(); e.stopPropagation(); setIsDeleting(true); }} className="text-red-600">
                      <Trash2 className="mr-2 h-4 w-4" /> Delete Listing
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
                <AlertDialog open={isDeleting} onOpenChange={setIsDeleting}>
                  <AlertDialogContent onClick={(e) => e.stopPropagation()}>
                    <AlertDialogHeader>
                      <AlertDialogTitle>Delete Product?</AlertDialogTitle>
                      <AlertDialogDescription>
                        Are you sure you want to delete "{product.title}"? This action cannot be undone.
                      </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                      <AlertDialogCancel onClick={(e) => { e.stopPropagation(); setIsDeleting(false); }}>Cancel</AlertDialogCancel>
                      <AlertDialogAction onClick={handleDelete} className="bg-red-600">Delete</AlertDialogAction>
                    </AlertDialogFooter>
                  </AlertDialogContent>
                </AlertDialog>
              </div>
            )}
          </div>
          {product.imageUrls?.[0] && (
            <Image
              src={product.imageUrls[0]}
              alt={product.title}
              fill
              className="object-cover transition-transform duration-500 group-hover:scale-110"
              sizes="(max-width: 768px) 50vw, (max-width: 1280px) 33vw, 25vw"
            />
          )}
          <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
        </div>
        <div className="p-5 flex flex-col flex-grow">
          <div className="flex justify-between items-start mb-2">
            <h3 className="text-lg font-bold leading-tight group-hover:text-primary transition-colors flex-1 pr-2">
              {product.title}
            </h3>
            {product.grade && <span className="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-[10px] font-black px-2 py-0.5 rounded">{product.grade}</span>}
          </div>
          <div className="flex items-end justify-between mt-4 flex-grow">
            <div>
              <p className="text-xs text-gray-500 dark:text-gray-400 font-medium">Price</p>
              <p className="text-2xl font-black text-[#0d121b] dark:text-white tracking-tight">${product.price.toLocaleString()}</p>
            </div>
            <Button size="sm" className="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all active:scale-95" onClick={(e) => { e.preventDefault(); handleAddToCart(e); }}>
              Buy It
            </Button>
          </div>
          <div className="mt-4 pt-4 border-t border-gray-100 dark:border-white/10 flex items-center justify-between text-xs text-gray-400">
            <span className="flex items-center gap-1"><Clock className="h-3 w-3" /> {getFormattedDate(product.createdAt)}</span>
            <span className="flex items-center gap-1"><Users className="h-3 w-3" /> {product.views || 0} views</span>
          </div>
        </div>
      </Link>
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/products/ProductCardSkeleton.tsx
--------------------------------------------------------------------------------

// components/products/ProductCardSkeleton.tsx
import { Card, CardContent, CardFooter } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";

export default function ProductCardSkeleton() {
  return (
    <Card className="overflow-hidden rounded-lg shadow-md h-full">
      <CardContent className="p-0">
        <Skeleton className="w-full h-auto aspect-square" />
      </CardContent>
      <CardFooter className="p-4 flex flex-col items-start space-y-2">
        <Skeleton className="h-4 w-1/3" />
        <Skeleton className="h-5 w-full" />
        <Skeleton className="h-6 w-1/4 mt-1" />
      </CardFooter>
    </Card>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/products/ProductGrid.tsx
--------------------------------------------------------------------------------


'use client';

import type { Product } from '@/lib/types';
import ProductCard from './ProductCard';
import EmptyState from '../ui/EmptyState';
import { Package, Upload } from 'lucide-react';
import { QuickView } from './QuickView';
import { Button } from '../ui/button';
import Link from 'next/link';
import { useUserPermissions } from '@/hooks/use-user-permissions';

export interface ProductGridProps {
  products: Product[];
}

export default function ProductGrid({ products }: ProductGridProps) {
  const { canSell } = useUserPermissions();

  if (!products || products.length === 0) {
    return <EmptyState 
      icon={<Package className="h-12 w-12 text-muted-foreground" />}
      title="No Products Found"
      description="Try adjusting your search or filters to find what you're looking for."
    >
        {canSell && (
          <Button asChild className="mt-6">
              <Link href="/sell/create">
                  <Upload className="h-4 w-4 mr-2" />
                  List an Item
              </Link>
          </Button>
        )}
    </EmptyState>;
  }

  return (
    <div
      className="grid grid-cols-2 gap-x-4 gap-y-8 md:grid-cols-3 lg:grid-cols-4 2xl:grid-cols-5 xl:gap-x-8 mt-8"
    >
      {products.map((product) => (
        <ProductCard key={product.id} product={product} />
      ))}
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/products/ProductGridSkeleton.tsx
--------------------------------------------------------------------------------

// components/products/ProductGridSkeleton.tsx
import ProductCardSkeleton from "./ProductCardSkeleton";

export default function ProductGridSkeleton({ count = 8 }: { count?: number }) {
  return (
    <div className="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 2xl:grid-cols-5 xl:gap-x-8 mt-8">
      {Array.from({ length: count }).map((_, i) => (
        <ProductCardSkeleton key={i} />
      ))}
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/products/ProductImageGallery.tsx
--------------------------------------------------------------------------------


"use client";

import { useState } from 'react';
import Image from 'next/image';
import { motion, AnimatePresence } from 'framer-motion';
import { ChevronLeft, ChevronRight, Maximize2, X } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent } from '@/components/ui/dialog';
import { Badge } from '@/components/ui/badge';
import { cn } from '@/lib/utils';
import { ShieldCheck } from 'lucide-react';

interface ProductImageGalleryProps {
  images: string[];
  title: string;
  isCard: boolean;
  condition?: string;
  isAuthenticated?: boolean;
}

const conditionColors: Record<string, string> = {
  'Mint': 'bg-green-100 text-green-800 border-green-200',
  'Near Mint': 'bg-emerald-100 text-emerald-800 border-emerald-200',
  'Excellent': 'bg-blue-100 text-blue-800 border-blue-200',
  'Good': 'bg-yellow-100 text-yellow-800 border-yellow-200',
  'Fair': 'bg-orange-100 text-orange-800 border-orange-200',
  'Poor': 'bg-red-100 text-red-800 border-red-200',
};

export default function ProductImageGallery({ images, title, isCard, condition, isAuthenticated }: ProductImageGalleryProps) {
  const [selectedIndex, setSelectedIndex] = useState(0);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [zoomStyle, setZoomStyle] = useState({ transformOrigin: 'center', transform: 'scale(1)' });

  const goToPrevious = (e?: React.MouseEvent) => {
    e?.stopPropagation();
    setSelectedIndex((prev) => (prev === 0 ? images.length - 1 : prev - 1));
  };

  const goToNext = (e?: React.MouseEvent) => {
    e?.stopPropagation();
    setSelectedIndex((prev) => (prev === images.length - 1 ? 0 : prev + 1));
  };

  const handleMouseMove = (e: React.MouseEvent<HTMLDivElement>) => {
    const { left, top, width, height } = e.currentTarget.getBoundingClientRect();
    const x = ((e.clientX - left) / width) * 100;
    const y = ((e.clientY - top) / height) * 100;
    setZoomStyle({
      transformOrigin: `${x}% ${y}%`,
      transform: 'scale(2.0)', // 2x Zoom
    });
  };

  const handleMouseLeave = () => {
    setZoomStyle({
      transformOrigin: 'center',
      transform: 'scale(1)',
    });
  };

  return (
    <>
      <div className="space-y-4">
        {/* Main Image */}
        <div
          className="relative aspect-square bg-gray-100 rounded-lg overflow-hidden group cursor-zoom-in"
          onMouseMove={handleMouseMove}
          onMouseLeave={handleMouseLeave}
          onClick={() => setIsFullscreen(true)}
        >
          <AnimatePresence mode="wait">
            <motion.div
              key={selectedIndex}
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.2 }}
              className="relative w-full h-full pointer-events-none"
            >
              <Image
                src={images[selectedIndex]}
                alt={`${title} - Image ${selectedIndex + 1}`}
                fill
                className="object-contain transition-transform duration-200 ease-out"
                style={zoomStyle}
                priority={selectedIndex === 0}
                sizes="(max-width: 768px) 100vw, 50vw"
              />
            </motion.div>
          </AnimatePresence>

          {/* Navigation Arrows */}
          {images.length > 1 && (
            <>
              <Button
                variant="ghost"
                size="icon"
                className="absolute left-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity bg-white/80 hover:bg-white rounded-full h-9 w-9 z-10"
                onClick={goToPrevious}
              >
                <ChevronLeft className="w-5 h-5" />
              </Button>
              <Button
                variant="ghost"
                size="icon"
                className="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity bg-white/80 hover:bg-white rounded-full h-9 w-9 z-10"
                onClick={goToNext}
              >
                <ChevronRight className="w-5 h-5" />
              </Button>
            </>
          )}

          {/* Fullscreen Button */}
          <Button
            variant="ghost"
            size="icon"
            className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-white/80 hover:bg-white rounded-full h-9 w-9 z-10"
            onClick={(e) => { e.stopPropagation(); setIsFullscreen(true); }}
          >
            <Maximize2 className="w-5 h-5" />
          </Button>

          <div className="absolute top-4 left-4 flex flex-col gap-2 pointer-events-none z-10">
            {condition && (
              <Badge className={cn("border-none", conditionColors[condition] || 'bg-gray-100')}>
                {condition}
              </Badge>
            )}
            {isAuthenticated && (
              <Badge className="bg-blue-100 text-blue-800 border-blue-200 border-none">
                <ShieldCheck className="h-3 w-3 mr-1" />
                Authenticated
              </Badge>
            )}
          </div>

          {/* Image Counter */}
          {images.length > 1 && (
            <div className="absolute bottom-2 right-2 bg-black/60 text-white px-2 py-1 rounded-full text-xs pointer-events-none z-10">
              {selectedIndex + 1} / {images.length}
            </div>
          )}
        </div>

        {/* Thumbnail Strip */}
        {images.length > 1 && (
          <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
            {images.map((image, index) => (
              <button
                key={index}
                onClick={() => setSelectedIndex(index)}
                className={`
                  relative flex-shrink-0 w-20 h-20 rounded-md overflow-hidden border-2 transition-all
                  ${index === selectedIndex ? 'border-primary ring-2 ring-primary/20' : 'border-transparent hover:border-gray-300'}
                `}
              >
                <Image
                  src={image}
                  alt={`Thumbnail ${index + 1}`}
                  fill
                  className="object-cover"
                />
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Fullscreen Modal */}
      <Dialog open={isFullscreen} onOpenChange={setIsFullscreen}>
        <DialogContent className="max-w-[95vw] w-full h-[95vh] p-0 bg-black/95 border-none shadow-none flex flex-col">
          <div className="relative flex-1 w-full flex items-center justify-center overflow-hidden">
            <Image
              src={images[selectedIndex]}
              alt={`${title} - Fullscreen`}
              fill
              className="object-contain"
            />

            {/* Close Button */}
            <Button
              variant="ghost"
              size="icon"
              className="absolute top-4 right-4 text-white hover:bg-white/20 rounded-full h-10 w-10 z-50"
              onClick={() => setIsFullscreen(false)}
            >
              <X className="w-6 h-6" />
            </Button>

            {/* Navigation in Fullscreen */}
            {images.length > 1 && (
              <>
                <Button
                  variant="ghost"
                  size="icon"
                  className="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:bg-white/20 h-12 w-12 rounded-full z-40"
                  onClick={goToPrevious}
                >
                  <ChevronLeft className="w-8 h-8" />
                </Button>
                <Button
                  variant="ghost"
                  size="icon"
                  className="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:bg-white/20 h-12 w-12 rounded-full z-40"
                  onClick={goToNext}
                >
                  <ChevronRight className="w-8 h-8" />
                </Button>
              </>
            )}
          </div>

          {/* Fullscreen Thumbnails */}
          {images.length > 1 && (
            <div className="h-24 bg-black/50 flex items-center justify-center p-4 border-t border-white/10">
              <div className="flex gap-4 overflow-x-auto max-w-full px-4 scrollbar-hide">
                {images.map((image, index) => (
                  <button
                    key={index}
                    onClick={() => setSelectedIndex(index)}
                    className={`
                        relative flex-shrink-0 w-16 h-16 rounded-md overflow-hidden border-2 transition-all
                        ${index === selectedIndex ? 'border-white ring-2 ring-white/50' : 'border-transparent opacity-50 hover:opacity-100'}
                        `}
                  >
                    <Image
                      src={image}
                      alt={`Thumb ${index}`}
                      fill
                      className="object-cover"
                    />
                  </button>
                ))}
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/products/ProductList.tsx
--------------------------------------------------------------------------------


'use client';

import type { Product } from '@/lib/types';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import Image from 'next/image';
import Link from 'next/link';
import { Button } from '../ui/button';
import EmptyState from '../ui/EmptyState';
import { Package } from 'lucide-react';

interface ProductListProps {
    products: Product[];
}

export default function ProductList({ products }: ProductListProps) {
  if (!products || products.length === 0) {
    return <EmptyState 
      icon={<Package className="h-12 w-12 text-muted-foreground" />}
      title="No Products Found"
      description="Try adjusting your search or filters to find what you're looking for."
    />;
  }

  return (
    <div className="border rounded-lg mt-8">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead className="w-[100px]">Image</TableHead>
            <TableHead>Title</TableHead>
            <TableHead>Condition</TableHead>
            <TableHead>Seller</TableHead>
            <TableHead className="text-right">Price</TableHead>
            <TableHead className="text-right">Actions</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {products.map((product) => (
            <TableRow key={product.id}>
              <TableCell>
                <div className="relative h-16 w-16 rounded-md overflow-hidden bg-muted">
                    <Image src={product.imageUrls[0]} alt={product.title} fill className="object-cover" />
                </div>
              </TableCell>
              <TableCell className="font-medium">{product.title}</TableCell>
              <TableCell>
                <Badge variant="outline">{product.condition}</Badge>
              </TableCell>
              <TableCell>{product.sellerName}</TableCell>
              <TableCell className="text-right font-semibold">${product.price.toFixed(2)}</TableCell>
              <TableCell className="text-right">
                <Button asChild variant="ghost" size="sm">
                    <Link href={`/product/${product.id}`}>View</Link>
                </Button>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/products/ProductViewSwitcher.tsx
--------------------------------------------------------------------------------

'use client';

import { Button } from '@/components/ui/button';
import { LayoutGrid, List, Grid } from 'lucide-react';
import { cn } from '@/lib/utils';

type ViewMode = 'grid' | 'list' | 'montage';

interface ProductViewSwitcherProps {
  view: ViewMode;
  setView: (view: ViewMode) => void;
}

export default function ProductViewSwitcher({ view, setView }: ProductViewSwitcherProps) {
  return (
    <div className="flex items-center gap-2">
      <Button
        variant="outline"
        size="icon"
        onClick={() => setView('grid')}
        className={cn(view === 'grid' && 'bg-accent text-accent-foreground')}
        aria-label="Grid View"
      >
        <LayoutGrid className="h-4 w-4" />
      </Button>
      <Button
        variant="outline"
        size="icon"
        onClick={() => setView('list')}
        className={cn(view === 'list' && 'bg-accent text-accent-foreground')}
        aria-label="List View"
      >
        <List className="h-4 w-4" />
      </Button>
       <Button
        variant="outline"
        size="icon"
        onClick={() => setView('montage')}
        className={cn(view === 'montage' && 'bg-accent text-accent-foreground')}
        aria-label="Montage View"
      >
        <Grid className="h-4 w-4" />
      </Button>
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/products/QuickView.tsx
--------------------------------------------------------------------------------


'use client';

import type { Product } from '@/lib/types';
import { Dialog, DialogContent, DialogTitle, DialogDescription, DialogTrigger } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Badge } from '../ui/badge';
import { Separator } from '../ui/separator';
import { useCart } from '@/context/CartContext';
import Link from 'next/link';
import { useViewedProducts } from '@/context/ViewedProductsContext';
import ProductImageGallery from './ProductImageGallery';
import { Heart, Share2, ShoppingCart, Edit, Eye } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { useUser } from '@/firebase';
import { useState } from 'react';
import { SUPER_ADMIN_EMAILS, SUPER_ADMIN_UIDS } from '@/lib/constants';

interface QuickViewProps {
  product: Product;
}

export function QuickView({ product }: QuickViewProps) {
  const { user } = useUser();
  const { addItem } = useCart();
  const { markAsViewed } = useViewedProducts();
  const { toast } = useToast();
  const [isOpen, setIsOpen] = useState(false);

  const isOwner = user && user.uid === product.sellerId;
  const isSuperAdmin = user && ((user.uid && SUPER_ADMIN_UIDS.includes(user.uid)) || (user.email && SUPER_ADMIN_EMAILS.includes(user.email)));
  const canEdit = isOwner || isSuperAdmin;


  const handleOpen = (openState: boolean) => {
    setIsOpen(openState);
    if (openState) {
      markAsViewed(product.id);
    }
  };

  const handleFavorite = () => {
    // This would eventually be a database action
    toast({
      title: "Added to Favorites!",
      description: `${product.title} has been added to your favorites list.`
    });
  }

  const handleShare = () => {
    navigator.clipboard.writeText(`${window.location.origin}/product/${product.id}`);
    toast({
      title: "Link Copied!",
      description: "A link to this product has been copied to your clipboard."
    });
  }
  
  const handleAddToCart = () => {
    addItem(product);
    toast({
        title: "Added to Cart!",
        description: `${product.title} is now in your cart.`
    });
    setIsOpen(false);
  }

  return (
    <Dialog open={isOpen} onOpenChange={handleOpen}>
      <DialogTrigger asChild>
        <Button variant="outline" size="sm" className="w-full mt-2">
            <Eye className="mr-2 h-4 w-4" />
            Quick View
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-4xl w-full h-auto md:h-[80vh] flex flex-col md:flex-row p-0">
          <DialogTitle className="sr-only">{`Quick view of ${product.title}`}</DialogTitle>
          <DialogDescription className="sr-only">{`View details for ${product.title}, add to cart, or see more.`}</DialogDescription>
        
        {/* Left Side: Image Gallery */}
        <div className="md:w-1/2 p-6 flex flex-col">
          <ProductImageGallery 
            images={product.imageUrls} 
            title={product.title} 
            isCard={product.category === 'Collector Cards'} 
          />
        </div>

        {/* Right Side: Product Details */}
        <div className="md:w-1/2 p-6 flex flex-col bg-gray-50/50 overflow-y-auto">
          
          <div className="space-y-3">
            <Badge variant="outline">{product.category}</Badge>
            <h1 className="text-2xl lg:text-3xl font-bold tracking-tight font-headline">{product.title}</h1>
            <div className="flex items-center gap-2">
              <p className="text-sm text-muted-foreground">
                Sold by <Link href={`/seller/${product.sellerId}`} className="font-medium text-primary hover:underline">{product.sellerName}</Link>
              </p>
              {/* Star ratings could go here */}
            </div>
          </div>

          <Separator className="my-5" />
          
          <div className="space-y-4">
            <p className="text-3xl font-bold text-foreground">${product.price.toFixed(2)}</p>
            
            <div className="text-sm text-muted-foreground">
                {product.description}
            </div>
          </div>
          
          <div className="mt-auto pt-6 space-y-4">
             <div className="flex items-center gap-4">
                <Button size="lg" className="flex-1" onClick={handleAddToCart}>
                    <ShoppingCart className="mr-2 h-5 w-5" />
                    Buy It
                </Button>
                <Button size="icon" variant="outline" onClick={handleFavorite}>
                    <Heart className="h-5 w-5" />
                </Button>
                <Button size="icon" variant="outline" onClick={handleShare}>
                    <Share2 className="h-5 w-5" />
                </Button>
             </div>
             {canEdit && (
                <Button asChild variant="secondary" className="w-full">
                    <Link href={`/sell/edit/${product.id}`}>
                        <Edit className="mr-2 h-4 w-4" />
                        Edit Listing
                    </Link>
                </Button>
             )}
             <Button asChild variant="ghost" className="w-full">
                <Link href={`/product/${product.id}`}>
                    View Full Product Details 
                </Link>
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/research/camera-scanner.tsx
--------------------------------------------------------------------------------

'use client';

import { useRef, useEffect, useState, useCallback } from 'react';
import { Loader, CameraOff, Sparkles, PlusCircle, Gem, Camera, ShoppingCart, Upload } from 'lucide-react';
import { useRouter } from 'next/navigation';
import { cn } from '@/lib/utils';
import { extractCardName } from '@/ai/flows/extract-card-name';
import { quickScan } from '@/ai/flows/quick-scan';
import { useToast } from '@/hooks/use-toast';
import { Button } from '@/components/ui/button';
import { verifyCard } from '@/lib/card-logic';
import type { Player } from '@/lib/research-types';

interface CameraScannerProps {
    playersToKeep: Player[];
    onScanComplete: (
        result: {
            name: string;
            isKeeper: boolean;
            imageDataUri: string;
            brand?: string;
            cardType?: string;
            sport?: string;
            cardYear?: number | null;
            isPrizmRookie?: boolean;
            salesData?: {
                averagePrice?: number | null;
                salesCount?: number | null;
                source?: string | null;
            };
        }
    ) => void;
    onAddNameToKeep: (name: string, sport?: string) => void;
}

type ScanResult = {
    name: string;
    isKeeper: boolean;
    isPrizmRookie?: boolean;
    brand?: string;
    cardType?: string;
    sport?: string;
    cardYear?: number | null;
    imageDataUri?: string;
};

type ProcessingState = 'idle' | 'scanning' | 'verifying';

const resizeImage = async (dataUri: string, maxWidth = 800): Promise<string> => {
    const img = new Image();
    img.src = dataUri;
    await new Promise((resolve) => { img.onload = resolve; });

    if (img.width <= maxWidth) {
        return dataUri;
    }

    const canvas = document.createElement('canvas');
    const scale = maxWidth / img.width;
    canvas.width = maxWidth;
    canvas.height = img.height * scale;
    const ctx = canvas.getContext('2d');

    if (!ctx) {
        throw new Error('Could not get canvas context');
    }

    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    return canvas.toDataURL('image/jpeg', 0.8);
};

export default function CameraScanner({
    playersToKeep,
    onScanComplete,
    onAddNameToKeep,
}: CameraScannerProps) {
    const videoRef = useRef<HTMLVideoElement>(null);
    const canvasRef = useRef<HTMLCanvasElement>(null);
    const fileInputRef = useRef<HTMLInputElement>(null);
    const router = useRouter();
    const [isCameraActive, setIsCameraActive] = useState(false);
    const [processingState, setProcessingState] = useState<ProcessingState>('idle');
    const [scanResult, setScanResult] = useState<ScanResult | null>(null);
    const [showResult, setShowResult] = useState(false);
    const [cameraError, setCameraError] = useState<string | null>(null);
    const { toast } = useToast();

    const cleanupCamera = useCallback(() => {
        if (videoRef.current && videoRef.current.srcObject) {
            const stream = videoRef.current.srcObject as MediaStream;
            stream.getTracks().forEach((track) => track.stop());
            videoRef.current.srcObject = null;
        }
    }, []);

    useEffect(() => {
        async function setupCamera() {
            if (isCameraActive) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' },
                    });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        // Ensure video plays (critical for iOS)
                        await videoRef.current.play();
                    }
                } catch (err: any) {
                    console.error('Camera access denied:', err);
                    const errorMessage = 'Camera access denied. Please enable camera permissions in your browser settings.';
                    setCameraError(errorMessage);
                    cleanupCamera();
                    setIsCameraActive(false);
                }
            } else {
                cleanupCamera();
            }
        }
        setupCamera();
        return cleanupCamera;
    }, [isCameraActive, cleanupCamera]);

    const toggleCamera = () => {
        setCameraError(null);
        setIsCameraActive(prev => !prev);
    };

    const handleListOnMarketplace = useCallback(() => {
        if (!scanResult) return;

        // Store scan data in sessionStorage for the create listing page
        const listingData = {
            title: `${scanResult.name}${scanResult.cardYear ? ` ${scanResult.cardYear}` : ''}${scanResult.brand ? ` ${scanResult.brand}` : ''}${scanResult.cardType ? ` ${scanResult.cardType}` : ''}`,
            description: `${scanResult.brand || 'Trading'} Card featuring ${scanResult.name}${scanResult.sport ? ` - ${scanResult.sport}` : ''}${scanResult.cardType ? ` ${scanResult.cardType}` : ''}`,
            category: 'Collector Cards',
            subCategory: 'Trading Cards',
            year: scanResult.cardYear,
            manufacturer: scanResult.brand,
            imageDataUri: scanResult.imageDataUri, // The scanned image
        };

        sessionStorage.setItem('researchScanData', JSON.stringify(listingData));
        router.push('/sell/create?from=research');
    }, [scanResult, router]);

    const processImage = useCallback(async (imageDataUri: string) => {
        if (processingState !== 'idle') return;

        if (!playersToKeep || playersToKeep.length === 0) {
            toast({
                variant: 'destructive',
                title: 'Setup Required',
                description: "Please add players to your 'keep list' before scanning.",
            });
            return;
        }

        console.log("Processing image...");
        setProcessingState('scanning');
        setScanResult(null);

        try {
            const resizedImage = await resizeImage(imageDataUri);

            const { playerName } = await quickScan({ cardImageDataUri: resizedImage });
            console.log("Quick scan result:", playerName);

            const preliminaryCheck = playersToKeep.find(p => p.name.toLowerCase() === playerName.toLowerCase());

            if (!preliminaryCheck) {
                const result = { name: playerName, isKeeper: false, imageDataUri: resizedImage };
                setScanResult(result);
                setShowResult(true);
                onScanComplete({ ...result, imageDataUri: resizedImage });
                setTimeout(() => setShowResult(false), 3000);
                setProcessingState('idle');
                return;
            }

            setProcessingState('verifying');
            const extractedDetails = await extractCardName({
                cardImageDataUri: resizedImage,
            });
            console.log("Detailed scan result:", extractedDetails);

            const { isKeeper, isPrizmRookie } = verifyCard(extractedDetails, playersToKeep);

            const result = {
                name: extractedDetails.playerName,
                isKeeper,
                isPrizmRookie,
                brand: extractedDetails.cardBrand,
                cardType: extractedDetails.cardColor,
                sport: extractedDetails.sport,
                cardYear: extractedDetails.cardYear,
                salesData: extractedDetails.salesData,
                imageDataUri: resizedImage,
            };

            setScanResult(result);
            setShowResult(true);
            onScanComplete({ ...result, imageDataUri: resizedImage });
            setTimeout(() => setShowResult(false), 3000);
        } catch (error: any) {
            console.error('Scan failed:', error);
            let description = 'An unknown error occurred during the scan.';
            if (error instanceof Error) {
                if (error.message.includes('Invalid image format')) {
                    description = 'The image format was invalid. Please try again with a JPEG or PNG.';
                } else if (error.message.includes('could not detect a player name')) {
                    description = 'The AI could not detect a player name on the card. Please try again with a clearer image.';
                } else {
                    description = error.message;
                }
            }
            toast({
                variant: 'destructive',
                title: 'Scan Failed',
                description,
            });
        } finally {
            setProcessingState('idle');
        }
    }, [processingState, playersToKeep, onScanComplete, toast]);

    const scan = useCallback(async () => {
        if (!videoRef.current || !canvasRef.current || !isCameraActive) return;

        const video = videoRef.current;
        const canvas = canvasRef.current;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        if (!context) return;

        context.clearRect(0, 0, canvas.width, canvas.height);
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageDataUri = canvas.toDataURL('image/jpeg');

        await processImage(imageDataUri);
    }, [isCameraActive, processImage]);

    const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onloadend = () => {
            const result = reader.result as string;
            processImage(result);
        };
        reader.readAsDataURL(file);
        // Reset input so same file can be selected again
        e.target.value = '';
    };

    const handleAddName = useCallback(() => {
        if (scanResult && !scanResult.isKeeper) {
            onAddNameToKeep(scanResult.name, scanResult.sport);
            setScanResult((prev) => (prev ? { ...prev, isKeeper: true } : null));
        }
    }, [onAddNameToKeep, scanResult]);

    const resultOverlayClasses = cn(
        'absolute inset-0 z-10 flex flex-col items-center justify-center p-4 text-center transition-opacity duration-300 text-white font-bold text-4xl font-headline tracking-wider',
        {
            'opacity-0 pointer-events-none': !showResult,
            'opacity-100': showResult,
            'bg-gradient-to-br from-yellow-400 via-red-500 to-pink-500': showResult && scanResult?.isPrizmRookie,
            'bg-green-500/80': showResult && scanResult?.isKeeper && !scanResult.isPrizmRookie,
            'bg-red-500/80': showResult && !scanResult?.isKeeper,
        }
    );

    return (
        <div className="w-full max-w-[12rem] aspect-[9/16] bg-black rounded-xl overflow-hidden shadow-2xl relative border-4 border-primary/50 cursor-pointer" onClick={isCameraActive ? scan : undefined}>
            <video
                ref={videoRef}
                autoPlay
                playsInline
                muted
                className={cn('w-full h-full object-cover', !isCameraActive && 'hidden')}
            />
            <canvas ref={canvasRef} className="hidden" />

            {!isCameraActive && !cameraError && (
                <div className="absolute inset-0 bg-black/80 flex flex-col items-center justify-center text-center p-4">
                    <Camera className="w-16 h-16 text-primary-foreground mb-4" />
                    <h3 className="text-xl font-bold text-white mb-2">Camera Off</h3>
                    <div className="flex flex-col gap-2 w-full">
                        <Button onClick={toggleCamera} size="sm" variant="secondary" className="w-full font-semibold">
                            Start Camera
                        </Button>
                        <div className="relative">
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept="image/*"
                                className="hidden"
                                onChange={handleFileUpload}
                            />
                            <Button onClick={() => fileInputRef.current?.click()} size="sm" variant="outline" className="w-full bg-transparent text-white border-white/30 hover:bg-white/10">
                                <Upload className="mr-2 h-3 w-3" />
                                Upload Image
                            </Button>
                        </div>
                    </div>
                </div>
            )}

            {isCameraActive && (
                <div className="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
                    <div
                        className="w-full h-auto border-2 border-dashed border-white/50 rounded-xl"
                        style={{ aspectRatio: '2.5 / 3.5' }}
                    />
                </div>
            )}

            {cameraError && (
                <div className="absolute inset-0 bg-black/80 flex flex-col items-center justify-center text-center p-4">
                    <CameraOff className="w-16 h-16 text-destructive mb-4" />
                    <h3 className="text-xl font-bold text-white mb-2">Camera Error</h3>
                    <p className="text-muted-foreground text-xs mb-4">{cameraError}</p>
                    <div className="relative w-full">
                        <input
                            ref={fileInputRef}
                            type="file"
                            accept="image/*"
                            className="hidden"
                            onChange={handleFileUpload}
                        />
                        <Button onClick={() => fileInputRef.current?.click()} size="sm" variant="outline" className="w-full bg-white text-black hover:bg-white/90">
                            <Upload className="mr-2 h-3 w-3" />
                            Upload Image Instead
                        </Button>
                    </div>
                </div>
            )}

            {processingState !== 'idle' && !showResult && (
                <div className="absolute inset-0 z-20 flex flex-col items-center justify-center bg-black/50 backdrop-blur-sm">
                    <Loader className="w-12 h-12 text-primary-foreground animate-spin mb-4" />
                    <p className="text-primary-foreground text-lg font-semibold">
                        {processingState === 'scanning' ? 'Scanning...' : 'Verifying...'}
                    </p>
                </div>
            )}

            <div className={resultOverlayClasses} onClick={() => setShowResult(false)}>
                {scanResult?.isPrizmRookie ? (
                    <div className="flex flex-col items-center gap-2 animate-pulse">
                        <Gem className="w-12 h-12" />
                        <p className="text-2xl">PRIZM ROOKIE!</p>
                    </div>
                ) : (
                    scanResult?.isKeeper ? 'KEEP' : 'DISCARD'
                )}
                <p className="text-xl font-body font-normal mt-2">
                    {scanResult?.name}
                </p>
                {showResult && scanResult && (
                    <div className="flex flex-col gap-2 mt-4">
                        {!scanResult.isKeeper && (
                            <Button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleAddName();
                                }}
                                variant="outline"
                                size="sm"
                                className="bg-white/20 hover:bg-white/30 text-white border-white"
                            >
                                <PlusCircle className="mr-2 h-4 w-4" />
                                Add to Keep List
                            </Button>
                        )}
                        <Button
                            onClick={(e) => {
                                e.stopPropagation();
                                handleListOnMarketplace();
                            }}
                            size="sm"
                            className="bg-primary hover:bg-primary/90"
                        >
                            <ShoppingCart className="mr-2 h-4 w-4" />
                            List on Marketplace
                        </Button>
                    </div>
                )}
            </div>

            <div className="absolute top-2 left-2 bg-black/50 p-2 rounded-lg text-white text-xs flex items-center gap-1">
                <Sparkles className="w-4 h-4 text-accent" />
                <span>AI Active</span>
                <div className={cn('w-2 h-2 rounded-full ml-1', isCameraActive ? 'bg-green-500' : 'bg-red-500')} />
            </div>
            {isCameraActive && (
                <div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/50 text-white text-xs px-3 py-1.5 rounded-full pointer-events-none">
                    Tap screen to scan
                </div>
            )}
            <button onClick={(e) => { e.stopPropagation(); toggleCamera(); }} className="absolute top-2 right-2 bg-black/50 p-2 rounded-full text-white text-xs z-30">
                {isCameraActive ? <CameraOff className="w-4 h-4" /> : <Camera className="w-4 h-4" />}
            </button>
        </div>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/research/history-log.tsx
--------------------------------------------------------------------------------

'use client';

import { Trash2, PlusCircle, ShoppingCart, DollarSign, TrendingUp } from 'lucide-react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import { formatDistanceToNow } from 'date-fns';
import type { ScanHistoryItem } from '@/lib/research-types';
import { formatCardDetails } from '@/lib/card-logic';

interface HistoryLogProps {
    history: ScanHistoryItem[];
    onDeleteItem: (id: string) => void;
    onAddNameToKeep: (name: string, sport?: string) => void;
}

export default function HistoryLog({
    history,
    onDeleteItem,
    onAddNameToKeep,
}: HistoryLogProps) {
    const router = useRouter();

    const handleListOnMarketplace = (item: ScanHistoryItem) => {
        const listingData = {
            title: `${item.name}${item.cardYear ? ` ${item.cardYear}` : ''}${item.brand ? ` ${item.brand}` : ''}${item.cardType ? ` ${item.cardType}` : ''}`,
            description: `${item.brand || 'Trading'} Card featuring ${item.name}${item.sport ? ` - ${item.sport}` : ''}${item.cardType ? ` ${item.cardType}` : ''}`,
            category: 'Collector Cards',
            subCategory: 'Trading Cards',
            year: item.cardYear,
            manufacturer: item.brand,
            imageDataUri: item.imageDataUri,
        };

        sessionStorage.setItem('researchScanData', JSON.stringify(listingData));
        router.push('/sell/create?from=research');
    };

    if (history.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center h-64 text-center p-4">
                <p className="text-muted-foreground">No scans yet</p>
                <p className="text-sm text-muted-foreground mt-2">
                    Use the camera to scan trading cards
                </p>
            </div>
        );
    }

    return (
        <ScrollArea className="h-[500px] pr-4">
            <div className="space-y-3">
                {history.map((item) => (
                    <div
                        key={item.id}
                        className={`p-4 rounded-lg border transition-all hover:shadow-md ${item.isPrizmRookie
                                ? 'border-yellow-400 bg-gradient-to-r from-yellow-50 to-pink-50'
                                : item.isKeeper
                                    ? 'border-green-300 bg-green-50'
                                    : 'border-gray-200 bg-white'
                            }`}
                    >
                        <div className="flex items-start justify-between gap-3">
                            <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1">
                                    <h3 className="font-semibold text-sm truncate">
                                        {item.name}
                                    </h3>
                                    {item.isPrizmRookie && (
                                        <Badge className="bg-gradient-to-r from-yellow-400 to-pink-500 text-white text-xs">
                                            PRIZM
                                        </Badge>
                                    )}
                                    {item.isKeeper && !item.isPrizmRookie && (
                                        <Badge variant="default" className="bg-green-600 text-xs">
                                            KEEP
                                        </Badge>
                                    )}
                                </div>

                                <p className="text-xs text-muted-foreground mb-2">
                                    {formatCardDetails(item)}
                                </p>

                                {item.salesData && item.salesData.averagePrice && (
                                    <div className="flex items-center gap-3 text-xs text-muted-foreground mb-2">
                                        <div className="flex items-center gap-1">
                                            <DollarSign className="w-3 h-3" />
                                            <span className="font-semibold text-green-600">
                                                ${item.salesData.averagePrice}
                                            </span>
                                            <span>avg</span>
                                        </div>
                                        {item.salesData.salesCount && (
                                            <div className="flex items-center gap-1">
                                                <TrendingUp className="w-3 h-3" />
                                                <span>{item.salesData.salesCount} sales</span>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <p className="text-xs text-muted-foreground">
                                    {formatDistanceToNow(item.timestamp, { addSuffix: true })}
                                </p>

                                <div className="flex gap-2 mt-3">
                                    <Button
                                        onClick={() => handleListOnMarketplace(item)}
                                        size="sm"
                                        variant="default"
                                        className="text-xs h-7"
                                    >
                                        <ShoppingCart className="w-3 h-3 mr-1" />
                                        List
                                    </Button>
                                    {!item.isKeeper && (
                                        <Button
                                            onClick={() => onAddNameToKeep(item.name, item.sport)}
                                            size="sm"
                                            variant="outline"
                                            className="text-xs h-7"
                                        >
                                            <PlusCircle className="w-3 h-3 mr-1" />
                                            Keep
                                        </Button>
                                    )}
                                </div>
                            </div>

                            <Button
                                onClick={() => onDeleteItem(item.id)}
                                variant="ghost"
                                size="icon"
                                className="h-8 w-8 text-muted-foreground hover:text-destructive"
                            >
                                <Trash2 className="h-4 w-4" />
                            </Button>
                        </div>
                    </div>
                ))}
            </div>
        </ScrollArea>
    );
}


--------------------------------------------------------------------------------
FILE: src/components/reviews/ReviewForm.tsx
--------------------------------------------------------------------------------


'use client';

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { collection, addDoc, serverTimestamp, query, where, getDocs } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';
import { useToast } from '@/hooks/use-toast';
import { Loader2, Star } from 'lucide-react';
import { cn } from '@/lib/utils';
import type { SafeUser } from '@/lib/types';
import Link from 'next/link';

const reviewSchema = z.object({
  rating: z.number().min(1, 'Rating is required').max(5),
  comment: z.string().min(10, 'Comment must be at least 10 characters long').max(1000),
});

interface ReviewFormProps {
  user: SafeUser;
  productId: string;
  productTitle: string;
  sellerId: string;
}

export default function ReviewForm({ user, productId, productTitle, sellerId }: ReviewFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [hoverRating, setHoverRating] = useState(0);
  const [hasReviewed, setHasReviewed] = useState(false); // Add this state
  const { toast } = useToast();

  const form = useForm<z.infer<typeof reviewSchema>>({
    resolver: zodResolver(reviewSchema),
    defaultValues: {
      rating: 0,
      comment: '',
    },
  });

   // Check if user has already reviewed this product
   useEffect(() => {
    if (!user) return;
    const checkReview = async () => {
        const q = query(
            collection(db, "reviews"),
            where("productId", "==", productId),
            where("buyerId", "==", user.uid)
        );
        const querySnapshot = await getDocs(q);
        if (!querySnapshot.empty) {
            setHasReviewed(true);
        }
    };
    checkReview();
  }, [user, productId]);


  async function onSubmit(values: z.infer<typeof reviewSchema>) {
    if (!user) {
      toast({ title: 'You must be signed in to leave a review.', variant: 'destructive' });
      return;
    }
    
    // Check if the user is trying to review their own product
    if (user.uid === sellerId) {
      toast({ title: "You can't review your own product.", variant: 'destructive' });
      return;
    }

    setIsSubmitting(true);
    try {
      await addDoc(collection(db, 'reviews'), {
        ...values,
        productId,
        productTitle,
        sellerId,
        buyerId: user.uid,
        buyerName: user.displayName,
        buyerAvatar: user.photoURL,
        createdAt: serverTimestamp(),
      });

      toast({ title: 'Review submitted successfully!' });
      form.reset();
      setHasReviewed(true); // Set hasReviewed to true after submission
    } catch (error: any) {
      console.error('Error submitting review:', error);
      toast({
        title: 'Failed to submit review.',
        description: error.message,
        variant: 'destructive',
      });
    } finally {
      setIsSubmitting(false);
    }
  }

  if (!user) {
    return (
      <div className="border rounded-lg p-6 text-center bg-gray-50">
        <p className="text-muted-foreground">
          <Button variant="link" asChild><Link href={`/sign-in?redirect=/product/${productId}`}>Sign in</Link></Button> to leave a review.
        </p>
      </div>
    );
  }
  
  if (hasReviewed) {
    return (
        <div className="border rounded-lg p-6 text-center bg-green-50 text-green-800">
            <p className="font-semibold">Thank you for your review!</p>
        </div>
    )
  }

  return (
    <div className="border rounded-lg p-6">
        <h3 className="text-lg font-semibold mb-4">Write a Review</h3>
        <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            <FormField
            control={form.control}
            name="rating"
            render={({ field }) => (
                <FormItem>
                <FormLabel>Your Rating</FormLabel>
                <FormControl>
                    <div className="flex items-center gap-1">
                    {[1, 2, 3, 4, 5].map((star) => (
                        <Star
                        key={star}
                        className={cn(
                            'h-8 w-8 cursor-pointer transition-colors',
                            (hoverRating >= star || field.value >= star)
                            ? 'text-yellow-400 fill-yellow-400'
                            : 'text-gray-300'
                        )}
                        onMouseEnter={() => setHoverRating(star)}
                        onMouseLeave={() => setHoverRating(0)}
                        onClick={() => field.onChange(star)}
                        />
                    ))}
                    </div>
                </FormControl>
                <FormMessage />
                </FormItem>
            )}
            />
            <FormField
            control={form.control}
            name="comment"
            render={({ field }) => (
                <FormItem>
                <FormLabel>Your Comment</FormLabel>
                <FormControl>
                    <Textarea
                    placeholder="Tell us about your experience with this item and seller..."
                    rows={4}
                    {...field}
                    />
                </FormControl>
                <FormMessage />
                </FormItem>
            )}
            />
            <Button type="submit" disabled={isSubmitting}>
            {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
            Submit Review
            </Button>
        </form>
        </Form>
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/reviews/ReviewList.tsx
--------------------------------------------------------------------------------


'use client';

import { Review } from '@/lib/types';
import { Card, CardContent } from '@/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Star, Loader2, MessageSquare } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { Skeleton } from '@/components/ui/skeleton';

interface ReviewListProps {
  reviews: Review[];
  isLoading: boolean;
}

function ReviewSkeleton() {
    return (
        <div className="flex gap-4">
            <Skeleton className="h-10 w-10 rounded-full" />
            <div className="flex-1 space-y-2">
                <Skeleton className="h-4 w-1/4" />
                <Skeleton className="h-4 w-full" />
                <Skeleton className="h-4 w-3/4" />
            </div>
        </div>
    )
}

export default function ReviewList({ reviews, isLoading }: ReviewListProps) {
  if (isLoading) {
    return (
        <div className="space-y-6">
            <ReviewSkeleton />
            <ReviewSkeleton />
        </div>
    )
  }

  if (reviews.length === 0) {
    return (
      <div className="text-center py-12 text-gray-500 border-2 border-dashed rounded-lg">
        <MessageSquare className="h-12 w-12 mx-auto mb-4 text-gray-300" />
        <h3 className="text-lg font-semibold">No reviews yet</h3>
        <p>Be the first to share your thoughts on this item.</p>
      </div>
    );
  }

  return (
    <div className="space-y-6 mt-6">
      {reviews.map((review) => (
        <Card key={review.id}>
          <CardContent className="p-6">
            <div className="flex gap-4">
              <Avatar>
                <AvatarImage src={review.buyerAvatar} alt={review.buyerName || 'Reviewer'} />
                <AvatarFallback>{review.buyerName?.[0]}</AvatarFallback>
              </Avatar>
              <div className="flex-1">
                <div className="flex items-center justify-between">
                  <h4 className="font-semibold">{review.buyerName}</h4>
                  <span className="text-xs text-muted-foreground">
                    {review.createdAt && formatDistanceToNow(review.createdAt.toDate(), { addSuffix: true })}
                  </span>
                </div>
                <div className="flex items-center gap-1 mt-1">
                  {[...Array(5)].map((_, i) => (
                    <Star
                      key={i}
                      className={`h-4 w-4 ${
                        i < review.rating ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300'
                      }`}
                    />
                  ))}
                </div>
                <p className="text-muted-foreground mt-3">{review.comment}</p>
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/search/SearchCommand.tsx
--------------------------------------------------------------------------------


"use client"

import * as React from "react"
import { useRouter } from "next/navigation"
import { Calculator, Calendar, CreditCard, Settings, Smile, User, Search, Home, ShoppingBag, Coins, Layers } from "lucide-react"

import {
    CommandDialog,
    CommandEmpty,
    CommandGroup,
    CommandInput,
    CommandItem,
    CommandList,
    CommandSeparator,
    CommandShortcut,
} from "@/components/ui/command"
import { DialogTitle, DialogDescription } from "../ui/dialog"

interface SearchCommandProps {
    open: boolean;
    setOpen: React.Dispatch<React.SetStateAction<boolean>>;
}

export function SearchCommand({ open, setOpen }: SearchCommandProps) {
    const router = useRouter()

    React.useEffect(() => {
        const down = (e: KeyboardEvent) => {
            if (e.key === "k" && (e.metaKey || e.ctrlKey)) {
                e.preventDefault()
                setOpen((prev: boolean) => !prev)
            }
        }

        document.addEventListener("keydown", down)
        return () => document.removeEventListener("keydown", down)
    }, [setOpen])

    const runCommand = React.useCallback((command: () => unknown) => {
        setOpen(false)
        command()
    }, [setOpen])

    const [search, setSearch] = React.useState("")

    const handleSearch = () => {
        if (!search) return;
        runCommand(() => router.push(`/browse?q=${encodeURIComponent(search)}`))
    }

    return (
        <CommandDialog open={open} onOpenChange={setOpen}>
            <DialogTitle className="sr-only">Search the site</DialogTitle>
            <DialogDescription className="sr-only">Use this command palette to search for products or navigate to different pages.</DialogDescription>
            <CommandInput
                placeholder="Type a command or search..."
                value={search}
                onValueChange={setSearch}
                onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                        handleSearch();
                    }
                }}
            />
            <CommandList>
                <CommandEmpty>No results found.</CommandEmpty>
                {search && (
                    <CommandGroup heading="Search">
                        <CommandItem onSelect={handleSearch}>
                            <Search className="mr-2 h-4 w-4" />
                            <span>Search for "{search}"</span>
                        </CommandItem>
                    </CommandGroup>
                )}
                <CommandGroup heading="Suggestions">
                    <CommandItem onSelect={() => runCommand(() => router.push('/browse'))}>
                        <ShoppingBag className="mr-2 h-4 w-4" />
                        <span>Browse All</span>
                    </CommandItem>
                    <CommandItem onSelect={() => runCommand(() => router.push('/collector-cards'))}>
                        <Layers className="mr-2 h-4 w-4" />
                        <span>Collector Cards</span>
                    </CommandItem>
                    <CommandItem onSelect={() => runCommand(() => router.push('/coins'))}>
                        <Coins className="mr-2 h-4 w-4" />
                        <span>Coins</span>
                    </CommandItem>
                </CommandGroup>
                <CommandSeparator />
                <CommandGroup heading="My Account">
                    <CommandItem onSelect={() => runCommand(() => router.push('/profile'))}>
                        <User className="mr-2 h-4 w-4" />
                        <span>Profile</span>
                    </CommandItem>
                    <CommandItem onSelect={() => runCommand(() => router.push('/sell/dashboard'))}>
                        <Settings className="mr-2 h-4 w-4" />
                        <span>Seller Dashboard</span>
                    </CommandItem>
                </CommandGroup>
            </CommandList>
        </CommandDialog>
    )
}


--------------------------------------------------------------------------------
FILE: src/components/sell/EbayPriceLookup.tsx
--------------------------------------------------------------------------------

'use client';

import { useState, useEffect } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { ExternalLink } from 'lucide-react';
import { Input } from '@/components/ui/input';

interface PriceLookupPopupProps {
  isOpen: boolean;
  onClose: () => void;
  searchParams?: {
    title?: string;
    year?: number;
  };
  onPriceSelect?: (price: number) => void;
}

export function EbayPriceLookup({ 
  isOpen, 
  onClose, 
  searchParams = {},
}: PriceLookupPopupProps) {
  const [searchQuery, setSearchQuery] = useState('');

  const { title, year } = searchParams;

  useEffect(() => {
    if (isOpen) {
      const parts = [];
      if (year) parts.push(year.toString());
      if (title) parts.push(title);
      const newQuery = parts.join(' ').trim();
      // eslint-disable-next-line react-hooks/set-state-in-effect
      setSearchQuery(prev => prev !== newQuery ? newQuery : prev);
    }
  }, [isOpen, title, year]);

  const handleSearchClick = () => {
    if (!searchQuery) return;
    // Construct eBay URL for "sold" items
    // _nkw: search query
    // LH_Sold=1: Sold items
    // LH_Complete=1: Completed listings (usually goes with Sold)
    const encodedQuery = encodeURIComponent(searchQuery);
    const ebayUrl = `https://www.ebay.com/sch/i.html?_nkw=${encodedQuery}&LH_Sold=1&LH_Complete=1&_ipg=60`;
    window.open(ebayUrl, '_blank', 'noopener,noreferrer');
    onClose();
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Research Sold Prices</DialogTitle>
          <DialogDescription>
             Search for similar sold items on eBay to determine a competitive price.
          </DialogDescription>
        </DialogHeader>
        
        <div className="flex items-center space-x-2 my-4">
          <Input 
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="e.g. 1999 Pokemon Charizard"
            onKeyDown={(e) => e.key === 'Enter' && handleSearchClick()}
          />
        </div>

        <DialogFooter className="sm:justify-start">
           <Button type="button" onClick={handleSearchClick} className="w-full sm:w-auto">
              <ExternalLink className="mr-2 h-4 w-4" />
              Search Sold Items on eBay
           </Button>
           <Button type="button" variant="secondary" onClick={onClose} className="w-full sm:w-auto mt-2 sm:mt-0">
             Close
           </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

--------------------------------------------------------------------------------
FILE: src/components/ui/EmptyState.tsx
--------------------------------------------------------------------------------

import { ShoppingBag, Search } from 'lucide-react';
import { Button } from './button';
import Link from 'next/link';
import { cn } from '@/lib/utils';
import { Inbox } from "lucide-react";

interface EmptyStateProps {
  title?: string;
  description?: string;
  icon?: React.ReactNode;
  className?: string;
  children?: React.ReactNode; 
  actionLabel?: string;
  href?: string;
}

export default function EmptyState({ 
  title = "No items found", 
  description = "We couldn't find any items matching your criteria.", 
  icon = <Search className="h-8 w-8 text-muted-foreground" />,
  actionLabel, 
  href,
  className,
  children
}: EmptyStateProps) {
  return (
    <div className={cn("flex flex-col items-center justify-center py-12 text-center border-2 border-dashed rounded-lg bg-muted/10", className)}>
      <div className="bg-background p-4 rounded-full mb-4 shadow-sm">
        {icon}
      </div>
      <h3 className="text-lg font-semibold">{title}</h3>
      <p className="text-muted-foreground max-w-sm mt-2 mb-6">{description}</p>
      {actionLabel && href && (
        <Button asChild>
          <Link href={href}>{actionLabel}</Link>
        </Button>
      )}
      {children}
    </div>
  );
}


--------------------------------------------------------------------------------
FILE: src/components/ui/accordion.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))

AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }


--------------------------------------------------------------------------------
FILE: src/components/ui/alert-dialog.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}


--------------------------------------------------------------------------------
FILE: src/components/ui/alert.tsx
--------------------------------------------------------------------------------

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }


--------------------------------------------------------------------------------
FILE: src/components/ui/avatar.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }


--------------------------------------------------------------------------------
FILE: src/components/ui/badge.tsx
--------------------------------------------------------------------------------

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }


--------------------------------------------------------------------------------
FILE: src/components/ui/button.tsx
--------------------------------------------------------------------------------

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }


--------------------------------------------------------------------------------
FILE: src/components/ui/camera-capture.tsx
--------------------------------------------------------------------------------

'use client';

import React, { useRef, useState, useCallback, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Camera, VideoOff, Trash2, CheckCircle, X, Loader2 } from 'lucide-react';
import { Dialog, DialogContent, DialogTrigger, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { ARCameraOverlay } from '@/components/ar-camera-overlay';
import { useToast } from '@/hooks/use-toast';
import Image from 'next/image';
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge';

interface CameraCaptureProps {
    onCapture: (files: File[]) => void;
    maxSizeMB?: number;
    captureMode?: 'card' | 'coin' | 'default';
    variant?: 'button' | 'hero';
    maxFiles?: number;
}

export function CameraCapture({ onCapture, maxSizeMB = 10, captureMode = 'default', variant = 'button', maxFiles = 4 }: CameraCaptureProps) {
    const videoRef = useRef<HTMLVideoElement>(null);
    const canvasRef = useRef<HTMLCanvasElement>(null);
    const [isDialogOpen, setIsDialogOpen] = useState(false);
    const [stream, setStream] = useState<MediaStream | null>(null);
    const [cameras, setCameras] = useState<MediaDeviceInfo[]>([]);
    const [selectedCamera, setSelectedCamera] = useState<string>('');
    const [hasCameraPermission, setHasCameraPermission] = useState<boolean | null>(null);
    const [error, setError] = useState<string | null>(null);
    const [isCameraLoading, setIsCameraLoading] = useState(false);

    // Multi-shot state
    const [capturedFiles, setCapturedFiles] = useState<File[]>([]);
    const [capturedPreviews, setCapturedPreviews] = useState<string[]>([]);

    const { toast } = useToast();

    // Cleanup previews on unmount or change
    useEffect(() => {
        return () => {
            capturedPreviews.forEach(url => URL.revokeObjectURL(url));
        };
    }, [capturedPreviews]);

    // Cleanup stream on unmount or stream change
    useEffect(() => {
        return () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        };
    }, [stream]);

    // Check for iOS Safari specifics on mount
    useEffect(() => {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        if (isIOS && isSafari) {
            // iOS Safari requires https or localhost
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                setError('Camera requires HTTPS on iOS Safari');
            }
        }
    }, []);


    const startCamera = useCallback(async (deviceId: string) => {
        setIsCameraLoading(true);
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        setError(null);

        try {
            // Constraints with fallback support
            const constraints: MediaStreamConstraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    aspectRatio: { ideal: 16 / 9 },
                    facingMode: deviceId ? undefined : 'environment' // Default to back camera
                }
            };

            const newStream = await navigator.mediaDevices.getUserMedia(constraints);
            setStream(newStream);
            setHasCameraPermission(true);

            if (videoRef.current) {
                videoRef.current.srcObject = newStream;
                // iOS Safari requires playing immediately
                await videoRef.current.play();
            }

            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            setCameras(videoDevices);
        } catch (err: any) {
            console.error("Error accessing camera:", err);

            // Retry with simpler constraints if it failed
            if (err.name === 'OverconstrainedError' || err.name === 'ConstraintNotSatisfiedError') {
                try {
                    const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    setStream(fallbackStream);
                    setHasCameraPermission(true);
                    if (videoRef.current) {
                        videoRef.current.srcObject = fallbackStream;
                        await videoRef.current.play();
                    }
                } catch (fallbackErr) {
                    setError("Could not access camera even with fallback settings.");
                    setHasCameraPermission(false);
                }
            } else {
                setError("Could not access the selected camera. It might be in use or permissions are denied.");
                setHasCameraPermission(false);
            }
        } finally {
            setIsCameraLoading(false);
        }
    }, [stream]);

    const initializeCamera = useCallback(async () => {
        setCapturedPreviews([]);
        setCapturedFiles([]);
        if (typeof navigator.mediaDevices?.getUserMedia !== 'function') {
            setError("Camera access is not supported by your browser.");
            setHasCameraPermission(false);
            return;
        }
        try {
            // iOS Safari: Check for Permission specifically if possible, otherwise just try
            // Note: navigator.permissions is not fully supported on iOS Safari yet, so we proceed to try getUserMedia

            // Try to get initial stream to prompt permission
            setIsCameraLoading(true);
            await navigator.mediaDevices.getUserMedia({ video: true }).then(s => s.getTracks().forEach(t => t.stop()));
            setHasCameraPermission(true);

            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');

            if (videoDevices.length === 0) {
                setError("No camera devices found.");
                setHasCameraPermission(false);
                return;
            }

            setCameras(videoDevices);
            const backCamera = videoDevices.find(d => d.label.toLowerCase().includes('back'));
            const selectedDeviceId = backCamera ? backCamera.deviceId : videoDevices[0].deviceId;
            setSelectedCamera(selectedDeviceId);
            await startCamera(selectedDeviceId);
        } catch (err) {
            console.error("Camera initialization failed:", err);
            setHasCameraPermission(false);
            setError("Camera permission was denied. Please enable it in your browser settings.");
        } finally {
            setIsCameraLoading(false);
        }
    }, [startCamera]);

    const stopStream = useCallback(() => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            setStream(null);
        }
    }, [stream]);

    const handleOpenChange = (open: boolean) => {
        setIsDialogOpen(open);
        if (open) {
            initializeCamera();
        } else {
            stopStream();
        }
    };

    const takePhoto = () => {
        if (!videoRef.current || !canvasRef.current || capturedFiles.length >= maxFiles) return;

        const video = videoRef.current;
        const canvas = canvasRef.current;
        const context = canvas.getContext('2d');
        if (!context) return;

        const videoWidth = video.videoWidth;
        const videoHeight = video.videoHeight;

        // Reset canvas dimensions to match the current video frame
        canvas.width = videoWidth;
        canvas.height = videoHeight;

        // Clear any previous drawing
        context.clearRect(0, 0, canvas.width, canvas.height);

        context.drawImage(video, 0, 0, videoWidth, videoHeight);

        canvas.toBlob((blob) => {
            if (blob) {
                const file = new File([blob], `capture_${Date.now()}.jpg`, { type: 'image/jpeg' });
                if (file.size > maxSizeMB * 1024 * 1024) {
                    toast({ title: 'Image too large', description: `The captured photo exceeds the ${maxSizeMB}MB limit.`, variant: 'destructive' });
                    return;
                }
                setCapturedFiles(prev => [...prev, file]);
                setCapturedPreviews(prev => [...prev, URL.createObjectURL(file)]);
            }
        }, 'image/jpeg', 0.9);
    };

    const removeCapturedImage = (indexToRemove: number) => {
        const urlToRemove = capturedPreviews[indexToRemove];
        URL.revokeObjectURL(urlToRemove);
        setCapturedPreviews(prev => prev.filter((_, index) => index !== indexToRemove));
        setCapturedFiles(prev => prev.filter((_, index) => index !== indexToRemove));
    };

    const handleDone = () => {
        onCapture(capturedFiles);
        setIsDialogOpen(false);
        stopStream();
    };

    return (
        <>
            <Dialog open={isDialogOpen} onOpenChange={handleOpenChange}>
                <DialogTrigger asChild>
                    {variant === 'hero' ? (
                        <div className="group relative aspect-square sm:aspect-video rounded-3xl border-2 border-solid border-indigo-600 bg-indigo-600/5 hover:bg-indigo-600/10 cursor-pointer flex flex-col items-center justify-center text-center p-6 transition-all shadow-sm hover:scale-[1.02] active:scale-[0.98]">
                            <div className="bg-indigo-600 p-5 rounded-full shadow-lg shadow-indigo-200 mb-4 group-hover:scale-110 transition-transform">
                                <Camera className="h-8 w-8 text-white" />
                            </div>
                            <h3 className="text-xl font-black text-indigo-900 tracking-tight">Use Camera</h3>
                            <p className="text-sm font-medium text-indigo-600/70 mt-2 max-w-[200px]">
                                Snap a photo from your <span className="font-bold">mobile device</span> or <span className="font-bold">computer camera</span>
                            </p>
                        </div>
                    ) : (
                        <Button variant="outline" className="gap-2">
                            <Camera className="w-4 h-4" /> Take Photo
                        </Button>
                    )}
                </DialogTrigger>
                <DialogContent className="max-w-4xl w-full p-0 gap-0 overflow-hidden bg-black border-slate-800">
                    <div className="absolute top-0 left-0 right-0 z-50 p-4 flex justify-between items-start bg-gradient-to-b from-black/80 to-transparent">
                        <div className="text-white">
                            <DialogTitle className="text-lg font-bold">Camera</DialogTitle>
                            <DialogDescription className="text-white/60 text-xs">
                                {capturedFiles.length} / {maxFiles} photos taken
                            </DialogDescription>
                        </div>
                        {cameras.length > 1 && (
                            <Select value={selectedCamera} onValueChange={(value) => { setSelectedCamera(value); startCamera(value); }} disabled={!hasCameraPermission}>
                                <SelectTrigger className="w-[140px] h-8 bg-white/10 border-white/20 text-white text-xs backdrop-blur-md">
                                    <SelectValue placeholder="Switch Camera" />
                                </SelectTrigger>
                                <SelectContent>
                                    {cameras.map(cam => (
                                        <SelectItem key={cam.deviceId} value={cam.deviceId}>
                                            {cam.label || `Camera ${cameras.indexOf(cam) + 1}`}
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        )}
                        <Button variant="ghost" size="icon" className="absolute top-2 right-2 text-white/70 hover:text-white" onClick={() => setIsDialogOpen(false)}><X /></Button>
                    </div>

                    <div className="relative w-full h-[60vh] md:h-[70vh] bg-black flex items-center justify-center overflow-hidden">
                        <video
                            ref={videoRef}
                            autoPlay
                            playsInline // REQUIRED for iOS Safari
                            muted
                            className="absolute inset-0 w-full h-full object-cover"
                        />
                        {isCameraLoading && (
                            <div className="absolute inset-0 flex items-center justify-center z-50 bg-black/50">
                                <Loader2 className="h-12 w-12 text-indigo-500 animate-spin" />
                            </div>
                        )}
                        {hasCameraPermission === false && !isCameraLoading && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/80 p-6 text-center z-40">
                                <VideoOff className="h-12 w-12 text-red-500 mb-4" />
                                <h3 className="text-white font-bold mb-2">Camera Access Denied</h3>
                                <p className="text-white/60 text-sm">{error || "Please check your browser settings."}</p>
                            </div>
                        )}
                        {hasCameraPermission && !isCameraLoading && <ARCameraOverlay guideType={captureMode === 'default' ? 'card' : captureMode} />}

                        <div className="absolute bottom-8 left-0 right-0 flex justify-center z-50">
                            <button
                                onClick={takePhoto}
                                disabled={!stream || !hasCameraPermission || capturedFiles.length >= maxFiles || isCameraLoading}
                                className={cn(
                                    "w-20 h-20 rounded-full border-4 border-white flex items-center justify-center transition-all active:scale-95",
                                    (capturedFiles.length >= maxFiles || isCameraLoading) ? "opacity-50 cursor-not-allowed border-slate-500" : "hover:bg-white/20"
                                )}
                            >
                                <div className="w-16 h-16 rounded-full bg-white shadow-lg" />
                            </button>
                        </div>
                    </div>

                    <div className="bg-slate-950 p-4 border-t border-white/10">
                        <div className="flex items-center gap-4 overflow-x-auto pb-4 scrollbar-thin scrollbar-thumb-white/20">
                            {capturedPreviews.map((url, idx) => (
                                <div key={url} className="relative flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border border-white/20 group">
                                    <Image src={url} alt={`Capture ${idx}`} className="w-full h-full object-cover" width={64} height={64} style={{ WebkitUserSelect: 'none', WebkitTransform: 'translateZ(0)' }} />
                                    <button
                                        onClick={() => removeCapturedImage(idx)}
                                        className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                                    >
                                        <Trash2 className="w-6 h-6 text-white" />
                                    </button>
                                    <Badge className="absolute bottom-0 right-0 rounded-none rounded-tl-md bg-indigo-600 px-1 py-0 text-[10px]">
                                        {idx + 1}
                                    </Badge>
                                </div>
                            ))}
                            {capturedFiles.length < maxFiles && (
                                <div className="w-16 h-16 rounded-lg border-2 border-dashed border-white/10 flex items-center justify-center text-white/20 text-xs">
                                    {maxFiles - capturedFiles.length} left
                                </div>
                            )}
                        </div>
                        <div className="flex gap-3 mt-2">
                            <Button
                                variant="outline"
                                className="flex-1 bg-transparent border-white/20 text-white hover:bg-white/10 hover:text-white"
                                onClick={() => setIsDialogOpen(false)}
                            >
                                Cancel
                            </Button>
                            <Button
                                className="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold"
                                onClick={handleDone}
                                disabled={capturedFiles.length === 0}
                            >
                                <CheckCircle className="w-4 h-4 mr-2" />
                                Add {capturedFiles.length} Photo{capturedFiles.length !== 1 && 's'}
                            </Button>
                        </div>
                    </div>
                </DialogContent>
            </Dialog>
            <canvas ref={canvasRef} className="hidden" />
        </>
    );
}

--------------------------------------------------------------------------------
FILE: src/components/ui/card.tsx
--------------------------------------------------------------------------------

import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }


--------------------------------------------------------------------------------
FILE: src/components/ui/carousel.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react"
import { ArrowLeft, ArrowRight } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: "horizontal" | "vertical"
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />")
  }

  return context
}

const Carousel = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & CarouselProps
>(
  (
    {
      orientation = "horizontal",
      opts,
      setApi,
      plugins,
      className,
      children,
      ...props
    },
    ref
  ) => {
    const [carouselRef, api] = useEmblaCarousel(
      {
        ...opts,
        axis: orientation === "horizontal" ? "x" : "y",
      },
      plugins
    )
    const [canScrollPrev, setCanScrollPrev] = React.useState(false)
    const [canScrollNext, setCanScrollNext] = React.useState(false)

    const onSelect = React.useCallback((api: CarouselApi) => {
      if (!api) {
        return
      }

      setCanScrollPrev(api.canScrollPrev())
      setCanScrollNext(api.canScrollNext())
    }, [])

    const scrollPrev = React.useCallback(() => {
      api?.scrollPrev()
    }, [api])

    const scrollNext = React.useCallback(() => {
      api?.scrollNext()
    }, [api])

    const handleKeyDown = React.useCallback(
      (event: React.KeyboardEvent<HTMLDivElement>) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault()
          scrollPrev()
        } else if (event.key === "ArrowRight") {
          event.preventDefault()
          scrollNext()
        }
      },
      [scrollPrev, scrollNext]
    )

    React.useEffect(() => {
      if (!api || !setApi) {
        return
      }

      setApi(api)
    }, [api, setApi])

    React.useEffect(() => {
      if (!api) {
        return
      }

      onSelect(api)
      api.on("reInit", onSelect)
      api.on("select", onSelect)

      return () => {
        api?.off("select", onSelect)
      }
    }, [api, onSelect])

    return (
      <CarouselContext.Provider
        value={{
          carouselRef,
          api: api,
          opts,
          orientation:
            orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
          scrollPrev,
          scrollNext,
          canScrollPrev,
          canScrollNext,
        }}
      >
        <div
          ref={ref}
          onKeyDownCapture={handleKeyDown}
          className={cn("relative", className)}
          role="region"
          aria-roledescription="carousel"
          {...props}
        >
          {children}
        </div>
      </CarouselContext.Provider>
    )
  }
)
Carousel.displayName = "Carousel"

const CarouselContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div ref={carouselRef} className="overflow-hidden">
      <div
        ref={ref}
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props}
      />
    </div>
  )
})
CarouselContent.displayName = "CarouselContent"

const CarouselItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { orientation } = useCarousel()

  return (
    <div
      ref={ref}
      role="group"
      aria-roledescription="slide"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props}
    />
  )
})
CarouselItem.displayName = "CarouselItem"

const CarouselPrevious = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute  h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-left-12 top-1/2 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft className="h-4 w-4" />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
})
CarouselPrevious.displayName = "CarouselPrevious"

const CarouselNext = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-right-12 top-1/2 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight className="h-4 w-4" />
      <span className="sr-only">Next slide</span>
    </Button>
  )
})
CarouselNext.displayName = "CarouselNext"

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}


--------------------------------------------------------------------------------
FILE: src/components/ui/checkbox.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }


--------------------------------------------------------------------------------
FILE: src/components/ui/collapsible.tsx
--------------------------------------------------------------------------------

"use client"

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

const Collapsible = CollapsiblePrimitive.Root

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent

export { Collapsible, CollapsibleTrigger, CollapsibleContent }


--------------------------------------------------------------------------------
FILE: src/components/ui/command.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import { type DialogProps } from "@radix-ui/react-dialog"
import { Command as CommandPrimitive } from "cmdk"
import { Search } from "lucide-react"

import { cn } from "@/lib/utils"
import { Dialog, DialogContent } from "@/components/ui/dialog"

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className
    )}
    {...props}
  />
))
Command.displayName = CommandPrimitive.displayName

interface CommandDialogProps extends DialogProps {}

const CommandDialog = ({ children, ...props }: CommandDialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0 shadow-lg">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    />
  </div>
))

CommandInput.displayName = CommandPrimitive.Input.displayName

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
))

CommandList.displayName = CommandPrimitive.List.displayName

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => (
  <CommandPrimitive.Empty
    ref={ref}
    className="py-6 text-center text-sm"
    {...props}
  />
))

CommandEmpty.displayName = CommandPrimitive.Empty.displayName

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className
    )}
    {...props}
  />
))

CommandGroup.displayName = CommandPrimitive.Group.displayName

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 h-px bg-border", className)}
    {...props}
  />
))
CommandSeparator.displayName = CommandPrimitive.Separator.displayName

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none aria-selected:bg-accent aria-selected:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  />
))

CommandItem.displayName = CommandPrimitive.Item.displayName

const CommandShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
CommandShortcut.displayName = "CommandShortcut"

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandSeparator,
  CommandShortcut,
}

--------------------------------------------------------------------------------
FILE: src/components/ui/dialog.tsx
--------------------------------------------------------------------------------


"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}


--------------------------------------------------------------------------------
FILE: src/components/ui/dropdown-menu.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}


--------------------------------------------------------------------------------
FILE: src/components/ui/form.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  FormProvider,
  useFormContext,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState, formState } = useFormContext()

  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

const FormItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div ref={ref} className={cn("space-y-2", className)} {...props} />
    </FormItemContext.Provider>
  )
})
FormItem.displayName = "FormItem"

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField()

  return (
    <Label
      ref={ref}
      className={cn(error && "text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
})
FormLabel.displayName = "FormLabel"

const FormControl = React.forwardRef<
  React.ElementRef<typeof Slot>,
  React.ComponentPropsWithoutRef<typeof Slot>
>(({ ...props }, ref) => {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      ref={ref}
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
})
FormControl.displayName = "FormControl"

const FormDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
  const { formDescriptionId } = useFormField()

  return (
    <p
      ref={ref}
      id={formDescriptionId}
      className={cn("text-sm text-muted-foreground", className)}
      {...props}
    />
  )
})
FormDescription.displayName = "FormDescription"

const FormMessage = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? "") : children

  if (!body) {
    return null
  }

  return (
    <p
      ref={ref}
      id={formMessageId}
      className={cn("text-sm font-medium text-destructive", className)}
      {...props}
    >
      {body}
    </p>
  )
})
FormMessage.displayName = "FormMessage"

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}


--------------------------------------------------------------------------------
FILE: src/components/ui/input.tsx
--------------------------------------------------------------------------------

import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }


--------------------------------------------------------------------------------
FILE: src/components/ui/label.tsx
--------------------------------------------------------------------------------


"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }


--------------------------------------------------------------------------------
FILE: src/components/ui/navigation-menu.tsx
--------------------------------------------------------------------------------


"use client"

import * as React from "react"
import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu"
import { cva } from "class-variance-authority"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const NavigationMenu = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Root
    ref={ref}
    className={cn(
      "relative z-10 flex max-w-max flex-1 items-center justify-center",
      className
    )}
    {...props}
  >
    {children}
    <NavigationMenuViewport />
  </NavigationMenuPrimitive.Root>
))
NavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName

const NavigationMenuList = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.List
    ref={ref}
    className={cn(
      "group flex flex-1 list-none items-center justify-center space-x-1",
      className
    )}
    {...props}
  />
))
NavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName

const NavigationMenuItem = NavigationMenuPrimitive.Item

const navigationMenuTriggerStyle = cva(
  "group inline-flex h-10 w-max items-center justify-center rounded-md bg-transparent px-4 py-2 text-sm font-medium transition-colors hover:bg-secondary hover:text-secondary-foreground focus:bg-secondary focus:text-secondary-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-secondary/50 data-[state=open]:bg-secondary/50"
)

const NavigationMenuTrigger = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Trigger
    ref={ref}
    className={cn(navigationMenuTriggerStyle(), "group", className)}
    {...props}
  >
    {children}{" "}
    <ChevronDown
      className="relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180"
      aria-hidden="true"
    />
  </NavigationMenuPrimitive.Trigger>
))
NavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName

const NavigationMenuContent = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Content
    ref={ref}
    className={cn(
      "left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto ",
      className
    )}
    {...props}
  />
))
NavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName

const NavigationMenuLink = NavigationMenuPrimitive.Link

const NavigationMenuViewport = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>
>(({ className, ...props }, ref) => (
  <div className={cn("absolute left-0 top-full flex justify-center w-full")}>
    <NavigationMenuPrimitive.Viewport
      className={cn(
        "origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-b-lg border-t bg-background/95 backdrop-blur-sm shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90",
        className
      )}
      ref={ref}
      {...props}
    />
  </div>
))
NavigationMenuViewport.displayName =
  NavigationMenuPrimitive.Viewport.displayName

const NavigationMenuIndicator = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Indicator
    ref={ref}
    className={cn(
      "top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in",
      className
    )}
    {...props}
  >
    <div className="relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md" />
  </NavigationMenuPrimitive.Indicator>
))
NavigationMenuIndicator.displayName =
  NavigationMenuPrimitive.Indicator.displayName

export {
  navigationMenuTriggerStyle,
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
}


--------------------------------------------------------------------------------
FILE: src/components/ui/popover.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }


--------------------------------------------------------------------------------
FILE: src/components/ui/progress.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-4 w-full overflow-hidden rounded-full bg-secondary",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }


--------------------------------------------------------------------------------
FILE: src/components/ui/radio-group.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Root
      className={cn("grid gap-2", className)}
      {...props}
      ref={ref}
    />
  )
})
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-2.5 w-2.5 fill-current text-current" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
})
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName

export { RadioGroup, RadioGroupItem }


--------------------------------------------------------------------------------
FILE: src/components/ui/scroll-area.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }


--------------------------------------------------------------------------------
FILE: src/components/ui/select.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}


--------------------------------------------------------------------------------
FILE: src/components/ui/separator.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }


--------------------------------------------------------------------------------
FILE: src/components/ui/sheet.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}


--------------------------------------------------------------------------------
FILE: src/components/ui/sidebar.tsx
--------------------------------------------------------------------------------


"use client"

import * as React from "react"
import { cva } from "class-variance-authority"
import { cn } from "@/lib/utils"
import { useSidebar } from "@/components/layout/sidebar-provider"
import { Button } from "./button"
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "./tooltip"
import { PanelLeftClose, PanelRightClose } from "lucide-react"

const Sidebar = React.forwardRef<
  HTMLElement,
  React.ComponentProps<"aside">
>(({ className, onMouseEnter, onMouseLeave, ...props }, ref) => {
  const { isSidebarOpen, isHovered, setIsHovered } = useSidebar()
  const effectiveOpen = isSidebarOpen || isHovered

  return (
    <aside
      ref={ref}
      onMouseEnter={(e) => {
        setIsHovered(true)
        onMouseEnter?.(e)
      }}
      onMouseLeave={(e) => {
        setIsHovered(false)
        onMouseLeave?.(e)
      }}
      className={cn(
        "flex flex-col border-r transition-all duration-300 ease-in-out bg-background z-40",
        effectiveOpen ? "w-64" : "w-20",
        className
      )}
      {...props}
    />
  )
})
Sidebar.displayName = "Sidebar"

const SidebarHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { isSidebarOpen, isHovered } = useSidebar()
  const effectiveOpen = isSidebarOpen || isHovered

  return (
    <div
      ref={ref}
      className={cn(
        "flex h-16 items-center border-b px-4 shrink-0 transition-all",
        !effectiveOpen && "justify-center px-0",
        className
      )}
      {...props}
    />
  )
})
SidebarHeader.displayName = "SidebarHeader"

const SidebarContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("flex-1 overflow-x-hidden overflow-y-auto", className)} {...props} />
))
SidebarContent.displayName = "SidebarContent"

const SidebarFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("mt-auto p-4 border-t", className)}
    {...props}
  />
))
SidebarFooter.displayName = "SidebarFooter"

const SidebarMenu = React.forwardRef<
  HTMLElement,
  React.HTMLAttributes<HTMLElement>
>(({ className, ...props }, ref) => (
  <nav ref={ref} className={cn("flex flex-col gap-1", className)} {...props} />
))
SidebarMenu.displayName = "SidebarMenu"

const SidebarMenuItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("", className)} {...props} />
))
SidebarMenuItem.displayName = "SidebarMenuItem"

const SidebarMenuButton = React.forwardRef<
  React.ElementRef<typeof Button>,
  React.ComponentProps<typeof Button> & {
    isActive?: boolean
    tooltip?: string
  }
>(({ className, isActive, tooltip, children, ...props }, ref) => {
  const { isSidebarOpen, isHovered } = useSidebar()
  const effectiveOpen = isSidebarOpen || isHovered

  const buttonContent = (
    <Button
      ref={ref}
      variant={isActive ? "secondary" : "ghost"}
      className={cn(
        "w-full justify-start gap-3 transition-all",
        !effectiveOpen && "justify-center px-2",
        className
      )}
      {...props}
    >
      {React.Children.map(children, (child, index) => {
        // Icon - always show (first child)
        if (index === 0 && React.isValidElement(child)) {
          return React.cloneElement(child, {
            className: cn("h-5 w-5 shrink-0", (child.props as any).className),
          } as any)
        }
        // Text - show only when expanded (second child)
        if (index === 1) {
          // Handle both direct strings and span elements with text
          if (typeof child === "string" || (React.isValidElement(child) && child.type === "span")) {
            const text = typeof child === "string" ? child : child.props.children
            return (
              <span
                className={cn(
                  "whitespace-nowrap transition-all duration-300 overflow-hidden",
                  effectiveOpen
                    ? "opacity-100 translate-x-0 max-w-full"
                    : "opacity-0 max-w-0 -translate-x-2 pointer-events-none absolute"
                )}
              >
                {text}
              </span>
            )
          }
        }
        // Any other children (like motion.div for active indicator)
        if (index > 1) {
          return child
        }
        return null
      })}
    </Button>
  )

  if (!effectiveOpen && tooltip) {
    return (
      <TooltipProvider delayDuration={100}>
        <Tooltip>
          <TooltipTrigger asChild>{buttonContent}</TooltipTrigger>
          <TooltipContent side="right" className="ml-2">
            {tooltip}
          </TooltipContent>
        </Tooltip>
      </TooltipProvider>
    )
  }

  return buttonContent
})
SidebarMenuButton.displayName = "SidebarMenuButton"


const SidebarTrigger = React.forwardRef<
  React.ElementRef<typeof Button>,
  React.ComponentProps<typeof Button>
>(({ className, ...props }, ref) => {
  const { isSidebarOpen, setIsSidebarOpen } = useSidebar();
  return (
    <Button
      ref={ref}
      variant="ghost"
      size="icon"
      onClick={() => setIsSidebarOpen(!isSidebarOpen)}
      className={cn("hidden lg:flex", className)}
      {...props}
    >
      {isSidebarOpen ? <PanelLeftClose /> : <PanelRightClose />}
      <span className="sr-only">Toggle sidebar</span>
    </Button>
  )
})
SidebarTrigger.displayName = "SidebarTrigger"


export {
  Sidebar,
  SidebarHeader,
  SidebarContent,
  SidebarFooter,
  SidebarMenu,
  SidebarMenuItem,
  SidebarMenuButton,
  SidebarTrigger,
}


--------------------------------------------------------------------------------
FILE: src/components/ui/skeleton.tsx
--------------------------------------------------------------------------------

import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-primary/10", className)}
      {...props}
    />
  )
}

export { Skeleton }


--------------------------------------------------------------------------------
FILE: src/components/ui/slider.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"

import { cn } from "@/lib/utils"

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex w-full touch-none select-none items-center",
      className
    )}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-2 w-full grow overflow-hidden rounded-full bg-secondary">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
))
Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }


--------------------------------------------------------------------------------
FILE: src/components/ui/switch.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }


--------------------------------------------------------------------------------
FILE: src/components/ui/table.tsx
--------------------------------------------------------------------------------

import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}


--------------------------------------------------------------------------------
FILE: src/components/ui/tabs.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }


--------------------------------------------------------------------------------
FILE: src/components/ui/textarea.tsx
--------------------------------------------------------------------------------

import * as React from 'react';

import {cn} from '@/lib/utils';

const Textarea = React.forwardRef<HTMLTextAreaElement, React.ComponentProps<'textarea'>>(
  ({className, ...props}, ref) => {
    return (
      <textarea
        className={cn(
          'flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm',
          className
        )}
        ref={ref}
        {...props}
      />
    );
  }
);
Textarea.displayName = 'Textarea';

export {Textarea};


--------------------------------------------------------------------------------
FILE: src/components/ui/toast.tsx
--------------------------------------------------------------------------------

"use client"

import * as React from "react"
import * as ToastPrimitives from "@radix-ui/react-toast"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const ToastProvider = ToastPrimitives.Provider

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
      className
    )}
    {...props}
  />
))
ToastViewport.displayName = ToastPrimitives.Viewport.displayName

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
  {
    variants: {
      variant: {
        default: "border bg-background text-foreground",
        destructive:
          "destructive group border-destructive bg-destructive text-destructive-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
    VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  )
})
Toast.displayName = ToastPrimitives.Root.displayName

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
      className
    )}
    {...props}
  />
))
ToastAction.displayName = ToastPrimitives.Action.displayName

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
))
ToastClose.displayName = ToastPrimitives.Close.displayName

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn("text-sm font-semibold", className)}
    {...props}
  />
))
ToastTitle.displayName = ToastPrimitives.Title.displayName

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn("text-sm opacity-90", className)}
    {...props}
  />
))
ToastDescription.displayName = ToastPrimitives.Description.displayName

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>

type ToastActionElement = React.ReactElement<typeof ToastAction>

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
}


--------------------------------------------------------------------------------
FILE: src/components/ui/toaster.tsx
--------------------------------------------------------------------------------

"use client"

import { useToast } from "@/hooks/use-toast"
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from "@/components/ui/toast"

export function Toaster() {
  const { toasts } = useToast()

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action}
            <ToastClose />
          </Toast>
        )
      })}
      <ToastViewport />
    </ToastProvider>
  )
}


--------------------------------------------------------------------------------
FILE: src/components/ui/tooltip.tsx
--------------------------------------------------------------------------------


"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Portal>
    <TooltipPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </TooltipPrimitive.Portal>
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }

