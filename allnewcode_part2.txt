--- PART 2 START ---
================================================================================
FILE: src/components/layout/PageHeader.tsx
================================================================================

interface PageHeaderProps {
    title: string;
    description?: string;
}

export function PageHeader({ title, description }: PageHeaderProps) {
    return (
        <div className="mb-6 sm:mb-8">
            <h1 className="text-3xl sm:text-4xl md:text-5xl font-bold tracking-tight text-primary font-headline">
                {title}
            </h1>
            {description && (
                <p className="mt-3 sm:mt-4 text-base sm:text-lg text-muted-foreground max-w-3xl">
                    {description}
                </p>
            )}
        </div>
    )
}

================================================================================
FILE: src/components/layout/collapsible-sidebar-layout.tsx
================================================================================

'use client';

import React, { useState, type ReactNode } from 'react';
import { cn } from '@/lib/utils';
import { useSidebar } from './sidebar-provider';
import { Button } from '@/components/ui/button';
import { PanelLeftClose, PanelRightClose } from 'lucide-react';

function CollapsibleSidebarLayoutInner({ children, sidebar }: { children: ReactNode, sidebar: ReactNode }) {
  const { isSidebarOpen } = useSidebar();

  return (
    <div className="flex min-h-screen w-full">
      <aside
        className={cn(
          'relative bg-card border-r z-40 transition-all duration-300 ease-in-out hidden lg:block',
          isSidebarOpen ? 'w-64' : 'w-20'
        )}
      >
        <div className="flex flex-col h-full overflow-hidden">
          {sidebar}
        </div>
      </aside>

      <div className="flex flex-col flex-1 overflow-auto">
        {children}
      </div>
    </div>
  );
}


export function CollapsibleSidebarLayout({ children, sidebar }: { children: ReactNode, sidebar: ReactNode }) {
    return (
        <CollapsibleSidebarLayoutInner sidebar={sidebar}>
            {children}
        </CollapsibleSidebarLayoutInner>
    )
}

================================================================================
FILE: src/components/layout/main-nav.tsx
================================================================================

"use client"

import { MainNavLinks } from './MainNavLinks';

export function MainNav() {
  return (
    <nav className="hidden md:flex items-center space-x-6 text-sm font-medium">
      <MainNavLinks />
    </nav>
  );
}

================================================================================
FILE: src/components/layout/mobile-nav.tsx
================================================================================

'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Sheet, SheetContent, SheetTrigger } from '@/components/ui/sheet';
import { Menu } from 'lucide-react';
import { Logo } from '@/components/logo';
import { MobileNavContent } from './MobileNavContent';
import Link from 'next/link';

export function MobileNav() {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <Sheet open={isOpen} onOpenChange={setIsOpen}>
      <SheetTrigger asChild>
        <Button variant="ghost" size="icon" className="md:hidden">
          <Menu className="h-6 w-6" />
          <span className="sr-only">Toggle navigation menu</span>
        </Button>
      </SheetTrigger>
      <SheetContent side="left" className="p-0">
        <div className="flex h-full flex-col">
          <div className="border-b p-4">
             <Link href="/" onClick={() => setIsOpen(false)} aria-label="Back to homepage">
              <Logo />
            </Link>
          </div>
          <MobileNavContent setIsOpen={setIsOpen} />
        </div>
      </SheetContent>
    </Sheet>
  );
}

================================================================================
FILE: src/components/layout/page-transition.tsx
================================================================================
'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { usePathname } from 'next/navigation';

export function PageTransition({ children }: { children: React.ReactNode }) {
    const pathname = usePathname();

    return (
        <AnimatePresence mode="wait">
            <motion.div
                key={pathname}
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                transition={{ duration: 0.3, ease: 'easeOut' }}
            >
                {children}
            </motion.div>
        </AnimatePresence>
    );
}

================================================================================
FILE: src/components/layout/search-bar.tsx
================================================================================

'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Input } from '@/components/ui/input';
import { Search } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from '../ui/button';

export function SearchBar({ className, inputClassName, buttonClassName }: { className?: string; inputClassName?: string; buttonClassName?: string; }) {
  const [searchTerm, setSearchTerm] = useState('');
  const router = useRouter();

  const handleSearch = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    if (searchTerm.trim()) {
      router.push(`/browse?q=${encodeURIComponent(searchTerm.trim())}`);
    }
  };

  return (
    <form onSubmit={handleSearch} className={cn("relative w-full", className)}>
      <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-primary" />
      <Input
        type="search"
        placeholder="Find your next holy grail with AI..."
        className={cn("w-full pl-10 bg-[#e7ebf3] dark:bg-white/5 border-transparent focus:bg-white dark:focus:bg-background-dark focus-within:border-primary/50", inputClassName)}
        value={searchTerm}
        onChange={(e) => setSearchTerm(e.target.value)}
      />
       <div className="absolute right-3 top-1/2 -translate-y-1/2 flex items-center">
            <kbd className="hidden sm:inline-flex items-center gap-1 rounded border bg-white dark:bg-white/10 px-1.5 font-mono text-[10px] font-medium text-muted-foreground">
                <span className="text-xs">âŒ˜</span>K
            </kbd>
            {buttonClassName && <Button type="submit" className={buttonClassName}>AI Search</Button>}
        </div>
    </form>
  );
}

================================================================================
FILE: src/components/layout/sidebar-provider.tsx
================================================================================

'use client';

import React, { createContext, useContext, useState, useEffect } from 'react';
import { usePathname } from 'next/navigation';

interface SidebarContextType {
    isSidebarOpen: boolean;
    setIsSidebarOpen: React.Dispatch<React.SetStateAction<boolean>>;
    isHovered: boolean;
    setIsHovered: React.Dispatch<React.SetStateAction<boolean>>;
    isSellingSection: boolean;
    setIsSellingSection: React.Dispatch<React.SetStateAction<boolean>>;
}

const SidebarContext = createContext<SidebarContextType | undefined>(undefined);

export function useSidebar() {
    const context = useContext(SidebarContext);
    if (!context) {
        throw new Error('useSidebar must be used within a SidebarProvider');
    }
    return context;
}

export function SidebarProvider({ children }: { children: React.ReactNode }) {
    const [isSidebarOpen, setIsSidebarOpen] = useState(false);
    const [isHovered, setIsHovered] = useState(false);
    const [isSellingSection, setIsSellingSection] = useState(false);
    
    // This provider will wrap layouts that need a sidebar.
    return (
        <SidebarContext.Provider value={{ 
            isSidebarOpen, 
            setIsSidebarOpen, 
            isHovered, 
            setIsHovered,
            isSellingSection, 
            setIsSellingSection 
        }}>
            {children}
        </SidebarContext.Provider>
    );
}

================================================================================
FILE: src/components/layout/sidebar-toggle.tsx
================================================================================

'use client';

import { Button } from '@/components/ui/button';
import { PanelLeftClose, PanelRightClose } from 'lucide-react';
import { useSidebar } from './sidebar-provider';

export function SidebarToggle() {
    const { isSidebarOpen, setIsSidebarOpen } = useSidebar();
    
    return (
        <Button 
            variant="ghost" 
            size="icon" 
            onClick={() => setIsSidebarOpen(!isSidebarOpen)}
            className="hidden lg:flex"
        >
            {isSidebarOpen ? <PanelLeftClose /> : <PanelRightClose />}
            <span className="sr-only">Toggle sidebar</span>
        </Button>
    )
}

================================================================================
FILE: src/components/layout/user-nav.tsx
================================================================================


"use client";

import Link from 'next/link';
import { useUser, useDoc, useMemoFirebase } from '@/firebase';
import { signOutUser } from '@/lib/firebase/auth';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Skeleton } from '@/components/ui/skeleton';
import { useRouter } from 'next/navigation';
import { Shield, Zap } from 'lucide-react';
import { doc } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import { UserProfile } from '@/lib/types';
import { useUserPermissions } from '@/hooks/use-user-permissions';
import { SUPER_ADMIN_EMAILS, SUPER_ADMIN_UIDS } from '@/lib/constants';


export function UserNav() {
  const { user, isUserLoading } = useUser();
  const { canSell, isSuperAdmin: isClaimSuperAdmin, isLoading: permissionsLoading } = useUserPermissions();
  const isSuperAdmin = isClaimSuperAdmin || (user?.uid && SUPER_ADMIN_UIDS.includes(user.uid)) || (user?.email && SUPER_ADMIN_EMAILS.includes(user.email));
  const router = useRouter();

  const handleSignOut = async () => {
    await signOutUser();
    router.push('/');
    router.refresh();
  };

  if (isUserLoading) {
    return <Skeleton className="h-10 w-10 rounded-full" />;
  }

  if (!user) {
    return (
      <div className="flex items-center gap-2">
        <Button asChild variant="ghost" size="sm">
          <Link href="/sign-in">Sign In</Link>
        </Button>
        <Button asChild size="sm">
          <Link href="/sign-up">Sign Up</Link>
        </Button>
      </div>
    );
  }

  const getInitials = (name?: string | null) => {
    if (!name) return 'U';
    const names = name.split(' ');
    if (names.length > 1) {
      return `${names[0][0]}${names[names.length - 1][0]}`;
    }
    return name[0];
  };

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" className="relative h-10 w-10 rounded-full">
          <Avatar className="h-10 w-10">
            <AvatarImage src={user.photoURL || ''} alt={user.displayName || 'User'} />
            <AvatarFallback>{getInitials(user.displayName)}</AvatarFallback>
          </Avatar>
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent className="w-56" align="end" forceMount>
        <DropdownMenuLabel className="font-normal">
          <div className="flex flex-col space-y-1">
            <p className="text-sm font-medium leading-none">{user.displayName || 'User'}</p>
            <p className="text-xs leading-none text-muted-foreground">{user.email}</p>
          </div>
        </DropdownMenuLabel>
        <DropdownMenuSeparator />
        {isSuperAdmin && (
          <>
            <DropdownMenuItem asChild>
              <Link href="/admin">
                <Shield className="mr-2 h-4 w-4" />
                <span>Admin Dashboard</span>
              </Link>
            </DropdownMenuItem>
            <DropdownMenuItem asChild>
              <Link href="/admin/power-tools">
                <Zap className="mr-2 h-4 w-4" />
                <span>Power Tools</span>
              </Link>
            </DropdownMenuItem>
          </>
        )}
        <DropdownMenuGroup>
          <DropdownMenuItem asChild>
            <Link href="/profile">Profile</Link>
          </DropdownMenuItem>
          {canSell && (
            <DropdownMenuItem asChild>
              <Link href="/sell/dashboard">Seller Dashboard</Link>
            </DropdownMenuItem>
          )}
          <DropdownMenuItem asChild>
            <Link href="/profile/favorites">My Favorites</Link>
          </DropdownMenuItem>
          {canSell && (
            <DropdownMenuItem asChild>
              <Link href="/profile/listings">My Listings</Link>
            </DropdownMenuItem>
          )}
        </DropdownMenuGroup>
        <DropdownMenuSeparator />
        {canSell && (
          <DropdownMenuItem asChild>
            <Link href="/sell/create">Sell Item</Link>
          </DropdownMenuItem>
        )}
        <DropdownMenuSeparator />
        <DropdownMenuItem onClick={handleSignOut}>
          Sign out
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

================================================================================
FILE: src/components/logo.tsx
================================================================================
import { Sparkles } from 'lucide-react';
import { cn } from '@/lib/utils';

export function Logo({ className }: { className?: string }) {
    return (
        <div className={cn("flex items-center gap-2 text-primary", className)}>
            <div className="size-8 bg-primary rounded-lg flex items-center justify-center text-white">
                <Sparkles className="h-5 w-5" />
            </div>
            <h2 className="text-[#0d121b] dark:text-white text-xl font-black leading-tight tracking-tight">Picksy</h2>
        </div>
    );
}

================================================================================
FILE: src/components/notifications/NotificationBell.tsx
================================================================================


'use client';

import { useState, useEffect, useTransition, useMemo } from 'react';
import { useUser, useCollection, useMemoFirebase } from '@/firebase';
import { getUserNotifications, markAllAsRead, markAsRead } from '@/services/notifications';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Badge } from '@/components/ui/badge';
import { Bell, Loader2, Check } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { cn } from '@/lib/utils';
import Link from 'next/link';
import { Notification } from '@/lib/types';
import { query, collection, where, orderBy, limit } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';

export function NotificationBell() {
  const { user } = useUser();
  const [isOpen, setIsOpen] = useState(false);
  const [isPending, startTransition] = useTransition();

  const notificationsQuery = useMemoFirebase(() => {
    if (!user?.uid) return null;
    return query(
        collection(db, 'notifications'),
        where('recipientId', '==', user.uid),
        orderBy('createdAt', 'desc'), 
        limit(20)
    );
  }, [user?.uid]);

  const { data: notifications, isLoading } = useCollection<Notification>(notificationsQuery);
  
  const unreadCount = notifications?.filter(n => !n.read).length || 0;

  const handleMarkAllRead = () => {
    if (!user?.uid || unreadCount === 0) return;
    startTransition(async () => {
      await markAllAsRead(user.uid);
    });
  };

  const handleNotificationClick = async (notification: Notification) => {
    if (!notification.read) {
        await markAsRead(notification.id);
    }
    // Note: navigation is handled by the Link component
  };

  return (
    <DropdownMenu open={isOpen} onOpenChange={setIsOpen}>
      <DropdownMenuTrigger asChild>
        <Button
          variant="ghost"
          size="icon"
          className="relative"
          aria-label={`View notifications (${unreadCount} unread)`}
        >
          <Bell className="h-5 w-5" />
          {unreadCount > 0 && (
            <span className="absolute top-1 right-1 flex h-4 w-4 items-center justify-center rounded-full bg-destructive text-xs font-bold text-white">
              {unreadCount}
            </span>
          )}
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent className="w-80 md:w-96" align="end">
        <div className="flex items-center justify-between p-2">
            <DropdownMenuLabel>Notifications</DropdownMenuLabel>
            {unreadCount > 0 && (
                <Button variant="ghost" size="sm" onClick={handleMarkAllRead} disabled={isPending}>
                    {isPending ? <Loader2 className="w-4 h-4 animate-spin"/> : <Check className="w-4 h-4 mr-1" />}
                    Mark all as read
                </Button>
            )}
        </div>
        <DropdownMenuSeparator />
        <ScrollArea className="h-[300px] md:h-[400px]">
          {isLoading && <div className="flex items-center justify-center p-8"><Loader2 className="w-6 h-6 animate-spin text-muted-foreground" /></div>}
          {!isLoading && (!notifications || notifications.length === 0) && (
             <div className="text-center p-8 text-sm text-muted-foreground">
                You have no notifications.
             </div>
          )}
          {notifications && notifications.map((notif) => (
            <DropdownMenuItem key={notif.id} asChild className={cn("flex items-start gap-3 p-3", !notif.read && "bg-primary/5")}>
              <Link href={notif.link || '#'} onClick={() => handleNotificationClick(notif)}>
                 {!notif.read && <div className="w-2 h-2 rounded-full bg-primary mt-1.5 shrink-0"></div>}
                 <div className={cn("flex-1", notif.read && "ml-5")}>
                    <p className="font-semibold text-sm">{notif.title}</p>
                    <p className="text-xs text-muted-foreground">{notif.message}</p>
                    <p className="text-xs text-muted-foreground/80 mt-1">
                        {formatDistanceToNow(notif.createdAt.toDate(), { addSuffix: true })}
                    </p>
                 </div>
              </Link>
            </DropdownMenuItem>
          ))}
        </ScrollArea>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

================================================================================
FILE: src/components/product/ProductDetails.tsx
================================================================================

'use client';

import { useState, useEffect, useCallback, useMemo, Suspense } from 'react';
import { notFound, useRouter } from 'next/navigation';
import Image from 'next/image';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Skeleton } from '@/components/ui/skeleton';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { useToast } from '@/hooks/use-toast';
import {
    Share2,
    Heart,
    Star,
    ShieldCheck,
    CheckCircle,
    AlertCircle,
    ChevronLeft,
    MessageSquare,
    Eye,
    Calendar,
    ShoppingCart,
    CreditCard,
    Loader2,
    Info as InfoIcon,
    Copyright,
    ChevronRight
} from 'lucide-react';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { cn } from '@/lib/utils';
import { db } from '@/lib/firebase/config';
import { doc, getDoc, collection, query, where, getDocs, limit, addDoc, serverTimestamp, deleteDoc, setDoc, orderBy, updateDoc, increment } from 'firebase/firestore';
import { useCart } from '@/context/CartContext';
import type { Product, Review } from '@/lib/types';
import type { UserProfile } from '@/lib/types';
import { useViewedProducts } from '@/context/ViewedProductsContext';
import { useUser, useCollection, useMemoFirebase, useDoc, useFirebase } from '@/firebase';
import ReviewForm from '@/components/reviews/ReviewForm';
import ReviewList from '@/components/reviews/ReviewList';
import { placeBid, acceptBid } from '@/services/bidding';
import { Input } from '@/components/ui/input';
import { Bid } from '@/lib/types';
import ProductGrid from '@/components/products/ProductGrid';
import ProductGridSkeleton from '@/components/products/ProductGridSkeleton';

// Define types
interface Seller extends UserProfile {
    rating?: number;
    totalSales?: number;
    isVerified?: boolean;
    responseTime?: string;
    joinDate?: string;
    description?: string;
}


// Main product component
export default function ProductDetails({ productId, initialProduct }: { productId: string; initialProduct: Product }) {
    const router = useRouter();
    const { toast } = useToast();
    const { user, isUserLoading } = useUser();
    const { addItem, updateQuantity: updateCartQuantity } = useCart();
    const { markAsViewed } = useViewedProducts();
    
    const [selectedImage, setSelectedImage] = useState(0);
    const [quantity, setQuantity] = useState(1);
    const [seller, setSeller] = useState<Seller | null>(null);
    const [relatedProducts, setRelatedProducts] = useState<Product[]>([]);
    const [loadingRelated, setLoadingRelated] = useState(true);
    
    // Bidding State
    const [bidAmount, setBidAmount] = useState('');
    const [biddingLoading, setBiddingLoading] = useState(false);

    const { firestore } = useFirebase();
    
    const productRef = useMemoFirebase(() => firestore ? doc(db, 'products', productId) : null, [firestore, productId]);
    const { data: product, isLoading: isProductLoading, error: productError } = useDoc<Product>(productRef, {
        initialData: initialProduct,
    });

    const reviewsQuery = useMemoFirebase(() => {
        if (!firestore || !productId) return null;
        return query(
            collection(firestore, 'reviews'),
            where('productId', '==', productId),
            orderBy('createdAt', 'desc')
        );
    }, [firestore, productId]);

    const { data: reviews, isLoading: reviewsLoading } = useCollection<Review>(reviewsQuery);

    const favoriteRef = useMemoFirebase(() => {
        if (!firestore || !user?.uid || !productId) return null;
        return doc(firestore, 'users', user.uid, 'favorites', productId);
    }, [firestore, user?.uid, productId]);

    const { data: favorite } = useDoc(favoriteRef);
    const isFavorited = favorite !== null;

    const toggleFavorite = useCallback(async () => {
        if (!user || !favoriteRef) {
            router.push(`/sign-in?redirect=/product/${productId}`);
            return;
        }
        if (isFavorited) {
            await deleteDoc(favoriteRef);
            toast({ title: "Removed from favorites." });
        } else {
            await setDoc(favoriteRef, {
                productId: productId,
                addedAt: serverTimestamp(),
            });
            toast({ title: "Added to favorites!" });
        }
    }, [user, favoriteRef, isFavorited, productId, router, toast]);


    const handleStartConversation = async () => {
        if (!user || !product || !seller) {
            if (!user) {
                router.push(`/sign-in?redirect=/product/${product?.id}`);
            }
            return;
        }

        if (user.uid === seller.id) {
            toast({ title: "You can't message yourself.", variant: 'destructive' });
            return;
        }

        const conversationQuery = query(
            collection(db, 'conversations'),
            where('participantIds', 'array-contains', user.uid)
        );

        const querySnapshot = await getDocs(conversationQuery);
        let existingConversation: any = null;

        querySnapshot.forEach(doc => {
            const data = doc.data();
            if (data.participantIds.includes(seller.id) && data.productContext?.id === product.id) {
                existingConversation = { id: doc.id, ...data };
            }
        });

        if (existingConversation) {
            router.push(`/messages/${existingConversation.id}`);
        } else {
            const newConversationRef = await addDoc(collection(db, 'conversations'), {
                participantIds: [user.uid, seller.id],
                participants: {
                    [user.uid]: {
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                    },
                    [seller.id]: {
                        displayName: seller.displayName,
                        photoURL: seller.photoURL,
                    }
                },
                lastMessage: {
                    text: `Inquiry about: ${product.title}`,
                    senderId: user.uid,
                    timestamp: serverTimestamp(),
                },
                productContext: {
                    id: product.id,
                    title: product.title,
                    imageUrl: product.imageUrls[0],
                },
                createdAt: serverTimestamp(),
            });
            router.push(`/messages/${newConversationRef.id}`);
        }
    };
    
    // Increment view count
     useEffect(() => {
        if (productId && productRef) {
            const incrementView = async () => {
                await updateDoc(productRef, {
                    views: increment(1)
                });
            };
            incrementView().catch(console.error); // Fire-and-forget
        }
    }, [productId, productRef]);

    useEffect(() => {
        if (product) {
            markAsViewed(productId);
            // Fetch seller and related products
             const fetchExtraData = async () => {
                setLoadingRelated(true);
                if (product.sellerId) {
                    const sellerRef = doc(db, 'users', product.sellerId);
                    const sellerSnap = await getDoc(sellerRef);
                    if (sellerSnap.exists()) {
                        const sellerData = sellerSnap.data() as UserProfile;
                        setSeller({
                            ...sellerData,
                            id: sellerSnap.id,
                            rating: 4.8,
                            totalSales: 150,
                            isVerified: true,
                            joinDate: sellerData.createdAt?.toDate().toLocaleDateString() || new Date().toLocaleDateString(),
                        } as Seller);
                    }
                }

                const relatedQuery = query(
                    collection(db, 'products'),
                    where('category', '==', product.category),
                    where('__name__', '!=', productId),
                    limit(4)
                );
                const relatedSnap = await getDocs(relatedQuery);
                const relatedData = relatedSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })) as Product[];
                setRelatedProducts(relatedData);
                setLoadingRelated(false);
            };

            fetchExtraData();
        }
    }, [product, productId, markAsViewed]);

    useEffect(() => {
        if (productError) {
            toast({
                title: "Error loading product",
                description: productError.message,
                variant: 'destructive',
            })
        }
    }, [productError, toast]);
    
    if (!product && !isProductLoading) {
        notFound();
    }
    
    if (!product) {
        return (
            <div className="container mx-auto px-4 py-8">
                <Skeleton className="h-10 w-24 mb-6" />
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                    <div>
                        <Skeleton className="aspect-square rounded-2xl mb-4" />
                        <div className="flex gap-2">
                            {[...Array(4)].map((_, i) => (
                                <Skeleton key={i} className="w-20 h-20 rounded-lg" />
                            ))}
                        </div>
                    </div>
                    <div className="space-y-6">
                        <div className="space-y-3">
                            <Skeleton className="h-4 w-1/4" />
                            <Skeleton className="h-9 w-3/4" />
                            <Skeleton className="h-10 w-1/3" />
                             <div className="flex gap-4">
                                <Skeleton className="h-5 w-1/4" />
                                <Skeleton className="h-5 w-1/4" />
                            </div>
                            <Skeleton className="h-20 w-full" />
                        </div>
                        <Skeleton className="h-12 w-full" />
                        <div className="flex gap-3">
                             <Skeleton className="h-12 flex-1" />
                             <Skeleton className="h-12 flex-1" />
                        </div>
                        <Skeleton className="h-20 w-full" />
                    </div>
                </div>
            </div>
        );
    }

    const conditionColors: Record<string, string> = {
        'Mint': 'bg-green-100 text-green-800 border-green-200',
        'Near Mint': 'bg-emerald-100 text-emerald-800 border-emerald-200',
        'Excellent': 'bg-blue-100 text-blue-800 border-blue-200',
        'Good': 'bg-yellow-100 text-yellow-800 border-yellow-200',
        'Fair': 'bg-orange-100 text-orange-800 border-orange-200',
        'Poor': 'bg-red-100 text-red-800 border-red-200',
    };

    const handleAddToCart = () => {
        addItem(product);
        updateCartQuantity(product.id, quantity)
    };

    const handleBuyNow = () => {
        handleAddToCart();
        router.push('/checkout');
    };

    const handlePlaceBid = async () => {
        if (!user) {
            router.push(`/sign-in?redirect=/product/${product?.id}`);
            return;
        }
        if (!product || !bidAmount) return;

        try {
            setBiddingLoading(true);
            await placeBid(product.id, user.uid, user.displayName || 'Anonymous', parseFloat(bidAmount));
            toast({
                title: "Bid Placed",
                description: "Your bid has been submitted successfully!",
            });
            setBidAmount('');
        } catch (err: any) {
            toast({
                variant: "destructive",
                title: "Bid Failed",
                description: err.message,
            });
        } finally {
            setBiddingLoading(false);
        }
    };

    const handleAcceptBid = async (bidId: string) => {
        if (!product) return;
        try {
            await acceptBid(product.id, bidId);
            toast({
                title: "Bid Accepted",
                description: "You have accepted the offer!",
            });
        } catch (err: any) {
            toast({
                variant: "destructive",
                title: "Error",
                description: err.message,
            });
        }
    };

    const isCard = product.category === 'Collector Cards';
    const isCoin = product.category === 'Coins';

    return (
        <div className="min-h-screen bg-gray-50">
            <div className="container mx-auto px-4 py-8">
                <Button
                    variant="ghost"
                    onClick={() => router.back()}
                    className="mb-6"
                >
                    <ChevronLeft className="h-4 w-4 mr-2" />
                    Back
                </Button>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                    <div className="space-y-4">
                        <div
                            className={cn(
                                'relative bg-gray-100 border overflow-hidden',
                                isCoin ? 'aspect-square rounded-full' : 'aspect-square rounded-2xl'
                            )}
                        >
                            <Image
                                src={product.imageUrls[selectedImage]}
                                alt={product.title}
                                fill
                                className={cn(
                                    'object-cover',
                                    isCoin ? 'rounded-full' : ''
                                )}
                                sizes="(max-width: 768px) 100vw, 50vw"
                                priority
                            />
                            <div className="absolute top-4 left-4 flex flex-col gap-2">
                                <Badge className={cn("border-none", conditionColors[product.condition as string] || 'bg-gray-100')}>
                                    {product.condition}
                                </Badge>
                                {(product as any).authentication?.isAuthenticated && (
                                    <Badge className="bg-blue-100 text-blue-800 border-blue-200 border-none">
                                        <ShieldCheck className="h-3 w-3 mr-1" />
                                        Authenticated
                                    </Badge>
                                )}
                            </div>
                        </div>

                        {product.imageUrls.length > 1 && (
                            <div className="flex gap-2 overflow-x-auto pb-2">
                                {product.imageUrls.map((url, index) => (
                                    <button
                                        key={index}
                                        onClick={() => setSelectedImage(index)}
                                        className={cn(
                                            "relative w-20 h-20 overflow-hidden flex-shrink-0 border-2 transition-all",
                                            isCoin ? "rounded-full" : "rounded-lg",
                                            selectedImage === index
                                                ? "border-primary ring-2 ring-primary/20"
                                                : "border-transparent hover:border-gray-300"
                                        )}
                                        aria-label={`View image ${index + 1} of ${product.title}`}
                                    >
                                        <Image
                                            src={url}
                                            alt={`${product.title} view ${index + 1}`}
                                            fill
                                            className={cn(
                                                'object-cover',
                                                isCoin ? "rounded-full" : ""
                                            )}
                                        />
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="space-y-6">
                        <div>
                            <div className="flex items-center justify-between mb-2">
                                <Badge variant="outline" className="text-xs">
                                    {product.category} {product.subCategory && `> ${product.subCategory}`}
                                </Badge>
                                <div className="flex items-center gap-2">
                                    <Button
                                        variant="ghost"
                                        size="icon"
                                        onClick={toggleFavorite}
                                        className="h-9 w-9"
                                    >
                                        <Heart className={cn("h-5 w-5", isFavorited && "fill-red-500 text-red-500")} />
                                    </Button>
                                    <Button variant="ghost" size="icon" className="h-9 w-9">
                                        <Share2 className="h-5 w-5" />
                                    </Button>
                                </div>
                            </div>

                            <h1 className="text-3xl font-bold text-gray-900 mb-3">{product.title}</h1>

                            <div className="flex items-center gap-3 mb-4">
                                <div className="text-4xl font-bold text-gray-900">
                                    ${product.price.toFixed(2)}
                                </div>
                            </div>
                            
                             <div className="text-sm text-muted-foreground flex flex-wrap gap-x-4 gap-y-1">
                                {product.year && (
                                    <div className="flex items-center gap-1.5">
                                        <Calendar className="w-4 h-4" />
                                        <span>Year: {product.year}</span>
                                    </div>
                                )}
                                {product.manufacturer && (
                                    <div className="flex items-center gap-1.5">
                                        <Copyright className="w-4 h-4" />
                                        <span>{product.manufacturer}</span>
                                    </div>
                                )}
                                 <div className="flex items-center gap-1.5">
                                    <Eye className="w-4 h-4" />
                                    <span>{(product as any).views || 0} views</span>
                                </div>
                            </div>


                            <p className="text-gray-600 mt-4">{product.description}</p>
                        </div>

                        {(product.quantity && product.quantity > 0) ? (
                            <Alert className="bg-green-50 border-green-200">
                                <CheckCircle className="h-4 w-4 text-green-600" />
                                <AlertDescription className="text-green-800">
                                    <span className="font-semibold">In Stock</span>
                                </AlertDescription>
                            </Alert>
                        ) : (
                            <Alert variant="destructive">
                                <AlertCircle className="h-4 w-4" />
                                <AlertDescription>
                                    <span className="font-semibold">Out of Stock</span>
                                </AlertDescription>
                            </Alert>
                        )}
                        
                        <div className="space-y-4 pt-4 border-t">
                             {(!product.isReverseBidding || user?.uid === product.sellerId) && (
                                <div className="flex flex-col sm:flex-row gap-3">
                                    <Button
                                        size="lg"
                                        className="flex-1"
                                        onClick={handleAddToCart}
                                        disabled={!product.quantity || product.quantity === 0}
                                    >
                                        <ShoppingCart className="h-5 w-5 mr-2" />
                                        Add to Cart
                                    </Button>
                                    <Button
                                        size="lg"
                                        className="flex-1 bg-gradient-to-r from-primary to-primary/80"
                                        onClick={handleBuyNow}
                                        disabled={!product.quantity || product.quantity === 0}
                                    >
                                        <CreditCard className="h-5 w-5 mr-2" />
                                        Buy Now
                                    </Button>
                                </div>
                             )}
                        </div>

                        {product.isReverseBidding && (
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                        <h3 className="font-semibold text-lg">Bids</h3>
                                        <Badge variant="secondary">{product.bids?.length || 0} Bids</Badge>
                                    </div>
                                    {product.bids && product.bids.length > 0 ? (
                                        <div className="space-y-2 border p-3 rounded-lg max-h-60 overflow-y-auto bg-gray-50/50">
                                            {[...product.bids].sort((a, b) => b.amount - a.amount).map((bid) => (
                                                <div key={bid.id} className="flex justify-between items-center p-3 bg-white border rounded shadow-sm">
                                                    <div>
                                                        <div className="font-medium flex items-center gap-2">
                                                            {bid.bidderName}
                                                            {bid.bidderId === user?.uid && <Badge variant="outline" className="text-[10px] h-5">You</Badge>}
                                                        </div>
                                                        <div className="text-gray-500 text-xs mt-0.5">
                                                            {bid.timestamp?.seconds ? new Date(bid.timestamp.seconds * 1000).toLocaleDateString() : 'Just now'}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <span className="font-bold text-lg">${bid.amount.toFixed(2)}</span>
                                                        {user?.uid === product.sellerId && bid.status === 'pending' && (
                                                            <Button size="sm" onClick={() => handleAcceptBid(bid.id)}>Accept</Button>
                                                        )}
                                                        {bid.status === 'accepted' && <Badge className="bg-green-500 hover:bg-green-600">Accepted</Badge>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-center p-6 border-2 border-dashed rounded-lg text-gray-400 bg-gray-50">
                                            <p>No bids yet. Be the first to make an offer!</p>
                                        </div>
                                    )}

                                    {(!user || user.uid !== product.sellerId) ? (
                                        <div className="flex gap-3 pt-2">
                                            <div className="relative flex-1">
                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-semibold">$</span>
                                                <Input
                                                    type="number"
                                                    placeholder="Enter bid"
                                                    className="pl-8 h-12 text-lg"
                                                    value={bidAmount}
                                                    onChange={(e) => setBidAmount(e.target.value)}
                                                />
                                            </div>
                                            <Button
                                                onClick={handlePlaceBid}
                                                disabled={biddingLoading || !bidAmount}
                                                size="lg"
                                                className="px-8"
                                            >
                                                {biddingLoading ? <Loader2 className="animate-spin w-5 h-5" /> : "Place Bid"}
                                            </Button>
                                        </div>
                                    ) : (
                                        <div className="p-4 bg-blue-50 text-blue-800 rounded-lg text-sm border border-blue-100 flex items-center gap-2">
                                            <InfoIcon className="w-4 h-4" />
                                            <span>You are the seller. You can accept offers from the list above.</span>
                                        </div>
                                    )}
                                </div>
                            )}

                        {seller && (
                             <Card>
                                <CardContent className="pt-6">
                                    <div className="flex items-center gap-3 mb-4">
                                        <Avatar className="h-12 w-12 border">
                                            <AvatarImage src={seller.photoURL || ''} />
                                            <AvatarFallback>{seller.displayName?.[0]}</AvatarFallback>
                                        </Avatar>
                                        <div className="flex-1">
                                            <h3 className="font-semibold text-gray-900">{seller.displayName}</h3>
                                            <div className="flex items-center gap-3 mt-1">
                                                <div className="flex items-center gap-1">
                                                    <Star className="h-4 w-4 fill-yellow-400 text-yellow-400" />
                                                    <span className="text-sm font-medium">{seller.rating}</span>
                                                    <span className="text-xs text-gray-500">({seller.totalSales} sales)</span>
                                                </div>
                                            </div>
                                        </div>
                                        <Button variant="outline" size="sm" asChild>
                                            <Link href={`/seller/${product.sellerId}`}>
                                                View Shop <ChevronRight className="w-4 h-4 ml-1" />
                                            </Link>
                                        </Button>
                                    </div>
                                    <Button variant="outline" size="sm" className="w-full" onClick={handleStartConversation}>
                                        <MessageSquare className="h-4 w-4 mr-2" />
                                        Message Seller
                                    </Button>
                                </CardContent>
                            </Card>
                        )}
                    </div>
                </div>

                <div className="lg:col-span-2 mt-12">
                    <Tabs defaultValue="reviews" className="space-y-6">
                        <TabsList className="grid grid-cols-2 w-full max-w-sm">
                            <TabsTrigger value="reviews">Reviews ({reviews?.length || 0})</TabsTrigger>
                            <TabsTrigger value="details">Item Details</TabsTrigger>
                        </TabsList>
                        <TabsContent value="reviews">
                            <Suspense fallback={<Loader2 className="animate-spin" />}>
                                {isUserLoading ? (
                                    <div className="flex justify-center p-8"><Loader2 className="animate-spin" /></div>
                                ) : (
                                    <>
                                        <ReviewForm
                                            user={user as any}
                                            productId={product.id}
                                            productTitle={product.title}
                                            sellerId={product.sellerId}
                                        />
                                        <ReviewList reviews={reviews || []} isLoading={reviewsLoading} />
                                    </>
                                )}
                            </Suspense>
                        </TabsContent>

                        <TabsContent value="details">
                            <Card>
                                <CardContent className="pt-6">
                                    <div className="prose max-w-none text-gray-600">
                                       <p>{product.description}</p>
                                       {/* Additional details would be rendered here */}
                                    </div>
                                </CardContent>
                            </Card>
                        </TabsContent>
                    </Tabs>
                </div>

                {relatedProducts.length > 0 && (
                    <div className="lg:col-span-2 mt-16">
                        <h2 className="text-2xl font-bold text-gray-900 mb-6">Related Collectibles</h2>
                        {loadingRelated ? <ProductGridSkeleton count={4}/> : <ProductGrid products={relatedProducts} />}
                    </div>
                )}
            </div>
        </div>
    );
}

================================================================================
FILE: src/components/products/AICardGrader.tsx
================================================================================

'use client';

import { useState, useTransition } from 'react';
import Image from 'next/image';
import { checkCardCondition } from '@/ai/flows/check-card-condition';
import type { CardConditionOutput } from '@/ai/flows/schemas';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Loader2, Sparkles, CheckCircle2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { suggestListingDetails } from '@/ai/flows/suggest-listing-details';
import type { SuggestListingDetailsOutput } from '@/ai/flows/schemas';

const fileToDataUri = (file: File): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target?.result as string);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
};

interface AICardGraderProps {
  onGradeComplete?: (grade: string) => void;
  onApplySuggestions: (suggestions: SuggestListingDetailsOutput) => void;
  imageFiles: File[];
}

export default function AICardGrader({ onGradeComplete, onApplySuggestions, imageFiles }: AICardGraderProps) {
  const [isPending, startTransition] = useTransition();
  const [result, setResult] = useState<SuggestListingDetailsOutput | null>(null);
  const { toast } = useToast();

  const handleGrade = () => {
    if (imageFiles.length === 0) {
      toast({ title: "Missing Photos", description: "Please upload at least one photo of your card.", variant: "destructive" });
      return;
    }

    startTransition(async () => {
      try {
        const dataUris = await Promise.all(
          imageFiles.map(file => fileToDataUri(file))
        );

        const gradingReport = await suggestListingDetails({
          photoDataUris: dataUris,
        });

        setResult(gradingReport);

        if (gradingReport.condition && onGradeComplete) {
          onGradeComplete(gradingReport.condition);
        }

        toast({ title: "AI Analysis Complete!", description: "Review the suggestions below and apply them to your listing." });

      } catch (error) {
        console.error(error);
        toast({ title: "Grading Failed", description: "Could not analyze images. Please try again.", variant: "destructive" });
      }
    });
  };

  const applySuggestions = () => {
    if (result) {
      onApplySuggestions(result);
    }
  }

  return (
    <div className="w-full mx-auto border border-indigo-100 shadow-xl overflow-hidden rounded-2xl bg-gradient-to-r from-indigo-50 to-white mb-6">
      <div className="p-6">
        <div className="flex items-center gap-2 mb-4">
          <div className="bg-indigo-600 p-2 rounded-lg">
            <Sparkles className="h-5 w-5 text-white" />
          </div>
          <div>
            <h3 className="text-lg font-black text-indigo-950">AI Grade & Suggest</h3>
            <p className="text-sm text-muted-foreground">Get AI-powered condition & listing suggestions.</p>
          </div>
        </div>

        <Button
          size="lg"
          className="w-full h-12 text-md font-bold bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all"
          onClick={handleGrade}
          disabled={isPending || imageFiles.length === 0}
        >
          {isPending ? (
            <><Loader2 className="mr-2 h-5 w-5 animate-spin" />Analyzing...</>
          ) : (
            <><Sparkles className="mr-2 h-5 w-5" />Analyze & Suggest Details</>
          )}
        </Button>

        {result && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 mt-6">
            <div className="space-y-4 bg-slate-50 rounded-2xl p-4 border border-slate-100">
              <div className="flex items-center justify-between border-b border-slate-200 pb-3">
                <span className="text-slate-500 font-bold uppercase text-xs tracking-widest">AI Suggestions</span>
                <Button size="sm" onClick={applySuggestions} className="h-7 rounded-md">Apply All</Button>
              </div>

              <div className="grid gap-2 text-sm">
                <AISuggestion label="Title" value={result.title} />
                <AISuggestion label="Price" value={`$${result.price.toFixed(2)}`} />
                <AISuggestion label="Condition" value={result.condition} />
                <AISuggestion label="Year" value={String(result.year)} />
              </div>

              <div className="flex gap-2 text-xs text-slate-400 pt-2 items-center justify-center">
                <CheckCircle2 className="h-3 w-3" />
                <span>AI Estimation â€¢ Review before publishing</span>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function AISuggestion({ label, value }: { label: string, value: string | undefined }) {
  if (!value) return null;
  return (
    <div className="flex justify-between items-center bg-white p-2 rounded-lg border border-slate-100 shadow-sm">
      <h5 className="text-xs font-black text-slate-400 uppercase">{label}</h5>
      <p className="text-xs font-medium text-slate-800 leading-snug text-right">{value}</p>
    </div>
  );
}

================================================================================
FILE: src/components/products/BiddingInterface.tsx
================================================================================
'use client';

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Loader2, Info as InfoIcon, Clock, TrendingUp } from 'lucide-react';
import { Bid, Product, SafeUser } from '@/lib/types';
import { useToast } from '@/hooks/use-toast';
import { placeBid, acceptBid } from '@/services/bidding';

interface BiddingInterfaceProps {
    product: Product;
    user: SafeUser;
    onAcceptBid?: (bidId: string) => Promise<void>;
}

export function BiddingInterface({ product, user, onAcceptBid }: BiddingInterfaceProps) {
    const { toast } = useToast();
    const [bidAmount, setBidAmount] = useState('');
    const [loading, setLoading] = useState(false);

    const handlePlaceBid = async () => {
        if (!user) return;
        if (!bidAmount) return;

        try {
            setLoading(true);
            await placeBid(product.id, user.uid, user.displayName || 'Anonymous', parseFloat(bidAmount));
            toast({
                title: "Bid Placed",
                description: "Your offer has been sent to the seller!",
            });
            setBidAmount('');
        } catch (err: any) {
            toast({
                variant: "destructive",
                title: "Offer Failed",
                description: err.message,
            });
        } finally {
            setLoading(false);
        }
    };

    const isSeller = user?.uid === product.sellerId;
    const sortedBids = [...(product.bids || [])].sort((a, b) => b.amount - a.amount);

    return (
        <div className="space-y-6">
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                    <h3 className="font-black text-xl tracking-tight">Active Offers</h3>
                    <Badge variant="secondary" className="rounded-full px-3">{product.bids?.length || 0}</Badge>
                </div>
                {product.bids && product.bids.length > 0 && (
                    <div className="flex items-center gap-1 text-[10px] font-bold text-orange-500 animate-pulse">
                        <Clock className="h-3 w-3" />
                        <span>LIVE UPDATES</span>
                    </div>
                )}
            </div>

            <div className="space-y-3">
                <AnimatePresence initial={false}>
                    {sortedBids.length > 0 ? (
                        sortedBids.map((bid, index) => (
                            <motion.div
                                key={bid.id}
                                initial={{ opacity: 0, x: -20 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, scale: 0.95 }}
                                transition={{ delay: index * 0.05 }}
                                className={`flex justify-between items-center p-4 rounded-2xl border transition-all ${bid.status === 'accepted'
                                        ? 'bg-green-50 border-green-200'
                                        : 'bg-white/50 border-white/60 hover:border-indigo-200 shadow-sm'
                                    }`}
                            >
                                <div className="flex flex-col">
                                    <div className="font-bold flex items-center gap-2 text-sm">
                                        {bid.bidderName}
                                        {bid.bidderId === user?.uid && (
                                            <Badge variant="outline" className="text-[9px] h-4 px-1.5 uppercase font-black bg-indigo-50 text-indigo-600 border-indigo-100">You</Badge>
                                        )}
                                    </div>
                                    <div className="text-[10px] text-muted-foreground font-medium mt-0.5">
                                        {bid.timestamp?.seconds ? new Date(bid.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Recently'}
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="flex flex-col items-end">
                                        <span className="font-black text-lg text-indigo-600">${bid.amount.toLocaleString()}</span>
                                        {index === 0 && bid.status === 'pending' && (
                                            <span className="text-[9px] font-bold text-orange-500 uppercase">Highest Offer</span>
                                        )}
                                    </div>
                                    {isSeller && bid.status === 'pending' && (
                                        <Button
                                            size="sm"
                                            onClick={() => onAcceptBid?.(bid.id)}
                                            className="rounded-full bg-indigo-600 hover:bg-indigo-700 h-8 px-4 text-xs font-bold"
                                        >
                                            Accept
                                        </Button>
                                    )}
                                    {bid.status === 'accepted' && (
                                        <Badge className="bg-green-500 text-white border-none text-[10px] font-black h-6 px-3">ACCEPTED</Badge>
                                    )}
                                </div>
                            </motion.div>
                        ))
                    ) : (
                        <motion.div
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            className="text-center p-10 border-2 border-dashed rounded-3xl text-muted-foreground bg-white/20 border-white/40"
                        >
                            <TrendingUp className="h-8 w-8 mx-auto mb-3 opacity-20" />
                            <p className="font-bold text-sm">No offers yet.</p>
                            <p className="text-xs">Be the first to secure this item!</p>
                        </motion.div>
                    )}
                </AnimatePresence>
            </div>

            {!isSeller && product.status !== 'sold' && (
                <div className="p-6 rounded-3xl bg-indigo-600 shadow-xl shadow-indigo-500/20 text-white">
                    <div className="flex items-center gap-2 mb-4">
                        <TrendingUp className="h-4 w-4" />
                        <span className="text-xs font-black uppercase tracking-widest">Place Your Offer</span>
                    </div>
                    <div className="flex gap-3">
                        <div className="relative flex-1">
                            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-white/60 font-black">$</span>
                            <Input
                                type="number"
                                placeholder="0.00"
                                className="pl-10 h-14 bg-white/10 border-white/20 text-white placeholder:text-white/40 text-xl font-black rounded-2xl focus-visible:ring-white/30"
                                value={bidAmount}
                                onChange={(e) => setBidAmount(e.target.value)}
                            />
                        </div>
                        <Button
                            onClick={handlePlaceBid}
                            disabled={loading || !bidAmount}
                            className="h-14 px-8 bg-white text-indigo-600 hover:bg-white/90 rounded-2xl font-black text-sm transition-transform active:scale-95"
                        >
                            {loading ? <Loader2 className="animate-spin w-5 h-5" /> : "SEND OFFER"}
                        </Button>
                    </div>
                    <p className="text-[10px] font-bold text-white/50 mt-4 flex items-center gap-1.5 uppercase tracking-tighter">
                        <InfoIcon className="h-3 w-3" />
                        Offers are binding. Seller will be notified immediately.
                    </p>
                </div>
            )}

            {isSeller && (
                <div className="p-4 rounded-2xl bg-indigo-50 border border-indigo-100 flex items-center gap-3">
                    <div className="bg-indigo-600 p-2 rounded-xl text-white">
                        <InfoIcon className="h-4 w-4" />
                    </div>
                    <div className="text-xs font-bold text-indigo-900 leading-tight">
                        You are the seller. You can accept any offer above to finalize the sale instantly.
                    </div>
                </div>
            )}
        </div>
    );
}

================================================================================
FILE: src/components/products/EnhancedAICardGrader.tsx
================================================================================
'use client';

import { useState } from 'react';
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Loader2, Sparkles, CheckCircle2, ShieldCheck, TrendingUp, AlertCircle, Image as ImageIcon } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { gradeCardDetailsAction } from '@/app/actions/ai-grading';
import { suggestListingDetailsAction } from '@/app/actions/ai-grading';
import type { GradeCardDetailsOutput } from '@/ai/schemas/grading-schemas';
import type { SuggestListingDetailsOutput } from '@/ai/flows/suggest-listing-details';
import { useUser } from '@/firebase';
import { uploadImages } from '@/lib/firebase/storage';

const fileToDataUri = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target?.result as string);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
};

interface EnhancedAICardGraderProps {
    onGradeComplete?: (grade: string) => void;
    onApplySuggestions: (suggestions: SuggestListingDetailsOutput) => void;
    imageFiles: File[];
}

export default function EnhancedAICardGrader({ onGradeComplete, onApplySuggestions, imageFiles }: EnhancedAICardGraderProps) {
    const [isGrading, setIsGrading] = useState(false);
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [gradingResult, setGradingResult] = useState<GradeCardDetailsOutput | null>(null);
    const [listingResult, setListingResult] = useState<SuggestListingDetailsOutput | null>(null);
    const { toast } = useToast();
    const { user } = useUser();

    const getGradeColor = (grade: number) => {
        if (grade >= 9) return 'text-emerald-600 bg-emerald-50 border-emerald-200';
        if (grade >= 7) return 'text-blue-600 bg-blue-50 border-blue-200';
        if (grade >= 5) return 'text-amber-600 bg-amber-50 border-amber-200';
        return 'text-rose-600 bg-rose-50 border-rose-200';
    };

    const getScoreColor = (score: number) => {
        if (score >= 9) return 'text-emerald-600';
        if (score >= 7) return 'text-blue-600';
        if (score >= 5) return 'text-amber-600';
        return 'text-rose-600';
    };

    const handleDetailedGrading = async () => {
        if (imageFiles.length === 0) {
            toast({
                title: "No Images",
                description: "Please upload at least the front of your card for grading.",
                variant: "destructive"
            });
            return;
        }

        const maxFileSize = 10 * 1024 * 1024; // 10MB
        const oversizedFiles = imageFiles.filter(f => f.size > maxFileSize);
        if (oversizedFiles.length > 0) {
            toast({
                title: "Files Too Large",
                description: "Some images exceed the 10MB limit. Please resize them.",
                variant: "destructive"
            });
            return;
        }

        setIsGrading(true);
        try {
            if (!user) {
                throw new Error("You must be logged in to grade cards.");
            }

            // 1. Get ID Token
            const token = await user.getIdToken();

            // 2. Upload Images to Storage (Solves Payload Limit)
            const uploadPath = `grading-temp/${user.uid}`;
            const uploadedUrls = await uploadImages(imageFiles.slice(0, 2), uploadPath);

            const frontImage = uploadedUrls[0];
            const backImage = uploadedUrls[1]; // undefined if only 1 uploaded

            // 3. Call AI Action with URLs and Token
            const result = await gradeCardDetailsAction({
                frontImageDataUri: frontImage,
                backImageDataUri: backImage,
                idToken: token
            });

            setGradingResult(result);

            if (result.condition && onGradeComplete) {
                onGradeComplete(result.condition);
            }

            toast({
                title: "Grading Complete!",
                description: `Overall Grade: ${result.overallGrade}/10 (${result.condition})`
            });

        } catch (error: any) {
            console.error('Grading error:', error);
            toast({
                title: "Grading Failed",
                description: error.message || "Could not analyze card. Please try again.",
                variant: "destructive"
            });
        } finally {
            setIsGrading(false);
        }
    };

    const handleQuickAnalysis = async () => {
        if (imageFiles.length === 0) {
            toast({
                title: "No Images",
                description: "Please upload at least one photo of your card.",
                variant: "destructive"
            });
            return;
        }

        const maxFileSize = 10 * 1024 * 1024; // 10MB
        const oversizedFiles = imageFiles.filter(f => f.size > maxFileSize);
        if (oversizedFiles.length > 0) {
            toast({
                title: "Files Too Large",
                description: "Some images exceed the 10MB limit. Please resize them.",
                variant: "destructive"
            });
            return;
        }

        setIsAnalyzing(true);
        try {
            if (!user) {
                throw new Error("You must be logged in to analyze cards.");
            }

            // 1. Get ID Token
            const token = await user.getIdToken();

            // 2. Upload Images
            const uploadPath = `grading-temp/${user.uid}`;
            const uploadedUrls = await uploadImages(imageFiles.slice(0, 3), uploadPath);

            // 3. Call AI Action
            const result = await suggestListingDetailsAction({
                photoDataUris: uploadedUrls,
                idToken: token
            });

            setListingResult(result);

            toast({
                title: "Analysis Complete!",
                description: "AI suggestions are ready to apply."
            });

        } catch (error: any) {
            console.error('Analysis error:', error);
            toast({
                title: "Analysis Failed",
                description: error.message || "Could not analyze images. Please try again.",
                variant: "destructive"
            });
        } finally {
            setIsAnalyzing(false);
        }
    };

    const applySuggestions = () => {
        if (listingResult) {
            onApplySuggestions(listingResult);
            toast({ title: "Suggestions Applied!" });
        }
    };

    return (
        <Card className="overflow-hidden border-2 border-indigo-100 shadow-xl bg-gradient-to-br from-indigo-50 via-white to-purple-50">
            <CardHeader className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                <div className="flex items-center gap-3">
                    <div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                        <ShieldCheck className="h-6 w-6" />
                    </div>
                    <div>
                        <CardTitle className="text-xl font-black">AI Card Analysis Lab</CardTitle>
                        <CardDescription className="text-indigo-100">
                            Professional-grade analysis with detailed grading
                        </CardDescription>
                    </div>
                </div>
            </CardHeader>

            <CardContent className="p-6 space-y-6">
                {/* Action Buttons */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <Button
                        size="lg"
                        className="h-14 text-md font-bold bg-indigo-600 hover:bg-indigo-700 shadow-lg transition-all"
                        onClick={handleDetailedGrading}
                        disabled={isGrading || imageFiles.length === 0}
                    >
                        {isGrading ? (
                            <><Loader2 className="mr-2 h-5 w-5 animate-spin" />Grading Card...</>
                        ) : (
                            <><ShieldCheck className="mr-2 h-5 w-5" />Detailed Grading</>
                        )}
                    </Button>

                    <Button
                        size="lg"
                        variant="outline"
                        className="h-14 text-md font-bold border-2 border-purple-200 hover:bg-purple-50 transition-all"
                        onClick={handleQuickAnalysis}
                        disabled={isAnalyzing || imageFiles.length === 0}
                    >
                        {isAnalyzing ? (
                            <><Loader2 className="mr-2 h-5 w-5 animate-spin" />Analyzing...</>
                        ) : (
                            <><Sparkles className="mr-2 h-5 w-5 text-purple-600" />Quick Analysis</>
                        )}
                    </Button>
                </div>

                {/* Image Upload Guidance */}
                {imageFiles.length === 0 && (
                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 flex items-start gap-3">
                        <AlertCircle className="h-5 w-5 text-amber-600 mt-0.5 flex-shrink-0" />
                        <div className="text-sm">
                            <p className="font-semibold text-amber-900">Upload card images first</p>
                            <p className="text-amber-700 mt-1">For best results, upload front and back images of your card.</p>
                        </div>
                    </div>
                )}

                {imageFiles.length === 1 && (
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start gap-3">
                        <ImageIcon className="h-5 w-5 text-blue-600 mt-0.5 flex-shrink-0" />
                        <div className="text-sm">
                            <p className="font-semibold text-blue-900">Add back image for complete analysis</p>
                            <p className="text-blue-700 mt-1">Upload a second image of the card back for full grading accuracy.</p>
                        </div>
                    </div>
                )}

                {/* Grading Results */}
                {gradingResult && (
                    <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-4">
                        {/* Overall Grade */}
                        <div className={cn(
                            "rounded-xl p-6 border-2 text-center",
                            getGradeColor(gradingResult.overallGrade)
                        )}>
                            <div className="text-6xl font-black mb-2">{gradingResult.overallGrade}<span className="text-3xl">/10</span></div>
                            <div className="text-xl font-bold mb-2">{gradingResult.condition}</div>
                            <Badge variant="outline" className="text-sm">Overall Grade</Badge>
                        </div>

                        {/* Tabbed Analysis */}
                        <Tabs defaultValue="front" className="w-full">
                            <TabsList className="grid w-full grid-cols-3">
                                <TabsTrigger value="front">Front</TabsTrigger>
                                <TabsTrigger value="back">Back</TabsTrigger>
                                <TabsTrigger value="summary">Summary</TabsTrigger>
                            </TabsList>

                            <TabsContent value="front" className="space-y-4 mt-4">
                                <GradingSection title="Corners" score={gradingResult.frontAnalysis.corners.score}>
                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                        <div><span className="font-semibold">Top Left:</span> {gradingResult.frontAnalysis.corners.topLeft}</div>
                                        <div><span className="font-semibold">Top Right:</span> {gradingResult.frontAnalysis.corners.topRight}</div>
                                        <div><span className="font-semibold">Bottom Left:</span> {gradingResult.frontAnalysis.corners.bottomLeft}</div>
                                        <div><span className="font-semibold">Bottom Right:</span> {gradingResult.frontAnalysis.corners.bottomRight}</div>
                                    </div>
                                    <p className="text-sm text-muted-foreground mt-2">{gradingResult.frontAnalysis.corners.notes}</p>
                                </GradingSection>

                                <GradingSection title="Centering" score={gradingResult.frontAnalysis.centering.score}>
                                    <div className="text-sm space-y-1">
                                        <div><span className="font-semibold">Left/Right:</span> {gradingResult.frontAnalysis.centering.leftRight}</div>
                                        <div><span className="font-semibold">Top/Bottom:</span> {gradingResult.frontAnalysis.centering.topBottom}</div>
                                        <p className="text-muted-foreground mt-2">{gradingResult.frontAnalysis.centering.notes}</p>
                                    </div>
                                </GradingSection>

                                <GradingSection title="Edges" score={gradingResult.frontAnalysis.edges.score}>
                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                        <div><span className="font-semibold">Top:</span> {gradingResult.frontAnalysis.edges.top}</div>
                                        <div><span className="font-semibold">Right:</span> {gradingResult.frontAnalysis.edges.right}</div>
                                        <div><span className="font-semibold">Bottom:</span> {gradingResult.frontAnalysis.edges.bottom}</div>
                                        <div><span className="font-semibold">Left:</span> {gradingResult.frontAnalysis.edges.left}</div>
                                    </div>
                                    <p className="text-sm text-muted-foreground mt-2">{gradingResult.frontAnalysis.edges.notes}</p>
                                </GradingSection>

                                <GradingSection title="Surface" score={gradingResult.frontAnalysis.surface.score}>
                                    <div className="text-sm space-y-1">
                                        <div><span className="font-semibold">Scratches:</span> {gradingResult.frontAnalysis.surface.scratches ? 'Present' : 'None detected'}</div>
                                        <div><span className="font-semibold">Print Lines:</span> {gradingResult.frontAnalysis.surface.printLines ? 'Visible' : 'None detected'}</div>
                                        <p className="text-muted-foreground mt-2">{gradingResult.frontAnalysis.surface.notes}</p>
                                    </div>
                                </GradingSection>
                            </TabsContent>

                            <TabsContent value="back" className="space-y-4 mt-4">
                                <GradingSection title="Corners" score={gradingResult.backAnalysis.corners.score}>
                                    <p className="text-sm text-muted-foreground">{gradingResult.backAnalysis.corners.notes}</p>
                                </GradingSection>

                                <GradingSection title="Centering" score={gradingResult.backAnalysis.centering.score}>
                                    <p className="text-sm text-muted-foreground">{gradingResult.backAnalysis.centering.notes}</p>
                                </GradingSection>

                                <GradingSection title="Edges" score={gradingResult.backAnalysis.edges.score}>
                                    <p className="text-sm text-muted-foreground">{gradingResult.backAnalysis.edges.notes}</p>
                                </GradingSection>

                                <GradingSection title="Surface" score={gradingResult.backAnalysis.surface.score}>
                                    <p className="text-sm text-muted-foreground">{gradingResult.backAnalysis.surface.notes}</p>
                                </GradingSection>
                            </TabsContent>

                            <TabsContent value="summary" className="space-y-4 mt-4">
                                {/* Strengths */}
                                <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                                    <h4 className="font-bold text-emerald-900 mb-2 flex items-center gap-2">
                                        <CheckCircle2 className="h-4 w-4" />
                                        Strengths
                                    </h4>
                                    <ul className="space-y-1">
                                        {gradingResult.strengths.map((strength, idx) => (
                                            <li key={idx} className="text-sm text-emerald-800">â€¢ {strength}</li>
                                        ))}
                                    </ul>
                                </div>

                                {/* Weaknesses */}
                                <div className="bg-rose-50 border border-rose-200 rounded-lg p-4">
                                    <h4 className="font-bold text-rose-900 mb-2 flex items-center gap-2">
                                        <AlertCircle className="h-4 w-4" />
                                        Weaknesses
                                    </h4>
                                    <ul className="space-y-1">
                                        {gradingResult.weaknesses.map((weakness, idx) => (
                                            <li key={idx} className="text-sm text-rose-800">â€¢ {weakness}</li>
                                        ))}
                                    </ul>
                                </div>

                                {/* Recommendations */}
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 className="font-bold text-blue-900 mb-2">Recommendations</h4>
                                    <p className="text-sm text-blue-800">{gradingResult.recommendations}</p>
                                </div>

                                {/* Estimated Value */}
                                <div className="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-lg p-4">
                                    <h4 className="font-bold text-amber-900 mb-2 flex items-center gap-2">
                                        <TrendingUp className="h-4 w-4" />
                                        Estimated Value
                                    </h4>
                                    <div className="text-2xl font-black text-amber-900 mb-1">
                                        ${gradingResult.estimatedValue.min.toFixed(2)} - ${gradingResult.estimatedValue.max.toFixed(2)} AUD
                                    </div>
                                    <p className="text-sm text-amber-800">{gradingResult.estimatedValue.notes}</p>
                                </div>
                            </TabsContent>
                        </Tabs>
                    </div>
                )}

                {/* Listing Analysis Results */}
                {listingResult && (
                    <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div className="bg-slate-50 rounded-xl p-4 border border-slate-200 space-y-3">
                            <div className="flex items-center justify-between border-b border-slate-300 pb-3">
                                <span className="text-slate-600 font-bold uppercase text-xs tracking-widest">Quick Analysis</span>
                                <Button size="sm" onClick={applySuggestions} className="h-8">
                                    Apply All
                                </Button>
                            </div>

                            <div className="grid gap-2">
                                <SuggestionRow label="Title" value={listingResult.title} />
                                <SuggestionRow label="Price" value={`$${listingResult.price.toFixed(2)} AUD`} />
                                <SuggestionRow label="Condition" value={listingResult.condition} />
                                <SuggestionRow label="Category" value={listingResult.category} />
                                {listingResult.year && <SuggestionRow label="Year" value={String(listingResult.year)} />}
                                {listingResult.manufacturer && <SuggestionRow label="Manufacturer" value={listingResult.manufacturer} />}
                            </div>

                            <div className="flex gap-2 text-xs text-slate-500 pt-2 items-center justify-center">
                                <CheckCircle2 className="h-3 w-3" />
                                <span>AI Estimation â€¢ Review before publishing</span>
                            </div>
                        </div>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}

function GradingSection({ title, score, children }: { title: string; score: number; children: React.ReactNode }) {
    const getScoreColor = (score: number) => {
        if (score >= 9) return 'text-emerald-600 bg-emerald-50';
        if (score >= 7) return 'text-blue-600 bg-blue-50';
        if (score >= 5) return 'text-amber-600 bg-amber-50';
        return 'text-rose-600 bg-rose-50';
    };

    return (
        <div className="bg-white rounded-lg border border-slate-200 p-4">
            <div className="flex items-center justify-between mb-3">
                <h4 className="font-bold text-slate-900">{title}</h4>
                <Badge className={cn("font-bold", getScoreColor(score))}>
                    {score}/10
                </Badge>
            </div>
            {children}
        </div>
    );
}

function SuggestionRow({ label, value }: { label: string; value: string | undefined }) {
    if (!value) return null;
    return (
        <div className="flex justify-between items-center bg-white p-3 rounded-lg border border-slate-100 shadow-sm">
            <h5 className="text-xs font-bold text-slate-500 uppercase">{label}</h5>
            <p className="text-sm font-semibold text-slate-900">{value}</p>
        </div>
    );
}

================================================================================
FILE: src/components/products/InfiniteProductGrid.tsx
================================================================================
'use client';

import React, { useState, useMemo, useCallback, useRef, useEffect, Suspense } from 'react';
import { useSearchParams, useRouter, usePathname } from 'next/navigation';
import { getProducts } from '@/services/product-service';
import type { Product, ProductSearchParams, UserProfile } from '@/lib/types';
import ProductCard from '@/components/products/ProductCard';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { LayoutGrid, List, Loader2, Filter, Grid } from 'lucide-react';
import { PageHeader } from '../layout/PageHeader';
import { CollectorCardsFilterTrigger } from '../filters/collector-cards-filter-trigger';
import AdvancedFilterPanel from '../filters/AdvancedFilterPanel';
import { useUser, useCollection, useMemoFirebase } from '@/firebase';
import { collection, query, where } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import { motion } from 'framer-motion';
import MontageGrid from './MontageGrid';
import Image from 'next/image';
import Link from 'next/link';

type ViewMode = 'grid' | 'list' | 'montage';
const PAGE_SIZE = 24;

const CONDITION_OPTIONS = ['Mint', 'Near Mint', 'Excellent', 'Good', 'Fair', 'Poor'];


function InfiniteProductGridInner({ pageTitle, pageDescription, initialFilterState = {} }: { pageTitle: string, pageDescription?: string, initialFilterState?: Partial<ProductSearchParams> }) {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  const [products, setProducts] = useState<Product[]>([]);

  const loadingRef = useRef(false);
  const hasMoreRef = useRef(true);
  const pageRef = useRef(0);

  const [loading, setLoading] = useState(true);
  const [hasMore, setHasMore] = useState(true);

  const observer = useRef<IntersectionObserver>();

  const currentSearchParams = useMemo(() => {
    const params: ProductSearchParams = { ...initialFilterState };
    searchParams.forEach((value, key) => {
      if (key === 'priceRange' || key === 'yearRange') {
        params[key] = value.split(',').map(Number) as [number, number];
      } else if (key === 'conditions' || key === 'sellers' || key === 'categories') {
        params[key] = value.split(',');
      } else {
        params[key] = value;
      }
    });
    return params;
  }, [searchParams, initialFilterState]);

  // Filter specific states, derived from URL
  const viewMode = (currentSearchParams.view as ViewMode) || 'grid';
  const sortOrder = currentSearchParams.sort || 'createdAt-desc';
  const priceRange = currentSearchParams.priceRange || [0, 5000];
  const selectedConditions = useMemo(() => currentSearchParams.conditions || [], [currentSearchParams.conditions]);
  const selectedSellers = useMemo(() => currentSearchParams.sellers || [], [currentSearchParams.sellers]);

  const [postcode, setPostcode] = useState<string>("");
  const [isExclusionMode, setIsExclusionMode] = useState<boolean>(false);

  const { user } = useUser();

  const usersQuery = useMemoFirebase(() => {
    // Only query users if authenticated to avoid permission errors
    if (!user) return null;
    return query(collection(db, 'users'), where('accountType', '==', 'seller'));
  }, [user?.uid]);
  const { data: fetchedUsers } = useCollection<UserProfile>(usersQuery);

  const availableSellers = useMemo(() => {
    if (!fetchedUsers) return [];
    return fetchedUsers as unknown as UserProfile[];
  }, [fetchedUsers]);


  const createQueryString = useCallback(
    (newParams: Record<string, string | string[] | [number, number] | null>) => {
      const params = new URLSearchParams(searchParams.toString());
      for (const [key, value] of Object.entries(newParams)) {
        if (value && Array.isArray(value) && value.length > 0) {
          params.set(key, value.join(','));
        } else if (value && !Array.isArray(value)) {
          params.set(key, String(value));
        } else {
          params.delete(key);
        }
      }
      return params.toString();
    },
    [searchParams]
  );

  const handleFilterChange = useCallback((key: string, value: string | string[] | [number, number] | null) => {
    const newQuery = createQueryString({ [key]: value, page: null });
    router.push(`${pathname}?${newQuery}`, { scroll: false });
  }, [createQueryString, pathname, router]);

  const handleViewChange = (mode: ViewMode) => {
    handleFilterChange('view', mode);
  };

  const loadMoreProducts = useCallback(async () => {
    if (loadingRef.current || !hasMoreRef.current) return;

    loadingRef.current = true;
    setLoading(true);

    pageRef.current += 1;

    try {
      const { products: newProducts, hasMore: newHasMore } = await getProducts({
        ...currentSearchParams,
        page: pageRef.current,
        limit: PAGE_SIZE,
      });

      setProducts(prev => {
        if (pageRef.current === 1) return newProducts;
        const uniqueIds = new Set(prev.map(p => p.id));
        const filteredNewProducts = newProducts.filter(p => !uniqueIds.has(p.id));
        return [...prev, ...filteredNewProducts];
      });

      hasMoreRef.current = newHasMore;
      setHasMore(newHasMore);

    } catch (error) {
      console.error("Failed to load products:", error);
    } finally {
      loadingRef.current = false;
      setLoading(false);
    }
  }, [currentSearchParams]);

  useEffect(() => {
    pageRef.current = 0;
    setProducts([]);
    hasMoreRef.current = true;
    setHasMore(true);
    loadingRef.current = false;
    setLoading(true);
    loadMoreProducts();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchParams]);


  const lastProductElementRef = useCallback((node: HTMLDivElement) => {
    if (loadingRef.current) return;
    if (observer.current) observer.current.disconnect();

    observer.current = new IntersectionObserver(entries => {
      if (entries[0].isIntersecting && hasMoreRef.current) {
        loadMoreProducts();
      }
    });

    if (node) observer.current.observe(node);
  }, [loadMoreProducts]);

  const renderProducts = () => {
    if (products.length === 0 && loading) {
      return (
        <div className="grid grid-cols-[repeat(auto-fill,minmax(220px,1fr))] gap-x-6 gap-y-8">
          {[...Array(18)].map((_, i) => (
            <div key={i} className="space-y-2">
              <div className="bg-muted aspect-[5/7] rounded-lg shimmer" />
              <div className="space-y-2">
                <div className="h-4 bg-muted rounded w-3/4 shimmer" />
                <div className="h-5 bg-muted rounded w-1/2 shimmer" />
              </div>
            </div>
          ))}
        </div>
      )
    }

    if (products.length === 0 && !loading) {
      return (
        <p className="col-span-full text-center text-muted-foreground py-12">
          No products found matching your criteria.
        </p>
      );
    }

    if (viewMode === 'list') {
      return (
        <div className="space-y-4">
          {products.map((product, index) => {
            const isLastElement = index === products.length - 1;
            return <motion.div
              layout
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.3 }}
              ref={isLastElement ? lastProductElementRef : null}
              key={`${product.id}-${index}`}>
              <ProductCard product={product} viewMode={viewMode} />
            </motion.div>
          })}
        </div>
      );
    }

    if (viewMode === 'montage') {
      return <MontageGrid products={products} lastProductRef={lastProductElementRef} />;
    }


    return (
      <motion.div layout className="grid grid-cols-[repeat(auto-fill,minmax(220px,1fr))] gap-x-6 gap-y-8">
        {products.map((product, index) => {
          const isLastElement = index === products.length - 1;
          return <motion.div
            layout
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
            transition={{ duration: 0.3, delay: (index % PAGE_SIZE) * 0.05 }}
            ref={isLastElement ? lastProductElementRef : null}
            key={`${product.id}-${index}`}>
            <ProductCard product={product} viewMode={viewMode} />
          </motion.div>
        })}
      </motion.div>
    );
  };

  const handleConditionSelection = useCallback((c: string) => {
    const newConditions = selectedConditions.includes(c)
      ? selectedConditions.filter(sc => sc !== c)
      : [...selectedConditions, c];
    handleFilterChange('conditions', newConditions.length > 0 ? newConditions : null);
  }, [selectedConditions, handleFilterChange]);

  const handleSellerSelection = useCallback((sellerId: string) => {
    const newSellers = selectedSellers.includes(sellerId)
      ? selectedSellers.filter(id => id !== sellerId)
      : [...selectedSellers, sellerId];
    handleFilterChange('sellers', newSellers.length > 0 ? newSellers : null);
  }, [selectedSellers, handleFilterChange]);

  return (
    <div className="container mx-auto max-w-screen-2xl px-4 py-8 min-h-screen">
      <header className="flex flex-col sm:flex-row justify-between items-start gap-4 mb-8">
        <div>
          <PageHeader title={pageTitle} description={pageDescription} />
        </div>
        <div className="flex items-center gap-2 self-end sm:self-auto flex-shrink-0">
          <Select value={sortOrder} onValueChange={(v) => handleFilterChange('sort', v)}>
            <SelectTrigger className="w-[180px] h-10 hidden sm:flex">
              <SelectValue placeholder="Sort by" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="createdAt-desc">Newest</SelectItem>
              <SelectItem value="price-asc">Price: Low to High</SelectItem>
              <SelectItem value="price-desc">Price: High to Low</SelectItem>
            </SelectContent>
          </Select>

          <div className="hidden sm:flex items-center rounded-md border bg-card p-1 h-10">
            <Button variant={viewMode === 'grid' ? 'secondary' : 'ghost'} size="icon" className="h-8 w-8" onClick={() => handleViewChange('grid')}><LayoutGrid /></Button>
            <Button variant={viewMode === 'list' ? 'secondary' : 'ghost'} size="icon" className="h-8 w-8" onClick={() => handleViewChange('list')}><List /></Button>
            <Button variant={viewMode === 'montage' ? 'secondary' : 'ghost'} size="icon" className="h-8 w-8" onClick={() => handleViewChange('montage')}><Grid /></Button>
          </div>
          <AdvancedFilterPanel
            currentFilters={currentSearchParams}
            onFilterChange={(newFilters) => {
              const newQuery = createQueryString(newFilters);
              router.push(`${pathname}?${newQuery}`, { scroll: false });
            }}
            onClearFilters={() => router.push(pathname, { scroll: false })}
          />
        </div>
      </header>

      {renderProducts()}

      {loading && products.length > 0 && (
        <div className="flex justify-center mt-8">
          <Loader2 className="animate-spin" />
        </div>
      )}

      {!hasMore && products.length > 0 && (
        <div className="py-12 text-center text-muted-foreground">
          <p>You&apos;ve reached the end of the list.</p>
        </div>
      )}
    </div>
  );
}

export default function InfiniteProductGrid(props: { pageTitle: string, pageDescription?: string, initialFilterState?: Partial<ProductSearchParams> }) {
  return (
    <Suspense fallback={<div className="flex h-screen w-full items-center justify-center"><Loader2 className="h-12 w-12 animate-spin" /></div>}>
      <InfiniteProductGridInner {...props} />
    </Suspense>
  )
}

================================================================================
FILE: src/components/products/MontageGrid.tsx
================================================================================
'use client';

import type { Product } from '@/lib/types';
import Image from 'next/image';
import Link from 'next/link';
import EmptyState from '../ui/EmptyState';
import { Package } from 'lucide-react';
import { motion } from 'framer-motion';

export interface MontageGridProps {
  products: Product[];
  lastProductRef?: (node: HTMLDivElement) => void;
}

import { useViewedProducts } from '@/context/ViewedProductsContext';
import { Eye, Trash2, Loader2 } from 'lucide-react';
import { useUser } from '@/firebase';
import { useState } from 'react';
import { deleteProductByAdmin } from '@/app/actions/admin';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';
import { useToast } from '@/hooks/use-toast';
import { SUPER_ADMIN_EMAILS, SUPER_ADMIN_UIDS } from '@/lib/constants';

export default function MontageGrid({ products, lastProductRef }: MontageGridProps) {
  const { viewedProductIds } = useViewedProducts();
  const { user } = useUser();
  const { toast } = useToast();
  const [deletingId, setDeletingId] = useState<string | null>(null);

  const isSuperAdmin = (user?.uid && SUPER_ADMIN_UIDS.includes(user.uid)) || (user?.email && SUPER_ADMIN_EMAILS.includes(user.email));

  const handleDelete = async (e: React.MouseEvent, productId: string) => {
    e.preventDefault();
    e.stopPropagation();

    if (!confirm("Are you sure you want to delete this product?")) return;

    setDeletingId(productId);
    try {
      const idToken = await getCurrentUserIdToken();
      if (!idToken) throw new Error("Auth error");

      const result = await deleteProductByAdmin(productId, idToken);

      if (result.success) {
        toast({ title: "Deleted", description: "Product removed." });
        // Note: The list won't auto-refresh unless we invalidate router or use realtime. 
        // Without router.refresh(), it stays until reload. 
        // For now, I'll rely on user reloading or navigation.
        // Actually, I can reload page: window.location.reload(); 
        // Or just letting it be is fine for now.
        window.location.reload();
      } else {
        toast({ title: "Error", description: result.error, variant: "destructive" });
      }
    } catch (err) {
      console.error(err);
      toast({ title: "Failed", variant: "destructive" });
    } finally {
      setDeletingId(null);
    }
  };

  if (!products || products.length === 0) {
    return <EmptyState
      icon={<Package className="h-12 w-12 text-muted-foreground" />}
      title="No Products Found"
      description="Try adjusting your search or filters to find what you're looking for."
    />;
  }

  return (
    <motion.div
      layout
      className="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-2"
    >
      {products.map((product, index) => {
        const isLastElement = index === products.length - 1;
        const hasViewed = viewedProductIds.includes(product.id);

        return (
          <motion.div
            ref={isLastElement ? lastProductRef : null}
            key={product.id}
            layout
            initial={{ opacity: 0, scale: 0.8 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.8 }}
            transition={{ duration: 0.3, delay: index * 0.02 }}
          >
            <Link href={`/product/${product.id}`} className="group block relative aspect-square w-full h-full overflow-hidden rounded-md">
              <Image
                src={product.imageUrls[0]}
                alt={product.title}
                fill
                sizes="(max-width: 640px) 25vw, (max-width: 768px) 16vw, (max-width: 1024px) 12.5vw, 10vw"
                className="object-cover transition-transform duration-300 ease-in-out group-hover:scale-110"
              />
              <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />

              {hasViewed && (
                <div className="absolute top-1 left-1 z-10">
                  <div className="bg-black/50 text-white p-1 rounded-full backdrop-blur-sm">
                    <Eye className="h-3 w-3" />
                  </div>
                </div>
              )}

              {isSuperAdmin && (
                <button
                  onClick={(e) => handleDelete(e, product.id)}
                  className="absolute top-1 right-1 z-20 bg-red-600/80 hover:bg-red-700 text-white p-1 rounded-md opacity-0 group-hover:opacity-100 transition-opacity"
                  disabled={deletingId === product.id}
                >
                  {deletingId === product.id ? <Loader2 className="h-3 w-3 animate-spin" /> : <Trash2 className="h-3 w-3" />}
                </button>
              )}

              <div className="absolute bottom-1 right-1">
                <span className="bg-black/50 text-white text-xs font-bold px-2 py-1 rounded-md backdrop-blur-sm">
                  ${product.price.toFixed(0)}
                </span>
              </div>
            </Link>
          </motion.div>
        )
      })}
    </motion.div>
  );
}

================================================================================
FILE: src/components/products/ProductCard.tsx
================================================================================

'use client';

import React, { useState } from 'react';
import Image from 'next/image';
import Link from 'next/link';
import type { Product } from '@/lib/types';
import { cn } from '@/lib/utils';
import { Badge } from '../ui/badge';
import { Button } from '../ui/button';
import { ShoppingCart, Eye, Trash2, Loader2, Clock, Users, Edit, MoreHorizontal, ShieldCheck } from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { useCart } from '@/context/CartContext';
import { useToast } from '@/hooks/use-toast';
import { Avatar, AvatarFallback, AvatarImage } from '../ui/avatar';
import { formatDistanceToNow } from 'date-fns';
import { QuickView } from './QuickView';
import { Timestamp } from 'firebase/firestore';
import { useUser } from '@/firebase';
import { getCurrentUserIdToken } from '@/lib/firebase/auth';
import { deleteProductByAdmin } from '@/app/actions/admin';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { useViewedProducts } from '@/context/ViewedProductsContext';
import { SUPER_ADMIN_EMAILS, SUPER_ADMIN_UIDS } from '@/lib/constants';


interface ProductCardProps {
  product: Product;
  viewMode?: 'grid' | 'list';
}

export default function ProductCard({ product, viewMode = 'grid' }: ProductCardProps) {
  const { addItem } = useCart();
  const { toast } = useToast();
  const { user } = useUser();
  const [isDeleting, setIsDeleting] = useState(false);
  const [isDeleted, setIsDeleted] = useState(false);
  const { viewedProductIds } = useViewedProducts();

  const hasViewed = viewedProductIds.includes(product.id);

  // Super admin check
  const isSuperAdmin = (user?.uid && SUPER_ADMIN_UIDS.includes(user.uid)) || (user?.email && SUPER_ADMIN_EMAILS.includes(user.email));

  const handleAddToCart = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.preventDefault();
    e.stopPropagation();
    addItem(product);
    toast({
      title: 'Added to Cart!',
      description: `${product.title} is now in your cart.`,
    });
  };

  const handleDelete = async (e: React.MouseEvent<HTMLButtonElement>) => {
    e.preventDefault();
    e.stopPropagation();

    if (!isSuperAdmin) return;
    setIsDeleting(true);

    try {
      const idToken = await getCurrentUserIdToken();
      if (!idToken) throw new Error("Authentication session expired.");

      const result = await deleteProductByAdmin(product.id, idToken);

      if (!result.success) {
        throw new Error(result.error);
      }

      toast({
        title: "Product Deleted",
        description: result.message,
      });
      setIsDeleted(true); // Visually remove the card

    } catch (error: any) {
      toast({
        variant: "destructive",
        title: "Deletion Failed",
        description: error.message || "An error occurred.",
      });
    } finally {
      setIsDeleting(false);
    }
  };


  const getFormattedDate = (dateValue: any) => {
    if (!dateValue) return '';

    // Handle both Firestore Timestamps and JS Date objects
    if (dateValue instanceof Timestamp) {
      return formatDistanceToNow(dateValue.toDate(), { addSuffix: true });
    }
    // Check for serialized Timestamp from server-side rendering
    if (typeof dateValue === 'object' && dateValue.seconds) {
      return formatDistanceToNow(new Date(dateValue.seconds * 1000), { addSuffix: true });
    }
    // Handle standard JS Date object
    if (dateValue instanceof Date) {
      return formatDistanceToNow(dateValue, { addSuffix: true });
    }
    return '';
  }

  if (isDeleted) {
    return null; // Don't render the card if it has been deleted
  }

  if (viewMode === 'list') {
    return (
      <Link href={`/product/${product.id}`} className="group block">
        <div className="flex flex-col sm:flex-row gap-4 rounded-lg border bg-card text-card-foreground shadow-sm overflow-hidden transition-all hover:shadow-md">
          <div className="relative w-full sm:w-48 flex-shrink-0 aspect-square bg-muted">
            {product.imageUrls?.[0] ? (
              <Image
                src={product.imageUrls[0]}
                alt={product.title}
                fill
                className="object-cover"
                sizes="(max-width: 640px) 100vw, 192px"
              />
            ) : null}
            <div className="absolute top-2 left-2 z-10 flex flex-col gap-1">
              {product.isVault && (
                <Badge 
                  variant="default" 
                  className="inline-flex items-center gap-1 bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-tighter shadow-md cursor-pointer z-20"
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    window.open('/vault', '_blank');
                  }}
                >
                  <ShieldCheck className="h-3 w-3" />
                  Vault
                </Badge>
              )}
              {hasViewed && (
                <Badge variant="secondary" className="inline-flex items-center gap-1 bg-black/50 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-tighter backdrop-blur-sm">
                  <Eye className="h-3 w-3" />
                  Viewed
                </Badge>
              )}
              {product.status === 'sold' && (
                <Badge variant="destructive">
                  Sold
                </Badge>
              )}
            </div>
            <div className="absolute top-2 right-2 z-10">
              {isSuperAdmin && (
                <div onClick={(e) => e.stopPropagation()}>
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button variant="secondary" size="icon" className="h-8 w-8 rounded-full bg-black/50 text-white backdrop-blur-sm hover:bg-black/70 border-none">
                        <MoreHorizontal className="h-4 w-4" />
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="end">
                      <DropdownMenuItem asChild>
                        <Link href={`/sell/create?edit=${product.id}`}>
                          <Edit className="mr-2 h-4 w-4" /> Edit Listing
                        </Link>
                      </DropdownMenuItem>
                      <DropdownMenuItem onClick={(e) => { e.preventDefault(); e.stopPropagation(); setIsDeleting(true); }} className="text-red-600">
                        <Trash2 className="mr-2 h-4 w-4" /> Delete Listing
                      </DropdownMenuItem>
                    </DropdownMenuContent>
                  </DropdownMenu>
                  <AlertDialog open={isDeleting} onOpenChange={setIsDeleting}>
                    <AlertDialogContent onClick={(e) => e.stopPropagation()}>
                      <AlertDialogHeader>
                        <AlertDialogTitle>Delete Product?</AlertDialogTitle>
                        <AlertDialogDescription>
                          Are you sure you want to delete "{product.title}"? This action cannot be undone.
                        </AlertDialogDescription>
                      </AlertDialogHeader>
                      <AlertDialogFooter>
                        <AlertDialogCancel onClick={(e) => { e.stopPropagation(); setIsDeleting(false); }}>Cancel</AlertDialogCancel>
                        <AlertDialogAction onClick={handleDelete} className="bg-red-600">Delete</AlertDialogAction>
                      </AlertDialogFooter>
                    </AlertDialogContent>
                  </AlertDialog>
                </div>
              )}
            </div>
          </div>
          <div className="p-4 flex flex-col justify-between flex-grow">
            <div>
              <div className="flex items-center justify-between">
                <Badge variant="outline" className="text-xs mb-1">{product.category}</Badge>
                <p className="text-lg font-bold">${product.price?.toLocaleString() || '0.00'}</p>
              </div>
              <h3 className="text-lg font-semibold text-foreground group-hover:text-primary leading-tight">
                {product.title}
              </h3>
              <p className="text-sm text-muted-foreground mt-2 line-clamp-2">
                {product.description}
              </p>
            </div>
            <div className="flex items-center justify-between mt-4 text-xs text-muted-foreground">
              <div className="flex items-center gap-2">
                <Avatar className="h-6 w-6">
                  <AvatarImage src={product.sellerAvatar} />
                  <AvatarFallback>{product.sellerName?.[0]}</AvatarFallback>
                </Avatar>
                <span>{product.sellerName}</span>
              </div>
              <span>{getFormattedDate(product.createdAt)}</span>
            </div>
          </div>
        </div>
      </Link>
    );
  }

  // Grid View (default) - new style
  return (
    <div className="group relative flex flex-col bg-white dark:bg-white/5 rounded-xl overflow-hidden border border-transparent hover:border-primary/20 hover:shadow-2xl transition-all duration-300 h-full">
      <Link href={`/product/${product.id}`} className="contents">
        <div className="aspect-[4/5] bg-gray-100 dark:bg-white/10 relative overflow-hidden">
          <div className="absolute top-3 left-3 z-10 flex gap-2">
            {product.isVault && (
              <Badge 
                variant="default" 
                className="inline-flex items-center gap-1 bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-tighter shadow-lg cursor-pointer z-20"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  window.open('/vault', '_blank');
                }}
              >
                <ShieldCheck className="h-3 w-3" />
                Vault
              </Badge>
            )}
            {hasViewed && (
              <Badge variant="secondary" className="inline-flex items-center gap-1 bg-black/50 text-white text-[10px] font-bold px-2.5 py-1 rounded-full uppercase tracking-tighter backdrop-blur-sm">
                <Eye className="h-3 w-3" />
                Viewed
              </Badge>
            )}
          </div>
          <div className="absolute top-3 right-3 z-10">
            {isSuperAdmin && (
              <div onClick={(e) => e.preventDefault()}>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="secondary" size="icon" className="h-8 w-8 rounded-full bg-black/50 text-white backdrop-blur-sm hover:bg-black/70 border-none">
                      <MoreHorizontal className="h-4 w-4" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem asChild>
                      <Link href={`/sell/create?edit=${product.id}`}>
                        <Edit className="mr-2 h-4 w-4" /> Edit Listing
                      </Link>
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={(e) => { e.preventDefault(); e.stopPropagation(); setIsDeleting(true); }} className="text-red-600">
                      <Trash2 className="mr-2 h-4 w-4" /> Delete Listing
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
                <AlertDialog open={isDeleting} onOpenChange={setIsDeleting}>
                  <AlertDialogContent onClick={(e) => e.stopPropagation()}>
                    <AlertDialogHeader>
                      <AlertDialogTitle>Delete Product?</AlertDialogTitle>
                      <AlertDialogDescription>
                        Are you sure you want to delete "{product.title}"? This action cannot be undone.
                      </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                      <AlertDialogCancel onClick={(e) => { e.stopPropagation(); setIsDeleting(false); }}>Cancel</AlertDialogCancel>
                      <AlertDialogAction onClick={handleDelete} className="bg-red-600">Delete</AlertDialogAction>
                    </AlertDialogFooter>
                  </AlertDialogContent>
                </AlertDialog>
              </div>
            )}
          </div>
          {product.imageUrls?.[0] && (
            <Image
              src={product.imageUrls[0]}
              alt={product.title}
              fill
              className="object-cover transition-transform duration-500 group-hover:scale-110"
              sizes="(max-width: 768px) 50vw, (max-width: 1280px) 33vw, 25vw"
            />
          )}
          <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
        </div>
        <div className="p-5 flex flex-col flex-grow">
          <div className="flex justify-between items-start mb-2">
            <h3 className="text-lg font-bold leading-tight group-hover:text-primary transition-colors flex-1 pr-2">
              {product.title}
            </h3>
            {product.grade && <span className="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-[10px] font-black px-2 py-0.5 rounded">{product.grade}</span>}
          </div>
          <div className="flex items-end justify-between mt-4 flex-grow">
            <div>
              <p className="text-xs text-gray-500 dark:text-gray-400 font-medium">Price</p>
              <p className="text-2xl font-black text-[#0d121b] dark:text-white tracking-tight">${product.price.toLocaleString()}</p>
            </div>
            <Button size="sm" className="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all active:scale-95" onClick={(e) => { e.preventDefault(); handleAddToCart(e); }}>
              Buy It
            </Button>
          </div>
          <div className="mt-4 pt-4 border-t border-gray-100 dark:border-white/10 flex items-center justify-between text-xs text-gray-400">
            <span className="flex items-center gap-1"><Clock className="h-3 w-3" /> {getFormattedDate(product.createdAt)}</span>
            <span className="flex items-center gap-1"><Users className="h-3 w-3" /> {product.views || 0} views</span>
          </div>
        </div>
      </Link>
    </div>
  );
}

================================================================================
FILE: src/components/products/ProductCardSkeleton.tsx
================================================================================
// components/products/ProductCardSkeleton.tsx
import { Card, CardContent, CardFooter } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";

export default function ProductCardSkeleton() {
  return (
    <Card className="overflow-hidden rounded-lg shadow-md h-full">
      <CardContent className="p-0">
        <Skeleton className="w-full h-auto aspect-square" />
      </CardContent>
      <CardFooter className="p-4 flex flex-col items-start space-y-2">
        <Skeleton className="h-4 w-1/3" />
        <Skeleton className="h-5 w-full" />
        <Skeleton className="h-6 w-1/4 mt-1" />
      </CardFooter>
    </Card>
  );
}

================================================================================
FILE: src/components/products/ProductGrid.tsx
================================================================================

'use client';

import type { Product } from '@/lib/types';
import ProductCard from './ProductCard';
import EmptyState from '../ui/EmptyState';
import { Package, Upload } from 'lucide-react';
import { QuickView } from './QuickView';
import { Button } from '../ui/button';
import Link from 'next/link';
import { useUserPermissions } from '@/hooks/use-user-permissions';

export interface ProductGridProps {
  products: Product[];
}

export default function ProductGrid({ products }: ProductGridProps) {
  const { canSell } = useUserPermissions();

  if (!products || products.length === 0) {
    return <EmptyState 
      icon={<Package className="h-12 w-12 text-muted-foreground" />}
      title="No Products Found"
      description="Try adjusting your search or filters to find what you're looking for."
    >
        {canSell && (
          <Button asChild className="mt-6">
              <Link href="/sell/create">
                  <Upload className="h-4 w-4 mr-2" />
                  List an Item
              </Link>
          </Button>
        )}
    </EmptyState>;
  }

  return (
    <div
      className="grid grid-cols-2 gap-x-4 gap-y-8 md:grid-cols-3 lg:grid-cols-4 2xl:grid-cols-5 xl:gap-x-8 mt-8"
    >
      {products.map((product) => (
        <ProductCard key={product.id} product={product} />
      ))}
    </div>
  );
}

================================================================================
FILE: src/components/products/ProductGridSkeleton.tsx
================================================================================
// components/products/ProductGridSkeleton.tsx
import ProductCardSkeleton from "./ProductCardSkeleton";

export default function ProductGridSkeleton({ count = 8 }: { count?: number }) {
  return (
    <div className="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 2xl:grid-cols-5 xl:gap-x-8 mt-8">
      {Array.from({ length: count }).map((_, i) => (
        <ProductCardSkeleton key={i} />
      ))}
    </div>
  );
}

================================================================================
FILE: src/components/products/ProductImageGallery.tsx
================================================================================

"use client";

import { useState, useEffect, useCallback } from 'react';
import Image from 'next/image';
import { motion, AnimatePresence } from 'framer-motion';
import { ChevronLeft, ChevronRight, Maximize2, X } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { Badge } from '@/components/ui/badge';
import { cn } from '@/lib/utils';
import { ShieldCheck } from 'lucide-react';

interface ProductImageGalleryProps {
  images: string[];
  title: string;
  isCard: boolean;
  condition?: string;
  isAuthenticated?: boolean;
}

const conditionColors: Record<string, string> = {
  'Mint': 'bg-green-100 text-green-800 border-green-200',
  'Near Mint': 'bg-emerald-100 text-emerald-800 border-emerald-200',
  'Excellent': 'bg-blue-100 text-blue-800 border-blue-200',
  'Good': 'bg-yellow-100 text-yellow-800 border-yellow-200',
  'Fair': 'bg-orange-100 text-orange-800 border-orange-200',
  'Poor': 'bg-red-100 text-red-800 border-red-200',
};

export default function ProductImageGallery({ images, title, isCard, condition, isAuthenticated }: ProductImageGalleryProps) {
  const [selectedIndex, setSelectedIndex] = useState(0);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [zoomStyle, setZoomStyle] = useState({ transformOrigin: 'center', transform: 'scale(1)' });

  const goToPrevious = useCallback((e?: React.MouseEvent | KeyboardEvent) => {
    e?.stopPropagation();
    setSelectedIndex((prev) => (prev === 0 ? images.length - 1 : prev - 1));
  }, [images.length]);

  const goToNext = useCallback((e?: React.MouseEvent | KeyboardEvent) => {
    e?.stopPropagation();
    setSelectedIndex((prev) => (prev === images.length - 1 ? 0 : prev + 1));
  }, [images.length]);

  useEffect(() => {
    if (!isFullscreen) return;

    const handleKeyDown = (e: KeyboardEvent) => {
      switch (e.key) {
        case 'ArrowLeft':
          goToPrevious(e);
          break;
        case 'ArrowRight':
          goToNext(e);
          break;
        case 'Escape':
          setIsFullscreen(false);
          break;
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isFullscreen, goToPrevious, goToNext]);

  const handleMouseMove = (e: React.MouseEvent<HTMLDivElement>) => {
    const { left, top, width, height } = e.currentTarget.getBoundingClientRect();
    const x = ((e.clientX - left) / width) * 100;
    const y = ((e.clientY - top) / height) * 100;
    setZoomStyle({
      transformOrigin: `${x}% ${y}%`,
      transform: 'scale(2.0)', // 2x Zoom
    });
  };

  const handleMouseLeave = () => {
    setZoomStyle({
      transformOrigin: 'center',
      transform: 'scale(1)',
    });
  };

  return (
    <>
      <div className="space-y-4">
        {/* Main Image */}
        <div
          className="relative aspect-square bg-gray-100 rounded-lg overflow-hidden group cursor-zoom-in"
          onMouseMove={handleMouseMove}
          onMouseLeave={handleMouseLeave}
          onClick={() => setIsFullscreen(true)}
        >
          <AnimatePresence mode="wait">
            <motion.div
              key={selectedIndex}
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.2 }}
              className="relative w-full h-full pointer-events-none"
            >
              <Image
                src={images[selectedIndex]}
                alt={`${title} - Image ${selectedIndex + 1}`}
                fill
                className="object-contain transition-transform duration-200 ease-out"
                style={zoomStyle}
                priority={selectedIndex === 0}
                sizes="(max-width: 768px) 100vw, 50vw"
              />
            </motion.div>
          </AnimatePresence>

          {/* Navigation Arrows */}
          {images.length > 1 && (
            <>
              <Button
                variant="ghost"
                size="icon"
                className="absolute left-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity bg-white/80 hover:bg-white rounded-full h-9 w-9 z-10"
                onClick={goToPrevious}
              >
                <ChevronLeft className="w-5 h-5" />
              </Button>
              <Button
                variant="ghost"
                size="icon"
                className="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity bg-white/80 hover:bg-white rounded-full h-9 w-9 z-10"
                onClick={goToNext}
              >
                <ChevronRight className="w-5 h-5" />
              </Button>
            </>
          )}

          {/* Fullscreen Button */}
          <Button
            variant="ghost"
            size="icon"
            className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-white/80 hover:bg-white rounded-full h-9 w-9 z-10"
            onClick={(e) => { e.stopPropagation(); setIsFullscreen(true); }}
          >
            <Maximize2 className="w-5 h-5" />
          </Button>

          <div className="absolute top-4 left-4 flex flex-col gap-2 pointer-events-none z-10">
            {condition && (
              <Badge className={cn("border-none", conditionColors[condition] || 'bg-gray-100')}>
                {condition}
              </Badge>
            )}
            {isAuthenticated && (
              <Badge className="bg-blue-100 text-blue-800 border-blue-200 border-none">
                <ShieldCheck className="h-3 w-3 mr-1" />
                Authenticated
              </Badge>
            )}
          </div>

          {/* Image Counter */}
          {images.length > 1 && (
            <div className="absolute bottom-2 right-2 bg-black/60 text-white px-2 py-1 rounded-full text-xs pointer-events-none z-10">
              {selectedIndex + 1} / {images.length}
            </div>
          )}
        </div>

        {/* Thumbnail Strip */}
        {images.length > 1 && (
          <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
            {images.map((image, index) => (
              <button
                key={index}
                onClick={() => setSelectedIndex(index)}
                className={`
                  relative flex-shrink-0 w-20 h-20 rounded-md overflow-hidden border-2 transition-all
                  ${index === selectedIndex ? 'border-primary ring-2 ring-primary/20' : 'border-transparent hover:border-gray-300'}
                `}
              >
                <Image
                  src={image}
                  alt={`Thumbnail ${index + 1}`}
                  fill
                  className="object-cover"
                />
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Fullscreen Modal */}
      <Dialog open={isFullscreen} onOpenChange={setIsFullscreen}>
        <DialogContent className="max-w-[95vw] w-full h-[95vh] p-0 bg-black/95 border-none shadow-none flex flex-col">
          <DialogTitle className="sr-only">
            Full-screen view of {title}
          </DialogTitle>
          <DialogDescription className="sr-only">
            Viewing image {selectedIndex + 1} of {images.length}. Use arrow buttons or arrow keys to navigate.
          </DialogDescription>

          <div className="relative flex-1 w-full flex items-center justify-center overflow-hidden">
            <Image
              src={images[selectedIndex]}
              alt={`${title} - Fullscreen`}
              fill
              className="object-contain"
            />

            {/* Close Button */}
            <Button
              variant="ghost"
              size="icon"
              className="absolute top-4 right-4 text-white hover:bg-white/20 rounded-full h-10 w-10 z-50"
              onClick={() => setIsFullscreen(false)}
            >
              <X className="w-6 h-6" />
            </Button>

            {/* Navigation in Fullscreen */}
            {images.length > 1 && (
              <>
                <Button
                  variant="ghost"
                  size="icon"
                  className="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:bg-white/20 h-12 w-12 rounded-full z-40"
                  onClick={goToPrevious}
                >
                  <ChevronLeft className="w-8 h-8" />
                </Button>
                <Button
                  variant="ghost"
                  size="icon"
                  className="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:bg-white/20 h-12 w-12 rounded-full z-40"
                  onClick={goToNext}
                >
                  <ChevronRight className="w-8 h-8" />
                </Button>
              </>
            )}
          </div>

          {/* Fullscreen Thumbnails */}
          {images.length > 1 && (
            <div className="h-24 bg-black/50 flex items-center justify-center p-4 border-t border-white/10">
              <div className="flex gap-4 overflow-x-auto max-w-full px-4 scrollbar-hide">
                {images.map((image, index) => (
                  <button
                    key={index}
                    onClick={() => setSelectedIndex(index)}
                    className={`
                        relative flex-shrink-0 w-16 h-16 rounded-md overflow-hidden border-2 transition-all
                        ${index === selectedIndex ? 'border-white ring-2 ring-white/50' : 'border-transparent opacity-50 hover:opacity-100'}
                        `}
                  >
                    <Image
                      src={image}
                      alt={`Thumb ${index}`}
                      fill
                      className="object-cover"
                    />
                  </button>
                ))}
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </>
  );
}

================================================================================
FILE: src/components/products/ProductList.tsx
================================================================================

'use client';

import type { Product } from '@/lib/types';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import Image from 'next/image';
import Link from 'next/link';
import { Button } from '../ui/button';
import EmptyState from '../ui/EmptyState';
import { Package } from 'lucide-react';

interface ProductListProps {
    products: Product[];
}

export default function ProductList({ products }: ProductListProps) {
  if (!products || products.length === 0) {
    return <EmptyState 
      icon={<Package className="h-12 w-12 text-muted-foreground" />}
      title="No Products Found"
      description="Try adjusting your search or filters to find what you're looking for."
    />;
  }

  return (
    <div className="border rounded-lg mt-8">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead className="w-[100px]">Image</TableHead>
            <TableHead>Title</TableHead>
            <TableHead>Condition</TableHead>
            <TableHead>Seller</TableHead>
            <TableHead className="text-right">Price</TableHead>
            <TableHead className="text-right">Actions</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {products.map((product) => (
            <TableRow key={product.id}>
              <TableCell>
                <div className="relative h-16 w-16 rounded-md overflow-hidden bg-muted">
                    <Image src={product.imageUrls[0]} alt={product.title} fill className="object-cover" />
                </div>
              </TableCell>
              <TableCell className="font-medium">{product.title}</TableCell>
              <TableCell>
                <Badge variant="outline">{product.condition}</Badge>
              </TableCell>
              <TableCell>{product.sellerName}</TableCell>
              <TableCell className="text-right font-semibold">${product.price.toFixed(2)}</TableCell>
              <TableCell className="text-right">
                <Button asChild variant="ghost" size="sm">
                    <Link href={`/product/${product.id}`}>View</Link>
                </Button>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
}

================================================================================
FILE: src/components/products/ProductViewSwitcher.tsx
================================================================================
'use client';

import { Button } from '@/components/ui/button';
import { LayoutGrid, List, Grid } from 'lucide-react';
import { cn } from '@/lib/utils';

type ViewMode = 'grid' | 'list' | 'montage';

interface ProductViewSwitcherProps {
  view: ViewMode;
  setView: (view: ViewMode) => void;
}

export default function ProductViewSwitcher({ view, setView }: ProductViewSwitcherProps) {
  return (
    <div className="flex items-center gap-2">
      <Button
        variant="outline"
        size="icon"
        onClick={() => setView('grid')}
        className={cn(view === 'grid' && 'bg-accent text-accent-foreground')}
        aria-label="Grid View"
      >
        <LayoutGrid className="h-4 w-4" />
      </Button>
      <Button
        variant="outline"
        size="icon"
        onClick={() => setView('list')}
        className={cn(view === 'list' && 'bg-accent text-accent-foreground')}
        aria-label="List View"
      >
        <List className="h-4 w-4" />
      </Button>
       <Button
        variant="outline"
        size="icon"
        onClick={() => setView('montage')}
        className={cn(view === 'montage' && 'bg-accent text-accent-foreground')}
        aria-label="Montage View"
      >
        <Grid className="h-4 w-4" />
      </Button>
    </div>
  );
}

================================================================================
FILE: src/components/products/QuickView.tsx
================================================================================

'use client';

import type { Product } from '@/lib/types';
import { Dialog, DialogContent, DialogTitle, DialogDescription, DialogTrigger } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Badge } from '../ui/badge';
import { Separator } from '../ui/separator';
import { useCart } from '@/context/CartContext';
import Link from 'next/link';
import { useViewedProducts } from '@/context/ViewedProductsContext';
import ProductImageGallery from './ProductImageGallery';
import { Heart, Share2, ShoppingCart, Edit, Eye } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { useUser } from '@/firebase';
import { useState } from 'react';
import { SUPER_ADMIN_EMAILS, SUPER_ADMIN_UIDS } from '@/lib/constants';

interface QuickViewProps {
  product: Product;
}

export function QuickView({ product }: QuickViewProps) {
  const { user } = useUser();
  const { addItem } = useCart();
  const { markAsViewed } = useViewedProducts();
  const { toast } = useToast();
  const [isOpen, setIsOpen] = useState(false);

  const isOwner = user && user.uid === product.sellerId;
  const isSuperAdmin = user && ((user.uid && SUPER_ADMIN_UIDS.includes(user.uid)) || (user.email && SUPER_ADMIN_EMAILS.includes(user.email)));
  const canEdit = isOwner || isSuperAdmin;


  const handleOpen = (openState: boolean) => {
    setIsOpen(openState);
    if (openState) {
      markAsViewed(product.id);
    }
  };

  const handleFavorite = () => {
    // This would eventually be a database action
    toast({
      title: "Added to Favorites!",
      description: `${product.title} has been added to your favorites list.`
    });
  }

  const handleShare = () => {
    navigator.clipboard.writeText(`${window.location.origin}/product/${product.id}`);
    toast({
      title: "Link Copied!",
      description: "A link to this product has been copied to your clipboard."
    });
  }
  
  const handleAddToCart = () => {
    addItem(product);
    toast({
        title: "Added to Cart!",
        description: `${product.title} is now in your cart.`
    });
    setIsOpen(false);
  }

  return (
    <Dialog open={isOpen} onOpenChange={handleOpen}>
      <DialogTrigger asChild>
        <Button variant="outline" size="sm" className="w-full mt-2">
            <Eye className="mr-2 h-4 w-4" />
            Quick View
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-4xl w-full h-auto md:h-[80vh] flex flex-col md:flex-row p-0">
          <DialogTitle className="sr-only">{`Quick view of ${product.title}`}</DialogTitle>
          <DialogDescription className="sr-only">{`View details for ${product.title}, add to cart, or see more.`}</DialogDescription>
        
        {/* Left Side: Image Gallery */}
        <div className="md:w-1/2 p-6 flex flex-col">
          <ProductImageGallery 
            images={product.imageUrls} 
            title={product.title} 
            isCard={product.category === 'Collector Cards'} 
          />
        </div>

        {/* Right Side: Product Details */}
        <div className="md:w-1/2 p-6 flex flex-col bg-gray-50/50 overflow-y-auto">
          
          <div className="space-y-3">
            <Badge variant="outline">{product.category}</Badge>
            <h1 className="text-2xl lg:text-3xl font-bold tracking-tight font-headline">{product.title}</h1>
            <div className="flex items-center gap-2">
              <p className="text-sm text-muted-foreground">
                Sold by <Link href={`/seller/${product.sellerId}`} className="font-medium text-primary hover:underline">{product.sellerName}</Link>
              </p>
              {/* Star ratings could go here */}
            </div>
          </div>

          <Separator className="my-5" />
          
          <div className="space-y-4">
            <p className="text-3xl font-bold text-foreground">${product.price.toFixed(2)}</p>
            
            <div className="text-sm text-muted-foreground">
                {product.description}
            </div>
          </div>
          
          <div className="mt-auto pt-6 space-y-4">
             <div className="flex items-center gap-4">
                <Button size="lg" className="flex-1" onClick={handleAddToCart}>
                    <ShoppingCart className="mr-2 h-5 w-5" />
                    Buy It
                </Button>
                <Button size="icon" variant="outline" onClick={handleFavorite}>
                    <Heart className="h-5 w-5" />
                </Button>
                <Button size="icon" variant="outline" onClick={handleShare}>
                    <Share2 className="h-5 w-5" />
                </Button>
             </div>
             {canEdit && (
                <Button asChild variant="secondary" className="w-full">
                    <Link href={`/sell/edit/${product.id}`}>
                        <Edit className="mr-2 h-4 w-4" />
                        Edit Listing
                    </Link>
                </Button>
             )}
             <Button asChild variant="ghost" className="w-full">
                <Link href={`/product/${product.id}`}>
                    View Full Product Details â†’
                </Link>
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}

================================================================================
FILE: src/components/research/camera-scanner.tsx
================================================================================
'use client';

import { useRef, useEffect, useState, useCallback } from 'react';
import { Loader, CameraOff, Sparkles, PlusCircle, Gem, Camera, ShoppingCart, Upload } from 'lucide-react';
import { useRouter } from 'next/navigation';
import { cn } from '@/lib/utils';
import { extractCardName } from '@/ai/flows/extract-card-name';
import { quickScan } from '@/ai/flows/quick-scan';
import { useToast } from '@/hooks/use-toast';
import { Button } from '@/components/ui/button';
import { verifyCard } from '@/lib/card-logic';
import type { Player } from '@/lib/research-types';

interface CameraScannerProps {
    playersToKeep: Player[];
    onScanComplete: (
        result: {
            name: string;
            isKeeper: boolean;
            imageDataUri: string;
            brand?: string;
            cardType?: string;
            sport?: string;
            cardYear?: number | null;
            isPrizmRookie?: boolean;
            salesData?: {
                averagePrice?: number | null;
                salesCount?: number | null;
                source?: string | null;
            };
        }
    ) => void;
    onAddNameToKeep: (name: string, sport?: string) => void;
}

type ScanResult = {
    name: string;
    isKeeper: boolean;
    isPrizmRookie?: boolean;
    brand?: string;
    cardType?: string;
    sport?: string;
    cardYear?: number | null;
    imageDataUri?: string;
};

type ProcessingState = 'idle' | 'scanning' | 'verifying';

const resizeImage = async (dataUri: string, maxWidth = 800): Promise<string> => {
    const img = new Image();
    img.src = dataUri;
    await new Promise((resolve) => { img.onload = resolve; });

    if (img.width <= maxWidth) {
        return dataUri;
    }

    const canvas = document.createElement('canvas');
    const scale = maxWidth / img.width;
    canvas.width = maxWidth;
    canvas.height = img.height * scale;
    const ctx = canvas.getContext('2d');

    if (!ctx) {
        throw new Error('Could not get canvas context');
    }

    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    return canvas.toDataURL('image/jpeg', 0.8);
};

export default function CameraScanner({
    playersToKeep,
    onScanComplete,
    onAddNameToKeep,
}: CameraScannerProps) {
    const videoRef = useRef<HTMLVideoElement>(null);
    const canvasRef = useRef<HTMLCanvasElement>(null);
    const fileInputRef = useRef<HTMLInputElement>(null);
    const router = useRouter();
    const [isCameraActive, setIsCameraActive] = useState(false);
    const [processingState, setProcessingState] = useState<ProcessingState>('idle');
    const [scanResult, setScanResult] = useState<ScanResult | null>(null);
    const [showResult, setShowResult] = useState(false);
    const [cameraError, setCameraError] = useState<string | null>(null);
    const { toast } = useToast();

    const cleanupCamera = useCallback(() => {
        if (videoRef.current && videoRef.current.srcObject) {
            const stream = videoRef.current.srcObject as MediaStream;
            stream.getTracks().forEach((track) => track.stop());
            videoRef.current.srcObject = null;
        }
    }, []);

    useEffect(() => {
        async function setupCamera() {
            if (isCameraActive) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' },
                    });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        // Ensure video plays (critical for iOS)
                        await videoRef.current.play();
                    }
                } catch (err: any) {
                    console.error('Camera access denied:', err);
                    const errorMessage = 'Camera access denied. Please enable camera permissions in your browser settings.';
                    setCameraError(errorMessage);
                    cleanupCamera();
                    setIsCameraActive(false);
                }
            } else {
                cleanupCamera();
            }
        }
        setupCamera();
        return cleanupCamera;
    }, [isCameraActive, cleanupCamera]);

    const toggleCamera = () => {
        setCameraError(null);
        setIsCameraActive(prev => !prev);
    };

    const handleListOnMarketplace = useCallback(() => {
        if (!scanResult) return;

        // Store scan data in sessionStorage for the create listing page
        const listingData = {
            title: `${scanResult.name}${scanResult.cardYear ? ` ${scanResult.cardYear}` : ''}${scanResult.brand ? ` ${scanResult.brand}` : ''}${scanResult.cardType ? ` ${scanResult.cardType}` : ''}`,
            description: `${scanResult.brand || 'Trading'} Card featuring ${scanResult.name}${scanResult.sport ? ` - ${scanResult.sport}` : ''}${scanResult.cardType ? ` ${scanResult.cardType}` : ''}`,
            category: 'Collector Cards',
            subCategory: 'Trading Cards',
            year: scanResult.cardYear,
            manufacturer: scanResult.brand,
            imageDataUri: scanResult.imageDataUri, // The scanned image
        };

        sessionStorage.setItem('researchScanData', JSON.stringify(listingData));
        router.push('/sell/create?from=research');
    }, [scanResult, router]);

    const processImage = useCallback(async (imageDataUri: string) => {
        if (processingState !== 'idle') return;

        if (!playersToKeep || playersToKeep.length === 0) {
            toast({
                variant: 'destructive',
                title: 'Setup Required',
                description: "Please add players to your 'keep list' before scanning.",
            });
            return;
        }

        console.log("Processing image...");
        setProcessingState('scanning');
        setScanResult(null);

        try {
            const resizedImage = await resizeImage(imageDataUri);

            const { playerName } = await quickScan({ cardImageDataUri: resizedImage });
            console.log("Quick scan result:", playerName);

            const preliminaryCheck = playersToKeep.find(p => p.name.toLowerCase() === playerName.toLowerCase());

            if (!preliminaryCheck) {
                const result = { name: playerName, isKeeper: false, imageDataUri: resizedImage };
                setScanResult(result);
                setShowResult(true);
                onScanComplete({ ...result, imageDataUri: resizedImage });
                setTimeout(() => setShowResult(false), 3000);
                setProcessingState('idle');
                return;
            }

            setProcessingState('verifying');
            const extractedDetails = await extractCardName({
                cardImageDataUri: resizedImage,
            });
            console.log("Detailed scan result:", extractedDetails);

            const { isKeeper, isPrizmRookie } = verifyCard(extractedDetails, playersToKeep);

            const result = {
                name: extractedDetails.playerName,
                isKeeper,
                isPrizmRookie,
                brand: extractedDetails.cardBrand,
                cardType: extractedDetails.cardColor,
                sport: extractedDetails.sport,
                cardYear: extractedDetails.cardYear,
                salesData: extractedDetails.salesData,
                imageDataUri: resizedImage,
            };

            setScanResult(result);
            setShowResult(true);
            onScanComplete({ ...result, imageDataUri: resizedImage });
            setTimeout(() => setShowResult(false), 3000);
        } catch (error: any) {
            console.error('Scan failed:', error);
            let description = 'An unknown error occurred during the scan.';
            if (error instanceof Error) {
                if (error.message.includes('Invalid image format')) {
                    description = 'The image format was invalid. Please try again with a JPEG or PNG.';
                } else if (error.message.includes('could not detect a player name')) {
                    description = 'The AI could not detect a player name on the card. Please try again with a clearer image.';
                } else {
                    description = error.message;
                }
            }
            toast({
                variant: 'destructive',
                title: 'Scan Failed',
                description,
            });
        } finally {
            setProcessingState('idle');
        }
    }, [processingState, playersToKeep, onScanComplete, toast]);

    const scan = useCallback(async () => {
        if (!videoRef.current || !canvasRef.current || !isCameraActive) return;

        const video = videoRef.current;
        const canvas = canvasRef.current;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        if (!context) return;

        context.clearRect(0, 0, canvas.width, canvas.height);
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageDataUri = canvas.toDataURL('image/jpeg');

        await processImage(imageDataUri);
    }, [isCameraActive, processImage]);

    const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onloadend = () => {
            const result = reader.result as string;
            processImage(result);
        };
        reader.readAsDataURL(file);
        // Reset input so same file can be selected again
        e.target.value = '';
    };

    const handleAddName = useCallback(() => {
        if (scanResult && !scanResult.isKeeper) {
            onAddNameToKeep(scanResult.name, scanResult.sport);
            setScanResult((prev) => (prev ? { ...prev, isKeeper: true } : null));
        }
    }, [onAddNameToKeep, scanResult]);

    const resultOverlayClasses = cn(
        'absolute inset-0 z-10 flex flex-col items-center justify-center p-4 text-center transition-opacity duration-300 text-white font-bold text-4xl font-headline tracking-wider',
        {
            'opacity-0 pointer-events-none': !showResult,
            'opacity-100': showResult,
            'bg-gradient-to-br from-yellow-400 via-red-500 to-pink-500': showResult && scanResult?.isPrizmRookie,
            'bg-green-500/80': showResult && scanResult?.isKeeper && !scanResult.isPrizmRookie,
            'bg-red-500/80': showResult && !scanResult?.isKeeper,
        }
    );

    return (
        <div className="w-full max-w-[12rem] aspect-[9/16] bg-black rounded-xl overflow-hidden shadow-2xl relative border-4 border-primary/50 cursor-pointer" onClick={isCameraActive ? scan : undefined}>
            <video
                ref={videoRef}
                autoPlay
                playsInline
                muted
                className={cn('w-full h-full object-cover', !isCameraActive && 'hidden')}
            />
            <canvas ref={canvasRef} className="hidden" />

            {!isCameraActive && !cameraError && (
                <div className="absolute inset-0 bg-black/80 flex flex-col items-center justify-center text-center p-4">
                    <Camera className="w-16 h-16 text-primary-foreground mb-4" />
                    <h3 className="text-xl font-bold text-white mb-2">Camera Off</h3>
                    <div className="flex flex-col gap-2 w-full">
                        <Button onClick={toggleCamera} size="sm" variant="secondary" className="w-full font-semibold">
                            Start Camera
                        </Button>
                        <div className="relative">
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept="image/*"
                                className="hidden"
                                onChange={handleFileUpload}
                            />
                            <Button onClick={() => fileInputRef.current?.click()} size="sm" variant="outline" className="w-full bg-transparent text-white border-white/30 hover:bg-white/10">
                                <Upload className="mr-2 h-3 w-3" />
                                Upload Image
                            </Button>
                        </div>
                    </div>
                </div>
            )}

            {isCameraActive && (
                <div className="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
                    <div
                        className="w-full h-auto border-2 border-dashed border-white/50 rounded-xl"
                        style={{ aspectRatio: '2.5 / 3.5' }}
                    />
                </div>
            )}

            {cameraError && (
                <div className="absolute inset-0 bg-black/80 flex flex-col items-center justify-center text-center p-4">
                    <CameraOff className="w-16 h-16 text-destructive mb-4" />
                    <h3 className="text-xl font-bold text-white mb-2">Camera Error</h3>
                    <p className="text-muted-foreground text-xs mb-4">{cameraError}</p>
                    <div className="relative w-full">
                        <input
                            ref={fileInputRef}
                            type="file"
                            accept="image/*"
                            className="hidden"
                            onChange={handleFileUpload}
                        />
                        <Button onClick={() => fileInputRef.current?.click()} size="sm" variant="outline" className="w-full bg-white text-black hover:bg-white/90">
                            <Upload className="mr-2 h-3 w-3" />
                            Upload Image Instead
                        </Button>
                    </div>
                </div>
            )}

            {processingState !== 'idle' && !showResult && (
                <div className="absolute inset-0 z-20 flex flex-col items-center justify-center bg-black/50 backdrop-blur-sm">
                    <Loader className="w-12 h-12 text-primary-foreground animate-spin mb-4" />
                    <p className="text-primary-foreground text-lg font-semibold">
                        {processingState === 'scanning' ? 'Scanning...' : 'Verifying...'}
                    </p>
                </div>
            )}

            <div className={resultOverlayClasses} onClick={() => setShowResult(false)}>
                {scanResult?.isPrizmRookie ? (
                    <div className="flex flex-col items-center gap-2 animate-pulse">
                        <Gem className="w-12 h-12" />
                        <p className="text-2xl">PRIZM ROOKIE!</p>
                    </div>
                ) : (
                    scanResult?.isKeeper ? 'KEEP' : 'DISCARD'
                )}
                <p className="text-xl font-body font-normal mt-2">
                    {scanResult?.name}
                </p>
                {showResult && scanResult && (
                    <div className="flex flex-col gap-2 mt-4">
                        {!scanResult.isKeeper && (
                            <Button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleAddName();
                                }}
                                variant="outline"
                                size="sm"
                                className="bg-white/20 hover:bg-white/30 text-white border-white"
                            >
                                <PlusCircle className="mr-2 h-4 w-4" />
                                Add to Keep List
                            </Button>
                        )}
                        <Button
                            onClick={(e) => {
                                e.stopPropagation();
                                handleListOnMarketplace();
                            }}
                            size="sm"
                            className="bg-primary hover:bg-primary/90"
                        >
                            <ShoppingCart className="mr-2 h-4 w-4" />
                            List on Marketplace
                        </Button>
                    </div>
                )}
            </div>

            <div className="absolute top-2 left-2 bg-black/50 p-2 rounded-lg text-white text-xs flex items-center gap-1">
                <Sparkles className="w-4 h-4 text-accent" />
                <span>AI Active</span>
                <div className={cn('w-2 h-2 rounded-full ml-1', isCameraActive ? 'bg-green-500' : 'bg-red-500')} />
            </div>
            {isCameraActive && (
                <div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/50 text-white text-xs px-3 py-1.5 rounded-full pointer-events-none">
                    Tap screen to scan
                </div>
            )}
            <button onClick={(e) => { e.stopPropagation(); toggleCamera(); }} className="absolute top-2 right-2 bg-black/50 p-2 rounded-full text-white text-xs z-30">
                {isCameraActive ? <CameraOff className="w-4 h-4" /> : <Camera className="w-4 h-4" />}
            </button>
        </div>
    );
}

================================================================================
FILE: src/components/research/history-log.tsx
================================================================================
'use client';

import { Trash2, PlusCircle, ShoppingCart, DollarSign, TrendingUp } from 'lucide-react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import { formatDistanceToNow } from 'date-fns';
import type { ScanHistoryItem } from '@/lib/research-types';
import { formatCardDetails } from '@/lib/card-logic';

interface HistoryLogProps {
    history: ScanHistoryItem[];
    onDeleteItem: (id: string) => void;
    onAddNameToKeep: (name: string, sport?: string) => void;
}

export default function HistoryLog({
    history,
    onDeleteItem,
    onAddNameToKeep,
}: HistoryLogProps) {
    const router = useRouter();

    const handleListOnMarketplace = (item: ScanHistoryItem) => {
        const listingData = {
            title: `${item.name}${item.cardYear ? ` ${item.cardYear}` : ''}${item.brand ? ` ${item.brand}` : ''}${item.cardType ? ` ${item.cardType}` : ''}`,
            description: `${item.brand || 'Trading'} Card featuring ${item.name}${item.sport ? ` - ${item.sport}` : ''}${item.cardType ? ` ${item.cardType}` : ''}`,
            category: 'Collector Cards',
            subCategory: 'Trading Cards',
            year: item.cardYear,
            manufacturer: item.brand,
            imageDataUri: item.imageDataUri,
        };

        sessionStorage.setItem('researchScanData', JSON.stringify(listingData));
        router.push('/sell/create?from=research');
    };

    if (history.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center h-64 text-center p-4">
                <p className="text-muted-foreground">No scans yet</p>
                <p className="text-sm text-muted-foreground mt-2">
                    Use the camera to scan trading cards
                </p>
            </div>
        );
    }

    return (
        <ScrollArea className="h-[500px] pr-4">
            <div className="space-y-3">
                {history.map((item) => (
                    <div
                        key={item.id}
                        className={`p-4 rounded-lg border transition-all hover:shadow-md ${item.isPrizmRookie
                                ? 'border-yellow-400 bg-gradient-to-r from-yellow-50 to-pink-50'
                                : item.isKeeper
                                    ? 'border-green-300 bg-green-50'
                                    : 'border-gray-200 bg-white'
                            }`}
                    >
                        <div className="flex items-start justify-between gap-3">
                            <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1">
                                    <h3 className="font-semibold text-sm truncate">
                                        {item.name}
                                    </h3>
                                    {item.isPrizmRookie && (
                                        <Badge className="bg-gradient-to-r from-yellow-400 to-pink-500 text-white text-xs">
                                            PRIZM
                                        </Badge>
                                    )}
                                    {item.isKeeper && !item.isPrizmRookie && (
                                        <Badge variant="default" className="bg-green-600 text-xs">
                                            KEEP
                                        </Badge>
                                    )}
                                </div>

                                <p className="text-xs text-muted-foreground mb-2">
                                    {formatCardDetails(item)}
                                </p>

                                {item.salesData && item.salesData.averagePrice && (
                                    <div className="flex items-center gap-3 text-xs text-muted-foreground mb-2">
                                        <div className="flex items-center gap-1">
                                            <DollarSign className="w-3 h-3" />
                                            <span className="font-semibold text-green-600">
                                                ${item.salesData.averagePrice}
                                            </span>
                                            <span>avg</span>
                                        </div>
                                        {item.salesData.salesCount && (
                                            <div className="flex items-center gap-1">
                                                <TrendingUp className="w-3 h-3" />
                                                <span>{item.salesData.salesCount} sales</span>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <p className="text-xs text-muted-foreground">
                                    {formatDistanceToNow(item.timestamp, { addSuffix: true })}
                                </p>

                                <div className="flex gap-2 mt-3">
                                    <Button
                                        onClick={() => handleListOnMarketplace(item)}
                                        size="sm"
                                        variant="default"
                                        className="text-xs h-7"
                                    >
                                        <ShoppingCart className="w-3 h-3 mr-1" />
                                        List
                                    </Button>
                                    {!item.isKeeper && (
                                        <Button
                                            onClick={() => onAddNameToKeep(item.name, item.sport)}
                                            size="sm"
                                            variant="outline"
                                            className="text-xs h-7"
                                        >
                                            <PlusCircle className="w-3 h-3 mr-1" />
                                            Keep
                                        </Button>
                                    )}
                                </div>
                            </div>

                            <Button
                                onClick={() => onDeleteItem(item.id)}
                                variant="ghost"
                                size="icon"
                                className="h-8 w-8 text-muted-foreground hover:text-destructive"
                            >
                                <Trash2 className="h-4 w-4" />
                            </Button>
                        </div>
                    </div>
                ))}
            </div>
        </ScrollArea>
    );
}

================================================================================
FILE: src/components/reviews/ReviewForm.tsx
================================================================================

'use client';

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { collection, addDoc, serverTimestamp, query, where, getDocs } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';
import { useToast } from '@/hooks/use-toast';
import { Loader2, Star } from 'lucide-react';
import { cn } from '@/lib/utils';
import type { SafeUser } from '@/lib/types';
import Link from 'next/link';

const reviewSchema = z.object({
  rating: z.number().min(1, 'Rating is required').max(5),
  comment: z.string().min(10, 'Comment must be at least 10 characters long').max(1000),
});

interface ReviewFormProps {
  user: SafeUser;
  productId: string;
  productTitle: string;
  sellerId: string;
}

export default function ReviewForm({ user, productId, productTitle, sellerId }: ReviewFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [hoverRating, setHoverRating] = useState(0);
  const [hasReviewed, setHasReviewed] = useState(false); // Add this state
  const { toast } = useToast();

  const form = useForm<z.infer<typeof reviewSchema>>({
    resolver: zodResolver(reviewSchema),
    defaultValues: {
      rating: 0,
      comment: '',
    },
  });

   // Check if user has already reviewed this product
   useEffect(() => {
    if (!user) return;
    const checkReview = async () => {
        const q = query(
            collection(db, "reviews"),
            where("productId", "==", productId),
            where("buyerId", "==", user.uid)
        );
        const querySnapshot = await getDocs(q);
        if (!querySnapshot.empty) {
            setHasReviewed(true);
        }
    };
    checkReview();
  }, [user, productId]);


  async function onSubmit(values: z.infer<typeof reviewSchema>) {
    if (!user) {
      toast({ title: 'You must be signed in to leave a review.', variant: 'destructive' });
      return;
    }
    
    // Check if the user is trying to review their own product
    if (user.uid === sellerId) {
      toast({ title: "You can't review your own product.", variant: 'destructive' });
      return;
    }

    setIsSubmitting(true);
    try {
      await addDoc(collection(db, 'reviews'), {
        ...values,
        productId,
        productTitle,
        sellerId,
        buyerId: user.uid,
        buyerName: user.displayName,
        buyerAvatar: user.photoURL,
        createdAt: serverTimestamp(),
      });

      toast({ title: 'Review submitted successfully!' });
      form.reset();
      setHasReviewed(true); // Set hasReviewed to true after submission
    } catch (error: any) {
      console.error('Error submitting review:', error);
      toast({
        title: 'Failed to submit review.',
        description: error.message,
        variant: 'destructive',
      });
    } finally {
      setIsSubmitting(false);
    }
  }

  if (!user) {
    return (
      <div className="border rounded-lg p-6 text-center bg-gray-50">
        <p className="text-muted-foreground">
          <Button variant="link" asChild><Link href={`/sign-in?redirect=/product/${productId}`}>Sign in</Link></Button> to leave a review.
        </p>
      </div>
    );
  }
  
  if (hasReviewed) {
    return (
        <div className="border rounded-lg p-6 text-center bg-green-50 text-green-800">
            <p className="font-semibold">Thank you for your review!</p>
        </div>
    )
  }

  return (
    <div className="border rounded-lg p-6">
        <h3 className="text-lg font-semibold mb-4">Write a Review</h3>
        <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            <FormField
            control={form.control}
            name="rating"
            render={({ field }) => (
                <FormItem>
                <FormLabel>Your Rating</FormLabel>
                <FormControl>
                    <div className="flex items-center gap-1">
                    {[1, 2, 3, 4, 5].map((star) => (
                        <Star
                        key={star}
                        className={cn(
                            'h-8 w-8 cursor-pointer transition-colors',
                            (hoverRating >= star || field.value >= star)
                            ? 'text-yellow-400 fill-yellow-400'
                            : 'text-gray-300'
                        )}
                        onMouseEnter={() => setHoverRating(star)}
                        onMouseLeave={() => setHoverRating(0)}
                        onClick={() => field.onChange(star)}
                        />
                    ))}
                    </div>
                </FormControl>
                <FormMessage />
                </FormItem>
            )}
            />
            <FormField
            control={form.control}
            name="comment"
            render={({ field }) => (
                <FormItem>
                <FormLabel>Your Comment</FormLabel>
                <FormControl>
                    <Textarea
                    placeholder="Tell us about your experience with this item and seller..."
                    rows={4}
                    {...field}
                    />
                </FormControl>
                <FormMessage />
                </FormItem>
            )}
            />
            <Button type="submit" disabled={isSubmitting}>
            {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
            Submit Review
            </Button>
        </form>
        </Form>
    </div>
  );
}

================================================================================
FILE: src/components/reviews/ReviewList.tsx
================================================================================

'use client';

import { Review } from '@/lib/types';
import { Card, CardContent } from '@/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Star, Loader2, MessageSquare } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { Skeleton } from '@/components/ui/skeleton';

interface ReviewListProps {
  reviews: Review[];
  isLoading: boolean;
}

function ReviewSkeleton() {
    return (
        <div className="flex gap-4">
            <Skeleton className="h-10 w-10 rounded-full" />
            <div className="flex-1 space-y-2">
                <Skeleton className="h-4 w-1/4" />
                <Skeleton className="h-4 w-full" />
                <Skeleton className="h-4 w-3/4" />
            </div>
        </div>
    )
}

export default function ReviewList({ reviews, isLoading }: ReviewListProps) {
  if (isLoading) {
    return (
        <div className="space-y-6">
            <ReviewSkeleton />
            <ReviewSkeleton />
        </div>
    )
  }

  if (reviews.length === 0) {
    return (
      <div className="text-center py-12 text-gray-500 border-2 border-dashed rounded-lg">
        <MessageSquare className="h-12 w-12 mx-auto mb-4 text-gray-300" />
        <h3 className="text-lg font-semibold">No reviews yet</h3>
        <p>Be the first to share your thoughts on this item.</p>
      </div>
    );
  }

  return (
    <div className="space-y-6 mt-6">
      {reviews.map((review) => (
        <Card key={review.id}>
          <CardContent className="p-6">
            <div className="flex gap-4">
              <Avatar>
                <AvatarImage src={review.buyerAvatar} alt={review.buyerName || 'Reviewer'} />
                <AvatarFallback>{review.buyerName?.[0]}</AvatarFallback>
              </Avatar>
              <div className="flex-1">
                <div className="flex items-center justify-between">
                  <h4 className="font-semibold">{review.buyerName}</h4>
                  <span className="text-xs text-muted-foreground">
                    {review.createdAt && formatDistanceToNow(review.createdAt.toDate(), { addSuffix: true })}
                  </span>
                </div>
                <div className="flex items-center gap-1 mt-1">
                  {[...Array(5)].map((_, i) => (
                    <Star
                      key={i}
                      className={`h-4 w-4 ${
                        i < review.rating ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300'
                      }`}
                    />
                  ))}
                </div>
                <p className="text-muted-foreground mt-3">{review.comment}</p>
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}

================================================================================
FILE: src/components/search/SearchCommand.tsx
================================================================================

"use client"

import * as React from "react"
import { useRouter } from "next/navigation"
import { Calculator, Calendar, CreditCard, Settings, Smile, User, Search, Home, ShoppingBag, Coins, Layers } from "lucide-react"

import {
    CommandDialog,
    CommandEmpty,
    CommandGroup,
    CommandInput,
    CommandItem,
    CommandList,
    CommandSeparator,
    CommandShortcut,
} from "@/components/ui/command"
import { DialogTitle, DialogDescription } from "../ui/dialog"

interface SearchCommandProps {
    open: boolean;
    setOpen: React.Dispatch<React.SetStateAction<boolean>>;
}

export function SearchCommand({ open, setOpen }: SearchCommandProps) {
    const router = useRouter()

    React.useEffect(() => {
        const down = (e: KeyboardEvent) => {
            if (e.key === "k" && (e.metaKey || e.ctrlKey)) {
                e.preventDefault()
                setOpen((prev: boolean) => !prev)
            }
        }

        document.addEventListener("keydown", down)
        return () => document.removeEventListener("keydown", down)
    }, [setOpen])

    const runCommand = React.useCallback((command: () => unknown) => {
        setOpen(false)
        command()
    }, [setOpen])

    const [search, setSearch] = React.useState("")

    const handleSearch = () => {
        if (!search) return;
        runCommand(() => router.push(`/browse?q=${encodeURIComponent(search)}`))
    }

    return (
        <CommandDialog open={open} onOpenChange={setOpen}>
            <DialogTitle className="sr-only">Search the site</DialogTitle>
            <DialogDescription className="sr-only">Use this command palette to search for products or navigate to different pages.</DialogDescription>
            <CommandInput
                placeholder="Type a command or search..."
                value={search}
                onValueChange={setSearch}
                onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                        handleSearch();
                    }
                }}
            />
            <CommandList>
                <CommandEmpty>No results found.</CommandEmpty>
                {search && (
                    <CommandGroup heading="Search">
                        <CommandItem onSelect={handleSearch}>
                            <Search className="mr-2 h-4 w-4" />
                            <span>Search for "{search}"</span>
                        </CommandItem>
                    </CommandGroup>
                )}
                <CommandGroup heading="Suggestions">
                    <CommandItem onSelect={() => runCommand(() => router.push('/browse'))}>
                        <ShoppingBag className="mr-2 h-4 w-4" />
                        <span>Browse All</span>
                    </CommandItem>
                    <CommandItem onSelect={() => runCommand(() => router.push('/collector-cards'))}>
                        <Layers className="mr-2 h-4 w-4" />
                        <span>Collector Cards</span>
                    </CommandItem>
                    <CommandItem onSelect={() => runCommand(() => router.push('/coins'))}>
                        <Coins className="mr-2 h-4 w-4" />
                        <span>Coins</span>
                    </CommandItem>
                </CommandGroup>
                <CommandSeparator />
                <CommandGroup heading="My Account">
                    <CommandItem onSelect={() => runCommand(() => router.push('/profile'))}>
                        <User className="mr-2 h-4 w-4" />
                        <span>Profile</span>
                    </CommandItem>
                    <CommandItem onSelect={() => runCommand(() => router.push('/sell/dashboard'))}>
                        <Settings className="mr-2 h-4 w-4" />
                        <span>Seller Dashboard</span>
                    </CommandItem>
                </CommandGroup>
            </CommandList>
        </CommandDialog>
    )
}

================================================================================
FILE: src/components/sell/EbayPriceLookup.tsx
================================================================================
'use client';

import { useState, useEffect } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { ExternalLink } from 'lucide-react';
import { Input } from '@/components/ui/input';

interface PriceLookupPopupProps {
  isOpen: boolean;
  onClose: () => void;
  searchParams?: {
    title?: string;
    year?: number;
  };
  onPriceSelect?: (price: number) => void;
}

export function EbayPriceLookup({ 
  isOpen, 
  onClose, 
  searchParams = {},
}: PriceLookupPopupProps) {
  const [searchQuery, setSearchQuery] = useState('');

  const { title, year } = searchParams;

  useEffect(() => {
    if (isOpen) {
      const parts = [];
      if (year) parts.push(year.toString());
      if (title) parts.push(title);
      const newQuery = parts.join(' ').trim();
      // eslint-disable-next-line react-hooks/set-state-in-effect
      setSearchQuery(prev => prev !== newQuery ? newQuery : prev);
    }
  }, [isOpen, title, year]);

  const handleSearchClick = () => {
    if (!searchQuery) return;
    // Construct eBay URL for "sold" items
    // _nkw: search query
    // LH_Sold=1: Sold items
    // LH_Complete=1: Completed listings (usually goes with Sold)
    const encodedQuery = encodeURIComponent(searchQuery);
    const ebayUrl = `https://www.ebay.com/sch/i.html?_nkw=${encodedQuery}&LH_Sold=1&LH_Complete=1&_ipg=60`;
    window.open(ebayUrl, '_blank', 'noopener,noreferrer');
    onClose();
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Research Sold Prices</DialogTitle>
          <DialogDescription>
             Search for similar sold items on eBay to determine a competitive price.
          </DialogDescription>
        </DialogHeader>
        
        <div className="flex items-center space-x-2 my-4">
          <Input 
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="e.g. 1999 Pokemon Charizard"
            onKeyDown={(e) => e.key === 'Enter' && handleSearchClick()}
          />
        </div>

        <DialogFooter className="sm:justify-start">
           <Button type="button" onClick={handleSearchClick} className="w-full sm:w-auto">
              <ExternalLink className="mr-2 h-4 w-4" />
              Search Sold Items on eBay
           </Button>
           <Button type="button" variant="secondary" onClick={onClose} className="w-full sm:w-auto mt-2 sm:mt-0">
             Close
           </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
================================================================================
FILE: src/components/ui/EmptyState.tsx
================================================================================
import { ShoppingBag, Search } from 'lucide-react';
import { Button } from './button';
import Link from 'next/link';
import { cn } from '@/lib/utils';
import { Inbox } from "lucide-react";

interface EmptyStateProps {
  title?: string;
  description?: string;
  icon?: React.ReactNode;
  className?: string;
  children?: React.ReactNode; 
  actionLabel?: string;
  href?: string;
}

export default function EmptyState({ 
  title = "No items found", 
  description = "We couldn't find any items matching your criteria.", 
  icon = <Search className="h-8 w-8 text-muted-foreground" />,
  actionLabel, 
  href,
  className,
  children
}: EmptyStateProps) {
  return (
    <div className={cn("flex flex-col items-center justify-center py-12 text-center border-2 border-dashed rounded-lg bg-muted/10", className)}>
      <div className="bg-background p-4 rounded-full mb-4 shadow-sm">
        {icon}
      </div>
      <h3 className="text-lg font-semibold">{title}</h3>
      <p className="text-muted-foreground max-w-sm mt-2 mb-6">{description}</p>
      {actionLabel && href && (
        <Button asChild>
          <Link href={href}>{actionLabel}</Link>
        </Button>
      )}
      {children}
    </div>
  );
}

================================================================================
FILE: src/components/ui/accordion.tsx
================================================================================
"use client"

import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))

AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }

================================================================================
FILE: src/components/ui/alert-dialog.tsx
================================================================================
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}

================================================================================
FILE: src/components/ui/alert.tsx
================================================================================
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }

================================================================================
FILE: src/components/ui/avatar.tsx
================================================================================
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }

================================================================================
FILE: src/components/ui/badge.tsx
================================================================================
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }

================================================================================
FILE: src/components/ui/button.tsx
================================================================================
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }

================================================================================
FILE: src/components/ui/camera-capture.tsx
================================================================================
'use client';

import React, { useRef, useState, useCallback, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Camera, VideoOff, Trash2, CheckCircle, X, Loader2 } from 'lucide-react';
import { Dialog, DialogContent, DialogTrigger, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { ARCameraOverlay } from '@/components/ar-camera-overlay';
import { useToast } from '@/hooks/use-toast';
import Image from 'next/image';
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge';

interface CameraCaptureProps {
    onCapture: (files: File[]) => void;
    maxSizeMB?: number;
    captureMode?: 'card' | 'coin' | 'default';
    variant?: 'button' | 'hero';
    maxFiles?: number;
}

export function CameraCapture({ onCapture, maxSizeMB = 10, captureMode = 'default', variant = 'button', maxFiles = 4 }: CameraCaptureProps) {
    const videoRef = useRef<HTMLVideoElement>(null);
    const canvasRef = useRef<HTMLCanvasElement>(null);
    const [isDialogOpen, setIsDialogOpen] = useState(false);
    const [stream, setStream] = useState<MediaStream | null>(null);
    const [cameras, setCameras] = useState<MediaDeviceInfo[]>([]);
    const [selectedCamera, setSelectedCamera] = useState<string>('');
    const [hasCameraPermission, setHasCameraPermission] = useState<boolean | null>(null);
    const [error, setError] = useState<string | null>(null);
    const [isCameraLoading, setIsCameraLoading] = useState(false);

    // Multi-shot state
    const [capturedFiles, setCapturedFiles] = useState<File[]>([]);
    const [capturedPreviews, setCapturedPreviews] = useState<string[]>([]);

    const { toast } = useToast();

    // Track previews for cleanup to avoid closure staleness on unmount
    const previewsRef = useRef<string[]>([]);
    useEffect(() => {
        previewsRef.current = capturedPreviews;
    }, [capturedPreviews]);

    // Cleanup previews strictly on unmount
    useEffect(() => {
        return () => {
            previewsRef.current.forEach(url => URL.revokeObjectURL(url));
        };
    }, []);

    // Cleanup stream on unmount or stream change
    useEffect(() => {
        return () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        };
    }, [stream]);

    // Check for iOS Safari specifics on mount
    useEffect(() => {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        if (isIOS && isSafari) {
            // iOS Safari requires https or localhost
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                setError('Camera requires HTTPS on iOS Safari');
            }
        }
    }, []);


    const startCamera = useCallback(async (deviceId: string) => {
        setIsCameraLoading(true);
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        setError(null);

        try {
            // Constraints with fallback support
            const constraints: MediaStreamConstraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    aspectRatio: { ideal: 16 / 9 },
                    facingMode: deviceId ? undefined : 'environment' // Default to back camera
                }
            };

            const newStream = await navigator.mediaDevices.getUserMedia(constraints);
            setStream(newStream);
            setHasCameraPermission(true);

            if (videoRef.current) {
                videoRef.current.srcObject = newStream;
                // iOS Safari requires playing immediately
                await videoRef.current.play();
            }

            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            setCameras(videoDevices);
        } catch (err: any) {
            console.error("Error accessing camera:", err);

            // Retry with simpler constraints if it failed
            if (err.name === 'OverconstrainedError' || err.name === 'ConstraintNotSatisfiedError') {
                try {
                    const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    setStream(fallbackStream);
                    setHasCameraPermission(true);
                    if (videoRef.current) {
                        videoRef.current.srcObject = fallbackStream;
                        await videoRef.current.play();
                    }
                } catch (fallbackErr) {
                    setError("Could not access camera even with fallback settings.");
                    setHasCameraPermission(false);
                }
            } else {
                setError("Could not access the selected camera. It might be in use or permissions are denied.");
                setHasCameraPermission(false);
            }
        } finally {
            setIsCameraLoading(false);
        }
    }, [stream]);

    const initializeCamera = useCallback(async () => {
        setCapturedPreviews([]);
        setCapturedFiles([]);
        if (typeof navigator.mediaDevices?.getUserMedia !== 'function') {
            setError("Camera access is not supported by your browser.");
            setHasCameraPermission(false);
            return;
        }
        try {
            // iOS Safari: Check for Permission specifically if possible, otherwise just try
            // Note: navigator.permissions is not fully supported on iOS Safari yet, so we proceed to try getUserMedia

            // Try to get initial stream to prompt permission
            setIsCameraLoading(true);
            await navigator.mediaDevices.getUserMedia({ video: true }).then(s => s.getTracks().forEach(t => t.stop()));
            setHasCameraPermission(true);

            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');

            if (videoDevices.length === 0) {
                setError("No camera devices found.");
                setHasCameraPermission(false);
                return;
            }

            setCameras(videoDevices);
            const backCamera = videoDevices.find(d => d.label.toLowerCase().includes('back'));
            const selectedDeviceId = backCamera ? backCamera.deviceId : videoDevices[0].deviceId;
            setSelectedCamera(selectedDeviceId);
            await startCamera(selectedDeviceId);
        } catch (err) {
            console.error("Camera initialization failed:", err);
            setHasCameraPermission(false);
            setError("Camera permission was denied. Please enable it in your browser settings.");
        } finally {
            setIsCameraLoading(false);
        }
    }, [startCamera]);

    const stopStream = useCallback(() => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            setStream(null);
        }
    }, [stream]);

    const handleOpenChange = (open: boolean) => {
        setIsDialogOpen(open);
        if (open) {
            initializeCamera();
        } else {
            stopStream();
        }
    };

    const takePhoto = () => {
        if (!videoRef.current || !canvasRef.current || capturedFiles.length >= maxFiles) return;

        const video = videoRef.current;
        const canvas = canvasRef.current;
        const context = canvas.getContext('2d');
        if (!context) return;

        const videoWidth = video.videoWidth;
        const videoHeight = video.videoHeight;

        // Reset canvas dimensions to match the current video frame
        canvas.width = videoWidth;
        canvas.height = videoHeight;

        // Clear any previous drawing
        context.clearRect(0, 0, canvas.width, canvas.height);

        context.drawImage(video, 0, 0, videoWidth, videoHeight);

        canvas.toBlob((blob) => {
            if (blob) {
                const file = new File([blob], `capture_${Date.now()}.jpg`, { type: 'image/jpeg' });
                if (file.size > maxSizeMB * 1024 * 1024) {
                    toast({ title: 'Image too large', description: `The captured photo exceeds the ${maxSizeMB}MB limit.`, variant: 'destructive' });
                    return;
                }
                setCapturedFiles(prev => [...prev, file]);
                setCapturedPreviews(prev => [...prev, URL.createObjectURL(file)]);
            }
        }, 'image/jpeg', 0.9);
    };

    const removeCapturedImage = (indexToRemove: number) => {
        const urlToRemove = capturedPreviews[indexToRemove];
        URL.revokeObjectURL(urlToRemove);
        setCapturedPreviews(prev => prev.filter((_, index) => index !== indexToRemove));
        setCapturedFiles(prev => prev.filter((_, index) => index !== indexToRemove));
    };

    const handleDone = () => {
        onCapture(capturedFiles);
        setIsDialogOpen(false);
        stopStream();
    };

    return (
        <>
            <Dialog open={isDialogOpen} onOpenChange={handleOpenChange}>
                <DialogTrigger asChild>
                    {variant === 'hero' ? (
                        <div className="group relative aspect-square sm:aspect-video rounded-3xl border-2 border-solid border-indigo-600 bg-indigo-600/5 hover:bg-indigo-600/10 cursor-pointer flex flex-col items-center justify-center text-center p-6 transition-all shadow-sm hover:scale-[1.02] active:scale-[0.98]">
                            <div className="bg-indigo-600 p-5 rounded-full shadow-lg shadow-indigo-200 mb-4 group-hover:scale-110 transition-transform">
                                <Camera className="h-8 w-8 text-white" />
                            </div>
                            <h3 className="text-xl font-black text-indigo-900 tracking-tight">Use Camera</h3>
                            <p className="text-sm font-medium text-indigo-600/70 mt-2 max-w-[200px]">
                                Snap a photo from your <span className="font-bold">mobile device</span> or <span className="font-bold">computer camera</span>
                            </p>
                        </div>
                    ) : (
                        <Button variant="outline" className="gap-2">
                            <Camera className="w-4 h-4" /> Take Photo
                        </Button>
                    )}
                </DialogTrigger>
                <DialogContent className="max-w-4xl w-full p-0 gap-0 overflow-hidden bg-black border-slate-800">
                    <div className="absolute top-0 left-0 right-0 z-50 p-4 flex justify-between items-start bg-gradient-to-b from-black/80 to-transparent">
                        <div className="text-white">
                            <DialogTitle className="text-lg font-bold">Camera</DialogTitle>
                            <DialogDescription className="text-white/60 text-xs">
                                {capturedFiles.length} / {maxFiles} photos taken
                            </DialogDescription>
                        </div>
                        {cameras.length > 1 && (
                            <Select value={selectedCamera} onValueChange={(value) => { setSelectedCamera(value); startCamera(value); }} disabled={!hasCameraPermission}>
                                <SelectTrigger className="w-[140px] h-8 bg-white/10 border-white/20 text-white text-xs backdrop-blur-md">
                                    <SelectValue placeholder="Switch Camera" />
                                </SelectTrigger>
                                <SelectContent>
                                    {cameras.map(cam => (
                                        <SelectItem key={cam.deviceId} value={cam.deviceId}>
                                            {cam.label || `Camera ${cameras.indexOf(cam) + 1}`}
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        )}
                        <Button variant="ghost" size="icon" className="absolute top-2 right-2 text-white/70 hover:text-white" onClick={() => setIsDialogOpen(false)}><X /></Button>
                    </div>

                    <div className="relative w-full h-[60vh] md:h-[70vh] bg-black flex items-center justify-center overflow-hidden">
                        <video
                            ref={videoRef}
                            autoPlay
                            playsInline // REQUIRED for iOS Safari
                            muted
                            className="absolute inset-0 w-full h-full object-cover"
                        />
                        {isCameraLoading && (
                            <div className="absolute inset-0 flex items-center justify-center z-50 bg-black/50">
                                <Loader2 className="h-12 w-12 text-indigo-500 animate-spin" />
                            </div>
                        )}
                        {hasCameraPermission === false && !isCameraLoading && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/80 p-6 text-center z-40">
                                <VideoOff className="h-12 w-12 text-red-500 mb-4" />
                                <h3 className="text-white font-bold mb-2">Camera Access Denied</h3>
                                <p className="text-white/60 text-sm">{error || "Please check your browser settings."}</p>
                            </div>
                        )}
                        {hasCameraPermission && !isCameraLoading && <ARCameraOverlay guideType={captureMode === 'default' ? 'card' : captureMode} />}

                        <div className="absolute bottom-8 left-0 right-0 flex justify-center z-50">
                            <button
                                onClick={takePhoto}
                                disabled={!stream || !hasCameraPermission || capturedFiles.length >= maxFiles || isCameraLoading}
                                className={cn(
                                    "w-20 h-20 rounded-full border-4 border-white flex items-center justify-center transition-all active:scale-95",
                                    (capturedFiles.length >= maxFiles || isCameraLoading) ? "opacity-50 cursor-not-allowed border-slate-500" : "hover:bg-white/20"
                                )}
                            >
                                <div className="w-16 h-16 rounded-full bg-white shadow-lg" />
                            </button>
                        </div>
                    </div>

                    <div className="bg-slate-950 p-4 border-t border-white/10">
                        <div className="flex items-center gap-4 overflow-x-auto pb-4 scrollbar-thin scrollbar-thumb-white/20">
                            {capturedPreviews.map((url, idx) => (
                                <div key={url} className="relative flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border border-white/20 group">
                                    <Image src={url} alt={`Capture ${idx}`} className="w-full h-full object-cover" width={64} height={64} style={{ WebkitUserSelect: 'none', WebkitTransform: 'translateZ(0)' }} />
                                    <button
                                        onClick={() => removeCapturedImage(idx)}
                                        className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                                    >
                                        <Trash2 className="w-6 h-6 text-white" />
                                    </button>
                                    <Badge className="absolute bottom-0 right-0 rounded-none rounded-tl-md bg-indigo-600 px-1 py-0 text-[10px]">
                                        {idx + 1}
                                    </Badge>
                                </div>
                            ))}
                            {capturedFiles.length < maxFiles && (
                                <div className="w-16 h-16 rounded-lg border-2 border-dashed border-white/10 flex items-center justify-center text-white/20 text-xs">
                                    {maxFiles - capturedFiles.length} left
                                </div>
                            )}
                        </div>
                        <div className="flex gap-3 mt-2">
                            <Button
                                variant="outline"
                                className="flex-1 bg-transparent border-white/20 text-white hover:bg-white/10 hover:text-white"
                                onClick={() => setIsDialogOpen(false)}
                            >
                                Cancel
                            </Button>
                            <Button
                                className="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold"
                                onClick={handleDone}
                                disabled={capturedFiles.length === 0}
                            >
                                <CheckCircle className="w-4 h-4 mr-2" />
                                Add {capturedFiles.length} Photo{capturedFiles.length !== 1 && 's'}
                            </Button>
                        </div>
                    </div>
                </DialogContent>
            </Dialog>
            <canvas ref={canvasRef} className="hidden" />
        </>
    );
}
================================================================================
FILE: src/components/ui/card.tsx
================================================================================
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }

================================================================================
FILE: src/components/ui/carousel.tsx
================================================================================
"use client"

import * as React from "react"
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react"
import { ArrowLeft, ArrowRight } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: "horizontal" | "vertical"
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />")
  }

  return context
}

const Carousel = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & CarouselProps
>(
  (
    {
      orientation = "horizontal",
      opts,
      setApi,
      plugins,
      className,
      children,
      ...props
    },
    ref
  ) => {
    const [carouselRef, api] = useEmblaCarousel(
      {
        ...opts,
        axis: orientation === "horizontal" ? "x" : "y",
      },
      plugins
    )
    const [canScrollPrev, setCanScrollPrev] = React.useState(false)
    const [canScrollNext, setCanScrollNext] = React.useState(false)

    const onSelect = React.useCallback((api: CarouselApi) => {
      if (!api) {
        return
      }

      setCanScrollPrev(api.canScrollPrev())
      setCanScrollNext(api.canScrollNext())
    }, [])

    const scrollPrev = React.useCallback(() => {
      api?.scrollPrev()
    }, [api])

    const scrollNext = React.useCallback(() => {
      api?.scrollNext()
    }, [api])

    const handleKeyDown = React.useCallback(
      (event: React.KeyboardEvent<HTMLDivElement>) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault()
          scrollPrev()
        } else if (event.key === "ArrowRight") {
          event.preventDefault()
          scrollNext()
        }
      },
      [scrollPrev, scrollNext]
    )

    React.useEffect(() => {
      if (!api || !setApi) {
        return
      }

      setApi(api)
    }, [api, setApi])

    React.useEffect(() => {
      if (!api) {
        return
      }

      onSelect(api)
      api.on("reInit", onSelect)
      api.on("select", onSelect)

      return () => {
        api?.off("select", onSelect)
      }
    }, [api, onSelect])

    return (
      <CarouselContext.Provider
        value={{
          carouselRef,
          api: api,
          opts,
          orientation:
            orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
          scrollPrev,
          scrollNext,
          canScrollPrev,
          canScrollNext,
        }}
      >
        <div
          ref={ref}
          onKeyDownCapture={handleKeyDown}
          className={cn("relative", className)}
          role="region"
          aria-roledescription="carousel"
          {...props}
        >
          {children}
        </div>
      </CarouselContext.Provider>
    )
  }
)
Carousel.displayName = "Carousel"

const CarouselContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div ref={carouselRef} className="overflow-hidden">
      <div
        ref={ref}
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props}
      />
    </div>
  )
})
CarouselContent.displayName = "CarouselContent"

const CarouselItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { orientation } = useCarousel()

  return (
    <div
      ref={ref}
      role="group"
      aria-roledescription="slide"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props}
    />
  )
})
CarouselItem.displayName = "CarouselItem"

const CarouselPrevious = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute  h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-left-12 top-1/2 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft className="h-4 w-4" />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
})
CarouselPrevious.displayName = "CarouselPrevious"

const CarouselNext = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-right-12 top-1/2 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight className="h-4 w-4" />
      <span className="sr-only">Next slide</span>
    </Button>
  )
})
CarouselNext.displayName = "CarouselNext"

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}

================================================================================
FILE: src/components/ui/checkbox.tsx
================================================================================
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }

================================================================================
FILE: src/components/ui/collapsible.tsx
================================================================================
"use client"

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

const Collapsible = CollapsiblePrimitive.Root

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent

export { Collapsible, CollapsibleTrigger, CollapsibleContent }

================================================================================
FILE: src/components/ui/command.tsx
================================================================================
"use client"

import * as React from "react"
import { type DialogProps } from "@radix-ui/react-dialog"
import { Command as CommandPrimitive } from "cmdk"
import { Search } from "lucide-react"

import { cn } from "@/lib/utils"
import { Dialog, DialogContent } from "@/components/ui/dialog"

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className
    )}
    {...props}
  />
))
Command.displayName = CommandPrimitive.displayName

interface CommandDialogProps extends DialogProps {}

const CommandDialog = ({ children, ...props }: CommandDialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0 shadow-lg">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    />
  </div>
))

CommandInput.displayName = CommandPrimitive.Input.displayName

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
))

CommandList.displayName = CommandPrimitive.List.displayName

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => (
  <CommandPrimitive.Empty
    ref={ref}
    className="py-6 text-center text-sm"
    {...props}
  />
))

CommandEmpty.displayName = CommandPrimitive.Empty.displayName

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className
    )}
    {...props}
  />
))

CommandGroup.displayName = CommandPrimitive.Group.displayName

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 h-px bg-border", className)}
    {...props}
  />
))
CommandSeparator.displayName = CommandPrimitive.Separator.displayName

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none aria-selected:bg-accent aria-selected:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  />
))

CommandItem.displayName = CommandPrimitive.Item.displayName

const CommandShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
CommandShortcut.displayName = "CommandShortcut"

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandSeparator,
  CommandShortcut,
}
================================================================================
FILE: src/components/ui/dialog.tsx
================================================================================

"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}

================================================================================
FILE: src/components/ui/dropdown-menu.tsx
================================================================================
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}

================================================================================
FILE: src/components/ui/form.tsx
================================================================================
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  FormProvider,
  useFormContext,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState, formState } = useFormContext()

  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

const FormItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div ref={ref} className={cn("space-y-2", className)} {...props} />
    </FormItemContext.Provider>
  )
})
FormItem.displayName = "FormItem"

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField()

  return (
    <Label
      ref={ref}
      className={cn(error && "text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
})
FormLabel.displayName = "FormLabel"

const FormControl = React.forwardRef<
  React.ElementRef<typeof Slot>,
  React.ComponentPropsWithoutRef<typeof Slot>
>(({ ...props }, ref) => {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      ref={ref}
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
})
FormControl.displayName = "FormControl"

const FormDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
  const { formDescriptionId } = useFormField()

  return (
    <p
      ref={ref}
      id={formDescriptionId}
      className={cn("text-sm text-muted-foreground", className)}
      {...props}
    />
  )
})
FormDescription.displayName = "FormDescription"

const FormMessage = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? "") : children

  if (!body) {
    return null
  }

  return (
    <p
      ref={ref}
      id={formMessageId}
      className={cn("text-sm font-medium text-destructive", className)}
      {...props}
    >
      {body}
    </p>
  )
})
FormMessage.displayName = "FormMessage"

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}

================================================================================
FILE: src/components/ui/input.tsx
================================================================================
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }

================================================================================
FILE: src/components/ui/label.tsx
================================================================================

"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }

================================================================================
FILE: src/components/ui/navigation-menu.tsx
================================================================================

"use client"

import * as React from "react"
import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu"
import { cva } from "class-variance-authority"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const NavigationMenu = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Root
    ref={ref}
    className={cn(
      "relative z-10 flex max-w-max flex-1 items-center justify-center",
      className
    )}
    {...props}
  >
    {children}
    <NavigationMenuViewport />
  </NavigationMenuPrimitive.Root>
))
NavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName

const NavigationMenuList = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.List
    ref={ref}
    className={cn(
      "group flex flex-1 list-none items-center justify-center space-x-1",
      className
    )}
    {...props}
  />
))
NavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName

const NavigationMenuItem = NavigationMenuPrimitive.Item

const navigationMenuTriggerStyle = cva(
  "group inline-flex h-10 w-max items-center justify-center rounded-md bg-transparent px-4 py-2 text-sm font-medium transition-colors hover:bg-secondary hover:text-secondary-foreground focus:bg-secondary focus:text-secondary-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-secondary/50 data-[state=open]:bg-secondary/50"
)

const NavigationMenuTrigger = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Trigger
    ref={ref}
    className={cn(navigationMenuTriggerStyle(), "group", className)}
    {...props}
  >
    {children}{" "}
    <ChevronDown
      className="relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180"
      aria-hidden="true"
    />
  </NavigationMenuPrimitive.Trigger>
))
NavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName

const NavigationMenuContent = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Content
    ref={ref}
    className={cn(
      "left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto ",
      className
    )}
    {...props}
  />
))
NavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName

const NavigationMenuLink = NavigationMenuPrimitive.Link

const NavigationMenuViewport = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>
>(({ className, ...props }, ref) => (
  <div className={cn("absolute left-0 top-full flex justify-center w-full")}>
    <NavigationMenuPrimitive.Viewport
      className={cn(
        "origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-b-lg border-t bg-background/95 backdrop-blur-sm shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90",
        className
      )}
      ref={ref}
      {...props}
    />
  </div>
))
NavigationMenuViewport.displayName =
  NavigationMenuPrimitive.Viewport.displayName

const NavigationMenuIndicator = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Indicator
    ref={ref}
    className={cn(
      "top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in",
      className
    )}
    {...props}
  >
    <div className="relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md" />
  </NavigationMenuPrimitive.Indicator>
))
NavigationMenuIndicator.displayName =
  NavigationMenuPrimitive.Indicator.displayName

export {
  navigationMenuTriggerStyle,
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
}

================================================================================
FILE: src/components/ui/popover.tsx
================================================================================
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }

================================================================================
FILE: src/components/ui/progress.tsx
================================================================================
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-4 w-full overflow-hidden rounded-full bg-secondary",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }

================================================================================
FILE: src/components/ui/radio-group.tsx
================================================================================
"use client"

import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Root
      className={cn("grid gap-2", className)}
      {...props}
      ref={ref}
    />
  )
})
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-2.5 w-2.5 fill-current text-current" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
})
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName

export { RadioGroup, RadioGroupItem }

================================================================================
FILE: src/components/ui/scroll-area.tsx
================================================================================
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }

================================================================================
FILE: src/components/ui/select.tsx
================================================================================
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}

================================================================================
FILE: src/components/ui/separator.tsx
================================================================================
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }

================================================================================
FILE: src/components/ui/sheet.tsx
================================================================================
"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}

================================================================================
FILE: src/components/ui/sidebar.tsx
================================================================================

"use client"

import * as React from "react"
import { cva } from "class-variance-authority"
import { cn } from "@/lib/utils"
import { useSidebar } from "@/components/layout/sidebar-provider"
import { Button } from "./button"
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "./tooltip"
import { PanelLeftClose, PanelRightClose } from "lucide-react"

const Sidebar = React.forwardRef<
  HTMLElement,
  React.ComponentProps<"aside">
>(({ className, onMouseEnter, onMouseLeave, ...props }, ref) => {
  const { isSidebarOpen, isHovered, setIsHovered } = useSidebar()
  const effectiveOpen = isSidebarOpen || isHovered

  return (
    <aside
      ref={ref}
      onMouseEnter={(e) => {
        setIsHovered(true)
        onMouseEnter?.(e)
      }}
      onMouseLeave={(e) => {
        setIsHovered(false)
        onMouseLeave?.(e)
      }}
      className={cn(
        "flex flex-col border-r transition-all duration-300 ease-in-out bg-background z-40",
        effectiveOpen ? "w-64" : "w-20",
        className
      )}
      {...props}
    />
  )
})
Sidebar.displayName = "Sidebar"

const SidebarHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { isSidebarOpen, isHovered } = useSidebar()
  const effectiveOpen = isSidebarOpen || isHovered

  return (
    <div
      ref={ref}
      className={cn(
        "flex h-16 items-center border-b px-4 shrink-0 transition-all",
        !effectiveOpen && "justify-center px-0",
        className
      )}
      {...props}
    />
  )
})
SidebarHeader.displayName = "SidebarHeader"

const SidebarContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("flex-1 overflow-x-hidden overflow-y-auto", className)} {...props} />
))
SidebarContent.displayName = "SidebarContent"

const SidebarFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("mt-auto p-4 border-t", className)}
    {...props}
  />
))
SidebarFooter.displayName = "SidebarFooter"

const SidebarMenu = React.forwardRef<
  HTMLElement,
  React.HTMLAttributes<HTMLElement>
>(({ className, ...props }, ref) => (
  <nav ref={ref} className={cn("flex flex-col gap-1", className)} {...props} />
))
SidebarMenu.displayName = "SidebarMenu"

const SidebarMenuItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("", className)} {...props} />
))
SidebarMenuItem.displayName = "SidebarMenuItem"

const SidebarMenuButton = React.forwardRef<
  React.ElementRef<typeof Button>,
  React.ComponentProps<typeof Button> & {
    isActive?: boolean
    tooltip?: string
  }
>(({ className, isActive, tooltip, children, ...props }, ref) => {
  const { isSidebarOpen, isHovered } = useSidebar()
  const effectiveOpen = isSidebarOpen || isHovered

  const buttonContent = (
    <Button
      ref={ref}
      variant={isActive ? "secondary" : "ghost"}
      className={cn(
        "w-full justify-start gap-3 transition-all",
        !effectiveOpen && "justify-center px-2",
        className
      )}
      {...props}
    >
      {React.Children.map(children, (child, index) => {
        // Icon - always show (first child)
        if (index === 0 && React.isValidElement(child)) {
          return React.cloneElement(child, {
            className: cn("h-5 w-5 shrink-0", (child.props as any).className),
          } as any)
        }
        // Text - show only when expanded (second child)
        if (index === 1) {
          // Handle both direct strings and span elements with text
          if (typeof child === "string" || (React.isValidElement(child) && child.type === "span")) {
            const text = typeof child === "string" ? child : child.props.children
            return (
              <span
                className={cn(
                  "whitespace-nowrap transition-all duration-300 overflow-hidden",
                  effectiveOpen
                    ? "opacity-100 translate-x-0 max-w-full"
                    : "opacity-0 max-w-0 -translate-x-2 pointer-events-none absolute"
                )}
              >
                {text}
              </span>
            )
          }
        }
        // Any other children (like motion.div for active indicator)
        if (index > 1) {
          return child
        }
        return null
      })}
    </Button>
  )

  if (!effectiveOpen && tooltip) {
    return (
      <TooltipProvider delayDuration={100}>
        <Tooltip>
          <TooltipTrigger asChild>{buttonContent}</TooltipTrigger>
          <TooltipContent side="right" className="ml-2">
            {tooltip}
          </TooltipContent>
        </Tooltip>
      </TooltipProvider>
    )
  }

  return buttonContent
})
SidebarMenuButton.displayName = "SidebarMenuButton"


const SidebarTrigger = React.forwardRef<
  React.ElementRef<typeof Button>,
  React.ComponentProps<typeof Button>
>(({ className, ...props }, ref) => {
  const { isSidebarOpen, setIsSidebarOpen } = useSidebar();
  return (
    <Button
      ref={ref}
      variant="ghost"
      size="icon"
      onClick={() => setIsSidebarOpen(!isSidebarOpen)}
      className={cn("hidden lg:flex", className)}
      {...props}
    >
      {isSidebarOpen ? <PanelLeftClose /> : <PanelRightClose />}
      <span className="sr-only">Toggle sidebar</span>
    </Button>
  )
})
SidebarTrigger.displayName = "SidebarTrigger"


export {
  Sidebar,
  SidebarHeader,
  SidebarContent,
  SidebarFooter,
  SidebarMenu,
  SidebarMenuItem,
  SidebarMenuButton,
  SidebarTrigger,
}

================================================================================
FILE: src/components/ui/skeleton.tsx
================================================================================
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-primary/10", className)}
      {...props}
    />
  )
}

export { Skeleton }

================================================================================
FILE: src/components/ui/slider.tsx
================================================================================
"use client"

import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"

import { cn } from "@/lib/utils"

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex w-full touch-none select-none items-center",
      className
    )}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-2 w-full grow overflow-hidden rounded-full bg-secondary">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
))
Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }

================================================================================
FILE: src/components/ui/switch.tsx
================================================================================
"use client"

import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }

================================================================================
FILE: src/components/ui/table.tsx
================================================================================
import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

================================================================================
FILE: src/components/ui/tabs.tsx
================================================================================
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }

================================================================================
FILE: src/components/ui/textarea.tsx
================================================================================
import * as React from 'react';

import {cn} from '@/lib/utils';

const Textarea = React.forwardRef<HTMLTextAreaElement, React.ComponentProps<'textarea'>>(
  ({className, ...props}, ref) => {
    return (
      <textarea
        className={cn(
          'flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm',
          className
        )}
        ref={ref}
        {...props}
      />
    );
  }
);
Textarea.displayName = 'Textarea';

export {Textarea};

================================================================================
FILE: src/components/ui/toast.tsx
================================================================================
"use client"

import * as React from "react"
import * as ToastPrimitives from "@radix-ui/react-toast"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const ToastProvider = ToastPrimitives.Provider

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
      className
    )}
    {...props}
  />
))
ToastViewport.displayName = ToastPrimitives.Viewport.displayName

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
  {
    variants: {
      variant: {
        default: "border bg-background text-foreground",
        destructive:
          "destructive group border-destructive bg-destructive text-destructive-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
    VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  )
})
Toast.displayName = ToastPrimitives.Root.displayName

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
      className
    )}
    {...props}
  />
))
ToastAction.displayName = ToastPrimitives.Action.displayName

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
))
ToastClose.displayName = ToastPrimitives.Close.displayName

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn("text-sm font-semibold", className)}
    {...props}
  />
))
ToastTitle.displayName = ToastPrimitives.Title.displayName

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn("text-sm opacity-90", className)}
    {...props}
  />
))
ToastDescription.displayName = ToastPrimitives.Description.displayName

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>

type ToastActionElement = React.ReactElement<typeof ToastAction>

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
}

================================================================================
FILE: src/components/ui/toaster.tsx
================================================================================
"use client"

import { useToast } from "@/hooks/use-toast"
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from "@/components/ui/toast"

export function Toaster() {
  const { toasts } = useToast()

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action}
            <ToastClose />
          </Toast>
        )
      })}
      <ToastViewport />
    </ToastProvider>
  )
}

================================================================================
FILE: src/components/ui/tooltip.tsx
================================================================================

"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Portal>
    <TooltipPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </TooltipPrimitive.Portal>
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }

================================================================================
FILE: src/context/CartContext.tsx
================================================================================
"use client";
import React, { createContext, useContext, useState, useEffect, useCallback, ReactNode, useRef } from 'react';
import type { Product } from '@/lib/types';
import { useToast } from '@/hooks/use-toast';

export interface CartItem extends Product {
  quantity: number;
}

interface CartContextType {
  items: CartItem[];
  addItem: (product: Product, quantity?: number) => void;
  removeItem: (productId: string) => void;
  updateQuantity: (productId: string, quantity: number) => void;
  clearCart: () => void;
  cartTotal: number;
  itemCount: number;
  isCartOpen: boolean;
  setIsCartOpen: (isOpen: boolean) => void;
}

const CartContext = createContext<CartContextType | undefined>(undefined);

const getInitialCart = (): CartItem[] => {
  if (typeof window === 'undefined') {
    return [];
  }
  try {
    const savedCart = localStorage.getItem('picksy-cart');
    return savedCart ? JSON.parse(savedCart) : [];
  } catch (error) {
    console.error("Failed to load cart from localStorage on init", error);
    return [];
  }
};

export function CartProvider({ children }: { children: ReactNode }) {
  const [items, setItems] = useState<CartItem[]>([]);
  const [isCartOpen, setIsCartOpen] = useState(false);
  const { toast } = useToast();
  const hasLoaded = useRef(false);

  useEffect(() => {
    try {
      const savedCart = localStorage.getItem('picksy-cart');
      if (savedCart) {
          setItems(JSON.parse(savedCart));
      }
    } catch (error) {
      console.error("Failed to load cart from localStorage", error);
    } finally {
      hasLoaded.current = true;
    }
  }, []);

  useEffect(() => {
    if (hasLoaded.current) {
        try {
          localStorage.setItem('picksy-cart', JSON.stringify(items));
        } catch (error) {
          console.error("Failed to save cart to localStorage", error);
        }
    }
  }, [items]);

  const addItem = useCallback((product: Product, quantity: number = 1) => {
    setItems((prevItems) => {
      const existingItem = prevItems.find((item) => item.id === product.id);
      if (existingItem) {
        return prevItems.map((item) =>
          item.id === product.id
            ? { ...item, quantity: item.quantity + quantity }
            : item
        );
      }
      return [...prevItems, { ...product, quantity }];
    });
     toast({
        title: "Added to Cart",
        description: `${product.title} has been added to your cart.`,
      });
  }, [toast]);

  const removeItem = useCallback((productId: string) => {
    setItems((prevItems) => prevItems.filter((item) => item.id !== productId));
     toast({
        title: "Item Removed",
        variant: "destructive",
      });
  }, [toast]);

  const updateQuantity = useCallback((productId: string, quantity: number) => {
    if (quantity <= 0) {
      removeItem(productId);
      return;
    }
    setItems((prevItems) =>
      prevItems.map((item) =>
        item.id === productId ? { ...item, quantity } : item
      )
    );
  }, [removeItem]);

  const clearCart = useCallback(() => {
    setItems([]);
  }, []);

  const cartTotal = items.reduce((total, item) => total + item.price * item.quantity, 0);
  const itemCount = items.reduce((total, item) => total + item.quantity, 0);

  return (
    <CartContext.Provider
      value={{
        items,
        addItem,
        removeItem,
        updateQuantity,
        clearCart,
        cartTotal,
        itemCount,
        isCartOpen,
        setIsCartOpen,
      }}
    >
      {children}
    </CartContext.Provider>
  );
}

export function useCart() {
  const context = useContext(CartContext);
  if (context === undefined) {
    throw new Error('useCart must be used within a CartProvider');
  }
  return context;
}

================================================================================
FILE: src/context/ViewedProductsContext.tsx
================================================================================
"use client";

import React, { createContext, useContext, useState, useEffect } from "react";

type ViewedProductsContextType = {
    viewedProductIds: string[];
    markAsViewed: (productId: string) => void;
};

const ViewedProductsContext = createContext<ViewedProductsContextType | undefined>(
    undefined
);

export function ViewedProductsProvider({
    children,
}: {
    children: React.ReactNode;
}) {
    const [viewedProductIds, setViewedProductIds] = useState<string[]>([]);

    useEffect(() => {
        const stored = localStorage.getItem("viewedProductIds");
        if (stored) {
            try {
                setTimeout(() => {
                    setViewedProductIds(JSON.parse(stored));
                }, 0);
            } catch (e) {
                console.error("Failed to parse viewedProductIds from localStorage", e);
            }
        }
    }, []);

    const markAsViewed = (productId: string) => {
        setViewedProductIds((prev) => {
            if (prev.includes(productId)) return prev;
            const newIds = [productId, ...prev];
            // Limit to last 50 viewed items to prevent localStorage bloat
            const limitedIds = newIds.slice(0, 50);
            localStorage.setItem("viewedProductIds", JSON.stringify(limitedIds));
            return limitedIds;
        });
    };

    return (
        <ViewedProductsContext.Provider value={{ viewedProductIds, markAsViewed }}>
            {children}
        </ViewedProductsContext.Provider>
    );
}

export function useViewedProducts() {
    const context = useContext(ViewedProductsContext);
    if (context === undefined) {
        throw new Error(
            "useViewedProducts must be used within a ViewedProductsProvider"
        );
    }
    return context;
}

================================================================================
FILE: src/firebase/auth/use-user.tsx
================================================================================

'use client';

import { useFirebase } from '@/firebase/provider';
import type { User as FirebaseUser } from 'firebase/auth';

// Define the shape of the safe, plain user object
export type SafeUser = {
  uid: string;
  email: string | null;
  displayName: string | null;
  photoURL: string | null;
  // Add the getIdTokenResult method for custom claims
  getIdTokenResult: (forceRefresh?: boolean) => Promise<{ claims: { [key: string]: any; }; }>;
  getIdToken: (forceRefresh?: boolean) => Promise<string>;
} | null;


// Return type for useUser()
export interface UserHookResult {
  user: SafeUser;
  isUserLoading: boolean;
  userError: Error | null;
}


/**
 * Hook specifically for accessing the authenticated user's state.
 * This provides the User object, loading status, and any auth errors.
 * @returns {UserHookResult} Object with user, isUserLoading, userError.
 */
export const useUser = (): UserHookResult => {
  const { user, isUserLoading, userError } = useFirebase();
  return { user, isUserLoading, userError };
};

================================================================================
FILE: src/firebase/error-emitter.ts
================================================================================

'use client';
import { FirestorePermissionError } from '@/firebase/errors';

/**
 * Defines the shape of all possible events and their corresponding payload types.
 * This centralizes event definitions for type safety across the application.
 */
export interface AppEvents {
  'permission-error': FirestorePermissionError;
}

// A generic type for a callback function.
type Callback<T> = (data: T) => void;

/**
 * A strongly-typed pub/sub event emitter.
 * It uses a generic type T that extends a record of event names to payload types.
 */
function createEventEmitter<T extends Record<string, any>>() {
  // The events object stores arrays of callbacks, keyed by event name.
  // The types ensure that a callback for a specific event matches its payload type.
  const events: { [K in keyof T]?: Array<Callback<T[K]>> } = {};

  return {
    /**
     * Subscribe to an event.
     * @param eventName The name of the event to subscribe to.
     * @param callback The function to call when the event is emitted.
     */
    on<K extends keyof T>(eventName: K, callback: Callback<T[K]>) {
      if (!events[eventName]) {
        events[eventName] = [];
      }
      events[eventName]?.push(callback);
    },

    /**
     * Unsubscribe from an event.
     * @param eventName The name of the event to unsubscribe from.
     * @param callback The specific callback to remove.
     */
    off<K extends keyof T>(eventName: K, callback: Callback<T[K]>) {
      if (!events[eventName]) {
        return;
      }
      events[eventName] = events[eventName]?.filter(cb => cb !== callback);
    },

    /**
     * Publish an event to all subscribers.
     * @param eventName The name of the event to emit.
     * @param data The data payload that corresponds to the event's type.
     */
    emit<K extends keyof T>(eventName: K, data: T[K]) {
      if (!events[eventName]) {
        return;
      }
      events[eventName]?.forEach(callback => callback(data));
    },
  };
}

// Create and export a singleton instance of the emitter, typed with our AppEvents interface.
export const errorEmitter = createEventEmitter<AppEvents>();

================================================================================
FILE: src/firebase/errors.ts
================================================================================

'use client';
import { getAuth, type User } from 'firebase/auth';

type SecurityRuleContext = {
  path: string;
  operation: 'get' | 'list' | 'create' | 'update' | 'delete' | 'write';
  requestResourceData?: any;
};

interface FirebaseAuthToken {
  name: string | null;
  email: string | null;
  email_verified: boolean;
  phone_number: string | null;
  sub: string;
  firebase: {
    identities: Record<string, string[]>;
    sign_in_provider: string;
    tenant: string | null;
  };
}

interface FirebaseAuthObject {
  uid: string;
  token: FirebaseAuthToken;
}

interface SecurityRuleRequest {
  auth: FirebaseAuthObject | null;
  method: string;
  path: string;
  resource?: {
    data: any;
  };
}

/**
 * Builds a security-rule-compliant auth object from the Firebase User.
 * @param currentUser The currently authenticated Firebase user.
 * @returns An object that mirrors request.auth in security rules, or null.
 */
function buildAuthObject(currentUser: User | null): FirebaseAuthObject | null {
  if (!currentUser) {
    return null;
  }

  const token: FirebaseAuthToken = {
    name: currentUser.displayName,
    email: currentUser.email,
    email_verified: currentUser.emailVerified,
    phone_number: currentUser.phoneNumber,
    sub: currentUser.uid,
    firebase: {
      identities: currentUser.providerData.reduce((acc, p) => {
        if (p.providerId) {
          acc[p.providerId] = [p.uid];
        }
        return acc;
      }, {} as Record<string, string[]>),
      sign_in_provider: currentUser.providerData[0]?.providerId || 'custom',
      tenant: currentUser.tenantId,
    },
  };

  return {
    uid: currentUser.uid,
    token: token,
  };
}

/**
 * Builds the complete, simulated request object for the error message.
 * It safely tries to get the current authenticated user.
 * @param context The context of the failed Firestore operation.
 * @returns A structured request object.
 */
function buildRequestObject(context: SecurityRuleContext): SecurityRuleRequest {
  let authObject: FirebaseAuthObject | null = null;
  try {
    // Safely attempt to get the current user.
    const firebaseAuth = getAuth();
    const currentUser = firebaseAuth.currentUser;
    if (currentUser) {
      authObject = buildAuthObject(currentUser);
    }
  } catch {
    // This will catch errors if the Firebase app is not yet initialized.
    // In this case, we'll proceed without auth information.
  }

  return {
    auth: authObject,
    method: context.operation,
    path: `/databases/(default)/documents/${context.path}`,
    resource: context.requestResourceData ? { data: context.requestResourceData } : undefined,
  };
}

/**
 * Builds the final, formatted error message for the LLM.
 * @param requestObject The simulated request object.
 * @returns A string containing the error message and the JSON payload.
 */
function buildErrorMessage(requestObject: SecurityRuleRequest): string {
  return `Missing or insufficient permissions: The following request was denied by Firestore Security Rules:
${JSON.stringify(requestObject, null, 2)}`;
}

/**
 * A custom error class designed to be consumed by an LLM for debugging.
 * It structures the error information to mimic the request object
 * available in Firestore Security Rules.
 */
export class FirestorePermissionError extends Error {
  public readonly request: SecurityRuleRequest;

  constructor(context: SecurityRuleContext) {
    const requestObject = buildRequestObject(context);
    super(buildErrorMessage(requestObject));
    this.name = 'FirebaseError';
    this.request = requestObject;
  }
}

================================================================================
FILE: src/firebase/firestore/use-collection.tsx
================================================================================

'use client';

import { useState, useEffect } from 'react';
import {
  Query,
  onSnapshot,
  DocumentData,
  FirestoreError,
  QuerySnapshot,
  CollectionReference,
} from 'firebase/firestore';
import { errorEmitter } from '@/firebase/error-emitter';
import { FirestorePermissionError } from '@/firebase/errors';
import { useFirebase } from '../provider'; 

/** Utility type to add an 'id' field to a given type T. */
export type WithId<T> = T & { id: string };

/**
 * Interface for the return value of the useCollection hook.
 * @template T Type of the document data.
 */
export interface UseCollectionResult<T> {
  data: WithId<T>[] | null; // Document data with ID, or null.
  isLoading: boolean;       // True if loading.
  error: FirestoreError | Error | null; // Error object, or null.
}

/* Internal implementation of Query:
  https://github.com/firebase/firebase-js-sdk/blob/c5f08a9bc5da0d2b0207802c972d53724ccef055/packages/firestore/src/lite-api/reference.ts#L143
*/
export interface InternalQuery extends Query<DocumentData> {
  _query: {
    path: {
      canonicalString(): string;
      toString(): string;
    }
  }
}

/**
 * React hook to subscribe to a Firestore collection or query in real-time.
 * Handles nullable references/queries.
 * 
 *
 * IMPORTANT! YOU MUST MEMOIZE the inputted memoizedTargetRefOrQuery or BAD THINGS WILL HAPPEN
 * use useMemoFirebase to memoize it.
 *  
 * @template T Optional type for document data. Defaults to any.
 * @param {CollectionReference<DocumentData> | Query<DocumentData> | null | undefined} memoizedTargetRefOrQuery -
 * The Firestore CollectionReference or Query, wrapped in useMemoFirebase. Waits if null/undefined.
 * @returns {UseCollectionResult<T>} Object with data, isLoading, error.
 */
export function useCollection<T = any>(
    memoizedTargetRefOrQuery: ((CollectionReference<DocumentData> | Query<DocumentData>) & {__memo?: boolean})  | null | undefined,
): UseCollectionResult<T> {
  type ResultItemType = WithId<T>;
  type StateDataType = ResultItemType[] | null;

  const [data, setData] = useState<StateDataType>(null);
  const [isLoading, setIsLoading] = useState<boolean>(true); // Start as true
  const [error, setError] = useState<FirestoreError | Error | null>(null);
  const { isUserLoading } = useFirebase();

  useEffect(() => {
    // Wait until user auth state is resolved before attempting to fetch data
    if (isUserLoading) {
      setTimeout(() => {
        setIsLoading(true);
      }, 0);
      return;
    }

    if (!memoizedTargetRefOrQuery) {
      setTimeout(() => {
        setData(null);
        setIsLoading(false);
        setError(null);
      }, 0);
      return;
    }

    const path: string =
        memoizedTargetRefOrQuery.type === 'collection'
            ? (memoizedTargetRefOrQuery as CollectionReference).path
            : (memoizedTargetRefOrQuery as unknown as InternalQuery)._query.path.canonicalString();

    setTimeout(() => {
      setIsLoading(true);
      setError(null);
    }, 0);

    const unsubscribe = onSnapshot(
      memoizedTargetRefOrQuery,
      (snapshot: QuerySnapshot<DocumentData>) => {
        const results: ResultItemType[] = [];
        for (const doc of snapshot.docs) {
          results.push({ ...(doc.data() as T), id: doc.id });
        }
        setData(results);
        setError(null);
        setIsLoading(false);
      },
      (error: FirestoreError) => {
        if (error.code === 'permission-denied') {
            const contextualError = new FirestorePermissionError({
                operation: 'list',
                path,
            });
            setError(contextualError);
            errorEmitter.emit('permission-error', contextualError);
        } else {
            console.error("Firestore Error:", error);
            setError(error);
        }
        
        setData(null);
        setIsLoading(false);
      }
    );

    return () => unsubscribe();
  }, [memoizedTargetRefOrQuery, isUserLoading]);
  
  if(memoizedTargetRefOrQuery && !(memoizedTargetRefOrQuery as any).__memo) {
    if (process.env.NODE_ENV === 'development') {
      console.warn('A query passed to useCollection was not properly memoized using useMemoFirebase. This will cause infinite render loops.');
    }
  }

  return { data, isLoading, error };
}

================================================================================
FILE: src/firebase/firestore/use-doc.tsx
================================================================================

'use client';
    
import { useState, useEffect } from 'react';
import {
  DocumentReference,
  onSnapshot,
  DocumentData,
  FirestoreError,
  DocumentSnapshot,
} from 'firebase/firestore';
import { errorEmitter } from '@/firebase/error-emitter';
import { FirestorePermissionError } from '@/firebase/errors';
import { useFirebase } from '../provider';

/** Utility type to add an 'id' field to a given type T. */
type WithId<T> = T & { id: string };

/**
 * Interface for the return value of the useDoc hook.
 * @template T Type of the document data.
 */
export interface UseDocResult<T> {
  data: WithId<T> | null; // Document data with ID, or null.
  isLoading: boolean;       // True if loading.
  error: FirestoreError | Error | null; // Error object, or null.
}

interface UseDocOptions<T> {
  initialData?: T;
}

/**
 * React hook to subscribe to a single Firestore document in real-time.
 * Handles nullable references.
 * 
 * IMPORTANT! YOU MUST MEMOIZE the inputted memoizedTargetRefOrQuery or BAD THINGS WILL HAPPEN
 * use useMemoFirebase to memoize it.
 *
 *
 * @template T Optional type for document data. Defaults to any.
 * @param {DocumentReference<DocumentData> | null | undefined} memoizedDocRef -
 * The Firestore DocumentReference, wrapped in useMemoFirebase. Waits if null/undefined.
 * @returns {UseDocResult<T>} Object with data, isLoading, error.
 */
export function useDoc<T = any>(
  memoizedDocRef: (DocumentReference<DocumentData>  & {__memo?: boolean}) | null | undefined,
  options: UseDocOptions<WithId<T>> = {}
): UseDocResult<T> {
  const { isUserLoading } = useFirebase();
  const [data, setData] = useState<WithId<T> | null>(options.initialData || null);
  const [isLoading, setIsLoading] = useState<boolean>(!options.initialData);
  const [error, setError] = useState<FirestoreError | Error | null>(null);

  useEffect(() => {
    if (isUserLoading) {
        setTimeout(() => {
            setIsLoading(true);
        }, 0);
        return;
    }

    if (!memoizedDocRef) {
      setTimeout(() => {
        setData(null);
        setIsLoading(false);
        setError(null);
      }, 0);
      return;
    }
    
    if (options.initialData) {
        setTimeout(() => {
            setIsLoading(false);
        }, 0);
    } else {
        setTimeout(() => {
            setIsLoading(true);
        }, 0);
    }
    
    setTimeout(() => {
        setError(null);
    }, 0);

    const unsubscribe = onSnapshot(
      memoizedDocRef,
      (snapshot: DocumentSnapshot<DocumentData>) => {
        if (snapshot.exists()) {
          setData({ ...(snapshot.data() as T), id: snapshot.id });
        } else {
          // Document does not exist
          setData(null);
        }
        setError(null); // Clear any previous error on successful snapshot (even if doc doesn't exist)
        setIsLoading(false);
      },
      (error: FirestoreError) => {
        if (error.code === 'permission-denied') {
            const contextualError = new FirestorePermissionError({
                operation: 'get',
                path: memoizedDocRef.path,
            });
            setError(contextualError);
            errorEmitter.emit('permission-error', contextualError);
        } else {
             console.error("Firestore Error:", error);
             setError(error);
        }
        setData(null);
        setIsLoading(false);
      }
    );

    return () => unsubscribe();
  }, [memoizedDocRef, options.initialData, isUserLoading]);
  
  if(memoizedDocRef && !(memoizedDocRef as any).__memo) {
    if (process.env.NODE_ENV === 'development') {
      console.warn('A query passed to useDoc was not properly memoized using useMemoFirebase. This will cause infinite render loops.');
    }
  }

  return { data, isLoading, error };
}

================================================================================
FILE: src/firebase/index.ts
================================================================================
'use client';

// This file is the main entry point for all client-side Firebase functionality.
// It re-exports the necessary providers, hooks, and utilities.

import { useMemo, type DependencyList } from 'react';

/**
 * A custom hook that wraps React's `useMemo` to stabilize Firestore query/document references.
 * It adds a `__memo` property to the returned value, which is checked by `useCollection` and `useDoc`
 * to ensure that query objects are not recreated on every render, preventing infinite loops.
 *
 * @param factory A function that creates the Firestore query or document reference.
 * @param deps An array of dependencies for the `useMemo` hook.
 * @returns The memoized value from the factory function, with an added `__memo` property.
 */
export function useMemoFirebase<T>(factory: () => T, deps: DependencyList): T {
    // Use JSON.stringify on deps for a more robust comparison of object/array dependencies.
    // eslint-disable-next-line react-hooks/exhaustive-deps
    const memoizedValue = useMemo(factory, deps);

    // Attach a non-enumerable property to mark this object as memoized for our hooks.
    if (memoizedValue && typeof memoizedValue === 'object') {
        Object.defineProperty(memoizedValue, '__memo', {
            value: true,
            writable: false,
            enumerable: false,
            configurable: false,
        });
    }

    return memoizedValue;
}


export * from './provider';
// FirebaseClientProvider is removed, so we don't export it.
export * from './firestore/use-collection';
export * from './firestore/use-doc';
export * from './auth/use-user';
export * from './errors';
export * from './error-emitter';

================================================================================
FILE: src/firebase/non-blocking-login.tsx
================================================================================
'use client';
import {
  Auth, // Import Auth type for type hinting
  signInAnonymously,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  // Assume getAuth and app are initialized elsewhere
} from 'firebase/auth';

/** Initiate anonymous sign-in (non-blocking). */
export function initiateAnonymousSignIn(authInstance: Auth): void {
  // CRITICAL: Call signInAnonymously directly. Do NOT use 'await signInAnonymously(...)'.
  signInAnonymously(authInstance);
  // Code continues immediately. Auth state change is handled by onAuthStateChanged listener.
}

/** Initiate email/password sign-up (non-blocking). */
export function initiateEmailSignUp(authInstance: Auth, email: string, password: string): void {
  // CRITICAL: Call createUserWithEmailAndPassword directly. Do NOT use 'await createUserWithEmailAndPassword(...)'.
  createUserWithEmailAndPassword(authInstance, email, password);
  // Code continues immediately. Auth state change is handled by onAuthStateChanged listener.
}

/** Initiate email/password sign-in (non-blocking). */
export function initiateEmailSignIn(authInstance: Auth, email: string, password: string): void {
  // CRITICAL: Call signInWithEmailAndPassword directly. Do NOT use 'await signInWithEmailAndPassword(...)'.
  signInWithEmailAndPassword(authInstance, email, password);
  // Code continues immediately. Auth state change is handled by onAuthStateChanged listener.
}

================================================================================
FILE: src/firebase/provider.tsx
================================================================================

'use client';

import React, { createContext, useContext, ReactNode, useMemo, useState, useEffect } from 'react';
import { FirebaseApp } from 'firebase/app';
import { Firestore, doc, getDoc, setDoc } from 'firebase/firestore';
import { Auth, User, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from 'firebase/auth';
import { FirebaseErrorListener } from '@/components/FirebaseErrorListener'
import type { SafeUser } from './auth/use-user';
import { app, auth as authInstance, db } from '@/lib/firebase/config';
import { SUPER_ADMIN_EMAILS } from '@/lib/constants';

/**
 * Creates a plain, serializable object from a Firebase User object.
 * This prevents passing complex, circular objects into React state.
 * @param user The raw Firebase User object.
 * @returns A "safe" user object with only primitive values, or null.
 */
function getSafeUser(user: User | null): SafeUser {
  if (!user) {
    return null;
  }
  return {
    uid: user.uid,
    email: user.email,
    displayName: user.displayName,
    photoURL: user.photoURL,
    // Pass the function reference, it will be called in components
    getIdTokenResult: (forceRefresh?: boolean) => user.getIdTokenResult(forceRefresh),
    getIdToken: (forceRefresh?: boolean) => user.getIdToken(forceRefresh),
  };
}

// Internal state for user authentication, using the SafeUser type
interface UserAuthState {
  user: SafeUser;
  isUserLoading: boolean;
  userError: Error | null;
}

// Combined state for the Firebase context
export interface FirebaseContextState {
  areServicesAvailable: boolean;
  firebaseApp: FirebaseApp | null;
  firestore: Firestore | null;
  auth: Auth | null;
  // User authentication state now uses SafeUser
  user: SafeUser;
  isUserLoading: boolean;
  userError: Error | null;
}

// Return type for useFirebase()
export interface FirebaseServicesAndUser {
  firebaseApp: FirebaseApp | null; // Can be null on server
  firestore: Firestore | null; // Can be null on server
  auth: Auth | null; // Can be null on server
  user: SafeUser;
  isUserLoading: boolean;
  userError: Error | null;
}

// React Context
export const FirebaseContext = createContext<FirebaseContextState | undefined>(undefined);

/**
 * FirebaseProvider manages and provides Firebase services and user authentication state.
 */
export const FirebaseProvider: React.FC<{
  children: ReactNode;
}> = ({
  children,
}) => {
    const [userAuthState, setUserAuthState] = useState<UserAuthState>({
      user: null,
      isUserLoading: true,
      userError: null,
    });

    const authService = typeof window !== 'undefined' ? authInstance : null;

    // Effect to subscribe to Firebase auth state changes
    useEffect(() => {
      if (!authService) {
        setTimeout(() => {
          setUserAuthState({ user: null, isUserLoading: false, userError: null });
        }, 0);
        return;
      }

      const oneTimeSetup = async (user: User) => {
        try {
          console.log("[Setup] Starting one-time setup for user:", user.uid);

          // Identify super admin by UID or email list
          const isSuperAdminUser = user.uid === 'O5nCLgbIaRRRF369K0kjgT59io73' || (user.email && SUPER_ADMIN_EMAILS.includes(user.email));

          if (isSuperAdminUser) {
            console.log("[Setup] User identified as Super Admin.");
            const userRef = doc(db, 'users', user.uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists() && (!userSnap.data().isAdmin || userSnap.data().role !== 'superadmin')) {
              console.log("[Setup] Updating existing user profile with admin role...");
              await setDoc(userRef, { isAdmin: true, role: 'superadmin', canSell: true }, { merge: true });
              console.log("[Setup] Admin role set.");
            } else if (!userSnap.exists()) {
              console.log("[Setup] Creating new super admin profile...");
              await setDoc(userRef, {
                email: user.email,
                displayName: user.displayName || 'Super Admin',
                isAdmin: true,
                role: 'superadmin',
                canSell: true,
                createdAt: new Date(),
              }, { merge: true });
              console.log("[Setup] Super admin profile created.");
            }

            console.log("[Setup] Checking platform stats...");
            const statsRef = doc(db, 'platform_stats', 'global');
            try {
              const statsSnap = await getDoc(statsRef);
              if (!statsSnap.exists()) {
                console.log("[Setup] Initializing platform stats...");
                await setDoc(statsRef, {
                  totalRevenue: 0,
                  activeSellers: 0,
                  disputeCount: 0,
                  totalItems: 0,
                });
                console.log("[Setup] Platform stats initialized.");
              }
            } catch (statsErr) {
              console.warn("[Setup] Optional: Platform stats check failed (likely permissions):", statsErr);
            }
          }
          console.log("[Setup] Setup process complete.");
        } catch (error) {
          console.error("[Setup] Critical setup error:", error);
        }
      };

      const unsubscribe = onAuthStateChanged(
        authService,
        (firebaseUser) => { // Raw Firebase user
          if (firebaseUser) {
            oneTimeSetup(firebaseUser).catch(console.error);
          }
          setUserAuthState({ user: getSafeUser(firebaseUser), isUserLoading: false, userError: null });
        },
        (error) => {
          console.error("FirebaseProvider: onAuthStateChanged error:", error);
          setUserAuthState({ user: null, isUserLoading: false, userError: error });
        }
      );

      return () => unsubscribe(); // Cleanup
    }, [authService]);

    // Memoize the context value
    const contextValue = useMemo((): FirebaseContextState => {
      const servicesAvailable = !!(app && db && authInstance);
      return {
        areServicesAvailable: servicesAvailable,
        firebaseApp: servicesAvailable ? app : null,
        firestore: servicesAvailable ? db : null,
        auth: servicesAvailable ? authInstance : null,
        user: userAuthState.user,
        isUserLoading: userAuthState.isUserLoading,
        userError: userAuthState.userError,
      };
    }, [userAuthState]);

    return (
      <FirebaseContext.Provider value={contextValue}>
        <FirebaseErrorListener />
        {children}
      </FirebaseContext.Provider>
    );
  };


/**
 * Hook to access core Firebase services and user authentication state.
 * Throws error if core services are not available or used outside provider.
 */
export const useFirebase = (): FirebaseServicesAndUser => {
  const context = useContext(FirebaseContext);

  if (context === undefined) {
    throw new Error('useFirebase must be used within a FirebaseProvider.');
  }

  return {
    firebaseApp: context.firebaseApp,
    firestore: context.firestore,
    auth: context.auth,
    user: context.user,
    isUserLoading: context.isUserLoading,
    userError: context.userError,
  };
};

/** Hook to access Firebase Auth instance. */
export const useAuth = (): Auth | null => {
  const { auth } = useFirebase();
  return auth;
};

/** Hook to access Firestore instance. */
export const useFirestore = (): Firestore | null => {
  const { firestore } = useFirebase();
  return firestore;
};

/** Hook to access Firebase App instance. */
export const useFirebaseApp = (): FirebaseApp | null => {
  const { firebaseApp } = useFirebase();
  return firebaseApp;
};

================================================================================
FILE: src/hooks/use-before-unload.ts
================================================================================

'use client';

import { useEffect } from 'react';

const useBeforeUnload = (when: boolean, message: string = 'Changes you made may not be saved.') => {
  useEffect(() => {
    const handleBeforeUnload = (event: BeforeUnloadEvent) => {
      if (when) {
        event.preventDefault();
        // Modern browsers show a generic message, but this is required for older ones.
        event.returnValue = message;
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);

    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
    };
  }, [when, message]);
};

export const BeforeUnload = ({ when }: { when: boolean }) => {
  useBeforeUnload(when);
  return null;
};

================================================================================
FILE: src/hooks/use-mobile.tsx
================================================================================
import * as React from "react"

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
    const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

    React.useEffect(() => {
        const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
        const onChange = () => {
            setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
        }
        mql.addEventListener("change", onChange)
        setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
        return () => mql.removeEventListener("change", onChange)
    }, [])

    return !!isMobile
}

================================================================================
FILE: src/hooks/use-toast.ts
================================================================================
"use client"

// Inspired by react-hot-toast library
import * as React from "react"

import type {
  ToastActionElement,
  ToastProps,
} from "@/components/ui/toast"

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType["ADD_TOAST"]
      toast: ToasterToast
    }
  | {
      type: ActionType["UPDATE_TOAST"]
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType["DISMISS_TOAST"]
      toastId?: ToasterToast["id"]
    }
  | {
      type: ActionType["REMOVE_TOAST"]
      toastId?: ToasterToast["id"]
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: "REMOVE_TOAST",
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case "ADD_TOAST":
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case "UPDATE_TOAST":
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      }

    case "DISMISS_TOAST": {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t
        ),
      }
    }
    case "REMOVE_TOAST":
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, "id">

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: "UPDATE_TOAST",
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id })

  dispatch({
    type: "ADD_TOAST",
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
  }
}

export { useToast, toast }

================================================================================
FILE: src/hooks/use-user-permissions.ts
================================================================================

'use client';

import { useUser, useDoc, useMemoFirebase } from '@/firebase';
import { doc } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import type { UserProfile } from '@/lib/types';
import { SUPER_ADMIN_UIDS } from '@/lib/constants';

interface UserPermissions {
    isSuperAdmin: boolean;
    isAdmin: boolean;
    canSell: boolean;
    isLoading: boolean;
    userProfile: UserProfile | null;
}

/**
 * A hook to get detailed permissions for the current user.
 * It checks the user's role and selling capabilities from their Firestore profile.
 * @returns {UserPermissions} An object with boolean flags for permissions and loading state.
 */
export function useUserPermissions(): UserPermissions {
    const { user, isUserLoading: isAuthLoading } = useUser();

    // Memoize the document reference to prevent re-renders
    const userProfileRef = useMemoFirebase(() => {
        if (!user?.uid) return null;
        return doc(db, 'users', user.uid);
    }, [user?.uid]);

    // useDoc will fetch the user's profile from Firestore
    const { data: userProfile, isLoading: isProfileLoading } = useDoc<UserProfile>(userProfileRef);

    const isLoading = isAuthLoading || isProfileLoading;

    if (isLoading || !user || !userProfile) {
        return {
            isSuperAdmin: user?.uid ? SUPER_ADMIN_UIDS.includes(user.uid) : false,
            isAdmin: user?.uid ? SUPER_ADMIN_UIDS.includes(user.uid) : false,
            canSell: false,
            isLoading,
            userProfile: userProfile || null,
        };
    }


    const role = userProfile.role;

    return {
        isSuperAdmin: role === 'superadmin' || SUPER_ADMIN_UIDS.includes(user.uid),
        isAdmin: role === 'admin' || role === 'superadmin' || userProfile.isAdmin === true || SUPER_ADMIN_UIDS.includes(user.uid),
        canSell: userProfile.canSell === true || role === 'superadmin' || SUPER_ADMIN_UIDS.includes(user.uid),
        isLoading: false,
        userProfile,
    };
}

================================================================================
FILE: src/lib/actions.ts
================================================================================
"use server";

import { z } from "zod";
import {
    moderateContent,
    type ModerateContentOutput,
} from "@/ai/flows/ai-content-moderation";
import { notifySellerOfRemoval } from "@/ai/flows/notify-seller-of-removal";
import { detectFraud } from "@/ai/flows/detect-fraud";

const ModerationSchema = z.object({
    productName: z.string().min(1, { message: "Product name is required." }),
    productDescription: z
        .string()
        .min(1, { message: "Product description is required." }),
    productImageUri: z
        .string()
        .optional(),
});

export type ModerationState = {
    result?: ModerateContentOutput;
    error?: string;
    fields?: {
        productName?: string;
        productDescription?: string;
        productImageUri?: string;
    };
    message?: string;
};

export async function moderateProductAction(
    prevState: ModerationState,
    formData: FormData
): Promise<ModerationState> {
    const validatedFields = ModerationSchema.safeParse({
        productName: formData.get("productName"),
        productDescription: formData.get("productDescription"),
        productImageUri: formData.get("productImageUri"),
    });

    if (!validatedFields.success) {
        return {
            error: "Invalid fields.",
            fields: {
                productName: validatedFields.error.flatten().fieldErrors.productName?.join(", "),
                productDescription: validatedFields.error.flatten().fieldErrors.productDescription?.join(", "),
                productImageUri: validatedFields.error.flatten().fieldErrors.productImageUri?.join(", "),
            },
        };
    }

    try {
        const result = await moderateContent(validatedFields.data);
        return {
            result,
            message: "Content moderated successfully.",
        };
    } catch (e) {
        console.error(e);
        return {
            error: "Failed to moderate content. Please try again.",
        };
    }
}

const FraudSchema = z.object({
    details: z.string().min(1, { message: "Analysis details are required." }),
});

export type FraudState = {
    result?: {
        isFraudulent: boolean;
        riskScore: number;
        reason: string;
        recommendedAction?: string;
    };
    error?: string;
    message?: string;
};

export async function detectFraudAction(
    prevState: FraudState,
    formData: FormData
): Promise<FraudState> {
    const validatedFields = FraudSchema.safeParse({
        details: formData.get("details"),
    });

    if (!validatedFields.success) {
        return {
            error: "Invalid input.",
        };
    }

    try {
        const result = await detectFraud(validatedFields.data);
        return {
            result,
            message: "Fraud analysis complete.",
        };
    } catch (e: any) {
        console.error(e);
        return {
            error: e.message || "Failed to analyze fraud patterns.",
        };
    }
}

================================================================================
FILE: src/lib/card-logic.ts
================================================================================
import type { Player } from './research-types';
import type { ExtractCardNameOutput } from '@/ai/flows/extract-card-name';

/**
 * Verifies if a scanned card matches the user's keep list criteria
 */
export function verifyCard(
    extractedDetails: ExtractCardNameOutput,
    playersToKeep: Player[]
): { isKeeper: boolean; isPrizmRookie: boolean } {
    const playerName = extractedDetails.playerName.toLowerCase();
    const matchedPlayer = playersToKeep.find(
        (p) => p.name.toLowerCase() === playerName
    );

    const isKeeper = !!matchedPlayer;

    // Check if it's a Prizm Rookie card (special designation)
    const isPrizmRookie =
        isKeeper &&
        extractedDetails.cardBrand?.toLowerCase().includes('prizm') === true &&
        extractedDetails.cardType?.toLowerCase().includes('rookie') === true;

    return { isKeeper, isPrizmRookie };
}

/**
 * Formats card details for display
 */
export function formatCardDetails(item: {
    name: string;
    brand?: string;
    cardType?: string;
    sport?: string;
    cardYear?: number | null;
}): string {
    const parts: string[] = [item.name];

    if (item.cardYear) parts.push(`${item.cardYear}`);
    if (item.brand) parts.push(item.brand);
    if (item.cardType) parts.push(item.cardType);
    if (item.sport) parts.push(item.sport);

    return parts.join(' â€¢ ');
}

================================================================================
FILE: src/lib/constants.ts
================================================================================
// Super Admin Configuration
export const SUPER_ADMIN_EMAILS = (process.env.SUPER_ADMIN_EMAILS || '').split(',').filter(Boolean);
export const SUPER_ADMIN_UIDS = (process.env.SUPER_ADMIN_UIDS || '').split(',').filter(Boolean);

================================================================================
FILE: src/lib/firebase/admin.ts
================================================================================

import * as admin from 'firebase-admin';
import path from 'path';
import fs from 'fs';


function initializeFirebaseAdmin() {
    // Check for Emulator usage
    if (process.env.NEXT_PUBLIC_USE_EMULATORS === 'true') {
        if (!process.env.FIREBASE_AUTH_EMULATOR_HOST) {
            process.env.FIREBASE_AUTH_EMULATOR_HOST = '127.0.0.1:9099';
            console.log('ðŸ”§ Configured Firebase Admin to use Auth Emulator at 127.0.0.1:9099');
        }
        if (!process.env.FIRESTORE_EMULATOR_HOST) {
            process.env.FIRESTORE_EMULATOR_HOST = '127.0.0.1:8080';
        }
        if (!process.env.FIREBASE_STORAGE_EMULATOR_HOST) {
            process.env.FIREBASE_STORAGE_EMULATOR_HOST = '127.0.0.1:9199';
        }
    }

    if (admin.apps.length > 0) {
        return admin.apps[0]!;
    }

    const projectId = process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID;
    const storageBucket = process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET;

    if (!projectId || !storageBucket) {
        console.error('Missing Firebase configuration environment variables');
    }

    const config = {
        projectId,
        storageBucket,
    };

    try {
        // Priority 1: Application Default Credentials (production/GCP)
        if (process.env.GOOGLE_APPLICATION_CREDENTIALS) {
            console.log('Using GOOGLE_APPLICATION_CREDENTIALS for Firebase Admin');
            return admin.initializeApp({
                ...config,
                credential: admin.credential.applicationDefault(),
            });
        }

        // Priority 2: Service Account JSON from Environment Variable
        const saJson = process.env.SERVICE_ACCOUNT_JSON || process.env.FIREBASE_SERVICE_ACCOUNT_JSON;
        if (saJson) {
            console.log('Using Service Account JSON from env for Firebase Admin');
            try {
                const serviceAccount = JSON.parse(saJson.replace(/\\n/g, '\n'));
                return admin.initializeApp({
                    ...config,
                    credential: admin.credential.cert(serviceAccount),
                });
            } catch (error) {
                console.error('Failed to parse SERVICE_ACCOUNT_JSON:', error);
                throw new Error('Invalid SERVICE_ACCOUNT_JSON format');
            }
        }

        // Priority 2.5: Individual Secret Environment Variables (App Hosting/Secrets)
        if (process.env.FIREBASE_ADMIN_PRIVATE_KEY && process.env.FIREBASE_ADMIN_CLIENT_EMAIL) {
            console.log('Using Individual Secrets for Firebase Admin');
            try {
                // Handle private key newlines
                const privateKey = process.env.FIREBASE_ADMIN_PRIVATE_KEY.replace(/\\n/g, '\n');
                return admin.initializeApp({
                    ...config,
                    credential: admin.credential.cert({
                        projectId: process.env.FIREBASE_ADMIN_PROJECT_ID || projectId,
                        clientEmail: process.env.FIREBASE_ADMIN_CLIENT_EMAIL,
                        privateKey: privateKey,
                    }),
                });
            } catch (error) {
                console.error('Failed to initialize with individual secrets:', error);
            }
        }

        // Priority 3: File-based Service Account (Development/Local)
        // Only attempt this if we are likely in a local environment
        const saPath = path.resolve(process.cwd(), 'studio-8322868971-8ca89-firebase-adminsdk-fbsvc-b2a4041fbd.json');
        if (fs.existsSync(saPath)) {
            console.log('Using local service account file for Firebase Admin');
            return admin.initializeApp({
                ...config,
                credential: admin.credential.cert(require(saPath)),
            });
        }

        // Priority 4: Default ADC Fallback (useful if running in Cloud Run/Functions without explicitly set env var)
        console.log('Falling back to default Application Default Credentials');
        return admin.initializeApp({
            ...config,
            credential: admin.credential.applicationDefault(),
        });

    } catch (error) {
        console.error('Firebase Admin Initialization Error:', error);
        // Return existing app if something raced and created it, mostly for safety
        if (admin.apps.length > 0) return admin.apps[0]!;
        throw error;
    }
}

const firebaseAdminApp = initializeFirebaseAdmin();
export const firestoreDb = firebaseAdminApp.firestore();
export const authAdmin = firebaseAdminApp.auth();
export const auth = authAdmin; // Alias for compatibility
export const storageAdmin = firebaseAdminApp.storage();
export const messagingAdmin = firebaseAdminApp.messaging();

================================================================================
FILE: src/lib/firebase/auth-admin.ts
================================================================================

import { auth } from '@/lib/firebase/admin';

/**
 * Verifies the Firebase ID token on the server side.
 * @param idToken The Firebase ID token from the client.
 * @returns The decoded token payload.
 * @throws Will throw an error if the token is invalid or verification fails.
 */
export async function verifyIdToken(idToken: string) {
  try {
    const decodedToken = await auth.verifyIdToken(idToken);
    return decodedToken;
  } catch (error: any) {
    console.error('Error verifying ID token:', error.code, error.message);

    // Check for specific error types to give better feedback in logs
    if (error.code === 'auth/id-token-expired') {
      console.error('The provided ID token has expired. Please refresh the page or re-authenticate.');
    } else if (error.code === 'auth/argument-error') {
      console.error('The ID token is missing or malformed.');
    }

    throw new Error('Invalid or expired authentication token.');
  }
}

================================================================================
FILE: src/lib/firebase/auth.ts
================================================================================

import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  setPersistence,
  browserLocalPersistence,
  signOut,
  updateProfile,
  getIdToken,
} from "firebase/auth";
import { auth } from "./config";
import { createUserProfile } from "./client-ops";

interface SignUpOptions {
  email: string;
  password: string;
  displayName: string;
  accountType: 'buyer' | 'seller';
  storeName?: string;
  storeDescription?: string;
}

export async function signUpWithEmail(options: SignUpOptions) {
  const { email, password, displayName, accountType, storeName, storeDescription } = options;
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    await updateProfile(user, { displayName });

    // Prepare profile data
    const profileData: any = {
      email: user.email,
      displayName: user.displayName,
      accountType: accountType,
    };

    if (accountType === 'seller') {
      profileData.storeName = storeName;
      profileData.storeDescription = storeDescription;
    }

    await createUserProfile(user.uid, profileData);

    const safeUser = {
      uid: user.uid,
      email: user.email,
      displayName: user.displayName,
    };

    return { user: safeUser, error: null };
  } catch (error: any) {
    return { user: null, error: { code: error.code, message: error.message } };
  }
}

export async function signInWithEmail(email: string, password: string) {
  try {
    await setPersistence(auth, browserLocalPersistence);
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    const safeUser = {
      uid: user.uid,
      email: user.email,
      displayName: user.displayName,
      photoURL: user.photoURL,
    };

    return { user: safeUser, error: null };
  } catch (error: any) {
    return { user: null, error: { code: error.code, message: error.message } };
  }
}

export async function signOutUser() {
  try {
    await signOut(auth);
    return { error: null };
  } catch (error: any) {
    return { error: error.message };
  }
}

export async function getCurrentUserIdToken(): Promise<string | null> {
    if (!auth.currentUser) {
        return null;
    }
    // Force refresh to ensure the token is valid for server-side verification
    return await getIdToken(auth.currentUser, true);
}

================================================================================
FILE: src/lib/firebase/client-ops.ts
================================================================================

import {
  collection,
  doc,
  setDoc,
  addDoc,
  updateDoc,
  serverTimestamp,
  deleteDoc,
} from 'firebase/firestore';
import { updateProfile } from 'firebase/auth';
import { db, auth } from './config'; // Client SDK
import type { Product, UserProfile, Donation, SafeUser } from '@/lib/types';
import { processDonation } from '@/ai/flows/process-donation';

export async function createUserProfile(uid: string, data: Partial<UserProfile>) {
  await setDoc(doc(db, 'users', uid), {
    id: uid,
    ...data,
    createdAt: serverTimestamp(),
  }, { merge: true });
}

export async function updateUserProfile(user: SafeUser, data: { displayName: string; bio?: string }) {
    if (!user || !auth.currentUser) {
        throw new Error("User not authenticated.");
    }

    // Update Firebase Auth profile
    await updateProfile(auth.currentUser, {
        displayName: data.displayName,
    });

    // Update Firestore profile
    const userDocRef = doc(db, 'users', user.uid);
    await updateDoc(userDocRef, {
        displayName: data.displayName,
        bio: data.bio || '',
    });
}

export async function deleteProduct(productId: string) {
    if (!productId) throw new Error("Product ID is required.");
    const productRef = doc(db, 'products', productId);
    await deleteDoc(productRef);
}


export async function createDonation(donationData: Omit<Donation, "id" | "createdAt" | "status">) {
  const donationPayload = {
    ...donationData,
    status: "Pending Label" as const,
    createdAt: serverTimestamp(),
  };
  const docRef = await addDoc(collection(db, "donations"), donationPayload);

  // Trigger AI Flow
  await processDonation({ donationId: docRef.id, ...donationData, quantity: donationData.quantity.toString() });
  
  return docRef.id;
}

================================================================================
FILE: src/lib/firebase/config.ts
================================================================================

import { initializeApp, getApps, getApp, FirebaseOptions, FirebaseApp } from "firebase/app";
import { getAuth, Auth } from "firebase/auth";
import {
  getFirestore,
  Firestore,
  initializeFirestore,
  persistentLocalCache,
  persistentMultipleTabManager
} from "firebase/firestore";
import { getStorage, FirebaseStorage, connectStorageEmulator } from "firebase/storage";
import { connectAuthEmulator } from "firebase/auth";
import { connectFirestoreEmulator } from "firebase/firestore";

const firebaseConfig: FirebaseOptions = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  databaseURL: process.env.NEXT_PUBLIC_FIREBASE_DATABASE_URL,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
};

// Initialize Firebase
let app: FirebaseApp;
let db: Firestore;

if (!getApps().length) {
  if (!firebaseConfig.apiKey) {
    throw new Error("Missing Firebase API Key. Please set NEXT_PUBLIC_FIREBASE_API_KEY in your .env file");
  }
  app = initializeApp(firebaseConfig);

  if (typeof window !== 'undefined') {
    // Enable offline persistence on the client
    try {
      db = initializeFirestore(app, {
        localCache: persistentLocalCache({
          tabManager: persistentMultipleTabManager()
        })
      });
    } catch (error) {
      console.error("Firestore persistence initialization error:", error);
      db = getFirestore(app);
    }
  } else {
    db = getFirestore(app);
  }
} else {
  app = getApp();
  db = getFirestore(app);
}


// Auth and Storage rely on browser APIs, so we initialize them conditionally
// to prevent errors during server-side rendering or build steps.
let auth: Auth;
let storage: FirebaseStorage;

if (typeof window !== 'undefined') {
  try {
    auth = getAuth(app);
    storage = getStorage(app);

    // CRITICAL: Ensure we're NEVER in emulator mode in production
    const useEmulators = process.env.NEXT_PUBLIC_USE_EMULATORS === 'true';
    const isProduction = process.env.NODE_ENV === 'production';

    if (isProduction && useEmulators) {
      console.error('âŒ CRITICAL: Emulator mode is enabled in production! This should never happen.');
    } else if (isProduction) {
      console.log('âœ… Firebase running in PRODUCTION mode (emulators disabled)');
    } else if (useEmulators) {
      console.log('ðŸ”§ Firebase running in DEVELOPMENT mode with emulators');
      connectAuthEmulator(auth, "http://localhost:9099");
      connectFirestoreEmulator(db, "localhost", 8080);
      connectStorageEmulator(storage, "localhost", 9199);
    } else {
      console.log('ðŸ”§ Firebase running in DEVELOPMENT mode (no emulators)');
    }
  } catch (e) {
    console.error("Firebase Auth/Storage could not be initialized on the client.", e);
  }
}

// @ts-ignore - auth and storage may be uninitialized on the server
export { app, auth, db, storage };

================================================================================
FILE: src/lib/firebase/firestore.ts
================================================================================
'use server';

import { firestoreDb } from '@/lib/firebase/admin';
import type { Product, Review, Category, Seller } from '@/lib/types';
import { Timestamp } from 'firebase-admin/firestore';

// Helper to serialize Admin Timestamps to plain objects for Client Components
const serializeData = (docData: any, docId: string) => {
    if (!docData) return null;

    const serialized: { [key: string]: any } = { id: docId };

    for (const key in docData) {
        if (Object.prototype.hasOwnProperty.call(docData, key)) {
            const value = docData[key];

            // Check for Admin SDK Timestamp
            if (value && typeof value.toDate === 'function') {
                const date = value.toDate();
                serialized[key] = { seconds: Math.floor(date.getTime() / 1000), nanoseconds: 0 };
            }
            // Check for serialized timestamp
            else if (value && typeof value === 'object' && value.hasOwnProperty('seconds') && value.hasOwnProperty('nanoseconds')) {
                serialized[key] = value;
            }
            else {
                serialized[key] = value;
            }
        }
    }
    return serialized;
};

export async function getProductById(id: string): Promise<Product | null> {
    try {
        const docSnap = await firestoreDb.collection('products').doc(id).get();
        if (docSnap.exists) {
            return serializeData(docSnap.data(), docSnap.id) as Product;
        }
        return null;
    } catch (e: any) {
        console.error(`Failed to fetch product ${id}:`, e.message);
        return null;
    }
}

export async function getReviewsForProduct(productId: string): Promise<Review[]> {
    try {
        const querySnapshot = await firestoreDb.collection('reviews')
            .where('productId', '==', productId)
            .orderBy('createdAt', 'desc')
            .get();

        return querySnapshot.docs.map((doc) => serializeData(doc.data(), doc.id) as Review);
    } catch (e: any) {
        console.error('Failed to fetch reviews:', e.message);
        return [];
    }
}

export async function getCategories(): Promise<Category[]> {
    try {
        const snapshot = await firestoreDb.collection('categories')
            .orderBy('name')
            .get();

        if (snapshot.empty) return [];
        return snapshot.docs.map(doc => serializeData(doc.data(), doc.id) as Category);
    } catch (e: any) {
        console.error('Failed to fetch categories: ', e.message);
        return [];
    }
}

export async function getTopSellers(limitCount: number): Promise<Seller[]> {
    try {
        const snapshot = await firestoreDb.collection('users')
            .where('accountType', '==', 'seller')
            .limit(limitCount)
            .get();

        if (snapshot.empty) return [];

        const sellers = snapshot.docs.map(docSnap => {
            const data = serializeData(docSnap.data(), docSnap.id) as any;
            return {
                ...data,
                id: docSnap.id,
                rating: 4.5 + Math.random() * 0.5,
                totalSales: Math.floor(Math.random() * 200) + 50,
                avatarUrl: data.photoURL,
            } as Seller;
        });

        return sellers;
    } catch (e: any) {
        console.error('Failed to fetch top sellers:', e.message);
        return [];
    }
}

export async function getPublicProductCount(): Promise<number> {
    try {
        const snapshot = await firestoreDb.collection('products')
            .where('status', '==', 'available')
            .count()
            .get();

        return snapshot.data().count;
    } catch (e: any) {
        console.error("Failed to count products:", e.message);
        return 0;
    }
}

================================================================================
FILE: src/lib/firebase/serializers.ts
================================================================================

/**
 * Converts Firestore document data to plain objects safe for Client Components
 */
export function serializeFirestoreDoc<T extends Record<string, any>>(
    data: T
): T {
    const serialized: any = {};

    for (const [key, value] of Object.entries(data)) {
        if (value && typeof value === 'object' && typeof value.toDate === 'function') {
            // Handle Firestore Timestamp (both client and admin SDK have toDate())
            serialized[key] = value.toDate().toISOString();
        } else if (value && typeof value === 'object' && '_seconds' in value) {
            // Handle already-converted Timestamp objects (from server-side serialization sometimes)
            serialized[key] = new Date(
                value._seconds * 1000 + (value._nanoseconds || 0) / 1000000
            ).toISOString();
        } else if (Array.isArray(value)) {
            // Recursively handle arrays
            serialized[key] = value.map(item => 
                typeof item === 'object' ? serializeFirestoreDoc(item) : item
            );
        } else if (value && typeof value === 'object') {
            // Recursively handle nested objects
            // Check constructor to avoid traversing special objects like Date (though Date is handled by Next.js, standard objects are safer)
            if (value.constructor === Object) {
                 serialized[key] = serializeFirestoreDoc(value);
            } else {
                 serialized[key] = value;
            }
        } else {
            // Primitive values are fine
            serialized[key] = value;
        }
    }

    return serialized as T;
}

================================================================================
FILE: src/lib/firebase/storage.ts
================================================================================

import { ref, uploadBytes, getDownloadURL, listAll, deleteObject } from "firebase/storage";
import { storage } from "./config";
import { auth } from "./config";

function sanitizePath(path: string): string {
  // Remove any path traversal attempts
  const sanitized = path.replace(/\.\./g, '').replace(/\/\//g, '/');

  // Ensure path starts with allowed prefixes
  const allowedPrefixes = ['products/', 'media-library/', 'temp-analysis/'];
  if (!allowedPrefixes.some(prefix => sanitized.startsWith(prefix))) {
    console.warn(`Upload path ${sanitized} does not start with whitelisted prefix. Defaulting to 'media-library/'.`);
    return 'media-library/';
  }

  return sanitized;
}

export async function uploadImages(
  files: File[],
  path: string
): Promise<string[]> {
  const user = auth.currentUser;
  // Loosening this restriction to allow category image uploads, etc.
  // if (!user) throw new Error("User not authenticated");

  const sanitizedPath = sanitizePath(path);

  const uploadPromises = files.map(async (file) => {
    // Sanitize filename
    const safeFilename = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
    const uniqueFilename = `${Date.now()}-${safeFilename}`;

    const fullPath = sanitizedPath.endsWith('/')
      ? `${sanitizedPath}${uniqueFilename}`
      : `${sanitizedPath}/${uniqueFilename}`;

    const fileRef = ref(
      storage,
      fullPath
    );
    await uploadBytes(fileRef, file);
    return getDownloadURL(fileRef);
  });

  return Promise.all(uploadPromises);
}

// Uploads files to a general 'media-library' folder
export async function uploadMedia(files: File[]): Promise<string[]> {
  const uploadPromises = files.map(async (file) => {
    const safeFilename = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
    const fileRef = ref(storage, `media-library/${Date.now()}-${safeFilename}`);
    await uploadBytes(fileRef, file);
    return getDownloadURL(fileRef);
  });

  return Promise.all(uploadPromises);
}

// Lists all files from the 'media-library'
export async function listMedia(): Promise<{ name: string, url: string }[]> {
  const listRef = ref(storage, 'media-library');
  const res = await listAll(listRef);

  const files = await Promise.all(
    res.items.map(async (itemRef) => {
      const url = await getDownloadURL(itemRef);
      return { name: itemRef.name, url };
    })
  );

  return files;
}

// Deletes a specific file from the 'media-library'
export async function deleteMedia(fileName: string): Promise<void> {
  const desertRef = ref(storage, `media-library/${fileName}`);
  await deleteObject(desertRef);
}

================================================================================
FILE: src/lib/placeholder-images.ts
================================================================================

import data from './placeholder-images.json';

export type ImagePlaceholder = {
  id: string;
  description: string;
  imageUrl: string;
  imageHint: string;
};

export const PlaceHolderImages: ImagePlaceholder[] = data.placeholderImages;

================================================================================
FILE: src/lib/product-utils.ts
================================================================================
'use client';

import type { Product } from '@/lib/types';
import { Timestamp } from 'firebase/firestore';

export interface FilterOptions {
  sortOrder?: string;
  priceRange?: [number, number];
  conditions?: string[];
  categories?: string[];
  subCategories?: string[];
  searchTerm?: string;
}

/**
 * Filters and sorts an array of products based on various criteria.
 * @param products - The array of products to filter.
 * @param filters - The filter criteria.
 * @returns A new array of filtered and sorted products.
 */
export function filterAndSortProducts(products: Product[], filters: FilterOptions): Product[] {
  let filteredProducts = [...products];

  // 1. Filter by Search Term (Title and Description)
  if (filters.searchTerm) {
    const lowercasedTerm = filters.searchTerm.toLowerCase();
    filteredProducts = filteredProducts.filter(p =>
      p.title.toLowerCase().includes(lowercasedTerm) ||
      (p.description && p.description.toLowerCase().includes(lowercasedTerm))
    );
  }

  // 2. Filter by Price Range
  if (filters.priceRange) {
    const [min, max] = filters.priceRange;
    filteredProducts = filteredProducts.filter(p => {
        const price = p.price || 0;
        const isGte = min === undefined || price >= min;
        const isLte = max === undefined || price <= max;
        return isGte && isLte;
    });
  }

  // 3. Filter by Condition
  if (filters.conditions && filters.conditions.length > 0) {
    filteredProducts = filteredProducts.filter(p =>
      filters.conditions!.includes(p.condition || '')
    );
  }
  
  // 4. Filter by Category
  if (filters.categories && filters.categories.length > 0) {
      filteredProducts = filteredProducts.filter(p =>
          filters.categories!.includes(p.category || '')
      );
  }
  
  // 5. Filter by Sub-Category
  if (filters.subCategories && filters.subCategories.length > 0) {
      filteredProducts = filteredProducts.filter(p =>
          filters.subCategories!.includes(p.subCategory || '')
      );
  }

  // 6. Sort the results
  if (filters.sortOrder) {
    switch (filters.sortOrder) {
      case 'price-asc':
        filteredProducts.sort((a, b) => a.price - b.price);
        break;
      case 'price-desc':
        filteredProducts.sort((a, b) => b.price - a.price);
        break;
      case 'createdAt-desc':
      default:
        // Ensure createdAt is a Timestamp before using toMillis
        filteredProducts.sort((a, b) => {
            const aDate = a.createdAt instanceof Timestamp ? a.createdAt.toMillis() : 0;
            const bDate = b.createdAt instanceof Timestamp ? b.createdAt.toMillis() : 0;
            return bDate - aDate;
        });
        break;
    }
  }

  return filteredProducts;
}

================================================================================
FILE: src/lib/rate-limiter.ts
================================================================================

export interface RateLimitConfig {
    windowMs: number;
    maxRequests: number;
}

export class RateLimiter {
    private requestLog: Map<string, number[]> = new Map();
    private cleanupInterval: NodeJS.Timeout | null = null;

    constructor(private config: RateLimitConfig) {
        // Automatic cleanup every 5 minutes
        this.cleanupInterval = setInterval(() => {
            this.cleanup(Date.now());
        }, 5 * 60 * 1000);
    }

    /**
     * Check if request is allowed under rate limit
     * @returns true if allowed, false if limit exceeded
     */
    checkLimit(userId: string): boolean {
        const now = Date.now();
        const userRequests = this.requestLog.get(userId) || [];

        const recentRequests = userRequests.filter(
            timestamp => now - timestamp < this.config.windowMs
        );

        if (recentRequests.length >= this.config.maxRequests) {
            return false;
        }

        recentRequests.push(now);
        this.requestLog.set(userId, recentRequests);

        return true;
    }

    private cleanup(now: number) {
        for (const [userId, requests] of this.requestLog.entries()) {
            const recentRequests = requests.filter(
                timestamp => now - timestamp < this.config.windowMs
            );

            if (recentRequests.length === 0) {
                this.requestLog.delete(userId);
            } else {
                this.requestLog.set(userId, recentRequests);
            }
        }
    }

    destroy() {
        if (this.cleanupInterval) {
            clearInterval(this.cleanupInterval);
        }
    }
}

================================================================================
FILE: src/lib/research-types.ts
================================================================================
// Research/Card Scanner Types

export interface Player {
    name: string;
    sport: string;
    prizmRookieYear?: number;
}

export const defaultPlayers: Player[] = [
    { name: 'LeBron James', sport: 'Basketball' },
    { name: 'Michael Jordan', sport: 'Basketball' },
    { name: 'Tom Brady', sport: 'Football' },
    { name: 'Patrick Mahomes', sport: 'Football' },
    { name: 'Mike Trout', sport: 'Baseball' },
    { name: 'Shohei Ohtani', sport: 'Baseball' },
    { name: 'Lionel Messi', sport: 'Soccer' },
    { name: 'Cristiano Ronaldo', sport: 'Soccer' },
];

export interface ScanHistoryItem {
    id: string;
    name: string;
    isKeeper: boolean;
    isPrizmRookie?: boolean;
    brand?: string;
    cardType?: string;
    sport?: string;
    cardYear?: number | null;
    salesData?: {
        averagePrice?: number | null;
        salesCount?: number | null;
        source?: string | null;
    };
    timestamp: Date;
    imageDataUri?: string;
}

================================================================================
FILE: src/lib/types.ts
================================================================================

import { Timestamp } from "firebase/firestore";

// We can extend the FirebaseUser type to include our custom fields
export type User = {
  id: string;
  displayName?: string;
  avatarUrl?: string; // Mock data uses avatarUrl
  storeName?: string;
  bio?: string;
  friendIds?: string[];
  blockedSellerIds?: string[];
  birthDate?: string;
  privateCollectionPassword?: string;
  postcode?: string;
};

// Define the shape of the safe, plain user object
export type SafeUser = {
  uid: string;
  email: string | null;
  displayName: string | null;
  photoURL: string | null;
  // Add the getIdTokenResult method for custom claims
  getIdTokenResult: (forceRefresh?: boolean) => Promise<{ claims: { [key: string]: any; }; }>;
} | null;

export type UserRole = 'viewer' | 'seller' | 'admin' | 'superadmin';

export type UserProfile = {
  id: string;
  displayName: string;
  email: string;
  photoURL?: string;
  createdAt?: Timestamp;
  accountType?: 'buyer' | 'seller';
  storeName?: string;
  storeDescription?: string;
  bio?: string;
  // Mock data for demo
  rating?: number;
  totalSales?: number;
  isVerified?: boolean;
  joinDate?: string;
  // New Role-Based Access Fields
  role?: UserRole;
  canSell?: boolean;
};

export type Product = {
  id: string;
  title: string;
  description: string;
  price: number;
  category: string;
  subCategory?: string;
  sellerId: string;
  sellerName: string;
  sellerEmail: string;
  sellerAvatar?: string;
  imageUrls: string[];
  status: 'available' | 'sold' | 'draft';
  isPrivate?: boolean;
  gradingCompany?: 'PSA' | 'BGS' | 'CGC' | 'SGC' | 'Raw';
  grade?: string;
  certNumber?: string;
  year?: number;
  manufacturer?: string;
  cardNumber?: string;
  createdAt?: Timestamp | Date;
  updatedAt?: Timestamp | Date;
  soldAt?: any;
  condition?: string;
  conditionDescription?: string;
  isReverseBidding?: boolean;
  bids?: Bid[];
  acceptedBidId?: string;
  isDraft?: boolean;
  quantity?: number;
  views?: number; // Total views (non-unique)
  uniqueViews?: number; // Unique views for auto-repricing
  viewedByUsers?: string[]; // List of user IDs who have viewed for unique tracking
  lastViewedTimestamp?: Timestamp; // Timestamp of the most recent view for auto-repricing
  isVault?: boolean;
  // New Auction Fields
  isAuction?: boolean;
  startingBid?: number;
  currentBid?: number;
  auctionEndTime?: Timestamp;
  buyItNowPrice?: number;
  bidHistory?: Bid[];
  autoRepricingEnabled?: boolean;
  minStockQuantity?: number;
};

export type ProductSearchParams = {
  [key: string]: any;
  q?: string;
  category?: string;
  subCategory?: string;
  sellerId?: string;
  page?: number;
  limit?: number;
  sort?: string;
  view?: 'grid' | 'list';
  priceRange?: [number, number];
  conditions?: string[];
  categories?: string[];
  sellers?: string[];
  yearRange?: [number, number];
};


export type Bid = {
  id: string;
  bidderId: string;
  bidderName: string;
  amount: number;
  timestamp: Timestamp; // Firestore timestamp
  status: 'pending' | 'accepted' | 'rejected';
};

export interface Donation {
  id?: string;
  fullName: string;
  email: string;
  donationType: "Cards" | "Coins" | "Mixed Collectibles";
  description: string;
  quantity: string;
  status: "Pending Label" | "Label Sent" | "Received" | "Sorted" | "Delivered to Hospital";
  createdAt: Timestamp;
}

export interface Seller {
  id: string;
  displayName: string;
  avatarUrl: string;
  rating: number;
  totalSales: number;
}

export interface Review {
  id: string;
  productId: string;
  productTitle: string;
  sellerId: string;
  buyerId: string;
  buyerName: string;
  buyerAvatar?: string;
  rating: number;
  comment: string;
  createdAt: Timestamp;
}

export interface VerificationRequest {
  id: string;
  userId: string;
  userName: string;
  type: 'user' | 'item';
  itemId?: string; // product id if type is 'item'
  status: 'pending' | 'approved' | 'rejected';
  documentUrls: string[];
  userMessage: string;
  createdAt: Timestamp;
  reviewedBy?: string; // admin id
  reviewedAt?: Timestamp;
  rejectionReason?: string;
}

export interface WishlistItem {
  id: string; // Corresponds to product ID
  addedAt: Timestamp;
}

export interface ForumPost {
  id: string;
  authorId: string;
  authorName: string;
  authorAvatar?: string;
  title: string;
  content: string;
  category: string; // e.g., 'General', 'Showcase', 'Advice'
  likes: number;
  repliesCount: number;
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

export interface ForumReply {
  id: string;
  postId: string;
  authorId: string;
  authorName: string;
  authorAvatar?: string;
  content: string;
  createdAt: Timestamp;
}

export interface Notification {
  id: string;
  recipientId: string;
  type: 'outbid' | 'sale' | 'system' | 'mention' | 'wishlist_alert';
  title: string;
  message: string;
  link?: string; // URL to redirect to (e.g., /product/123)
  read: boolean;
  createdAt: Timestamp;
}

export interface Transaction {
  id: string;
  transactionId: string; // From payment provider
  buyerId: string;
  sellerId: string;
  productId: string;
  amount: number;
  platformFee: number;
  status: 'completed' | 'refunded' | 'disputed';
  createdAt: Timestamp;
}

export interface Category {
  id: string;
  name: string;
  description?: string;
  imageUrl?: string;
  slug?: string;
  section: string;
  href?: string;
}

================================================================================
FILE: src/lib/utils.ts
================================================================================
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

================================================================================
FILE: src/middleware.ts
================================================================================
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  const response = NextResponse.next();

  // 1. Security Headers (Always Safe & Recommended)
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  response.headers.set('Permissions-Policy', 'camera=*, microphone=(), geolocation=()');

  // 2. Route Protection (Requires Cookie Sync)
  // Since we are currently using client-side Firebase Auth, the server doesn't see the user's token by default.
  // To enable the blocking logic below, you must implement a mechanism to sync the Fireabse ID token to a 'session' cookie.

  /* 
  const session = request.cookies.get('session') || request.cookies.get('__session');
  const isAuth = !!session;
 
  // Protect Admin Routes
  if (request.nextUrl.pathname.startsWith('/admin')) {
    if (!isAuth) {
      return NextResponse.redirect(new URL('/sign-in', request.url));
    }
  }
 
  // Protect Seller Routes
  if (request.nextUrl.pathname.startsWith('/sell')) {
    if (!isAuth) {
       return NextResponse.redirect(new URL('/sign-in', request.url));
    }
  }
  */

  return response;
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - api (API routes)
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     */
    '/((?!api|_next/static|_next/image|favicon.ico).*)',
  ],
};

================================================================================
FILE: src/schemas/product.ts
================================================================================
import { z } from 'zod';

export const productFormSchema = z.object({
    title: z.string().min(5, "Title must be at least 5 characters").max(100, "Title must be less than 100 characters"),
    description: z.string().min(20, "Description must be at least 20 characters").max(2000, "Description must be less than 2000 characters"),
    price: z.number().min(0.01, "Price must be at least $0.01"),
    category: z.string().min(1, "Category is required"),
    subCategory: z.string().optional(),
    imageUrls: z.array(z.string().url("Invalid image URL")).min(1, "At least one image is required").max(10, "Maximum 10 images"),
    condition: z.string().min(1, "Condition is required"),
    conditionDescription: z.string().optional(),

    // Grading
    gradingCompany: z.enum(['PSA', 'BGS', 'CGC', 'SGC', 'Raw']).optional(),
    grade: z.string().optional(),
    certNumber: z.string().optional(),

    // Additional details
    year: z.number().int().min(1800).max(new Date().getFullYear() + 1).optional(),
    manufacturer: z.string().optional(),
    cardNumber: z.string().optional(),

    // Settings
    status: z.enum(['available', 'sold', 'draft']).default('available'),
    isPrivate: z.boolean().default(false),
    isDraft: z.boolean().default(false),
    quantity: z.number().int().min(1).default(1),
    
    // Feature Flags (Added for new features)
    isVault: z.boolean().optional(),
    isReverseBidding: z.boolean().optional(),
    autoRepricingEnabled: z.boolean().optional(),

    // Auction fields
    isAuction: z.boolean().optional(),
    startingBid: z.number().min(0).optional(),
    auctionEndTime: z.any().optional(), // Timestamp handling can be complex in zod, using any or coercion
    buyItNowPrice: z.number().min(0).optional(),
    minStockQuantity: z.number().optional(),
});

export type ProductFormValues = z.infer<typeof productFormSchema>;
================================================================================
FILE: src/services/bidding.ts
================================================================================

import { db } from '@/lib/firebase/config';
import { doc, updateDoc, arrayUnion, getDoc, serverTimestamp, Timestamp } from 'firebase/firestore';
import { Product, Bid } from '@/lib/types';

export async function placeBid(productId: string, bidderId: string, bidderName: string, amount: number) {
    const productRef = doc(db, 'products', productId);
    const productSnap = await getDoc(productRef);

    if (!productSnap.exists()) {
        throw new Error('Product not found');
    }

    const product = productSnap.data() as Product;

    if (!product.isReverseBidding) {
        throw new Error('This product does not accept bids');
    }
    
    if(bidderId === product.sellerId) {
        throw new Error("You cannot bid on your own item.");
    }

    const currentBids = product.bids || [];
    const highestBidAmount = currentBids.reduce((max, bid) => Math.max(max, bid.amount), 0);
    const baselinePrice = Math.max(product.price, highestBidAmount);

    const allowedMax = baselinePrice * 1.25;

    if (amount > allowedMax) {
        throw new Error(`Bid amount cannot exceed 25% of current highest offer/price ($${allowedMax.toFixed(2)})`);
    }

    if (amount < product.price) {
        throw new Error(`Bid must be at least the starting price ($${product.price.toFixed(2)})`);
    }

    const newBid: Bid = {
        id: crypto.randomUUID(),
        bidderId,
        bidderName,
        amount,
        timestamp: Timestamp.now(),
        status: 'pending'
    };

    await updateDoc(productRef, {
        bids: arrayUnion(newBid)
    });

    return newBid;
}

export async function acceptBid(productId: string, bidId: string) {
    const productRef = doc(db, 'products', productId);
    const productSnap = await getDoc(productRef);

    if (!productSnap.exists()) {
        throw new Error('Product not found');
    }

    const product = productSnap.data() as Product;
    const bids = product.bids || [];
    const acceptedBid = bids.find(b => b.id === bidId);

    if (!acceptedBid) {
        throw new Error("Bid not found.");
    }

    // Update the status of all bids
    const updatedBids = bids.map(bid => {
        if (bid.id === bidId) {
            return { ...bid, status: 'accepted' as const };
        }
        // Optionally mark other pending bids as rejected
        if (bid.status === 'pending') {
           return { ...bid, status: 'rejected' as const };
        }
       return bid;
    });

    await updateDoc(productRef, {
        bids: updatedBids,
        acceptedBidId: bidId,
        price: acceptedBid.amount, // Update the product price to the accepted bid amount
        status: 'sold', // Mark the product as sold
        soldAt: serverTimestamp()
    });
}

================================================================================
FILE: src/services/notifications.ts
================================================================================

'use server';

import { db } from '@/lib/firebase/config';
import { collection, addDoc, query, where, orderBy, limit, getDocs, updateDoc, doc, Timestamp, writeBatch } from 'firebase/firestore';
import { Notification } from '@/lib/types';
import { SUPER_ADMIN_EMAILS, SUPER_ADMIN_UIDS } from '@/lib/constants';

const NOTIFICATIONS_COL = 'notifications';

/**
 * Trigger a notification for a user.
 * Use this when: a bid is placed (notify seller), a user is outbid, a reply is posted, etc.
 */
export async function sendNotification(
    recipientId: string,
    type: 'outbid' | 'sale' | 'system' | 'mention' | 'wishlist_alert',
    title: string,
    message: string,
    link?: string
) {
    const notification: Omit<Notification, 'id'> = {
        recipientId,
        type,
        title,
        message,
        link,
        read: false,
        createdAt: Timestamp.now()
    };

    await addDoc(collection(db, NOTIFICATIONS_COL), notification);
}

/**
 * Get the latest notifications for the current user.
 */
export async function getUserNotifications(userId: string, limitCount = 20) {
    const q = query(
        collection(db, NOTIFICATIONS_COL),
        where('recipientId', '==', userId),
        orderBy('createdAt', 'desc'),
        limit(limitCount)
    );

    const snapshot = await getDocs(q);
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Notification));
}

/**
 * Mark a specific notification as read.
 */
export async function markAsRead(notificationId: string) {
    const ref = doc(db, NOTIFICATIONS_COL, notificationId);
    await updateDoc(ref, { read: true });
}

/**
 * Mark all notifications for a user as read.
 */
export async function markAllAsRead(userId: string) {
    const q = query(
        collection(db, NOTIFICATIONS_COL),
        where('recipientId', '==', userId),
        where('read', '==', false)
    );

    const snapshot = await getDocs(q);
    const batch = writeBatch(db);

    snapshot.docs.forEach(doc => {
        batch.update(doc.ref, { read: true });
    });

    await batch.commit();
}

export async function getSuperAdminId(): Promise<string | null> {
    try {
        // If we have hardcoded UIDs, use the first one as the primary admin ID
        if (SUPER_ADMIN_UIDS.length > 0) {
            return SUPER_ADMIN_UIDS[0];
        }

        const q = query(collection(db, 'users'), where('email', 'in', SUPER_ADMIN_EMAILS), limit(1));
        const querySnapshot = await getDocs(q);
        if (!querySnapshot.empty) {
            return querySnapshot.docs[0].id;
        }
        return null;
    } catch (error) {
        console.error('Error getting super admin ID:', error);
        return null;
    }
}

================================================================================
FILE: src/services/product-service.ts
================================================================================

import { db } from '@/lib/firebase/config';
import type { Product, ProductSearchParams } from '@/lib/types';
import { collection, query, where, orderBy, limit, getDocs, startAfter, QueryConstraint, Timestamp, Query, DocumentData } from 'firebase/firestore';

const PAGE_SIZE = 24;

export async function getProducts(searchParams: ProductSearchParams): Promise<{ products: Product[], hasMore: boolean }> {

  const { page = 1, sort = 'createdAt-desc', q, category, categories, subCategory, conditions, priceRange, sellers, yearRange } = searchParams;

  const productsRef = collection(db, 'products');
  let constraints: QueryConstraint[] = [where('isDraft', '==', false)];

  // Build constraints based on search params

  // Handle Multi-select Categories
  if (categories && categories.length > 0) {
    constraints.push(where('category', 'in', categories.slice(0, 30)));
  } else if (category) {
    // Fallback for single category
    constraints.push(where('category', '==', category));
  }

  if (subCategory) {
    constraints.push(where('subCategory', '==', subCategory));
  }
  if (conditions && conditions.length > 0) {
    constraints.push(where('condition', 'in', conditions));
  }
  if (sellers && sellers.length > 0) {
    constraints.push(where('sellerId', 'in', sellers.slice(0, 30)));
  }

  // Firestore allows only ONE field to have inequality filters.
  // We prioritize Price Range for DB filtering as it's more common.
  // Year Range will be filtered in-memory if Price Range is also active.
  let filterYearInMemory = false;

  if (priceRange) {
    if (priceRange[0] > 0) {
      constraints.push(where('price', '>=', priceRange[0]));
    }
    if (priceRange[1] < 10000) {
      constraints.push(where('price', '<=', priceRange[1]));
    }
    // If price range is active, we MUST filter year in memory
    if (yearRange) {
      filterYearInMemory = true;
    }
  } else if (yearRange) {
    // No price range, so we can use DB filtering for year
    if (yearRange[0] > 1900) {
      constraints.push(where('year', '>=', yearRange[0]));
    }
    if (yearRange[1] < new Date().getFullYear()) {
      constraints.push(where('year', '<=', yearRange[1]));
    }
  }

  const [sortField, sortDirection] = sort.split('-') as ['createdAt' | 'price' | 'year' | 'views' | 'title', 'asc' | 'desc'];

  // If we rely on inequality, the first orderBy must be on that field.
  // Firestore Requirement: "If you include a filter with a range comparison (<, <=, >, >=), your first ordering must be on the same field."
  let orderByConstraints: QueryConstraint[] = [];

  if (priceRange && (priceRange[0] > 0 || priceRange[1] < 10000)) {
    if (sortField !== 'price') {
      // We must order by price first, then the user's sort.
      orderByConstraints.push(orderBy('price', sortDirection === 'desc' ? 'desc' : 'asc'));

      orderByConstraints.push(orderBy(sortField, sortDirection));
    } else {
      orderByConstraints.push(orderBy('price', sortDirection));
    }
  } else if (!filterYearInMemory && yearRange && (yearRange[0] > 1900 || yearRange[1] < new Date().getFullYear())) {
    // Filtering by Year in DB
    // Ensure sorting by year is handled
    if (sortField !== 'year') {
      orderByConstraints.push(orderBy('year', sortDirection === 'desc' ? 'desc' : 'asc'));
      orderByConstraints.push(orderBy(sortField, sortDirection));
    } else {
      orderByConstraints.push(orderBy('year', sortDirection));
    }
  } else {
    // No range filters, standard sort
    orderByConstraints.push(orderBy(sortField, sortDirection));
  }

  // Apply constraints
  const finalConstraints = [...constraints, ...orderByConstraints];

  // Pagination
  // Note: Pagination with in-memory filtering (Search, Year override) is tricky.
  // We'll fetch a larger batch if we know we are filtering in memory, but for now stick to PAGE_SIZE
  // and accept that pages might be shorter.

  let finalQuery: Query<DocumentData>;

  if (page > 1) {
    const prevPageLimit = (page - 1) * PAGE_SIZE;
    const prevPagesQuery = query(productsRef, ...finalConstraints, limit(prevPageLimit));
    const prevPagesSnapshot = await getDocs(prevPagesQuery);
    const lastVisible = prevPagesSnapshot.docs[prevPagesSnapshot.docs.length - 1];

    if (lastVisible) {
      finalQuery = query(productsRef, ...finalConstraints, startAfter(lastVisible), limit(PAGE_SIZE));
    } else {
      finalQuery = query(productsRef, ...finalConstraints, limit(PAGE_SIZE));
    }
  } else {
    finalQuery = query(productsRef, ...finalConstraints, limit(PAGE_SIZE));
  }

  const querySnapshot = await getDocs(finalQuery);

  let products = querySnapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  } as Product));

  // In-Memory Filters
  if (q) {
    const lowercasedTerm = q.toLowerCase();
    products = products.filter(p => p.title.toLowerCase().includes(lowercasedTerm) || (p.description && p.description.toLowerCase().includes(lowercasedTerm)));
  }

  if (filterYearInMemory && yearRange) {
    products = products.filter(p => {
      if (!p.year) return false;
      return p.year >= yearRange[0] && p.year <= yearRange[1];
    });
  }

  const hasMore = querySnapshot.docs.length === PAGE_SIZE;

  return { products, hasMore };
}

export async function getAllProducts(): Promise<Product[]> {
  const productsRef = collection(db, 'products');
  const q = query(productsRef, where('isDraft', '==', false), orderBy('createdAt', 'desc'));
  const querySnapshot = await getDocs(q);
  const products = querySnapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  } as Product));
  return products;
}

